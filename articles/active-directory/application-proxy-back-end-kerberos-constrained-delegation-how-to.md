---
title: Come configurare un'applicazione proxy dell'applicazione per l'uso della delega vincolata Kerberos | Microsoft Docs
description: Come configurare la delega vincolata Kerberos per un'applicazione proxy dell'applicazione Azure AD.
services: active-directory
documentationcenter: 
author: ajamess
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/11/2017
ms.author: asteen
ms.openlocfilehash: 3a768c30cb874d42d7b4fbd2eeaa6c0e23904e10
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/03/2017
---
# <a name="how-to-configure-an-application-proxy-application-to-use-kerberos-constrained-delegation"></a><span data-ttu-id="d1088-103">Come configurare un'applicazione proxy dell'applicazione per l'uso della delega vincolata Kerberos</span><span class="sxs-lookup"><span data-stu-id="d1088-103">How to configure an Application Proxy application to use Kerberos Constrained Delegation</span></span>

<span data-ttu-id="d1088-104">I metodi disponibili per ottenere l'accesso SSO alle applicazioni pubblicate possono in qualche modo variare da un'applicazione all'altra e una delle opzioni predefinite del proxy dell'applicazione Azure è la delega vincolata Kerberos (KCD).</span><span class="sxs-lookup"><span data-stu-id="d1088-104">The methods available for achieving SSO to published applications can somewhat vary from application to application and one of the options that Azure Application Proxy offers right out of the box, is Kerberos Constrained Delegation (KCD).</span></span> <span data-ttu-id="d1088-105">È qui che un host del connettore viene configurato per eseguire l'autenticazione Kerberos vincolata nelle applicazioni back-end per conto degli utenti.</span><span class="sxs-lookup"><span data-stu-id="d1088-105">This is where a connector host is configured to perform constrained kerberos authentication to backend applications, on behalf of users.</span></span>

<span data-ttu-id="d1088-106">La procedura effettiva per l'abilitazione della delega vincolata Kerberos è relativamente semplice e in genere richiede semplicemente una conoscenza generale dei vari componenti e del flusso di autenticazione che facilita l'accesso SSO.</span><span class="sxs-lookup"><span data-stu-id="d1088-106">The actual procedure for enabling KCD is relatively straightforward and typically requires no more than a general understanding of the various components and authentication flow that facilitates SSO.</span></span> <span data-ttu-id="d1088-107">Trovare fonti di informazioni valide per risolvere i problemi degli scenari in cui l'accesso SSO della delega vincolata Kerberos non funziona come previsto può essere complicato.</span><span class="sxs-lookup"><span data-stu-id="d1088-107">Finding good sources of information to help troubleshoot scenarios where KCD SSO doesn’t function as expected, can be sparse.</span></span>

<span data-ttu-id="d1088-108">A tale proposito, questo articolo tenta di fornire un singolo punto di riferimento per risolvere e correggere in modo autonomo alcuni tra i problemi più comuni riscontrati.</span><span class="sxs-lookup"><span data-stu-id="d1088-108">As such, this article attempts to provide a single point of reference that should help troubleshoot and self-remediate some of the most common issues that we see.</span></span> <span data-ttu-id="d1088-109">L'articolo offre al contempo indicazioni aggiuntive per la diagnosi delle implementazioni più complesse e problematiche.</span><span class="sxs-lookup"><span data-stu-id="d1088-109">At the same time offer additional guidance for diagnosing the more complex and troubled of implementation.</span></span>

<span data-ttu-id="d1088-110">Si noti che questo articolo presuppone quanto segue:</span><span class="sxs-lookup"><span data-stu-id="d1088-110">note that this article makes the following assumptions:</span></span>

-   <span data-ttu-id="d1088-111">Il proxy dell'applicazione Azure è stato distribuito in base alla nostra [documentazione](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable) e l'accesso generale alle applicazioni non di delega vincolata Kerberos funziona come previsto.</span><span class="sxs-lookup"><span data-stu-id="d1088-111">Azure Application Proxy has been deployed as per our [documentation](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-enable) and general access to non KCD applications is working as expected.</span></span>

-   <span data-ttu-id="d1088-112">L'applicazione di destinazione pubblicata è basata sull'implementazione di Kerberos da parte di IIS e Microsoft.</span><span class="sxs-lookup"><span data-stu-id="d1088-112">The published target application is based on IIS and Microsoft’s implementation of kerberos.</span></span>

-   <span data-ttu-id="d1088-113">Gli host del server e dell'applicazione si trovano in un unico dominio di Active Directory.</span><span class="sxs-lookup"><span data-stu-id="d1088-113">The server and application hosts reside in a single Active Directory domain.</span></span> <span data-ttu-id="d1088-114">Informazioni dettagliate sugli scenari tra domini e foreste sono disponibili nel nostro [white paper sulla delega vincolata Kerberos](http://aka.ms/KCDPaper).</span><span class="sxs-lookup"><span data-stu-id="d1088-114">Detailed information on cross domain and forest scenarios can be found in our [KCD whitepaper](http://aka.ms/KCDPaper).</span></span>

-   <span data-ttu-id="d1088-115">L'applicazione in questione viene pubblicata in un tenant Azure con preautenticazione abilitata e gli utenti dovrebbero eseguire l'autenticazione basata su moduli in Azure.</span><span class="sxs-lookup"><span data-stu-id="d1088-115">The subject application is published in an Azure tenant with pre-authentication enabled, and users are expected to authenticate to Azure via forms based authentication.</span></span> <span data-ttu-id="d1088-116">Gli scenari di autenticazione dei rich client non sono trattati in questo articolo, ma verranno aggiunti in futuro.</span><span class="sxs-lookup"><span data-stu-id="d1088-116">Rich client authentication scenarios are not covered by this article, but be added at some point in the future.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="d1088-117">Prerequisiti</span><span class="sxs-lookup"><span data-stu-id="d1088-117">Prerequisites</span></span>

<span data-ttu-id="d1088-118">Il proxy dell'applicazione Azure può essere distribuito praticamente in qualsiasi tipo di infrastruttura o ambiente e indubbiamente le architetture variano in base all'organizzazione.</span><span class="sxs-lookup"><span data-stu-id="d1088-118">Azure Application Proxy can be deployed into pretty much any type of infrastructure or environment and the architectures no doubt vary from organization to organization.</span></span> <span data-ttu-id="d1088-119">Una delle cause più comuni dei problemi correlati alla delega vincolata Kerberos non è rappresentata dagli ambienti stessi, ma piuttosto da semplici errori di configurazione o disattenzioni.</span><span class="sxs-lookup"><span data-stu-id="d1088-119">One of the most common causes of KCD related issues are not the environments themselves, but rather simple mis-configurations, or general oversight.</span></span>

<span data-ttu-id="d1088-120">Per questo motivo, è consigliabile sempre verificare di aver soddisfatto tutti i prerequisiti elencati nel nostro articolo principale [Fornire l'accesso Single Sign-On alle app con il proxy di applicazione](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) prima di procedere con la risoluzione dei problemi.</span><span class="sxs-lookup"><span data-stu-id="d1088-120">For this reason, our advice is always to start by making sure you have met all the pre-requisites laid out in our main [Using KCD SSO with the Application Proxy article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd) before starting troubleshooting.</span></span>

<span data-ttu-id="d1088-121">Si noti in particolare la sezione sulla configurazione della delega vincolata Kerberos in 2012 R2, in quanto adotta un approccio radicalmente diverso alla configurazione della delega vincolata Kerberos nelle versioni precedenti di Windows, ma è opportuno tenere presente anche altre considerazioni:</span><span class="sxs-lookup"><span data-stu-id="d1088-121">Particularly the section on configuring KCD on 2012R2, as this employs a fundamentally different approach to configuring KCD on previous versions of Windows, but also while being mindful of several other considerations:</span></span>

-   <span data-ttu-id="d1088-122">Spesso può accadere che un server membro del dominio apra una finestra di dialogo con canale sicuro con un controller di dominio specifico.</span><span class="sxs-lookup"><span data-stu-id="d1088-122">It is not uncommon for a domain member server to open a secure channel dialog with a specific domain controller.</span></span> <span data-ttu-id="d1088-123">Passare a un'altra finestra di dialogo in qualsiasi momento, in modo da non limitare gli host del connettore alla sola comunicazione con specifici controller di dominino di siti locali.</span><span class="sxs-lookup"><span data-stu-id="d1088-123">Then move to another dialog at any given time, so connector hosts should generally not be restricted to being able to communicate with only specific local site DCs.</span></span>

-   <span data-ttu-id="d1088-124">In modo analogo al punto precedente, gli scenari tra domini si affidano ai riferimenti che indirizzano un host del connettore ai controller di dominio che possono trovarsi all'esterno del perimetro della rete locale.</span><span class="sxs-lookup"><span data-stu-id="d1088-124">Similar to the above point, cross domain scenarios rely on referrals that direct a connector host to DCs that may reside outside of the local network perimeter.</span></span> <span data-ttu-id="d1088-125">In questo scenario è ugualmente importante verificare anche di consentire il traffico verso i controller di dominio che rappresentano altri rispettivi domini; in caso contrario, la delega avrà esito negativo.</span><span class="sxs-lookup"><span data-stu-id="d1088-125">In this scenario it is equally important to make sure you are also allowing traffic onwards to DCs that represent other respective domains, or else delegation fail.</span></span>

-   <span data-ttu-id="d1088-126">Laddove possibile, è consigliabile evitare di posizionare dispositivi IPS/IDS attivi tra gli host del connettore e i controller di dominio, in quanto sono spesso altamente intrusivi e interferiscono con il traffico RPC di base</span><span class="sxs-lookup"><span data-stu-id="d1088-126">Where possible, you should avoid placing any active IPS/IDS devices between connector hosts and DCs, as these are sometimes over intrusive and interfere with core RPC traffic</span></span>

<span data-ttu-id="d1088-127">Per quanto sarebbe auspicabile risolvere i problemi in modo rapido ed efficiente, questa attività può richiedere tempo. Pertanto, laddove possibile, è opportuno testare la delega negli scenari più semplici.</span><span class="sxs-lookup"><span data-stu-id="d1088-127">As much as we’d like to resolve issues quickly and effectively, it can take time, so where possible you should try and test delegation in the simplest of scenarios.</span></span> <span data-ttu-id="d1088-128">Il numero di variabili introdotte è direttamente proporzionale ai problemi da risolvere.</span><span class="sxs-lookup"><span data-stu-id="d1088-128">The more variables you introduce, the more you may have to contend with.</span></span> <span data-ttu-id="d1088-129">Ad esempio, limitare i test a un singolo connettore permette di risparmiare tempo prezioso e, dopo aver risolto i problemi, sarà possibile aggiungere altri connettori.</span><span class="sxs-lookup"><span data-stu-id="d1088-129">For example, limiting your testing to a single connector can save valuable time, and additional connectors can be added after the issues has been resolved.</span></span>

<span data-ttu-id="d1088-130">Alcuni fattori ambientali possono contribuire a un problema. Anche in questo caso, se possibile, ridurre l'architettura al minimo ai fini di test.</span><span class="sxs-lookup"><span data-stu-id="d1088-130">Some environmental factors may also be contributing to an issue, so again if possible try and minimize the architecture to a bare minimum for testing.</span></span> <span data-ttu-id="d1088-131">Spesso, ad esempio, si verificano errori di configurazione negli elenchi di controllo di accesso (ACL) del firewall interno. Se possibile, quindi, consentire tutto il traffico di un connettore direttamente verso i controller di dominio e l'applicazione back-end.</span><span class="sxs-lookup"><span data-stu-id="d1088-131">For example, misconfigured internal firewall ACLs are not uncommon, so if possible have all traffic from a connector allowed straight through to the DCs and backend application.</span></span> 

<span data-ttu-id="d1088-132">La situazione ideale richiede di posizionare i connettori quanto più vicini alle destinazioni.</span><span class="sxs-lookup"><span data-stu-id="d1088-132">Actually the absolute best place to position connectors is as close to their targets as can be.</span></span> <span data-ttu-id="d1088-133">La presenza di un firewall inline durante i test aggiunge inutili complessità e potrebbe prolungare le indagini.</span><span class="sxs-lookup"><span data-stu-id="d1088-133">Having a firewall sat inline whilst testing simply adds unnecessary complexity, and could just prolong your investigations.</span></span>

<span data-ttu-id="d1088-134">In sostanza, che cosa costituisce un problema di delega vincolata Kerberos?</span><span class="sxs-lookup"><span data-stu-id="d1088-134">So, what constitutes a KCD problem anyway?</span></span> <span data-ttu-id="d1088-135">Esistono diverse indicazioni tipiche di problemi con l'accesso SSO della delega vincolata Kerberos: i primi segnali si manifestano in genere nel browser.</span><span class="sxs-lookup"><span data-stu-id="d1088-135">Well, there several classic indications of KCD SSO failing and the first signs of an issue usually manifest themselves in the browser.</span></span>

   ![Errore di configurazione della delega vincolata Kerberos](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic1.png)

   ![Autorizzazione non riuscita a causa di autorizzazioni mancanti](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic2.png)

<span data-ttu-id="d1088-138">Questi messaggi segnalano tutti l'impossibilità di eseguire l'accesso SSO e, di conseguenza, impediscono all'utente l'accesso all'applicazione.</span><span class="sxs-lookup"><span data-stu-id="d1088-138">all which bear the same symptom of failing to perform SSO, and consequently denying the user access to the application.</span></span>

## <a name="troubleshooting"></a><span data-ttu-id="d1088-139">Risoluzione dei problemi</span><span class="sxs-lookup"><span data-stu-id="d1088-139">Troubleshooting</span></span>

<span data-ttu-id="d1088-140">La modalità di risoluzione dipende quindi dal problema e dai sintomi osservati.</span><span class="sxs-lookup"><span data-stu-id="d1088-140">How you then troubleshoot depend on the issue and observed symptoms.</span></span> <span data-ttu-id="d1088-141">Prima di procedere, è consigliabile visitare i collegamenti seguenti, che contengono informazioni utili probabilmente non ancora fornite:</span><span class="sxs-lookup"><span data-stu-id="d1088-141">Before going any further we would suggest the following links, as they contain useful information you may not yet have come across:</span></span>

-   [<span data-ttu-id="d1088-142">Risolvere i problemi e i messaggi di errore del proxy dell'applicazione</span><span class="sxs-lookup"><span data-stu-id="d1088-142">Troubleshoot Application Proxy problems and error messages</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot)

-   [<span data-ttu-id="d1088-143">Errori di Kerberos</span><span class="sxs-lookup"><span data-stu-id="d1088-143">Kerberos errors and symptoms</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-troubleshoot#kerberos-errors)

-   [<span data-ttu-id="d1088-144">Utilizzo dell'accesso Single Sign-On quando le identità cloud e locali non sono identiche</span><span class="sxs-lookup"><span data-stu-id="d1088-144">Working with SSO when on-premises and cloud identities are not identical</span></span>](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd#working-with-sso-when-on-premises-and-cloud-identities-are-not-identical)

<span data-ttu-id="d1088-145">Se si è giunti a questo punto, è senza dubbio presente un problema importante.</span><span class="sxs-lookup"><span data-stu-id="d1088-145">If you’ve got this far, then the main issue definitely exists.</span></span> <span data-ttu-id="d1088-146">È necessario andare più a fondo: per iniziare, separare il flusso in tre fasi distinte di cui è possibile risolvere i problemi.</span><span class="sxs-lookup"><span data-stu-id="d1088-146">You need to dig deeper, so start by separating the flow into three distinct stages that you can troubleshoot.</span></span>

<span data-ttu-id="d1088-147">**Preautenticazione del client**: l'utente esterno che esegue l'autenticazione in Azure tramite un browser.</span><span class="sxs-lookup"><span data-stu-id="d1088-147">**Client pre-authentication** - The external user authenticating to Azure via a browser.</span></span>

<span data-ttu-id="d1088-148">Per garantire il funzionamento dell'accesso SSO della delega vincolata Kerberos, è essenziale poter eseguire la preautenticazione in Azure.</span><span class="sxs-lookup"><span data-stu-id="d1088-148">Being able to pre-authenticate to Azure is imperative for KCD SSO to function.</span></span> <span data-ttu-id="d1088-149">Questa fase deve essere verificata e gestita in prima istanza, in presenza di errori.</span><span class="sxs-lookup"><span data-stu-id="d1088-149">This should be tested and addressed first, if there are any issues.</span></span> <span data-ttu-id="d1088-150">Si noti che la fase di preautenticazione non è in alcun modo correlata alla delega vincolata Kerberos o all'applicazione pubblicata.</span><span class="sxs-lookup"><span data-stu-id="d1088-150">Note that the pre-authentication stage has no relation to KCD or the published application.</span></span> <span data-ttu-id="d1088-151">Dovrebbe essere abbastanza semplice risolvere eventuali discrepanze eseguendo un test di integrità per verificare che l'account sia presente in Azure e non sia disabilitato o bloccato.</span><span class="sxs-lookup"><span data-stu-id="d1088-151">It should be fairly easy to correct any discrepancies by sanity checking the subject account exists in Azure, and that it is not disabled/blocked.</span></span> <span data-ttu-id="d1088-152">La risposta di errore nel browser è in genere sufficientemente descrittiva per comprendere la causa.</span><span class="sxs-lookup"><span data-stu-id="d1088-152">The error response in the browser is usually descriptive enough to understand the cause.</span></span> <span data-ttu-id="d1088-153">In caso di dubbi, è anche possibile controllare i nostri documenti aggiuntivi sulla risoluzione dei problemi.</span><span class="sxs-lookup"><span data-stu-id="d1088-153">You can also check our other Troubleshoot docs to verify if you aren’t sure.</span></span>

<span data-ttu-id="d1088-154">**Servizio di delega**: il connettore del proxy Azure che ottiene un ticket di servizio Kerberos da un centro di distribuzione chiavi Kerberos (KDC) per conto degli utenti.</span><span class="sxs-lookup"><span data-stu-id="d1088-154">**Delegation service** - The Azure Proxy connector obtaining a kerberos service ticket from a KDC (Kerberos Distribution Center), on behalf of users.</span></span>

<span data-ttu-id="d1088-155">Le comunicazioni esterne tra il client e il front-end di Azure non dovrebbero avere comunque alcuna rilevanza sulla delega vincolata Kerberos, se non per garantirne il funzionamento.</span><span class="sxs-lookup"><span data-stu-id="d1088-155">The external communications between the client and the Azure front end should have no bearing on KCD whatsoever, other than ensuring that it works.</span></span> <span data-ttu-id="d1088-156">In questo modo il servizio proxy di Azure può disporre di un ID utente valido che può essere usato per ottenere un ticket Kerberos.</span><span class="sxs-lookup"><span data-stu-id="d1088-156">This is so the Azure Proxy service can be provided with a valid user ID that be used to obtain a kerberos ticket.</span></span> <span data-ttu-id="d1088-157">Senza questa delega vincolata Kerberos non sarebbe possibile e l'operazione avrebbe esito negativo.</span><span class="sxs-lookup"><span data-stu-id="d1088-157">Without this KCD is not possible and would fail.</span></span>

<span data-ttu-id="d1088-158">Come accennato in precedenza, i messaggi di errore del browser offrono in genere alcune indicazioni valide sul motivo per cui si verificano errori.</span><span class="sxs-lookup"><span data-stu-id="d1088-158">As mentioned previously, the browser error messages usually provide some good clues on why things are failing.</span></span> <span data-ttu-id="d1088-159">Accertarsi di indicare l'ID attività e il timestamp nella risposta, poiché consentiranno di associare il comportamento agli eventi effettivi nel log eventi del proxy Azure.</span><span class="sxs-lookup"><span data-stu-id="d1088-159">Make sure to note down the activity ID and timestamp in the response as this allow you to correlate the behavior to actual events in the Azure Proxy event log.</span></span>

   ![Errore di configurazione della delega vincolata Kerberos](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic3.png)

<span data-ttu-id="d1088-161">E le voci corrispondenti visualizzate nel log eventi verrebbero interpretate come eventi 13019 o 12027.</span><span class="sxs-lookup"><span data-stu-id="d1088-161">And the corresponding entries seen the event log would be seen as events 13019 or 12027.</span></span> <span data-ttu-id="d1088-162">I log eventi dei connettori sono disponibili in **Registri applicazioni e servizi** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Connettore**&gt;**Admin (Amministratore)**.</span><span class="sxs-lookup"><span data-stu-id="d1088-162">You can find the connector event logs in **Applications and Services Logs** &gt; **Microsoft** &gt; **AadApplicationProxy** &gt; **Connector**&gt;**Admin**.</span></span>

   ![Evento 13019 del log eventi del proxy dell'applicazione](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic4.png)

   ![Evento 12027 del log eventi del proxy dell'applicazione](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic5.png)

-   <span data-ttu-id="d1088-165">Usare un record A nel DNS interno per l'indirizzo dell'applicazione e non un record CNAME</span><span class="sxs-lookup"><span data-stu-id="d1088-165">Use an A record in your internal DNS for the application’s address, and not a CName</span></span>

-   <span data-ttu-id="d1088-166">Verificare nuovamente che all'host del connettore siano stati concessi i diritti di delega al nome dell'entità servizio (SPN) dell'account di destinazione designato e che sia selezionata l'opzione **Usa un qualsiasi protocollo di autenticazione**.</span><span class="sxs-lookup"><span data-stu-id="d1088-166">Re-confirm that the connector host has been granted the rights to delegate to the designated target account’s SPN, and that **Use any authentication protocol** is selected.</span></span> <span data-ttu-id="d1088-167">Questo argomento è trattato nel nostro articolo principale sulla [configurazione di SSO](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd)</span><span class="sxs-lookup"><span data-stu-id="d1088-167">This is covered in our main [SSO configuration article](https://docs.microsoft.com/azure/active-directory/active-directory-application-proxy-sso-using-kcd)</span></span>

-   <span data-ttu-id="d1088-168">Verificare che in AD sia presente una sola istanza del nome SPN eseguendo un comando **setspn -x** da un prompt dei comandi in un host membro di dominio qualsiasi</span><span class="sxs-lookup"><span data-stu-id="d1088-168">Verify that there is only a single instance of the SPN in existence in AD by issuing a **setspn -x** from a cmd prompt on any domain member host</span></span>

-   <span data-ttu-id="d1088-169">Verificare se sono stati applicati criteri di dominio per limitare la [dimensione massima dei token Kerberos emessi](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), in quanto, se eccessiva, impedisce al connettore di ottenere un token</span><span class="sxs-lookup"><span data-stu-id="d1088-169">Check to see if a domain policy is being enforced to limit the [max size of issued kerberos tokens](https://blogs.technet.microsoft.com/askds/2012/09/12/maxtokensize-and-windows-8-and-windows-server-2012/), as this prevent the connector from obtaining a token if found to be excessive</span></span>

<span data-ttu-id="d1088-170">Una traccia di rete che acquisisca gli scambi tra l'host del connettore e una delega vincolata Kerberos del dominio rappresenta quindi il successivo passaggio ideale per ottenere un livello maggiore di dettaglio sui problemi.</span><span class="sxs-lookup"><span data-stu-id="d1088-170">A network trace capturing the exchanges between the connector host and a domain KDC would then be the next best step in obtaining more low level detail on the issues.</span></span> <span data-ttu-id="d1088-171">Queste informazioni sono disponibili nel [white paper di approfondimento sulla risoluzione dei problemi](https://aka.ms/proxytshootpaper).</span><span class="sxs-lookup"><span data-stu-id="d1088-171">You can find this in [deep dive Troubleshoot paper](https://aka.ms/proxytshootpaper).</span></span>

<span data-ttu-id="d1088-172">Se la creazione di ticket non presenta problemi, verrà visualizzato un evento nei log a indicare che l'autenticazione ha avuto esito negativo a causa di un codice 401 restituito dall'applicazione.</span><span class="sxs-lookup"><span data-stu-id="d1088-172">If ticketing looks good, you should see an event in the logs stating that authentication failed due to the application returning a 401.</span></span> <span data-ttu-id="d1088-173">Ciò indica in genere che l'applicazione di destinazione ha rifiutato il ticket. Procedere alla fase successiva.</span><span class="sxs-lookup"><span data-stu-id="d1088-173">This typically indicates that the target application rejecting your ticket, so proceed with the following next stage.</span></span>

<span data-ttu-id="d1088-174">**Applicazione di destinazione**: il consumer del ticket Kerberos fornito dal connettore</span><span class="sxs-lookup"><span data-stu-id="d1088-174">**Target application** - The consumer of the kerberos ticket provided by the connector</span></span>

<span data-ttu-id="d1088-175">In questa fase il connettore dovrebbe aver inviato un ticket di servizio Kerberos al back-end, sotto forma di intestazione all'interno della prima richiesta dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="d1088-175">At this stage the connector is expected to have sent a kerberos service ticket to the backend, as a header within the first application request.</span></span>

-   <span data-ttu-id="d1088-176">Tramite l'URL interno dell'applicazione definito nel portale, confermare che l'applicazione sia accessibile direttamente dal browser nell'host del connettore.</span><span class="sxs-lookup"><span data-stu-id="d1088-176">Using the application’s internal URL defined in the portal, validate that the application is accessible directly from the browser on the connector host.</span></span> <span data-ttu-id="d1088-177">A questo punto sarà possibile eseguire l'accesso.</span><span class="sxs-lookup"><span data-stu-id="d1088-177">Then you can login successfully.</span></span> <span data-ttu-id="d1088-178">I dettagli a questo proposito sono disponibili nella pagina di risoluzione dei problemi del connettore.</span><span class="sxs-lookup"><span data-stu-id="d1088-178">Details on doing this can be found on the connector Troubleshoot page.</span></span>

-   <span data-ttu-id="d1088-179">Nell'host del connettore confermare che l'autenticazione tra il browser e l'applicazione usi Kerberos, effettuando una delle operazioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="d1088-179">Still on the connector host, confirm that the authentication between the browser and the application is using kerberos, by doing one of the following:</span></span>

1.  <span data-ttu-id="d1088-180">Eseguire Strumenti di sviluppo (**F12**) in Internet Explorer oppure usare [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) dall'host del connettore.</span><span class="sxs-lookup"><span data-stu-id="d1088-180">Run Dev tools(**F12**) in Internet Explorer, or use [Fiddler](https://blogs.msdn.microsoft.com/crminthefield/2012/10/10/using-fiddler-to-check-for-kerberos-auth/) from the connector host.</span></span> <span data-ttu-id="d1088-181">Passare all'applicazione mediante l'URL interno ed esaminare le intestazioni dell'autorizzazione WWW restituite nella risposta dell'applicazione, per garantire che sia presente Negotiate o Kerberos.</span><span class="sxs-lookup"><span data-stu-id="d1088-181">Go to the application using the internal URL, and inspect the offered WWW authorization headers returned in the response from the application, to ensure that either negotiate or kerberos is present.</span></span> <span data-ttu-id="d1088-182">Un BLOB Kerberos restituito successivamente nella risposta del browser all'applicazione inizia in genere con **YII**, pertanto si tratta di un'indicazione valida del fatto che Kerberos è in uso.</span><span class="sxs-lookup"><span data-stu-id="d1088-182">A subsequent kerberos blob returned in the response from the browser to the application typically start with **YII**, so this is a good indication of kerberos being in play.</span></span> <span data-ttu-id="d1088-183">NTLM, d'altro canto, inizia sempre con **TlRMTVNTUAAB** (NTLMSSP in caso di decodifica da Base64).</span><span class="sxs-lookup"><span data-stu-id="d1088-183">NTLM on the other hand always start with **TlRMTVNTUAAB**, which reads NTLMSSP when decoded from Base64.</span></span> <span data-ttu-id="d1088-184">Se **TlRMTVNTUAAB** è presente all'inizio del BLOB, Kerberos **non** è disponibile.</span><span class="sxs-lookup"><span data-stu-id="d1088-184">If you see **TlRMTVNTUAAB** at the start of the blob, this means that Kerberos is **not** available.</span></span> <span data-ttu-id="d1088-185">In caso contrario, Kerberos dovrebbe essere disponibile.</span><span class="sxs-lookup"><span data-stu-id="d1088-185">If you don’t see this, Kerberos is likely available.</span></span>

  * <span data-ttu-id="d1088-186">Si noti che, se si usa Fiddler, questo metodo richiedere la disabilitazione temporanea della protezione estesa sulla configurazione dell'applicazione in IIS.</span><span class="sxs-lookup"><span data-stu-id="d1088-186">Note, if using Fiddler, this method would require temporarily disabling extended protection on the application’s config in IIS.</span></span>

     ![Finestra di controllo di rete del browser](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic6.png)

    <span data-ttu-id="d1088-188">*Figura:* poiché non inizia con TIRMTVNTUAAB, questo esempio indica che Kerberos è disponibile.</span><span class="sxs-lookup"><span data-stu-id="d1088-188">*Figure:* Since this does not start with TIRMTVNTUAAB, this is an example that Kerberos is available.</span></span> <span data-ttu-id="d1088-189">Si tratta di un esempio di un BLOB Kerberos che non inizia con YII.</span><span class="sxs-lookup"><span data-stu-id="d1088-189">This is an example of a Kerberos Blob that doesn’t start with YII.</span></span>

2.  <span data-ttu-id="d1088-190">Rimuovere temporaneamente NTLM dall'elenco dei provider nel sito IIS e accedere all'app direttamente da Internet Explorer nell'host del connettore.</span><span class="sxs-lookup"><span data-stu-id="d1088-190">Temporarily remove NTLM from the providers list on IIS site and access app directly from IE on connector host.</span></span> <span data-ttu-id="d1088-191">Dopo aver rimosso NTLM dall'elenco dei provider, sarà possibile accedere all'applicazione solo mediante Kerberos.</span><span class="sxs-lookup"><span data-stu-id="d1088-191">With NTLM no longer in the providers list, you should be able to access the application using Kerberos only.</span></span> <span data-ttu-id="d1088-192">In caso di errore, si è verificato un problema con la configurazione dell'applicazione e l'autenticazione Kerberos non funziona.</span><span class="sxs-lookup"><span data-stu-id="d1088-192">If this fails, then that suggests that there is a problem with the application’s configuration and Kerberos authentication is not functioning.</span></span>

<span data-ttu-id="d1088-193">Se Kerberos non è disponibile, controllare le impostazioni di autenticazione dell'applicazione in IIS per verificare che Negotiate si trovi in cima all'elenco e NTLM al di sotto di esso</span><span class="sxs-lookup"><span data-stu-id="d1088-193">If Kerberos is not available, then check the application’s authentication settings in IIS to make sure negotiate is listed topmost, with NTLM just beneath it.</span></span> <span data-ttu-id="d1088-194">(Not Negotiate:kerberos o Negotiate:PKU2U).</span><span class="sxs-lookup"><span data-stu-id="d1088-194">(Not Negotiate:kerberos or Negotiate:PKU2U).</span></span> <span data-ttu-id="d1088-195">Procedere solo se Kerberos funziona.</span><span class="sxs-lookup"><span data-stu-id="d1088-195">Only continue if Kerberos is functional.</span></span>

   ![Provider di autenticazione di Windows](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic7.png)
   
-   <span data-ttu-id="d1088-197">Con Kerberos e NTLM disponibili, disabilitare temporaneamente la preautenticazione per l'applicazione nel portale.</span><span class="sxs-lookup"><span data-stu-id="d1088-197">With Kerberos and NTLM in place, lets now temporarily disable pre-authentication for the application in the portal.</span></span> <span data-ttu-id="d1088-198">Verificare se è possibile accedervi da Internet tramite l'URL esterno.</span><span class="sxs-lookup"><span data-stu-id="d1088-198">See if you can access it from the internet using the external URL.</span></span> <span data-ttu-id="d1088-199">Verrà richiesto di eseguire l'autenticazione, per la quale sarà possibile usare lo stesso account del passaggio precedente.</span><span class="sxs-lookup"><span data-stu-id="d1088-199">You should be prompted to authenticate and should be able to do so with the same account used in the previous step.</span></span> <span data-ttu-id="d1088-200">In caso contrario, si è verificato un problema con l'applicazione back-end e non con la delega vincolata Kerberos.</span><span class="sxs-lookup"><span data-stu-id="d1088-200">If not, this indicates a problem with the backend application and not KCD at all.</span></span>

-   <span data-ttu-id="d1088-201">Riabilitare la preautenticazione nel portale ed eseguire l'autenticazione tramite Azure tentando di connettersi all'applicazione tramite l'URL esterno.</span><span class="sxs-lookup"><span data-stu-id="d1088-201">Now re-enable pre-authentication in the portal and authenticate through Azure by attempting to connect to the application via it’s external URL.</span></span> <span data-ttu-id="d1088-202">Se l'accesso SSO ha esito negativo, verranno visualizzati un messaggio di errore non consentito nel browser e l'evento 13022 nel log:</span><span class="sxs-lookup"><span data-stu-id="d1088-202">If SSO has failed, then you should see a forbidden error message in the browser, plus event 13022 in the log:</span></span>

    <span data-ttu-id="d1088-203">*Microsoft AAD Application Proxy Connector non riesce ad autenticare l'utente perché il server back-end risponde ai tentativi di autenticazione Kerberos con un errore HTTP 401.*</span><span class="sxs-lookup"><span data-stu-id="d1088-203">*Microsoft AAD Application Proxy Connector cannot authenticate the user because the backend server responds to Kerberos authentication attempts with an HTTP 401 error.*</span></span>

    ![Errore HTTP 401 non consentito](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic8.png)

-   <span data-ttu-id="d1088-205">Controllare l'applicazione IIS per verificare che il pool di applicazioni sia configurato per l'uso dello stesso account con cui è stato configurato il nome SPN in Active Directory navigando in IIS come illustrato di seguito</span><span class="sxs-lookup"><span data-stu-id="d1088-205">Check the IIS application to ensure the configured application pool is configured to use the same account that the SPN has been configured against in AD, by navigating in IIS as illustrated below</span></span>

    ![Finestra di configurazione dell'applicazione IIS](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic9.png)

    <span data-ttu-id="d1088-207">Quando si conosce l'identità, eseguire il comando seguente da un prompt dei comandi per verificare che questo account sia configurato con il nome SPN in questione.</span><span class="sxs-lookup"><span data-stu-id="d1088-207">Once you know the identity, issue the following from a cmd prompt to make sure this account is definitely configured with the SPN in question.</span></span> <span data-ttu-id="d1088-208">Ad esempio, **setspn – q http/spn.wacketywack.com**</span><span class="sxs-lookup"><span data-stu-id="d1088-208">For example,  **setspn – q http/spn.wacketywack.com**</span></span>

    ![Finestra di comando SetSPN](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic10.png)

-   <span data-ttu-id="d1088-210">Verificare che il nome SPN definito in base alle impostazioni dell'applicazione nel portale sia lo stesso nome SPN configurato in base all'account Active Directory di destinazione usato dal pool di applicazioni</span><span class="sxs-lookup"><span data-stu-id="d1088-210">Check that the SPN defined against the application’s settings in the portal is the same SPN that is configured against the target AD account in use by the application’s app pool</span></span>

   ![Configurazione del nome SPN nel Portale di Azure](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic11.png)
   
-   <span data-ttu-id="d1088-212">Passare a IIS e selezionare l'opzione **Editor di configurazione** per l'applicazione, quindi navigare a **system.webServer/security/authentication/windowsAuthentication** per verificare che **UseAppPoolCredentials** sia impostato su true</span><span class="sxs-lookup"><span data-stu-id="d1088-212">Go into IIS and select the **Configuration Editor** option for the application, and navigate to **system.webServer/security/authentication/windowsAuthentication** to make sure that **UseAppPoolCredentials** is set to true</span></span>

   ![Opzione delle credenziali dei pool di applicazioni della configurazione IIS](./media/application-proxy-back-end-kerberos-constrained-delegation-how-to/graphic12.png)

<span data-ttu-id="d1088-214">Oltre a risultare utile per migliorare le prestazioni delle operazioni Kerberos, l'abilitazione della modalità Kernel determina la decrittografia del ticket per il servizio richiesto con l'account del computer.</span><span class="sxs-lookup"><span data-stu-id="d1088-214">While being useful in improving the performance of Kerberos operations, leaving Kernel mode enabled also causes the ticket for the requested service to be decrypted using machine account.</span></span> <span data-ttu-id="d1088-215">Questo è anche noto come sistema locale, pertanto la sua impostazione su true interrompe la delega vincolata Kerberos quando l'applicazione è ospitata in più server in una farm.</span><span class="sxs-lookup"><span data-stu-id="d1088-215">This is also called the Local system, so having this set to true break KCD when the application is hosted across multiple servers in a farm.</span></span>

-   <span data-ttu-id="d1088-216">Come verifica aggiuntiva, è possibile disabilitare anche la protezione **estesa**.</span><span class="sxs-lookup"><span data-stu-id="d1088-216">As an additional check, you may also want to disable the **Extended** protection too.</span></span> <span data-ttu-id="d1088-217">In alcuni scenari è emerso che questa impostazione interrompe la delega vincolata Kerberos se abilitata in configurazioni particolarmente specifiche, in cui un'applicazione viene pubblicata come sottocartella del sito Web predefinito.</span><span class="sxs-lookup"><span data-stu-id="d1088-217">There have been encountered scenarios where this has proved to break KCD when enabled in very specific configurations, where an application is published as a sub folder of the Default Web site.</span></span> <span data-ttu-id="d1088-218">Questa stessa impostazione è configurata solo per l'autenticazione anonima, lasciando le finestre di dialogo disattivate a indicare che gli oggetti figlio non erediteranno impostazioni attive.</span><span class="sxs-lookup"><span data-stu-id="d1088-218">This itself is configured for Anonymous authentication only, leaving the entire dialogs greyed out suggesting child objects would not be inheriting any active settings.</span></span> <span data-ttu-id="d1088-219">Laddove possibile è comunque consigliabile mantenere abilitata questa impostazione. Eseguire i test, ma non dimenticare di riabilitarla.</span><span class="sxs-lookup"><span data-stu-id="d1088-219">But where possible we would always recommend having this enabled, so by all means test, but don’t forget to restore this to enabled.</span></span>

<span data-ttu-id="d1088-220">Questi controlli aggiuntivi dovrebbero consentire di iniziare a usare correttamente l'applicazione pubblicata.</span><span class="sxs-lookup"><span data-stu-id="d1088-220">These additional checks should have put you on track to start using your published application.</span></span> <span data-ttu-id="d1088-221">È possibile proseguire ed eseguire lo spin up di altri connettori configurati per la delega ma, se l'operazione ha esito negativo, è consigliabile leggere la nostra procedura tecnica dettagliata nella [Guida completa alla risoluzione dei problemi del proxy dell'applicazione di Azure AD](https://aka.ms/proxytshootpaper)</span><span class="sxs-lookup"><span data-stu-id="d1088-221">You can go ahead and spin up additional connectors that are also configured to delegate, but if things are no further then we would suggest a read of our more in-depth technical walkthrough [The complete guide for Troubleshoot Azure AD Application Proxy](https://aka.ms/proxytshootpaper)</span></span>

<span data-ttu-id="d1088-222">Se il problema persiste, il supporto è a disposizione per fornire assistenza e procedere da questo punto.</span><span class="sxs-lookup"><span data-stu-id="d1088-222">If you’re still unable to progress your issue, support would be more than happy to assist and continue from here.</span></span> <span data-ttu-id="d1088-223">Creare un ticket di supporto direttamente all'interno del portale per essere contattati dai nostri ingegneri.</span><span class="sxs-lookup"><span data-stu-id="d1088-223">Create a support ticket directly within the portal and our engineers will reach out to you.</span></span>

## <a name="other-scenarios"></a><span data-ttu-id="d1088-224">Altri scenari</span><span class="sxs-lookup"><span data-stu-id="d1088-224">Other scenarios</span></span>

-   <span data-ttu-id="d1088-225">Il proxy dell'applicazione Azure richiede un ticket Kerberos prima dell'invio della richiesta a un'applicazione.</span><span class="sxs-lookup"><span data-stu-id="d1088-225">Azure Application Proxy requests a Kerberos ticket before sending its request to an application.</span></span> <span data-ttu-id="d1088-226">Alcune applicazioni di terze parti, ad esempio Tableau Server, non implementano questo metodo di autenticazione, preferendo l'approccio più tradizionale delle negoziazioni.</span><span class="sxs-lookup"><span data-stu-id="d1088-226">Some 3rd party applications such as Tableau Server do not like this method of authenticating, and rather expects the more conventional negotiations to take place,.</span></span> <span data-ttu-id="d1088-227">La prima richiesta è anonima, consentendo all'applicazione di rispondere con i tipi di autenticazione supportati tramite un codice 401.</span><span class="sxs-lookup"><span data-stu-id="d1088-227">The first request is anonymous, allowing the application to respond with the authentication types that it supports through a 401.</span></span>

-   <span data-ttu-id="d1088-228">Autenticazione a doppio hop: generalmente usata negli scenari con applicazioni a livelli, con un back-end e un front-end che richiedono l'autenticazione, ad esempio SQL Reporting Services.</span><span class="sxs-lookup"><span data-stu-id="d1088-228">Double hop authentication - Commonly used in scenarios where an application is tiered, with a backend and front end, both requiring authentication, such as SQL Reporting Services.</span></span>

## <a name="next-steps"></a><span data-ttu-id="d1088-229">Passaggi successivi</span><span class="sxs-lookup"><span data-stu-id="d1088-229">Next steps</span></span>
[<span data-ttu-id="d1088-230">Configurare la delega vincolata Kerberos (KCD) in un dominio gestito</span><span class="sxs-lookup"><span data-stu-id="d1088-230">Configure kerberos constrained delegation (KCD) on a managed domain</span></span>](https://docs.microsoft.com/azure/active-directory-domain-services/active-directory-ds-enable-kcd)
