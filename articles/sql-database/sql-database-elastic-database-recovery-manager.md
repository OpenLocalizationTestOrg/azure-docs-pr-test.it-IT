---
title: Uso di Gestione ripristino per risolvere i problemi della mappe partizioni | Microsoft Docs
description: Usare la classe RecoveryManager per risolvere i problemi relativi alle mappe partizioni.
services: sql-database
documentationcenter: 
manager: jhubbard
author: ddove
ms.assetid: 45520ca3-6903-4b39-88ba-1d41b22da9fe
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/25/2016
ms.author: ddove
ms.openlocfilehash: e60e2295484873ea15d52108b7d619319a57827f
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 07/11/2017
---
# <a name="using-the-recoverymanager-class-to-fix-shard-map-problems"></a><span data-ttu-id="975e6-103">Uso della classe RecoveryManager per correggere i problemi delle mappe partizioni</span><span class="sxs-lookup"><span data-stu-id="975e6-103">Using the RecoveryManager class to fix shard map problems</span></span>
<span data-ttu-id="975e6-104">La classe [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) consente alle applicazioni ADO.NET di rilevare e correggere facilmente le eventuali incoerenze tra la mappa globale partizioni e la mappa locale partizioni in un ambiente di database partizionato.</span><span class="sxs-lookup"><span data-stu-id="975e6-104">The [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) class provides ADO.Net applications the ability to easily detect and correct any inconsistencies between the global shard map (GSM) and the local shard map (LSM) in a sharded database environment.</span></span> 

<span data-ttu-id="975e6-105">La mappa globale partizioni e la mappa locale partizioni tengono traccia del mapping di ogni database in un ambiente partizionato.</span><span class="sxs-lookup"><span data-stu-id="975e6-105">The GSM and LSM track the mapping of each database in a sharded environment.</span></span> <span data-ttu-id="975e6-106">Si verifica a volte un'interruzione tra la mappa globale partizioni e la mappa locale partizioni.</span><span class="sxs-lookup"><span data-stu-id="975e6-106">Occasionally, a break occurs between the GSM and the LSM.</span></span> <span data-ttu-id="975e6-107">In tal caso usare la classe RecoveryManager per rilevare e correggere l'interruzione.</span><span class="sxs-lookup"><span data-stu-id="975e6-107">In that case, use the RecoveryManager class to detect and repair the break.</span></span>

<span data-ttu-id="975e6-108">La classe RecoveryManager fa parte della [Libreria client dei database elastici](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="975e6-108">The RecoveryManager class is part of the [Elastic Database client library](sql-database-elastic-database-client-library.md).</span></span> 

![Mappa partizioni][1]

<span data-ttu-id="975e6-110">Per le definizioni dei termini, vedere il [Glossario degli strumenti di database elastici](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="975e6-110">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span> <span data-ttu-id="975e6-111">Per informazioni su come usare **ShardMapManager** per gestire dati in una soluzione partizionata, vedere [Gestione mappe partizioni](sql-database-elastic-scale-shard-map-management.md).</span><span class="sxs-lookup"><span data-stu-id="975e6-111">To understand how the **ShardMapManager** is used to manage data in a sharded solution, see [Shard map management](sql-database-elastic-scale-shard-map-management.md).</span></span>

## <a name="why-use-the-recovery-manager"></a><span data-ttu-id="975e6-112">Perché usare Gestione ripristino</span><span class="sxs-lookup"><span data-stu-id="975e6-112">Why use the recovery manager?</span></span>
<span data-ttu-id="975e6-113">In un ambiente di database partizionato c'è un unico tenant per database e ci sono molti database per server.</span><span class="sxs-lookup"><span data-stu-id="975e6-113">In a sharded database environment, there is one tenant per database, and many databases per server.</span></span> <span data-ttu-id="975e6-114">Nell'ambiente possono anche esserci molti server.</span><span class="sxs-lookup"><span data-stu-id="975e6-114">There can also be many servers in the environment.</span></span> <span data-ttu-id="975e6-115">Ogni database è mappato nella mappa partizioni, quindi le chiamate possono essere instradate correttamente al server e al database appropriati.</span><span class="sxs-lookup"><span data-stu-id="975e6-115">Each database is mapped in the shard map, so calls can be routed to the correct server and database.</span></span> <span data-ttu-id="975e6-116">I database vengono rilevati in base a una **chiave di partizionamento orizzontale** e a ogni partizione viene assegnato un **intervallo di valori di chiave**.</span><span class="sxs-lookup"><span data-stu-id="975e6-116">Databases are tracked according to a **sharding key**, and each shard is assigned a **range of key values**.</span></span> <span data-ttu-id="975e6-117">Ad esempio, una chiave di partizionamento orizzontale può rappresentare i nomi dei clienti da "D" a "F."</span><span class="sxs-lookup"><span data-stu-id="975e6-117">For example, a sharding key may represent the customer names from "D" to "F."</span></span> <span data-ttu-id="975e6-118">Il mapping di tutte le partizioni (ovvero i database) e i relativi intervalli di mapping sono inclusi nella **mappa globale partizioni**.</span><span class="sxs-lookup"><span data-stu-id="975e6-118">The mapping of all shards (aka databases) and their mapping ranges are contained in the **global shard map (GSM)**.</span></span> <span data-ttu-id="975e6-119">Ogni database include anche una mappa degli intervalli presenti nella partizione, ovvero la **mappa locale partizioni**.</span><span class="sxs-lookup"><span data-stu-id="975e6-119">Each database also contains a map of the ranges contained on the shard that is known as the **local shard map (LSM)**.</span></span> <span data-ttu-id="975e6-120">Quando un'app si connette a una partizione, il mapping viene memorizzato nella cache insieme all'app per consentire un recupero rapido.</span><span class="sxs-lookup"><span data-stu-id="975e6-120">When an app connects to a shard, the mapping is cached with the app for quick retrieval.</span></span> <span data-ttu-id="975e6-121">La mappa locale partizioni si usa per convalidare i dati memorizzati nella cache.</span><span class="sxs-lookup"><span data-stu-id="975e6-121">The LSM is used to validate cached data.</span></span> 

<span data-ttu-id="975e6-122">La mappa globale e locale delle partizioni potrebbero perdere la sincronizzazione per i motivi seguenti:</span><span class="sxs-lookup"><span data-stu-id="975e6-122">The GSM and LSM may become out of sync for the following reasons:</span></span>

1. <span data-ttu-id="975e6-123">L'eliminazione di una partizione con un intervallo che si ritiene non più usato o la ridenominazione della partizione.</span><span class="sxs-lookup"><span data-stu-id="975e6-123">The deletion of a shard whose range is believed to no longer be in use, or renaming of a shard.</span></span> <span data-ttu-id="975e6-124">Eliminazione dei risultati di una partizione in un **mapping di partizione orfana**.</span><span class="sxs-lookup"><span data-stu-id="975e6-124">Deleting a shard results in an **orphaned shard mapping**.</span></span> <span data-ttu-id="975e6-125">Analogamente, anche un database rinominato può causare un mapping di partizione orfana.</span><span class="sxs-lookup"><span data-stu-id="975e6-125">Similarly, a renamed database can cause an orphaned shard mapping.</span></span> <span data-ttu-id="975e6-126">A seconda della finalità della modifica, potrebbe essere necessario rimuovere la partizione o aggiornarne il percorso.</span><span class="sxs-lookup"><span data-stu-id="975e6-126">Depending on the intent of the change, the shard may need to be removed or the shard location needs to be updated.</span></span> <span data-ttu-id="975e6-127">Per ripristinare un database eliminato, vedere [Ripristinare un database SQL di Azure con il portale di Azure](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="975e6-127">To recover a deleted database, see [Restore a deleted database](sql-database-recovery-using-backups.md).</span></span>
2. <span data-ttu-id="975e6-128">Si verifica un evento di failover geografico.</span><span class="sxs-lookup"><span data-stu-id="975e6-128">A geo-failover event occurs.</span></span> <span data-ttu-id="975e6-129">Per continuare, è necessario aggiornare il nome del server e il nome del database dello strumento di gestione della mappa partizioni all'interno dell'applicazione e quindi aggiornare i dettagli del mapping di partizione per tutte le partizioni nella mappa partizioni.</span><span class="sxs-lookup"><span data-stu-id="975e6-129">To continue, one must update the server name, and database name of shard map manager in the application and then update the shard mapping details for all shards in a shard map.</span></span> <span data-ttu-id="975e6-130">In caso di failover geografico, è necessario che la logica di ripristino sia automatizzata nel flusso di lavoro di failover.</span><span class="sxs-lookup"><span data-stu-id="975e6-130">If there is a geo-failover, such recovery logic should be automated within the failover workflow.</span></span> <span data-ttu-id="975e6-131">L'automazione delle azioni di ripristino rende possibile la gestibilità senza problemi dei database abilitati per la replica geografica, evitando interventi manuali.</span><span class="sxs-lookup"><span data-stu-id="975e6-131">Automating recovery actions enables a frictionless manageability for geo-enabled databases and avoids manual human actions.</span></span> <span data-ttu-id="975e6-132">Per informazioni sulle opzioni per ripristinare un database in caso di interruzione del data center, vedere [Continuità aziendale](sql-database-business-continuity.md) e [Ripristino di emergenza](sql-database-disaster-recovery.md).</span><span class="sxs-lookup"><span data-stu-id="975e6-132">To learn about options to recover a database if there is a data center outage, see [Business Continuity](sql-database-business-continuity.md) and [Disaster Recovery](sql-database-disaster-recovery.md).</span></span>
3. <span data-ttu-id="975e6-133">Una partizione o un database ShardMapManager viene ripristinato a una condizione precedente.</span><span class="sxs-lookup"><span data-stu-id="975e6-133">Either a shard or the ShardMapManager database is restored to an earlier point-in time.</span></span> <span data-ttu-id="975e6-134">Per informazioni sul recupero temporizzato tramite i backup, vedere l'articolo sul [ripristino mediante backup](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="975e6-134">To learn about point in time recovery using backups, see [Recovery using backups](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="975e6-135">Per altre informazioni sugli strumenti di database elastici per i database SQL di Azure, la replica geografica e il ripristino, vedere:</span><span class="sxs-lookup"><span data-stu-id="975e6-135">For more information about Azure SQL Database Elastic Database tools, geo-replication and Restore, see the following:</span></span> 

* [<span data-ttu-id="975e6-136">Panoramica: Continuità aziendale del cloud e ripristino di emergenza del database con database SQL</span><span class="sxs-lookup"><span data-stu-id="975e6-136">Overview: Cloud business continuity and database disaster recovery with SQL Database</span></span>](sql-database-business-continuity.md) 
* [<span data-ttu-id="975e6-137">Iniziare a utilizzare gli strumenti di database elastici</span><span class="sxs-lookup"><span data-stu-id="975e6-137">Get started with elastic database tools</span></span>](sql-database-elastic-scale-get-started.md)  
* [<span data-ttu-id="975e6-138">Gestione di mappe partizioni</span><span class="sxs-lookup"><span data-stu-id="975e6-138">ShardMap Management</span></span>](sql-database-elastic-scale-shard-map-management.md)

## <a name="retrieving-recoverymanager-from-a-shardmapmanager"></a><span data-ttu-id="975e6-139">Ripristino di RecoveryManager da un oggetto ShardMapManager</span><span class="sxs-lookup"><span data-stu-id="975e6-139">Retrieving RecoveryManager from a ShardMapManager</span></span>
<span data-ttu-id="975e6-140">Il primo passaggio consiste nel creare un'istanza di RecoveryManager.</span><span class="sxs-lookup"><span data-stu-id="975e6-140">The first step is to create a RecoveryManager instance.</span></span> <span data-ttu-id="975e6-141">Il [metodo GetRecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) restituisce la funzionalità di Gestione ripristino per l'istanza corrente di [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx).</span><span class="sxs-lookup"><span data-stu-id="975e6-141">The [GetRecoveryManager method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) returns the recovery manager for the current [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) instance.</span></span> <span data-ttu-id="975e6-142">Per risolvere eventuali incoerenze in una mappa partizioni, è necessario ripristinare prima di tutto RecoveryManager per una mappa partizioni specifica.</span><span class="sxs-lookup"><span data-stu-id="975e6-142">To address any inconsistencies in the shard map, you must first retrieve the RecoveryManager for the particular shard map.</span></span> 

   ```
    ShardMapManager smm = ShardMapManagerFactory.GetSqlShardMapManager(smmConnnectionString,  
             ShardMapManagerLoadPolicy.Lazy);
             RecoveryManager rm = smm.GetRecoveryManager(); 
   ```

<span data-ttu-id="975e6-143">In questo esempio RecoveryManager viene inizializzato da ShardMapManager.</span><span class="sxs-lookup"><span data-stu-id="975e6-143">In this example, the RecoveryManager is initialized from the ShardMapManager.</span></span> <span data-ttu-id="975e6-144">Anche ShardMapManager che contiene un oggetto ShardMap è già inizializzato.</span><span class="sxs-lookup"><span data-stu-id="975e6-144">The ShardMapManager containing a ShardMap is also already initialized.</span></span> 

<span data-ttu-id="975e6-145">Poiché questo codice dell'applicazione manipola la mappa partizioni stessa, le credenziali usate nel metodo factory, nell'esempio precedente smmConnectionString, devono essere credenziali con autorizzazioni di lettura/scrittura per il database GSM a cui si fa riferimento nella stringa di connessione.</span><span class="sxs-lookup"><span data-stu-id="975e6-145">Since this application code manipulates the shard map itself, the credentials used in the factory method (in the preceding example, smmConnectionString) should be credentials that have read-write permissions on the GSM database referenced by the connection string.</span></span> <span data-ttu-id="975e6-146">Queste credenziali sono in genere diverse da quelle usate per aprire connessioni per il routing dipendente dai dati.</span><span class="sxs-lookup"><span data-stu-id="975e6-146">These credentials are typically different from credentials used to open connections for data-dependent routing.</span></span> <span data-ttu-id="975e6-147">Per ulteriori informazioni, vedere [Gestione delle credenziali nella libreria client dei database elastici](sql-database-elastic-scale-manage-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="975e6-147">For more information, see [Using credentials in the elastic database client](sql-database-elastic-scale-manage-credentials.md).</span></span>

## <a name="removing-a-shard-from-the-shardmap-after-a-shard-is-deleted"></a><span data-ttu-id="975e6-148">Rimozione di una partizione da ShardMap dopo l'eliminazione di una partizione</span><span class="sxs-lookup"><span data-stu-id="975e6-148">Removing a shard from the ShardMap after a shard is deleted</span></span>
<span data-ttu-id="975e6-149">Il [metodo DetachShard](https://msdn.microsoft.com/library/azure/dn842083.aspx) scollega la partizione specificata dalla mappa partizioni ed elimina i mapping associati alla partizione.</span><span class="sxs-lookup"><span data-stu-id="975e6-149">The [DetachShard method](https://msdn.microsoft.com/library/azure/dn842083.aspx) detaches the given shard from the shard map and deletes mappings associated with the shard.</span></span>  

* <span data-ttu-id="975e6-150">Il parametro location corrisponde al percorso della partizione, cioè il nome del server e il nome del database, della partizione che viene scollegata.</span><span class="sxs-lookup"><span data-stu-id="975e6-150">The location parameter is the shard location, specifically server name and database name, of the shard being detached.</span></span> 
* <span data-ttu-id="975e6-151">Il parametro shardMapName è il nome della mappa partizioni.</span><span class="sxs-lookup"><span data-stu-id="975e6-151">The shardMapName parameter is the shard map name.</span></span> <span data-ttu-id="975e6-152">È richiesto solo quando più mappe partizioni sono gestite dallo stesso gestore delle mappe partizioni.</span><span class="sxs-lookup"><span data-stu-id="975e6-152">This is only required when multiple shard maps are managed by the same shard map manager.</span></span> <span data-ttu-id="975e6-153">facoltativo.</span><span class="sxs-lookup"><span data-stu-id="975e6-153">Optional.</span></span> 


> [!IMPORTANT]
> <span data-ttu-id="975e6-154">usare questa tecnica solo se si è certi che l'intervallo per il mapping aggiornato sia vuoto.</span><span class="sxs-lookup"><span data-stu-id="975e6-154">Use this technique only if you are certain that the range for the updated mapping is empty.</span></span> <span data-ttu-id="975e6-155">Poiché i metodi descritti precedentemente non controllano i dati dell'intervallo da spostare, è consigliabile includere i controlli nel codice.</span><span class="sxs-lookup"><span data-stu-id="975e6-155">The methods above do not check data for the range being moved, so it is best to include checks in your code.</span></span>
>

<span data-ttu-id="975e6-156">Questo esempio rimuove le partizioni dalla mappa partizioni.</span><span class="sxs-lookup"><span data-stu-id="975e6-156">This example removes shards from the shard map.</span></span> 

   ```
   rm.DetachShard(s.Location, customerMap);
   ``` 

<span data-ttu-id="975e6-157">La mappa partizioni riflette il percorso della partizione nella mappa globale delle partizioni precedente l'eliminazione della partizione.</span><span class="sxs-lookup"><span data-stu-id="975e6-157">The shard map reflects the shard location in the GSM before the deletion of the shard.</span></span> <span data-ttu-id="975e6-158">Poiché la partizione è stata eliminata, si presuppone che questa operazione sia stata intenzionale che l'intervallo di chiavi di partizionamento orizzontale non venga più usato.</span><span class="sxs-lookup"><span data-stu-id="975e6-158">Because the shard was deleted, it is assumed this was intentional, and the sharding key range is no longer in use.</span></span> <span data-ttu-id="975e6-159">Se non è questo il caso, è possibile eseguire un ripristino temporizzato.</span><span class="sxs-lookup"><span data-stu-id="975e6-159">If not, you can execute point-in time restore.</span></span> <span data-ttu-id="975e6-160">Per ripristinare le partizioni da un punto nel tempo precedente.</span><span class="sxs-lookup"><span data-stu-id="975e6-160">to recover the shard from an earlier point-in-time.</span></span> <span data-ttu-id="975e6-161">In questo caso, vedere la sezione seguente per rilevare le incoerenze della partizione. Per eseguire il ripristino, vedere [Recupero temporizzato](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="975e6-161">(In that case, review the following section to detect shard inconsistencies.) To recover, see [Point in time recovery](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="975e6-162">Presupponendo che l'eliminazione del database sia stata intenzionale, l'azione di pulizia amministrativa finale consiste nell'eliminare la voce relativa alla partizione nel gestore delle mappe partizioni.</span><span class="sxs-lookup"><span data-stu-id="975e6-162">Since it is assumed the database deletion was intentional, the final administrative cleanup action is to delete the entry to the shard in the shard map manager.</span></span> <span data-ttu-id="975e6-163">In questo modo si impedisce all'applicazione di scrivere inavvertitamente informazioni in un intervallo non previsto.</span><span class="sxs-lookup"><span data-stu-id="975e6-163">This prevents the application from inadvertently writing information to a range that is not expected.</span></span>

## <a name="to-detect-mapping-differences"></a><span data-ttu-id="975e6-164">Per rilevare le differenze nei mapping</span><span class="sxs-lookup"><span data-stu-id="975e6-164">To detect mapping differences</span></span>
<span data-ttu-id="975e6-165">Il [metodo DetectMappingDifferences](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) seleziona e restituisce una della mappe partizioni, locale o globale, come origine di dati reali e riconcilia i mapping in entrambi i tipi di mappa partizioni, globale e locale.</span><span class="sxs-lookup"><span data-stu-id="975e6-165">The [DetectMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) selects and returns one of the shard maps (either local or global) as the source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   rm.DetectMappingDifferences(location, shardMapName);
   ```

* <span data-ttu-id="975e6-166">Il *percorso* specifica il nome del server e il nome del database.</span><span class="sxs-lookup"><span data-stu-id="975e6-166">The *location* specifies the server name and database name.</span></span> 
* <span data-ttu-id="975e6-167">Il parametro *shardMapName* è il nome della mappa partizioni.</span><span class="sxs-lookup"><span data-stu-id="975e6-167">The *shardMapName* parameter is the shard map name.</span></span> <span data-ttu-id="975e6-168">È richiesto solo se più mappe partizioni sono gestite dallo stesso gestore delle mappe partizioni.</span><span class="sxs-lookup"><span data-stu-id="975e6-168">This is only required if multiple shard maps are managed by the same shard map manager.</span></span> <span data-ttu-id="975e6-169">Facoltativo.</span><span class="sxs-lookup"><span data-stu-id="975e6-169">Optional.</span></span> 

## <a name="to-resolve-mapping-differences"></a><span data-ttu-id="975e6-170">Per risolvere le differenze nei mapping</span><span class="sxs-lookup"><span data-stu-id="975e6-170">To resolve mapping differences</span></span>
<span data-ttu-id="975e6-171">Il [metodo ResolveMappingDifferences](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) seleziona una delle mappe partizioni, locale o globale, come origine di dati reali e riconcilia i mapping in entrambi i tipi di mappa partizioni, globale e locale.</span><span class="sxs-lookup"><span data-stu-id="975e6-171">The [ResolveMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) selects one of the shard maps (either local or global) as the source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   ResolveMappingDifferences (RecoveryToken, MappingDifferenceResolution.KeepShardMapping);
   ```

* <span data-ttu-id="975e6-172">Il parametro *RecoveryToken* enumera le differenze nei mapping tra la mappa globale di partizioni e la mappa locale di partizioni per la partizione specifica.</span><span class="sxs-lookup"><span data-stu-id="975e6-172">The *RecoveryToken* parameter enumerates the differences in the mappings between the GSM and the LSM for the specific shard.</span></span> 
* <span data-ttu-id="975e6-173">L' [enumerazione MappingDifferenceResolution](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) viene usata per indicare il metodo per risolvere la differenza tra i mapping di partizione.</span><span class="sxs-lookup"><span data-stu-id="975e6-173">The [MappingDifferenceResolution enumeration](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) is used to indicate the method for resolving the difference between the shard mappings.</span></span> 
* <span data-ttu-id="975e6-174">È consigliabile usare **MappingDifferenceResolution.KeepShardMapping** qualora la mappa locale partizioni contenga il mapping corretto e quindi si dovrà usare il mapping presente nella partizione.</span><span class="sxs-lookup"><span data-stu-id="975e6-174">**MappingDifferenceResolution.KeepShardMapping** is recommended that when the LSM contains the accurate mapping and therefore the mapping in the shard should be used.</span></span> <span data-ttu-id="975e6-175">Questo si verifica in genere nel caso di un failover, dove la partizione ora risiede in un nuovo server.</span><span class="sxs-lookup"><span data-stu-id="975e6-175">This is typically the case if there is a failover: the shard now resides on a new server.</span></span> <span data-ttu-id="975e6-176">Poiché la partizione deve essere prima rimossa dalla mappa globale partizioni, tramite il metodo RecoveryManager.DetachShard, non esiste più un mapping nella mappa globale partizioni.</span><span class="sxs-lookup"><span data-stu-id="975e6-176">Since the shard must first be removed from the GSM (using the RecoveryManager.DetachShard method), a mapping no longer exists on the GSM.</span></span> <span data-ttu-id="975e6-177">Per ristabilire il mapping della partizione è quindi necessario usare la mappa locale partizioni.</span><span class="sxs-lookup"><span data-stu-id="975e6-177">Therefore, the LSM must be used to re-establish the shard mapping.</span></span>

## <a name="attach-a-shard-to-the-shardmap-after-a-shard-is-restored"></a><span data-ttu-id="975e6-178">Collegare una partizione a ShardMap dopo il ripristino di una partizione</span><span class="sxs-lookup"><span data-stu-id="975e6-178">Attach a shard to the ShardMap after a shard is restored</span></span>
<span data-ttu-id="975e6-179">Il [metodo AttachShard](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) collega la partizione specificata alla mappa partizioni.</span><span class="sxs-lookup"><span data-stu-id="975e6-179">The [AttachShard method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) attaches the given shard to the shard map.</span></span> <span data-ttu-id="975e6-180">Rileva quindi eventuali incoerenze nella mappa partizioni e aggiorna i mapping in modo che la partizione corrisponda al punto di ripristino della partizione.</span><span class="sxs-lookup"><span data-stu-id="975e6-180">It then detects any shard map inconsistencies and updates the mappings to match the shard at the point of the shard restoration.</span></span> <span data-ttu-id="975e6-181">Si presuppone che venga rinominato anche il database per riflettere il nome del database originale, precedente al ripristino della partizione, perché per impostazione predefinita il ripristino temporizzato usa un nuovo database a cui aggiunge il timestamp.</span><span class="sxs-lookup"><span data-stu-id="975e6-181">It is assumed that the database is also renamed to reflect the original database name (before the shard was restored), since the point-in time restoration defaults to a new database appended with the timestamp.</span></span> 

   ```
   rm.AttachShard(location, shardMapName)
   ``` 

* <span data-ttu-id="975e6-182">Il parametro *location* corrisponde al nome del server e al nome del database della partizione che viene collegata.</span><span class="sxs-lookup"><span data-stu-id="975e6-182">The *location* parameter is the server name and database name, of the shard being attached.</span></span> 
* <span data-ttu-id="975e6-183">Il parametro *shardMapName* è il nome della mappa partizioni.</span><span class="sxs-lookup"><span data-stu-id="975e6-183">The *shardMapName* parameter is the shard map name.</span></span> <span data-ttu-id="975e6-184">È richiesto solo quando più mappe partizioni sono gestite dallo stesso gestore delle mappe partizioni.</span><span class="sxs-lookup"><span data-stu-id="975e6-184">This is only required when multiple shard maps are managed by the same shard map manager.</span></span> <span data-ttu-id="975e6-185">Facoltativo.</span><span class="sxs-lookup"><span data-stu-id="975e6-185">Optional.</span></span> 

<span data-ttu-id="975e6-186">Questo esempio aggiunge una partizione alla mappa partizioni ripristinata di recente da una condizione precedente.</span><span class="sxs-lookup"><span data-stu-id="975e6-186">This example adds a shard to the shard map that has been recently restored from an earlier point-in time.</span></span> <span data-ttu-id="975e6-187">Poiché la partizione, ovvero il mapping per la partizione nella mappa locale partizioni, è stata ripristinata, è potenzialmente incoerenze con la voce della partizione nella mappa globale partizioni.</span><span class="sxs-lookup"><span data-stu-id="975e6-187">Since the shard (namely the mapping for the shard in the LSM) has been restored, it is potentially inconsistent with the shard entry in the GSM.</span></span> <span data-ttu-id="975e6-188">Esternamente a questo codice di esempio, la partizione è stata ripristinata e rinominata con il nome originale del database.</span><span class="sxs-lookup"><span data-stu-id="975e6-188">Outside of this example code, the shard was restored and renamed to the original name of the database.</span></span> <span data-ttu-id="975e6-189">Essendo stata ripristinata, si presuppone che il mapping nella mappa locale partizioni sia quello attendibile.</span><span class="sxs-lookup"><span data-stu-id="975e6-189">Since it was restored, it is assumed the mapping in the LSM is the trusted mapping.</span></span> 

   ```
   rm.AttachShard(s.Location, customerMap); 
   var gs = rm.DetectMappingDifferences(s.Location); 
      foreach (RecoveryToken g in gs) 
       { 
       rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
       } 
   ```

## <a name="updating-shard-locations-after-a-geo-failover-restore-of-the-shards"></a><span data-ttu-id="975e6-190">Aggiornamento dei percorsi della partizioni dopo un failover geografico, o ripristino, delle partizioni</span><span class="sxs-lookup"><span data-stu-id="975e6-190">Updating shard locations after a geo-failover (restore) of the shards</span></span>
<span data-ttu-id="975e6-191">Nel caso di failover geografico, il database secondario è reso accessibile in scrittura e diventa il database primario.</span><span class="sxs-lookup"><span data-stu-id="975e6-191">If there is a geo-failover, the secondary database is made write accessible and becomes the new primary database.</span></span> <span data-ttu-id="975e6-192">Il nome del server, e potenzialmente il database a seconda della configurazione, può essere diverso da quello primario originale.</span><span class="sxs-lookup"><span data-stu-id="975e6-192">The name of the server, and potentially the database (depending on your configuration), may be different from the original primary.</span></span> <span data-ttu-id="975e6-193">È quindi necessario correggere le voci dei mapping per la partizione nella mappa globale partizioni e nella mappa locale partizioni.</span><span class="sxs-lookup"><span data-stu-id="975e6-193">Therefore the mapping entries for the shard in the GSM and LSM must be fixed.</span></span> <span data-ttu-id="975e6-194">In modo analogo, se il database viene ripristinato con un nome e un percorso diversi, oppure a una condizione precedente, potrebbero verificarsi incoerenze nelle mappe partizioni.</span><span class="sxs-lookup"><span data-stu-id="975e6-194">Similarly, if the database is restored to a different name or location, or to an earlier point in time, this might cause inconsistencies in the shard maps.</span></span> <span data-ttu-id="975e6-195">Il gestore delle mappe partizioni controlla la distribuzione delle connessioni aperte ai database corretti.</span><span class="sxs-lookup"><span data-stu-id="975e6-195">The Shard Map Manager handles the distribution of open connections to the correct database.</span></span> <span data-ttu-id="975e6-196">La distribuzione si basa sui dati contenuti nella mappa partizioni e sul valore della chiave di partizionamento orizzontale di destinazione della richiesta dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="975e6-196">Distribution is based on the data in the shard map and the value of the sharding key that is the target of the applications request.</span></span> <span data-ttu-id="975e6-197">Dopo un failover geografico queste informazioni devono essere aggiornate con il nome del server, il nome del database e il mapping di partizione corretti del database ripristinato.</span><span class="sxs-lookup"><span data-stu-id="975e6-197">After a geo-failover, this information must be updated with the accurate server name, database name and shard mapping of the recovered database.</span></span> 

## <a name="best-practices"></a><span data-ttu-id="975e6-198">Procedure consigliate</span><span class="sxs-lookup"><span data-stu-id="975e6-198">Best practices</span></span>
<span data-ttu-id="975e6-199">Il failover geografico e il ripristino sono operazioni che di solito sono gestite da un amministratore del cloud dell'applicazione usando intenzionalmente una delle funzionalità di continuità aziendale dei database SQL di Azure.</span><span class="sxs-lookup"><span data-stu-id="975e6-199">Geo-failover and recovery are operations typically managed by a cloud administrator of the application intentionally utilizing one of Azure SQL Databases business continuity features.</span></span> <span data-ttu-id="975e6-200">La pianificazione della continuità aziendale richiede la definizione di processi, procedure e misure che garantiscano la continuità delle operazioni aziendali senza interruzioni.</span><span class="sxs-lookup"><span data-stu-id="975e6-200">Business continuity planning requires processes, procedures, and measures to ensure that business operations can continue without interruption.</span></span> <span data-ttu-id="975e6-201">In questo flusso di lavoro è necessario usare i metodi disponibili come parte della classe RecoveryManager per assicurare che la mappa globale partizioni e la mappa locale partizioni siano mantenute aggiornate con l'azione di ripristino eseguita.</span><span class="sxs-lookup"><span data-stu-id="975e6-201">The methods available as part of the RecoveryManager class should be used within this work flow to ensure the GSM and LSM are kept up-to-date based on the recovery action taken.</span></span> <span data-ttu-id="975e6-202">Per assicurarsi che la mappa globale partizioni e la mappa locale partizioni riflettano le informazioni corrette dopo un evento di failover, occorre eseguire cinque passaggi.</span><span class="sxs-lookup"><span data-stu-id="975e6-202">There are five basic steps to properly ensuring the GSM and LSM reflect the accurate information after a failover event.</span></span> <span data-ttu-id="975e6-203">Il codice dell'applicazione per eseguire questi passaggi può essere integrato negli strumenti e nel flusso di lavoro esistenti.</span><span class="sxs-lookup"><span data-stu-id="975e6-203">The application code to execute these steps can be integrated into existing tools and workflow.</span></span> 

1. <span data-ttu-id="975e6-204">Recuperare Gestione ripristino da ShardMapManager.</span><span class="sxs-lookup"><span data-stu-id="975e6-204">Retrieve the RecoveryManager from the ShardMapManager.</span></span> 
2. <span data-ttu-id="975e6-205">Scollegare la partizione precedente dalla mappa partizioni.</span><span class="sxs-lookup"><span data-stu-id="975e6-205">Detach the old shard from the shard map.</span></span>
3. <span data-ttu-id="975e6-206">Collegare la nuova partizione alla mappa partizioni, includendo il percorso della nuova partizione.</span><span class="sxs-lookup"><span data-stu-id="975e6-206">Attach the new shard to the shard map, including the new shard location.</span></span>
4. <span data-ttu-id="975e6-207">Rilevare le incoerenze nel mapping tra la mappa globale partizioni e la mappa locale partizioni.</span><span class="sxs-lookup"><span data-stu-id="975e6-207">Detect inconsistencies in the mapping between the GSM and LSM.</span></span> 
5. <span data-ttu-id="975e6-208">Risolvere le differenze tra la mappa globale partizioni e la mappa locale partizioni, considerando attendibile la mappa locale partizioni.</span><span class="sxs-lookup"><span data-stu-id="975e6-208">Resolve differences between the GSM and the LSM, trusting the LSM.</span></span> 

<span data-ttu-id="975e6-209">L'esempio segue questa procedura:</span><span class="sxs-lookup"><span data-stu-id="975e6-209">This example performs the following steps:</span></span>

1. <span data-ttu-id="975e6-210">Rimuove le partizioni dalla mappa partizioni che riflette i percorsi precedenti all'evento di failover.</span><span class="sxs-lookup"><span data-stu-id="975e6-210">Removes shards from the Shard Map that reflect shard locations before the failover event.</span></span>
2. <span data-ttu-id="975e6-211">Collega le partizioni alla mappa partizioni riflettendo i nuovi percorsi delle partizioni. Il parametro "Configuration.SecondaryServer" è il nuovo nome del server, ma lo stesso nome del database.</span><span class="sxs-lookup"><span data-stu-id="975e6-211">Attaches shards to the Shard Map reflecting the new shard locations (the parameter "Configuration.SecondaryServer" is the new server name but the same database name).</span></span>
3. <span data-ttu-id="975e6-212">Recupera i token di ripristino rilevando le differenze dei mapping tra la mappa globale partizioni e la mappa locale partizioni per ogni partizione.</span><span class="sxs-lookup"><span data-stu-id="975e6-212">Retrieves the recovery tokens by detecting mapping differences between the GSM and the LSM for each shard.</span></span> 
4. <span data-ttu-id="975e6-213">Risolve le incoerenze considerando attendibile il mapping dalla mappa locale partizioni di ogni partizione.</span><span class="sxs-lookup"><span data-stu-id="975e6-213">Resolves the inconsistencies by trusting the mapping from the LSM of each shard.</span></span> 
   
   ```
   var shards = smm.GetShards(); 
   foreach (shard s in shards) 
   { 
     if (s.Location.Server == Configuration.PrimaryServer) 
   
         { 
          ShardLocation slNew = new ShardLocation(Configuration.SecondaryServer, s.Location.Database); 
   
          rm.DetachShard(s.Location); 
   
          rm.AttachShard(slNew); 
   
          var gs = rm.DetectMappingDifferences(slNew); 
   
          foreach (RecoveryToken g in gs) 
            { 
               rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
            } 
        } 
    } 
   ```

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-database-recovery-manager/recovery-manager.png

