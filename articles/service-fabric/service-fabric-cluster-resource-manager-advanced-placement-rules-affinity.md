---
title: "Cluster Resource Manager di Service Fabric - Affinità | Documentazione Microsoft"
description: "Informazioni generali sulla configurazione dell'affinità per i servizi di Service Fabric"
services: service-fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: 
ms.assetid: 678073e1-d08d-46c4-a811-826e70aba6c4
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: 3efda4ee4016245668e5da431d7b8868a21c790e
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/18/2017
---
# <a name="configuring-and-using-service-affinity-in-service-fabric"></a><span data-ttu-id="6f03f-103">Configurazione e utilizzo dell'affinità del servizio in Service Fabric</span><span class="sxs-lookup"><span data-stu-id="6f03f-103">Configuring and using service affinity in Service Fabric</span></span>
<span data-ttu-id="6f03f-104">Il controllo di affinità è disponibile principalmente per facilitare la transizione di grandi applicazioni monolitiche verso ambienti cloud e di microservizi.</span><span class="sxs-lookup"><span data-stu-id="6f03f-104">Affinity is a control that is provided mainly to help ease the transition of larger monolithic applications into the cloud and microservices world.</span></span> <span data-ttu-id="6f03f-105">Viene anche usato come ottimizzazione per migliorare le prestazioni dei servizi, sebbene questa operazione possa avere effetti collaterali.</span><span class="sxs-lookup"><span data-stu-id="6f03f-105">It is also used as an optimization for improving the performance of services, although doing so can have side effects.</span></span>

<span data-ttu-id="6f03f-106">Si supponga di voler importare in Service Fabric un'applicazione di grandi dimensioni o che non era stata progettata nell'ottica dei microservizi (o qualsiasi ambiente distribuito).</span><span class="sxs-lookup"><span data-stu-id="6f03f-106">Let’s say you’re bringing a larger app, or one that just wasn’t designed with microservices in mind, to Service Fabric (or any distributed environment).</span></span> <span data-ttu-id="6f03f-107">Questo tipo di transizione è comune.</span><span class="sxs-lookup"><span data-stu-id="6f03f-107">This type of transition is common.</span></span> <span data-ttu-id="6f03f-108">È necessario innanzitutto sollevare l'intera applicazione nell'ambiente, creare il pacchetto e accertarsi che venga eseguita senza problemi.</span><span class="sxs-lookup"><span data-stu-id="6f03f-108">You start by lifting the entire app into the environment, packaging it, and making sure it is running smoothly.</span></span> <span data-ttu-id="6f03f-109">Quindi, la si suddivide in vari servizi più piccoli che comunicano tra loro.</span><span class="sxs-lookup"><span data-stu-id="6f03f-109">Then you start breaking it down into different smaller services that all talk to each other.</span></span>

<span data-ttu-id="6f03f-110">Infine è possibile che nell'applicazione si siano verificati alcuni problemi.</span><span class="sxs-lookup"><span data-stu-id="6f03f-110">Eventually you may find that the application is experiencing some issues.</span></span> <span data-ttu-id="6f03f-111">I problemi rientrano, in genere, in una di queste categorie:</span><span class="sxs-lookup"><span data-stu-id="6f03f-111">The issues usually fall into one of these categories:</span></span>

1. <span data-ttu-id="6f03f-112">Una parte del componente X dell'app monolitica aveva una dipendenza non documentata dal componente Y che abbiamo appena convertito in servizi separati.</span><span class="sxs-lookup"><span data-stu-id="6f03f-112">Some component X in the monolithic app had an undocumented dependency on component Y, and you just turned those components into separate services.</span></span> <span data-ttu-id="6f03f-113">Poiché questi servizi sono in esecuzione su nodi diversi del cluster, vengono interrotti.</span><span class="sxs-lookup"><span data-stu-id="6f03f-113">Since these services are now running on different nodes in the cluster, they're broken.</span></span>
2. <span data-ttu-id="6f03f-114">Queste componenti comunicano tramite (named pipe locali | memoria condivisa | file su disco), e devono essere subito in grado di scrivere su una risorsa locale condivisa per motivi di prestazioni.</span><span class="sxs-lookup"><span data-stu-id="6f03f-114">These components communicate via (local named pipes | shared memory | files on disk) and they really need to be able to write to a shared local resource for performance reasons right now.</span></span> <span data-ttu-id="6f03f-115">Tale dipendenza rigida viene rimossa, forse, in un secondo momento.</span><span class="sxs-lookup"><span data-stu-id="6f03f-115">That hard dependency gets removed later, maybe.</span></span>
3. <span data-ttu-id="6f03f-116">La procedura è corretta, ma si scopre che questi due componenti comunicano tra loro o sono sensibili alle prestazioni.</span><span class="sxs-lookup"><span data-stu-id="6f03f-116">Everything is fine, but it turns out that these two components are actually chatty/performance sensitive.</span></span> <span data-ttu-id="6f03f-117">Quando sono stati spostati in servizi separati, le prestazioni globali hanno subito dell'applicazione ne hanno risentito pesantemente o hanno aumentato la latenza.</span><span class="sxs-lookup"><span data-stu-id="6f03f-117">When they moved them into separate services overall application performance tanked or latency increased.</span></span> <span data-ttu-id="6f03f-118">Di conseguenza, l'applicazione globale non soddisfa le aspettative.</span><span class="sxs-lookup"><span data-stu-id="6f03f-118">As a result, the overall application is not meeting expectations.</span></span>

<span data-ttu-id="6f03f-119">In questi casi non si vuole perdere il lavoro di refactoring e non si vuole tornare all'app monolitica.</span><span class="sxs-lookup"><span data-stu-id="6f03f-119">In these cases, we don’t want to lose our refactoring work, and don’t want to go back to the monolith.</span></span> <span data-ttu-id="6f03f-120">L'ultima condizione può anche essere utile come una normale ottimizzazione.</span><span class="sxs-lookup"><span data-stu-id="6f03f-120">The last condition may even be desirable as a plain optimization.</span></span> <span data-ttu-id="6f03f-121">Tuttavia fino a quando non sarà possibile riprogettare i componenti perché funzionino in modo naturale come servizi (o fino a quando non si sarà in grado di risolvere le aspettative delle prestazioni in un altro modo), è necessario un senso di località.</span><span class="sxs-lookup"><span data-stu-id="6f03f-121">However, until we can redesign the components to work naturally as services (or until we can solve the performance expectations some other way) we're going to need some sense of locality.</span></span>

<span data-ttu-id="6f03f-122">Cosa fare?</span><span class="sxs-lookup"><span data-stu-id="6f03f-122">What to do?</span></span> <span data-ttu-id="6f03f-123">Si può provare ad attivare il servizio di affinità.</span><span class="sxs-lookup"><span data-stu-id="6f03f-123">Well, you could try turning on affinity.</span></span>

## <a name="how-to-configure-affinity"></a><span data-ttu-id="6f03f-124">Come configurare l'affinità</span><span class="sxs-lookup"><span data-stu-id="6f03f-124">How to configure affinity</span></span>
<span data-ttu-id="6f03f-125">Per impostare l'affinità, è necessario definire una relazione di affinità tra due servizi.</span><span class="sxs-lookup"><span data-stu-id="6f03f-125">To set up affinity, you define an affinity relationship between two different services.</span></span> <span data-ttu-id="6f03f-126">Si tratta di fare in modo che un servizio "punti" a un altro servizio affinché il primo possa essere eseguito solo se anche il secondo è in esecuzione.</span><span class="sxs-lookup"><span data-stu-id="6f03f-126">You can think of affinity as “pointing” one service at another and saying “This service can only run where that service is running.”</span></span> <span data-ttu-id="6f03f-127">A volte, si fa riferimento all'affinità come a una relazioni padre-figlio, in cui l'elemento figlio punta all'elemento padre.</span><span class="sxs-lookup"><span data-stu-id="6f03f-127">Sometimes we refer to affinity as a parent/child relationship (where you point the child at the parent).</span></span> <span data-ttu-id="6f03f-128">L'affinità garantisce che le repliche o le istanze di un servizio vengano inserite negli stessi nodi in cui risiedono quelle di un altro servizio.</span><span class="sxs-lookup"><span data-stu-id="6f03f-128">Affinity ensures that the replicas or instances of one service are placed on the same nodes as those of another service.</span></span>

```csharp
ServiceCorrelationDescription affinityDescription = new ServiceCorrelationDescription();
affinityDescription.Scheme = ServiceCorrelationScheme.Affinity;
affinityDescription.ServiceName = new Uri("fabric:/otherApplication/parentService");
serviceDescription.Correlations.Add(affinityDescription);
await fabricClient.ServiceManager.CreateServiceAsync(serviceDescription);
```

> [!NOTE]
> <span data-ttu-id="6f03f-129">Un servizio figlio può partecipare solo a una relazione di affinità singola.</span><span class="sxs-lookup"><span data-stu-id="6f03f-129">A child service can only participate in a single affinity relationship.</span></span> <span data-ttu-id="6f03f-130">Se si desidera creare un'affinità fra un servizio figlio e due servizi padre in una volta sola, sono disponibili due opzioni:</span><span class="sxs-lookup"><span data-stu-id="6f03f-130">If you wanted the child to be affinitized to two parent services at once you have a couple options:</span></span>
> - <span data-ttu-id="6f03f-131">Invertire le relazioni (includere i punti parentService1 e parentService2 nel servizio figlio corrente), oppure</span><span class="sxs-lookup"><span data-stu-id="6f03f-131">Reverse the relationships (have parentService1 and parentService2 point at the current child service), or</span></span>
> - <span data-ttu-id="6f03f-132">Designare uno dei padri come hub per convenzione e disporre di tutti i punti del servizio in quel servizio.</span><span class="sxs-lookup"><span data-stu-id="6f03f-132">Designate one of the parents as a hub by convention and have all services point at that service.</span></span> 
>
> <span data-ttu-id="6f03f-133">Il comportamento di selezione risultante del cluster deve essere lo stesso.</span><span class="sxs-lookup"><span data-stu-id="6f03f-133">The resulting placement behavior in the cluster should be the same.</span></span>
>

## <a name="different-affinity-options"></a><span data-ttu-id="6f03f-134">Diverse opzioni di affinità</span><span class="sxs-lookup"><span data-stu-id="6f03f-134">Different affinity options</span></span>
<span data-ttu-id="6f03f-135">L'affinità è rappresentata tramite vari possibili schemi di correlazione e ha due modalità diverse.</span><span class="sxs-lookup"><span data-stu-id="6f03f-135">Affinity is represented via one of several correlation schemes, and has two different modes.</span></span> <span data-ttu-id="6f03f-136">La modalità di affinità più comune è la cosiddetta NonAlignedAffinity.</span><span class="sxs-lookup"><span data-stu-id="6f03f-136">The most common mode of affinity is what we call NonAlignedAffinity.</span></span> <span data-ttu-id="6f03f-137">Nella modalità NonAlignedAffinity le repliche o le istanze dei diversi servizi vengono inserite negli stessi nodi.</span><span class="sxs-lookup"><span data-stu-id="6f03f-137">In NonAlignedAffinity, the replicas or instances of the different services are placed on the same nodes.</span></span> <span data-ttu-id="6f03f-138">L'altra modalità è AlignedAffinity.</span><span class="sxs-lookup"><span data-stu-id="6f03f-138">The other mode is AlignedAffinity.</span></span> <span data-ttu-id="6f03f-139">La modalità AlignedAffinity viene usata solo con i servizi con stato.</span><span class="sxs-lookup"><span data-stu-id="6f03f-139">Aligned Affinity is useful only with stateful services.</span></span> <span data-ttu-id="6f03f-140">La configurazione di due servizi con stati per l'allineamento dell'affinità garantisce che i primari di tali servizi vengano inseriti negli stessi nodi.</span><span class="sxs-lookup"><span data-stu-id="6f03f-140">Configuring two stateful services to have aligned affinity ensures that the primaries of those services are placed on the same nodes as each other.</span></span> <span data-ttu-id="6f03f-141">La configurazione consente anche di inserire ogni coppia di secondari dei servizi negli stessi nodi.</span><span class="sxs-lookup"><span data-stu-id="6f03f-141">It also causes each pair of secondaries for those services to be placed on the same nodes.</span></span> <span data-ttu-id="6f03f-142">È possibile anche configurare una relazione NonAlignedAffinity per i servizi con stato, sebbene questa pratica sia meno comune.</span><span class="sxs-lookup"><span data-stu-id="6f03f-142">It is also possible (though less common) to configure NonAlignedAffinity for stateful services.</span></span> <span data-ttu-id="6f03f-143">Per la relazione NonAlignedAffinity, le diverse repliche dei due servizi con stato saranno in esecuzione sugli stessi nodi, ma le relative primarie potrebbero finire in nodi diversi.</span><span class="sxs-lookup"><span data-stu-id="6f03f-143">For NonAlignedAffinity, the different replicas of the two stateful services would run on the same nodes, but their primaries could end up on different nodes.</span></span>

<span data-ttu-id="6f03f-144"><center>
![Modalità di affinità e loro effetti][Image1]
</center></span><span class="sxs-lookup"><span data-stu-id="6f03f-144"><center>
![Affinity Modes and Their Effects][Image1]
</center></span></span>

### <a name="best-effort-desired-state"></a><span data-ttu-id="6f03f-145">Stato desiderato del massimo sforzo</span><span class="sxs-lookup"><span data-stu-id="6f03f-145">Best effort desired state</span></span>
<span data-ttu-id="6f03f-146">Una relazione di affinità è migliore.</span><span class="sxs-lookup"><span data-stu-id="6f03f-146">An affinity relationship is best effort.</span></span> <span data-ttu-id="6f03f-147">Non fornisce le stesse garanzie di collocazione o affidabilità di quelle eseguite nello stesso processo eseguibile.</span><span class="sxs-lookup"><span data-stu-id="6f03f-147">It does not provide the same guarantees of collocation or reliability that running in the same executable process does.</span></span> <span data-ttu-id="6f03f-148">I servizi in una relazione di affinità sono entità profondamente diverse che possono avere esito negativo ed essere spostate in modo indipendente.</span><span class="sxs-lookup"><span data-stu-id="6f03f-148">The services in an affinity relationship are fundamentally different entities that can fail and be moved independently.</span></span> <span data-ttu-id="6f03f-149">Una relazione di affinità può anche subire un'interruzione, anche se tali interruzioni sono temporanee.</span><span class="sxs-lookup"><span data-stu-id="6f03f-149">An affinity relationship could also break, though these breaks are temporary.</span></span> <span data-ttu-id="6f03f-150">Ad esempio, i limiti di capacità possono significare che solo alcuni degli oggetti del servizio nella relazione di affinità possono contenere un determinato nodo.</span><span class="sxs-lookup"><span data-stu-id="6f03f-150">For example, capacity limitations may mean that only some of the service objects in the affinity relationship can fit on a given node.</span></span> <span data-ttu-id="6f03f-151">In questi casi, anche se è disponibile una relazione di affinità, non verrà applicata a causa di altri vincoli.</span><span class="sxs-lookup"><span data-stu-id="6f03f-151">In these cases even though there's an affinity relationship in place, it can't be enforced due to the other constraints.</span></span> <span data-ttu-id="6f03f-152">Se è possibile eseguire questa operazione, la violazione viene corretta automaticamente in un secondo momento.</span><span class="sxs-lookup"><span data-stu-id="6f03f-152">If it is possible to do so, the violation is automatically corrected later.</span></span>

### <a name="chains-vs-stars"></a><span data-ttu-id="6f03f-153">Modelli a catena o a stella</span><span class="sxs-lookup"><span data-stu-id="6f03f-153">Chains vs. stars</span></span>
<span data-ttu-id="6f03f-154">Oggi Cluster Resource Manager non è in grado modellare le catene di relazioni di affinità di.</span><span class="sxs-lookup"><span data-stu-id="6f03f-154">Today the Cluster Resource Manager isn't able to model chains of affinity relationships.</span></span> <span data-ttu-id="6f03f-155">Ciò significa che un servizio che è un elemento figlio in una relazione di affinità non potrà essere un elemento padre in un'altra relazione di affinità.</span><span class="sxs-lookup"><span data-stu-id="6f03f-155">What this means is that a service that is a child in one affinity relationship can’t be a parent in another affinity relationship.</span></span> <span data-ttu-id="6f03f-156">Se si desidera modellare questo tipo di relazione, è necessario modellarla in modo efficace a forma di stella, invece di una catena.</span><span class="sxs-lookup"><span data-stu-id="6f03f-156">If you want to model this type of relationship, you effectively have to model it as a star, rather than a chain.</span></span> <span data-ttu-id="6f03f-157">Per spostarsi da un modello a catena a uno a stella, l'elemento figlio più basso verrebbe imparentato con il padre del primo elemento figlio.</span><span class="sxs-lookup"><span data-stu-id="6f03f-157">To move from a chain to a star, the bottommost child would be parented to the first child’s parent instead.</span></span> <span data-ttu-id="6f03f-158">A seconda della disposizione dei servizi, è possibile eseguire l'operazione più volte.</span><span class="sxs-lookup"><span data-stu-id="6f03f-158">Depending on the arrangement of your services, you may have to do this multiple times.</span></span> <span data-ttu-id="6f03f-159">Se non esiste alcun servizio padre naturale, è necessario crearne uno che funga da segnaposto.</span><span class="sxs-lookup"><span data-stu-id="6f03f-159">If there's no natural parent service, you may have to create one that serves as a placeholder.</span></span> <span data-ttu-id="6f03f-160">A seconda dei requisiti, è inoltre consigliabile esaminare i [gruppi di applicazioni](service-fabric-cluster-resource-manager-application-groups.md).</span><span class="sxs-lookup"><span data-stu-id="6f03f-160">Depending on your requirements, you may also want to look into [Application Groups](service-fabric-cluster-resource-manager-application-groups.md).</span></span>

<span data-ttu-id="6f03f-161"><center>
![Modelli a catena o a stella nel contesto delle relazioni di affinità][Image2]
</center></span><span class="sxs-lookup"><span data-stu-id="6f03f-161"><center>
![Chains vs. Stars in the Context of Affinity Relationships][Image2]
</center></span></span>

<span data-ttu-id="6f03f-162">Un altro aspetto da notare circa le relazioni di affinità attuali è che sono direzionali.</span><span class="sxs-lookup"><span data-stu-id="6f03f-162">Another thing to note about affinity relationships today is that they are directional.</span></span> <span data-ttu-id="6f03f-163">Ciò significa che la regola di affinità impone solo che l'elemento figlio sia collocato nella stessa posizione dell'elemento padre.</span><span class="sxs-lookup"><span data-stu-id="6f03f-163">This means that the affinity rule only enforces that the child placed with the parent.</span></span> <span data-ttu-id="6f03f-164">Non garantisce che l'elemento padre sia posizionato con l'elemento figlio.</span><span class="sxs-lookup"><span data-stu-id="6f03f-164">It does not ensure that the parent is located with the child.</span></span> <span data-ttu-id="6f03f-165">È anche importante notare che la relazione di affinità non può essere perfetta o immediatamente imposta poiché diversi servizi dispongono di diversi cicli di vita e possono avere esito negativo e spostarsi in modo indipendente.</span><span class="sxs-lookup"><span data-stu-id="6f03f-165">It is also important to note that the affinity relationship can't be perfect or instantly enforced since different services have with different lifecycles and can fail and move independently.</span></span> <span data-ttu-id="6f03f-166">Supponiamo, ad esempio, che per l'elemento padre improvvisamente si verifichi un errore su un altro nodo perché si è arrestato in modo anomalo.</span><span class="sxs-lookup"><span data-stu-id="6f03f-166">For example, let's say the parent suddenly fails over to another node because it crashed.</span></span> <span data-ttu-id="6f03f-167">Cluster Resource Manager e Gestione failover gestiscono prima di tutto il failover, poiché mantenere i servizi attivi, coerenti e disponibili è la priorità.</span><span class="sxs-lookup"><span data-stu-id="6f03f-167">The Cluster Resource Manager and Failover Manager handle the failover first, since keeping the services up, consistent, and available is the priority.</span></span> <span data-ttu-id="6f03f-168">Una volta completato il failover, la relazione di affinità è interrotta, ma per Cluster Resource Manager l'operazione si svolge in modo corretto fino a quando non rileva che l'elemento figlio non si trova con l'elemento padre.</span><span class="sxs-lookup"><span data-stu-id="6f03f-168">Once the failover completes, the affinity relationship is broken, but the Cluster Resource Manager thinks everything is fine until it notices that the child is not located with the parent.</span></span> <span data-ttu-id="6f03f-169">Questi tipi di controlli vengono eseguiti periodicamente.</span><span class="sxs-lookup"><span data-stu-id="6f03f-169">These sorts of checks are performed periodically.</span></span> <span data-ttu-id="6f03f-170">Altre informazioni sulla modalità in cui Cluster Resource Manager valuta i vincoli sono disponibili in [questo articolo](service-fabric-cluster-resource-manager-management-integration.md#constraint-types), mentre [questo](service-fabric-cluster-resource-manager-balancing.md) fornisce altre indicazioni su come configurare la frequenza con cui questi vincoli vengono valutati.</span><span class="sxs-lookup"><span data-stu-id="6f03f-170">More information on how the Cluster Resource Manager evaluates constraints is available in [this article](service-fabric-cluster-resource-manager-management-integration.md#constraint-types), and [this one](service-fabric-cluster-resource-manager-balancing.md) talks more about how to configure the cadence on which these constraints are evaluated.</span></span>   


### <a name="partitioning-support"></a><span data-ttu-id="6f03f-171">Supporto del partizionamento</span><span class="sxs-lookup"><span data-stu-id="6f03f-171">Partitioning support</span></span>
<span data-ttu-id="6f03f-172">L'ultimo aspetto da notare è che le relazioni di affinità non sono supportate nelle situazioni in cui l'elemento padre è partizionato.</span><span class="sxs-lookup"><span data-stu-id="6f03f-172">The final thing to notice about affinity is that affinity relationships aren’t supported where the parent is partitioned.</span></span> <span data-ttu-id="6f03f-173">I servizi padre partizionati potrebbero essere supportati alla fine, ma attualmente non è consentito.</span><span class="sxs-lookup"><span data-stu-id="6f03f-173">Partitioned parent services may be supported eventually, but today it is not allowed.</span></span>

## <a name="next-steps"></a><span data-ttu-id="6f03f-174">Passaggi successivi</span><span class="sxs-lookup"><span data-stu-id="6f03f-174">Next steps</span></span>
- <span data-ttu-id="6f03f-175">Per altre informazioni sulla configurazione dei servizi, [Informazioni sulla configurazione dei servizi](service-fabric-cluster-resource-manager-configure-services.md)</span><span class="sxs-lookup"><span data-stu-id="6f03f-175">For more information on configuring services, [Learn about configuring Services](service-fabric-cluster-resource-manager-configure-services.md)</span></span>
- <span data-ttu-id="6f03f-176">Per limitare i servizi per un set ridotto di computer o per l'aggregazione del carico dei servizi, usare [Gruppi di applicazioni](service-fabric-cluster-resource-manager-application-groups.md)</span><span class="sxs-lookup"><span data-stu-id="6f03f-176">To limit services to a small set of machines or aggregating the load of services, use [Application Groups](service-fabric-cluster-resource-manager-application-groups.md)</span></span>

[Image1]:./media/service-fabric-cluster-resource-manager-advanced-placement-rules-affinity/cluster-resrouce-manager-affinity-modes.png
[Image2]:./media/service-fabric-cluster-resource-manager-advanced-placement-rules-affinity/cluster-resource-manager-chains-vs-stars.png