---
title: Risoluzione dei problemi di Crittografia dischi di Azure | Microsoft Docs
description: Questo articolo offre suggerimenti per la risoluzione dei problemi di Crittografia dischi di Microsoft Azure per VM IaaS Windows e Linux.
services: security
documentationcenter: na
author: deventiwari
manager: avibm
editor: yuridio
ms.assetid: ce0e23bd-07eb-43af-a56c-aa1a73bdb747
ms.service: security
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/27/2017
ms.author: devtiw
ms.openlocfilehash: 5f482a92b8fcd71a1b767fcc5741bc57605997ea
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/29/2017
---
# <a name="azure-disk-encryption-troubleshooting-guide"></a><span data-ttu-id="66e37-103">Guida alla risoluzione dei problemi di Crittografia dischi di Azure</span><span class="sxs-lookup"><span data-stu-id="66e37-103">Azure Disk Encryption Troubleshooting Guide</span></span>

<span data-ttu-id="66e37-104">Questa guida è destinata a professionisti IT, analisti della sicurezza delle informazioni e amministratori cloud le cui organizzazioni usano Crittografia dischi di Azure e necessitano di indicazioni per risolvere i problemi relativi alla crittografia dei dischi.</span><span class="sxs-lookup"><span data-stu-id="66e37-104">This guide is for information technology (IT) professionals, information security analysts, and cloud administrators whose organizations are using Azure disk encryption and need guidance to troubleshoot disk-encryption related issues.</span></span>

## <a name="troubleshooting-linux-os-disk-encryption"></a><span data-ttu-id="66e37-105">Risoluzione dei problemi relativi alla crittografia del disco del sistema operativo Linux</span><span class="sxs-lookup"><span data-stu-id="66e37-105">Troubleshooting Linux OS disk encryption</span></span>

<span data-ttu-id="66e37-106">Per la crittografia del disco del sistema operativo Linux, prima di affrontare l'intero processo è necessario smontare l'unità del sistema operativo.</span><span class="sxs-lookup"><span data-stu-id="66e37-106">Linux OS disk encryption must unmount the OS drive prior to running it through the full disk encryption process.</span></span>   <span data-ttu-id="66e37-107">In caso contrario, verrà probabilmente visualizzato un messaggio di errore di tipo "Impossibile</span><span class="sxs-lookup"><span data-stu-id="66e37-107">If it cannot, an error message of "failed to unmount after…"</span></span> <span data-ttu-id="66e37-108">smontare dopo…".</span><span class="sxs-lookup"><span data-stu-id="66e37-108">error message is likely to occur.</span></span>

<span data-ttu-id="66e37-109">È molto probabile che ciò si verifichi quando si tenta di eseguire la crittografia del disco del sistema operativo in un ambiente di VM di destinazione che è stato modificato rispetto all'immagine predefinita supportata della raccolta.</span><span class="sxs-lookup"><span data-stu-id="66e37-109">This is most likely when OS disk encryption is attempted on a target VM environment that has been modified or changed from its supported stock gallery image.</span></span>  <span data-ttu-id="66e37-110">Di seguito sono riportati esempi di deviazioni dall'immagine supportata che possono impedire all'estensione di smontare l'unità del sistema operativo:</span><span class="sxs-lookup"><span data-stu-id="66e37-110">Examples of deviations from the supported image, which can interfere with the extension’s ability to unmount the OS drive include:</span></span>
- <span data-ttu-id="66e37-111">Immagini personalizzate che non corrispondono più al file system e/o allo schema di partizionamento supportato.</span><span class="sxs-lookup"><span data-stu-id="66e37-111">Customized images that no longer match a supported file system and/or partitioning scheme.</span></span>
- <span data-ttu-id="66e37-112">Immagini personalizzate con applicazioni quali antivirus, Docker, SAP, MongoDB o Apache Cassandra in esecuzione nel sistema operativo prima della crittografia.</span><span class="sxs-lookup"><span data-stu-id="66e37-112">Customized images with applications such as antivirus, Docker, SAP, MongoDB, or Apache Cassandra running in the OS prior to encryption.</span></span>  <span data-ttu-id="66e37-113">Queste applicazioni sono difficili da terminare e, quando hanno mantenuto handle di file aperti nell'unità del sistema operativo, l'unità non può essere disinstallata, causando un errore.</span><span class="sxs-lookup"><span data-stu-id="66e37-113">These applications are difficult to terminate, and when they retain open file handles to the OS drive, the drive cannot be unmounted, causing failure.</span></span>
- <span data-ttu-id="66e37-114">Gli script personalizzati che vengono eseguiti in prossimità del tempo di chiusura al passaggio di crittografia possono interferire e causare questo errore.</span><span class="sxs-lookup"><span data-stu-id="66e37-114">Custom scripts that run in close time proximity to the encryption step can interfere and cause this failure.</span></span> <span data-ttu-id="66e37-115">Questa situazione può verificarsi quando un modello di Resource Manager definisce l'esecuzione simultanea di più estensioni o quando un'estensione di script personalizzati o un'altra azione viene eseguita contemporaneamente alla crittografia del disco.</span><span class="sxs-lookup"><span data-stu-id="66e37-115">This can happen when a Resource Manager template defines multiple extensions to execute simultaneously, or when a custom script extension or other action is run simultaneously to disk encryption.</span></span>   <span data-ttu-id="66e37-116">Il problema potrebbe essere risolto serializzando e isolando tali passaggi.</span><span class="sxs-lookup"><span data-stu-id="66e37-116">Serializing and isolating such steps may resolve the issue.</span></span>
- <span data-ttu-id="66e37-117">Mancata disabilitazione di SELinux prima dell'abilitazione della crittografia, che causa l'esito negativo del passaggio di smontaggio.</span><span class="sxs-lookup"><span data-stu-id="66e37-117">When SELinux has not been disabled prior to enabling encryption, the unmount step fails.</span></span>  <span data-ttu-id="66e37-118">È possibile riabilitare SELinux al termine della crittografia.</span><span class="sxs-lookup"><span data-stu-id="66e37-118">SELinux can be re-enabled after encryption has completed.</span></span>
- <span data-ttu-id="66e37-119">Uso nel disco del sistema operativo di uno schema LVM. Anche è disponibile un supporto limitato per dischi dati LVM, non sono supportati dischi del sistema operativo LVM.</span><span class="sxs-lookup"><span data-stu-id="66e37-119">When the OS disk is using an LVM scheme (although limited LVM data disk support is available, LVM OS disk is not)</span></span>
- <span data-ttu-id="66e37-120">Requisiti minimi di memoria non soddisfatti. Per la crittografia del disco del sistema operativo sono consigliati 7 GB.</span><span class="sxs-lookup"><span data-stu-id="66e37-120">When minimum memory requirements are not met (7GB is suggested for OS disk encryption)</span></span>
- <span data-ttu-id="66e37-121">Montaggio ricorsivo delle unità dati nella directory /mnt/ o l'una nell'altra (ad esempio, /mnt/data1, /mnt/data2, /data3 + /data3/data4 e così via).</span><span class="sxs-lookup"><span data-stu-id="66e37-121">When data drives have been recursively mounted under /mnt/ directory, or each other (for example, /mnt/data1, /mnt/data2, /data3 + /data3/data4, etc.)</span></span>
- <span data-ttu-id="66e37-122">Altri [prerequisiti](https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption) di Crittografia dischi di Azure per Linux non soddisfatti.</span><span class="sxs-lookup"><span data-stu-id="66e37-122">When other Azure Disk Encryption [prerequisites](https://docs.microsoft.com/en-us/azure/security/azure-security-disk-encryption) for Linux are not met</span></span>

## <a name="unable-to-encrypt"></a><span data-ttu-id="66e37-123">Impossibile eseguire la crittografia</span><span class="sxs-lookup"><span data-stu-id="66e37-123">Unable to encrypt</span></span>

<span data-ttu-id="66e37-124">In alcuni casi, la crittografia del disco Linux sembra bloccata nella fase "OS disk encryption started" e SSH è disabilitato.</span><span class="sxs-lookup"><span data-stu-id="66e37-124">In some cases, the Linux disk encryption appears to be stuck at "OS disk encryption started" and SSH is disabled.</span></span> <span data-ttu-id="66e37-125">Il completamento del processo in un immagine di galleria della raccolta può richiedere da 3 a 16 ore.</span><span class="sxs-lookup"><span data-stu-id="66e37-125">This process can take between 3-16 hours to complete on a stock gallery image.</span></span>  <span data-ttu-id="66e37-126">Se vengono aggiunti dischi dati di dimensioni da più TB, il processo può richiedere giorni.</span><span class="sxs-lookup"><span data-stu-id="66e37-126">If multi-TB size data disks are added, the process may take days.</span></span> <span data-ttu-id="66e37-127">La sequenza della crittografia del disco del sistema operativo Linux prevede lo smontaggio temporaneo dell'unità del sistema operativo, la crittografia blocco per blocco dell'intero disco del sistema operativo e quindi il relativo rimontaggio in stato crittografato.</span><span class="sxs-lookup"><span data-stu-id="66e37-127">The Linux OS disk encryption sequence unmounts the OS drive temporarily, and performs block by block encryption of the entire OS disk, before remounting it in its encrypted state.</span></span>   <span data-ttu-id="66e37-128">A differenza di Crittografia dischi di Azure in Windows, la crittografia dei dischi Linux non consente di usare contemporaneamente la VM mentre è in corso la crittografia.</span><span class="sxs-lookup"><span data-stu-id="66e37-128">Unlike Azure Disk Encryption on Windows, Linux Disk Encryption does not allow concurrent use of the VM while the encryption is in progress.</span></span>  <span data-ttu-id="66e37-129">Le caratteristiche di prestazioni della VM, ad esempio le dimensioni del disco e il fatto che l'account di archiviazione sia supportato da Archiviazione Standard o Premium (SSD), può influire notevolmente sul tempo necessario per completare la crittografia.</span><span class="sxs-lookup"><span data-stu-id="66e37-129">The performance characteristics of the VM, including the size of the disk and whether the storage account is backed by standard or premium (SSD) storage, can greatly influence the time required to complete encryption.</span></span>

<span data-ttu-id="66e37-130">Per controllare lo stato, è possibile eseguire il poll del campo ProgressMessage restituito dal comando [Get-AzureRmVmDiskEncryptionStatus](https://docs.microsoft.com/powershell/module/azurerm.compute/get-azurermvmdiskencryptionstatus).</span><span class="sxs-lookup"><span data-stu-id="66e37-130">To check status, the ProgressMessage field returned from the [Get-AzureRmVmDiskEncryptionStatus](https://docs.microsoft.com/powershell/module/azurerm.compute/get-azurermvmdiskencryptionstatus) command can be polled.</span></span>   <span data-ttu-id="66e37-131">Mentre viene eseguita la crittografia dell'unità del sistema operativo, la VM passa in stato di manutenzione e SSH viene disabilitato per impedire interruzioni del processo in corso.</span><span class="sxs-lookup"><span data-stu-id="66e37-131">While the OS drive is being encrypted, the VM enters a servicing state, and SSH is also disabled to prevent any disruption to the ongoing process.</span></span>  <span data-ttu-id="66e37-132">Mentre è in corso la crittografia, per la maggior parte del tempo verrà segnalato lo stato EncryptionInProgress, seguito diverse ore dopo da un messaggio VMRestartPending con cui viene richiesto di riavviare la VM.</span><span class="sxs-lookup"><span data-stu-id="66e37-132">EncryptionInProgress will be reported for the majority of the time while encryption is in progress, followed several hours later with a VMRestartPending message prompting to restart the VM.</span></span>  <span data-ttu-id="66e37-133">Ad esempio:</span><span class="sxs-lookup"><span data-stu-id="66e37-133">For example:</span></span>


```
PS > Get-AzureRmVMDiskEncryptionStatus -ResourceGroupName $resourceGroupName -VMName $vmName
OsVolumeEncrypted          : EncryptionInProgress
DataVolumesEncrypted       : EncryptionInProgress
OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
ProgressMessage            : OS disk encryption started

PS > Get-AzureRmVMDiskEncryptionStatus -ResourceGroupName $resourceGroupName -VMName $vmName
OsVolumeEncrypted          : VMRestartPending
DataVolumesEncrypted       : Encrypted
OsVolumeEncryptionSettings : Microsoft.Azure.Management.Compute.Models.DiskEncryptionSettings
ProgressMessage            : OS disk successfully encrypted, please reboot the VM
```

<span data-ttu-id="66e37-134">Dopo tale richiesta, il riavvio della VM e 2-3 minuti per l'esecuzione del riavvio e dei passaggi finali nella destinazione, il messaggio di stato indicherà che la crittografia è completata.</span><span class="sxs-lookup"><span data-stu-id="66e37-134">Once prompted to reboot the VM, and after restarting the VM, and giving 2-3 minutes for the reboot and for final steps to be performed on the target, the status message will indicate that encryption has finally completed.</span></span>   <span data-ttu-id="66e37-135">Quando viene visualizzato tale messaggio, l'unità del sistema operativo crittografata sarà pronta per l'uso e la VM sarà nuovamente utilizzabile.</span><span class="sxs-lookup"><span data-stu-id="66e37-135">Once this message is available, the encrypted OS drive is expected to be ready for use and for the VM to be usable again.</span></span>

<span data-ttu-id="66e37-136">Se questa sequenza non è stata visualizzata o le informazioni di avvio, il messaggio di stato o altri indicatori di errore segnalano che la crittografia del sistema operativo ha avuto esito negativo nel corso di questo processo (ad esempio, se viene visualizzato il messaggio di tipo "Impossibile smontare" descritto in questa guida), è consigliabile ripristinare lo snapshot o il backup della VM eseguiti subito prima della crittografia.</span><span class="sxs-lookup"><span data-stu-id="66e37-136">In cases where this sequence was not seen, or if boot information, progress message, or other error indicators report that OS encryption has failed in the middle of this process (for example if you are seeing the "failed to unmount" error described in this guide), it is recommended to restore the VM back to the snapshot or backup taken immediately prior to encryption.</span></span>  <span data-ttu-id="66e37-137">Prima del tentativo successivo, è consigliabile valutare di nuovo le caratteristiche della VM e verificare che siano soddisfatti tutti i prerequisiti.</span><span class="sxs-lookup"><span data-stu-id="66e37-137">Prior to the next attempt, it is suggested to re-evaluate the characteristics of the VM and ensure that all prerequisites are satisfied.</span></span>

## <a name="troubleshooting-azure-disk-encryption-behind-a-firewall"></a><span data-ttu-id="66e37-138">Risoluzione dei problemi di Crittografia dischi di Azure dietro un firewall</span><span class="sxs-lookup"><span data-stu-id="66e37-138">Troubleshooting Azure Disk Encryption behind a Firewall</span></span>
<span data-ttu-id="66e37-139">Quando la connettività è limitata da un firewall, da un requisito del proxy o dalle impostazioni di gruppi di sicurezza di rete (NSG), l'estensione potrebbe non essere più in grado di eseguire le attività necessarie.</span><span class="sxs-lookup"><span data-stu-id="66e37-139">When connectivity is restricted by a firewall, proxy requirement, or network security group (NSG) settings, the ability of the extension to perform needed tasks can be disrupted.</span></span>   <span data-ttu-id="66e37-140">È quindi possibile che vengano visualizzati messaggi di tipo "Stato estensione non disponibile nella VM" e che gli scenari previsti non vengano completati.</span><span class="sxs-lookup"><span data-stu-id="66e37-140">This can result in status messages such as "Extension status not available on the VM" and in expected scenarios failing to finish.</span></span>  <span data-ttu-id="66e37-141">Le sezioni che seguono illustrano alcuni problemi comuni relativi ai firewall che è possibile esaminare.</span><span class="sxs-lookup"><span data-stu-id="66e37-141">The sections that follow has some common firewall issues that you may investigate.</span></span>

### <a name="network-security-groups"></a><span data-ttu-id="66e37-142">Gruppi di sicurezza di rete</span><span class="sxs-lookup"><span data-stu-id="66e37-142">Network security groups</span></span>
<span data-ttu-id="66e37-143">Tutte le impostazioni dei gruppi di sicurezza di rete devono consentire all'endpoint di soddisfare i [prerequisiti](https://docs.microsoft.com/azure/security/azure-security-disk-encryption#prerequisites) di configurazione di rete documentati per la crittografia dei dischi.</span><span class="sxs-lookup"><span data-stu-id="66e37-143">Any network security group settings applied must still allow the endpoint to meet the documented network configuration [prerequisites](https://docs.microsoft.com/azure/security/azure-security-disk-encryption#prerequisites) for disk encryption.</span></span>

### <a name="azure-keyvault-behind-firewall"></a><span data-ttu-id="66e37-144">Azure Key Vault dietro un firewall</span><span class="sxs-lookup"><span data-stu-id="66e37-144">Azure Keyvault behind firewall</span></span>
<span data-ttu-id="66e37-145">La VM deve poter accedere all'insieme di credenziali delle chiavi.</span><span class="sxs-lookup"><span data-stu-id="66e37-145">The VM must be able to access key vault.</span></span> <span data-ttu-id="66e37-146">Vedere le indicazioni sull'accesso a un insieme di credenziali delle chiavi protetto da un firewall gestito dal team di [Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-access-behind-firewall).</span><span class="sxs-lookup"><span data-stu-id="66e37-146">Refer to guidance on access to key fault from behind a firewall that is maintained by the [Key Vault](https://docs.microsoft.com/azure/key-vault/key-vault-access-behind-firewall) team.</span></span>

### <a name="linux-package-management-behind-firewall"></a><span data-ttu-id="66e37-147">Gestione pacchetti Linux dietro un firewall</span><span class="sxs-lookup"><span data-stu-id="66e37-147">Linux package management behind firewall</span></span>
<span data-ttu-id="66e37-148">In fase di esecuzione, Crittografia dischi di Azure per Linux usa il sistema di gestione pacchetti della distribuzione di destinazione per installare i componenti che costituiscono prerequisiti necessari prima di abilitare la crittografia.</span><span class="sxs-lookup"><span data-stu-id="66e37-148">At run time, Azure Disk Encryption for Linux relies on the target distribution’s package management system to install needed prerequisite components prior to enabling encryption.</span></span>  <span data-ttu-id="66e37-149">Se le impostazioni del firewall impediscono alla VM di scaricare e installare tali componenti, si verificheranno errori successivi.</span><span class="sxs-lookup"><span data-stu-id="66e37-149">If firewall settings prevent the VM from being able to download and install these components, then subsequent failures are expected.</span></span>    <span data-ttu-id="66e37-150">I passaggi per eseguire questa configurazione possono variare in base alla distribuzione.</span><span class="sxs-lookup"><span data-stu-id="66e37-150">The steps to configure this may vary by distribution.</span></span>  <span data-ttu-id="66e37-151">In Red Hat, quando è necessario un proxy è essenziale verificare che subscription-manager e yum siano configurati correttamente.</span><span class="sxs-lookup"><span data-stu-id="66e37-151">On Red Hat, when a proxy is required, ensuring that subscription-manager and yum are set up properly is vital.</span></span>  <span data-ttu-id="66e37-152">Vedere [questo](https://access.redhat.com/solutions/189533) articolo del supporto Red Hat sull'argomento.</span><span class="sxs-lookup"><span data-stu-id="66e37-152">See [this](https://access.redhat.com/solutions/189533) Red Hat support article on this topic.</span></span>  

## <a name="troubleshooting-windows-server-2016-server-core"></a><span data-ttu-id="66e37-153">Risoluzione dei problemi di Server Core di Windows Server 2016</span><span class="sxs-lookup"><span data-stu-id="66e37-153">Troubleshooting Windows Server 2016 Server Core</span></span>

<span data-ttu-id="66e37-154">In Server Core di Windows Server 2016, la componente bdehdcfg non è disponibile per impostazione predefinita.</span><span class="sxs-lookup"><span data-stu-id="66e37-154">On Windows Server 2016 Server Core, the bdehdcfg component is not available by default.</span></span> <span data-ttu-id="66e37-155">Questa componente è necessaria per la Crittografia dischi di Azure.</span><span class="sxs-lookup"><span data-stu-id="66e37-155">This component is required by Azure Disk Encryption.</span></span>

<span data-ttu-id="66e37-156">Per risolvere questo problema, copiare i seguenti 4 file da una macchina virtuale del data center di Windows Server 2016 nella cartella c:\windows\system32 dell'immagine di Server Core:</span><span class="sxs-lookup"><span data-stu-id="66e37-156">To workaround this issue, copy the following 4 files from a Windows Server 2016 Data Center VM to the c:\windows\system32 folder of the Server Core image:</span></span>

```
bdehdcfg.exe
bdehdcfglib.dll
bdehdcfglib.dll.mui
bdehdcfg.exe.mui
```

<span data-ttu-id="66e37-157">Quindi, eseguire il comando seguente:</span><span class="sxs-lookup"><span data-stu-id="66e37-157">Then, run the following command:</span></span>

```
bdehdcfg.exe -target default
```

<span data-ttu-id="66e37-158">Verrà creata una partizione del sistema di 550MB e quindi, dopo un riavvio, è possibile usare Diskpart per verificare i volumi e continuare.</span><span class="sxs-lookup"><span data-stu-id="66e37-158">This will create a 550MB system partition and then after a reboot, you can use Diskpart to check the volumes, and proceed.</span></span>  

<span data-ttu-id="66e37-159">ad esempio:</span><span class="sxs-lookup"><span data-stu-id="66e37-159">For example:</span></span>

```
DISKPART> list vol

  Volume ###  Ltr  Label        Fs     Type        Size     Status     Info
  ----------  ---  -----------  -----  ----------  -------  ---------  --------
  Volume 0     C                NTFS   Partition    126 GB  Healthy    Boot
  Volume 1                      NTFS   Partition    550 MB  Healthy    System
  Volume 2     D   Temporary S  NTFS   Partition     13 GB  Healthy    Pagefile
```
## <a name="see-also"></a><span data-ttu-id="66e37-160">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="66e37-160">See also</span></span>
<span data-ttu-id="66e37-161">In questo documento sono stati esaminati alcuni problemi comuni di Crittografia dischi di Azure ed è stato illustrato come risolverli.</span><span class="sxs-lookup"><span data-stu-id="66e37-161">In this document, you learned more about some common issues in Azure disk encryption, and how to troubleshoot.</span></span> <span data-ttu-id="66e37-162">Per altre informazioni su questo servizio e sulle relative funzionalità, vedere:</span><span class="sxs-lookup"><span data-stu-id="66e37-162">For more information about this service and its capability read:</span></span>

- [<span data-ttu-id="66e37-163">Applicare la crittografia dei dischi nel Centro sicurezza di Azure</span><span class="sxs-lookup"><span data-stu-id="66e37-163">Apply disk encryption in Azure Security Center</span></span>](https://docs.microsoft.com/azure/security-center/security-center-apply-disk-encryption)
- [<span data-ttu-id="66e37-164">Crittografare una macchina virtuale di Azure</span><span class="sxs-lookup"><span data-stu-id="66e37-164">Encrypt an Azure Virtual Machine</span></span>](https://docs.microsoft.com/azure/security-center/security-center-disk-encryption)
- [<span data-ttu-id="66e37-165">Crittografia dei dati inattivi di Azure</span><span class="sxs-lookup"><span data-stu-id="66e37-165">Azure Data Encryption-at-Rest</span></span>](https://docs.microsoft.com/azure/security/azure-security-encryption-atrest)
