---
title: Integrazione di Gateway Desktop remoto con Azure MFA tramite l'estensione NPS | Microsoft Docs
description: Questo articolo illustra come integrare l'infrastruttura Gateway Desktop remoto con Azure MFA usando l'estensione NPS (Network Policy Server, Server dei criteri di rete) per Microsoft Azure.
services: active-directory
keywords: Azure MFA, integrare Gateway Desktop remoto, Azure Active Directory, estensione NPS (Network Policy Server)
documentationcenter: 
author: kgremban
manager: femila
ms.assetid: 
ms.service: active-directory
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/15/2017
ms.author: kgremban
ms.reviewer: jsnow
ms.custom: it-pro
ms.openlocfilehash: 6ff9a341b31e5005949dcc0ecb2591060269846e
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/18/2017
---
#  <a name="integrate-your-remote-desktop-gateway-infrastructure-using-the-network-policy-server-nps-extension-and-azure-ad"></a><span data-ttu-id="57f1b-104">Integrare l'infrastruttura Gateway Desktop remoto con Azure MFA usando l'estensione NPS (Network Policy Server, Server dei criteri di rete) e Azure AD</span><span class="sxs-lookup"><span data-stu-id="57f1b-104">Integrate your Remote Desktop Gateway infrastructure using the Network Policy Server (NPS) extension and Azure AD</span></span>

<span data-ttu-id="57f1b-105">Questo articolo contiene i dettagli relativi all'integrazione dell'infrastruttura Gateway Desktop remoto con Azure Multi-Factor Authentication (MFA) usando l'estensione NPS (Network Policy Server, Server dei criteri di rete) per Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="57f1b-105">This article provides details for integrating your Remote Desktop Gateway infrastructure with Azure Multi-Factor Authentication (MFA) using the Network Policy Server (NPS) extension for Microsoft Azure.</span></span> 

<span data-ttu-id="57f1b-106">L'estensione NPS (Network Policy Server, Server dei criteri) per Azure consente agli utenti di proteggere l'autenticazione di client RADIUS (Remote Authentication Dial-In User Service) tramite il servizio [Azure Multi-Factor Authentication (MFA)](multi-factor-authentication.md) basato sul cloud.</span><span class="sxs-lookup"><span data-stu-id="57f1b-106">The Network Policy Service (NPS) extension for Azure allows customers to safeguard Remote Authentication Dial-In User Service (RADIUS) client authentication using Azure’s cloud-based [Multi-Factor Authentication (MFA)](multi-factor-authentication.md).</span></span> <span data-ttu-id="57f1b-107">Questa soluzione fornisce la verifica in due passaggi per l'aggiunta di un secondo livello di sicurezza agli accessi e alle transazioni degli utenti.</span><span class="sxs-lookup"><span data-stu-id="57f1b-107">This solution provides two-step verification for adding a second layer of security to user sign-ins and transactions.</span></span>

<span data-ttu-id="57f1b-108">Questo articolo contiene istruzione dettagliate per l'integrazione dell'infrastruttura Gateway Desktop remoto con Azure MFA tramite l'estensione NPS per Azure.</span><span class="sxs-lookup"><span data-stu-id="57f1b-108">This article provides step-by-step instructions for integrating the NPS infrastructure with Azure MFA using the NPS extension for Azure.</span></span> <span data-ttu-id="57f1b-109">Questo consente la verifica sicura per gli utenti che tentano di accedere a Gateway Desktop remoto.</span><span class="sxs-lookup"><span data-stu-id="57f1b-109">This enables secure verification for users attempting to log on to a Remote Desktop Gateway.</span></span> 

<span data-ttu-id="57f1b-110">Servizi di accesso e criteri di rete consente alle organizzazioni di eseguire le operazioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="57f1b-110">The Network Policy and Access Services (NPS) gives organizations the ability to do the following:</span></span>
* <span data-ttu-id="57f1b-111">Definire posizioni centrali per la gestione e il controllo delle richieste di rete, indicando quali utenti possono connettersi, le ore del giorno in cui sono consentite le connessioni, la durata delle connessioni, il livello di sicurezza che i client devono usare per la connessione e così via.</span><span class="sxs-lookup"><span data-stu-id="57f1b-111">Define central locations for the management and control of network requests by specifying who can connect, what times of day connections are allowed, the duration of connections, and the level of security that clients must use to connect, and so on.</span></span> <span data-ttu-id="57f1b-112">Invece che specificare questi criteri in ogni VPN o server Gateway Desktop remoto, è possibile specificarli una sola volta in una posizione centrale.</span><span class="sxs-lookup"><span data-stu-id="57f1b-112">Rather than specifying these policies on each VPN or Remote Desktop (RD) Gateway server, these policies can be specified once in a central location.</span></span> <span data-ttu-id="57f1b-113">Il protocollo RADIUS fornisce servizi centralizzati di autenticazione, autorizzazione e accounting.</span><span class="sxs-lookup"><span data-stu-id="57f1b-113">The RADIUS protocol provides the centralized Authentication, Authorization, and Accounting (AAA).</span></span> 
* <span data-ttu-id="57f1b-114">Stabilire e applicare criteri di integrità client di Protezione accesso alla rete che determinano se ai dispositivi viene concesso l'accesso alle risorse di rete con o senza restrizioni.</span><span class="sxs-lookup"><span data-stu-id="57f1b-114">Establish and enforce Network Access Protection (NAP) client health policies that determine whether devices are granted unrestricted or restricted access to network resources.</span></span>
* <span data-ttu-id="57f1b-115">Fornire un mezzo per imporre l'autenticazione e l'autorizzazione per l'accesso a commutatori Ethernet e punti di accesso wireless che supportano 802.1x.</span><span class="sxs-lookup"><span data-stu-id="57f1b-115">Provide a means to enforce authentication and authorization for access to 802.1x-capable wireless access points and Ethernet switches.</span></span>    

<span data-ttu-id="57f1b-116">In genere, le organizzazioni usano Server dei criteri di rete (RADIUS) per semplificare e centralizzare la gestione dei criteri VPN.</span><span class="sxs-lookup"><span data-stu-id="57f1b-116">Typically, organizations use NPS (RADIUS) to simplify and centralize the management of VPN polices.</span></span> <span data-ttu-id="57f1b-117">Tuttavia, molte organizzazioni usano anche Server dei criteri di rete per semplificare e centralizzare la gestione di criteri di autorizzazione connessioni Desktop remoto.</span><span class="sxs-lookup"><span data-stu-id="57f1b-117">However, many organizations also use NPS to simplify and centralize the management of RD Desktop Connection Authorization Policies (RD CAPs).</span></span> 

<span data-ttu-id="57f1b-118">Le organizzazioni possono anche integrare Server dei criteri di rete con Azure MFA per migliorare la sicurezza e offrire un livello elevato di conformità.</span><span class="sxs-lookup"><span data-stu-id="57f1b-118">Organizations can also integrate NPS with Azure MFA to enhance security and provide a high level of compliance.</span></span> <span data-ttu-id="57f1b-119">In questo modo, si garantisce che gli utenti eseguano la verifica in due passaggi per accedere a Gateway Desktop remoto.</span><span class="sxs-lookup"><span data-stu-id="57f1b-119">This helps ensure that users establish two-step verification to log on to the Remote Desktop Gateway.</span></span> <span data-ttu-id="57f1b-120">Affinché venga concesso loro l'accesso, gli utenti devono specificare la combinazione di nome utente/password con informazioni sotto il controllo dell'utente.</span><span class="sxs-lookup"><span data-stu-id="57f1b-120">For users to be granted access, they must provide their username/password combination with information that the user has in their control.</span></span> <span data-ttu-id="57f1b-121">Queste informazioni devono essere attendibili e non facilmente duplicabili, ad esempio un numero di telefono cellulare, un numero di rete fissa, un'applicazione in un dispositivo mobile e così via.</span><span class="sxs-lookup"><span data-stu-id="57f1b-121">This information must be trusted and not easily duplicated, such as a cell phone number, landline number, application on a mobile device, and so on.</span></span>

<span data-ttu-id="57f1b-122">Prima che fosse disponibile l'estensione NPS per Azure, i clienti che volevano implementare la verifica in due passaggi per ambienti Server dei criteri di rete e Azure MFA integrati dovevano configurare e gestire un server MFA distinto nell'ambiente locale, come documentato nello scenario relativo a [Gateway Desktop remoto e server Azure Multi-Factor Authentication con RADIUS](multi-factor-authentication-get-started-server-rdg.md).</span><span class="sxs-lookup"><span data-stu-id="57f1b-122">Prior to the availability of the NPS extension for Azure, customers who wished to implement two-step verification for integrated NPS and Azure MFA environments had to configure and maintain a separate MFA Server in the on-premises environment as documented in [Remote Desktop Gateway and Azure Multi-Factor Authentication Server using RADIUS](multi-factor-authentication-get-started-server-rdg.md).</span></span>

<span data-ttu-id="57f1b-123">La disponibilità dell'estensione NPS per Azure offre ora alle organizzazioni la possibilità di scegliere se distribuire una soluzione MFA locale o una soluzione MFA basata sul cloud per l'autenticazione sicura dei client RADIUS.</span><span class="sxs-lookup"><span data-stu-id="57f1b-123">The availability of the NPS extension for Azure now gives organizations the choice to deploy either an on-premises based MFA solution or a cloud-based MFA solution to secure RADIUS client authentication.</span></span>

## <a name="authentication-flow"></a><span data-ttu-id="57f1b-124">Flusso di autenticazione</span><span class="sxs-lookup"><span data-stu-id="57f1b-124">Authentication Flow</span></span>

<span data-ttu-id="57f1b-125">Perché venga concesso loro l'accesso a risorse di rete tramite Gateway Desktop remoto, gli utenti devono soddisfare le condizioni specificate nei criteri di autorizzazione connessioni Desktop remoto e nei criteri di autorizzazione delle risorse di Desktop remoto.</span><span class="sxs-lookup"><span data-stu-id="57f1b-125">For users to be granted access to network resources through a Remote Desktop Gateway, they must meet the conditions specified in one RD Connection Authorization Policy (RD CAP) and one RD Resource Authorization Policy (RD RAP).</span></span> <span data-ttu-id="57f1b-126">I criteri di autorizzazione connessioni Desktop remoto specificano gli utenti autorizzati a connettersi a Gateway Desktop remoto.</span><span class="sxs-lookup"><span data-stu-id="57f1b-126">RD CAPs specify who is authorized to connect to RD Gateways.</span></span> <span data-ttu-id="57f1b-127">I criteri di autorizzazione delle risorse di Desktop remoto specificano le risorse di rete, come desktop remoti o app remote, ai quali l'utente è autorizzato a connettersi tramite Gateway Desktop remoto.</span><span class="sxs-lookup"><span data-stu-id="57f1b-127">RD RAPs specify the network resources, such as remote desktops or remote apps, that the user is allowed to connect to through the RD Gateway.</span></span> 

<span data-ttu-id="57f1b-128">Un'istanza di Gateway Desktop remoto può essere configurata per l'uso di un archivio centrale di criteri per i criteri di autorizzazione delle risorse di Desktop remoto.</span><span class="sxs-lookup"><span data-stu-id="57f1b-128">An RD Gateway can be configured to use a central policy store for RD CAPs.</span></span> <span data-ttu-id="57f1b-129">I criteri di autorizzazione delle risorse di Desktop remoto non possono usare criteri centrali, in quanto vengono elaborati da Gateway Desktop remoto.</span><span class="sxs-lookup"><span data-stu-id="57f1b-129">RD RAPs cannot use a central policy, as they are processed on the RD Gateway.</span></span> <span data-ttu-id="57f1b-130">Un esempio di Gateway Desktop remoto configurato per l'uso di un archivio centrale di criteri per criteri di autorizzazione connessioni Desktop remoto è un client RADIUS connesso a un altro server NPS che funge da archivio centrale di criteri.</span><span class="sxs-lookup"><span data-stu-id="57f1b-130">An example of an RD Gateway configured to use a central policy store for RD CAPs is a RADIUS client to another NPS server that serves as the central policy store.</span></span>

<span data-ttu-id="57f1b-131">Quando l'estensione NPS per Azure è integrata con Server dei criteri di rete e Gateway Desktop remoto, il corretto flusso di autenticazione è quello illustrato di seguito:</span><span class="sxs-lookup"><span data-stu-id="57f1b-131">When the NPS extension for Azure is integrated with the NPS and Remote Desktop Gateway, the successful authentication flow is as follows:</span></span>

1. <span data-ttu-id="57f1b-132">Il server Gateway Desktop remoto riceve da un utente Desktop remoto una richiesta di autenticazione per la connessione a una risorsa, ad esempio una sessione Desktop remoto.</span><span class="sxs-lookup"><span data-stu-id="57f1b-132">The Remote Desktop Gateway server receives an authentication request from a remote desktop user to connect to a resource, such as a Remote Desktop session.</span></span> <span data-ttu-id="57f1b-133">Fungendo da client RADIUS, il server Gateway Desktop remoto converte la richiesta in un messaggio di richiesta di accesso RADIUS e invia il messaggio al server RADIUS (Server dei criteri di rete) in cui è installata l'estensione NPS.</span><span class="sxs-lookup"><span data-stu-id="57f1b-133">Acting as a RADIUS client, the Remote Desktop Gateway server converts the request to a RADIUS Access-Request message and sends the message to the RADIUS (NPS) server where the NPS extension is installed.</span></span> 
2. <span data-ttu-id="57f1b-134">La combinazione di nome utente e password viene verificata in Active Directory e l'utente viene autenticato.</span><span class="sxs-lookup"><span data-stu-id="57f1b-134">The username and password combination is verified in Active Directory and the user is authenticated.</span></span>
3. <span data-ttu-id="57f1b-135">Se vengono soddisfatte tutte le condizioni specificate nella richiesta di connessione NPS e nei criteri di rete (ad esempio per quanto riguarda le restrizioni relative all'ora del giorno o all'appartenenza a gruppi), l'estensione NPS attiva una richiesta di autenticazione secondaria con Azure MFA.</span><span class="sxs-lookup"><span data-stu-id="57f1b-135">If all the conditions as specified in the NPS Connection Request and the Network Policies are met (for example, time of day or group membership restrictions), the NPS extension triggers a request for secondary authentication with Azure MFA.</span></span> 
4. <span data-ttu-id="57f1b-136">Azure MFA comunica con Azure AD, recupera i dettagli dell'utente ed esegue l'autenticazione secondaria usando il metodo configurato dall'utente (messaggio di testo, app per dispositivi mobili e così via).</span><span class="sxs-lookup"><span data-stu-id="57f1b-136">Azure MFA communicates with Azure AD, retrieves the user’s details, and performs the secondary authentication using the method configured by the user (text message, mobile app, and so on).</span></span> 
5. <span data-ttu-id="57f1b-137">Una volta completata la verifica MFA, Azure MFA comunica il risultato all'estensione NPS.</span><span class="sxs-lookup"><span data-stu-id="57f1b-137">Upon success of the MFA challenge, Azure MFA communicates the result to the NPS extension.</span></span>
6. <span data-ttu-id="57f1b-138">Il server NPS in cui è installata l'estensione invia un messaggio di autorizzazione di accesso RADIUS per i criteri di autorizzazione connessioni Desktop remoto al server Gateway Desktop remoto.</span><span class="sxs-lookup"><span data-stu-id="57f1b-138">The NPS server where the extension is installed sends a RADIUS Access-Accept message for the RD CAP policy to the Remote Desktop Gateway server.</span></span>
7. <span data-ttu-id="57f1b-139">All'utente viene concesso l'accesso alla risorsa di rete richiesta tramite Gateway Desktop remoto.</span><span class="sxs-lookup"><span data-stu-id="57f1b-139">The user is granted access to the requested network resource through the RD Gateway.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="57f1b-140">Prerequisiti</span><span class="sxs-lookup"><span data-stu-id="57f1b-140">Prerequisites</span></span>
<span data-ttu-id="57f1b-141">Questa sezione illustra in modo dettagliato i prerequisiti necessari per l'integrazione di Azure MFA con Gateway Desktop remoto.</span><span class="sxs-lookup"><span data-stu-id="57f1b-141">This section details the prerequisites necessary before integrating Azure MFA with the Remote Desktop Gateway.</span></span> <span data-ttu-id="57f1b-142">Prima di iniziare, è necessario che siano soddisfatti i prerequisiti seguenti.</span><span class="sxs-lookup"><span data-stu-id="57f1b-142">Before you begin, you must have the following prerequisites in place.</span></span>  

* <span data-ttu-id="57f1b-143">Infrastruttura Servizi Desktop remoto</span><span class="sxs-lookup"><span data-stu-id="57f1b-143">Remote Desktop Services (RDS) infrastructure</span></span>
* <span data-ttu-id="57f1b-144">Licenza di Azure MFA</span><span class="sxs-lookup"><span data-stu-id="57f1b-144">Azure MFA License</span></span>
* <span data-ttu-id="57f1b-145">Software Windows Server</span><span class="sxs-lookup"><span data-stu-id="57f1b-145">Windows Server software</span></span>
* <span data-ttu-id="57f1b-146">Ruolo Servizi di accesso e criteri di rete</span><span class="sxs-lookup"><span data-stu-id="57f1b-146">Network Policy and Access Services (NPS) role</span></span>
* <span data-ttu-id="57f1b-147">Azure AD con sincronizzazione con AD in locale</span><span class="sxs-lookup"><span data-stu-id="57f1b-147">Azure AD synched with on-premises AD</span></span> 
* <span data-ttu-id="57f1b-148">ID GUID di Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="57f1b-148">Azure Active Directory GUID ID</span></span>

### <a name="remote-desktop-services-rds-infrastructure"></a><span data-ttu-id="57f1b-149">Infrastruttura Servizi Desktop remoto</span><span class="sxs-lookup"><span data-stu-id="57f1b-149">Remote Desktop Services (RDS) infrastructure</span></span>
<span data-ttu-id="57f1b-150">Deve essere presente un'infrastruttura Servizi Desktop remoto funzionante.</span><span class="sxs-lookup"><span data-stu-id="57f1b-150">You must have a working Remote Desktop Services (RDS) infrastructure in place.</span></span> <span data-ttu-id="57f1b-151">In caso contrario, è possibile creare rapidamente questa infrastruttura di Azure usando il modello di avvio rapido seguente: [Create Remote Desktop Session Collection deployment](https://github.com/Azure/azure-quickstart-templates/tree/ad20c78b36d8e1246f96bb0e7a8741db481f957f/rds-deployment) (Creare una distribuzione della raccolta di sessioni di Desktop remoto).</span><span class="sxs-lookup"><span data-stu-id="57f1b-151">If you do not, then you can quickly create this infrastructure in Azure using the following quick start template: [Create Remote Desktop Session Collection deployment](https://github.com/Azure/azure-quickstart-templates/tree/ad20c78b36d8e1246f96bb0e7a8741db481f957f/rds-deployment).</span></span> 

<span data-ttu-id="57f1b-152">Se si vuole creare manualmente un'infrastruttura Servizi Desktop remoto locale per scopi di test, completare i passaggi di distribuzione.</span><span class="sxs-lookup"><span data-stu-id="57f1b-152">If you wish to manually create an on-premises RDS infrastructure quickly for testing purposes, follow the steps to deploy one.</span></span> 
<span data-ttu-id="57f1b-153">**Altre informazioni**: [Deploy RDS with Azure quick start](https://docs.microsoft.com/windows-server/remote/remote-desktop-services/rds-in-azure) (Avvio rapido per la distribuzione di Servizi Desktop remoto con Azure) e [Basic RDS infrastructure deployment](https://docs.microsoft.com/windows-server/remote/remote-desktop-services/rds-deploy-infrastructure) (Distribuzione di un'infrastruttura Servizi Desktop remoto di base).</span><span class="sxs-lookup"><span data-stu-id="57f1b-153">**Learn more**: [Deploy RDS with Azure quick start](https://docs.microsoft.com/windows-server/remote/remote-desktop-services/rds-in-azure) and [Basic RDS infrastructure deployment](https://docs.microsoft.com/windows-server/remote/remote-desktop-services/rds-deploy-infrastructure).</span></span> 

### <a name="licenses"></a><span data-ttu-id="57f1b-154">Licenze</span><span class="sxs-lookup"><span data-stu-id="57f1b-154">Licenses</span></span>
<span data-ttu-id="57f1b-155">È richiesta una licenza per Azure MFA, disponibile tramite una sottoscrizione di Azure AD Premium, Enterprise Mobility + Security (EMS) o MFA.</span><span class="sxs-lookup"><span data-stu-id="57f1b-155">Required is a license for Azure MFA, which is available through an Azure AD Premium, Enterprise Mobility plus Security (EMS), or an MFA subscription.</span></span> <span data-ttu-id="57f1b-156">Per altre informazioni, vedere [Come ottenere Azure Multi-Factor Authentication](multi-factor-authentication-versions-plans.md).</span><span class="sxs-lookup"><span data-stu-id="57f1b-156">For more information, see [How to get Azure Multi-Factor Authentication](multi-factor-authentication-versions-plans.md).</span></span> <span data-ttu-id="57f1b-157">A scopo di test, è possibile usare una sottoscrizione della versione di valutazione gratuita.</span><span class="sxs-lookup"><span data-stu-id="57f1b-157">For testing purposes, you can use a trial subscription.</span></span>

### <a name="software"></a><span data-ttu-id="57f1b-158">Software</span><span class="sxs-lookup"><span data-stu-id="57f1b-158">Software</span></span>
<span data-ttu-id="57f1b-159">L'estensione NPS richiede Windows Server 2008 R2 SP1 o versione successiva con il servizio ruolo NPS installato.</span><span class="sxs-lookup"><span data-stu-id="57f1b-159">The NPS extension requires Windows Server 2008 R2 SP1 or above with the NPS role service installed.</span></span> <span data-ttu-id="57f1b-160">Tutti i passaggi in questa sezione sono stati eseguiti usando Windows Server 2016.</span><span class="sxs-lookup"><span data-stu-id="57f1b-160">All the steps in this section were performed using Windows Server 2016.</span></span>

### <a name="network-policy-and-access-services-nps-role"></a><span data-ttu-id="57f1b-161">Ruolo Servizi di accesso e criteri di rete</span><span class="sxs-lookup"><span data-stu-id="57f1b-161">Network Policy and Access Services (NPS) role</span></span>
<span data-ttu-id="57f1b-162">Il servizio ruolo NPS fornisce le funzionalità di client e server RADIUS, nonché il servizio di integrità Protezione accesso alla rete.</span><span class="sxs-lookup"><span data-stu-id="57f1b-162">The NPS role service provides the RADIUS server and client functionality as well as Network Access Policy health service.</span></span> <span data-ttu-id="57f1b-163">Questo ruolo deve essere installato in almeno due computer dell'infrastruttura: il computer Gateway Desktop remoto e un altro server membro o controller di dominio.</span><span class="sxs-lookup"><span data-stu-id="57f1b-163">This role must be installed on at least two computers in your infrastructure: The Remote Desktop Gateway and another member server or domain controller.</span></span> <span data-ttu-id="57f1b-164">Per impostazione predefinita, il ruolo è già presente nel computer configurato come Gateway Desktop remoto.</span><span class="sxs-lookup"><span data-stu-id="57f1b-164">By default, the role is already present on the computer configured as the Remote Desktop Gateway.</span></span>  <span data-ttu-id="57f1b-165">È necessario installare il ruolo NPS almeno anche in un altro computer, ad esempio un controller di dominio o un server membro.</span><span class="sxs-lookup"><span data-stu-id="57f1b-165">You must also install the NPS role on at least on another computer, such as a domain controller or member server.</span></span>

<span data-ttu-id="57f1b-166">Per informazioni sull'installazione del servizio ruolo NPS di Windows Server 2012 o versioni successive, vedere [Install a NAP Health Policy Server](https://technet.microsoft.com/library/dd296890.aspx) (Installare un server criteri di integrità Protezione accesso alla rete).</span><span class="sxs-lookup"><span data-stu-id="57f1b-166">For information on installing the NPS role service Windows Server 2012 or older, see [Install a NAP Health Policy Server](https://technet.microsoft.com/library/dd296890.aspx).</span></span> <span data-ttu-id="57f1b-167">Per una descrizione delle procedure consigliate per Server dei criteri di rete, inclusi i consigli sull'installazione di Server dei criteri di rete in un controller di dominio, vedere [Best Practices for NPS](https://technet.microsoft.com/library/cc771746) (Procedure consigliate per Server dei criteri di rete).</span><span class="sxs-lookup"><span data-stu-id="57f1b-167">For a description of best practices for NPS, including the recommendation to install NPS on a domain controller, see [Best Practices for NPS](https://technet.microsoft.com/library/cc771746).</span></span>

### <a name="azure-active-directory-synched-with-on-premises-active-directory"></a><span data-ttu-id="57f1b-168">Azure Active Directory con sincronizzazione con Active Directory locale</span><span class="sxs-lookup"><span data-stu-id="57f1b-168">Azure Active Directory synched with on-premises Active Directory</span></span> 
<span data-ttu-id="57f1b-169">Per usare l'estensione NPS, gli utenti locali devono essere sincronizzati con Azure AD e abilitati per MFA.</span><span class="sxs-lookup"><span data-stu-id="57f1b-169">To use the NPS extension, on-premises users must be synced with Azure AD and enabled for MFA.</span></span> <span data-ttu-id="57f1b-170">Questa sezione presuppone che gli utenti locali siano sincronizzati con Azure AD tramite AD Connect.</span><span class="sxs-lookup"><span data-stu-id="57f1b-170">This section assumes that on-premises users are synched with Azure AD using AD Connect.</span></span> <span data-ttu-id="57f1b-171">Per informazioni su Azure AD Connect, vedere [Integrare le directory locali con Azure Active Directory](../active-directory/connect/active-directory-aadconnect.md).</span><span class="sxs-lookup"><span data-stu-id="57f1b-171">For information on Azure AD connect, see [Integrate your on-premises directories with Azure Active Directory](../active-directory/connect/active-directory-aadconnect.md).</span></span> 

### <a name="azure-active-directory-guid-id"></a><span data-ttu-id="57f1b-172">ID GUID di Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="57f1b-172">Azure Active Directory GUID ID</span></span>
<span data-ttu-id="57f1b-173">Per installare Server dei criteri di rete, è necessario conoscere il GUID di Azure AD.</span><span class="sxs-lookup"><span data-stu-id="57f1b-173">To install NPS, you need to know the GUID of the Azure AD.</span></span> <span data-ttu-id="57f1b-174">Le istruzioni per individuare il GUID di Azure AD sono disponibili nella sezione seguente.</span><span class="sxs-lookup"><span data-stu-id="57f1b-174">Instructions for finding the GUID of the Azure AD are provided below.</span></span>

## <a name="configure-multi-factor-authentication"></a><span data-ttu-id="57f1b-175">Configurare Multi-Factor Authentication</span><span class="sxs-lookup"><span data-stu-id="57f1b-175">Configure Multi-Factor Authentication</span></span> 
<span data-ttu-id="57f1b-176">Questa sezione contiene le istruzioni per l'integrazione di Azure MFA con Gateway Desktop remoto.</span><span class="sxs-lookup"><span data-stu-id="57f1b-176">This section provides instructions for integrating Azure MFA with the Remote Desktop Gateway.</span></span> <span data-ttu-id="57f1b-177">Un amministratore deve configurare il servizio Azure MFA prima che gli utenti possano effettuare la registrazione automatica dei propri dispositivi o applicazioni a più fattori.</span><span class="sxs-lookup"><span data-stu-id="57f1b-177">As an administrator, you must configure the Azure MFA service before users can self-register their multi-factor devices or applications.</span></span>

<span data-ttu-id="57f1b-178">Per informazioni su come abilitare MFA per gli utenti di Azure AD, seguire i passaggi descritti in [Introduzione ad Azure Multi-Factor Authentication nel cloud](multi-factor-authentication-get-started-cloud.md).</span><span class="sxs-lookup"><span data-stu-id="57f1b-178">Follow the steps in [Getting started with Azure Multi-Factor Authentication in the cloud](multi-factor-authentication-get-started-cloud.md) to enable MFA for your Azure AD users.</span></span> 

### <a name="configure-accounts-for-two-step-verification"></a><span data-ttu-id="57f1b-179">Configurare gli account per la verifica in due passaggi</span><span class="sxs-lookup"><span data-stu-id="57f1b-179">Configure accounts for two-step verification</span></span>
<span data-ttu-id="57f1b-180">Dopo che un account è stato abilitato per MFA, è possibile accedere alle risorse governate dai criteri MFA solo dopo aver configurato un dispositivo attendibile da usare per il secondo fattore di autenticazione con la verifica in due passaggi.</span><span class="sxs-lookup"><span data-stu-id="57f1b-180">Once an account has been enabled for MFA, you cannot sign in to resources governed by the MFA policy until you have successfully configured a trusted device to use for the second authentication factor have authenticated using two-step verification.</span></span>

<span data-ttu-id="57f1b-181">Per comprendere al meglio e configurare correttamente i dispositivi per MFA con il proprio account utente, seguire i passaggi descritti in [Quali sono i vantaggi di Azure Multi-Factor Authentication?](./end-user/multi-factor-authentication-end-user.md).</span><span class="sxs-lookup"><span data-stu-id="57f1b-181">Follow the steps in [What does Azure Multi-Factor Authentication mean for me?](./end-user/multi-factor-authentication-end-user.md) to understand and properly configure your devices for MFA with your user account.</span></span>

## <a name="install-and-configure-nps-extension"></a><span data-ttu-id="57f1b-182">Installare e configurare l'estensione NPS</span><span class="sxs-lookup"><span data-stu-id="57f1b-182">Install and configure NPS extension</span></span>
<span data-ttu-id="57f1b-183">Questa sezione fornisce istruzioni per configurare l'infrastruttura Servizi Desktop remoto per l'uso di Azure MFA per l'autenticazione client con Gateway Desktop remoto.</span><span class="sxs-lookup"><span data-stu-id="57f1b-183">This section provides instructions for configuring RDS infrastructure to use Azure MFA for client authentication with the Remote Desktop Gateway.</span></span>

### <a name="acquire-azure-active-directory-guid-id"></a><span data-ttu-id="57f1b-184">Acquisire l'ID GUID di Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="57f1b-184">Acquire Azure Active Directory GUID ID</span></span>

<span data-ttu-id="57f1b-185">Come parte della configurazione dell'estensione NPS, è necessario fornire le credenziali di amministratore e l'ID di Azure AD per il tenant di Azure AD.</span><span class="sxs-lookup"><span data-stu-id="57f1b-185">As part of the configuration of the NPS extension, you need to supply admin credentials and the Azure AD ID for your Azure AD tenant.</span></span> <span data-ttu-id="57f1b-186">La procedura seguente mostra come ottenere l'ID tenant.</span><span class="sxs-lookup"><span data-stu-id="57f1b-186">The following steps show you how to get the tenant ID.</span></span>

1. <span data-ttu-id="57f1b-187">Accedere al [portale di Azure](https://portal.azure.com) come amministratore globale del tenant di Azure.</span><span class="sxs-lookup"><span data-stu-id="57f1b-187">Sign in to the [Azure portal](https://portal.azure.com) as the global administrator of the Azure tenant.</span></span>
2. <span data-ttu-id="57f1b-188">Nel riquadro di spostamento sinistro fare clic sull'icona di **Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-188">In the left navigation, select the **Azure Active Directory** icon.</span></span>
3. <span data-ttu-id="57f1b-189">Selezionare **Proprietà**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-189">Select **Properties**.</span></span>
4. <span data-ttu-id="57f1b-190">Nel pannello Proprietà, accanto all'ID directory, fare clic sull'icona **Copia**, mostrata di seguito, per copiare l'ID negli Appunti.</span><span class="sxs-lookup"><span data-stu-id="57f1b-190">In the Properties blade, beside the Directory ID, click the **Copy** icon, as shown below, to copy the ID to clipboard.</span></span>

 ![Proprietà](./media/nps-extension-remote-desktop-gateway/image1.png)

### <a name="install-the-nps-extension"></a><span data-ttu-id="57f1b-192">Installare l'estensione di Server dei criteri di rete</span><span class="sxs-lookup"><span data-stu-id="57f1b-192">Install the NPS extension</span></span>
<span data-ttu-id="57f1b-193">Installare l'estensione NPS in un server con il ruolo Servizi di accesso e criteri di rete installato.</span><span class="sxs-lookup"><span data-stu-id="57f1b-193">Install the NPS extension on a server that has the Network Policy and Access Services (NPS) role installed.</span></span> <span data-ttu-id="57f1b-194">Questo funge da server RADIUS per la progettazione.</span><span class="sxs-lookup"><span data-stu-id="57f1b-194">This functions as the RADIUS server for your design.</span></span> 

>[!Important]
> <span data-ttu-id="57f1b-195">Assicurarsi di non installare l'estensione NPS nel server Gateway Desktop remoto.</span><span class="sxs-lookup"><span data-stu-id="57f1b-195">Be sure you do not install the NPS extension on your Remote Desktop Gateway server.</span></span>
> 

1. <span data-ttu-id="57f1b-196">Scaricare l'[estensione NPS](https://aka.ms/npsmfa).</span><span class="sxs-lookup"><span data-stu-id="57f1b-196">Download the [NPS extension](https://aka.ms/npsmfa).</span></span> 
2. <span data-ttu-id="57f1b-197">Copiare il file eseguibile di installazione (NpsExtnForAzureMfaInstaller.exe) nel server NPS.</span><span class="sxs-lookup"><span data-stu-id="57f1b-197">Copy the setup executable file (NpsExtnForAzureMfaInstaller.exe) to the NPS server.</span></span>
3. <span data-ttu-id="57f1b-198">Nel server NPS fare doppio clic su **NpsExtnForAzureMfaInstaller.exe**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-198">On the NPS server, double-click **NpsExtnForAzureMfaInstaller.exe**.</span></span> <span data-ttu-id="57f1b-199">Se richiesto, fare clic su **Esegui**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-199">If prompted, click **Run**.</span></span>
4. <span data-ttu-id="57f1b-200">Nella finestra di dialogo relativa all'estensione NPS per Azure MFA leggere le condizioni di licenza software, selezionare **Accetto i termini e le condizioni di licenza** e fare clic su **Installa**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-200">In the NPS Extension for Azure MFA dialog box, review the software license terms, check **I agree to the license terms and conditions**, and click **Install**.</span></span>
 
  ![Installazione dell'estensione per Azure MFA](./media/nps-extension-remote-desktop-gateway/image2.png)

5. <span data-ttu-id="57f1b-202">Nella finestra relativa all'estensione NPS per Azure MFA fare clic su Chiudi.</span><span class="sxs-lookup"><span data-stu-id="57f1b-202">In the NPS Extension for Azure MFA dialog box, click Close.</span></span> 

  ![Per installare l'estensione NPS per Azure MFA](./media/nps-extension-remote-desktop-gateway/image3.png)

### <a name="configure-certificates-for-use-with-the-nps-extension-using-a-powershell-script"></a><span data-ttu-id="57f1b-204">Configurare i certificati per l'uso con l'estensione NPS tramite uno script di PowerShell</span><span class="sxs-lookup"><span data-stu-id="57f1b-204">Configure certificates for use with the NPS extension using a PowerShell script</span></span>
<span data-ttu-id="57f1b-205">Per garantire comunicazioni protette e sicure, è necessario configurare i certificati che l'estensione NPS può usare.</span><span class="sxs-lookup"><span data-stu-id="57f1b-205">Next, you need to configure certificates for use by the NPS extension to ensure secure communications and assurance.</span></span> <span data-ttu-id="57f1b-206">I componenti di Server dei criteri di rete includono uno script di Windows PowerShell che configura un certificato autofirmato per l'uso con Server dei criteri di rete.</span><span class="sxs-lookup"><span data-stu-id="57f1b-206">The NPS components include a Windows PowerShell script that configures a self-signed certificate for use with NPS.</span></span> 

<span data-ttu-id="57f1b-207">Lo script esegue le azioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="57f1b-207">The script performs the following actions:</span></span>

* <span data-ttu-id="57f1b-208">Crea un certificato autofirmato</span><span class="sxs-lookup"><span data-stu-id="57f1b-208">Creates a self-signed certificate</span></span>
* <span data-ttu-id="57f1b-209">Associa la chiave pubblica del certificato all'entità servizio in Azure AD</span><span class="sxs-lookup"><span data-stu-id="57f1b-209">Associates public key of certificate to service principal on Azure AD</span></span>
* <span data-ttu-id="57f1b-210">Archivia il certificato nell'archivio del computer locale</span><span class="sxs-lookup"><span data-stu-id="57f1b-210">Stores the cert in the local machine store</span></span>
* <span data-ttu-id="57f1b-211">Concede l'accesso alla chiave privata del certificato all'utente di rete</span><span class="sxs-lookup"><span data-stu-id="57f1b-211">Grants access to the certificate’s private key to the network user</span></span>
* <span data-ttu-id="57f1b-212">Riavvia il servizio Server dei criteri di rete</span><span class="sxs-lookup"><span data-stu-id="57f1b-212">Restarts Network Policy Server service</span></span>

<span data-ttu-id="57f1b-213">Per usare certificati personalizzati, è necessario associare la parte pubblica del certificato all'entità servizio in Azure AD e così via.</span><span class="sxs-lookup"><span data-stu-id="57f1b-213">If you want to use your own certificates, you need to associate the public of your certificate to the service principle on Azure AD, and so on.</span></span>

<span data-ttu-id="57f1b-214">Per usare lo script, specificare l'estensione con le credenziali amministrative di Azure AD e l'ID tenant di Azure AD copiato in precedenza.</span><span class="sxs-lookup"><span data-stu-id="57f1b-214">To use the script, provide the extension with your Azure AD Admin credentials and the Azure AD tenant ID that you copied earlier.</span></span> <span data-ttu-id="57f1b-215">Eseguire lo script in ogni server NPS in cui è stata installata l'estensione NPS.</span><span class="sxs-lookup"><span data-stu-id="57f1b-215">Run the script on each NPS server where you installed the NPS extension.</span></span> <span data-ttu-id="57f1b-216">Eseguire quindi le operazioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="57f1b-216">Then do the following:</span></span>

1. <span data-ttu-id="57f1b-217">Aprire un prompt di Windows PowerShell come amministratore.</span><span class="sxs-lookup"><span data-stu-id="57f1b-217">Open an administrative Windows PowerShell prompt.</span></span>
2. <span data-ttu-id="57f1b-218">Al prompt di PowerShell digitare **cd 'c:\Programmi\Microsoft\AzureMfa\Config'** e premere **INVIO**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-218">At the PowerShell prompt, type **cd ‘c:\Program Files\Microsoft\AzureMfa\Config’**, and press **ENTER**.</span></span>
3. <span data-ttu-id="57f1b-219">Digitare _.\AzureMfsNpsExtnConfigSetup.ps1_ e premere **INVIO**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-219">Type _.\AzureMfsNpsExtnConfigSetup.ps1_, and press **ENTER**.</span></span> <span data-ttu-id="57f1b-220">Lo script verifica se il modulo di PowerShell per Azure Active Directory è installato.</span><span class="sxs-lookup"><span data-stu-id="57f1b-220">The script checks to see if the Azure Active Directory PowerShell module is installed.</span></span> <span data-ttu-id="57f1b-221">Se non è installato, lo installa.</span><span class="sxs-lookup"><span data-stu-id="57f1b-221">If not installed, the script installs the module for you.</span></span>

  ![Azure AD PowerShell](./media/nps-extension-remote-desktop-gateway/image4.png)
  
4. <span data-ttu-id="57f1b-223">Dopo che lo script ha verificato l'installazione del modulo di PowerShell, viene visualizzata la finestra di dialogo relativa al modulo di PowerShell per Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="57f1b-223">After the script verifies the installation of the PowerShell module, it displays the Azure Active Directory PowerShell module dialog box.</span></span> <span data-ttu-id="57f1b-224">Nella finestra di dialogo immettere le credenziali e la password di amministratore di Azure AD e fare clic su **Accedi**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-224">In the dialog box, enter your Azure AD admin credentials and password, and click **Sign In**.</span></span>

  ![Aprire l'account di PowerShell](./media/nps-extension-remote-desktop-gateway/image5.png)

5. <span data-ttu-id="57f1b-226">Quando viene chiesto, incollare l'ID tenant copiato negli Appunti in precedenza e premere **INVIO**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-226">When prompted, paste the tenant ID you copied to the clipboard earlier, and press **ENTER**.</span></span>

  ![Immettere l'ID tenant](./media/nps-extension-remote-desktop-gateway/image6.png)

6. <span data-ttu-id="57f1b-228">Lo script crea un certificato autofirmato e apporta altre modifiche alla configurazione.</span><span class="sxs-lookup"><span data-stu-id="57f1b-228">The script creates a self-signed certificate and performs other configuration changes.</span></span> <span data-ttu-id="57f1b-229">L'output è come quello nell'immagine seguente.</span><span class="sxs-lookup"><span data-stu-id="57f1b-229">The output should be like the image shown below.</span></span>

  ![Certificato autofirmato](./media/nps-extension-remote-desktop-gateway/image7.png)

## <a name="configure-nps-components-on-remote-desktop-gateway"></a><span data-ttu-id="57f1b-231">Configurare i componenti di Server dei criteri di rete in Gateway Desktop remoto</span><span class="sxs-lookup"><span data-stu-id="57f1b-231">Configure NPS components on Remote Desktop Gateway</span></span>
<span data-ttu-id="57f1b-232">In questa sezione si configureranno i criteri di autorizzazione connessioni Gateway Desktop remoto e altre impostazioni RADIUS.</span><span class="sxs-lookup"><span data-stu-id="57f1b-232">In this section, you configure the Remote Desktop Gateway connection authorization policies and other RADIUS settings.</span></span>

<span data-ttu-id="57f1b-233">Il flusso di autenticazione richiede che vengano scambiati messaggi RADIUS tra Gateway Desktop remoto e il server NPS in cui è installata l'estensione NPS.</span><span class="sxs-lookup"><span data-stu-id="57f1b-233">The authentication flow requires that RADIUS messages be exchanged between the Remote Desktop Gateway and the NPS server where the NPS Server is installed.</span></span> <span data-ttu-id="57f1b-234">Questo significa che è necessario configurare le impostazioni del client RADIUS sia su Gateway Desktop remoto sia sul server NPS in cui è installata l'estensione NPS.</span><span class="sxs-lookup"><span data-stu-id="57f1b-234">This means that you must configure RADIUS client settings on both Remote Desktop Gateway and the NPS server where the NPS extension is installed.</span></span> 

### <a name="configure-remote-desktop-gateway-connection-authorization-policies-to-use-central-store"></a><span data-ttu-id="57f1b-235">Configurare criteri di autorizzazione connessioni per Gateway Desktop remoto per l'uso di un archivio centrale</span><span class="sxs-lookup"><span data-stu-id="57f1b-235">Configure Remote Desktop Gateway connection authorization policies to use central store</span></span>
<span data-ttu-id="57f1b-236">I criteri di autorizzazione connessioni Desktop remoto specificano i requisiti per la connessione a un server Gateway Desktop remoto.</span><span class="sxs-lookup"><span data-stu-id="57f1b-236">Remote Desktop connection authorization policies (RD CAPs) specify the requirements for connecting to a Remote Desktop Gateway server.</span></span> <span data-ttu-id="57f1b-237">I criteri di autorizzazione connessioni Desktop remoto possono essere archiviati in locale (impostazione predefinita) oppure in un archivio di criteri di autorizzazione connessioni Desktop remoto centrale che esegue Server dei criteri di rete.</span><span class="sxs-lookup"><span data-stu-id="57f1b-237">RD CAPs can be stored locally (default) or they can be stored in a central RD CAP store that is running NPS.</span></span> <span data-ttu-id="57f1b-238">Per configurare l'integrazione di Azure MFA con Servizi Desktop remoto, è necessario specificare l'uso di un archivio centrale.</span><span class="sxs-lookup"><span data-stu-id="57f1b-238">To configure integration of Azure MFA with RDS, you need to specify the use of a central store.</span></span>

1. <span data-ttu-id="57f1b-239">Nel server Gateway Desktop remoto aprire **Server Manager**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-239">On the RD Gateway server, open **Server Manager**.</span></span> 
2. <span data-ttu-id="57f1b-240">Scegliere **Strumenti** dal menu, fare clic su **Servizi Desktop remoto** e quindi su **Gestione Gateway Desktop remoto**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-240">On the menu, click **Tools**, point to **Remote Desktop Services**, and then click **Remote Desktop Gateway Manager**.</span></span>

  ![Servizi Desktop remoto](./media/nps-extension-remote-desktop-gateway/image8.png)

3. <span data-ttu-id="57f1b-242">In Gestione Gateway Desktop remoto fare clic con il pulsante destro del mouse su **\[Nome server\] (locale)** e quindi scegliere **Proprietà**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-242">In the RD Gateway Manger, right-click **\[Server Name\] (Local)**, and click **Properties**.</span></span>

  ![Server Name](./media/nps-extension-remote-desktop-gateway/image9.png)

4. <span data-ttu-id="57f1b-244">Nella finestra di dialogo Proprietà selezionare la scheda **Archivio criteri di autorizzazione connessioni Desktop remoto**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-244">In the Properties dialog box, select the **RD CAP** Store tab.</span></span>
5. <span data-ttu-id="57f1b-245">Nella scheda Archivio criteri di autorizzazione connessioni Desktop remoto selezionare **Server dei criteri di rete centrale**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-245">On the RD CAP Store tab, select **Central Server running NPS**.</span></span> 
6. <span data-ttu-id="57f1b-246">Nel campo **Immettere il nome o l'indirizzo IP del Server dei criteri di rete** digitare l'indirizzo IP o il nome del server in cui è stata installata l'estensione NPS.</span><span class="sxs-lookup"><span data-stu-id="57f1b-246">In the **Enter a name or IP address for the server running NPS** field, type the IP address or server name of the server where you installed the NPS extension.</span></span>

  ![Immettere il nome o l'indirizzo IP](./media/nps-extension-remote-desktop-gateway/image10.png)
  
7. <span data-ttu-id="57f1b-248">Fare clic su **Aggiungi**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-248">Click **Add**.</span></span>
8. <span data-ttu-id="57f1b-249">Nella finestra di dialogo **Segreto condiviso** immettere un segreto condiviso e quindi fare clic su **OK**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-249">In the **Shared Secret** dialog box, enter a shared secret, and then click **OK**.</span></span> <span data-ttu-id="57f1b-250">Assicurarsi di registrare il segreto condiviso e di archiviare il record in modo sicuro.</span><span class="sxs-lookup"><span data-stu-id="57f1b-250">Ensure you record this shared secret and store the record securely.</span></span>

 >[!NOTE]
 ><span data-ttu-id="57f1b-251">Il segreto condiviso viene usato per stabilire un trust tra i server e i client RADIUS.</span><span class="sxs-lookup"><span data-stu-id="57f1b-251">Shared secret is used to establish trust between the RADIUS servers and clients.</span></span> <span data-ttu-id="57f1b-252">Creare una password lunga e complessa.</span><span class="sxs-lookup"><span data-stu-id="57f1b-252">Create a long and complex password.</span></span>
 >

 ![Segreto condiviso](./media/nps-extension-remote-desktop-gateway/image11.png)

9. <span data-ttu-id="57f1b-254">Fare clic su **OK** per chiudere la finestra di dialogo.</span><span class="sxs-lookup"><span data-stu-id="57f1b-254">Click **OK** to close the dialog box.</span></span>

### <a name="configure-radius-timeout-value-on-remote-desktop-gateway-nps"></a><span data-ttu-id="57f1b-255">Configurare il valore di timeout RADIUS in Server dei criteri di rete per Gateway Desktop remoto</span><span class="sxs-lookup"><span data-stu-id="57f1b-255">Configure RADIUS timeout value on Remote Desktop Gateway NPS</span></span>
<span data-ttu-id="57f1b-256">Per garantire il tempo necessario per convalidare le credenziali degli utenti, eseguire la verifica in due passaggi, ricevere le risposte e rispondere a messaggi RADIUS, è necessario regolare il valore di timeout RADIUS.</span><span class="sxs-lookup"><span data-stu-id="57f1b-256">To ensure there is time to validate users’ credentials, perform two-step verification, receive responses, and respond to RADIUS messages, it is necessary to adjust the RADIUS timeout value.</span></span>

1. <span data-ttu-id="57f1b-257">In Server Manager nel server Gateway Desktop remoto fare clic su **Strumenti** e quindi su **Server dei criteri di rete**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-257">On the RD Gateway server, in Server Manager, click **Tools**, and then click **Network Policy Server**.</span></span> 
2. <span data-ttu-id="57f1b-258">Nella console **Server dei criteri di rete (locale)** espandere **Client e server RADIUS** e quindi selezionare **Gruppi di server RADIUS remoti**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-258">In the **NPS (Local)** console, expand **RADIUS Clients and Servers**, and select **Remote RADIUS Server**.</span></span>

 ![Gruppi di server RADIUS remoti](./media/nps-extension-remote-desktop-gateway/image12.png)

3. <span data-ttu-id="57f1b-260">Nel riquadro dei dettagli fare doppio clic su **GRUPPO DI SERVER GATEWAY DI SERVIZI TERMINAL**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-260">In the details pane, double-click **TS GATEWAY SERVER GROUP**.</span></span>

 >[!NOTE]
 ><span data-ttu-id="57f1b-261">Questo gruppo di server RADIUS è stato creato durante la configurazione del server centrale per i criteri NPS.</span><span class="sxs-lookup"><span data-stu-id="57f1b-261">This RADIUS Server Group was created when you configured the central server for NPS policies.</span></span> <span data-ttu-id="57f1b-262">Gateway Desktop remoto inoltra i messaggi RADIUS a questo server o gruppo di server, se il gruppo ne contiene più di uno.</span><span class="sxs-lookup"><span data-stu-id="57f1b-262">The RD Gateway forwards RADIUS messages to this server or group of servers, if more than one in the group.</span></span>
 >

4. <span data-ttu-id="57f1b-263">Nella finestra di dialogo **Proprietà GRUPPO DI SERVER GATEWAY DI SERVIZI TERMINAL** selezionare l'indirizzo IP o il nome del server NPS configurato per archiviare i criteri di autorizzazione connessioni Desktop remoto e quindi fare clic su **Modifica**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-263">In the **TS GATEWAY SERVER GROUP Properties** dialog box, select the IP address or name of the NPS server you configured to store RD CAPs, and then click **Edit**.</span></span> 

 ![Gruppo di server gateway di Servizi terminal](./media/nps-extension-remote-desktop-gateway/image13.png)

5. <span data-ttu-id="57f1b-265">Nella finestra di dialogo **Modifica server RADIUS** selezionare la scheda **Bilanciamento del carico**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-265">In the **Edit RADIUS Server** dialog box, select the **Load Balancing** tab.</span></span>
6. <span data-ttu-id="57f1b-266">Nella campo **Numero di secondi senza risposta prima che la richiesta venga annullata** della scheda **Bilanciamento del carico** modificare il valore predefinito da 3 a un valore compreso tra 30 e 60 secondi.</span><span class="sxs-lookup"><span data-stu-id="57f1b-266">In the **Load Balancing** tab, in the **Number of seconds without response before request is considered dropped** field, change the default value from 3 to a value between 30 and 60 seconds.</span></span>
7. <span data-ttu-id="57f1b-267">Nel campo **Numero di secondi tra le richieste quando il server viene identificato come non disponibile** modificare il valore di 30 secondi in un valore uguale o maggiore del valore specificato nel passaggio precedente.</span><span class="sxs-lookup"><span data-stu-id="57f1b-267">In the **Number of seconds between requests when server is identified as unavailable** field, change the default value of 30 seconds to a value that is equal to or greater than the value you specified in the previous step.</span></span>

 ![Modificare il server RADIUS](./media/nps-extension-remote-desktop-gateway/image14.png)

8.  <span data-ttu-id="57f1b-269">Fare clic su OK due volte per chiudere le finestre di dialogo.</span><span class="sxs-lookup"><span data-stu-id="57f1b-269">Click OK two times to close the dialog boxes.</span></span>

### <a name="verify-connection-request-policies"></a><span data-ttu-id="57f1b-270">Verificare i criteri di richiesta di connessione</span><span class="sxs-lookup"><span data-stu-id="57f1b-270">Verify Connection Request Policies</span></span> 
<span data-ttu-id="57f1b-271">Per impostazione predefinita, quando si configura Gateway Desktop remoto per l'uso di un archivio centrale di criteri per i criteri di autorizzazione connessioni, Gateway Desktop remoto viene configurato per inoltrare richieste di criteri di autorizzazione connessioni al server NPS.</span><span class="sxs-lookup"><span data-stu-id="57f1b-271">By default, when you configure the RD Gateway to use a central policy store for connection authorization policies, the RD Gateway is configured to forward CAP requests to the NPS server.</span></span> <span data-ttu-id="57f1b-272">Il server NPS in cui è installata l'estensione per Azure MFA elabora la richiesta di accesso RADIUS.</span><span class="sxs-lookup"><span data-stu-id="57f1b-272">The NPS server with the Azure MFA extension installed, processes the RADIUS access request.</span></span> <span data-ttu-id="57f1b-273">I passaggi seguenti mostrano come verificare i criteri di richiesta di connessione predefiniti.</span><span class="sxs-lookup"><span data-stu-id="57f1b-273">The following steps show you how to verify the default connection request policy.</span></span> 

1. <span data-ttu-id="57f1b-274">Nella console Server dei criteri di rete (locale) in Gateway Desktop remoto espandere **Criteri** e selezionare **Criteri di richiesta di connessione**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-274">On the RD Gateway, in the NPS (Local) console, expand **Policies**, and select **Connection Request Policies**.</span></span>
2. <span data-ttu-id="57f1b-275">Fare clic con il pulsante destro del mouse su **Criteri di richiesta di connessione** e fare doppio clic su **CRITERI DI AUTORIZZAZIONE GATEWAY DI SERVIZI TERMINAL**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-275">Right-click **Connect Request Policies**, and double-click **TS GATEWAY AUTHORIZATION POLICY**.</span></span>
3. <span data-ttu-id="57f1b-276">Nella finestra **Proprietà CRITERI DI AUTORIZZAZIONE GATEWAY DI SERVIZI TERMINAL** fare clic sulla scheda **Impostazioni**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-276">In the **TS GATEWAY AUTHORIZATION POLICY properties** dialog box, click the **Settings** tab.</span></span>
4. <span data-ttu-id="57f1b-277">Nella scheda **Impostazioni** fare clic su **Autenticazione** in Inoltro richiesta di connessione.</span><span class="sxs-lookup"><span data-stu-id="57f1b-277">On **Settings** tab, under Forwarding Connection Request, click **Authentication**.</span></span> <span data-ttu-id="57f1b-278">Il client RADIUS è configurato per inoltrare le richieste di autenticazione.</span><span class="sxs-lookup"><span data-stu-id="57f1b-278">RADIUS client is configured to forward requests for authentication.</span></span>

 ![Impostazioni di autenticazione](./media/nps-extension-remote-desktop-gateway/image15.png)
 
5. <span data-ttu-id="57f1b-280">Fare clic su **Annulla**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-280">Click **Cancel**.</span></span> 

## <a name="configure-nps-on-the-server-where-the-nps-extension-is-installed"></a><span data-ttu-id="57f1b-281">Configurare Server dei criteri di rete nel server in cui è installata l'estensione NPS</span><span class="sxs-lookup"><span data-stu-id="57f1b-281">Configure NPS on the server where the NPS extension is installed</span></span>
<span data-ttu-id="57f1b-282">Il server NPS in cui è installata l'estensione NPS deve essere in grado di scambiare messaggi RADIUS con il server NPS in Gateway Desktop remoto.</span><span class="sxs-lookup"><span data-stu-id="57f1b-282">The NPS server where the NPS extension is installed needs to be able to exchange RADIUS messages with the NPS server on the Remote Desktop Gateway.</span></span> <span data-ttu-id="57f1b-283">Per consentire questo scambio di messaggi, è necessario configurare i componenti di Server dei criteri di rete nel server in cui è installata l'estensione NPS.</span><span class="sxs-lookup"><span data-stu-id="57f1b-283">To enable this message exchange, you need to configure the NPS components on the server where the NPS extension service is installed.</span></span> 

### <a name="register-server-in-active-directory"></a><span data-ttu-id="57f1b-284">Registrare il server in Active Directory</span><span class="sxs-lookup"><span data-stu-id="57f1b-284">Register Server in Active Directory</span></span>
<span data-ttu-id="57f1b-285">Per il corretto funzionamento in questo scenario, è necessario registrare il server NPS in Active Directory.</span><span class="sxs-lookup"><span data-stu-id="57f1b-285">To function properly in this scenario, the NPS server needs to be registered in Active Directory.</span></span>

1. <span data-ttu-id="57f1b-286">Aprire **Server Manager**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-286">Open **Server Manager**.</span></span>
2. <span data-ttu-id="57f1b-287">In Server Manager fare clic su **Strumenti** e quindi su **Server dei criteri di rete**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-287">In Server Manager, click **Tools**, and then click **Network Policy Server**.</span></span> 
3. <span data-ttu-id="57f1b-288">Nella console di Server dei criteri di rete fare clic con il pulsante destro del mouse su **Server dei criteri di rete (locale)** e quindi scegliere **Registra server in Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-288">In the Network Policy Server console, right-click **NPS (Local)**, and then click **Register server in Active Directory**.</span></span> 
4. <span data-ttu-id="57f1b-289">Fare clic su **OK** due volte.</span><span class="sxs-lookup"><span data-stu-id="57f1b-289">Click **OK** two times.</span></span>

 ![Registrare il server in Active Directory](./media/nps-extension-remote-desktop-gateway/image16.png)

5. <span data-ttu-id="57f1b-291">Lasciare aperta la console per la procedura successiva.</span><span class="sxs-lookup"><span data-stu-id="57f1b-291">Leave the console open for the next procedure.</span></span>

### <a name="create-and-configure-radius-client"></a><span data-ttu-id="57f1b-292">Creare e configurare il client RADIUS</span><span class="sxs-lookup"><span data-stu-id="57f1b-292">Create and configure RADIUS client</span></span> 
<span data-ttu-id="57f1b-293">Gateway Desktop remoto deve essere configurato come client RADIUS per il server NPS.</span><span class="sxs-lookup"><span data-stu-id="57f1b-293">The Remote Desktop Gateway needs to be configured as a RADIUS client to the NPS server.</span></span> 

1. <span data-ttu-id="57f1b-294">Nel server NPS in cui è installata l'estensione NPS fare clic con il pulsante destro del mouse su **Client RADIUS** nella console **Server dei criteri di rete (locale)** e scegliere **Nuovo**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-294">On the NPS server where the NPS extension is installed, in the **NPS (Local)** console, right-click **RADIUS Clients** and click **New**.</span></span>

 ![Nuovo client RADIUS](./media/nps-extension-remote-desktop-gateway/image17.png)

2. <span data-ttu-id="57f1b-296">Nella finestra di dialogo **Nuovo client RADIUS** immettere un nome descrittivo, ad esempio _Gateway_, e l'indirizzo IP o il nome DNS del server Gateway Desktop remoto.</span><span class="sxs-lookup"><span data-stu-id="57f1b-296">In the **New RADIUS client** dialog box, provide a friendly name, such as _Gateway_, and the IP address or DNS name of the Remote Desktop Gateway server.</span></span> 
3. <span data-ttu-id="57f1b-297">Nei campi **Segreto condiviso** e **Conferma segreto condiviso** immettere lo stesso segreto usato in precedenza.</span><span class="sxs-lookup"><span data-stu-id="57f1b-297">In the **Shared secret** and the **Confirm shared secret** fields, enter the same secret that you used before.</span></span>

 ![Nome e indirizzo](./media/nps-extension-remote-desktop-gateway/image18.png)

4. <span data-ttu-id="57f1b-299">Fare clic su **OK** per chiudere la finestra di dialogo Nuovo client RADIUS.</span><span class="sxs-lookup"><span data-stu-id="57f1b-299">Click **OK** to close the New RADIUS client dialog box.</span></span>

### <a name="configure-network-policy"></a><span data-ttu-id="57f1b-300">Configurare i criteri di rete</span><span class="sxs-lookup"><span data-stu-id="57f1b-300">Configure Network Policy</span></span>
<span data-ttu-id="57f1b-301">Tenere presente che il server NPS con l'estensione per Azure MFA è l'archivio centrale di criteri designato per i criteri di autorizzazione connessioni.</span><span class="sxs-lookup"><span data-stu-id="57f1b-301">Recall the NPS server with the Azure MFA extension is the designated central policy store for the Connection Authorization Policy (CAP).</span></span> <span data-ttu-id="57f1b-302">Di conseguenza, è necessario implementare criteri di autorizzazione connessioni nel server NPS per autorizzare richieste di connessione valide.</span><span class="sxs-lookup"><span data-stu-id="57f1b-302">Therefore, you need to implement a CAP on the NPS server to authorize valid connections requests.</span></span>  

1. <span data-ttu-id="57f1b-303">Nella console Server dei criteri di rete (locale) espandere **Criteri** e fare clic su **Criteri di rete**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-303">In the NPS (Local) console, expand **Policies**, and click **Network Policies**.</span></span>
2. <span data-ttu-id="57f1b-304">Fare clic con il pulsante destro del mouse su **Connessioni ad altri server di accesso remoto** e scegliere **Duplica criterio**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-304">Right-click **Connections to other access servers**, and click **Duplicate policy**.</span></span> 

 ![Duplica criterio](./media/nps-extension-remote-desktop-gateway/image19.png)

3. <span data-ttu-id="57f1b-306">Fare clic con il pulsante destro del mouse su **Copia di Connessioni ad altri server di accesso remoto** e scegliere **Proprietà**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-306">Right-click **Copy of Connections to other access servers**, and click **Properties**.</span></span>

 ![Proprietà di rete](./media/nps-extension-remote-desktop-gateway/image20.png)

4. <span data-ttu-id="57f1b-308">Nella finestra di dialogo**Copia di Connessioni ad altri server di accesso remoto** immettere un nome appropriato, ad esempio **GatewayDesktopRemoto_CriteriAutorizzazioneConnessioni** in Nome criterio.</span><span class="sxs-lookup"><span data-stu-id="57f1b-308">In the **Copy of Connections to other access servers** dialog box, in Policy Name, enter a suitable name, such as **RDG_CAP**.</span></span> <span data-ttu-id="57f1b-309">Selezionare **Criterio attivato** e fare clic su **Concedi accesso**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-309">Check **Policy Enabled**, and select **Grant access**.</span></span> <span data-ttu-id="57f1b-310">Facoltativamente, in Tipo di server di accesso alla rete selezionare **Gateway Desktop remoto** oppure lasciare l'impostazione **Non specificato**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-310">Optionally, in Type of network access, select **Remote Desktop Gateway**, or you can leave it as **Unspecified**.</span></span>

 ![Copia di Connessioni ad altri server di accesso remoto](./media/nps-extension-remote-desktop-gateway/image21.png)

5.  <span data-ttu-id="57f1b-312">Fare clic sulla scheda **Vincoli** e selezionare **Consenti ai client di connettersi senza negoziare il metodo di autenticazione**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-312">Click the **Constraints** tab, and check **Allow clients to connect without negotiating an authentication method**.</span></span>

 ![Consenti ai client di connettersi senza negoziare il metodo di autenticazione](./media/nps-extension-remote-desktop-gateway/image22.png)

6. <span data-ttu-id="57f1b-314">Facoltativamente, è possibile fare clic sulla scheda **Condizioni** e aggiungere le condizioni che devono essere soddisfatte perché la connessione venga autorizzata, ad esempio l'appartenenza a un gruppo di Windows specifico.</span><span class="sxs-lookup"><span data-stu-id="57f1b-314">Optionally, click the **Conditions** tab and add conditions that must be met for the connection to be authorized, for example, membership in a specific Windows group.</span></span>

 ![Condizioni](./media/nps-extension-remote-desktop-gateway/image23.png)

7. <span data-ttu-id="57f1b-316">Fare clic su **OK**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-316">Click **OK**.</span></span> <span data-ttu-id="57f1b-317">Quando viene chiesto se visualizzare l'argomento della Guida corrispondente, fare clic su **No**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-317">When prompted to view the corresponding Help topic, click **No**.</span></span>
8. <span data-ttu-id="57f1b-318">Assicurarsi che i nuovi criteri siano visualizzati all'inizio dell'elenco, che siano abilitati e che concedano l'accesso.</span><span class="sxs-lookup"><span data-stu-id="57f1b-318">Ensure that your new policy is at the top of the list, that the policy is enabled, and that it grants access.</span></span>

 ![Criteri di rete](./media/nps-extension-remote-desktop-gateway/image24.png)

## <a name="verify-configuration"></a><span data-ttu-id="57f1b-320">Verificare la configurazione</span><span class="sxs-lookup"><span data-stu-id="57f1b-320">Verify configuration</span></span>
<span data-ttu-id="57f1b-321">Per verificare la configurazione, è necessario accedere a Gateway Desktop remoto con un client RDP appropriato.</span><span class="sxs-lookup"><span data-stu-id="57f1b-321">To verify the configuration, you need to log on the Remote Desktop Gateway with a suitable RDP client.</span></span> <span data-ttu-id="57f1b-322">Assicurarsi di usare un account consentito dai criteri di autorizzazione connessioni e abilitato per Azure MFA.</span><span class="sxs-lookup"><span data-stu-id="57f1b-322">Be sure to use an account that is allowed by your Connection Authorization Policies and is enabled for Azure MFA.</span></span> 

<span data-ttu-id="57f1b-323">Come mostrato nell'immagine seguente, è possibile usare la pagina **Accesso Web Desktop remoto**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-323">As show in the image below, you can use the **Remote Desktop Web Access** page.</span></span>

![Accesso Web Desktop remoto](./media/nps-extension-remote-desktop-gateway/image25.png)

<span data-ttu-id="57f1b-325">Dopo aver immesso correttamente le credenziali per l'autenticazione primaria, la finestra di dialogo Connessione desktop remoto indica lo stato Avvio della connessione remota, come mostrato di seguito.</span><span class="sxs-lookup"><span data-stu-id="57f1b-325">Upon successfully entering your credentials for primary authentication, the Remote Desktop Connect dialog box shows a status of Initiating remote connection, as shown below.</span></span> 

<span data-ttu-id="57f1b-326">Se l'autenticazione con il metodo di autenticazione secondario configurato in precedenza in Azure MFA avviene correttamente, viene stabilita una connessione alla risorsa.</span><span class="sxs-lookup"><span data-stu-id="57f1b-326">If you successfully authenticate with the secondary authentication method you previously configured in Azure MFA, you are connected to the resource.</span></span> <span data-ttu-id="57f1b-327">Se invece l'autenticazione secondaria non ha esito positivo, l'accesso alla risorsa viene negato.</span><span class="sxs-lookup"><span data-stu-id="57f1b-327">However, if the secondary authentication is not successful, you are denied access to resource.</span></span> 

![Avviare la connessione remota](./media/nps-extension-remote-desktop-gateway/image26.png)

<span data-ttu-id="57f1b-329">Nell'esempio seguente viene usata l'app Authenticator su un dispositivo Windows Phone per fornire l'autenticazione secondaria.</span><span class="sxs-lookup"><span data-stu-id="57f1b-329">In the example below, the Authenticator app on a Windows phone is used to provide the secondary authentication.</span></span>

![Account](./media/nps-extension-remote-desktop-gateway/image27.png)

<span data-ttu-id="57f1b-331">Dopo aver eseguito correttamente l'autenticazione con il metodo secondario, viene effettuato l'accesso a Gateway Desktop remoto nel modo normale.</span><span class="sxs-lookup"><span data-stu-id="57f1b-331">Once you have successfully authenticated using the secondary authentication method, you are logged into the Remote Desktop Gateway as normal.</span></span> <span data-ttu-id="57f1b-332">Tuttavia, poiché è stato richiesto di usare un metodo di autenticazione secondaria tramite un'app per dispositivi mobili in un dispositivo attendibile, il processo di accesso è più sicuro di quanto non sarebbe altrimenti.</span><span class="sxs-lookup"><span data-stu-id="57f1b-332">However, because you are required to use a secondary authentication method using a mobile app on a trusted device, the log-in process is more secure than it would be otherwise.</span></span>

### <a name="view-event-viewer-logs-for-successful-logon-events"></a><span data-ttu-id="57f1b-333">Visualizzare i log del Visualizzatore eventi per individuare gli eventi di accesso riusciti</span><span class="sxs-lookup"><span data-stu-id="57f1b-333">View Event Viewer logs for successful logon events</span></span>
<span data-ttu-id="57f1b-334">Per visualizzare gli eventi di accesso riusciti nei log del Visualizzatore eventi di Windows, è possibile usare il comando seguente di Windows PowerShell per eseguire una query sui log di Servizi terminal Windows e di sicurezza di Windows.</span><span class="sxs-lookup"><span data-stu-id="57f1b-334">To view the successful sign-in events in the Windows Event Viewer logs, you can issue the following Windows PowerShell command to query the Windows Terminal Services and Windows Security logs.</span></span>

<span data-ttu-id="57f1b-335">Per eseguire una query per individuare gli eventi di accesso riusciti nei log operativi del gateway _(Visualizzatore eventi\Registri applicazioni e servizi\Microsoft\Windows\TerminalServices-Gateway\Operational_, usare i comandi seguenti:</span><span class="sxs-lookup"><span data-stu-id="57f1b-335">To query successful sign-in events in the Gateway operational logs _(Event Viewer\Applications and Services Logs\Microsoft\Windows\TerminalServices-Gateway\Operational_, use the following commands:</span></span>

* <span data-ttu-id="57f1b-336">_Get-WinEvent -Logname Microsoft-Windows-TerminalServices-Gateway/Operational_ | where {$_.ID -eq '300'} | FL</span><span class="sxs-lookup"><span data-stu-id="57f1b-336">_Get-WinEvent -Logname Microsoft-Windows-TerminalServices-Gateway/Operational_ | where {$_.ID -eq '300'} | FL</span></span> 
* <span data-ttu-id="57f1b-337">Questo comando visualizza gli eventi di Windows che mostrano che l'utente ha soddisfatto i requisiti dei criteri di autorizzazione risorse e gli è stato concesso l'accesso.</span><span class="sxs-lookup"><span data-stu-id="57f1b-337">This command displays Windows events that show the user met resource authorization policy requirements (RD RAP) and was granted access.</span></span>

![Visualizzare il Visualizzatore eventi](./media/nps-extension-remote-desktop-gateway/image28.png)

* <span data-ttu-id="57f1b-339">_Get-WinEvent -Logname Microsoft-Windows-TerminalServices-Gateway/Operational_ | where {$_.ID -eq '200'} | FL</span><span class="sxs-lookup"><span data-stu-id="57f1b-339">_Get-WinEvent -Logname Microsoft-Windows-TerminalServices-Gateway/Operational_ | where {$_.ID -eq '200'} | FL</span></span>
* <span data-ttu-id="57f1b-340">Questo comando visualizza gli eventi che mostrano che l'utente ha soddisfatto i requisiti dei criteri di autorizzazione connessioni.</span><span class="sxs-lookup"><span data-stu-id="57f1b-340">This command displays the events that show when user met connection authorization policy requirements.</span></span>

![Autorizzazione connessioni](./media/nps-extension-remote-desktop-gateway/image29.png)

<span data-ttu-id="57f1b-342">È anche possibile visualizzare questo log e filtrarlo in base agli ID evento 300 e 200.</span><span class="sxs-lookup"><span data-stu-id="57f1b-342">You can also view this log and filter on event IDs, 300 and 200.</span></span> <span data-ttu-id="57f1b-343">Per eseguire una query per individuare gli eventi di accesso riusciti nei log del visualizzatore eventi di sicurezza, usare il comando seguente:</span><span class="sxs-lookup"><span data-stu-id="57f1b-343">To query successful logon events in the Security event viewer logs, use the following command:</span></span>

* <span data-ttu-id="57f1b-344">_Get-WinEvent -Logname Security_ | where {$_.ID -eq '6272'} | FL</span><span class="sxs-lookup"><span data-stu-id="57f1b-344">_Get-WinEvent -Logname Security_ | where {$_.ID -eq '6272'} | FL</span></span> 
* <span data-ttu-id="57f1b-345">Questo comando può essere eseguito nel server NPS centrale o nel server Gateway Desktop remoto.</span><span class="sxs-lookup"><span data-stu-id="57f1b-345">This command can be run on either the central NPS or the RD Gateway Server.</span></span> 

![Eventi di accesso riusciti](./media/nps-extension-remote-desktop-gateway/image30.png)

<span data-ttu-id="57f1b-347">È anche possibile aprire la visualizzazione personalizzata del log di sicurezza o di Servizi di accesso e criteri di rete, come illustrato di seguito:</span><span class="sxs-lookup"><span data-stu-id="57f1b-347">You can also view the Security log or the Network Policy and Access Services custom view, as shown below:</span></span>

![Servizi di accesso e criteri di rete](./media/nps-extension-remote-desktop-gateway/image31.png)

<span data-ttu-id="57f1b-349">Nel server in cui è installata l'estensione NPS per Azure MFA è possibile trovare i log applicazioni del Visualizzatore eventi specifici per l'estensione in _Registri applicazioni e servizi\Microsoft\AzureMfa_.</span><span class="sxs-lookup"><span data-stu-id="57f1b-349">On the server where you installed the NPS extension for Azure MFA, you can find Event Viewer application logs specific to the extension at _Application and Services Logs\Microsoft\AzureMfa_.</span></span> 

![Log applicazioni del Visualizzatore eventi](./media/nps-extension-remote-desktop-gateway/image32.png)

## <a name="troubleshoot-guide"></a><span data-ttu-id="57f1b-351">Guida per la risoluzione dei problemi</span><span class="sxs-lookup"><span data-stu-id="57f1b-351">Troubleshoot Guide</span></span>

<span data-ttu-id="57f1b-352">Se la configurazione non funziona come previsto, è consigliabile iniziare verificando che l'utente sia configurato per usare Azure MFA.</span><span class="sxs-lookup"><span data-stu-id="57f1b-352">If the configuration is not working as expected, the first place to start to troubleshoot is to verify that the user is configured to use Azure MFA.</span></span> <span data-ttu-id="57f1b-353">Chiedere all'utente di connettersi al [portale di Azure](https://portal.azure.com).</span><span class="sxs-lookup"><span data-stu-id="57f1b-353">Have the user connect to the [Azure portal](https://portal.azure.com).</span></span> <span data-ttu-id="57f1b-354">Se all'utente viene richiesta l'autenticazione secondaria e può eseguire l'autenticazione, la configurazione di Azure MFA è corretta.</span><span class="sxs-lookup"><span data-stu-id="57f1b-354">If users are prompted for secondary verification and can successfully authenticate, you can eliminate an incorrect configuration of Azure MFA.</span></span>

<span data-ttu-id="57f1b-355">Se Azure MFA funziona correttamente, esaminare i log eventi pertinenti.</span><span class="sxs-lookup"><span data-stu-id="57f1b-355">If Azure MFA is working for the user(s), you should review the relevant Event logs.</span></span> <span data-ttu-id="57f1b-356">I log da esaminare sono i log operativi del gateway e quelli relativi a eventi di sicurezza e Azure MFA, illustrati nella sezione precedente.</span><span class="sxs-lookup"><span data-stu-id="57f1b-356">These include the Security Event, Gateway operational, and Azure MFA logs that are discussed in the previous section.</span></span> 

<span data-ttu-id="57f1b-357">Di seguito è illustrato un esempio di output di un log di sicurezza che mostra un evento di accesso non riuscito (ID evento 6273).</span><span class="sxs-lookup"><span data-stu-id="57f1b-357">Below is an example output of Security log showing a failed logon event (Event ID 6273).</span></span>

![Evento di accesso non riuscito](./media/nps-extension-remote-desktop-gateway/image33.png)

<span data-ttu-id="57f1b-359">Di seguito è illustrato un evento correlato dei log di Azure MFA:</span><span class="sxs-lookup"><span data-stu-id="57f1b-359">Below is a related event from the AzureMFA logs:</span></span>

![Log di Azure MFA](./media/nps-extension-remote-desktop-gateway/image34.png)

<span data-ttu-id="57f1b-361">Per opzioni avanzate di risoluzione dei problemi, consultare i file di log in formato database di Server dei criteri di rete nella posizione in cui è installato il servizio Server dei criteri di rete.</span><span class="sxs-lookup"><span data-stu-id="57f1b-361">To perform advanced troubleshoot options, consult the NPS database format log files where the NPS service is installed.</span></span> <span data-ttu-id="57f1b-362">Questi file di log vengono creati nella cartella _%SystemRoot%\System32\Logs_ come file di testo con valori delimitati da virgole.</span><span class="sxs-lookup"><span data-stu-id="57f1b-362">These log files are created in _%SystemRoot%\System32\Logs_ folder as comma-delimited text files.</span></span> 

<span data-ttu-id="57f1b-363">Per una descrizione di questi file di log, vedere [Interpret NPS Database Format Log Files](https://technet.microsoft.com/library/cc771748.aspx) (Interpretare i file di log in formato database di Server dei criteri di rete).</span><span class="sxs-lookup"><span data-stu-id="57f1b-363">For a description of these log files, see [Interpret NPS Database Format Log Files](https://technet.microsoft.com/library/cc771748.aspx).</span></span> <span data-ttu-id="57f1b-364">Le voci di questi file di log sono difficili da interpretare senza importarle in un foglio di calcolo o in un database.</span><span class="sxs-lookup"><span data-stu-id="57f1b-364">The entries in these log files can be difficult to interpret without importing them into a spreadsheet or a database.</span></span> <span data-ttu-id="57f1b-365">Online sono disponibili diversi parser IAS che possono aiutare a interpretare i file di log.</span><span class="sxs-lookup"><span data-stu-id="57f1b-365">You can find several IAS parsers online to assist you in interpreting the log files.</span></span> 

<span data-ttu-id="57f1b-366">L'immagine seguente mostra l'output di una di queste [applicazioni shareware](http://www.deepsoftware.com/iasviewer) che è possibile scaricare.</span><span class="sxs-lookup"><span data-stu-id="57f1b-366">The image below shows the output of one such downloadable [shareware application](http://www.deepsoftware.com/iasviewer).</span></span> 

![App shareware](./media/nps-extension-remote-desktop-gateway/image35.png)

<span data-ttu-id="57f1b-368">Infine, per altre opzioni di risoluzione dei problemi, è possibile usare uno strumento di analisi di protocolli, ad esempio [Microsoft Message Analyzer](https://technet.microsoft.com/library/jj649776.aspx).</span><span class="sxs-lookup"><span data-stu-id="57f1b-368">Finally, for additional troubleshoot options, you can use a protocol analyzer, such [Microsoft Message Analyzer](https://technet.microsoft.com/library/jj649776.aspx).</span></span> 

<span data-ttu-id="57f1b-369">L'immagine seguente di Microsoft Message Analyzer mostra il traffico di rete filtrato in base al protocollo RADIUS che contiene il nome utente **Contoso\AliceC**.</span><span class="sxs-lookup"><span data-stu-id="57f1b-369">The image below from Microsoft Message Analyzer shows network traffic filtered on RADIUS protocol that contains the user name **Contoso\AliceC**.</span></span>

![Microsoft Message Analyzer](./media/nps-extension-remote-desktop-gateway/image36.png)

## <a name="next-steps"></a><span data-ttu-id="57f1b-371">Passaggi successivi</span><span class="sxs-lookup"><span data-stu-id="57f1b-371">Next steps</span></span>
[<span data-ttu-id="57f1b-372">Come ottenere Azure Multi-Factor Authentication</span><span class="sxs-lookup"><span data-stu-id="57f1b-372">How to get Azure Multi-Factor Authentication</span></span>](multi-factor-authentication-versions-plans.md)

[<span data-ttu-id="57f1b-373">Gateway Desktop remoto e server Azure Multi-Factor Authentication utilizzando RADIUS</span><span class="sxs-lookup"><span data-stu-id="57f1b-373">Remote Desktop Gateway and Azure Multi-Factor Authentication Server using RADIUS</span></span>](multi-factor-authentication-get-started-server-rdg.md)

[<span data-ttu-id="57f1b-374">Integrare le directory locali con Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="57f1b-374">Integrate your on-premises directories with Azure Active Directory</span></span>](../active-directory/connect/active-directory-aadconnect.md)
