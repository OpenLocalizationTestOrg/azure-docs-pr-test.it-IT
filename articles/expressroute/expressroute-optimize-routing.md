---
title: 'Ottimizzare il routing in ExpressRoute: Azure | Microsoft Docs'
description: "Questa pagina contiene informazioni dettagliate su come ottimizzare il routing in presenza di più circuiti ExpressRoute per la connessione tra Microsoft e la rete aziendale."
documentationcenter: na
services: expressroute
author: charwen
manager: carmonm
editor: 
ms.assetid: fca53249-d9c3-4cff-8916-f8749386a4dd
ms.service: expressroute
ms.devlang: na
ms.topic: get-started-article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 04/06/2017
ms.author: charwen
ms.openlocfilehash: c3a85b9445d69330c3f6c7d298169efddb6ecca0
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 07/11/2017
---
# <a name="optimize-expressroute-routing"></a><span data-ttu-id="30418-103">Ottimizzare il routing in ExpressRoute</span><span class="sxs-lookup"><span data-stu-id="30418-103">Optimize ExpressRoute Routing</span></span>
<span data-ttu-id="30418-104">In presenza di più circuiti ExpressRoute sono disponibili più percorsi per connettersi a Microsoft.</span><span class="sxs-lookup"><span data-stu-id="30418-104">When you have multiple ExpressRoute circuits, you have more than one path to connect to Microsoft.</span></span> <span data-ttu-id="30418-105">Il routing può quindi risultare non ottimale, ovvero è possibile che il traffico usi un percorso più lungo per raggiungere Microsoft e da Microsoft la rete del cliente.</span><span class="sxs-lookup"><span data-stu-id="30418-105">As a result, suboptimal routing may happen - that is, your traffic may take a longer path to reach Microsoft, and Microsoft to your network.</span></span> <span data-ttu-id="30418-106">Più lungo è il percorso di rete, maggiore sarà la latenza</span><span class="sxs-lookup"><span data-stu-id="30418-106">The longer the network path, the higher the latency.</span></span> <span data-ttu-id="30418-107">che ha un impatto diretto sull'esperienza utente e sulle prestazioni dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="30418-107">Latency has direct impact on application performance and user experience.</span></span> <span data-ttu-id="30418-108">Questo articolo descrive il problema e illustra come ottimizzare il routing con tecnologie di routing standard.</span><span class="sxs-lookup"><span data-stu-id="30418-108">This article will illustrate this problem and explain how to optimize routing using the standard routing technologies.</span></span>

## <a name="suboptimal-routing-from-customer-to-microsoft"></a><span data-ttu-id="30418-109">Routing non ottimale dal cliente a Microsoft</span><span class="sxs-lookup"><span data-stu-id="30418-109">Suboptimal routing from customer to Microsoft</span></span>
<span data-ttu-id="30418-110">Per esaminare il problema di routing si userà un esempio.</span><span class="sxs-lookup"><span data-stu-id="30418-110">Let's take a close look at the routing problem by an example.</span></span> <span data-ttu-id="30418-111">Si supponga di avere due sedi negli Stati Uniti: una a Los Angeles e una a New York.</span><span class="sxs-lookup"><span data-stu-id="30418-111">Imagine you have two offices in the US, one in Los Angeles and one in New York.</span></span> <span data-ttu-id="30418-112">Gli uffici sono connessi tramite una rete WAN (Wide Area Network), che può essere la propria rete backbone o la VPN IP del provider di servizi.</span><span class="sxs-lookup"><span data-stu-id="30418-112">Your offices are connected on a Wide Area Network (WAN), which can be either your own backbone network or your service provider's IP VPN.</span></span> <span data-ttu-id="30418-113">Sono disponibili due circuiti ExpressRoute, uno negli Stati Uniti occidentali e uno negli Stati Uniti orientali, anch'essi connessi tramite la rete WAN.</span><span class="sxs-lookup"><span data-stu-id="30418-113">You have two ExpressRoute circuits, one in US West and one in US East, that are also connected on the WAN.</span></span> <span data-ttu-id="30418-114">Naturalmente, per la connessione alla rete Microsoft esistono due percorsi.</span><span class="sxs-lookup"><span data-stu-id="30418-114">Obviously, you have two paths to connect to the Microsoft network.</span></span> <span data-ttu-id="30418-115">Si supponga ora di avere una distribuzione di Azure, ad esempio il servizio app di Azure, negli Stati Uniti occidentali e negli Stati Uniti orientali.</span><span class="sxs-lookup"><span data-stu-id="30418-115">Now imagine you have Azure deployment (for example, Azure App Service) in both US West and US East.</span></span> <span data-ttu-id="30418-116">Si vogliono connettere gli utenti di Los Angeles alla distribuzione di Azure negli Stati Uniti occidentali e gli utenti di New York alla distribuzione di Azure negli Stati Uniti orientali perché, secondo quanto annunciato dall'amministratore del servizio, per assicurare esperienze ottimali è consigliabile che gli utenti di ogni ufficio accedano ai servizi di Azure nelle vicinanze.</span><span class="sxs-lookup"><span data-stu-id="30418-116">Your intention is to connect your users in Los Angeles to Azure US West and your users in New York to Azure US East because your service admin advertises that users in each office access the nearby Azure services for optimal experiences.</span></span> <span data-ttu-id="30418-117">Sfortunatamente, il piano funziona correttamente per gli utenti della costa orientale, ma non per quelli della costa occidentale.</span><span class="sxs-lookup"><span data-stu-id="30418-117">Unfortunately, the plan works out well for the east coast users but not for the west coast users.</span></span> <span data-ttu-id="30418-118">Di seguito è riportata la causa del problema.</span><span class="sxs-lookup"><span data-stu-id="30418-118">The cause of the problem is the following.</span></span> <span data-ttu-id="30418-119">In ogni circuito ExpressRoute vengono pubblicati sia il prefisso di Azure negli Stati Uniti orientali (23.100.0.0/16) che il prefisso di Azure negli Stati Uniti occidentali (13.100.0.0/16).</span><span class="sxs-lookup"><span data-stu-id="30418-119">On each ExpressRoute circuit, we advertise to you both the prefix in Azure US East (23.100.0.0/16) and the prefix in Azure US West (13.100.0.0/16).</span></span> <span data-ttu-id="30418-120">Se non si conosce l'area di provenienza di un prefisso, non si potrà differenziarne la gestione.</span><span class="sxs-lookup"><span data-stu-id="30418-120">If you don't know which prefix is from which region, you are not able to treat it differently.</span></span> <span data-ttu-id="30418-121">Ritenendo che entrambi i prefissi siano più vicini agli Stati Uniti orientali rispetto agli Stati Uniti occidentali, la rete WAN potrebbe indirizzare gli utenti di entrambi gli uffici al circuito ExpressRoute negli Stati Uniti orientali.</span><span class="sxs-lookup"><span data-stu-id="30418-121">Your WAN network may think both of the prefixes are closer to US East than US West and therefore route both office users to the ExpressRoute circuit in US East.</span></span> <span data-ttu-id="30418-122">Molti utenti nell'ufficio di Los Angeles avranno di conseguenza un'esperienza insoddisfacente.</span><span class="sxs-lookup"><span data-stu-id="30418-122">In the end, you will have many unhappy users in the Los Angeles office.</span></span>

![Problema caso 1 ExpressRoute: routing non ottimale dal cliente a Microsoft](./media/expressroute-optimize-routing/expressroute-case1-problem.png)

### <a name="solution-use-bgp-communities"></a><span data-ttu-id="30418-124">Soluzione: usare BGP Community</span><span class="sxs-lookup"><span data-stu-id="30418-124">Solution: use BGP Communities</span></span>
<span data-ttu-id="30418-125">Per ottimizzare il routing per gli utenti di entrambi gli uffici, è necessario sapere quale prefisso proviene da Azure negli Stati Uniti occidentali e quale da Azure negli Stati Uniti orientali.</span><span class="sxs-lookup"><span data-stu-id="30418-125">To optimize routing for both office users, you need to know which prefix is from Azure US West and which from Azure US East.</span></span> <span data-ttu-id="30418-126">Queste informazioni vengono codificate con i [valori di BGP Community](expressroute-routing.md).</span><span class="sxs-lookup"><span data-stu-id="30418-126">We encode this information by using [BGP Community values](expressroute-routing.md).</span></span> <span data-ttu-id="30418-127">È stato assegnato un valore di BGP Community univoco per ogni area di Azure, ad esempio "12076:51004" per gli Stati Uniti orientali, "12076:51006" per gli Stati Uniti occidentali.</span><span class="sxs-lookup"><span data-stu-id="30418-127">We've assigned a unique BGP Community value to each Azure region, e.g. "12076:51004" for US East, "12076:51006" for US West.</span></span> <span data-ttu-id="30418-128">Dopo aver appreso da quale area di Azure proviene ogni prefisso, si può scegliere il circuito ExpressRoute da configurare come preferito.</span><span class="sxs-lookup"><span data-stu-id="30418-128">Now that you know which prefix is from which Azure region, you can configure which ExpressRoute circuit should be preferred.</span></span> <span data-ttu-id="30418-129">Poiché si usa BGP per lo scambio di informazioni di routing, è possibile usare il valore di BGP relativo alla preferenza locale per determinare il routing.</span><span class="sxs-lookup"><span data-stu-id="30418-129">Because we use the BGP to exchange routing info, you can use BGP's Local Preference to influence routing.</span></span> <span data-ttu-id="30418-130">In questo esempio è possibile assegnare un valore di preferenza locale 13.100.0.0/16 più alto negli Stati Uniti occidentali di quello negli Stati Uniti orientali e, in modo analogo, un valore di preferenza locale 23.100.0.0/16 più alto negli Stati Uniti orientali rispetto a quello negli Stati Uniti occidentali.</span><span class="sxs-lookup"><span data-stu-id="30418-130">In our example, you can assign a higher local preference value to 13.100.0.0/16 in US West than in US East, and similarly, a higher local preference value to 23.100.0.0/16 in US East than in US West.</span></span> <span data-ttu-id="30418-131">Questa configurazione garantirà che, quando sono disponibili entrambi i percorsi per connettersi a Microsoft, gli utenti di Los Angeles useranno il circuito ExpressRoute negli Stati Uniti occidentali per connettersi ad Azure negli Stati Uniti occidentali, mentre gli utenti di New York useranno il circuito ExpressRoute negli Stati Uniti orientali per connettersi ad Azure negli Stati Uniti orientali.</span><span class="sxs-lookup"><span data-stu-id="30418-131">This configuration will make sure that, when both paths to Microsoft are available, your users in Los Angeles will take the ExpressRoute circuit in US West to connect to Azure US West whereas your users in New York take the ExpressRoute in US East to Azure US East.</span></span> <span data-ttu-id="30418-132">Il routing è ottimizzato su entrambi i lati.</span><span class="sxs-lookup"><span data-stu-id="30418-132">Routing is optimized on both sides.</span></span> 

![Soluzione caso 1 ExpressRoute: usare BGP Community](./media/expressroute-optimize-routing/expressroute-case1-solution.png)

> [!NOTE]
> <span data-ttu-id="30418-134">La stessa tecnica, con la preferenza locale, può essere applicata al routing dal cliente alla rete virtuale di Azure.</span><span class="sxs-lookup"><span data-stu-id="30418-134">The same technique, using Local Preference, can be applied to routing from customer to Azure Virtual Network.</span></span> <span data-ttu-id="30418-135">I prefissi annunciati da Azure alla rete del cliente non vengono contrassegnati con il valore di BGP Community.</span><span class="sxs-lookup"><span data-stu-id="30418-135">We don't tag BGP Community value to the prefixes advertised from Azure to your network.</span></span> <span data-ttu-id="30418-136">Dato che si sa quale distribuzione della rete virtuale è vicina a un determinato ufficio, tuttavia, è possibile configurare i router di conseguenza in modo che venga preferito un circuito ExpressRoute rispetto a un altro.</span><span class="sxs-lookup"><span data-stu-id="30418-136">However, since you know which of your Virtual Network deployment is close to which of your office, you can configure your routers accordingly to prefer one ExpressRoute circuit to another.</span></span>
>
>

## <a name="suboptimal-routing-from-microsoft-to-customer"></a><span data-ttu-id="30418-137">Routing non ottimale da Microsoft al cliente</span><span class="sxs-lookup"><span data-stu-id="30418-137">Suboptimal routing from Microsoft to customer</span></span>
<span data-ttu-id="30418-138">Ecco un altro esempio in cui le connessioni da Microsoft usano un percorso più lungo per raggiungere la rete del cliente.</span><span class="sxs-lookup"><span data-stu-id="30418-138">Here is another example where connections from Microsoft take a longer path to reach your network.</span></span> <span data-ttu-id="30418-139">In questo caso, si usano i server di Exchange in locale ed Exchange Online in un [ambiente ibrido](https://technet.microsoft.com/library/jj200581%28v=exchg.150%29.aspx).</span><span class="sxs-lookup"><span data-stu-id="30418-139">In this case, you use on-premises Exchange servers and Exchange Online in a [hybrid environment](https://technet.microsoft.com/library/jj200581%28v=exchg.150%29.aspx).</span></span> <span data-ttu-id="30418-140">Gli uffici sono connessi a una rete WAN.</span><span class="sxs-lookup"><span data-stu-id="30418-140">Your offices are connected to a WAN.</span></span> <span data-ttu-id="30418-141">Si annunciano a Microsoft i prefissi dei server locali in entrambi gli uffici tramite i due circuiti ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="30418-141">You advertise the prefixes of your on-premises servers in both of your offices to Microsoft through the two ExpressRoute circuits.</span></span> <span data-ttu-id="30418-142">Nel caso, ad esempio, di migrazione delle cassette postali, Exchange Online avvierà le connessioni ai server locali.</span><span class="sxs-lookup"><span data-stu-id="30418-142">Exchange Online will initiate connections to the on-premises servers in cases such as mailbox migration.</span></span> <span data-ttu-id="30418-143">La connessione all'ufficio di Los Angeles viene purtroppo instradata al circuito ExpressRoute negli Stati Uniti orientali, attraversando l'intero continente prima di ritornare alla costa occidentale.</span><span class="sxs-lookup"><span data-stu-id="30418-143">Unfortunately, the connection to your Los Angeles office is routed to the ExpressRoute circuit in US East before traversing the entire continent back to the west coast.</span></span> <span data-ttu-id="30418-144">La causa di questo problema è simile a quella del primo.</span><span class="sxs-lookup"><span data-stu-id="30418-144">The cause of the problem is similar to the first one.</span></span> <span data-ttu-id="30418-145">Senza indicazioni la rete Microsoft non può stabilire quale prefisso del cliente è più vicino agli Stati Uniti orientali e quale agli Stati Uniti occidentali.</span><span class="sxs-lookup"><span data-stu-id="30418-145">Without any hint, the Microsoft network can't tell which customer prefix is close to US East and which one is close to US West.</span></span> <span data-ttu-id="30418-146">Può quindi accadere che venga scelga il percorso errato per l'ufficio di Los Angeles.</span><span class="sxs-lookup"><span data-stu-id="30418-146">It happens to pick the wrong path to your office in Los Angeles.</span></span>

![Caso 2 ExpressRoute: routing non ottimale da Microsoft al cliente](./media/expressroute-optimize-routing/expressroute-case2-problem.png)

### <a name="solution-use-as-path-prepending"></a><span data-ttu-id="30418-148">Soluzione: anteporre AS PATH</span><span class="sxs-lookup"><span data-stu-id="30418-148">Solution: use AS PATH prepending</span></span>
<span data-ttu-id="30418-149">Esistono due soluzioni al problema.</span><span class="sxs-lookup"><span data-stu-id="30418-149">There are two solutions to the problem.</span></span> <span data-ttu-id="30418-150">La prima consiste semplicemente nell'annunciare il prefisso locale per l'ufficio di Los Angeles, 177.2.0.0/31, sul circuito ExpressRoute negli Stati Uniti occidentali e il prefisso locale per l'ufficio di New York, 177.2.0.2/31, sul circuito ExpressRoute negli Stati Uniti orientali.</span><span class="sxs-lookup"><span data-stu-id="30418-150">The first one is that you simply advertise your on-premises prefix for your Los Angeles office, 177.2.0.0/31, on the ExpressRoute circuit in US West and your on-premises prefix for your New York office, 177.2.0.2/31, on the ExpressRoute circuit in US East.</span></span> <span data-ttu-id="30418-151">Di conseguenza, Microsoft avrà un solo percorso per connettersi agli uffici del cliente.</span><span class="sxs-lookup"><span data-stu-id="30418-151">As a result, there is only one path for Microsoft to connect to each of your offices.</span></span> <span data-ttu-id="30418-152">Non esistono ambiguità e il routing risulta ottimizzato.</span><span class="sxs-lookup"><span data-stu-id="30418-152">There is no ambiguity and routing is optimized.</span></span> <span data-ttu-id="30418-153">Con questa progettazione è necessario considerare la strategia di failover.</span><span class="sxs-lookup"><span data-stu-id="30418-153">With this design, you need to think about your failover strategy.</span></span> <span data-ttu-id="30418-154">Nel caso di interruzione del percorso verso Microsoft tramite ExpressRoute, è necessario assicurarsi che Exchange Online possa comunque connettersi ai server locali.</span><span class="sxs-lookup"><span data-stu-id="30418-154">In the event that the path to Microsoft via ExpressRoute is broken, you need to make sure that Exchange Online can still connect to your on-premises servers.</span></span> 

<span data-ttu-id="30418-155">La seconda soluzione consiste nel continuare ad annunciare entrambi i prefissi in entrambi i circuiti ExpressRoute e, inoltre, indicare qual è il prefisso vicino a un determinato ufficio.</span><span class="sxs-lookup"><span data-stu-id="30418-155">The second solution is that you continue to advertise both of the prefixes on both ExpressRoute circuits, and in addition you give us a hint of which prefix is close to which one of your offices.</span></span> <span data-ttu-id="30418-156">Poiché è supportata l'anteposizione di AS PATH in BGP, si può configurare AS PATH nel prefisso per determinare il routing.</span><span class="sxs-lookup"><span data-stu-id="30418-156">Because we support BGP AS Path prepending, you can configure the AS Path for your prefix to influence routing.</span></span> <span data-ttu-id="30418-157">In questo esempio si può estendere AS PATH per 172.2.0.0/31 negli Stati Uniti orientali, in modo che venga preferito il circuito ExpressRoute negli Stati Uniti occidentali per il traffico destinato a questo prefisso. La rete Microsoft considera infatti più breve il percorso per questo prefisso rispetto a quello negli Stati Uniti orientali.</span><span class="sxs-lookup"><span data-stu-id="30418-157">In this example, you can lengthen the AS PATH for 172.2.0.0/31 in US East so that we will prefer the ExpressRoute circuit in US West for traffic destined for this prefix (as our network will think the path to this prefix is shorter in the west).</span></span> <span data-ttu-id="30418-158">Allo stesso modo si può estendere AS PATH per 172.2.0.2/31 negli Stati Uniti occidentali, in modo che venga preferito il circuito ExpressRoute negli Stati Uniti orientali.</span><span class="sxs-lookup"><span data-stu-id="30418-158">Similarly you can lengthen the AS PATH for 172.2.0.2/31 in US West so that we'll prefer the ExpressRoute circuit in US East.</span></span> <span data-ttu-id="30418-159">Il routing è ottimizzato per entrambi gli uffici.</span><span class="sxs-lookup"><span data-stu-id="30418-159">Routing is optimized for both offices.</span></span> <span data-ttu-id="30418-160">Con questa progettazione, se un circuito ExpressRoute viene interrotto, Exchange Online può comunque raggiungere il cliente tramite un altro circuito ExpressRoute e la rete WAN.</span><span class="sxs-lookup"><span data-stu-id="30418-160">With this design, if one ExpressRoute circuit is broken, Exchange Online can still reach you via another ExpressRoute circuit and your WAN.</span></span> 

> [!IMPORTANT]
> <span data-ttu-id="30418-161">I numeri AS privati in AS PATH per i prefissi ricevuti su peering Microsoft vengono rimossi.</span><span class="sxs-lookup"><span data-stu-id="30418-161">We remove private AS numbers in the AS PATH for the prefixes received on Microsoft Peering.</span></span> <span data-ttu-id="30418-162">L'aggiunta di numeri AS pubblici in AS PATH è necessaria per determinare il routing per peering Microsoft.</span><span class="sxs-lookup"><span data-stu-id="30418-162">You need to append public AS numbers in the AS PATH to influence routing for Microsoft Peering.</span></span>
> 
> 

![Soluzione caso 2 ExpressRoute: anteporre AS PATH](./media/expressroute-optimize-routing/expressroute-case2-solution.png)

> [!NOTE]
> <span data-ttu-id="30418-164">Anche se gli esempi illustrati qui si riferiscono ai peer Microsoft e pubblici, le stesse funzionalità sono supportate per il peer privato.</span><span class="sxs-lookup"><span data-stu-id="30418-164">While the examples given here are for Microsoft and Public peerings, we do support the same capabilities for the Private peering.</span></span> <span data-ttu-id="30418-165">L'anteposizione di AS PATH funziona poi in un singolo circuito ExpressRoute, per determinare la selezione dei percorsi primari e secondari.</span><span class="sxs-lookup"><span data-stu-id="30418-165">Also, the AS Path prepending works within one single ExpressRoute circuit, to influence the selection of the primary and secondary paths.</span></span>
> 
> 

## <a name="suboptimal-routing-between-virtual-networks"></a><span data-ttu-id="30418-166">Routing non ottimale tra reti virtuali</span><span class="sxs-lookup"><span data-stu-id="30418-166">Suboptimal routing between virtual networks</span></span>
<span data-ttu-id="30418-167">Con ExpressRoute, è possibile abilitare la comunicazione da rete virtuale a rete virtuale collegando le reti virtuali a un circuito ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="30418-167">With ExpressRoute, you can enable Virtual Network to Virtual Network (which is also known as "VNet") communication by linking them to an ExpressRoute circuit.</span></span> <span data-ttu-id="30418-168">Se vengono collegate a più circuiti ExpressRoute, il routing tra le reti virtuali può risultare non ottimale.</span><span class="sxs-lookup"><span data-stu-id="30418-168">When you link them to multiple ExpressRoute circuits, suboptimal routing can happen between the VNets.</span></span> <span data-ttu-id="30418-169">Si consideri ad esempio</span><span class="sxs-lookup"><span data-stu-id="30418-169">Let's consider an example.</span></span> <span data-ttu-id="30418-170">di avere due circuiti ExpressRoute, uno negli Stati Uniti occidentali e uno negli Stati Uniti orientali.</span><span class="sxs-lookup"><span data-stu-id="30418-170">You have two ExpressRoute circuits, one in US West and one in US East.</span></span> <span data-ttu-id="30418-171">In ogni area sono presenti due reti virtuali,</span><span class="sxs-lookup"><span data-stu-id="30418-171">In each region, you have two VNets.</span></span> <span data-ttu-id="30418-172">in una sono distribuiti i server Web e nell'altra i server applicazioni.</span><span class="sxs-lookup"><span data-stu-id="30418-172">Your web servers are deployed in one VNet and application servers in the other.</span></span> <span data-ttu-id="30418-173">A scopo di ridondanza, si collegano le due reti virtuali di ogni area sia al circuito ExpressRoute locale che al circuito ExpressRoute remoto.</span><span class="sxs-lookup"><span data-stu-id="30418-173">For redundancy, you link the two VNets in each region to both the local ExpressRoute circuit and the remote ExpressRoute circuit.</span></span> <span data-ttu-id="30418-174">Come illustrato di seguito, da ogni rete virtuale esistono due percorsi all'altra rete virtuale.</span><span class="sxs-lookup"><span data-stu-id="30418-174">As can be seen below, from each VNet there are two paths to the other VNet.</span></span> <span data-ttu-id="30418-175">Le reti virtuali non rilevano quale circuito ExpressRoute è locale e quale è invece remoto.</span><span class="sxs-lookup"><span data-stu-id="30418-175">The VNets don't know which ExpressRoute circuit is local and which one is remote.</span></span> <span data-ttu-id="30418-176">Di conseguenza, eseguendo il routing ECMP (Equal-Cost-Multi-Path) per il bilanciamento del carico del traffico tra reti virtuali, alcuni flussi di traffico seguono il percorso più lungo e vengono instradati sul circuito ExpressRoute remoto.</span><span class="sxs-lookup"><span data-stu-id="30418-176">Consequently as they do Equal-Cost-Multi-Path (ECMP) routing to load-balance inter-VNet traffic, some traffic flows will take the longer path and get routed at the remote ExpressRoute circuit.</span></span>

![Caso 3 ExpressRoute: routing non ottimale tra reti virtuali](./media/expressroute-optimize-routing/expressroute-case3-problem.png)

### <a name="solution-assign-a-high-weight-to-local-connection"></a><span data-ttu-id="30418-178">Soluzione: assegnare un peso elevato alla connessione locale</span><span class="sxs-lookup"><span data-stu-id="30418-178">Solution: assign a high weight to local connection</span></span>
<span data-ttu-id="30418-179">La soluzione è semplice.</span><span class="sxs-lookup"><span data-stu-id="30418-179">The solution is simple.</span></span> <span data-ttu-id="30418-180">Dato che la posizione delle reti virtuali e dei circuiti è nota, è possibile indicare il percorso che dovrà essere preferito da ogni rete virtuale.</span><span class="sxs-lookup"><span data-stu-id="30418-180">Since you know where the VNets and the circuits are, you can tell us which path each VNet should prefer.</span></span> <span data-ttu-id="30418-181">Per questo esempio, in particolare, si assegna alla connessione locale un peso superiore rispetto alla connessione remota (vedere l'esempio di configurazione [qui](expressroute-howto-linkvnet-arm.md#modify-a-virtual-network-connection)).</span><span class="sxs-lookup"><span data-stu-id="30418-181">Specifically for this example, you assign a higher weight to the local connection than to the remote connection (see the configuration example [here](expressroute-howto-linkvnet-arm.md#modify-a-virtual-network-connection)).</span></span> <span data-ttu-id="30418-182">Quando una rete virtuale riceve un prefisso dell'altra rete virtuale su più connessioni, per l'invio del traffico destinato a tale prefisso preferisce la connessione con il peso più elevato.</span><span class="sxs-lookup"><span data-stu-id="30418-182">When a VNet receives the prefix of the other VNet on multiple connections it will prefer the connection with the highest weight to send traffic destined for that prefix.</span></span>

![Soluzione caso 3 ExpressRoute: assegnare un peso elevato alla connessione locale](./media/expressroute-optimize-routing/expressroute-case3-solution.png)

> [!NOTE]
> <span data-ttu-id="30418-184">Per determinare il routing dalla rete virtuale alla rete locale, se si hanno più circuiti ExpressRoute, è anche possibile configurare il peso di una connessione anziché anteporre AS PATH applicando la tecnica descritta nel secondo scenario riportato sopra.</span><span class="sxs-lookup"><span data-stu-id="30418-184">You can also influence routing from VNet to your on-premises network, if you have multiple ExpressRoute circuits, by configuring the weight of a connection instead of applying AS PATH prepending, a technique described in the second scenario above.</span></span> <span data-ttu-id="30418-185">Per ogni prefisso, per decidere come inviare il traffico verrà sempre esaminato il peso della connessione prima della lunghezza di AS PATH.</span><span class="sxs-lookup"><span data-stu-id="30418-185">For each prefix, we will always look at the connection weight before the AS Path length when deciding how to send traffic.</span></span>
>
>
