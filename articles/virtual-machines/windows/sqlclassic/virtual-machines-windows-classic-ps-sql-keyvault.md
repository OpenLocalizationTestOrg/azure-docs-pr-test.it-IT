---
title: Integrare il Key Vault con SQL Server in macchine virtuali Windows in Azure (classico) | Documentazione Microsoft
description: Informazioni su come automatizzare la configurazione della crittografia di SQL Server per l'uso con Azure Key Vault. Questo argomento illustra come usare l'integrazione di Azure Key Vault con le macchine virtuali di SQL Server nel modello di distribuzione classico.
services: virtual-machines-windows
documentationcenter: 
author: rothja
manager: jhubbard
editor: 
tags: azure-service-management
ms.assetid: ab8d41a7-1971-4032-ab71-eb435c455dc1
ms.service: virtual-machines-sql
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: vm-windows-sql-server
ms.workload: iaas-sql-server
ms.date: 02/17/2017
ms.author: jroth
ms.custom: H1Hack27Feb2017
ms.openlocfilehash: 2a9ac5763bb934bd0646e47c3936f7bdd0d603b1
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 07/11/2017
---
# <a name="configure-azure-key-vault-integration-for-sql-server-on-azure-virtual-machines-classic"></a><span data-ttu-id="0edcf-104">Configurare l'integrazione di Azure Key Vault per SQL Server in macchine virtuali di Azure (distribuzione classica)</span><span class="sxs-lookup"><span data-stu-id="0edcf-104">Configure Azure Key Vault Integration for SQL Server on Azure Virtual Machines (Classic)</span></span>
> [!div class="op_single_selector"]
> * [<span data-ttu-id="0edcf-105">Gestione risorse</span><span class="sxs-lookup"><span data-stu-id="0edcf-105">Resource Manager</span></span>](../sql/virtual-machines-windows-ps-sql-keyvault.md)
> * [<span data-ttu-id="0edcf-106">Classico</span><span class="sxs-lookup"><span data-stu-id="0edcf-106">Classic</span></span>](../classic/ps-sql-keyvault.md)
> 
> 

## <a name="overview"></a><span data-ttu-id="0edcf-107">Panoramica</span><span class="sxs-lookup"><span data-stu-id="0edcf-107">Overview</span></span>
<span data-ttu-id="0edcf-108">Esistono più funzionalità di crittografia di SQL Server, ad esempio [Transparent Data Encryption (TDE)](https://msdn.microsoft.com/library/bb934049.aspx), [crittografia a livello di colonna (CLE)](https://msdn.microsoft.com/library/ms173744.aspx) e [crittografia di backup](https://msdn.microsoft.com/library/dn449489.aspx).</span><span class="sxs-lookup"><span data-stu-id="0edcf-108">There are multiple SQL Server encryption features, such as [transparent data encryption (TDE)](https://msdn.microsoft.com/library/bb934049.aspx), [column level encryption (CLE)](https://msdn.microsoft.com/library/ms173744.aspx), and [backup encryption](https://msdn.microsoft.com/library/dn449489.aspx).</span></span> <span data-ttu-id="0edcf-109">Queste modalità di crittografia richiedono la gestione e l'archiviazione delle chiavi usate per la crittografia.</span><span class="sxs-lookup"><span data-stu-id="0edcf-109">These forms of encryption require you to manage and store the cryptographic keys you use for encryption.</span></span> <span data-ttu-id="0edcf-110">Il servizio dell'insieme di credenziali delle chiavi di Azure (AKV) è progettato per migliorare la sicurezza e la gestione di queste chiavi in una posizione sicura e a elevata disponibilità.</span><span class="sxs-lookup"><span data-stu-id="0edcf-110">The Azure Key Vault (AKV) service is designed to improve the security and management of these keys in a secure and highly available location.</span></span> <span data-ttu-id="0edcf-111">Il [connettore di SQL Server](http://www.microsoft.com/download/details.aspx?id=45344) consente a SQL Server di usare queste chiavi da Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="0edcf-111">The [SQL Server Connector](http://www.microsoft.com/download/details.aspx?id=45344) enables SQL Server to use these keys from Azure Key Vault.</span></span>

> [!IMPORTANT] 
> <span data-ttu-id="0edcf-112">Azure offre due diversi modelli di distribuzione per creare e usare le risorse: [Gestione risorse e la distribuzione classica](../../../azure-resource-manager/resource-manager-deployment-model.md).</span><span class="sxs-lookup"><span data-stu-id="0edcf-112">Azure has two different deployment models for creating and working with resources: [Resource Manager and Classic](../../../azure-resource-manager/resource-manager-deployment-model.md).</span></span> <span data-ttu-id="0edcf-113">Questo articolo illustra l'uso del modello di distribuzione classica.</span><span class="sxs-lookup"><span data-stu-id="0edcf-113">This article covers using the Classic deployment model.</span></span> <span data-ttu-id="0edcf-114">Microsoft consiglia di usare il modello di Gestione risorse per le distribuzioni più recenti.</span><span class="sxs-lookup"><span data-stu-id="0edcf-114">Microsoft recommends that most new deployments use the Resource Manager model.</span></span>

<span data-ttu-id="0edcf-115">Se si esegue SQL Server con computer locali, sono disponibili [passaggi per accedere a Azure Key Vault dal computer locale con SQL Server](https://msdn.microsoft.com/library/dn198405.aspx).</span><span class="sxs-lookup"><span data-stu-id="0edcf-115">If you are running SQL Server with on-premises machines, there are [steps you can follow to access Azure Key Vault from your on-premises SQL Server machine](https://msdn.microsoft.com/library/dn198405.aspx).</span></span> <span data-ttu-id="0edcf-116">Se si esegue SQL Server in macchine virtuali di Azure, è possibile risparmiare tempo usando la funzionalità di *Integrazione di Azure Key Vault* .</span><span class="sxs-lookup"><span data-stu-id="0edcf-116">But for SQL Server in Azure VMs, you can save time by using the *Azure Key Vault Integration* feature.</span></span> <span data-ttu-id="0edcf-117">Con alcuni cmdlet di Azure PowerShell che abilitano questa funzionalità, è possibile automatizzare la configurazione necessaria per l'accesso all'insieme di credenziali delle chiavi di una macchina virtuale di SQL.</span><span class="sxs-lookup"><span data-stu-id="0edcf-117">With a few Azure PowerShell cmdlets to enable this feature, you can automate the configuration necessary for a SQL VM to access your key vault.</span></span>

<span data-ttu-id="0edcf-118">Quando questa funzionalità è abilitata, installa automaticamente il connettore di SQL Server, configura il provider EKM per accedere ad Azure Key Vault e crea le credenziali per consentire l'accesso all'insieme di credenziali.</span><span class="sxs-lookup"><span data-stu-id="0edcf-118">When this feature is enabled, it automatically installs the SQL Server Connector, configures the EKM provider to access Azure Key Vault, and creates the credential to allow you to access your vault.</span></span> <span data-ttu-id="0edcf-119">Se sono stati esaminati i passaggi nella documentazione locale menzionati in precedenza, si noterà che questa funzionalità consente di automatizzare i passaggi 2 e 3.</span><span class="sxs-lookup"><span data-stu-id="0edcf-119">If you looked at the steps in the previously mentioned on-premises documentation, you can see that this feature automates steps 2 and 3.</span></span> <span data-ttu-id="0edcf-120">L'unica attività che è comunque necessario eseguire manualmente è la creazione delle chiavi e dell'insieme di credenziali delle chiavi.</span><span class="sxs-lookup"><span data-stu-id="0edcf-120">The only thing you would still need to do manually is to create the key vault and keys.</span></span> <span data-ttu-id="0edcf-121">Una volta completata questa operazione, l'intera installazione della macchina virtuale di SQL è automatizzata.</span><span class="sxs-lookup"><span data-stu-id="0edcf-121">From there, the entire setup of your SQL VM is automated.</span></span> <span data-ttu-id="0edcf-122">Quando la funzionalità ha completato l'installazione, è possibile eseguire istruzioni T-SQL per iniziare la crittografia dei database o del backup regolarmente.</span><span class="sxs-lookup"><span data-stu-id="0edcf-122">Once this feature has completed this setup, you can execute T-SQL statements to begin encrypting your databases or backups as you normally would.</span></span>

[!INCLUDE [AKV Integration Prepare](../../../../includes/virtual-machines-sql-server-akv-prepare.md)]

## <a name="configure-akv-integration"></a><span data-ttu-id="0edcf-123">Configurare l'integrazione di AKV</span><span class="sxs-lookup"><span data-stu-id="0edcf-123">Configure AKV Integration</span></span>
<span data-ttu-id="0edcf-124">Usare PowerShell per configurare l'integrazione di Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="0edcf-124">Use PowerShell to configure Azure Key Vault Integration.</span></span> <span data-ttu-id="0edcf-125">Le sezioni seguenti forniscono una panoramica dei parametri necessari e quindi uno script di PowerShell di esempio.</span><span class="sxs-lookup"><span data-stu-id="0edcf-125">The following sections provide an overview of the required parameters and then a sample PowerShell script.</span></span>

### <a name="install-the-sql-server-iaas-extension"></a><span data-ttu-id="0edcf-126">Installare l'estensione di SQL Server IaaS</span><span class="sxs-lookup"><span data-stu-id="0edcf-126">Install the SQL Server IaaS Extension</span></span>
<span data-ttu-id="0edcf-127">Come prima operazione, [installare l'estensione di SQL Server IaaS](../classic/sql-server-agent-extension.md).</span><span class="sxs-lookup"><span data-stu-id="0edcf-127">First, [install the SQL Server IaaS Extension](../classic/sql-server-agent-extension.md).</span></span>

### <a name="understand-the-input-parameters"></a><span data-ttu-id="0edcf-128">Comprendere i parametri di input</span><span class="sxs-lookup"><span data-stu-id="0edcf-128">Understand the input parameters</span></span>
<span data-ttu-id="0edcf-129">La tabella seguente elenca i parametri necessari per eseguire lo script di PowerShell nella sezione successiva.</span><span class="sxs-lookup"><span data-stu-id="0edcf-129">The following table lists the parameters required to run the PowerShell script in the next section.</span></span>

| <span data-ttu-id="0edcf-130">Parametro</span><span class="sxs-lookup"><span data-stu-id="0edcf-130">Parameter</span></span> | <span data-ttu-id="0edcf-131">Descrizione</span><span class="sxs-lookup"><span data-stu-id="0edcf-131">Description</span></span> | <span data-ttu-id="0edcf-132">Esempio</span><span class="sxs-lookup"><span data-stu-id="0edcf-132">Example</span></span> |
| --- | --- | --- |
| <span data-ttu-id="0edcf-133">**$akvURL**</span><span class="sxs-lookup"><span data-stu-id="0edcf-133">**$akvURL**</span></span> |<span data-ttu-id="0edcf-134">**URL dell'insieme di credenziali delle chiavi**</span><span class="sxs-lookup"><span data-stu-id="0edcf-134">**The key vault URL**</span></span> |<span data-ttu-id="0edcf-135">"https://contosokeyvault.vault.azure.net/"</span><span class="sxs-lookup"><span data-stu-id="0edcf-135">"https://contosokeyvault.vault.azure.net/"</span></span> |
| <span data-ttu-id="0edcf-136">**$spName**</span><span class="sxs-lookup"><span data-stu-id="0edcf-136">**$spName**</span></span> |<span data-ttu-id="0edcf-137">**Nome entità servizio**</span><span class="sxs-lookup"><span data-stu-id="0edcf-137">**Service Principal name**</span></span> |<span data-ttu-id="0edcf-138">"fde2b411-33d5-4e11-af04eb07b669ccf2"</span><span class="sxs-lookup"><span data-stu-id="0edcf-138">"fde2b411-33d5-4e11-af04eb07b669ccf2"</span></span> |
| <span data-ttu-id="0edcf-139">**$spSecret**</span><span class="sxs-lookup"><span data-stu-id="0edcf-139">**$spSecret**</span></span> |<span data-ttu-id="0edcf-140">**Segreto entità servizio**</span><span class="sxs-lookup"><span data-stu-id="0edcf-140">**Service Principal secret**</span></span> |<span data-ttu-id="0edcf-141">"9VTJSQwzlFepD8XODnzy8n2V01Jd8dAjwm/azF1XDKM="</span><span class="sxs-lookup"><span data-stu-id="0edcf-141">"9VTJSQwzlFepD8XODnzy8n2V01Jd8dAjwm/azF1XDKM="</span></span> |
| <span data-ttu-id="0edcf-142">**$credName**</span><span class="sxs-lookup"><span data-stu-id="0edcf-142">**$credName**</span></span> |<span data-ttu-id="0edcf-143">**Nome della credenziale**: l'integrazione di AKV crea una credenziale all'interno di SQL Server, consentendo alla macchina virtuale di avere accesso all'insieme di credenziali delle chiavi.</span><span class="sxs-lookup"><span data-stu-id="0edcf-143">**Credential name**: AKV Integration creates a credential within SQL Server, allowing the VM to have access to the key vault.</span></span> <span data-ttu-id="0edcf-144">Scegliere un nome per la credenziale.</span><span class="sxs-lookup"><span data-stu-id="0edcf-144">Choose a name for this credential.</span></span> |<span data-ttu-id="0edcf-145">"mycred1"</span><span class="sxs-lookup"><span data-stu-id="0edcf-145">"mycred1"</span></span> |
| <span data-ttu-id="0edcf-146">**$vmName**</span><span class="sxs-lookup"><span data-stu-id="0edcf-146">**$vmName**</span></span> |<span data-ttu-id="0edcf-147">**Nome macchina virtuale**: il nome di una macchina virtuale di SQL creato in precedenza.</span><span class="sxs-lookup"><span data-stu-id="0edcf-147">**Virtual machine name**: The name of a previously created SQL VM.</span></span> |<span data-ttu-id="0edcf-148">"myvmname"</span><span class="sxs-lookup"><span data-stu-id="0edcf-148">"myvmname"</span></span> |
| <span data-ttu-id="0edcf-149">**$serviceName**</span><span class="sxs-lookup"><span data-stu-id="0edcf-149">**$serviceName**</span></span> |<span data-ttu-id="0edcf-150">**Nome servizio**: il nome del servizio cloud associato alla macchina virtuale di SQL.</span><span class="sxs-lookup"><span data-stu-id="0edcf-150">**Service name**: The Cloud Service name that is associated with the SQL VM.</span></span> |<span data-ttu-id="0edcf-151">"mycloudservicename"</span><span class="sxs-lookup"><span data-stu-id="0edcf-151">"mycloudservicename"</span></span> |

### <a name="enable-akv-integration-with-powershell"></a><span data-ttu-id="0edcf-152">Abilitare l'integrazione di AKV con PowerShell</span><span class="sxs-lookup"><span data-stu-id="0edcf-152">Enable AKV Integration with PowerShell</span></span>
<span data-ttu-id="0edcf-153">Il cmdlet **New-AzureVMSqlServerKeyVaultCredentialConfig** crea un oggetto di configurazione per la funzionalità di integrazione di Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="0edcf-153">The **New-AzureVMSqlServerKeyVaultCredentialConfig** cmdlet creates a configuration object for the Azure Key Vault Integration feature.</span></span> <span data-ttu-id="0edcf-154">Il cmdlet **Set-AzureVMSqlServerExtension**configura l'integrazione con il parametro **KeyVaultCredentialSettings**.</span><span class="sxs-lookup"><span data-stu-id="0edcf-154">The **Set-AzureVMSqlServerExtension** configures this integration with the **KeyVaultCredentialSettings** parameter.</span></span> <span data-ttu-id="0edcf-155">I passaggi seguenti illustrano come usare questi comandi.</span><span class="sxs-lookup"><span data-stu-id="0edcf-155">The following steps show how to use these commands.</span></span>

1. <span data-ttu-id="0edcf-156">In Azure PowerShell configurare innanzitutto i parametri di input con i valori specifici, come descritto nelle sezioni precedenti di questo argomento.</span><span class="sxs-lookup"><span data-stu-id="0edcf-156">In Azure PowerShell, first configure the input parameters with your specific values as described in the previous sections of this topic.</span></span> <span data-ttu-id="0edcf-157">Di seguito è riportato uno script di esempio.</span><span class="sxs-lookup"><span data-stu-id="0edcf-157">The following script is an example.</span></span>
   
        $akvURL = "https://contosokeyvault.vault.azure.net/"
        $spName = "fde2b411-33d5-4e11-af04eb07b669ccf2"
        $spSecret = "9VTJSQwzlFepD8XODnzy8n2V01Jd8dAjwm/azF1XDKM="
        $credName = "mycred1"
        $vmName = "myvmname"
        $serviceName = "mycloudservicename"
2. <span data-ttu-id="0edcf-158">Usare quindi lo script seguente per configurare e abilitare l'integrazione di AKV.</span><span class="sxs-lookup"><span data-stu-id="0edcf-158">Then use the following script to configure and enable AKV Integration.</span></span>
   
        $secureakv =  $spSecret | ConvertTo-SecureString -AsPlainText -Force
        $akvs = New-AzureVMSqlServerKeyVaultCredentialConfig -Enable -CredentialName $credname -AzureKeyVaultUrl $akvURL -ServicePrincipalName $spName -ServicePrincipalSecret $secureakv
        Get-AzureVM -ServiceName $serviceName -Name $vmName | Set-AzureVMSqlServerExtension -KeyVaultCredentialSettings $akvs | Update-AzureVM

<span data-ttu-id="0edcf-159">L'estensione dell'agente IaaS di SQL aggiornerà la macchina virtuale di SQL con questa nuova configurazione.</span><span class="sxs-lookup"><span data-stu-id="0edcf-159">The SQL IaaS Agent Extension will update the SQL VM with this new configuration.</span></span>

[!INCLUDE [AKV Integration Next Steps](../../../../includes/virtual-machines-sql-server-akv-next-steps.md)]

