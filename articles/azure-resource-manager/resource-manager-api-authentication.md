---
title: aaaAzure Active Directory l'autenticazione e Gestione risorse | Documenti Microsoft
description: Tooauthentication manuale dello sviluppatore con hello API di gestione risorse di Azure e Azure Active Directory per l'integrazione di un'app con altre sottoscrizioni di Azure.
services: azure-resource-manager,active-directory
documentationcenter: na
author: dushyantgill
manager: timlt
editor: tysonn
ms.assetid: 17b2b40d-bf42-4c7d-9a88-9938409c5088
ms.service: azure-resource-manager
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: identity
ms.date: 12/27/2016
ms.author: dugill;tomfitz
ms.openlocfilehash: 757e45fdb28488b45de70647746461888bf35a56
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 10/06/2017
---
# <a name="use-resource-manager-authentication-api-tooaccess-subscriptions"></a><span data-ttu-id="159a6-103">Utilizzare le sottoscrizioni tooaccess autenticazione API di gestione risorse</span><span class="sxs-lookup"><span data-stu-id="159a6-103">Use Resource Manager authentication API tooaccess subscriptions</span></span>
## <a name="introduction"></a><span data-ttu-id="159a6-104">Introduzione</span><span class="sxs-lookup"><span data-stu-id="159a6-104">Introduction</span></span>
<span data-ttu-id="159a6-105">Se si è uno sviluppatore di software che deve toocreate un'app che gestisce le risorse di Azure del cliente, in questo argomento Mostra come tooauthenticate con hello le API di gestione risorse di Azure e ottenere l'accesso tooresources in altre sottoscrizioni.</span><span class="sxs-lookup"><span data-stu-id="159a6-105">If you are a software developer who needs toocreate an app that manages customer's Azure resources, this topic shows you how tooauthenticate with hello Azure Resource Manager APIs and gain access tooresources in other subscriptions.</span></span>

<span data-ttu-id="159a6-106">L'app possa accedere hello API di gestione risorse in due modi:</span><span class="sxs-lookup"><span data-stu-id="159a6-106">Your app can access hello Resource Manager APIs in couple of ways:</span></span>

1. <span data-ttu-id="159a6-107">**Accesso utente + app**: per le app che accedono alle risorse per conto di un utente connesso.</span><span class="sxs-lookup"><span data-stu-id="159a6-107">**User + app access**: for apps that access resources on behalf of a signed-in user.</span></span> <span data-ttu-id="159a6-108">Questo approccio funziona per le app, ad esempio le app Web e gli strumenti da riga di comando, che trattano solo la "gestione interattiva" delle risorse di Azure.</span><span class="sxs-lookup"><span data-stu-id="159a6-108">This approach works for apps, such as web apps and command-line tools, that deal with only "interactive management" of Azure resources.</span></span>
2. <span data-ttu-id="159a6-109">**Accesso solo app**: per le app che eseguono servizi daemon e processi pianificati.</span><span class="sxs-lookup"><span data-stu-id="159a6-109">**App-only access**: for apps that run daemon services and scheduled jobs.</span></span> <span data-ttu-id="159a6-110">identità dell'applicazione Hello viene concesso l'accesso diretto alle risorse di toohello.</span><span class="sxs-lookup"><span data-stu-id="159a6-110">hello app's identity is granted direct access toohello resources.</span></span> <span data-ttu-id="159a6-111">Questo approccio funziona per le app che servono a lungo termine tooAzure headless accesso (esecuzione automatica).</span><span class="sxs-lookup"><span data-stu-id="159a6-111">This approach works for apps that need long-term headless (unattended) access tooAzure.</span></span>

<span data-ttu-id="159a6-112">Questo argomento vengono fornite istruzioni dettagliate toocreate un'applicazione che utilizza entrambi i metodi di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="159a6-112">This topic provides step-by-step instructions toocreate an app that employs both these authorization methods.</span></span> <span data-ttu-id="159a6-113">Viene illustrato come tooperform ogni passaggio con l'API REST o c#.</span><span class="sxs-lookup"><span data-stu-id="159a6-113">It shows how tooperform each step with REST API or C#.</span></span> <span data-ttu-id="159a6-114">un'applicazione ASP.NET MVC Hello completezza è disponibile all'indirizzo [https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense](https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense).</span><span class="sxs-lookup"><span data-stu-id="159a6-114">hello complete ASP.NET MVC application is available at [https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense](https://github.com/dushyantgill/VipSwapper/tree/master/CloudSense).</span></span>

## <a name="what-hello-web-app-does"></a><span data-ttu-id="159a6-115">Le app web hello non</span><span class="sxs-lookup"><span data-stu-id="159a6-115">What hello web app does</span></span>
<span data-ttu-id="159a6-116">app web Hello:</span><span class="sxs-lookup"><span data-stu-id="159a6-116">hello web app:</span></span>

1. <span data-ttu-id="159a6-117">Esegue l'accesso per un utente di Azure.</span><span class="sxs-lookup"><span data-stu-id="159a6-117">Signs-in an Azure user.</span></span>
2. <span data-ttu-id="159a6-118">Chiede utente toogrant hello web app accesso tooResource Manager.</span><span class="sxs-lookup"><span data-stu-id="159a6-118">Asks user toogrant hello web app access tooResource Manager.</span></span>
3. <span data-ttu-id="159a6-119">Ottiene il token di accesso app + utente per l'accesso a Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="159a6-119">Gets user + app access token for accessing Resource Manager.</span></span>
4. <span data-ttu-id="159a6-120">Usa token (dal passaggio 3) toocall Gestione risorse e ruolo tooa principale di servizio dell'applicazione hello assegnare nella sottoscrizione hello, che fornisce una sottoscrizione di toohello di hello app a lungo termine accesso.</span><span class="sxs-lookup"><span data-stu-id="159a6-120">Uses token (from step 3) toocall Resource Manager and assign hello app's service principal tooa role in hello subscription, which gives hello app long-term access toohello subscription.</span></span>
5. <span data-ttu-id="159a6-121">Ottiene il token di accesso solo app.</span><span class="sxs-lookup"><span data-stu-id="159a6-121">Gets app-only access token.</span></span>
6. <span data-ttu-id="159a6-122">Usa token (dal passaggio 5) toomanage risorse nella sottoscrizione hello tramite Gestione risorse.</span><span class="sxs-lookup"><span data-stu-id="159a6-122">Uses token (from step 5) toomanage resources in hello subscription through Resource Manager.</span></span>

<span data-ttu-id="159a6-123">Ecco il flusso di hello end-to-end dell'applicazione web hello.</span><span class="sxs-lookup"><span data-stu-id="159a6-123">Here's hello end-to-end flow of hello web application.</span></span>

![Flusso di autenticazione di Resource Manager](./media/resource-manager-api-authentication/Auth-Swim-Lane.png)

<span data-ttu-id="159a6-125">Come un utente, fornire l'id di sottoscrizione hello per sottoscrizione hello desiderato toouse:</span><span class="sxs-lookup"><span data-stu-id="159a6-125">As a user, you provide hello subscription id for hello subscription you want toouse:</span></span>

![Fornire l'ID sottoscrizione](./media/resource-manager-api-authentication/sample-ux-1.png)

<span data-ttu-id="159a6-127">Selezionare hello toouse di account per l'accesso.</span><span class="sxs-lookup"><span data-stu-id="159a6-127">Select hello account toouse for logging in.</span></span>

![Selezionare un account](./media/resource-manager-api-authentication/sample-ux-2.png)

<span data-ttu-id="159a6-129">Fornire le credenziali.</span><span class="sxs-lookup"><span data-stu-id="159a6-129">Provide your credentials.</span></span>

![Fornire le credenziali](./media/resource-manager-api-authentication/sample-ux-3.png)

<span data-ttu-id="159a6-131">Concedere hello app accesso tooyour le sottoscrizioni di Azure:</span><span class="sxs-lookup"><span data-stu-id="159a6-131">Grant hello app access tooyour Azure subscriptions:</span></span>

![Concedere l'accesso](./media/resource-manager-api-authentication/sample-ux-4.png)

<span data-ttu-id="159a6-133">Gestire le sottoscrizioni connesse:</span><span class="sxs-lookup"><span data-stu-id="159a6-133">Manage your connected subscriptions:</span></span>

![Connettere la sottoscrizione](./media/resource-manager-api-authentication/sample-ux-7.png)

## <a name="register-application"></a><span data-ttu-id="159a6-135">Registrare l'applicazione</span><span class="sxs-lookup"><span data-stu-id="159a6-135">Register application</span></span>
<span data-ttu-id="159a6-136">Prima di iniziare a scrivere codice, registrare l'app Web in Azure Active Directory (AD).</span><span class="sxs-lookup"><span data-stu-id="159a6-136">Before you start coding, register your web app with Azure Active Directory (AD).</span></span> <span data-ttu-id="159a6-137">registrazione app Hello crea un'identità centrale per l'app in Azure AD.</span><span class="sxs-lookup"><span data-stu-id="159a6-137">hello app registration creates a central identity for your app in Azure AD.</span></span> <span data-ttu-id="159a6-138">Contiene informazioni di base sull'applicazione quali ID Client OAuth, gli URL di risposta e le credenziali che l'applicazione usa tooauthenticate e le API di gestione risorse di Azure di accesso.</span><span class="sxs-lookup"><span data-stu-id="159a6-138">It holds basic information about your application like OAuth Client ID, Reply URLs, and credentials that your application uses tooauthenticate and access Azure Resource Manager APIs.</span></span> <span data-ttu-id="159a6-139">registrazione app Hello registra inoltre hello vari delegate le autorizzazioni necessarie all'applicazione quando si accede a Microsoft APIs per conto di utente hello.</span><span class="sxs-lookup"><span data-stu-id="159a6-139">hello app registration also records hello various delegated permissions that your application needs when accessing Microsoft APIs on behalf of hello user.</span></span>

<span data-ttu-id="159a6-140">Poiché l'applicazione accede ad altre sottoscrizioni, è necessario configurarla come un'applicazione multi-tenant.</span><span class="sxs-lookup"><span data-stu-id="159a6-140">Because your app accesses other subscription, you must configure it as a multi-tenant application.</span></span> <span data-ttu-id="159a6-141">convalida toopass, fornire un dominio associato con Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="159a6-141">toopass validation, provide a domain associated with your Azure Active Directory.</span></span> <span data-ttu-id="159a6-142">domini di hello toosee associati di Azure Active Directory, accedi toohello [portale classico](https://manage.windowsazure.com).</span><span class="sxs-lookup"><span data-stu-id="159a6-142">toosee hello domains associated with your Azure Active Directory, log in toohello [classic portal](https://manage.windowsazure.com).</span></span> <span data-ttu-id="159a6-143">Selezionare l'istanza di Azure Active Directory e quindi selezionare **Domini**.</span><span class="sxs-lookup"><span data-stu-id="159a6-143">Select your Azure Active Directory and then select **Domains**.</span></span>

<span data-ttu-id="159a6-144">Hello di esempio seguente viene illustrato come tooregister hello app usando Azure PowerShell.</span><span class="sxs-lookup"><span data-stu-id="159a6-144">hello following example shows how tooregister hello app by using Azure PowerShell.</span></span> <span data-ttu-id="159a6-145">È necessario disporre di hello versione più recente (agosto 2016) di Azure PowerShell per toowork questo comando.</span><span class="sxs-lookup"><span data-stu-id="159a6-145">You must have hello latest version (August 2016) of Azure PowerShell for this command toowork.</span></span>

    $app = New-AzureRmADApplication -DisplayName "{app name}" -HomePage "https://{your domain}/{app name}" -IdentifierUris "https://{your domain}/{app name}" -Password "{your password}" -AvailableToOtherTenants $true

<span data-ttu-id="159a6-146">toolog in come hello applicazione Active Directory, è necessario che la password e l'id dell'applicazione hello.</span><span class="sxs-lookup"><span data-stu-id="159a6-146">toolog in as hello AD application, you need hello application id and password.</span></span> <span data-ttu-id="159a6-147">id applicazione hello toosee restituito dal comando precedente hello, utilizzare:</span><span class="sxs-lookup"><span data-stu-id="159a6-147">toosee hello application id that is returned from hello previous command, use:</span></span>

    $app.ApplicationId

<span data-ttu-id="159a6-148">Hello di esempio seguente viene illustrato come tooregister hello app usando l'interfaccia CLI di Azure.</span><span class="sxs-lookup"><span data-stu-id="159a6-148">hello following example shows how tooregister hello app by using Azure CLI.</span></span>

    azure ad app create --name {app name} --home-page https://{your domain}/{app name} --identifier-uris https://{your domain}/{app name} --password {your password} --available true

<span data-ttu-id="159a6-149">i risultati di Hello includono hello AppId, è necessario per l'autenticazione come applicazione hello.</span><span class="sxs-lookup"><span data-stu-id="159a6-149">hello results include hello AppId, which you need when authenticating as hello application.</span></span>

### <a name="optional-configuration---certificate-credential"></a><span data-ttu-id="159a6-150">Configurazione facoltativa: credenziali del certificato</span><span class="sxs-lookup"><span data-stu-id="159a6-150">Optional configuration - certificate credential</span></span>
<span data-ttu-id="159a6-151">Azure AD supporta anche le credenziali del certificato per le applicazioni: creare un certificato autofirmato, mantenere la chiave privata di hello e aggiungere una registrazione dell'applicazione hello tooyour chiave pubblica Azure AD.</span><span class="sxs-lookup"><span data-stu-id="159a6-151">Azure AD also supports certificate credentials for applications: you create a self-signed cert, keep hello private key, and add hello public key tooyour Azure AD application registration.</span></span> <span data-ttu-id="159a6-152">Per l'autenticazione, l'applicazione invia un tooAzure piccoli payload AD firmato con la chiave privata e Azure AD convalida firma hello con la chiave pubblica hello registrato.</span><span class="sxs-lookup"><span data-stu-id="159a6-152">For authentication, your application sends a small payload tooAzure AD signed using your private key, and Azure AD validates hello signature using hello public key that you registered.</span></span>

<span data-ttu-id="159a6-153">Per informazioni sulla creazione di un'app di Active Directory con un certificato, vedere [toocreate usare Azure PowerShell un'entità servizio tooaccess risorse](resource-group-authenticate-service-principal.md#create-service-principal-with-certificate-from-certificate-authority) o [toocreate CLI di Azure di utilizzare un'entità servizio tooaccess risorse](resource-group-authenticate-service-principal-cli.md#create-service-principal-with-certificate).</span><span class="sxs-lookup"><span data-stu-id="159a6-153">For information about creating an AD app with a certificate, see [Use Azure PowerShell toocreate a service principal tooaccess resources](resource-group-authenticate-service-principal.md#create-service-principal-with-certificate-from-certificate-authority) or [Use Azure CLI toocreate a service principal tooaccess resources](resource-group-authenticate-service-principal-cli.md#create-service-principal-with-certificate).</span></span>

## <a name="get-tenant-id-from-subscription-id"></a><span data-ttu-id="159a6-154">Ottenere l'ID tenant dall'ID sottoscrizione</span><span class="sxs-lookup"><span data-stu-id="159a6-154">Get tenant id from subscription id</span></span>
<span data-ttu-id="159a6-155">toorequest un token che può essere utilizzati toocall Gestione risorse, l'applicazione deve tooknow hello tenant ID del tenant di Azure AD hello che ospita hello sottoscrizione di Azure.</span><span class="sxs-lookup"><span data-stu-id="159a6-155">toorequest a token that can be used toocall Resource Manager, your application needs tooknow hello tenant ID of hello Azure AD tenant that hosts hello Azure subscription.</span></span> <span data-ttu-id="159a6-156">Molto probabilmente gli utenti conoscono i relativi ID sottoscrizione, ma potrebbero non conoscere gli ID tenant per Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="159a6-156">Most likely, your users know their subscription ids, but they might not know their tenant ids for Azure Active Directory.</span></span> <span data-ttu-id="159a6-157">tooget hello id tenant dell'utente, chiedere utente hello per l'id sottoscrizione hello. Quando si invia una richiesta di informazioni sulla sottoscrizione hello, fornire tale id sottoscrizione:</span><span class="sxs-lookup"><span data-stu-id="159a6-157">tooget hello user's tenant id, ask hello user for hello subscription id. Provide that subscription id when sending a request about hello subscription:</span></span>

    https://management.azure.com/subscriptions/{subscription-id}?api-version=2015-01-01

<span data-ttu-id="159a6-158">richiesta di Hello non riesce perché l'utente hello ha non ancora connessi, ma è possibile recuperare l'id tenant hello dalla risposta hello.</span><span class="sxs-lookup"><span data-stu-id="159a6-158">hello request fails because hello user has not logged in yet, but you can retrieve hello tenant id from hello response.</span></span> <span data-ttu-id="159a6-159">Tale eccezione, recuperare l'id tenant hello dal valore di intestazione di risposta hello per **WWW-Authenticate**.</span><span class="sxs-lookup"><span data-stu-id="159a6-159">In that exception, retrieve hello tenant id from hello response header value for **WWW-Authenticate**.</span></span> <span data-ttu-id="159a6-160">Vedrai questa implementazione di hello [GetDirectoryForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L20) metodo.</span><span class="sxs-lookup"><span data-stu-id="159a6-160">You see this implementation in hello [GetDirectoryForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L20) method.</span></span>

## <a name="get-user--app-access-token"></a><span data-ttu-id="159a6-161">Ottenere il token di accesso utente + app</span><span class="sxs-lookup"><span data-stu-id="159a6-161">Get user + app access token</span></span>
<span data-ttu-id="159a6-162">L'applicazione reindirizza hello utente tooAzure Active Directory con un OAuth 2.0 autorizzare richiedere - tooauthenticate hello credenziali dell'utente e ottenere un codice di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="159a6-162">Your application redirects hello user tooAzure AD with an OAuth 2.0 Authorize Request - tooauthenticate hello user's credentials and get back an authorization code.</span></span> <span data-ttu-id="159a6-163">L'applicazione utilizza tooget codice di autorizzazione hello un token di accesso per Gestione risorse.</span><span class="sxs-lookup"><span data-stu-id="159a6-163">Your application uses hello authorization code tooget an access token for Resource Manager.</span></span> <span data-ttu-id="159a6-164">Hello [ConnectSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/Controllers/HomeController.cs#L42) metodo crea una richiesta di autorizzazione hello.</span><span class="sxs-lookup"><span data-stu-id="159a6-164">hello [ConnectSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/Controllers/HomeController.cs#L42) method creates hello authorization request.</span></span>

<span data-ttu-id="159a6-165">Questo argomento viene illustrato l'utente di hello tooauthenticate di richieste di hello API REST.</span><span class="sxs-lookup"><span data-stu-id="159a6-165">This topic shows hello REST API requests tooauthenticate hello user.</span></span> <span data-ttu-id="159a6-166">Inoltre, è possibile utilizzare l'autenticazione di helper librerie tooperform nel codice.</span><span class="sxs-lookup"><span data-stu-id="159a6-166">You can also use helper libraries tooperform authentication in your code.</span></span> <span data-ttu-id="159a6-167">Per altre informazioni su queste librerie, vedere [Azure Active Directory Authentication Library](../active-directory/active-directory-authentication-libraries.md) (Libreria di autenticazione di Azure Active Directory).</span><span class="sxs-lookup"><span data-stu-id="159a6-167">For more information about these libraries, see [Azure Active Directory Authentication Libraries](../active-directory/active-directory-authentication-libraries.md).</span></span> <span data-ttu-id="159a6-168">Per informazioni aggiuntive su come integrare la gestione delle identità in un'applicazione, vedere [Guida per gli sviluppatori di Azure Active Directory](../active-directory/active-directory-developers-guide.md).</span><span class="sxs-lookup"><span data-stu-id="159a6-168">For guidance on integrating identity management in an application, see [Azure Active Directory developer's guide](../active-directory/active-directory-developers-guide.md).</span></span>

### <a name="auth-request-oauth-20"></a><span data-ttu-id="159a6-169">Richiesta di autorizzazione (OAuth 2.0)</span><span class="sxs-lookup"><span data-stu-id="159a6-169">Auth request (OAuth 2.0)</span></span>
<span data-ttu-id="159a6-170">Eseguire un endpoint di Authorize toohello Azure AD aprire Connect/OAuth 2.0 autorizzare richieste di ID:</span><span class="sxs-lookup"><span data-stu-id="159a6-170">Issue an Open ID Connect/OAuth2.0 Authorize Request toohello Azure AD Authorize endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize

<span data-ttu-id="159a6-171">parametri di stringa di query Hello sono disponibili per la richiesta sono descritti in hello [richiedere un codice di autorizzazione](../active-directory/develop/active-directory-protocols-oauth-code.md#request-an-authorization-code) argomento.</span><span class="sxs-lookup"><span data-stu-id="159a6-171">hello query string parameters that are available for this request are described in hello [request an authorization code](../active-directory/develop/active-directory-protocols-oauth-code.md#request-an-authorization-code) topic.</span></span>

<span data-ttu-id="159a6-172">Hello seguente esempio viene illustrato come toorequest autorizzazione OAuth 2.0:</span><span class="sxs-lookup"><span data-stu-id="159a6-172">hello following example shows how toorequest OAuth2.0 authorization:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize?client_id=a0448380-c346-4f9f-b897-c18733de9394&response_mode=query&response_type=code&redirect_uri=http%3a%2f%2fwww.vipswapper.com%2fcloudsense%2fAccount%2fSignIn&resource=https%3a%2f%2fgraph.windows.net%2f&domain_hint=live.com

<span data-ttu-id="159a6-173">Azure AD autentica l'utente hello e, se necessario, chiede hello utente toogrant autorizzazione toohello app.</span><span class="sxs-lookup"><span data-stu-id="159a6-173">Azure AD authenticates hello user, and, if necessary, asks hello user toogrant permission toohello app.</span></span> <span data-ttu-id="159a6-174">Restituisce toohello codice di autorizzazione hello URL di risposta dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="159a6-174">It returns hello authorization code toohello Reply URL of your application.</span></span> <span data-ttu-id="159a6-175">A seconda di hello richiesto response_mode, Azure AD entrambi invia nuovamente hello dati nella stringa di query o come dati post.</span><span class="sxs-lookup"><span data-stu-id="159a6-175">Depending on hello requested response_mode, Azure AD either sends back hello data in query string or as post data.</span></span>

    code=AAABAAAAiL****FDMZBUwZ8eCAA&session_state=2d16bbce-d5d1-443f-acdf-75f6b0ce8850

### <a name="auth-request-open-id-connect"></a><span data-ttu-id="159a6-176">Richiesta di autorizzazione (Open ID Connect)</span><span class="sxs-lookup"><span data-stu-id="159a6-176">Auth request (Open ID Connect)</span></span>
<span data-ttu-id="159a6-177">Anche se non si solo tooaccess Gestione risorse di Azure per conto di utente hello, consentono inoltre di hello utente toosign tooyour applicazione usando il proprio account Azure AD, emettere un Open ID autorizzare richiesta di connessione.</span><span class="sxs-lookup"><span data-stu-id="159a6-177">If you not only wish tooaccess Azure Resource Manager on behalf of hello user, but also allow hello user toosign in tooyour application using their Azure AD account, issue an Open ID Connect Authorize Request.</span></span> <span data-ttu-id="159a6-178">Con Connect Open ID, l'applicazione riceve un id_token da Azure AD che l'app è possibile utilizzare toosign utente hello.</span><span class="sxs-lookup"><span data-stu-id="159a6-178">With Open ID Connect, your application also receives an id_token from Azure AD that your app can use toosign in hello user.</span></span>

<span data-ttu-id="159a6-179">parametri di stringa di query Hello sono disponibili per la richiesta sono descritti in hello [richiesta di accesso hello trasmissione](../active-directory/develop/active-directory-protocols-openid-connect-code.md#send-the-sign-in-request) argomento.</span><span class="sxs-lookup"><span data-stu-id="159a6-179">hello query string parameters that are available for this request are described in hello [Send hello sign-in request](../active-directory/develop/active-directory-protocols-openid-connect-code.md#send-the-sign-in-request) topic.</span></span>

<span data-ttu-id="159a6-180">Una richiesta Open ID Connect di esempio è:</span><span class="sxs-lookup"><span data-stu-id="159a6-180">An example Open ID Connect request is:</span></span>

     https://login.microsoftonline.com/{tenant-id}/OAuth2/Authorize?client_id=a0448380-c346-4f9f-b897-c18733de9394&response_mode=form_post&response_type=code+id_token&redirect_uri=http%3a%2f%2fwww.vipswapper.com%2fcloudsense%2fAccount%2fSignIn&resource=https%3a%2f%2fgraph.windows.net%2f&scope=openid+profile&nonce=63567Dc4MDAw&domain_hint=live.com&state=M_12tMyKaM8

<span data-ttu-id="159a6-181">Azure AD autentica l'utente hello e, se necessario, chiede hello utente toogrant autorizzazione toohello app.</span><span class="sxs-lookup"><span data-stu-id="159a6-181">Azure AD authenticates hello user, and, if necessary, asks hello user toogrant permission toohello app.</span></span> <span data-ttu-id="159a6-182">Restituisce toohello codice di autorizzazione hello URL di risposta dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="159a6-182">It returns hello authorization code toohello Reply URL of your application.</span></span> <span data-ttu-id="159a6-183">A seconda di hello richiesto response_mode, Azure AD entrambi invia nuovamente hello dati nella stringa di query o come dati post.</span><span class="sxs-lookup"><span data-stu-id="159a6-183">Depending on hello requested response_mode, Azure AD either sends back hello data in query string or as post data.</span></span>

<span data-ttu-id="159a6-184">Una risposta Open ID Connect di esempio è:</span><span class="sxs-lookup"><span data-stu-id="159a6-184">An example Open ID Connect response is:</span></span>

    code=AAABAAAAiL*****I4rDWd7zXsH6WUjlkIEQxIAA&id_token=eyJ0eXAiOiJKV1Q*****T3GrzzSFxg&state=M_12tMyKaM8&session_state=2d16bbce-d5d1-443f-acdf-75f6b0ce8850

### <a name="token-request-oauth20-code-grant-flow"></a><span data-ttu-id="159a6-185">Richiesta di token (flusso di concessione del codice OAuth 2.0)</span><span class="sxs-lookup"><span data-stu-id="159a6-185">Token request (OAuth2.0 Code Grant Flow)</span></span>
<span data-ttu-id="159a6-186">Ora che l'applicazione ha ricevuto il codice di autorizzazione hello da Azure AD, è possibile token di accesso ora tooget hello per Gestione risorse di Azure.</span><span class="sxs-lookup"><span data-stu-id="159a6-186">Now that your application has received hello authorization code from Azure AD, it is time tooget hello access token for Azure Resource Manager.</span></span>  <span data-ttu-id="159a6-187">Registrare un endpoint Token di Azure AD toohello richiesta Token di OAuth 2.0 codice Grant:</span><span class="sxs-lookup"><span data-stu-id="159a6-187">Post an OAuth2.0 Code Grant Token Request toohello Azure AD Token endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Token

<span data-ttu-id="159a6-188">parametri di stringa di query Hello sono disponibili per la richiesta sono descritti in hello [utilizzare il codice di autorizzazione hello](../active-directory/develop/active-directory-protocols-oauth-code.md#use-the-authorization-code-to-request-an-access-token) argomento.</span><span class="sxs-lookup"><span data-stu-id="159a6-188">hello query string parameters that are available for this request are described in hello [use hello authorization code](../active-directory/develop/active-directory-protocols-oauth-code.md#use-the-authorization-code-to-request-an-access-token) topic.</span></span>

<span data-ttu-id="159a6-189">Hello di esempio seguente mostra una richiesta di token di concessione di codice con le credenziali di password:</span><span class="sxs-lookup"><span data-stu-id="159a6-189">hello following example shows a request for code grant token with password credential:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=authorization_code&code=AAABAAAAiL9Kn2Z*****L1nVMH3Z5ESiAA&redirect_uri=http%3A%2F%2Flocalhost%3A62080%2FAccount%2FSignIn&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_secret=olna84E8*****goScOg%3D

<span data-ttu-id="159a6-190">Quando si utilizzano le credenziali del certificato, è possibile creare un JSON Web Token (JWT) e accedere (RSA SHA256) utilizzando hello chiave privata della credenziale di certificato dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="159a6-190">When working with certificate credentials, create a JSON Web Token (JWT) and sign (RSA SHA256) using hello private key of your application's certificate credential.</span></span> <span data-ttu-id="159a6-191">Hello tipi di attestazione per il token hello vengono visualizzati [le attestazioni nei token JWT](../active-directory/develop/active-directory-protocols-oauth-code.md#jwt-token-claims).</span><span class="sxs-lookup"><span data-stu-id="159a6-191">hello claim types for hello token are shown in [JWT token claims](../active-directory/develop/active-directory-protocols-oauth-code.md#jwt-token-claims).</span></span> <span data-ttu-id="159a6-192">Per riferimento, vedere hello [codice Active Directory Authentication Library (.NET)](https://github.com/AzureAD/azure-activedirectory-library-for-dotnet/blob/dev/src/ADAL.PCL.Desktop/CryptographyHelper.cs) toosign i token JWT asserzione Client.</span><span class="sxs-lookup"><span data-stu-id="159a6-192">For reference, see hello [Active Directory Auth Library (.NET) code](https://github.com/AzureAD/azure-activedirectory-library-for-dotnet/blob/dev/src/ADAL.PCL.Desktop/CryptographyHelper.cs) toosign Client Assertion JWT tokens.</span></span>

<span data-ttu-id="159a6-193">Vedere hello [aprire ID connettersi spec](http://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication) per ulteriori informazioni sull'autenticazione client.</span><span class="sxs-lookup"><span data-stu-id="159a6-193">See hello [Open ID Connect spec](http://openid.net/specs/openid-connect-core-1_0.html#ClientAuthentication) for details on client authentication.</span></span>

<span data-ttu-id="159a6-194">Hello di esempio seguente mostra una richiesta di token di concessione di codice con le credenziali di certificato:</span><span class="sxs-lookup"><span data-stu-id="159a6-194">hello following example shows a request for code grant token with certificate credential:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=authorization_code&code=AAABAAAAiL9Kn2Z*****L1nVMH3Z5ESiAA&redirect_uri=http%3A%2F%2Flocalhost%3A62080%2FAccount%2FSignIn&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_assertion_type=urn%3Aietf%3Aparams%3Aoauth%3Aclient-assertion-type%3Ajwt-bearer&client_assertion=eyJhbG*****Y9cYo8nEjMyA

<span data-ttu-id="159a6-195">Risposta di esempio per il token di concessione del codice:</span><span class="sxs-lookup"><span data-stu-id="159a6-195">An example response for code grant token:</span></span>

    HTTP/1.1 200 OK

    {"token_type":"Bearer","expires_in":"3599","expires_on":"1432039858","not_before":"1432035958","resource":"https://management.core.windows.net/","access_token":"eyJ0eXAiOiJKV1Q****M7Cw6JWtfY2lGc5A","refresh_token":"AAABAAAAiL9Kn2Z****55j-sjnyYgAA","scope":"user_impersonation","id_token":"eyJ0eXAiOiJKV*****-drP1J3P-HnHi9Rr46kGZnukEBH4dsg"}

#### <a name="handle-code-grant-token-response"></a><span data-ttu-id="159a6-196">Gestire la risposta del token di concessione del codice</span><span class="sxs-lookup"><span data-stu-id="159a6-196">Handle code grant token response</span></span>
<span data-ttu-id="159a6-197">Una risposta corretta token contiene i token di accesso hello (utente + app) per Gestione risorse di Azure.</span><span class="sxs-lookup"><span data-stu-id="159a6-197">A successful token response contains hello (user + app) access token for Azure Resource Manager.</span></span> <span data-ttu-id="159a6-198">L'applicazione usa questo accesso token tooaccess Gestione risorse per conto di utente hello.</span><span class="sxs-lookup"><span data-stu-id="159a6-198">Your application uses this access token tooaccess Resource Manager on behalf of hello user.</span></span> <span data-ttu-id="159a6-199">durata Hello dei token di accesso rilasciato da Azure AD è un'ora.</span><span class="sxs-lookup"><span data-stu-id="159a6-199">hello lifetime of access tokens issued by Azure AD is one hour.</span></span> <span data-ttu-id="159a6-200">È improbabile che l'applicazione web necessita di token di accesso toorenew hello (utente + app).</span><span class="sxs-lookup"><span data-stu-id="159a6-200">It is unlikely that your web application needs toorenew hello (user + app) access token.</span></span> <span data-ttu-id="159a6-201">Se è richiesto il token di accesso di toorenew hello, usare i token di aggiornamento hello che l'applicazione riceve in risposta token hello.</span><span class="sxs-lookup"><span data-stu-id="159a6-201">If it needs toorenew hello access token, use hello refresh token that your application receives in hello token response.</span></span> <span data-ttu-id="159a6-202">Registrare un endpoint Token di Azure AD toohello richiedere Token OAuth 2.0:</span><span class="sxs-lookup"><span data-stu-id="159a6-202">Post an OAuth2.0 Token Request toohello Azure AD Token endpoint:</span></span>

    https://login.microsoftonline.com/{tenant-id}/OAuth2/Token

<span data-ttu-id="159a6-203">Hello toouse parametri con richiesta di aggiornamento hello sono descritti in [aggiornati i token di accesso hello](../active-directory/develop/active-directory-protocols-oauth-code.md#refreshing-the-access-tokens).</span><span class="sxs-lookup"><span data-stu-id="159a6-203">hello parameters toouse with hello refresh request are described in [refreshing hello access token](../active-directory/develop/active-directory-protocols-oauth-code.md#refreshing-the-access-tokens).</span></span>

<span data-ttu-id="159a6-204">Hello esempio seguente viene illustrato come token di aggiornamento toouse hello:</span><span class="sxs-lookup"><span data-stu-id="159a6-204">hello following example shows how toouse hello refresh token:</span></span>

    POST https://login.microsoftonline.com/7fe877e6-a150-4992-bbfe-f517e304dfa0/oauth2/token HTTP/1.1

    Content-Type: application/x-www-form-urlencoded
    Content-Length: 1012

    grant_type=refresh_token&refresh_token=AAABAAAAiL9Kn2Z****55j-sjnyYgAA&client_id=a0448380-c346-4f9f-b897-c18733de9394&client_secret=olna84E8*****goScOg%3D

<span data-ttu-id="159a6-205">Anche se i token di aggiornamento possono essere utilizzato tooget nuova i token di accesso per Gestione risorse di Azure, non sono adatti per l'accesso offline dall'applicazione.</span><span class="sxs-lookup"><span data-stu-id="159a6-205">Although refresh tokens can be used tooget new access tokens for Azure Resource Manager, they are not suitable for offline access by your application.</span></span> <span data-ttu-id="159a6-206">durata token di aggiornamento Hello è limitata e token di aggiornamento sono associati toohello utente.</span><span class="sxs-lookup"><span data-stu-id="159a6-206">hello refresh tokens lifetime is limited, and refresh tokens are bound toohello user.</span></span> <span data-ttu-id="159a6-207">Se l'utente hello lascia l'organizzazione hello, applicazione hello utilizzando il token di aggiornamento hello perde l'accesso.</span><span class="sxs-lookup"><span data-stu-id="159a6-207">If hello user leaves hello organization, hello application using hello refresh token loses access.</span></span> <span data-ttu-id="159a6-208">Questo approccio non è adatto per le applicazioni che vengono utilizzati dal team toomanage le risorse di Azure.</span><span class="sxs-lookup"><span data-stu-id="159a6-208">This approach isn't suitable for applications that are used by teams toomanage their Azure resources.</span></span>

## <a name="check-if-user-can-assign-access-toosubscription"></a><span data-ttu-id="159a6-209">Controllare se l'utente può assegnare toosubscription accesso</span><span class="sxs-lookup"><span data-stu-id="159a6-209">Check if user can assign access toosubscription</span></span>
<span data-ttu-id="159a6-210">A questo punto l'applicazione ha un token tooaccess Gestione risorse di Azure per conto di utente hello.</span><span class="sxs-lookup"><span data-stu-id="159a6-210">Your application now has a token tooaccess Azure Resource Manager on behalf of hello user.</span></span> <span data-ttu-id="159a6-211">passaggio successivo Hello è tooconnect sottoscrizione toohello app.</span><span class="sxs-lookup"><span data-stu-id="159a6-211">hello next step is tooconnect your app toohello subscription.</span></span> <span data-ttu-id="159a6-212">Dopo la connessione, l'app può gestire le sottoscrizioni anche quando l'utente hello non è presenti (accesso offline a lungo termine).</span><span class="sxs-lookup"><span data-stu-id="159a6-212">After connecting, your app can manage those subscriptions even when hello user isn't present (long-term offline access).</span></span>

<span data-ttu-id="159a6-213">Per ogni sottoscrizione tooconnect, chiamare hello [autorizzazioni relative agli elenchi di gestione risorse](https://docs.microsoft.com/rest/api/authorization/permissions) toodetermine API utente hello se dispone di diritti di gestione di accesso per la sottoscrizione di hello.</span><span class="sxs-lookup"><span data-stu-id="159a6-213">For each subscription tooconnect, call hello [Resource Manager list permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API toodetermine whether hello user has access management rights for hello subscription.</span></span>

<span data-ttu-id="159a6-214">Hello [UserCanManagerAccessForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L44) metodo hello app di esempio ASP.NET MVC implementa questa chiamata.</span><span class="sxs-lookup"><span data-stu-id="159a6-214">hello [UserCanManagerAccessForSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L44) method of hello ASP.NET MVC sample app implements this call.</span></span>

<span data-ttu-id="159a6-215">Hello seguente esempio viene illustrato come toorequest le autorizzazioni dell'utente per una sottoscrizione.</span><span class="sxs-lookup"><span data-stu-id="159a6-215">hello following example shows how toorequest a user's permissions on a subscription.</span></span> <span data-ttu-id="159a6-216">83cfe939-2402-4581-b761-4f59b0a041e4 è l'id di hello di hello sottoscrizione.</span><span class="sxs-lookup"><span data-stu-id="159a6-216">83cfe939-2402-4581-b761-4f59b0a041e4 is hello id of hello subscription.</span></span>

    GET https://management.azure.com/subscriptions/83cfe939-2402-4581-b761-4f59b0a041e4/providers/microsoft.authorization/permissions?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV1QiLC***lwO1mM7Cw6JWtfY2lGc5A

<span data-ttu-id="159a6-217">È un esempio di autorizzazioni dell'utente di hello risposta tooget nella sottoscrizione.</span><span class="sxs-lookup"><span data-stu-id="159a6-217">An example of hello response tooget user's permissions on subscription is:</span></span>

    HTTP/1.1 200 OK

    {"value":[{"actions":["*"],"notActions":["Microsoft.Authorization/*/Write","Microsoft.Authorization/*/Delete"]},{"actions":["*/read"],"notActions":[]}]}

<span data-ttu-id="159a6-218">le autorizzazioni di Hello API restituisce più autorizzazioni.</span><span class="sxs-lookup"><span data-stu-id="159a6-218">hello permissions API returns multiple permissions.</span></span> <span data-ttu-id="159a6-219">Ogni autorizzazione è costituita dalle azioni consentite (actions) e dalle azioni non consentite (notactions).</span><span class="sxs-lookup"><span data-stu-id="159a6-219">Each permission consists of allowed actions (actions) and disallowed actions (notactions).</span></span> <span data-ttu-id="159a6-220">Se è presente nell'elenco di azioni di un'autorizzazione consentito hello un'azione e non è presente nell'elenco notactions hello di tale autorizzazione, hello utente è consentito tooperform tale azione.</span><span class="sxs-lookup"><span data-stu-id="159a6-220">If an action is present in hello allowed actions list of any permission and not present in hello notactions list of that permission, hello user is allowed tooperform that action.</span></span> <span data-ttu-id="159a6-221">**Microsoft.Authorization/roleassignments/Write** azione hello che rights management che concede l'accesso.</span><span class="sxs-lookup"><span data-stu-id="159a6-221">**microsoft.authorization/roleassignments/write** is hello action that that grants access management rights.</span></span> <span data-ttu-id="159a6-222">L'applicazione è necessario analizzare hello autorizzazioni risultato toolook per trovare una corrispondenza di espressione regolare in questa stringa di azione in azioni di hello e notactions di ciascuna autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="159a6-222">Your application must parse hello permissions result toolook for a regex match on this action string in hello actions and notactions of each permission.</span></span>

## <a name="get-app-only-access-token"></a><span data-ttu-id="159a6-223">Ottenere il token di accesso solo app</span><span class="sxs-lookup"><span data-stu-id="159a6-223">Get app-only access token</span></span>
<span data-ttu-id="159a6-224">A questo punto, si conosce se hello utente può assegnare a toohello accesso sottoscrizione di Azure.</span><span class="sxs-lookup"><span data-stu-id="159a6-224">Now, you know if hello user can assign access toohello Azure subscription.</span></span> <span data-ttu-id="159a6-225">passaggi successivi Hello sono:</span><span class="sxs-lookup"><span data-stu-id="159a6-225">hello next steps are:</span></span>

1. <span data-ttu-id="159a6-226">Assegnare hello appropriato RBAC ruolo tooyour identità dell'applicazione per la sottoscrizione hello.</span><span class="sxs-lookup"><span data-stu-id="159a6-226">Assign hello appropriate RBAC role tooyour application's identity on hello subscription.</span></span>
2. <span data-ttu-id="159a6-227">Convalidare l'assegnazione di accesso di hello eseguendo una query per l'autorizzazione dell'applicazione hello sottoscrizione hello o l'accesso alla gestione di risorse utilizzando il token solo per app.</span><span class="sxs-lookup"><span data-stu-id="159a6-227">Validate hello access assignment by querying for hello Application's permission on hello subscription or by accessing Resource Manager using app-only token.</span></span>
3. <span data-ttu-id="159a6-228">Connessione hello record nella struttura di dati applicazioni "sottoscrizioni connessi" - id hello della sottoscrizione di hello di persistenza.</span><span class="sxs-lookup"><span data-stu-id="159a6-228">Record hello connection in your applications "connected subscriptions" data structure - persisting hello id of hello subscription.</span></span>

<span data-ttu-id="159a6-229">Verrà ora esaminato il primo passaggio hello più da vicino.</span><span class="sxs-lookup"><span data-stu-id="159a6-229">Let's look closer at hello first step.</span></span> <span data-ttu-id="159a6-230">tooassign hello appropriato RBAC ruolo toohello identità dell'applicazione, è necessario determinare:</span><span class="sxs-lookup"><span data-stu-id="159a6-230">tooassign hello appropriate RBAC role toohello application's identity, you must determine:</span></span>

* <span data-ttu-id="159a6-231">id di oggetto Hello dell'identità dell'applicazione Azure Active Directory dell'utente hello</span><span class="sxs-lookup"><span data-stu-id="159a6-231">hello object id of your application's identity in hello user's Azure Active Directory</span></span>
* <span data-ttu-id="159a6-232">Identificatore del ruolo RBAC hello che l'applicazione richiede sottoscrizione hello Hello</span><span class="sxs-lookup"><span data-stu-id="159a6-232">hello identifier of hello RBAC role that your application requires on hello subscription</span></span>

<span data-ttu-id="159a6-233">Quando l'applicazione autentica un utente da un'istanza di Azure AD, crea un oggetto entità servizio per l'applicazione in tale istanza di Azure AD.</span><span class="sxs-lookup"><span data-stu-id="159a6-233">When your application authenticates a user from an Azure AD, it creates a service principal object for your application in that Azure AD.</span></span> <span data-ttu-id="159a6-234">Azure consente RBAC ruoli toobe assegnato entità tooservice applicazioni di toocorresponding toogrant accesso diretto alle risorse di Azure.</span><span class="sxs-lookup"><span data-stu-id="159a6-234">Azure allows RBAC roles toobe assigned tooservice principals toogrant direct access toocorresponding applications on Azure resources.</span></span> <span data-ttu-id="159a6-235">Questa azione è esattamente ciò che si desidera toodo.</span><span class="sxs-lookup"><span data-stu-id="159a6-235">This action is exactly what we wish toodo.</span></span> <span data-ttu-id="159a6-236">Query hello Azure AD Graph API toodetermine hello identificatore dell'entità servizio hello dell'applicazione dell'utente connesso di hello's Azure AD.</span><span class="sxs-lookup"><span data-stu-id="159a6-236">Query hello Azure AD Graph API toodetermine hello identifier of hello service principal of your application in hello signed-in user's Azure AD.</span></span>

<span data-ttu-id="159a6-237">È necessario un token di accesso per Gestione risorse di Azure, è necessario un nuovo hello di toocall token di accesso API Azure AD Graph.</span><span class="sxs-lookup"><span data-stu-id="159a6-237">You only have an access token for Azure Resource Manager - you need a new access token toocall hello Azure AD Graph API.</span></span> <span data-ttu-id="159a6-238">Ogni applicazione in Azure AD ha autorizzazione tooquery il proprio oggetto entità servizio, pertanto è sufficiente un token di accesso solo app.</span><span class="sxs-lookup"><span data-stu-id="159a6-238">Every application in Azure AD has permission tooquery its own service principal object, so an app-only access token is sufficient.</span></span>

<a id="app-azure-ad-graph" />

### <a name="get-app-only-access-token-for-azure-ad-graph-api"></a><span data-ttu-id="159a6-239">Ottenere il token di accesso solo app per l'API Graph di Azure AD</span><span class="sxs-lookup"><span data-stu-id="159a6-239">Get app-only access token for Azure AD Graph API</span></span>
<span data-ttu-id="159a6-240">tooauthenticate l'app e ottenere un token tooAzure AD Graph API, emettere un endpoint token OAuth 2.0 concessione di credenziali Client del flusso richiesta di token tooAzure AD (**https://login.microsoftonline.com/ {directory_domain_name} / OAuth2/Token**).</span><span class="sxs-lookup"><span data-stu-id="159a6-240">tooauthenticate your app and get a token tooAzure AD Graph API, issue a Client Credential Grant OAuth2.0 flow token request tooAzure AD token endpoint (**https://login.microsoftonline.com/{directory_domain_name}/OAuth2/Token**).</span></span>

<span data-ttu-id="159a6-241">Hello [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs) metodo dell'applicazione di esempio ASP.net MVC Ottiene un accesso solo app token per l'utilizzo di API Graph hello hello Active Directory Authentication Library per .NET.</span><span class="sxs-lookup"><span data-stu-id="159a6-241">hello [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs) method of hello ASP.net MVC sample application gets an app-only access token for Graph API using hello Active Directory Authentication Library for .NET.</span></span>

<span data-ttu-id="159a6-242">parametri di stringa di query Hello sono disponibili per la richiesta sono descritti in hello [richiedere un Token di accesso](../active-directory/develop/active-directory-protocols-oauth-service-to-service.md#request-an-access-token) argomento.</span><span class="sxs-lookup"><span data-stu-id="159a6-242">hello query string parameters that are available for this request are described in hello [Request an Access Token](../active-directory/develop/active-directory-protocols-oauth-service-to-service.md#request-an-access-token) topic.</span></span>

<span data-ttu-id="159a6-243">Richiesta di esempio del token di concessione delle credenziali client:</span><span class="sxs-lookup"><span data-stu-id="159a6-243">An example request for client credential grant token:</span></span>

    POST https://login.microsoftonline.com/62e173e9-301e-423e-bcd4-29121ec1aa24/oauth2/token HTTP/1.1
    Content-Type: application/x-www-form-urlencoded
    Content-Length: 187</pre>
    <pre>grant_type=client_credentials&client_id=a0448380-c346-4f9f-b897-c18733de9394&resource=https%3A%2F%2Fgraph.windows.net%2F &client_secret=olna8C*****Og%3D

<span data-ttu-id="159a6-244">Risposta di esempio del token di concessione delle credenziali client:</span><span class="sxs-lookup"><span data-stu-id="159a6-244">An example response for client credential grant token:</span></span>

    HTTP/1.1 200 OK

    {"token_type":"Bearer","expires_in":"3599","expires_on":"1432039862","not_before":"1432035962","resource":"https://graph.windows.net/","access_token":"eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsIng1dCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSIsImtpZCI6Ik1uQ19WWmNBVGZNNXBPWWlKSE1iYTlnb0VLWSJ9.eyJhdWQiOiJodHRwczovL2dyYXBoLndpbmRv****G5gUTV-kKorR-pg"}

### <a name="get-objectid-of-application-service-principal-in-user-azure-ad"></a><span data-ttu-id="159a6-245">Ottenere l'ObjectId dell'entità servizio dell'applicazione nella directory Azure AD dell'utente</span><span class="sxs-lookup"><span data-stu-id="159a6-245">Get ObjectId of application service principal in user Azure AD</span></span>
<span data-ttu-id="159a6-246">A questo punto, usare hello tooquery token di accesso solo per app hello [le entità servizio di Azure AD Graph](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity) hello toodetermine API Id oggetto dell'entità servizio dell'applicazione hello nella directory hello.</span><span class="sxs-lookup"><span data-stu-id="159a6-246">Now, use hello app-only access token tooquery hello [Azure AD Graph Service Principals](https://msdn.microsoft.com/Library/Azure/Ad/Graph/api/entity-and-complex-type-reference#serviceprincipal-entity) API toodetermine hello Object Id of hello application's service principal in hello directory.</span></span>

<span data-ttu-id="159a6-247">Hello [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs#) metodo hello applicazione di esempio ASP.net MVC implementa questa chiamata.</span><span class="sxs-lookup"><span data-stu-id="159a6-247">hello [GetObjectIdOfServicePrincipalInOrganization](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureADGraphAPIUtil.cs#) method of hello ASP.net MVC sample application implements this call.</span></span>

<span data-ttu-id="159a6-248">Hello seguente esempio viene illustrato come toorequest principale di un'applicazione del servizio.</span><span class="sxs-lookup"><span data-stu-id="159a6-248">hello following example shows how toorequest an application's service principal.</span></span> <span data-ttu-id="159a6-249">a0448380-c346-4f9f-b897-c18733de9394 è l'id client hello di un'applicazione hello.</span><span class="sxs-lookup"><span data-stu-id="159a6-249">a0448380-c346-4f9f-b897-c18733de9394 is hello client id of hello application.</span></span>

    GET https://graph.windows.net/62e173e9-301e-423e-bcd4-29121ec1aa24/servicePrincipals?api-version=1.5&$filter=appId%20eq%20'a0448380-c346-4f9f-b897-c18733de9394' HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJK*****-kKorR-pg

<span data-ttu-id="159a6-250">Hello esempio seguente viene illustrata una risposta toohello richiesta per il servizio di un'applicazione principale</span><span class="sxs-lookup"><span data-stu-id="159a6-250">hello following example shows a response toohello request for an application's service principal</span></span>

    HTTP/1.1 200 OK

    {"odata.metadata":"https://graph.windows.net/62e173e9-301e-423e-bcd4-29121ec1aa24/$metadata#directoryObjects/Microsoft.DirectoryServices.ServicePrincipal","value":[{"odata.type":"Microsoft.DirectoryServices.ServicePrincipal","objectType":"ServicePrincipal","objectId":"9b5018d4-6951-42ed-8a92-f11ec283ccec","deletionTimestamp":null,"accountEnabled":true,"appDisplayName":"CloudSense","appId":"a0448380-c346-4f9f-b897-c18733de9394","appOwnerTenantId":"62e173e9-301e-423e-bcd4-29121ec1aa24","appRoleAssignmentRequired":false,"appRoles":[],"displayName":"CloudSense","errorUrl":null,"homepage":"http://www.vipswapper.com/cloudsense","keyCredentials":[],"logoutUrl":null,"oauth2Permissions":[{"adminConsentDescription":"Allow hello application tooaccess CloudSense on behalf of hello signed-in user.","adminConsentDisplayName":"Access CloudSense","id":"b7b7338e-683a-4796-b95e-60c10380de1c","isEnabled":true,"type":"User","userConsentDescription":"Allow hello application tooaccess CloudSense on your behalf.","userConsentDisplayName":"Access CloudSense","value":"user_impersonation"}],"passwordCredentials":[],"preferredTokenSigningKeyThumbprint":null,"publisherName":"vipswapper"quot;,"replyUrls":["http://www.vipswapper.com/cloudsense","http://www.vipswapper.com","http://vipswapper.com","http://vipswapper.azurewebsites.net","http://localhost:62080"],"samlMetadataUrl":null,"servicePrincipalNames":["http://www.vipswapper.com/cloudsense","a0448380-c346-4f9f-b897-c18733de9394"],"tags":["WindowsAzureActiveDirectoryIntegratedApp"]}]}

### <a name="get-azure-rbac-role-identifier"></a><span data-ttu-id="159a6-251">Ottenere l'identificatore del ruolo Controllo degli accessi in base al ruolo di Azure</span><span class="sxs-lookup"><span data-stu-id="159a6-251">Get Azure RBAC role identifier</span></span>
<span data-ttu-id="159a6-252">tooassign hello appropriato RBAC ruolo tooyour entità servizio, è necessario determinare l'identificatore hello del ruolo di Azure RBAC hello.</span><span class="sxs-lookup"><span data-stu-id="159a6-252">tooassign hello appropriate RBAC role tooyour service principal, you must determine hello identifier of hello Azure RBAC role.</span></span>

<span data-ttu-id="159a6-253">Hello RBAC ruolo più appropriato per l'applicazione:</span><span class="sxs-lookup"><span data-stu-id="159a6-253">hello right RBAC role for your application:</span></span>

* <span data-ttu-id="159a6-254">Se l'applicazione esegue solo il monitoraggio sottoscrizione hello, senza apportare alcuna modifica, richiede solo le autorizzazioni di lettura sottoscrizione hello.</span><span class="sxs-lookup"><span data-stu-id="159a6-254">If your application only monitors hello subscription, without making any changes, it requires only reader permissions on hello subscription.</span></span> <span data-ttu-id="159a6-255">Assegnare hello **lettore** ruolo.</span><span class="sxs-lookup"><span data-stu-id="159a6-255">Assign hello **Reader** role.</span></span>
* <span data-ttu-id="159a6-256">Se l'applicazione gestisce la sottoscrizione di Azure hello, creazione/modifica/eliminazione di entità, viene richiesta una delle autorizzazioni di collaboratore hello.</span><span class="sxs-lookup"><span data-stu-id="159a6-256">If your application manages Azure hello subscription, creating/modifying/deleting entities, it requires one of hello contributor permissions.</span></span>
  * <span data-ttu-id="159a6-257">toomanage un particolare tipo di risorsa, assegnare ruoli di collaboratore specifici delle risorse hello (collaboratore alla macchina virtuale, collaboratore di rete virtuale, collaboratore di Account di archiviazione e così via)</span><span class="sxs-lookup"><span data-stu-id="159a6-257">toomanage a particular type of resource, assign hello resource-specific contributor roles (Virtual Machine Contributor, Virtual Network Contributor, Storage Account Contributor, etc.)</span></span>
  * <span data-ttu-id="159a6-258">toomanage qualsiasi tipo di risorsa, assegnare hello **collaboratore** ruolo.</span><span class="sxs-lookup"><span data-stu-id="159a6-258">toomanage any resource type, assign hello **Contributor** role.</span></span>

<span data-ttu-id="159a6-259">assegnazione di ruolo Hello per l'applicazione è visibile toousers, quindi selezionare hello con privilegi minimi richiesti.</span><span class="sxs-lookup"><span data-stu-id="159a6-259">hello role assignment for your application is visible toousers, so select hello least-required privilege.</span></span>

<span data-ttu-id="159a6-260">Chiamare hello [definizione del ruolo Gestione risorse API](https://docs.microsoft.com/rest/api/authorization/roledefinitions) toolist tutti i ruoli di Azure RBAC e ricerca quindi scorrere hello toofind di hello risultato desiderato di definizione del ruolo in base al nome.</span><span class="sxs-lookup"><span data-stu-id="159a6-260">Call hello [Resource Manager role definition API](https://docs.microsoft.com/rest/api/authorization/roledefinitions) toolist all Azure RBAC roles and search then iterate over hello result toofind hello desired role definition by name.</span></span>

<span data-ttu-id="159a6-261">Hello [GetRoleId](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L246) metodo hello app di esempio ASP.net MVC implementa questa chiamata.</span><span class="sxs-lookup"><span data-stu-id="159a6-261">hello [GetRoleId](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L246) method of hello ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="159a6-262">esempio Hello richiesta di esempio viene illustrato come identificatore del ruolo Azure RBAC tooget.</span><span class="sxs-lookup"><span data-stu-id="159a6-262">hello following request example shows how tooget Azure RBAC role identifier.</span></span> <span data-ttu-id="159a6-263">09cbd307-aa71-4aca-b346-5f253e6e3ebb è l'id di hello di hello sottoscrizione.</span><span class="sxs-lookup"><span data-stu-id="159a6-263">09cbd307-aa71-4aca-b346-5f253e6e3ebb is hello id of hello subscription.</span></span>

    GET https://management.azure.com/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV*****fY2lGc5

<span data-ttu-id="159a6-264">risposta Hello è nel seguente formato hello:</span><span class="sxs-lookup"><span data-stu-id="159a6-264">hello response is in hello following format:</span></span>

    HTTP/1.1 200 OK

    {"value":[{"properties":{"roleName":"API Management Service Contributor","type":"BuiltInRole","description":"Lets you manage API Management services, but not access toothem.","scope":"/","permissions":[{"actions":["Microsoft.ApiManagement/Services/*","Microsoft.Authorization/*/read","Microsoft.Resources/subscriptions/resources/read","Microsoft.Resources/subscriptions/resourceGroups/read","Microsoft.Resources/subscriptions/resourceGroups/resources/read","Microsoft.Resources/subscriptions/resourceGroups/deployments/*","Microsoft.Insights/alertRules/*","Microsoft.Support/*"],"notActions":[]}]},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/312a565d-c81f-4fd8-895a-4e21e48d571c","type":"Microsoft.Authorization/roleDefinitions","name":"312a565d-c81f-4fd8-895a-4e21e48d571c"},{"properties":{"roleName":"Application Insights Component Contributor","type":"BuiltInRole","description":"Lets you manage Application Insights components, but not access toothem.","scope":"/","permissions":[{"actions":["Microsoft.Insights/components/*","Microsoft.Insights/webtests/*","Microsoft.Authorization/*/read","Microsoft.Resources/subscriptions/resources/read","Microsoft.Resources/subscriptions/resourceGroups/read","Microsoft.Resources/subscriptions/resourceGroups/resources/read","Microsoft.Resources/subscriptions/resourceGroups/deployments/*","Microsoft.Insights/alertRules/*","Microsoft.Support/*"],"notActions":[]}]},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/ae349356-3a1b-4a5e-921d-050484c6347e","type":"Microsoft.Authorization/roleDefinitions","name":"ae349356-3a1b-4a5e-921d-050484c6347e"}]}

<span data-ttu-id="159a6-265">Non è necessario toocall questa API in maniera continuativa.</span><span class="sxs-lookup"><span data-stu-id="159a6-265">You do not need toocall this API on an ongoing basis.</span></span> <span data-ttu-id="159a6-266">Dopo aver stabilito hello GUID conosciuto hello definizione del ruolo, è possibile creare id di definizione di ruolo hello come:</span><span class="sxs-lookup"><span data-stu-id="159a6-266">Once you've determined hello well-known GUID of hello role definition, you can construct hello role definition id as:</span></span>

    /subscriptions/{subscription_id}/providers/Microsoft.Authorization/roleDefinitions/{well-known-role-guid}

<span data-ttu-id="159a6-267">Di seguito sono hello GUID noto dei ruoli predefiniti comunemente utilizzati:</span><span class="sxs-lookup"><span data-stu-id="159a6-267">Here are hello well-known guids of commonly used built-in roles:</span></span>

| <span data-ttu-id="159a6-268">Ruolo</span><span class="sxs-lookup"><span data-stu-id="159a6-268">Role</span></span> | <span data-ttu-id="159a6-269">Guid</span><span class="sxs-lookup"><span data-stu-id="159a6-269">Guid</span></span> |
| --- | --- |
| <span data-ttu-id="159a6-270">Lettore</span><span class="sxs-lookup"><span data-stu-id="159a6-270">Reader</span></span> |<span data-ttu-id="159a6-271">acdd72a7-3385-48ef-bd42-f606fba81ae7</span><span class="sxs-lookup"><span data-stu-id="159a6-271">acdd72a7-3385-48ef-bd42-f606fba81ae7</span></span> |
| <span data-ttu-id="159a6-272">Collaboratore</span><span class="sxs-lookup"><span data-stu-id="159a6-272">Contributor</span></span> |<span data-ttu-id="159a6-273">b24988ac-6180-42a0-ab88-20f7382dd24c</span><span class="sxs-lookup"><span data-stu-id="159a6-273">b24988ac-6180-42a0-ab88-20f7382dd24c</span></span> |
| <span data-ttu-id="159a6-274">Collaboratore macchine virtuali</span><span class="sxs-lookup"><span data-stu-id="159a6-274">Virtual Machine Contributor</span></span> |<span data-ttu-id="159a6-275">d73bb868-a0df-4d4d-bd69-98a00b01fccb</span><span class="sxs-lookup"><span data-stu-id="159a6-275">d73bb868-a0df-4d4d-bd69-98a00b01fccb</span></span> |
| <span data-ttu-id="159a6-276">Collaboratore reti virtuali</span><span class="sxs-lookup"><span data-stu-id="159a6-276">Virtual Network Contributor</span></span> |<span data-ttu-id="159a6-277">b34d265f-36f7-4a0d-a4d4-e158ca92e90f</span><span class="sxs-lookup"><span data-stu-id="159a6-277">b34d265f-36f7-4a0d-a4d4-e158ca92e90f</span></span> |
| <span data-ttu-id="159a6-278">Collaboratore account di archiviazione</span><span class="sxs-lookup"><span data-stu-id="159a6-278">Storage Account Contributor</span></span> |<span data-ttu-id="159a6-279">86e8f5dc-a6e9-4c67-9d15-de283e8eac25</span><span class="sxs-lookup"><span data-stu-id="159a6-279">86e8f5dc-a6e9-4c67-9d15-de283e8eac25</span></span> |
| <span data-ttu-id="159a6-280">Collaboratore siti Web</span><span class="sxs-lookup"><span data-stu-id="159a6-280">Website Contributor</span></span> |<span data-ttu-id="159a6-281">de139f84-1756-47ae-9be6-808fbbe84772</span><span class="sxs-lookup"><span data-stu-id="159a6-281">de139f84-1756-47ae-9be6-808fbbe84772</span></span> |
| <span data-ttu-id="159a6-282">Collaboratore piani Web</span><span class="sxs-lookup"><span data-stu-id="159a6-282">Web Plan Contributor</span></span> |<span data-ttu-id="159a6-283">2cc479cb-7b4d-49a8-b449-8c00fd0f0a4b</span><span class="sxs-lookup"><span data-stu-id="159a6-283">2cc479cb-7b4d-49a8-b449-8c00fd0f0a4b</span></span> |
| <span data-ttu-id="159a6-284">Collaboratore SQL Server</span><span class="sxs-lookup"><span data-stu-id="159a6-284">SQL Server Contributor</span></span> |<span data-ttu-id="159a6-285">6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437</span><span class="sxs-lookup"><span data-stu-id="159a6-285">6d8ee4ec-f05a-4a1d-8b00-a9b17e38b437</span></span> |
| <span data-ttu-id="159a6-286">Collaboratore database SQL</span><span class="sxs-lookup"><span data-stu-id="159a6-286">SQL DB Contributor</span></span> |<span data-ttu-id="159a6-287">9b7fa17d-e63e-47b0-bb0a-15c516ac86ec</span><span class="sxs-lookup"><span data-stu-id="159a6-287">9b7fa17d-e63e-47b0-bb0a-15c516ac86ec</span></span> |

### <a name="assign-rbac-role-tooapplication"></a><span data-ttu-id="159a6-288">Assegnare RBAC ruolo tooapplication</span><span class="sxs-lookup"><span data-stu-id="159a6-288">Assign RBAC role tooapplication</span></span>
<span data-ttu-id="159a6-289">È tutto ciò che occorre tooassign hello appropriato RBAC ruolo tooyour dell'entità servizio utilizzando hello [Gestione risorse di creare l'assegnazione di ruolo](https://docs.microsoft.com/rest/api/authorization/roleassignments) API.</span><span class="sxs-lookup"><span data-stu-id="159a6-289">You have everything you need tooassign hello appropriate RBAC role tooyour service principal by using hello [Resource Manager create role assignment](https://docs.microsoft.com/rest/api/authorization/roleassignments) API.</span></span>

<span data-ttu-id="159a6-290">Hello [GrantRoleToServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L170) metodo hello app di esempio ASP.net MVC implementa questa chiamata.</span><span class="sxs-lookup"><span data-stu-id="159a6-290">hello [GrantRoleToServicePrincipalOnSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L170) method of hello ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="159a6-291">Un esempio richiesta tooassign RBAC ruolo tooapplication:</span><span class="sxs-lookup"><span data-stu-id="159a6-291">An example request tooassign RBAC role tooapplication:</span></span>

    PUT https://management.azure.com/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/microsoft.authorization/roleassignments/4f87261d-2816-465d-8311-70a27558df4c?api-version=2015-07-01 HTTP/1.1

    Authorization: Bearer eyJ0eXAiOiJKV1QiL*****FlwO1mM7Cw6JWtfY2lGc5
    Content-Type: application/json
    Content-Length: 230

    {"properties": {"roleDefinitionId":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7","principalId":"c3097b31-7309-4c59-b4e3-770f8406bad2"}}

<span data-ttu-id="159a6-292">Nella richiesta di hello, viene utilizzato hello seguenti valori:</span><span class="sxs-lookup"><span data-stu-id="159a6-292">In hello request, hello following values are used:</span></span>

| <span data-ttu-id="159a6-293">Guid</span><span class="sxs-lookup"><span data-stu-id="159a6-293">Guid</span></span> | <span data-ttu-id="159a6-294">Descrizione</span><span class="sxs-lookup"><span data-stu-id="159a6-294">Description</span></span> |
| --- | --- |
| <span data-ttu-id="159a6-295">09cbd307-aa71-4aca-b346-5f253e6e3ebb</span><span class="sxs-lookup"><span data-stu-id="159a6-295">09cbd307-aa71-4aca-b346-5f253e6e3ebb</span></span> |<span data-ttu-id="159a6-296">id di Hello di hello sottoscrizione</span><span class="sxs-lookup"><span data-stu-id="159a6-296">hello id of hello subscription</span></span> |
| <span data-ttu-id="159a6-297">c3097b31-7309-4c59-b4e3-770f8406bad2</span><span class="sxs-lookup"><span data-stu-id="159a6-297">c3097b31-7309-4c59-b4e3-770f8406bad2</span></span> |<span data-ttu-id="159a6-298">id di oggetto Hello dell'entità servizio hello di un'applicazione hello</span><span class="sxs-lookup"><span data-stu-id="159a6-298">hello object id of hello service principal of hello application</span></span> |
| <span data-ttu-id="159a6-299">acdd72a7-3385-48ef-bd42-f606fba81ae7</span><span class="sxs-lookup"><span data-stu-id="159a6-299">acdd72a7-3385-48ef-bd42-f606fba81ae7</span></span> |<span data-ttu-id="159a6-300">id di Hello del ruolo di lettore hello</span><span class="sxs-lookup"><span data-stu-id="159a6-300">hello id of hello reader role</span></span> |
| <span data-ttu-id="159a6-301">4f87261d-2816-465d-8311-70a27558df4c</span><span class="sxs-lookup"><span data-stu-id="159a6-301">4f87261d-2816-465d-8311-70a27558df4c</span></span> |<span data-ttu-id="159a6-302">un nuovo guid creato per la nuova assegnazione di ruolo hello</span><span class="sxs-lookup"><span data-stu-id="159a6-302">a new guid created for hello new role assignment</span></span> |

<span data-ttu-id="159a6-303">risposta Hello è nel seguente formato hello:</span><span class="sxs-lookup"><span data-stu-id="159a6-303">hello response is in hello following format:</span></span>

    HTTP/1.1 201 Created

    {"properties":{"roleDefinitionId":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleDefinitions/acdd72a7-3385-48ef-bd42-f606fba81ae7","principalId":"c3097b31-7309-4c59-b4e3-770f8406bad2","scope":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb"},"id":"/subscriptions/09cbd307-aa71-4aca-b346-5f253e6e3ebb/providers/Microsoft.Authorization/roleAssignments/4f87261d-2816-465d-8311-70a27558df4c","type":"Microsoft.Authorization/roleAssignments","name":"4f87261d-2816-465d-8311-70a27558df4c"}

### <a name="get-app-only-access-token-for-azure-resource-manager"></a><span data-ttu-id="159a6-304">Ottenere il token di accesso solo app per Azure Resource Manager</span><span class="sxs-lookup"><span data-stu-id="159a6-304">Get app-only access token for Azure Resource Manager</span></span>
<span data-ttu-id="159a6-305">toovalidate app ha accesso hello desiderato nella sottoscrizione hello, eseguire un'attività di test su sottoscrizione hello tramite un token di autorizzazione solo app.</span><span class="sxs-lookup"><span data-stu-id="159a6-305">toovalidate that app has hello desired access on hello subscription, perform a test task on hello subscription using an app-only token.</span></span>

<span data-ttu-id="159a6-306">tooget un token di accesso solo app, seguire le istruzioni nella sezione [ottenere token di accesso solo app per l'API di Azure AD Graph](#app-azure-ad-graph), con un valore diverso per il parametro risorsa hello:</span><span class="sxs-lookup"><span data-stu-id="159a6-306">tooget an app-only access token, follow instructions from section [Get app-only access token for Azure AD Graph API](#app-azure-ad-graph), with a different value for hello resource parameter:</span></span>

    https://management.core.windows.net/

<span data-ttu-id="159a6-307">Hello [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) metodo dell'applicazione di esempio ASP.NET MVC Ottiene un accesso solo app token per l'utilizzo di Azure Resource Manager hello hello Active Directory Authentication Library per .net.</span><span class="sxs-lookup"><span data-stu-id="159a6-307">hello [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of hello ASP.NET MVC sample application gets an app-only access token for Azure Resource Manager using hello Active Directory Authentication Library for .net.</span></span>

#### <a name="get-applications-permissions-on-subscription"></a><span data-ttu-id="159a6-308">Ottenere le autorizzazioni dell'applicazione per la sottoscrizione</span><span class="sxs-lookup"><span data-stu-id="159a6-308">Get Application's Permissions on Subscription</span></span>
<span data-ttu-id="159a6-309">accesso in una sottoscrizione di Azure di toocheck che l'applicazione ha hello desiderato, è inoltre possibile chiamare hello [le autorizzazioni di gestione risorse](https://docs.microsoft.com/rest/api/authorization/permissions) API.</span><span class="sxs-lookup"><span data-stu-id="159a6-309">toocheck that your application has hello desired access on an Azure subscription, you may also call hello [Resource Manager Permissions](https://docs.microsoft.com/rest/api/authorization/permissions) API.</span></span> <span data-ttu-id="159a6-310">Questo approccio è simile toohow determinare se l'utente hello dispone dei diritti di gestione dell'accesso per la sottoscrizione di hello.</span><span class="sxs-lookup"><span data-stu-id="159a6-310">This approach is similar toohow you determined whether hello user has Access Management rights for hello subscription.</span></span> <span data-ttu-id="159a6-311">Tuttavia, questa volta, chiamare l'API di autorizzazioni di hello con token di accesso solo per app hello ottenuto nel passaggio precedente hello.</span><span class="sxs-lookup"><span data-stu-id="159a6-311">However, this time, call hello permissions API with hello app-only access token that you received in hello previous step.</span></span>

<span data-ttu-id="159a6-312">Hello [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) metodo hello app di esempio ASP.NET MVC implementa questa chiamata.</span><span class="sxs-lookup"><span data-stu-id="159a6-312">hello [ServicePrincipalHasReadAccessToSubscription](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L110) method of hello ASP.NET MVC sample app implements this call.</span></span>

## <a name="manage-connected-subscriptions"></a><span data-ttu-id="159a6-313">Gestire le sottoscrizioni connesse</span><span class="sxs-lookup"><span data-stu-id="159a6-313">Manage connected subscriptions</span></span>
<span data-ttu-id="159a6-314">Quando ruolo RBAC appropriato hello viene assegnata l'entità servizio dell'applicazione tooyour sottoscrizione hello, l'applicazione può mantenere il monitoraggio/gestione tramite i token di accesso solo app per Gestione risorse di Azure.</span><span class="sxs-lookup"><span data-stu-id="159a6-314">When hello appropriate RBAC role is assigned tooyour application's service principal on hello subscription, your application can keep monitoring/managing it using app-only access tokens for Azure Resource Manager.</span></span>

<span data-ttu-id="159a6-315">Se un proprietario della sottoscrizione Rimuove l'assegnazione di ruolo dell'applicazione utilizzando portale classico hello o strumenti da riga di comando, l'applicazione è tooaccess non è più in grado di sottoscrizione.</span><span class="sxs-lookup"><span data-stu-id="159a6-315">If a subscription owner removes your application's role assignment using hello classic portal or command-line tools, your application is no longer able tooaccess that subscription.</span></span> <span data-ttu-id="159a6-316">In tal caso, si deve notificare utente hello che connessione hello sottoscrizione hello è stata interrotta da un'applicazione hello esterno e associarvi un'opzione troppo "Ripristina" connessione hello.</span><span class="sxs-lookup"><span data-stu-id="159a6-316">In that case, you should notify hello user that hello connection with hello subscription was severed from outside hello application and give them an option too"repair" hello connection.</span></span> <span data-ttu-id="159a6-317">"Ripristina" sarebbe semplicemente creare nuovamente l'assegnazione di ruolo hello che è stato eliminato non in linea.</span><span class="sxs-lookup"><span data-stu-id="159a6-317">"Repair" would simply re-create hello role assignment that was deleted offline.</span></span>

<span data-ttu-id="159a6-318">Esattamente come un'applicazione hello utente tooconnect sottoscrizioni tooyour è stato abilitato, è necessario consentire le sottoscrizioni di hello utente toodisconnect troppo.</span><span class="sxs-lookup"><span data-stu-id="159a6-318">Just as you enabled hello user tooconnect subscriptions tooyour application, you must allow hello user toodisconnect subscriptions too.</span></span> <span data-ttu-id="159a6-319">Da un punto di vista della gestione di accesso, disconnessione significa rimuovere l'assegnazione di ruolo hello contenente entità servizio dell'applicazione hello nella sottoscrizione hello.</span><span class="sxs-lookup"><span data-stu-id="159a6-319">From an access management point of view, disconnect means removing hello role assignment that hello application's service principal has on hello subscription.</span></span> <span data-ttu-id="159a6-320">Facoltativamente, dello stato in un'applicazione hello per sottoscrizione hello potrebbe essere rimossi troppo.</span><span class="sxs-lookup"><span data-stu-id="159a6-320">Optionally, any state in hello application for hello subscription might be removed too.</span></span>
<span data-ttu-id="159a6-321">Solo gli utenti con autorizzazione di accesso gestione per la sottoscrizione hello sono in grado di toodisconnect sottoscrizione di hello.</span><span class="sxs-lookup"><span data-stu-id="159a6-321">Only users with access management permission on hello subscription are able toodisconnect hello subscription.</span></span>

<span data-ttu-id="159a6-322">Hello [RevokeRoleFromServicePrincipalOnSubscription metodo](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L200) di ASP.net MVC hello app di esempio implementa questa chiamata.</span><span class="sxs-lookup"><span data-stu-id="159a6-322">hello [RevokeRoleFromServicePrincipalOnSubscription method](https://github.com/dushyantgill/VipSwapper/blob/master/CloudSense/CloudSense/AzureResourceManagerUtil.cs#L200) of hello ASP.net MVC sample app implements this call.</span></span>

<span data-ttu-id="159a6-323">Gli utenti ora possono connettere e gestire facilmente le sottoscrizioni di Azure con l'applicazione.</span><span class="sxs-lookup"><span data-stu-id="159a6-323">That's it - users can now easily connect and manage their Azure subscriptions with your application.</span></span>
