---
title: "Aggiungere report personalizzati sull'integrità di Service Fabric | Documentazione Microsoft"
description: "Questo articolo descrive come inviare report sull'integrità personalizzati alle entità di integrità di Azure Service Fabric. Offre consigli per la progettazione e l'implementazione di report efficaci relativi all'integrità."
services: service-fabric
documentationcenter: .net
author: oanapl
manager: timlt
editor: 
ms.assetid: 0a00a7d2-510e-47d0-8aa8-24c851ea847f
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 07/19/2017
ms.author: oanapl
ms.openlocfilehash: ed10eef347d4d93012078456b3a145589e66d30e
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/18/2017
---
# <a name="add-custom-service-fabric-health-reports"></a><span data-ttu-id="34ce1-104">Aggiungere report sull'integrità di Service Fabric personalizzati</span><span class="sxs-lookup"><span data-stu-id="34ce1-104">Add custom Service Fabric health reports</span></span>
<span data-ttu-id="34ce1-105">In Azure Service Fabric è disponibile un [modello di integrità](service-fabric-health-introduction.md) progettato per contrassegnare condizioni di non integrità di cluster e applicazioni in entità specifiche.</span><span class="sxs-lookup"><span data-stu-id="34ce1-105">Azure Service Fabric introduces a [health model](service-fabric-health-introduction.md) designed to flag unhealthy cluster and application conditions on specific entities.</span></span> <span data-ttu-id="34ce1-106">Il modello di integrità usa **i** , costituiti da watchdog e componenti di sistema.</span><span class="sxs-lookup"><span data-stu-id="34ce1-106">The health model uses **health reporters** (system components and watchdogs).</span></span> <span data-ttu-id="34ce1-107">Lo scopo è semplificare e velocizzare la diagnosi e la risoluzione dei problemi.</span><span class="sxs-lookup"><span data-stu-id="34ce1-107">The goal is easy and fast diagnosis and repair.</span></span> <span data-ttu-id="34ce1-108">Gli sviluppatori del servizio devono tenere conto dell'integrità fin dall'inizio.</span><span class="sxs-lookup"><span data-stu-id="34ce1-108">Service writers need to think upfront about health.</span></span> <span data-ttu-id="34ce1-109">È necessario segnalare tutte le condizioni che possono influire sull'integrità, soprattutto se aiutano a risalire alla causa dei problemi.</span><span class="sxs-lookup"><span data-stu-id="34ce1-109">Any condition that can impact health should be reported on, especially if it can help flag problems close to the root.</span></span> <span data-ttu-id="34ce1-110">Le informazioni sull'integrità consentono di risparmiare tempo ed energie per il debug e l'analisi.</span><span class="sxs-lookup"><span data-stu-id="34ce1-110">The health information can save time and effort on debugging and investigation.</span></span> <span data-ttu-id="34ce1-111">L'utilità è particolarmente evidente quando il servizio è in esecuzione su larga scala nel cloud (privato o Azure).</span><span class="sxs-lookup"><span data-stu-id="34ce1-111">The usefulness is especially clear once the service is up and running at scale in the cloud (private or Azure).</span></span>

<span data-ttu-id="34ce1-112">I generatori di report di Service Fabric eseguono il monitoraggio di condizioni di particolare interesse.</span><span class="sxs-lookup"><span data-stu-id="34ce1-112">The Service Fabric reporters monitor identified conditions of interest.</span></span> <span data-ttu-id="34ce1-113">Generano report su tali condizioni in base alla visualizzazione locale.</span><span class="sxs-lookup"><span data-stu-id="34ce1-113">They report on those conditions based on their local view.</span></span> <span data-ttu-id="34ce1-114">L'[archivio integrità](service-fabric-health-introduction.md#health-store) aggrega i dati sull'integrità inviati da tutti i reporter per determinare se le entità sono complessivamente integre.</span><span class="sxs-lookup"><span data-stu-id="34ce1-114">The [health store](service-fabric-health-introduction.md#health-store) aggregates health data sent by all reporters to determine whether entities are globally healthy.</span></span> <span data-ttu-id="34ce1-115">Il modello è concepito per essere completo, flessibile e facile da usare.</span><span class="sxs-lookup"><span data-stu-id="34ce1-115">The model is intended to be rich, flexible, and easy to use.</span></span> <span data-ttu-id="34ce1-116">La qualità dei report sull'integrità determina il livello di accuratezza della visualizzazione dell'integrità del cluster.</span><span class="sxs-lookup"><span data-stu-id="34ce1-116">The quality of the health reports determines the accuracy of the health view of the cluster.</span></span> <span data-ttu-id="34ce1-117">I falsi positivi che visualizzano erroneamente problemi di non integrità possono influire negativamente sugli aggiornamenti o su altri servizi che usano i dati di integrità,</span><span class="sxs-lookup"><span data-stu-id="34ce1-117">False positives that wrongly show unhealthy issues can negatively impact upgrades or other services that use health data.</span></span> <span data-ttu-id="34ce1-118">come ad esempio i servizi di ripristino e i meccanismi di avviso.</span><span class="sxs-lookup"><span data-stu-id="34ce1-118">Examples of such services are repair services and alerting mechanisms.</span></span> <span data-ttu-id="34ce1-119">Pertanto, è necessario creare report che segnalino le condizioni a cui si è interessati nel miglior modo possibile.</span><span class="sxs-lookup"><span data-stu-id="34ce1-119">Therefore, some thought is needed to provide reports that capture conditions of interest in the best possible way.</span></span>

<span data-ttu-id="34ce1-120">Per progettare e implementare i report sull'integrità, i watchdog e i componenti di sistema devono:</span><span class="sxs-lookup"><span data-stu-id="34ce1-120">To design and implement health reporting, watchdogs and system components must:</span></span>

* <span data-ttu-id="34ce1-121">Definire la condizione di cui devono occuparsi, il modo in cui viene monitorata e l'impatto sulla funzionalità del cluster o dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="34ce1-121">Define the condition they are interested in, the way it is monitored, and the impact on the cluster or application functionality.</span></span> <span data-ttu-id="34ce1-122">Tali informazioni determinano la proprietà del report sull'integrità e lo stato di integrità.</span><span class="sxs-lookup"><span data-stu-id="34ce1-122">Based on this information, decide on the health report property and health state.</span></span>
* <span data-ttu-id="34ce1-123">Determinare l' [entità](service-fabric-health-introduction.md#health-entities-and-hierarchy) a cui si applica il report.</span><span class="sxs-lookup"><span data-stu-id="34ce1-123">Determine the [entity](service-fabric-health-introduction.md#health-entities-and-hierarchy) that the report applies to.</span></span>
* <span data-ttu-id="34ce1-124">Determinare dove viene eseguito il report, ovvero dall'interno del servizio o da un watchdog interno o esterno.</span><span class="sxs-lookup"><span data-stu-id="34ce1-124">Determine where the reporting is done, from within the service or from an internal or external watchdog.</span></span>
* <span data-ttu-id="34ce1-125">Definire un'origine usata per identificare il generatore di report.</span><span class="sxs-lookup"><span data-stu-id="34ce1-125">Define a source used to identify the reporter.</span></span>
* <span data-ttu-id="34ce1-126">Scegliere una strategia di creazione di report (periodicamente o in caso di transizioni).</span><span class="sxs-lookup"><span data-stu-id="34ce1-126">Choose a reporting strategy, either periodically or on transitions.</span></span> <span data-ttu-id="34ce1-127">La creazione periodica di report è la scelta consigliata, perché richiede codice più semplice ed è meno soggetta a errori.</span><span class="sxs-lookup"><span data-stu-id="34ce1-127">The recommended way is periodically, as it requires simpler code and is less prone to errors.</span></span>
* <span data-ttu-id="34ce1-128">Determinare per quanto tempo il report sulle condizioni di non integrità deve rimanere nell'archivio integrità e come deve essere eliminato.</span><span class="sxs-lookup"><span data-stu-id="34ce1-128">Determine how long the report for unhealthy conditions should stay in the health store and how it should be cleared.</span></span> <span data-ttu-id="34ce1-129">Queste informazioni determinano la durata (TTL) del report e il comportamento alla scadenza.</span><span class="sxs-lookup"><span data-stu-id="34ce1-129">Using this information, decide the report's time to live and remove-on-expiration behavior.</span></span>

<span data-ttu-id="34ce1-130">Come indicato, i report possono essere creati da:</span><span class="sxs-lookup"><span data-stu-id="34ce1-130">As mentioned, reporting can be done from:</span></span>

* <span data-ttu-id="34ce1-131">La replica del servizio di Service Fabric monitorato.</span><span class="sxs-lookup"><span data-stu-id="34ce1-131">The monitored Service Fabric service replica.</span></span>
* <span data-ttu-id="34ce1-132">Watchdog interni distribuiti come servizio di Service Fabric, ad esempio un servizio senza stato di Service Fabric che monitora le condizioni e genera i report.</span><span class="sxs-lookup"><span data-stu-id="34ce1-132">Internal watchdogs deployed as a Service Fabric service (for example, a Service Fabric stateless service that monitors conditions and issues reports).</span></span> <span data-ttu-id="34ce1-133">Il watchdog può essere distribuito su tutti i nodi o è possibile creare un'affinità con il servizio monitorato.</span><span class="sxs-lookup"><span data-stu-id="34ce1-133">The watchdogs can be deployed an all nodes or can be affinitized to the monitored service.</span></span>
* <span data-ttu-id="34ce1-134">Watchdog interni eseguiti sui nodi di Service Fabric ma *non* implementati come servizi di Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="34ce1-134">Internal watchdogs that run on the Service Fabric nodes but are *not* implemented as Service Fabric services.</span></span>
* <span data-ttu-id="34ce1-135">Watchdog esterni che interrogano la risorsa dall' *esterno* del cluster di Service Fabric, ad esempio un servizio di monitoraggio come Gomez.</span><span class="sxs-lookup"><span data-stu-id="34ce1-135">External watchdogs that probe the resource from *outside* the Service Fabric cluster (for example, monitoring service like Gomez).</span></span>

> [!NOTE]
> <span data-ttu-id="34ce1-136">Per impostazione predefinita, il cluster viene popolato con report sull'integrità inviati dai componenti di sistema.</span><span class="sxs-lookup"><span data-stu-id="34ce1-136">Out of the box, the cluster is populated with health reports sent by the system components.</span></span> <span data-ttu-id="34ce1-137">Per altre informazioni, vedere [Uso dei report sull'integrità del sistema per la risoluzione dei problemi](service-fabric-understand-and-troubleshoot-with-system-health-reports.md).</span><span class="sxs-lookup"><span data-stu-id="34ce1-137">Read more at [Using system health reports for troubleshooting](service-fabric-understand-and-troubleshoot-with-system-health-reports.md).</span></span> <span data-ttu-id="34ce1-138">I report dell'utente devono essere inviati alle [entità di integrità](service-fabric-health-introduction.md#health-entities-and-hierarchy) già create dal sistema.</span><span class="sxs-lookup"><span data-stu-id="34ce1-138">The user reports must be sent on [health entities](service-fabric-health-introduction.md#health-entities-and-hierarchy) that have already been created by the system.</span></span>
> 
> 

<span data-ttu-id="34ce1-139">Una volta definita la progettazione dei report sull'integrità, è possibile inviarli facilmente.</span><span class="sxs-lookup"><span data-stu-id="34ce1-139">Once the health reporting design is clear, health reports can be sent easily.</span></span> <span data-ttu-id="34ce1-140">È possibile usare [FabricClient](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient) per segnalare lo stato di integrità se il cluster non è [sicuro](service-fabric-cluster-security.md) o se il client Fabric ha privilegi di amministratore.</span><span class="sxs-lookup"><span data-stu-id="34ce1-140">You can use [FabricClient](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient) to report health if the cluster is not [secure](service-fabric-cluster-security.md) or if the fabric client has admin privileges.</span></span> <span data-ttu-id="34ce1-141">Per la creazione di report è possibile usare l'API con [FabricClient.HealthManager.ReportHealth](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient.healthclient.reporthealth), PowerShell oppure REST.</span><span class="sxs-lookup"><span data-stu-id="34ce1-141">Reporting can be done through the API by using [FabricClient.HealthManager.ReportHealth](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient.healthclient.reporthealth), through PowerShell, or through REST.</span></span> <span data-ttu-id="34ce1-142">Sono disponibili controlli di configurazione che riuniscono i report in batch per migliorare le prestazioni.</span><span class="sxs-lookup"><span data-stu-id="34ce1-142">Configuration knobs batch reports for improved performance.</span></span>

> [!NOTE]
> <span data-ttu-id="34ce1-143">L'esecuzione di report sull'integrità è un'operazione sincrona e rappresenta solo l'attività di convalida sul lato client.</span><span class="sxs-lookup"><span data-stu-id="34ce1-143">Report health is synchronous, and it represents only the validation work on the client side.</span></span> <span data-ttu-id="34ce1-144">Il fatto che il report venga accettato dal client di integrità o dagli oggetti `Partition` o `CodePackageActivationContext` non significa che venga applicato nell'archivio.</span><span class="sxs-lookup"><span data-stu-id="34ce1-144">The fact that the report is accepted by the health client or the `Partition` or `CodePackageActivationContext` objects doesn't mean that it is applied in the store.</span></span> <span data-ttu-id="34ce1-145">Viene inviato in modo asincrono e possibilmente in batch con altri report.</span><span class="sxs-lookup"><span data-stu-id="34ce1-145">It is sent asynchronously and possibly batched with other reports.</span></span> <span data-ttu-id="34ce1-146">L'elaborazione sul server può comunque non riuscire. È possibile che un numero di sequenza non sia aggiornato, che l'entità a cui deve essere applicato il report sia stata eliminata e così via.</span><span class="sxs-lookup"><span data-stu-id="34ce1-146">The processing on the server may still fail: the sequence number could be stale, the entity on which the report must be applied has been deleted, etc.</span></span>
> 
> 

## <a name="health-client"></a><span data-ttu-id="34ce1-147">Client di integrità</span><span class="sxs-lookup"><span data-stu-id="34ce1-147">Health client</span></span>
<span data-ttu-id="34ce1-148">I report sull'integrità vengono inviati all'archivio integrità tramite un client di integrità, che risiede nel client Fabric.</span><span class="sxs-lookup"><span data-stu-id="34ce1-148">The health reports are sent to the health store through a health client, which lives inside the fabric client.</span></span> <span data-ttu-id="34ce1-149">Il client di integrità può essere configurato con le impostazioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="34ce1-149">The health client can be configured with the following settings:</span></span>

* <span data-ttu-id="34ce1-150">**HealthReportSendInterval**: ritardo tra il momento in cui il report viene aggiunto al client e il momento in cui viene inviato all'archivio integrità.</span><span class="sxs-lookup"><span data-stu-id="34ce1-150">**HealthReportSendInterval**: The delay between the time the report is added to the client and the time it is sent to the health store.</span></span> <span data-ttu-id="34ce1-151">Questo valore viene usato per inviare i report in batch un singolo messaggio, anziché inviare un messaggio per ogni report,</span><span class="sxs-lookup"><span data-stu-id="34ce1-151">Used to batch reports into a single message, rather than sending one message for each report.</span></span> <span data-ttu-id="34ce1-152">e migliorare così le prestazioni.</span><span class="sxs-lookup"><span data-stu-id="34ce1-152">The batching improves performance.</span></span> <span data-ttu-id="34ce1-153">Impostazione predefinita: 30 secondi.</span><span class="sxs-lookup"><span data-stu-id="34ce1-153">Default: 30 seconds.</span></span>
* <span data-ttu-id="34ce1-154">**HealthReportRetrySendInterval**: intervallo dopo il quale il client di integrità invia nuovamente i report sull'integrità accumulati all'archivio integrità.</span><span class="sxs-lookup"><span data-stu-id="34ce1-154">**HealthReportRetrySendInterval**: The interval at which the health client resends accumulated health reports to the health store.</span></span> <span data-ttu-id="34ce1-155">Impostazione predefinita: 30 secondi.</span><span class="sxs-lookup"><span data-stu-id="34ce1-155">Default: 30 seconds.</span></span>
* <span data-ttu-id="34ce1-156">**HealthOperationTimeout**: periodo di timeout per un messaggio di report inviato all'archivio integrità.</span><span class="sxs-lookup"><span data-stu-id="34ce1-156">**HealthOperationTimeout**: The timeout period for a report message sent to the health store.</span></span> <span data-ttu-id="34ce1-157">In caso di timeout di un messaggio scade, il client di integrità riprova a inviarlo finché l'archivio integrità non conferma che i report sono stati elaborati.</span><span class="sxs-lookup"><span data-stu-id="34ce1-157">If a message times out, the health client retries it until the health store confirms that the report has been processed.</span></span> <span data-ttu-id="34ce1-158">Valore predefinito: due minuti.</span><span class="sxs-lookup"><span data-stu-id="34ce1-158">Default: two minutes.</span></span>

> [!NOTE]
> <span data-ttu-id="34ce1-159">Quando i report vengono riuniti in batch, il client Fabric deve restare attivo almeno per il tempo previsto da HealthReportSendInterval per garantire l'invio dei report.</span><span class="sxs-lookup"><span data-stu-id="34ce1-159">When the reports are batched, the fabric client must be kept alive for at least the HealthReportSendInterval to ensure that they are sent.</span></span> <span data-ttu-id="34ce1-160">Se il messaggio viene perso o l'archivio integrità non può applicare i report a causa di errori temporanei, il client Fabric deve restare attivo più a lungo per dare la possibilità di riprovare.</span><span class="sxs-lookup"><span data-stu-id="34ce1-160">If the message is lost or the health store cannot apply them due to transient errors, the fabric client must be kept alive longer to give it a chance to retry.</span></span>
> 
> 

<span data-ttu-id="34ce1-161">La memorizzazione nel buffer sul client tiene conto dell'unicità dei report.</span><span class="sxs-lookup"><span data-stu-id="34ce1-161">The buffering on the client takes the uniqueness of the reports into consideration.</span></span> <span data-ttu-id="34ce1-162">Se un particolare generatore di report non corretto crea 100 report al secondo per la stessa proprietà della stessa entità, ad esempio, i report vengono sostituiti con l'ultima versione.</span><span class="sxs-lookup"><span data-stu-id="34ce1-162">For example, if a particular bad reporter is reporting 100 reports per second on the same property of the same entity, the reports are replaced with the last version.</span></span> <span data-ttu-id="34ce1-163">Nella coda del client sarà presente al massimo uno di questi report.</span><span class="sxs-lookup"><span data-stu-id="34ce1-163">At most one such report exists in the client queue.</span></span> <span data-ttu-id="34ce1-164">Se è configurato l'invio in batch, il numero di report inviati all'archivio integrità è solo uno per ogni intervallo di trasmissione.</span><span class="sxs-lookup"><span data-stu-id="34ce1-164">If batching is configured, the number of reports sent to the health store is just one per send interval.</span></span> <span data-ttu-id="34ce1-165">Questo è l'ultimo report aggiunto, che riflette lo stato più recente dell'entità.</span><span class="sxs-lookup"><span data-stu-id="34ce1-165">This report is the last added report, which reflects the most current state of the entity.</span></span>
<span data-ttu-id="34ce1-166">Specificare i parametri di configurazione quando viene creato `FabricClient` passando [FabricClientSettings](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclientsettings) con i valori desiderati per le voci correlate all'integrità.</span><span class="sxs-lookup"><span data-stu-id="34ce1-166">Specify configuration parameters when `FabricClient` is created by passing [FabricClientSettings](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclientsettings) with the desired values for health-related entries.</span></span>

<span data-ttu-id="34ce1-167">L'esempio seguente crea un client Fabric e specifica che i report devono essere inviati quando vengono aggiunti.</span><span class="sxs-lookup"><span data-stu-id="34ce1-167">The following example creates a fabric client and specifies that the reports should be sent when they are added.</span></span> <span data-ttu-id="34ce1-168">In caso di timeout ed errori che supportano nuovi tentativi, questi vengono eseguiti ogni 40 secondi.</span><span class="sxs-lookup"><span data-stu-id="34ce1-168">On timeouts and errors that can be retried, retries happen every 40 seconds.</span></span>

```csharp
var clientSettings = new FabricClientSettings()
{
    HealthOperationTimeout = TimeSpan.FromSeconds(120),
    HealthReportSendInterval = TimeSpan.FromSeconds(0),
    HealthReportRetrySendInterval = TimeSpan.FromSeconds(40),
};
var fabricClient = new FabricClient(clientSettings);
```

<span data-ttu-id="34ce1-169">Si consiglia di mantenere le impostazioni predefinite del client Fabric, con `HealthReportSendInterval` pari a 30 secondi.</span><span class="sxs-lookup"><span data-stu-id="34ce1-169">We recommend keeping the default fabric client settings, which set `HealthReportSendInterval` to 30 seconds.</span></span> <span data-ttu-id="34ce1-170">Questa impostazione garantisce prestazioni ottimali con l'invio in batch.</span><span class="sxs-lookup"><span data-stu-id="34ce1-170">This setting ensures optimal performance due to batching.</span></span> <span data-ttu-id="34ce1-171">Per i report critici che devono essere inviati il prima possibile, usare `HealthReportSendOptions` con il flag Immediate `true` nell'API [FabricClient.HealthClient.ReportHealth](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient.healthclient.reporthealth).</span><span class="sxs-lookup"><span data-stu-id="34ce1-171">For critical reports that must be sent as soon as possible, use `HealthReportSendOptions` with Immediate `true` in [FabricClient.HealthClient.ReportHealth](https://docs.microsoft.com/dotnet/api/system.fabric.fabricclient.healthclient.reporthealth) API.</span></span> <span data-ttu-id="34ce1-172">I report con flag Immediate ignorano l'intervallo di invio in batch.</span><span class="sxs-lookup"><span data-stu-id="34ce1-172">Immediate reports bypass the batching interval.</span></span> <span data-ttu-id="34ce1-173">Usare questo flag con cautela. Quando possibile, è preferibile usare l'invio in batch del client di integrità.</span><span class="sxs-lookup"><span data-stu-id="34ce1-173">Use this flag with care; we want to take advantage of the health client batching whenever possible.</span></span> <span data-ttu-id="34ce1-174">L'invio immediato è utile anche quando il client Fabric è in fase di chiusura (ad esempio, il processo ha determinato uno stato non valido e deve essere arrestato per evitare effetti collaterali).</span><span class="sxs-lookup"><span data-stu-id="34ce1-174">Immediate send is also useful when the fabric client is closing (for example, the process has determined invalid state and needs to shut down to prevent side effects).</span></span> <span data-ttu-id="34ce1-175">Ciò assicura un invio ottimale dei report accumulati.</span><span class="sxs-lookup"><span data-stu-id="34ce1-175">It ensures a best-effort send of the accumulated reports.</span></span> <span data-ttu-id="34ce1-176">Quando viene aggiunto un report con il flag Immediate, il client di integrità invia in batch tutti i report accumulati dall'ultimo invio.</span><span class="sxs-lookup"><span data-stu-id="34ce1-176">When one report is added with Immediate flag, the health client batches all the accumulated reports since last send.</span></span>

<span data-ttu-id="34ce1-177">È possibile specificare gli stessi parametri quando si crea una connessione a un cluster tramite PowerShell.</span><span class="sxs-lookup"><span data-stu-id="34ce1-177">Same parameters can be specified when a connection to a cluster is created through PowerShell.</span></span> <span data-ttu-id="34ce1-178">L'esempio seguente avvia una connessione a un cluster locale:</span><span class="sxs-lookup"><span data-stu-id="34ce1-178">The following example starts a connection to a local cluster:</span></span>

```powershell
PS C:\> Connect-ServiceFabricCluster -HealthOperationTimeoutInSec 120 -HealthReportSendIntervalInSec 0 -HealthReportRetrySendIntervalInSec 40
True

ConnectionEndpoint   :
FabricClientSettings : {
                       ClientFriendlyName                   : PowerShell-1944858a-4c6d-465f-89c7-9021c12ac0bb
                       PartitionLocationCacheLimit          : 100000
                       PartitionLocationCacheBucketCount    : 1024
                       ServiceChangePollInterval            : 00:02:00
                       ConnectionInitializationTimeout      : 00:00:02
                       KeepAliveInterval                    : 00:00:20
                       HealthOperationTimeout               : 00:02:00
                       HealthReportSendInterval             : 00:00:00
                       HealthReportRetrySendInterval        : 00:00:40
                       NotificationGatewayConnectionTimeout : 00:00:00
                       NotificationCacheUpdateTimeout       : 00:00:00
                       }
GatewayInformation   : {
                       NodeAddress                          : localhost:19000
                       NodeId                               : 1880ec88a3187766a6da323399721f53
                       NodeInstanceId                       : 130729063464981219
                       NodeName                             : Node.1
                       }
```

<span data-ttu-id="34ce1-179">Analogamente all'API, i report possono essere inviati usando l'opzione `-Immediate` per l'invio immediato, indipendentemente dal valore di `HealthReportSendInterval`.</span><span class="sxs-lookup"><span data-stu-id="34ce1-179">Similarly to API, reports can be sent using `-Immediate` switch to be sent immediately, regardless of the `HealthReportSendInterval` value.</span></span>

<span data-ttu-id="34ce1-180">Per REST, i report vengono inviati al gateway di Service Fabric, che ha un client Fabric interno.</span><span class="sxs-lookup"><span data-stu-id="34ce1-180">For REST, the reports are sent to the Service Fabric gateway, which has an internal fabric client.</span></span> <span data-ttu-id="34ce1-181">Per impostazione predefinita, questo client è configurato per inviare i report in batch ogni 30 secondi.</span><span class="sxs-lookup"><span data-stu-id="34ce1-181">By default, this client is configured to send reports batched every 30 seconds.</span></span> <span data-ttu-id="34ce1-182">È possibile modificare l'intervallo di invio in batch impostando l'opzione di configurazione del cluster `HttpGatewayHealthReportSendInterval` su `HttpGateway`.</span><span class="sxs-lookup"><span data-stu-id="34ce1-182">You can change the batch interval with the cluster configuration setting `HttpGatewayHealthReportSendInterval` on `HttpGateway`.</span></span> <span data-ttu-id="34ce1-183">Come indicato, è preferibile inviare i report con `Immediate` true.</span><span class="sxs-lookup"><span data-stu-id="34ce1-183">As mentioned, a better option is to send the reports with `Immediate` true.</span></span> 

> [!NOTE]
> <span data-ttu-id="34ce1-184">Per fare in modo che i servizi non autorizzati non creino report sull'integrità per le entità del cluster, configurare il server in modo che accetti solo le richieste dei client protetti.</span><span class="sxs-lookup"><span data-stu-id="34ce1-184">To ensure that unauthorized services can't report health against the entities in the cluster, configure the server to accept requests only from secured clients.</span></span> <span data-ttu-id="34ce1-185">Per la classe `FabricClient` usata per la creazione di report è necessario abilitare la sicurezza per consentire la comunicazione con il cluster, ad esempio con Kerberos o l'autenticazione del certificato.</span><span class="sxs-lookup"><span data-stu-id="34ce1-185">The `FabricClient` used for reporting must have security enabled to be able to communicate with the cluster (for example, with Kerberos or certificate authentication).</span></span> <span data-ttu-id="34ce1-186">Per altre informazioni, vedere la pagina relativa alla [sicurezza del cluster](service-fabric-cluster-security.md).</span><span class="sxs-lookup"><span data-stu-id="34ce1-186">Read more about [cluster security](service-fabric-cluster-security.md).</span></span>
> 
> 

## <a name="report-from-within-low-privilege-services"></a><span data-ttu-id="34ce1-187">Report dai servizi con privilegi limitati</span><span class="sxs-lookup"><span data-stu-id="34ce1-187">Report from within low privilege services</span></span>
<span data-ttu-id="34ce1-188">Se i servizi di Service Fabric non hanno accesso amministrativo al cluster, è possibile creare report sull'integrità per le entità dal contesto corrente tramite `Partition` o `CodePackageActivationContext`.</span><span class="sxs-lookup"><span data-stu-id="34ce1-188">If Service Fabric services do not have admin access to the cluster, you can report health on entities from the current context through `Partition` or `CodePackageActivationContext`.</span></span>

* <span data-ttu-id="34ce1-189">Per i servizi senza stato usare [IStatelessServicePartition.ReportInstanceHealth](https://docs.microsoft.com/dotnet/api/system.fabric.istatelessservicepartition.reportinstancehealth) per creare report relativi all'istanza del servizio corrente.</span><span class="sxs-lookup"><span data-stu-id="34ce1-189">For stateless services, use [IStatelessServicePartition.ReportInstanceHealth](https://docs.microsoft.com/dotnet/api/system.fabric.istatelessservicepartition.reportinstancehealth) to report on the current service instance.</span></span>
* <span data-ttu-id="34ce1-190">Per i servizi con stato usare [IStatefulServicePartition.ReportReplicaHealth](https://docs.microsoft.com/dotnet/api/system.fabric.istatefulservicepartition.reportreplicahealth) per creare report relativi alla replica corrente.</span><span class="sxs-lookup"><span data-stu-id="34ce1-190">For stateful services, use [IStatefulServicePartition.ReportReplicaHealth](https://docs.microsoft.com/dotnet/api/system.fabric.istatefulservicepartition.reportreplicahealth) to report on current replica.</span></span>
* <span data-ttu-id="34ce1-191">Usare [IServicePartition.ReportPartitionHealth](https://docs.microsoft.com/dotnet/api/system.fabric.iservicepartition.reportpartitionhealth) per creare report relativi all'entità della partizione corrente.</span><span class="sxs-lookup"><span data-stu-id="34ce1-191">Use [IServicePartition.ReportPartitionHealth](https://docs.microsoft.com/dotnet/api/system.fabric.iservicepartition.reportpartitionhealth) to report on the current partition entity.</span></span>
* <span data-ttu-id="34ce1-192">Usare [CodePackageActivationContext.ReportApplicationHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportapplicationhealth) per creare report relativi all'applicazione corrente.</span><span class="sxs-lookup"><span data-stu-id="34ce1-192">Use [CodePackageActivationContext.ReportApplicationHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportapplicationhealth) to report on current application.</span></span>
* <span data-ttu-id="34ce1-193">Usare [CodePackageActivationContext.ReportDeployedApplicationHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportdeployedapplicationhealth) per creare report relativi all'applicazione corrente distribuita sul nodo corrente.</span><span class="sxs-lookup"><span data-stu-id="34ce1-193">Use [CodePackageActivationContext.ReportDeployedApplicationHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportdeployedapplicationhealth) to report on the current application deployed on the current node.</span></span>
* <span data-ttu-id="34ce1-194">Usare [CodePackageActivationContext.ReportDeployedServicePackageHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportdeployedservicepackagehealth) per creare report relativi a un pacchetto del servizio per l'applicazione distribuita nel nodo corrente.</span><span class="sxs-lookup"><span data-stu-id="34ce1-194">Use [CodePackageActivationContext.ReportDeployedServicePackageHealth](https://docs.microsoft.com/dotnet/api/system.fabric.codepackageactivationcontext.reportdeployedservicepackagehealth) to report on a service package for the application deployed on the current node.</span></span>

> [!NOTE]
> <span data-ttu-id="34ce1-195">Internamente gli oggetti `Partition` e `CodePackageActivationContext` hanno un client di integrità configurato con le impostazioni predefinite.</span><span class="sxs-lookup"><span data-stu-id="34ce1-195">Internally, the `Partition` and the `CodePackageActivationContext` hold a health client configured with default settings.</span></span> <span data-ttu-id="34ce1-196">Come illustrato per il [client di integrità](service-fabric-report-health.md#health-client), i report vengono raggruppati in batch e inviati in base a un timer.</span><span class="sxs-lookup"><span data-stu-id="34ce1-196">As explained for the [health client](service-fabric-report-health.md#health-client), reports are batched and sent on a timer.</span></span> <span data-ttu-id="34ce1-197">Gli oggetti devono essere mantenuti attivi per poter inviare il report.</span><span class="sxs-lookup"><span data-stu-id="34ce1-197">The objects should be kept alive to have a chance to send the report.</span></span>
> 
> 

<span data-ttu-id="34ce1-198">È possibile specificare `HealthReportSendOptions` quando si inviano i report tramite le API di integrità `Partition` e `CodePackageActivationContext`.</span><span class="sxs-lookup"><span data-stu-id="34ce1-198">You can specify `HealthReportSendOptions` when sending reports through `Partition` and `CodePackageActivationContext` health APIs.</span></span> <span data-ttu-id="34ce1-199">Per i report critici che devono essere inviati il prima possibile, usare `HealthReportSendOptions` con il flag Immediate `true`.</span><span class="sxs-lookup"><span data-stu-id="34ce1-199">If you have critical reports that must be sent as soon as possible, use `HealthReportSendOptions` with Immediate `true`.</span></span> <span data-ttu-id="34ce1-200">I report con flag Immediate ignorano l'intervallo di invio in batch del client di integrità interno.</span><span class="sxs-lookup"><span data-stu-id="34ce1-200">Immediate reports bypass the batching interval of the internal health client.</span></span> <span data-ttu-id="34ce1-201">Come indicato in precedenza, usare questo flag con cautela. Quando possibile, è preferibile usare l'invio in batch del client di integrità.</span><span class="sxs-lookup"><span data-stu-id="34ce1-201">As mentioned before, use this flag with care; we want to take advantage of the health client batching whenever possible.</span></span>

## <a name="design-health-reporting"></a><span data-ttu-id="34ce1-202">Creare report sull'integrità</span><span class="sxs-lookup"><span data-stu-id="34ce1-202">Design health reporting</span></span>
<span data-ttu-id="34ce1-203">Il primo passaggio per la creazione di report di alta qualità consiste nell'identificare le condizioni che possono influire sull'integrità del servizio.</span><span class="sxs-lookup"><span data-stu-id="34ce1-203">The first step in generating high-quality reports is identifying the conditions that can impact the health of the service.</span></span> <span data-ttu-id="34ce1-204">Tutte le condizioni che facilitano l'identificazione dei problemi nel servizio o nel cluster non appena insorgono, o meglio ancora prima che si verifichino, possono consentire un notevole risparmio,</span><span class="sxs-lookup"><span data-stu-id="34ce1-204">Any condition that can help flag problems in the service or cluster when it starts--or even better, before a problem happens--can potentially save billions of dollars.</span></span> <span data-ttu-id="34ce1-205">grazie alla riduzione dei tempi di inattività e del numero di ore impiegate per l'analisi e la risoluzione dei problemi, oltre all'aumento della soddisfazione dei clienti.</span><span class="sxs-lookup"><span data-stu-id="34ce1-205">The benefits include less down time, fewer night hours spent investigating and repairing issues, and higher customer satisfaction.</span></span>

<span data-ttu-id="34ce1-206">Dopo aver identificato le condizioni, gli sviluppatori dei watchdog devono stabilire il modo migliore per monitorarle, trovando il giusto equilibrio tra sovraccarico e utilità.</span><span class="sxs-lookup"><span data-stu-id="34ce1-206">Once the conditions are identified, watchdog writers need to figure out the best way to monitor them for balance between overhead and usefulness.</span></span> <span data-ttu-id="34ce1-207">Si consideri, ad esempio, un servizio che esegue calcoli complessi usando alcuni file temporanei in una condivisione.</span><span class="sxs-lookup"><span data-stu-id="34ce1-207">For example, consider a service that does complex calculations that use some temporary files on a share.</span></span> <span data-ttu-id="34ce1-208">Un watchdog può monitorare la condivisione per verificare che sia disponibile spazio sufficiente.</span><span class="sxs-lookup"><span data-stu-id="34ce1-208">A watchdog could monitor the share to ensure that enough space is available.</span></span> <span data-ttu-id="34ce1-209">Può restare in attesa di notifiche relative a modifiche di file o directory.</span><span class="sxs-lookup"><span data-stu-id="34ce1-209">It could listen for notifications of file or directory changes.</span></span> <span data-ttu-id="34ce1-210">Può segnalare un avviso se si raggiunge una soglia prestabilita e un errore se la condivisione è piena.</span><span class="sxs-lookup"><span data-stu-id="34ce1-210">It could report a warning if an upfront threshold is reached, and report an error if the share is full.</span></span> <span data-ttu-id="34ce1-211">In caso di avviso, un sistema di ripristino può avviare la pulizia dei file meno recenti nella condivisione.</span><span class="sxs-lookup"><span data-stu-id="34ce1-211">On a warning, a repair system could start cleaning up older files on the share.</span></span> <span data-ttu-id="34ce1-212">In caso di errore, un sistema di ripristino può spostare la replica del servizio su un altro nodo.</span><span class="sxs-lookup"><span data-stu-id="34ce1-212">On an error, a repair system could move the service replica to another node.</span></span> <span data-ttu-id="34ce1-213">Si noti come vengono descritti gli stati della condizione in termini di integrità: lo stato della condizione può essere considerato integro (ok) o non integro (avviso o errore).</span><span class="sxs-lookup"><span data-stu-id="34ce1-213">Note how the condition states are described in terms of health: the state of the condition that can be considered healthy (ok) or unhealthy (warning or error).</span></span>

<span data-ttu-id="34ce1-214">Dopo aver impostato i dettagli di monitoraggio, gli sviluppatori del watchdog devono decidere come implementarlo.</span><span class="sxs-lookup"><span data-stu-id="34ce1-214">Once the monitoring details are set, a watchdog writer needs to figure out how to implement the watchdog.</span></span> <span data-ttu-id="34ce1-215">Se è possibile determinare le condizioni dall'interno del servizio, il watchdog può far parte del servizio stesso che viene monitorato.</span><span class="sxs-lookup"><span data-stu-id="34ce1-215">If the conditions can be determined from within the service, the watchdog can be part of the monitored service itself.</span></span> <span data-ttu-id="34ce1-216">Ad esempio, il codice del servizio può controllare l'utilizzo della condivisione e quindi creare un report ogni volta che prova a scrivere un file.</span><span class="sxs-lookup"><span data-stu-id="34ce1-216">For example, the service code can check the share usage, and then report every time it tries to write a file.</span></span> <span data-ttu-id="34ce1-217">Il vantaggio di questo approccio è dato dalla semplicità della creazione di report.</span><span class="sxs-lookup"><span data-stu-id="34ce1-217">The advantage of this approach is that reporting is simple.</span></span> <span data-ttu-id="34ce1-218">È necessario fare attenzione per evitare che gli errori del watchdog influiscano negativamente sulla funzionalità del servizio.</span><span class="sxs-lookup"><span data-stu-id="34ce1-218">Care must be taken to prevent watchdog bugs from impacting the service functionality.</span></span>

<span data-ttu-id="34ce1-219">Non è sempre possibile creare report dall'interno del servizio monitorato.</span><span class="sxs-lookup"><span data-stu-id="34ce1-219">Reporting from within the monitored service is not always an option.</span></span> <span data-ttu-id="34ce1-220">Un watchdog all'interno del servizio potrebbe non riuscire a rilevare le condizioni.</span><span class="sxs-lookup"><span data-stu-id="34ce1-220">A watchdog within the service may not be able to detect the conditions.</span></span> <span data-ttu-id="34ce1-221">Potrebbe non avere la logica o i dati per prendere una decisione.</span><span class="sxs-lookup"><span data-stu-id="34ce1-221">It may not have the logic or data to make the determination.</span></span> <span data-ttu-id="34ce1-222">Il monitoraggio delle condizioni potrebbe comportare un sovraccarico eccessivo.</span><span class="sxs-lookup"><span data-stu-id="34ce1-222">The overhead of monitoring the conditions may be high.</span></span> <span data-ttu-id="34ce1-223">Le condizioni potrebbero anche non essere specifiche di un servizio, ma avere invece ripercussioni sulle interazioni tra i servizi.</span><span class="sxs-lookup"><span data-stu-id="34ce1-223">The conditions also may not be specific to a service, but instead affect interactions between services.</span></span> <span data-ttu-id="34ce1-224">Un'altra opzione consiste nel creare i watchdog nel cluster come processi separati.</span><span class="sxs-lookup"><span data-stu-id="34ce1-224">Another option is to have watchdogs in the cluster as separate processes.</span></span> <span data-ttu-id="34ce1-225">I watchdog eseguono il monitoraggio delle condizioni e generano report, senza influire in alcun modo sui servizi principali.</span><span class="sxs-lookup"><span data-stu-id="34ce1-225">The watchdogs monitor the conditions and report, without affecting the main services in any way.</span></span> <span data-ttu-id="34ce1-226">Ad esempio, questi watchdog possono essere implementati come servizi senza stato nella stessa applicazione, distribuiti in tutti i nodi o negli stessi nodi del servizio.</span><span class="sxs-lookup"><span data-stu-id="34ce1-226">For example, these watchdogs could be implemented as stateless services in the same application, deployed on all nodes or on the same nodes as the service.</span></span>

<span data-ttu-id="34ce1-227">A volte anche un watchdog in esecuzione nel cluster può non essere una soluzione efficace.</span><span class="sxs-lookup"><span data-stu-id="34ce1-227">Sometimes, a watchdog running in the cluster is not an option either.</span></span> <span data-ttu-id="34ce1-228">Se la condizione monitorate è la disponibilità o la funzionalità del servizio dal punto di vista degli utenti, è preferibile inserire i watchdog nella stessa posizione dei client degli utenti,</span><span class="sxs-lookup"><span data-stu-id="34ce1-228">If the monitored condition is the availability or functionality of the service as users see it, it's best to have the watchdogs in the same place as the user clients.</span></span> <span data-ttu-id="34ce1-229">dove possono testare le operazioni allo stesso modo in cui vengono eseguite dagli utenti.</span><span class="sxs-lookup"><span data-stu-id="34ce1-229">There, they can test the operations in the same way users call them.</span></span> <span data-ttu-id="34ce1-230">Ad esempio, è possibile configurare un watchdog esterno al cluster che invia le richieste al servizio e controlla la latenza e la correttezza del risultato.</span><span class="sxs-lookup"><span data-stu-id="34ce1-230">For example, you can have a watchdog that lives outside the cluster, issues requests to the service, and checks the latency and correctness of the result.</span></span> <span data-ttu-id="34ce1-231">Ad esempio, per un servizio calcolatrice, verificare se l'operazione 2+2 restituisce 4 in tempi ragionevoli.</span><span class="sxs-lookup"><span data-stu-id="34ce1-231">(For a calculator service, for example, does 2+2 return 4 in a reasonable amount of time?)</span></span>

<span data-ttu-id="34ce1-232">Una volta finalizzati i dettagli del watchdog, stabilire un ID di origine che lo identifichi in modo univoco.</span><span class="sxs-lookup"><span data-stu-id="34ce1-232">Once the watchdog details have been finalized, you should decide on a source ID that uniquely identifies it.</span></span> <span data-ttu-id="34ce1-233">Se nel cluster sono presenti più watchdog dello stesso tipo, devono generare report per entità diverse oppure, se generano report per la stessa entità, usare proprietà o ID di origine diversi.</span><span class="sxs-lookup"><span data-stu-id="34ce1-233">If multiple watchdogs of the same type are living in the cluster, they must report on different entities, or, if they report on the same entity, use different source ID or property.</span></span> <span data-ttu-id="34ce1-234">In questo modo, i report possono coesistere.</span><span class="sxs-lookup"><span data-stu-id="34ce1-234">This way, their reports can coexist.</span></span> <span data-ttu-id="34ce1-235">La proprietà del report sull'integrità deve contenere la condizione monitorata.</span><span class="sxs-lookup"><span data-stu-id="34ce1-235">The property of the health report should capture the monitored condition.</span></span> <span data-ttu-id="34ce1-236">Ad esempio, nel caso sopra riportato la proprietà può essere **ShareSize**. Se più report si applicano alla stessa condizione, la proprietà deve contenere alcune informazioni dinamiche per consentire la coesistenza dei report.</span><span class="sxs-lookup"><span data-stu-id="34ce1-236">(For the example above, the property could be **ShareSize**.) If multiple reports apply to the same condition, the property should contain some dynamic information that allows reports to coexist.</span></span> <span data-ttu-id="34ce1-237">Ad esempio, se è necessario monitorare più condivisioni, il nome della proprietà può essere **ShareSize-sharename**.</span><span class="sxs-lookup"><span data-stu-id="34ce1-237">For example, if multiple shares need to be monitored, the property name can be **ShareSize-sharename**.</span></span>

> [!NOTE]
> <span data-ttu-id="34ce1-238">*Non* usare l'archivio integrità per conservare informazioni sullo stato.</span><span class="sxs-lookup"><span data-stu-id="34ce1-238">Do *not* use the health store to keep status information.</span></span> <span data-ttu-id="34ce1-239">Nei report solo le informazioni correlate all'integrità devono essere segnalate come informazioni sull'integrità, perché influiscono sulla valutazione dell'integrità di un'entità.</span><span class="sxs-lookup"><span data-stu-id="34ce1-239">Only health-related information should be reported as health, as this information impacts the health evaluation of an entity.</span></span> <span data-ttu-id="34ce1-240">L'archivio integrità non è stato progettato come archivio per utilizzo generico.</span><span class="sxs-lookup"><span data-stu-id="34ce1-240">The health store was not designed as a general-purpose store.</span></span> <span data-ttu-id="34ce1-241">Usa la logica di valutazione dell'integrità per aggregare tutti i dati nello stato di integrità.</span><span class="sxs-lookup"><span data-stu-id="34ce1-241">It uses health evaluation logic to aggregate all data into the health state.</span></span> <span data-ttu-id="34ce1-242">L'invio di informazioni non correlate all'integrità, come la creazione di report sullo stato con stato di integrità OK, non ha ripercussioni sullo stato di integrità aggregato, ma può influire negativamente sulle prestazioni dell'archivio integrità.</span><span class="sxs-lookup"><span data-stu-id="34ce1-242">Sending information unrelated to health (like reporting status with a health state of OK) doesn't impact the aggregated health state, but it can negatively affect the performance of the health store.</span></span>
> 
> 

<span data-ttu-id="34ce1-243">Il passaggio successivo consiste nel decidere per quale entità creare report.</span><span class="sxs-lookup"><span data-stu-id="34ce1-243">The next decision point is which entity to report on.</span></span> <span data-ttu-id="34ce1-244">Nella maggior parte dei casi, la condizione identifica chiaramente l'entità.</span><span class="sxs-lookup"><span data-stu-id="34ce1-244">Most of the time, the condition clearly idetifies the entity.</span></span> <span data-ttu-id="34ce1-245">Scegliere l'entità con la migliore granularità possibile.</span><span class="sxs-lookup"><span data-stu-id="34ce1-245">Choose the entity with best possible granularity.</span></span> <span data-ttu-id="34ce1-246">Se una condizione influisce su tutte le repliche in una partizione, creare report sulla partizione, non sul servizio.</span><span class="sxs-lookup"><span data-stu-id="34ce1-246">If a condition impacts all replicas in a partition, report on the partition, not on the service.</span></span> <span data-ttu-id="34ce1-247">Esistono tuttavia casi particolari che richiedono maggiore attenzione.</span><span class="sxs-lookup"><span data-stu-id="34ce1-247">There are corner cases where more thought is needed, though.</span></span> <span data-ttu-id="34ce1-248">Se la condizione influisce su un'entità, ad esempio una replica, ma si vuole segnalare la condizione per un tempo superiore alla durata della replica, è necessario creare report sulla partizione.</span><span class="sxs-lookup"><span data-stu-id="34ce1-248">If the condition impacts an entity, such as a replica, but the desire is to have the condition flagged for more than the duration of replica life, then it should be reported on the partition.</span></span> <span data-ttu-id="34ce1-249">In caso contrario, quando la replica viene eliminata, l'archivio integrità pulisce tutti i relativi report.</span><span class="sxs-lookup"><span data-stu-id="34ce1-249">Otherwise, when the replica is deleted, the health store cleans up all its reports.</span></span> <span data-ttu-id="34ce1-250">Gli sviluppatori dei watchdog devono considerare la durata dell'entità e del report.</span><span class="sxs-lookup"><span data-stu-id="34ce1-250">Watchdog writers must think about the lifetimes of the entity and the report.</span></span> <span data-ttu-id="34ce1-251">È necessario specificare chiaramente quando rimuovere un report da un archivio, ad esempio quando un errore segnalato per un'entità non si verifica più.</span><span class="sxs-lookup"><span data-stu-id="34ce1-251">It must be clear when a report should be cleaned up from a store (for example, when an error reported on an entity no longer applies).</span></span>

<span data-ttu-id="34ce1-252">L'esempio seguente illustra i punti descritti.</span><span class="sxs-lookup"><span data-stu-id="34ce1-252">Let's look at an example that puts together the points I described.</span></span> <span data-ttu-id="34ce1-253">Si consideri un'applicazione di Service Fabric composta da un servizio master con stato persistente e servizi secondari senza stato distribuiti in tutti i nodi, ovvero un tipo di servizio secondario per ogni tipo di attività.</span><span class="sxs-lookup"><span data-stu-id="34ce1-253">Consider a Service Fabric application composed of a master stateful persistent service and secondary stateless services deployed on all nodes (one secondary service type for each type of task).</span></span> <span data-ttu-id="34ce1-254">Il servizio master ha una coda di elaborazione con i comandi che devono essere eseguiti dai servizi secondari.</span><span class="sxs-lookup"><span data-stu-id="34ce1-254">The master has a processing queue that contains commands to be executed by secondaries.</span></span> <span data-ttu-id="34ce1-255">I servizi secondari eseguono le richieste in ingresso e restituiscono segnali di conferma.</span><span class="sxs-lookup"><span data-stu-id="34ce1-255">The secondaries execute the incoming requests and send back acknowledgement signals.</span></span> <span data-ttu-id="34ce1-256">Una condizione che è possibile monitorare è la lunghezza della coda di elaborazione del servizio master.</span><span class="sxs-lookup"><span data-stu-id="34ce1-256">One condition that could be monitored is the length of the master processing queue.</span></span> <span data-ttu-id="34ce1-257">Se la lunghezza della coda master raggiunge una soglia, viene generato un avviso.</span><span class="sxs-lookup"><span data-stu-id="34ce1-257">If the master queue length reaches a threshold, a warning is reported.</span></span> <span data-ttu-id="34ce1-258">L'avviso indica che i servizi secondari non possono gestire il carico.</span><span class="sxs-lookup"><span data-stu-id="34ce1-258">The warning indicates that the secondaries can't handle the load.</span></span> <span data-ttu-id="34ce1-259">Se la coda raggiunge la lunghezza massima e i comandi vengono eliminati, viene generato un errore perché il servizio non può essere ripristinato.</span><span class="sxs-lookup"><span data-stu-id="34ce1-259">If the queue reaches the maximum length and commands are dropped, an error is reported, as the service can't recover.</span></span> <span data-ttu-id="34ce1-260">I report possono riguardare la proprietà **QueueStatus**.</span><span class="sxs-lookup"><span data-stu-id="34ce1-260">The reports can be on the property **QueueStatus**.</span></span> <span data-ttu-id="34ce1-261">Il watchdog si trova all'interno del servizio e viene inviato periodicamente alla replica primaria del servizio master.</span><span class="sxs-lookup"><span data-stu-id="34ce1-261">The watchdog lives inside the service, and it's sent periodically on the master primary replica.</span></span> <span data-ttu-id="34ce1-262">La durata (TTL) è di 2 minuti e l'invio avviene periodicamente ogni 30 secondi.</span><span class="sxs-lookup"><span data-stu-id="34ce1-262">The time to live is two minutes, and it's sent periodically every 30 seconds.</span></span> <span data-ttu-id="34ce1-263">Se il servizio primario diventa inattivo, il report viene eliminato automaticamente dall'archivio.</span><span class="sxs-lookup"><span data-stu-id="34ce1-263">If the primary goes down, the report is cleaned up automatically from store.</span></span> <span data-ttu-id="34ce1-264">Se la replica del servizio è attiva ma presenta un deadlock o altri problemi, il report scade nell'archivio integrità.</span><span class="sxs-lookup"><span data-stu-id="34ce1-264">If the service replica is up, but it is deadlocked or having other issues, the report expires in the health store.</span></span> <span data-ttu-id="34ce1-265">In questo caso, l'entità viene considerata in stato di errore.</span><span class="sxs-lookup"><span data-stu-id="34ce1-265">In this case, the entity is evaluated at error.</span></span>

<span data-ttu-id="34ce1-266">Un'altra condizione che può essere monitorata è il tempo di esecuzione delle attività.</span><span class="sxs-lookup"><span data-stu-id="34ce1-266">Another condition that can be monitored is task execution time.</span></span> <span data-ttu-id="34ce1-267">Il servizio master distribuisce le attività ai server secondari in base al tipo di attività.</span><span class="sxs-lookup"><span data-stu-id="34ce1-267">The master distributes tasks to the secondaries based on the task type.</span></span> <span data-ttu-id="34ce1-268">A seconda della progettazione, il servizio master può eseguire il polling dei servizi secondari per quanto riguarda lo stato delle attività.</span><span class="sxs-lookup"><span data-stu-id="34ce1-268">Depending on the design, the master could poll the secondaries for task status.</span></span> <span data-ttu-id="34ce1-269">Può anche attendere che i servizi secondari inviino segnali di conferma al termine dell'operazione.</span><span class="sxs-lookup"><span data-stu-id="34ce1-269">It could also wait for secondaries to send back acknowledgement signals when they are done.</span></span> <span data-ttu-id="34ce1-270">Nel secondo caso, è necessario prestare attenzione a individuare le situazioni in cui i servizi secondari vengono interrotti o i messaggi vengono persi.</span><span class="sxs-lookup"><span data-stu-id="34ce1-270">In the second case, care must be taken to detect situations where secondaries die or messages are lost.</span></span> <span data-ttu-id="34ce1-271">Un'opzione consiste nell'invio di una richiesta ping da parte del master allo stesso servizio secondario, che restituisce lo stato.</span><span class="sxs-lookup"><span data-stu-id="34ce1-271">One option is for the master to send a ping request to the same secondary, which sends back its status.</span></span> <span data-ttu-id="34ce1-272">Se non riceve alcuno stato, il master lo considera un errore e ripianifica l'attività.</span><span class="sxs-lookup"><span data-stu-id="34ce1-272">If no status is received, the master considers it a failure and reschedules the task.</span></span> <span data-ttu-id="34ce1-273">Questo comportamento presuppone che le attività siano idempotenti.</span><span class="sxs-lookup"><span data-stu-id="34ce1-273">This behavior assumes that the tasks are idempotent.</span></span>

<span data-ttu-id="34ce1-274">La condizione monitorata può essere riportata come avviso se l'attività non viene eseguita entro un certo periodo di tempo **t1**, ad esempio, 10 minuti.</span><span class="sxs-lookup"><span data-stu-id="34ce1-274">The monitored condition can be translated as a warning if the task is not done in a certain time (**t1**, for example 10 minutes).</span></span> <span data-ttu-id="34ce1-275">La condizione monitorata può essere riportata come errore se l'attività non viene completata entro il periodo di tempo **t2**, ad esempio, 20 minuti.</span><span class="sxs-lookup"><span data-stu-id="34ce1-275">If the task is not completed in time (**t2**, for example 20 minutes), the monitored condition can be translated as Error.</span></span> <span data-ttu-id="34ce1-276">Questo tipo di report può essere creato in diversi modi:</span><span class="sxs-lookup"><span data-stu-id="34ce1-276">This reporting can be done in multiple ways:</span></span>

* <span data-ttu-id="34ce1-277">La replica primaria del servizio master genera periodicamente report su se stessa.</span><span class="sxs-lookup"><span data-stu-id="34ce1-277">The master primary replica reports on itself periodically.</span></span> <span data-ttu-id="34ce1-278">È possibile configurare una proprietà per tutte le attività in sospeso nella coda.</span><span class="sxs-lookup"><span data-stu-id="34ce1-278">You can have one property for all pending tasks in the queue.</span></span> <span data-ttu-id="34ce1-279">Se almeno una delle attività richiede più tempo, lo stato del report sulla proprietà **PendingTasks** è un avviso o errore, secondo il caso.</span><span class="sxs-lookup"><span data-stu-id="34ce1-279">If at least one task takes longer, the report status on the property **PendingTasks** is a warning or error, as appropriate.</span></span> <span data-ttu-id="34ce1-280">Se non sono presenti attività in sospeso o è stata avviata l'esecuzione di tutte le attività, viene segnalato uno stato integro.</span><span class="sxs-lookup"><span data-stu-id="34ce1-280">If there are no pending tasks or all tasks started execution, the report status is OK.</span></span> <span data-ttu-id="34ce1-281">Le attività sono persistenti.</span><span class="sxs-lookup"><span data-stu-id="34ce1-281">The tasks are persistent.</span></span> <span data-ttu-id="34ce1-282">Se il servizio primario si arresta, il nuovo servizio alzato di livello al ruolo di primario può continuare a generare report correttamente.</span><span class="sxs-lookup"><span data-stu-id="34ce1-282">If the primary goes down, the newly promoted primary can continue to report properly.</span></span>
* <span data-ttu-id="34ce1-283">Un altro processo di watchdog, nel cloud o esterno, verifica le attività dall'esterno, in base al risultato desiderato per l'attività, per controllare se sono state completate.</span><span class="sxs-lookup"><span data-stu-id="34ce1-283">Another watchdog process (in the cloud or external) checks the tasks (from outside, based on the desired task result) to see if they are completed.</span></span> <span data-ttu-id="34ce1-284">Se non rispettano le soglie, viene inviato un report sul servizio master.</span><span class="sxs-lookup"><span data-stu-id="34ce1-284">If they do not respect the thresholds, a report is sent on the master service.</span></span> <span data-ttu-id="34ce1-285">Viene inviato anche un report per ogni attività che include l'identificatore dell'attività, ad esempio **PendingTask+taskId**.</span><span class="sxs-lookup"><span data-stu-id="34ce1-285">A report is also sent on each task that includes the task identifier, like **PendingTask+taskId**.</span></span> <span data-ttu-id="34ce1-286">I report dovranno essere inviati solo sugli stati non integri.</span><span class="sxs-lookup"><span data-stu-id="34ce1-286">Reports should be sent only on unhealthy states.</span></span> <span data-ttu-id="34ce1-287">Impostare la durata (TTL) su alcuni minuti e contrassegnare i report da rimuovere alla scadenza, per garantire la pulizia.</span><span class="sxs-lookup"><span data-stu-id="34ce1-287">Set time to live to a few minutes, and mark the reports to be removed when they expire to ensure cleanup.</span></span>
* <span data-ttu-id="34ce1-288">Il servizio secondario che esegue un'attività segnala quando l'esecuzione richiede più tempo del previsto.</span><span class="sxs-lookup"><span data-stu-id="34ce1-288">The secondary that is executing a task reports when it takes longer than expected to run it.</span></span> <span data-ttu-id="34ce1-289">La segnalazione riguarda l'istanza del servizio della proprietà **PendingTasks**.</span><span class="sxs-lookup"><span data-stu-id="34ce1-289">It reports on the service instance on the property **PendingTasks**.</span></span> <span data-ttu-id="34ce1-290">Il report individua l'istanza del servizio che presenta problemi, ma allo scadere dell'istanza non consente di valutare la situazione,</span><span class="sxs-lookup"><span data-stu-id="34ce1-290">The report pinpoints the service instance that has issues, but it doesn't capture the situation where the instance dies.</span></span> <span data-ttu-id="34ce1-291">perché i report vengono eliminati.</span><span class="sxs-lookup"><span data-stu-id="34ce1-291">The reports are cleaned up then.</span></span> <span data-ttu-id="34ce1-292">È possibile creare report sul servizio secondario.</span><span class="sxs-lookup"><span data-stu-id="34ce1-292">It could report on the secondary service.</span></span> <span data-ttu-id="34ce1-293">Se l'attività viene completata, l'istanza del servizio secondario elimina il report dall'archivio.</span><span class="sxs-lookup"><span data-stu-id="34ce1-293">If the secondary completes the task, the secondary instance clears the report from the store.</span></span> <span data-ttu-id="34ce1-294">Il report non permette di valutare la situazione se il messaggio di acknowledgement viene perso e l'attività non viene completata dal punto di vista del master.</span><span class="sxs-lookup"><span data-stu-id="34ce1-294">The report doesn't capture the situation where the acknowledgement message is lost and the task is not finished from the master's point of view.</span></span>

<span data-ttu-id="34ce1-295">Se però la creazione di report viene eseguita nei casi descritti sopra, i report vengono acquisiti nell'integrità dell'applicazione quando questa viene valutata.</span><span class="sxs-lookup"><span data-stu-id="34ce1-295">However the reporting is done in the cases described above, the reports are captured in application health when health is evaluated.</span></span>

## <a name="report-periodically-vs-on-transition"></a><span data-ttu-id="34ce1-296">Report periodici e report in caso di transizione a confronto</span><span class="sxs-lookup"><span data-stu-id="34ce1-296">Report periodically vs. on transition</span></span>
<span data-ttu-id="34ce1-297">Usando il modello di report sull'integrità, i watchdog possono inviare report periodicamente o in caso di transizioni.</span><span class="sxs-lookup"><span data-stu-id="34ce1-297">By using the health reporting model, watchdogs can send reports periodically or on transitions.</span></span> <span data-ttu-id="34ce1-298">Nel caso dei report watchdog, è consigliabile inviarli periodicamente, perché il codice è molto più semplice e meno soggetto a errori.</span><span class="sxs-lookup"><span data-stu-id="34ce1-298">The recommended way for watchdog reporting is periodically, because the code is much simpler and less prone to errors.</span></span> <span data-ttu-id="34ce1-299">I watchdog devono essere più semplici possibile per evitare bug che generano report non corretti.</span><span class="sxs-lookup"><span data-stu-id="34ce1-299">The watchdogs must strive to be as simple as possible to avoid bugs that trigger incorrect reports.</span></span> <span data-ttu-id="34ce1-300">Eventuali report che segnalano erroneamente la *mancata integrità* influiscono sulla valutazione dell'integrità e sugli scenari basati sull'integrità, inclusi gli aggiornamenti.</span><span class="sxs-lookup"><span data-stu-id="34ce1-300">Incorrect *unhealthy* reports impact health evaluations and scenarios based on health, including upgrades.</span></span> <span data-ttu-id="34ce1-301">I report che segnalano erroneamente la *mancata integrità* hanno l'effetto di nascondere problemi del cluster ed è quindi opportuno evitare che vengano generati.</span><span class="sxs-lookup"><span data-stu-id="34ce1-301">Incorrect *healthy* reports hide issues in the cluster, which is not desired.</span></span>

<span data-ttu-id="34ce1-302">Per i report periodici, il watchdog può essere implementato con un timer.</span><span class="sxs-lookup"><span data-stu-id="34ce1-302">For periodic reporting, the watchdog can be implemented with a timer.</span></span> <span data-ttu-id="34ce1-303">In caso di callback del timer, il watchdog può controllare lo stato e inviare un report in base allo stato corrente.</span><span class="sxs-lookup"><span data-stu-id="34ce1-303">On a timer callback, the watchdog can check the state and send a report based on the current state.</span></span> <span data-ttu-id="34ce1-304">Non è necessario visualizzare il report inviato in precedenza o eseguire ottimizzazioni in termini di messaggistica.</span><span class="sxs-lookup"><span data-stu-id="34ce1-304">There is no need to see which report was sent previously or make any optimizations in terms of messaging.</span></span> <span data-ttu-id="34ce1-305">Ai fini delle prestazioni, il client di integrità è dotato di logica per l'invio in batch.</span><span class="sxs-lookup"><span data-stu-id="34ce1-305">The health client has batching logic to help with performance.</span></span> <span data-ttu-id="34ce1-306">Finché il client di integrità viene mantenuto attivo, esegue nuovi tentativi internamente finché il report non riceve un acknowledgement dall'archivio integrità o il watchdog genera un report più recente con entità, proprietà e origine identiche.</span><span class="sxs-lookup"><span data-stu-id="34ce1-306">While the health client is kept alive, it retries internally until the report is acknowledged by the health store or the watchdog generates a newer report with the same entity, property, and source.</span></span>

<span data-ttu-id="34ce1-307">La creazione di report in caso di transizioni richiede una gestione attenta dello stato.</span><span class="sxs-lookup"><span data-stu-id="34ce1-307">Reporting on transitions requires careful handling of state.</span></span> <span data-ttu-id="34ce1-308">Il watchdog esegue il monitoraggio di alcune condizioni e segnala soltanto eventuali modifiche di tali condizioni.</span><span class="sxs-lookup"><span data-stu-id="34ce1-308">The watchdog monitors some conditions and reports only when the conditions change.</span></span> <span data-ttu-id="34ce1-309">Il lato positivo di questo approccio è che sono necessari meno report.</span><span class="sxs-lookup"><span data-stu-id="34ce1-309">The upside of this approach is that fewer reports are needed.</span></span> <span data-ttu-id="34ce1-310">Il lato negativo è che la logica del watchdog è complessa.</span><span class="sxs-lookup"><span data-stu-id="34ce1-310">The downside is that the logic of the watchdog is complex.</span></span> <span data-ttu-id="34ce1-311">È necessario che il watchdog mantenga le condizioni o i report per poterli esaminare e determinare i cambiamenti di stato.</span><span class="sxs-lookup"><span data-stu-id="34ce1-311">The watchdog must maintain the conditions or the reports, so that they can be inspected to determine state changes.</span></span> <span data-ttu-id="34ce1-312">In caso di failover, fare attenzione ai report aggiunti, ma non ancora inviati all'archivio integrità.</span><span class="sxs-lookup"><span data-stu-id="34ce1-312">On failover, care must be taken with reports added, but not yet sent to the health store.</span></span> <span data-ttu-id="34ce1-313">Il numero di sequenza deve essere crescente.</span><span class="sxs-lookup"><span data-stu-id="34ce1-313">The sequence number must be ever-increasing.</span></span> <span data-ttu-id="34ce1-314">In caso contrario, i report verranno rifiutati come non aggiornati.</span><span class="sxs-lookup"><span data-stu-id="34ce1-314">If not, the reports are rejected as stale.</span></span> <span data-ttu-id="34ce1-315">Nei rari casi in cui si verifica una perdita di dati, potrebbe essere necessaria la sincronizzazione tra lo stato del reporter e quello dell'archivio integrità.</span><span class="sxs-lookup"><span data-stu-id="34ce1-315">In the rare cases where data loss is incurred, synchronization may be needed between the state of the reporter and the state of the health store.</span></span>

<span data-ttu-id="34ce1-316">La creazione di report relativi alle transizioni risulta utile per i servizi che inviano report relativi a se stessi, tramite `Partition` o `CodePackageActivationContext`.</span><span class="sxs-lookup"><span data-stu-id="34ce1-316">Reporting on transitions makes sense for services reporting on themselves, through `Partition` or `CodePackageActivationContext`.</span></span> <span data-ttu-id="34ce1-317">Quando viene rimosso l'oggetto locale, ovvero una replica o un pacchetto del servizio distribuito oppure un'applicazione distribuita, vengono rimossi anche tutti i rispettivi report.</span><span class="sxs-lookup"><span data-stu-id="34ce1-317">When the local object (replica or deployed service package / deployed application) is removed, all its reports are also removed.</span></span> <span data-ttu-id="34ce1-318">Grazie a questa pulizia automatica, non è strettamente necessario eseguire la sincronizzazione tra il generatore di report e l'archivio integrità.</span><span class="sxs-lookup"><span data-stu-id="34ce1-318">This automatic cleanup relaxes the need for synchronization between reporter and health store.</span></span> <span data-ttu-id="34ce1-319">Se il report è relativo a una partizione o un'applicazione padre, è necessario prestare attenzione in caso di failover, in modo da evitare report obsoleti nell'archivio integrità.</span><span class="sxs-lookup"><span data-stu-id="34ce1-319">If the report is for parent partition or parent application, care must be taken on failover to avoid stale reports in the health store.</span></span> <span data-ttu-id="34ce1-320">Occorre aggiungere la logica per mantenere lo stato corretto e cancellare il report dall'archivio quando non è più necessario.</span><span class="sxs-lookup"><span data-stu-id="34ce1-320">Logic must be added to maintain the correct state and clear the report from store when not needed anymore.</span></span>

## <a name="implement-health-reporting"></a><span data-ttu-id="34ce1-321">Implementare report sull'integrità</span><span class="sxs-lookup"><span data-stu-id="34ce1-321">Implement health reporting</span></span>
<span data-ttu-id="34ce1-322">Dopo aver definito l'entità e i dettagli del report, l'invio dei report sull'integrità può essere eseguito tramite API, PowerShell o REST.</span><span class="sxs-lookup"><span data-stu-id="34ce1-322">Once the entity and report details are clear, sending health reports can be done through the API, PowerShell, or REST.</span></span>

### <a name="api"></a><span data-ttu-id="34ce1-323">API</span><span class="sxs-lookup"><span data-stu-id="34ce1-323">API</span></span>
<span data-ttu-id="34ce1-324">Per usare un'API, è necessario creare un report sull'integrità specifico per il tipo di entità desiderato.</span><span class="sxs-lookup"><span data-stu-id="34ce1-324">To report through the API, you need to create a health report specific to the entity type they want to report on.</span></span> <span data-ttu-id="34ce1-325">Assegnare il report a un client di integrità.</span><span class="sxs-lookup"><span data-stu-id="34ce1-325">Give the report to a health client.</span></span> <span data-ttu-id="34ce1-326">In alternativa, creare informazioni sull'integrità e passarle ai metodi di creazione report corretti in `Partition` o `CodePackageActivationContext` per generare report sulle entità correnti.</span><span class="sxs-lookup"><span data-stu-id="34ce1-326">Alternatively, create a health information and pass it to correct reporting methods on `Partition` or `CodePackageActivationContext` to report on current entities.</span></span>

<span data-ttu-id="34ce1-327">L'esempio seguente illustra la generazione periodica di report da un watchdog all'interno del cluster.</span><span class="sxs-lookup"><span data-stu-id="34ce1-327">The following example shows periodic reporting from a watchdog within the cluster.</span></span> <span data-ttu-id="34ce1-328">I controlli del watchdog determinano se è possibile accedere a una risorsa esterna dall'interno di un nodo.</span><span class="sxs-lookup"><span data-stu-id="34ce1-328">The watchdog checks whether an external resource can be accessed from within a node.</span></span> <span data-ttu-id="34ce1-329">La risorsa è richiesta da un manifesto del servizio all'interno dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="34ce1-329">The resource is needed by a service manifest within the application.</span></span> <span data-ttu-id="34ce1-330">Se la risorsa non è disponibile, gli altri servizi all'interno dell'applicazione possono comunque funzionare correttamente.</span><span class="sxs-lookup"><span data-stu-id="34ce1-330">If the resource is unavailable, the other services within the application can still function properly.</span></span> <span data-ttu-id="34ce1-331">Il report viene quindi inviato per l'entità del pacchetto del servizio distribuito ogni 30 secondi.</span><span class="sxs-lookup"><span data-stu-id="34ce1-331">Therefore, the report is sent on the deployed service package entity every 30 seconds.</span></span>

```csharp
private static Uri ApplicationName = new Uri("fabric:/WordCount");
private static string ServiceManifestName = "WordCount.Service";
private static string NodeName = FabricRuntime.GetNodeContext().NodeName;
private static Timer ReportTimer = new Timer(new TimerCallback(SendReport), null, 30 * 1000, 30 * 1000);
private static FabricClient Client = new FabricClient(new FabricClientSettings() { HealthReportSendInterval = TimeSpan.FromSeconds(0) });

public static void SendReport(object obj)
{
    // Test whether the resource can be accessed from the node
    HealthState healthState = this.TestConnectivityToExternalResource();

    // Send report on deployed service package, as the connectivity is needed by the specific service manifest
    // and can be different on different nodes
    var deployedServicePackageHealthReport = new DeployedServicePackageHealthReport(
        ApplicationName,
        ServiceManifestName,
        NodeName,
        new HealthInformation("ExternalSourceWatcher", "Connectivity", healthState));

    // TODO: handle exception. Code omitted for snippet brevity.
    // Possible exceptions: FabricException with error codes
    // FabricHealthStaleReport (non-retryable, the report is already queued on the health client),
    // FabricHealthMaxReportsReached (retryable; user should retry with exponential delay until the report is accepted).
    Client.HealthManager.ReportHealth(deployedServicePackageHealthReport);
}
```

### <a name="powershell"></a><span data-ttu-id="34ce1-332">PowerShell</span><span class="sxs-lookup"><span data-stu-id="34ce1-332">PowerShell</span></span>
<span data-ttu-id="34ce1-333">Inviare report sull'integrità con **Send-ServiceFabric*TipoEntità*HealthReport**.</span><span class="sxs-lookup"><span data-stu-id="34ce1-333">Send health reports with **Send-ServiceFabric*EntityType*HealthReport**.</span></span>

<span data-ttu-id="34ce1-334">L'esempio seguente illustra la generazione di report periodica sui valori della CPU in un nodo.</span><span class="sxs-lookup"><span data-stu-id="34ce1-334">The following example shows periodic reporting on CPU values on a node.</span></span> <span data-ttu-id="34ce1-335">I report devono essere inviati ogni 30 secondi e hanno una durata (TTL) di 2 minuti.</span><span class="sxs-lookup"><span data-stu-id="34ce1-335">The reports should be sent every 30 seconds, and they have a time to live of two minutes.</span></span> <span data-ttu-id="34ce1-336">Se scadono, nel reporter sono presenti problemi e quindi il nodo viene considerato in stato di errore.</span><span class="sxs-lookup"><span data-stu-id="34ce1-336">If they expire, the reporter has issues, so the node is evaluated at error.</span></span> <span data-ttu-id="34ce1-337">Quando la CPU è oltre la soglia specificata, il report presenta uno stato di integrità di tipo avviso.</span><span class="sxs-lookup"><span data-stu-id="34ce1-337">When the CPU is above a threshold, the report has a health state of warning.</span></span> <span data-ttu-id="34ce1-338">Quando la CPU rimane oltre la soglia specificata per più di tempo di quello configurato, verrà segnalato come errore.</span><span class="sxs-lookup"><span data-stu-id="34ce1-338">When the CPU remains above a threshold for more than the configured time, it's reported as an error.</span></span> <span data-ttu-id="34ce1-339">In caso contrario, il reporter invia uno stato di integrità corretto.</span><span class="sxs-lookup"><span data-stu-id="34ce1-339">Otherwise, the reporter sends a health state of OK.</span></span>

```powershell
PS C:\> Send-ServiceFabricNodeHealthReport -NodeName Node.1 -HealthState Warning -SourceId PowershellWatcher -HealthProperty CPU -Description "CPU is above 80% threshold" -TimeToLiveSec 120

PS C:\> Get-ServiceFabricNodeHealth -NodeName Node.1
NodeName              : Node.1
AggregatedHealthState : Warning
UnhealthyEvaluations  :
                        Unhealthy event: SourceId='PowershellWatcher', Property='CPU', HealthState='Warning', ConsiderWarningAsError=false.

HealthEvents          :
                        SourceId              : System.FM
                        Property              : State
                        HealthState           : Ok
                        SequenceNumber        : 5
                        SentAt                : 4/21/2015 8:01:17 AM
                        ReceivedAt            : 4/21/2015 8:02:12 AM
                        TTL                   : Infinite
                        Description           : Fabric node is up.
                        RemoveWhenExpired     : False
                        IsExpired             : False
                        Transitions           : ->Ok = 4/21/2015 8:02:12 AM

                        SourceId              : PowershellWatcher
                        Property              : CPU
                        HealthState           : Warning
                        SequenceNumber        : 130741236814913394
                        SentAt                : 4/21/2015 9:01:21 PM
                        ReceivedAt            : 4/21/2015 9:01:21 PM
                        TTL                   : 00:02:00
                        Description           : CPU is above 80% threshold
                        RemoveWhenExpired     : False
                        IsExpired             : False
                        Transitions           : ->Warning = 4/21/2015 9:01:21 PM
```

<span data-ttu-id="34ce1-340">L'esempio seguente segnala un avviso temporaneo in una replica.</span><span class="sxs-lookup"><span data-stu-id="34ce1-340">The following example reports a transient warning on a replica.</span></span> <span data-ttu-id="34ce1-341">Ottiene prima di tutto l'ID della partizione e quindi all'ID della replica per il servizio interessato.</span><span class="sxs-lookup"><span data-stu-id="34ce1-341">It first gets the partition ID and then the replica ID for the service it is interested in.</span></span> <span data-ttu-id="34ce1-342">Invia quindi un report da **PowershellWatcher** sulla proprietà **ResourceDependency**.</span><span class="sxs-lookup"><span data-stu-id="34ce1-342">It then sends a report from **PowershellWatcher** on the property **ResourceDependency**.</span></span> <span data-ttu-id="34ce1-343">Il report è valido solo per due minuti e viene rimosso automaticamente dall'archivio.</span><span class="sxs-lookup"><span data-stu-id="34ce1-343">The report is of interest for only two minutes, and it is removed from the store automatically.</span></span>

```powershell
PS C:\> $partitionId = (Get-ServiceFabricPartition -ServiceName fabric:/WordCount/WordCount.Service).PartitionId

PS C:\> $replicaId = (Get-ServiceFabricReplica -PartitionId $partitionId | where {$_.ReplicaRole -eq "Primary"}).ReplicaId

PS C:\> Send-ServiceFabricReplicaHealthReport -PartitionId $partitionId -ReplicaId $replicaId -HealthState Warning -SourceId PowershellWatcher -HealthProperty ResourceDependency -Description "The external resource that the primary is using has been rebooted at 4/21/2015 9:01:21 PM. Expect processing delays for a few minutes." -TimeToLiveSec 120 -RemoveWhenExpired

PS C:\> Get-ServiceFabricReplicaHealth  -PartitionId $partitionId -ReplicaOrInstanceId $replicaId


PartitionId           : 8f82daff-eb68-4fd9-b631-7a37629e08c0
ReplicaId             : 130740415594605869
AggregatedHealthState : Warning
UnhealthyEvaluations  :
                        Unhealthy event: SourceId='PowershellWatcher', Property='ResourceDependency', HealthState='Warning', ConsiderWarningAsError=false.

HealthEvents          :
                        SourceId              : System.RA
                        Property              : State
                        HealthState           : Ok
                        SequenceNumber        : 130740768777734943
                        SentAt                : 4/21/2015 8:01:17 AM
                        ReceivedAt            : 4/21/2015 8:02:12 AM
                        TTL                   : Infinite
                        Description           : Replica has been created.
                        RemoveWhenExpired     : False
                        IsExpired             : False
                        Transitions           : ->Ok = 4/21/2015 8:02:12 AM

                        SourceId              : PowershellWatcher
                        Property              : ResourceDependency
                        HealthState           : Warning
                        SequenceNumber        : 130741243777723555
                        SentAt                : 4/21/2015 9:12:57 PM
                        ReceivedAt            : 4/21/2015 9:12:57 PM
                        TTL                   : 00:02:00
                        Description           : The external resource that the primary is using has been rebooted at 4/21/2015 9:01:21 PM. Expect processing delays for a few minutes.
                        RemoveWhenExpired     : True
                        IsExpired             : False
                        Transitions           : ->Warning = 4/21/2015 9:12:32 PM
```

### <a name="rest"></a><span data-ttu-id="34ce1-344">REST</span><span class="sxs-lookup"><span data-stu-id="34ce1-344">REST</span></span>
<span data-ttu-id="34ce1-345">Inviare report sull'integrità usando REST con richieste POST indirizzate all'entità desiderata e contenenti nel corpo la descrizione del report sull'integrità.</span><span class="sxs-lookup"><span data-stu-id="34ce1-345">Send health reports using REST with POST requests that go to the desired entity and have in the body the health report description.</span></span> <span data-ttu-id="34ce1-346">Vedere ad esempio come inviare [report sull'integrità di un cluster](https://docs.microsoft.com/rest/api/servicefabric/report-the-health-of-a-cluster) o [report sull'integrità di un servizio](https://docs.microsoft.com/rest/api/servicefabric/report-the-health-of-a-service) con REST.</span><span class="sxs-lookup"><span data-stu-id="34ce1-346">For example, see how to send REST [cluster health reports](https://docs.microsoft.com/rest/api/servicefabric/report-the-health-of-a-cluster) or [service health reports](https://docs.microsoft.com/rest/api/servicefabric/report-the-health-of-a-service).</span></span> <span data-ttu-id="34ce1-347">Sono supportate tutte le entità.</span><span class="sxs-lookup"><span data-stu-id="34ce1-347">All entities are supported.</span></span>

## <a name="next-steps"></a><span data-ttu-id="34ce1-348">Passaggi successivi</span><span class="sxs-lookup"><span data-stu-id="34ce1-348">Next steps</span></span>
<span data-ttu-id="34ce1-349">In base ai dati sull'integrità, gli sviluppatori del servizio e gli amministratori di cluster e applicazioni possono valutare come usare le informazioni.</span><span class="sxs-lookup"><span data-stu-id="34ce1-349">Based on the health data, service writers and cluster/application administrators can think of ways to consume the information.</span></span> <span data-ttu-id="34ce1-350">Ad esempio, è possibile impostare avvisi in base allo stato integrità per rilevare problemi gravi prima che provochino interruzioni.</span><span class="sxs-lookup"><span data-stu-id="34ce1-350">For example, they can set up alerts based on health status to catch severe issues before they provoke outages.</span></span> <span data-ttu-id="34ce1-351">Gli amministratori possono anche configurare sistemi di ripristino per risolvere i problemi automaticamente.</span><span class="sxs-lookup"><span data-stu-id="34ce1-351">Administrators can also set up repair systems to fix issues automatically.</span></span>

[<span data-ttu-id="34ce1-352">Introduzione al monitoraggio dell'integrità di Service Fabric</span><span class="sxs-lookup"><span data-stu-id="34ce1-352">Introduction to Service Fabric health Monitoring</span></span>](service-fabric-health-introduction.md)

[<span data-ttu-id="34ce1-353">Come visualizzare i report sull'integrità di Service Fabric</span><span class="sxs-lookup"><span data-stu-id="34ce1-353">View Service Fabric health reports</span></span>](service-fabric-view-entities-aggregated-health.md)

[<span data-ttu-id="34ce1-354">Creare report e verificare l'integrità dei servizi</span><span class="sxs-lookup"><span data-stu-id="34ce1-354">How to report and check service health</span></span>](service-fabric-diagnostics-how-to-report-and-check-service-health.md)

[<span data-ttu-id="34ce1-355">Uso dei report sull'integrità del sistema per la risoluzione dei problemi</span><span class="sxs-lookup"><span data-stu-id="34ce1-355">Use system health reports for troubleshooting</span></span>](service-fabric-understand-and-troubleshoot-with-system-health-reports.md)

[<span data-ttu-id="34ce1-356">Monitorare e diagnosticare servizi in locale</span><span class="sxs-lookup"><span data-stu-id="34ce1-356">Monitor and diagnose services locally</span></span>](service-fabric-diagnostics-how-to-monitor-and-diagnose-services-locally.md)

[<span data-ttu-id="34ce1-357">Aggiornamento di un'applicazione di infrastruttura di servizi</span><span class="sxs-lookup"><span data-stu-id="34ce1-357">Service Fabric application upgrade</span></span>](service-fabric-application-upgrade.md)

