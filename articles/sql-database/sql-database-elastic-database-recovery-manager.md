---
title: problemi di mapping aaaUsing toofix di gestione del ripristino di partizioni | Documenti Microsoft
description: Utilizzare hello RecoveryManager classe toosolve problemi mappe partizioni
services: sql-database
documentationcenter: 
manager: jhubbard
author: ddove
ms.assetid: 45520ca3-6903-4b39-88ba-1d41b22da9fe
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 10/25/2016
ms.author: ddove
ms.openlocfilehash: 2218fb15122f1df466e65483480461e366317f2f
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 10/06/2017
---
# <a name="using-hello-recoverymanager-class-toofix-shard-map-problems"></a><span data-ttu-id="d651c-103">Utilizzando i problemi di mappa partizioni toofix classe RecoveryManager hello</span><span class="sxs-lookup"><span data-stu-id="d651c-103">Using hello RecoveryManager class toofix shard map problems</span></span>
<span data-ttu-id="d651c-104">Hello [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) fornisce applicazioni ADO.Net hello possibilità tooeasily rilevare e correggere eventuali incoerenze tra mappa di partizioni globale hello (GSM) e mappa di partizioni locali di hello (LSM) in un ambiente di database partizionato.</span><span class="sxs-lookup"><span data-stu-id="d651c-104">hello [RecoveryManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.aspx) class provides ADO.Net applications hello ability tooeasily detect and correct any inconsistencies between hello global shard map (GSM) and hello local shard map (LSM) in a sharded database environment.</span></span> 

<span data-ttu-id="d651c-105">Hello GSM e LSM traccia hello mapping di ogni database in un ambiente partizionato.</span><span class="sxs-lookup"><span data-stu-id="d651c-105">hello GSM and LSM track hello mapping of each database in a sharded environment.</span></span> <span data-ttu-id="d651c-106">In alcuni casi, si verifica un'interruzione tra hello GSM e hello LSM.</span><span class="sxs-lookup"><span data-stu-id="d651c-106">Occasionally, a break occurs between hello GSM and hello LSM.</span></span> <span data-ttu-id="d651c-107">In tal caso, utilizzare hello RecoveryManager classe toodetect e ripristinare interruzione hello.</span><span class="sxs-lookup"><span data-stu-id="d651c-107">In that case, use hello RecoveryManager class toodetect and repair hello break.</span></span>

<span data-ttu-id="d651c-108">Hello RecoveryManager classe fa parte di hello [libreria client di Database elastico](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="d651c-108">hello RecoveryManager class is part of hello [Elastic Database client library](sql-database-elastic-database-client-library.md).</span></span> 

![Mappa partizioni][1]

<span data-ttu-id="d651c-110">Per le definizioni dei termini, vedere il [glossario degli strumenti del database elastico](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="d651c-110">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span> <span data-ttu-id="d651c-111">hello come toounderstand **ShardMapManager** toomanage utilizzati dati in una soluzione partizionata, vedere [gestione mappa partizioni](sql-database-elastic-scale-shard-map-management.md).</span><span class="sxs-lookup"><span data-stu-id="d651c-111">toounderstand how hello **ShardMapManager** is used toomanage data in a sharded solution, see [Shard map management](sql-database-elastic-scale-shard-map-management.md).</span></span>

## <a name="why-use-hello-recovery-manager"></a><span data-ttu-id="d651c-112">Perché utilizzare Gestione del ripristino di hello?</span><span class="sxs-lookup"><span data-stu-id="d651c-112">Why use hello recovery manager?</span></span>
<span data-ttu-id="d651c-113">In un ambiente di database partizionato c'è un unico tenant per database e ci sono molti database per server.</span><span class="sxs-lookup"><span data-stu-id="d651c-113">In a sharded database environment, there is one tenant per database, and many databases per server.</span></span> <span data-ttu-id="d651c-114">Può anche essere molti server nell'ambiente di hello.</span><span class="sxs-lookup"><span data-stu-id="d651c-114">There can also be many servers in hello environment.</span></span> <span data-ttu-id="d651c-115">Ogni database viene eseguito il mapping nella mappa partizioni hello, pertanto possono essere chiamate di database e server corretto toohello indirizzato.</span><span class="sxs-lookup"><span data-stu-id="d651c-115">Each database is mapped in hello shard map, so calls can be routed toohello correct server and database.</span></span> <span data-ttu-id="d651c-116">I database vengono rilevati in base tooa **chiave di partizionamento orizzontale**, e ogni partizione viene assegnato un **intervallo di valori chiave**.</span><span class="sxs-lookup"><span data-stu-id="d651c-116">Databases are tracked according tooa **sharding key**, and each shard is assigned a **range of key values**.</span></span> <span data-ttu-id="d651c-117">Ad esempio, una chiave di partizionamento orizzontale può rappresentare i nomi dei clienti hello da "D" troppo "f"</span><span class="sxs-lookup"><span data-stu-id="d651c-117">For example, a sharding key may represent hello customer names from "D" too"F."</span></span> <span data-ttu-id="d651c-118">Hello mapping di tutte le partizioni (noto anche come database) e i relativi intervalli di mapping sono contenuti in hello **mappa partizioni globali (GSM)**.</span><span class="sxs-lookup"><span data-stu-id="d651c-118">hello mapping of all shards (aka databases) and their mapping ranges are contained in hello **global shard map (GSM)**.</span></span> <span data-ttu-id="d651c-119">Ogni database contiene anche una mappa di intervalli di hello contenuti nella partizione hello noto come hello **mappa di partizioni locali (LSM)**.</span><span class="sxs-lookup"><span data-stu-id="d651c-119">Each database also contains a map of hello ranges contained on hello shard that is known as hello **local shard map (LSM)**.</span></span> <span data-ttu-id="d651c-120">Quando un'applicazione si connette tooa partizioni, mapping hello viene memorizzato nella cache con hello app per il recupero rapido.</span><span class="sxs-lookup"><span data-stu-id="d651c-120">When an app connects tooa shard, hello mapping is cached with hello app for quick retrieval.</span></span> <span data-ttu-id="d651c-121">Hello LSM è usato toovalidate memorizzati nella cache dei dati.</span><span class="sxs-lookup"><span data-stu-id="d651c-121">hello LSM is used toovalidate cached data.</span></span> 

<span data-ttu-id="d651c-122">Hello GSM e LSM potrebbe diventare non sincronizzata per hello seguenti motivi:</span><span class="sxs-lookup"><span data-stu-id="d651c-122">hello GSM and LSM may become out of sync for hello following reasons:</span></span>

1. <span data-ttu-id="d651c-123">l'eliminazione di Hello di una partizione il cui intervallo sembrano toono più essere in uso o la ridenominazione di una partizione.</span><span class="sxs-lookup"><span data-stu-id="d651c-123">hello deletion of a shard whose range is believed toono longer be in use, or renaming of a shard.</span></span> <span data-ttu-id="d651c-124">Eliminazione dei risultati di una partizione in un **mapping di partizione orfana**.</span><span class="sxs-lookup"><span data-stu-id="d651c-124">Deleting a shard results in an **orphaned shard mapping**.</span></span> <span data-ttu-id="d651c-125">Analogamente, anche un database rinominato può causare un mapping di partizione orfana.</span><span class="sxs-lookup"><span data-stu-id="d651c-125">Similarly, a renamed database can cause an orphaned shard mapping.</span></span> <span data-ttu-id="d651c-126">A seconda della finalità hello Roc hello, partizioni hello potrebbe essere necessario toobe rimosso o percorso partizioni hello deve toobe aggiornato.</span><span class="sxs-lookup"><span data-stu-id="d651c-126">Depending on hello intent of hello change, hello shard may need toobe removed or hello shard location needs toobe updated.</span></span> <span data-ttu-id="d651c-127">toorecover un database eliminato, vedere [ripristinare un database eliminato](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="d651c-127">toorecover a deleted database, see [Restore a deleted database](sql-database-recovery-using-backups.md).</span></span>
2. <span data-ttu-id="d651c-128">Si verifica un evento di failover geografico.</span><span class="sxs-lookup"><span data-stu-id="d651c-128">A geo-failover event occurs.</span></span> <span data-ttu-id="d651c-129">toocontinue, uno necessario aggiornare il nome di server hello e nome del database di gestore mappe partizioni in un'applicazione hello e quindi dettagli sul mapping di aggiornamento hello partizione per tutte le partizioni in una mappa partizioni.</span><span class="sxs-lookup"><span data-stu-id="d651c-129">toocontinue, one must update hello server name, and database name of shard map manager in hello application and then update hello shard mapping details for all shards in a shard map.</span></span> <span data-ttu-id="d651c-130">Se si verifica un failover geografico, tale logica di ripristino deve essere automatizzata all'interno del flusso di lavoro di hello failover.</span><span class="sxs-lookup"><span data-stu-id="d651c-130">If there is a geo-failover, such recovery logic should be automated within hello failover workflow.</span></span> <span data-ttu-id="d651c-131">L'automazione delle azioni di ripristino rende possibile la gestibilità senza problemi dei database abilitati per la replica geografica, evitando interventi manuali.</span><span class="sxs-lookup"><span data-stu-id="d651c-131">Automating recovery actions enables a frictionless manageability for geo-enabled databases and avoids manual human actions.</span></span> <span data-ttu-id="d651c-132">toolearn sulle opzioni toorecover un database, se si verifica un'interruzione del centro dati, vedere [la continuità aziendale](sql-database-business-continuity.md) e [il ripristino di emergenza](sql-database-disaster-recovery.md).</span><span class="sxs-lookup"><span data-stu-id="d651c-132">toolearn about options toorecover a database if there is a data center outage, see [Business Continuity](sql-database-business-continuity.md) and [Disaster Recovery](sql-database-disaster-recovery.md).</span></span>
3. <span data-ttu-id="d651c-133">Database ShardMapManager hello o partizioni viene ripristinato tooan precedenti temporizzate.</span><span class="sxs-lookup"><span data-stu-id="d651c-133">Either a shard or hello ShardMapManager database is restored tooan earlier point-in time.</span></span> <span data-ttu-id="d651c-134">toolearn sul punto di recupero temporizzato tramite i backup, vedere [ripristino tramite backup](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="d651c-134">toolearn about point in time recovery using backups, see [Recovery using backups](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="d651c-135">Per ulteriori informazioni sugli strumenti di Database elastico del Database SQL di Azure, la replica geografica e ripristino, vedere l'esempio hello:</span><span class="sxs-lookup"><span data-stu-id="d651c-135">For more information about Azure SQL Database Elastic Database tools, geo-replication and Restore, see hello following:</span></span> 

* [<span data-ttu-id="d651c-136">Panoramica: Continuità aziendale del cloud e ripristino di emergenza del database con database SQL</span><span class="sxs-lookup"><span data-stu-id="d651c-136">Overview: Cloud business continuity and database disaster recovery with SQL Database</span></span>](sql-database-business-continuity.md) 
* [<span data-ttu-id="d651c-137">Iniziare a utilizzare gli strumenti di database elastici</span><span class="sxs-lookup"><span data-stu-id="d651c-137">Get started with elastic database tools</span></span>](sql-database-elastic-scale-get-started.md)  
* [<span data-ttu-id="d651c-138">Gestione di mappe partizioni</span><span class="sxs-lookup"><span data-stu-id="d651c-138">ShardMap Management</span></span>](sql-database-elastic-scale-shard-map-management.md)

## <a name="retrieving-recoverymanager-from-a-shardmapmanager"></a><span data-ttu-id="d651c-139">Ripristino di RecoveryManager da un oggetto ShardMapManager</span><span class="sxs-lookup"><span data-stu-id="d651c-139">Retrieving RecoveryManager from a ShardMapManager</span></span>
<span data-ttu-id="d651c-140">primo passaggio Hello è un'istanza di RecoveryManager toocreate.</span><span class="sxs-lookup"><span data-stu-id="d651c-140">hello first step is toocreate a RecoveryManager instance.</span></span> <span data-ttu-id="d651c-141">Hello [GetRecoveryManager metodo](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) restituisce hello recovery manager per hello corrente [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) istanza.</span><span class="sxs-lookup"><span data-stu-id="d651c-141">hello [GetRecoveryManager method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getrecoverymanager.aspx) returns hello recovery manager for hello current [ShardMapManager](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.aspx) instance.</span></span> <span data-ttu-id="d651c-142">eseguire il mapping di eventuali incoerenze nella partizione hello tooaddress, è innanzitutto necessario recuperare hello RecoveryManager per mappa di partizioni particolare hello.</span><span class="sxs-lookup"><span data-stu-id="d651c-142">tooaddress any inconsistencies in hello shard map, you must first retrieve hello RecoveryManager for hello particular shard map.</span></span> 

   ```
    ShardMapManager smm = ShardMapManagerFactory.GetSqlShardMapManager(smmConnnectionString,  
             ShardMapManagerLoadPolicy.Lazy);
             RecoveryManager rm = smm.GetRecoveryManager(); 
   ```

<span data-ttu-id="d651c-143">In questo esempio hello RecoveryManager viene inizializzato dai hello ShardMapManager.</span><span class="sxs-lookup"><span data-stu-id="d651c-143">In this example, hello RecoveryManager is initialized from hello ShardMapManager.</span></span> <span data-ttu-id="d651c-144">Hello ShardMapManager contenente un ShardMap anche già inizializzato.</span><span class="sxs-lookup"><span data-stu-id="d651c-144">hello ShardMapManager containing a ShardMap is also already initialized.</span></span> 

<span data-ttu-id="d651c-145">Poiché il codice dell'applicazione modifica mappa partizioni hello stesso, hello credenziali utilizzate nel metodo factory hello (nell'esempio sopra riportato, hello smmConnectionString) devono essere le credenziali che dispongono delle autorizzazioni di lettura e scrittura sul database GSM hello hello a cui fa riferimento stringa di connessione.</span><span class="sxs-lookup"><span data-stu-id="d651c-145">Since this application code manipulates hello shard map itself, hello credentials used in hello factory method (in hello preceding example, smmConnectionString) should be credentials that have read-write permissions on hello GSM database referenced by hello connection string.</span></span> <span data-ttu-id="d651c-146">Queste credenziali sono solitamente diverse da connessioni tooopen le credenziali utilizzate per il routing dipendente dai dati.</span><span class="sxs-lookup"><span data-stu-id="d651c-146">These credentials are typically different from credentials used tooopen connections for data-dependent routing.</span></span> <span data-ttu-id="d651c-147">Per ulteriori informazioni, vedere [utilizzando le credenziali nel client di database elastico hello](sql-database-elastic-scale-manage-credentials.md).</span><span class="sxs-lookup"><span data-stu-id="d651c-147">For more information, see [Using credentials in hello elastic database client](sql-database-elastic-scale-manage-credentials.md).</span></span>

## <a name="removing-a-shard-from-hello-shardmap-after-a-shard-is-deleted"></a><span data-ttu-id="d651c-148">Rimozione di una partizione da hello ShardMap dopo l'eliminazione di una partizione</span><span class="sxs-lookup"><span data-stu-id="d651c-148">Removing a shard from hello ShardMap after a shard is deleted</span></span>
<span data-ttu-id="d651c-149">Hello [DetachShard metodo](https://msdn.microsoft.com/library/azure/dn842083.aspx) Scollega hello dato partizione dalla mappa partizioni hello ed elimina i mapping associati hello partizione.</span><span class="sxs-lookup"><span data-stu-id="d651c-149">hello [DetachShard method](https://msdn.microsoft.com/library/azure/dn842083.aspx) detaches hello given shard from hello shard map and deletes mappings associated with hello shard.</span></span>  

* <span data-ttu-id="d651c-150">il parametro di percorso Hello è percorso partizioni hello, in particolare il nome di server e il nome database di partizione hello viene scollegato.</span><span class="sxs-lookup"><span data-stu-id="d651c-150">hello location parameter is hello shard location, specifically server name and database name, of hello shard being detached.</span></span> 
* <span data-ttu-id="d651c-151">parametro shardMapName Hello è nome mappa partizioni di hello.</span><span class="sxs-lookup"><span data-stu-id="d651c-151">hello shardMapName parameter is hello shard map name.</span></span> <span data-ttu-id="d651c-152">Questo è solo necessario quando più mappe partizioni sono gestite da hello stesso gestore di mappe partizioni.</span><span class="sxs-lookup"><span data-stu-id="d651c-152">This is only required when multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="d651c-153">Facoltativo.</span><span class="sxs-lookup"><span data-stu-id="d651c-153">Optional.</span></span> 


> [!IMPORTANT]
> <span data-ttu-id="d651c-154">Utilizzare questa tecnica solo se si è certi che l'intervallo di hello per il mapping di hello aggiornato è vuoto.</span><span class="sxs-lookup"><span data-stu-id="d651c-154">Use this technique only if you are certain that hello range for hello updated mapping is empty.</span></span> <span data-ttu-id="d651c-155">dati per intervallo hello spostato non controllati da metodi Hello precedenti, è preferibile tooinclude verifica nel codice.</span><span class="sxs-lookup"><span data-stu-id="d651c-155">hello methods above do not check data for hello range being moved, so it is best tooinclude checks in your code.</span></span>
>

<span data-ttu-id="d651c-156">In questo esempio rimuove le partizioni dalla mappa partizioni hello.</span><span class="sxs-lookup"><span data-stu-id="d651c-156">This example removes shards from hello shard map.</span></span> 

   ```
   rm.DetachShard(s.Location, customerMap);
   ``` 

<span data-ttu-id="d651c-157">mappa partizioni Hello riflette posizione partizioni hello hello GSM prima dell'eliminazione di hello della partizione hello.</span><span class="sxs-lookup"><span data-stu-id="d651c-157">hello shard map reflects hello shard location in hello GSM before hello deletion of hello shard.</span></span> <span data-ttu-id="d651c-158">Poiché è stato eliminato partizioni hello, si presuppone questo era intenzionale e intervalli di chiavi di partizionamento orizzontale hello non sono più in uso.</span><span class="sxs-lookup"><span data-stu-id="d651c-158">Because hello shard was deleted, it is assumed this was intentional, and hello sharding key range is no longer in use.</span></span> <span data-ttu-id="d651c-159">Se non è questo il caso, è possibile eseguire un ripristino temporizzato.</span><span class="sxs-lookup"><span data-stu-id="d651c-159">If not, you can execute point-in time restore.</span></span> <span data-ttu-id="d651c-160">partizione di hello toorecover da un precedente punto nel tempo.</span><span class="sxs-lookup"><span data-stu-id="d651c-160">toorecover hello shard from an earlier point-in-time.</span></span> <span data-ttu-id="d651c-161">(In questo caso, esaminare hello seguendo le incoerenze di partizioni toodetect sezione). toorecover, vedere [recupero temporizzato](sql-database-recovery-using-backups.md).</span><span class="sxs-lookup"><span data-stu-id="d651c-161">(In that case, review hello following section toodetect shard inconsistencies.) toorecover, see [Point in time recovery](sql-database-recovery-using-backups.md).</span></span>

<span data-ttu-id="d651c-162">Poiché si presuppone l'eliminazione del database hello era intenzionale, hello Azione pulizia amministrativi finale è toodelete hello voce toohello partizione gestore mappe partizioni di hello.</span><span class="sxs-lookup"><span data-stu-id="d651c-162">Since it is assumed hello database deletion was intentional, hello final administrative cleanup action is toodelete hello entry toohello shard in hello shard map manager.</span></span> <span data-ttu-id="d651c-163">Questo impedisce l'applicazione hello intervallo tooa informazioni che non si prevede di scrivere inavvertitamente.</span><span class="sxs-lookup"><span data-stu-id="d651c-163">This prevents hello application from inadvertently writing information tooa range that is not expected.</span></span>

## <a name="toodetect-mapping-differences"></a><span data-ttu-id="d651c-164">differenze di mapping toodetect</span><span class="sxs-lookup"><span data-stu-id="d651c-164">toodetect mapping differences</span></span>
<span data-ttu-id="d651c-165">Hello [DetectMappingDifferences metodo](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) Seleziona e restituisce una delle mappe di partizioni hello (locali o globali) come origine hello e riconcilia i mapping di entrambe le mappe partizioni (GSM e LSM).</span><span class="sxs-lookup"><span data-stu-id="d651c-165">hello [DetectMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.detectmappingdifferences.aspx) selects and returns one of hello shard maps (either local or global) as hello source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   rm.DetectMappingDifferences(location, shardMapName);
   ```

* <span data-ttu-id="d651c-166">Hello *percorso* specifica il nome di server hello e il nome del database.</span><span class="sxs-lookup"><span data-stu-id="d651c-166">hello *location* specifies hello server name and database name.</span></span> 
* <span data-ttu-id="d651c-167">Hello *shardMapName* parametro è il nome della mappa partizioni hello.</span><span class="sxs-lookup"><span data-stu-id="d651c-167">hello *shardMapName* parameter is hello shard map name.</span></span> <span data-ttu-id="d651c-168">Questo è solo necessario se più mappe partizioni sono gestite da hello stesso gestore di mappe partizioni.</span><span class="sxs-lookup"><span data-stu-id="d651c-168">This is only required if multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="d651c-169">Facoltativo.</span><span class="sxs-lookup"><span data-stu-id="d651c-169">Optional.</span></span> 

## <a name="tooresolve-mapping-differences"></a><span data-ttu-id="d651c-170">differenze di mapping tooresolve</span><span class="sxs-lookup"><span data-stu-id="d651c-170">tooresolve mapping differences</span></span>
<span data-ttu-id="d651c-171">Hello [ResolveMappingDifferences metodo](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) seleziona una delle mappe di partizioni hello (locali o globali) come origine hello e riconcilia i mapping di entrambe le mappe partizioni (GSM e LSM).</span><span class="sxs-lookup"><span data-stu-id="d651c-171">hello [ResolveMappingDifferences method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.resolvemappingdifferences.aspx) selects one of hello shard maps (either local or global) as hello source of truth and reconciles mappings on both shard maps (GSM and LSM).</span></span>

   ```
   ResolveMappingDifferences (RecoveryToken, MappingDifferenceResolution.KeepShardMapping);
   ```

* <span data-ttu-id="d651c-172">Hello *RecoveryToken* parametro enumera hello differenze nei mapping hello hello GSM e hello LSM per partizioni specifiche di hello.</span><span class="sxs-lookup"><span data-stu-id="d651c-172">hello *RecoveryToken* parameter enumerates hello differences in hello mappings between hello GSM and hello LSM for hello specific shard.</span></span> 
* <span data-ttu-id="d651c-173">Hello [MappingDifferenceResolution enumerazione](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) metodo hello tooindicate utilizzato per risolvere hello differenza tra i mapping delle partizioni hello.</span><span class="sxs-lookup"><span data-stu-id="d651c-173">hello [MappingDifferenceResolution enumeration](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.mappingdifferenceresolution.aspx) is used tooindicate hello method for resolving hello difference between hello shard mappings.</span></span> 
* <span data-ttu-id="d651c-174">**MappingDifferenceResolution.KeepShardMapping** è consigliabile quando hello LSM contiene mapping accurato hello e pertanto mapping hello in partizioni hello devono essere utilizzate.</span><span class="sxs-lookup"><span data-stu-id="d651c-174">**MappingDifferenceResolution.KeepShardMapping** is recommended that when hello LSM contains hello accurate mapping and therefore hello mapping in hello shard should be used.</span></span> <span data-ttu-id="d651c-175">Questo avviene in genere hello se si verifica un failover: partizioni hello si trovano ora in un nuovo server.</span><span class="sxs-lookup"><span data-stu-id="d651c-175">This is typically hello case if there is a failover: hello shard now resides on a new server.</span></span> <span data-ttu-id="d651c-176">Poiché la partizione hello deve essere rimossa prima dal hello GSM (RecoveryManager.DetachShard metodo hello), un mapping non esiste più sul hello GSM.</span><span class="sxs-lookup"><span data-stu-id="d651c-176">Since hello shard must first be removed from hello GSM (using hello RecoveryManager.DetachShard method), a mapping no longer exists on hello GSM.</span></span> <span data-ttu-id="d651c-177">Hello LSM deve pertanto essere utilizzato toore-stabilire il mapping di partizione hello.</span><span class="sxs-lookup"><span data-stu-id="d651c-177">Therefore, hello LSM must be used toore-establish hello shard mapping.</span></span>

## <a name="attach-a-shard-toohello-shardmap-after-a-shard-is-restored"></a><span data-ttu-id="d651c-178">Collegare un toohello partizioni ShardMap dopo il ripristino di una partizione</span><span class="sxs-lookup"><span data-stu-id="d651c-178">Attach a shard toohello ShardMap after a shard is restored</span></span>
<span data-ttu-id="d651c-179">Hello [AttachShard metodo](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) collega hello mappa partizioni toohello di partizioni specificato.</span><span class="sxs-lookup"><span data-stu-id="d651c-179">hello [AttachShard method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.recovery.recoverymanager.attachshard.aspx) attaches hello given shard toohello shard map.</span></span> <span data-ttu-id="d651c-180">Quindi, rileva eventuali incoerenze mappa partizioni e degli aggiornamenti delle partizioni di hello mapping toomatch hello al punto di ripristino di partizioni hello di hello.</span><span class="sxs-lookup"><span data-stu-id="d651c-180">It then detects any shard map inconsistencies and updates hello mappings toomatch hello shard at hello point of hello shard restoration.</span></span> <span data-ttu-id="d651c-181">Si presuppone che il database hello anche tooreflect rinominato hello nome del database originale (prima partizione hello è stata ripristinata), poiché ripristino temporizzata di hello predefinite tooa nuovo database aggiunto con un timestamp hello.</span><span class="sxs-lookup"><span data-stu-id="d651c-181">It is assumed that hello database is also renamed tooreflect hello original database name (before hello shard was restored), since hello point-in time restoration defaults tooa new database appended with hello timestamp.</span></span> 

   ```
   rm.AttachShard(location, shardMapName)
   ``` 

* <span data-ttu-id="d651c-182">Hello *percorso* parametro è il nome di server hello e nome del database, di partizioni hello da connettere.</span><span class="sxs-lookup"><span data-stu-id="d651c-182">hello *location* parameter is hello server name and database name, of hello shard being attached.</span></span> 
* <span data-ttu-id="d651c-183">Hello *shardMapName* parametro è il nome della mappa partizioni hello.</span><span class="sxs-lookup"><span data-stu-id="d651c-183">hello *shardMapName* parameter is hello shard map name.</span></span> <span data-ttu-id="d651c-184">Questo è solo necessario quando più mappe partizioni sono gestite da hello stesso gestore di mappe partizioni.</span><span class="sxs-lookup"><span data-stu-id="d651c-184">This is only required when multiple shard maps are managed by hello same shard map manager.</span></span> <span data-ttu-id="d651c-185">Facoltativo.</span><span class="sxs-lookup"><span data-stu-id="d651c-185">Optional.</span></span> 

<span data-ttu-id="d651c-186">Questo esempio aggiunge una mappa partizioni toohello di partizioni che è stato recentemente ripristinata da un'ora di punto precedente.</span><span class="sxs-lookup"><span data-stu-id="d651c-186">This example adds a shard toohello shard map that has been recently restored from an earlier point-in time.</span></span> <span data-ttu-id="d651c-187">Poiché la partizione hello (vale a dire hello mapping per la partizione hello in hello LSM) è stata ripristinata, è potenzialmente non coerente con la voce di partizione hello in GSM hello.</span><span class="sxs-lookup"><span data-stu-id="d651c-187">Since hello shard (namely hello mapping for hello shard in hello LSM) has been restored, it is potentially inconsistent with hello shard entry in hello GSM.</span></span> <span data-ttu-id="d651c-188">Di fuori di questo codice di esempio, partizioni hello è stato ripristinato e rinominato toohello nome originale del database hello.</span><span class="sxs-lookup"><span data-stu-id="d651c-188">Outside of this example code, hello shard was restored and renamed toohello original name of hello database.</span></span> <span data-ttu-id="d651c-189">Dal momento che è stato ripristinato, si presuppone il mapping di hello in hello LSM mapping attendibile hello.</span><span class="sxs-lookup"><span data-stu-id="d651c-189">Since it was restored, it is assumed hello mapping in hello LSM is hello trusted mapping.</span></span> 

   ```
   rm.AttachShard(s.Location, customerMap); 
   var gs = rm.DetectMappingDifferences(s.Location); 
      foreach (RecoveryToken g in gs) 
       { 
       rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
       } 
   ```

## <a name="updating-shard-locations-after-a-geo-failover-restore-of-hello-shards"></a><span data-ttu-id="d651c-190">L'aggiornamento dei percorsi partizioni dopo un failover geografico (ripristino) di partizioni hello</span><span class="sxs-lookup"><span data-stu-id="d651c-190">Updating shard locations after a geo-failover (restore) of hello shards</span></span>
<span data-ttu-id="d651c-191">Se si verifica un failover geografico, database secondario hello verrà resi accessibili scrivere e diventa hello nuovo database primario.</span><span class="sxs-lookup"><span data-stu-id="d651c-191">If there is a geo-failover, hello secondary database is made write accessible and becomes hello new primary database.</span></span> <span data-ttu-id="d651c-192">nome del server di hello e, potenzialmente, il database di hello (a seconda della configurazione) Hello, potrebbe essere diverso dalla replica primaria originale hello.</span><span class="sxs-lookup"><span data-stu-id="d651c-192">hello name of hello server, and potentially hello database (depending on your configuration), may be different from hello original primary.</span></span> <span data-ttu-id="d651c-193">Pertanto hello voci di mapping per la partizione hello in GSM hello e LSM devono essere corretti.</span><span class="sxs-lookup"><span data-stu-id="d651c-193">Therefore hello mapping entries for hello shard in hello GSM and LSM must be fixed.</span></span> <span data-ttu-id="d651c-194">Analogamente, se hello database è ripristinato tooa altro nome o percorso o tooan punto nel tempo precedente, ciò potrebbe causare incoerenze nelle mappe partizioni hello.</span><span class="sxs-lookup"><span data-stu-id="d651c-194">Similarly, if hello database is restored tooa different name or location, or tooan earlier point in time, this might cause inconsistencies in hello shard maps.</span></span> <span data-ttu-id="d651c-195">Hello gestore mappe partizioni gestisce la distribuzione di hello di database corretto toohello di connessioni aperte.</span><span class="sxs-lookup"><span data-stu-id="d651c-195">hello Shard Map Manager handles hello distribution of open connections toohello correct database.</span></span> <span data-ttu-id="d651c-196">Distribuzione basata su dati hello nella mappa partizioni hello e il valore di hello della chiave di partizionamento orizzontale hello hello destinazione della richiesta di applicazioni hello.</span><span class="sxs-lookup"><span data-stu-id="d651c-196">Distribution is based on hello data in hello shard map and hello value of hello sharding key that is hello target of hello applications request.</span></span> <span data-ttu-id="d651c-197">Dopo un failover geografico, è necessario aggiornare questo informazioni con il nome di server accurato hello, nome del database e il mapping delle partizioni del database ripristinato hello.</span><span class="sxs-lookup"><span data-stu-id="d651c-197">After a geo-failover, this information must be updated with hello accurate server name, database name and shard mapping of hello recovered database.</span></span> 

## <a name="best-practices"></a><span data-ttu-id="d651c-198">Procedure consigliate</span><span class="sxs-lookup"><span data-stu-id="d651c-198">Best practices</span></span>
<span data-ttu-id="d651c-199">Failover geo e il ripristino sono operazioni in genere gestiti da un amministratore del cloud di un'applicazione hello intenzionalmente utilizzando una delle funzionalità di continuità aziendale di database SQL di Azure.</span><span class="sxs-lookup"><span data-stu-id="d651c-199">Geo-failover and recovery are operations typically managed by a cloud administrator of hello application intentionally utilizing one of Azure SQL Databases business continuity features.</span></span> <span data-ttu-id="d651c-200">Pianificazione della continuità aziendale richiede i processi, procedure e misure tooensure che è possono continuare le operazioni aziendali senza interruzioni.</span><span class="sxs-lookup"><span data-stu-id="d651c-200">Business continuity planning requires processes, procedures, and measures tooensure that business operations can continue without interruption.</span></span> <span data-ttu-id="d651c-201">Hello metodi disponibili come parte di hello RecoveryManager classe deve essere usato all'interno di questo hello tooensure del flusso di lavoro GSM e LSM vengono aggiornati in base a un'operazione di ripristino hello eseguita.</span><span class="sxs-lookup"><span data-stu-id="d651c-201">hello methods available as part of hello RecoveryManager class should be used within this work flow tooensure hello GSM and LSM are kept up-to-date based on hello recovery action taken.</span></span> <span data-ttu-id="d651c-202">Esistono cinque passaggi fondamentali tooproperly garantire hello GSM e LSM riflettono informazioni accurate di hello dopo un evento di failover.</span><span class="sxs-lookup"><span data-stu-id="d651c-202">There are five basic steps tooproperly ensuring hello GSM and LSM reflect hello accurate information after a failover event.</span></span> <span data-ttu-id="d651c-203">Hello tooexecute codice applicazione che questi passaggi possono essere integrati in flusso di lavoro e gli strumenti esistenti.</span><span class="sxs-lookup"><span data-stu-id="d651c-203">hello application code tooexecute these steps can be integrated into existing tools and workflow.</span></span> 

1. <span data-ttu-id="d651c-204">Consente di recuperare hello RecoveryManager hello ShardMapManager.</span><span class="sxs-lookup"><span data-stu-id="d651c-204">Retrieve hello RecoveryManager from hello ShardMapManager.</span></span> 
2. <span data-ttu-id="d651c-205">Scollegare partizione precedente di hello dalla mappa partizioni hello.</span><span class="sxs-lookup"><span data-stu-id="d651c-205">Detach hello old shard from hello shard map.</span></span>
3. <span data-ttu-id="d651c-206">Collegare hello nuova partizione toohello mappa partizioni, compresa l'ubicazione di hello nuova partizione.</span><span class="sxs-lookup"><span data-stu-id="d651c-206">Attach hello new shard toohello shard map, including hello new shard location.</span></span>
4. <span data-ttu-id="d651c-207">Il mapping tra hello GSM e LSM hello vengono rilevate incoerenze.</span><span class="sxs-lookup"><span data-stu-id="d651c-207">Detect inconsistencies in hello mapping between hello GSM and LSM.</span></span> 
5. <span data-ttu-id="d651c-208">Risolvere le differenze tra hello GSM e hello LSM, hello trusting LSM.</span><span class="sxs-lookup"><span data-stu-id="d651c-208">Resolve differences between hello GSM and hello LSM, trusting hello LSM.</span></span> 

<span data-ttu-id="d651c-209">In questo esempio esegue hello alla procedura seguente:</span><span class="sxs-lookup"><span data-stu-id="d651c-209">This example performs hello following steps:</span></span>

1. <span data-ttu-id="d651c-210">Rimuove le partizioni da hello mappa partizioni che riflettono i percorsi di partizione prima dell'evento di failover hello.</span><span class="sxs-lookup"><span data-stu-id="d651c-210">Removes shards from hello Shard Map that reflect shard locations before hello failover event.</span></span>
2. <span data-ttu-id="d651c-211">Collega partizioni toohello mappa partizioni riflettente hello nuove partizioni posizioni (parametro hello "Configuration.SecondaryServer" è nuovo nome del server hello ma hello stesso nome del database).</span><span class="sxs-lookup"><span data-stu-id="d651c-211">Attaches shards toohello Shard Map reflecting hello new shard locations (hello parameter "Configuration.SecondaryServer" is hello new server name but hello same database name).</span></span>
3. <span data-ttu-id="d651c-212">Recupera il token di ripristino hello rilevando le differenze di mapping tra hello GSM e hello LSM per ogni partizione.</span><span class="sxs-lookup"><span data-stu-id="d651c-212">Retrieves hello recovery tokens by detecting mapping differences between hello GSM and hello LSM for each shard.</span></span> 
4. <span data-ttu-id="d651c-213">Risolve le incoerenze hello mappando hello trusting da hello LSM di ogni partizione.</span><span class="sxs-lookup"><span data-stu-id="d651c-213">Resolves hello inconsistencies by trusting hello mapping from hello LSM of each shard.</span></span> 
   
   ```
   var shards = smm.GetShards(); 
   foreach (shard s in shards) 
   { 
     if (s.Location.Server == Configuration.PrimaryServer) 
   
         { 
          ShardLocation slNew = new ShardLocation(Configuration.SecondaryServer, s.Location.Database); 
   
          rm.DetachShard(s.Location); 
   
          rm.AttachShard(slNew); 
   
          var gs = rm.DetectMappingDifferences(slNew); 
   
          foreach (RecoveryToken g in gs) 
            { 
               rm.ResolveMappingDifferences(g, MappingDifferenceResolution.KeepShardMapping); 
            } 
        } 
    } 
   ```

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-database-recovery-manager/recovery-manager.png

