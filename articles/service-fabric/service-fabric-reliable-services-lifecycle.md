---
title: Panoramica del ciclo di vita di Reliable Services di Azure Service Fabric | Microsoft Docs
description: Informazioni sui diversi eventi del ciclo di vita di Reliable Services di Service Fabric
services: Service-Fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: vturecek;
ms.assetid: 
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: 16021ca72a2f10070b6409417ff0d88009591331
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/18/2017
---
# <a name="reliable-services-lifecycle-overview"></a><span data-ttu-id="074f9-103">Panoramica del ciclo di vita di Reliable Services</span><span class="sxs-lookup"><span data-stu-id="074f9-103">Reliable services lifecycle overview</span></span>
> [!div class="op_single_selector"]
> * [<span data-ttu-id="074f9-104">C# su Windows</span><span class="sxs-lookup"><span data-stu-id="074f9-104">C# on Windows</span></span>](service-fabric-reliable-services-lifecycle.md)
> * [<span data-ttu-id="074f9-105">Java su Linux</span><span class="sxs-lookup"><span data-stu-id="074f9-105">Java on Linux</span></span>](service-fabric-reliable-services-lifecycle-java.md)
>
>

<span data-ttu-id="074f9-106">Quando si pensa al ciclo di vita di Reliable Services, le nozioni di base del ciclo di vita sono quelle più importanti.</span><span class="sxs-lookup"><span data-stu-id="074f9-106">When thinking about the lifecycles of Reliable Services, the basics of the lifecycle are the most important.</span></span> <span data-ttu-id="074f9-107">In generale:</span><span class="sxs-lookup"><span data-stu-id="074f9-107">In general:</span></span>

- <span data-ttu-id="074f9-108">Durante l'avvio</span><span class="sxs-lookup"><span data-stu-id="074f9-108">During Startup</span></span>
  - <span data-ttu-id="074f9-109">I servizi vengono costruiti</span><span class="sxs-lookup"><span data-stu-id="074f9-109">Services are constructed</span></span>
  - <span data-ttu-id="074f9-110">Hanno la possibilità di creare e restituire zero o più listener</span><span class="sxs-lookup"><span data-stu-id="074f9-110">They have an opportunity to construct and return zero or more listeners</span></span>
  - <span data-ttu-id="074f9-111">Qualsiasi listener restituito è aperto, consentendo la comunicazione con il servizio</span><span class="sxs-lookup"><span data-stu-id="074f9-111">Any returned listeners are opened, allowing communication with the service</span></span>
  - <span data-ttu-id="074f9-112">Viene chiamato il metodo RunAsync del servizio che consente al servizio stesso di eseguire operazioni a esecuzione prolungata o in background</span><span class="sxs-lookup"><span data-stu-id="074f9-112">The Service's RunAsync method is called, allowing the service to do long running or background work</span></span>
- <span data-ttu-id="074f9-113">Durante l'arresto</span><span class="sxs-lookup"><span data-stu-id="074f9-113">During shutdown</span></span>
  - <span data-ttu-id="074f9-114">Il token di annullamento passato a RunAsync viene cancellato e i listener vengono chiusi</span><span class="sxs-lookup"><span data-stu-id="074f9-114">The cancellation token passed to RunAsync is canceled, and the listeners are closed</span></span>
  - <span data-ttu-id="074f9-115">Una volta completata l'operazione, viene eliminato l'oggetto servizio stesso</span><span class="sxs-lookup"><span data-stu-id="074f9-115">Once that is complete, the service object itself is destructed</span></span>

<span data-ttu-id="074f9-116">Sono disponibili informazioni dettagliate sull'esatto ordine di questi eventi.</span><span class="sxs-lookup"><span data-stu-id="074f9-116">There are details around the exact ordering of these events.</span></span> <span data-ttu-id="074f9-117">In particolare, l'ordine degli eventi potrebbe cambiare leggermente a seconda che il servizio Reliable sia con o senza stato.</span><span class="sxs-lookup"><span data-stu-id="074f9-117">In particular, the order of events may change slightly depending on whether the Reliable Service is Stateless or Stateful.</span></span> <span data-ttu-id="074f9-118">Inoltre, per i servizi con stato, è necessario affrontare lo scenario di scambio del ruolo di primario.</span><span class="sxs-lookup"><span data-stu-id="074f9-118">In addition, for stateful services, we have to deal with the Primary swap scenario.</span></span> <span data-ttu-id="074f9-119">Durante tale sequenza il ruolo di primario viene trasferito a un'altra replica (o ritorna) senza l'arresto del servizio.</span><span class="sxs-lookup"><span data-stu-id="074f9-119">During this sequence, the role of Primary is transferred to another replica (or comes back) without the service shutting down.</span></span> <span data-ttu-id="074f9-120">Infine è necessario considerare le condizioni di errore.</span><span class="sxs-lookup"><span data-stu-id="074f9-120">Finally, we have to think about error or failure conditions.</span></span>

## <a name="stateless-service-startup"></a><span data-ttu-id="074f9-121">Avvio di un servizio senza stato</span><span class="sxs-lookup"><span data-stu-id="074f9-121">Stateless service startup</span></span>
<span data-ttu-id="074f9-122">Il ciclo di vita di un servizio senza stato è piuttosto semplice.</span><span class="sxs-lookup"><span data-stu-id="074f9-122">The lifecycle of a stateless service is fairly straightforward.</span></span> <span data-ttu-id="074f9-123">Di seguito è riportato l'ordine degli eventi:</span><span class="sxs-lookup"><span data-stu-id="074f9-123">Here's the order of events:</span></span>

1. <span data-ttu-id="074f9-124">Il servizio viene costruito</span><span class="sxs-lookup"><span data-stu-id="074f9-124">The Service is constructed</span></span>
2. <span data-ttu-id="074f9-125">Quindi si verificano due cose in parallelo:</span><span class="sxs-lookup"><span data-stu-id="074f9-125">Then, in parallel two things happen:</span></span>
    - <span data-ttu-id="074f9-126">Viene richiamato `StatelessService.CreateServiceInstanceListeners()` e vengono aperti eventuali listener restituiti.</span><span class="sxs-lookup"><span data-stu-id="074f9-126">`StatelessService.CreateServiceInstanceListeners()` is invoked and any returned listeners are Opened.</span></span> <span data-ttu-id="074f9-127">Viene richiamato `ICommunicationListener.OpenAsync()` su ogni listener</span><span class="sxs-lookup"><span data-stu-id="074f9-127">`ICommunicationListener.OpenAsync()` is called on each listener</span></span>
    - <span data-ttu-id="074f9-128">Viene chiamato il metodo `StatelessService.RunAsync()` del servizio.</span><span class="sxs-lookup"><span data-stu-id="074f9-128">The service's `StatelessService.RunAsync()` method is called</span></span>
3. <span data-ttu-id="074f9-129">Se presente, viene chiamato il metodo `StatelessService.OnOpenAsync()` del servizio.</span><span class="sxs-lookup"><span data-stu-id="074f9-129">If present, the service's `StatelessService.OnOpenAsync()` method is called.</span></span> <span data-ttu-id="074f9-130">Si tratta di un override insolito ma comunque disponibile.</span><span class="sxs-lookup"><span data-stu-id="074f9-130">This is an uncommon override, but it is available.</span></span>

<span data-ttu-id="074f9-131">È importante notare che non vi è alcun ordine tra le chiamate per creare e aprire i listener e RunAsync.</span><span class="sxs-lookup"><span data-stu-id="074f9-131">It is important to note that there is no ordering between the calls to create and open the listeners and RunAsync.</span></span> <span data-ttu-id="074f9-132">I listener possono essere aperti prima dell'avvio di RunAsync.</span><span class="sxs-lookup"><span data-stu-id="074f9-132">The listeners may open before RunAsync is started.</span></span> <span data-ttu-id="074f9-133">Analogamente RunAsync potrebbe essere chiamato prima che i listener di comunicazione siano aperti o siano persino stati creati.</span><span class="sxs-lookup"><span data-stu-id="074f9-133">Similarly, RunAsync may end up invoked before the communication listeners are open or have even been constructed.</span></span> <span data-ttu-id="074f9-134">Se è necessaria una sincronizzazione, la si lascia come esercizio per il responsabile dell'implementazione.</span><span class="sxs-lookup"><span data-stu-id="074f9-134">If any synchronization is required, it is left as an exercise to the implementer.</span></span> <span data-ttu-id="074f9-135">Soluzioni comuni:</span><span class="sxs-lookup"><span data-stu-id="074f9-135">Common solutions:</span></span>

  - <span data-ttu-id="074f9-136">Talvolta i listener non possono funzionare fino a quando non vengono create altre informazioni o eseguite determinate operazioni.</span><span class="sxs-lookup"><span data-stu-id="074f9-136">Sometimes listeners can't function until some other information is created or work done.</span></span> <span data-ttu-id="074f9-137">Per i servizi senza stato le cui operazioni possono essere in genere eseguite in altre posizioni, ad esempio:</span><span class="sxs-lookup"><span data-stu-id="074f9-137">For stateless services that work can usually be done in other locations, such as:</span></span> 
    - <span data-ttu-id="074f9-138">nel costruttore del servizio</span><span class="sxs-lookup"><span data-stu-id="074f9-138">in the service's constructor</span></span>
    - <span data-ttu-id="074f9-139">mentre viene chiamato `CreateServiceInstanceListeners()`</span><span class="sxs-lookup"><span data-stu-id="074f9-139">during the `CreateServiceInstanceListeners()` call</span></span>
    - <span data-ttu-id="074f9-140">nell'ambito del costrutto del listener stesso</span><span class="sxs-lookup"><span data-stu-id="074f9-140">as a part of the construction of the listener itself</span></span>
  - <span data-ttu-id="074f9-141">In alcuni casi il codice in RunAsync non si avvia fino a quando i listener non vengono aperti.</span><span class="sxs-lookup"><span data-stu-id="074f9-141">Sometimes the code in RunAsync does not want to start until the listeners are open.</span></span> <span data-ttu-id="074f9-142">In questo caso è necessario un po' di coordinamento in più.</span><span class="sxs-lookup"><span data-stu-id="074f9-142">In this case additional coordination is necessary.</span></span> <span data-ttu-id="074f9-143">Una soluzione comune è un flag interno ai listener che indica quando vengono completati.</span><span class="sxs-lookup"><span data-stu-id="074f9-143">One common solution is some flag within the listeners indicating when they have completed.</span></span> <span data-ttu-id="074f9-144">Questo flag viene quindi verificato in RunAsync prima di continuare con le effettive operazioni.</span><span class="sxs-lookup"><span data-stu-id="074f9-144">This flag is then checked in RunAsync before continuing to actual work.</span></span>

## <a name="stateless-service-shutdown"></a><span data-ttu-id="074f9-145">Arresto di un servizio senza stato</span><span class="sxs-lookup"><span data-stu-id="074f9-145">Stateless service shutdown</span></span>
<span data-ttu-id="074f9-146">Quando si arresta un servizio senza stato, si segue lo stesso modello, solo in senso inverso:</span><span class="sxs-lookup"><span data-stu-id="074f9-146">When shutting down a stateless service, the same pattern is followed, just in reverse:</span></span>

1. <span data-ttu-id="074f9-147">In parallelo</span><span class="sxs-lookup"><span data-stu-id="074f9-147">In parallel</span></span>
    - <span data-ttu-id="074f9-148">Gli eventuali listener aperti vengono chiusi.</span><span class="sxs-lookup"><span data-stu-id="074f9-148">Any open listeners are Closed.</span></span> <span data-ttu-id="074f9-149">Viene richiamato `ICommunicationListener.CloseAsync()` su ogni listener.</span><span class="sxs-lookup"><span data-stu-id="074f9-149">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="074f9-150">Il token di annullamento passato a `RunAsync()` viene annullato.</span><span class="sxs-lookup"><span data-stu-id="074f9-150">The cancellation token passed to `RunAsync()` is canceled.</span></span> <span data-ttu-id="074f9-151">La verifica della proprietà `IsCancellationRequested` del token di annullamento restituisce true e se viene chiamato il metodo del token `ThrowIfCancellationRequested` genera `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="074f9-151">Checking the cancellation token's `IsCancellationRequested` property returns true, and if called the token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="074f9-152">Dopo il completamento di `CloseAsync()` su ogni listener e il completamento di `RunAsync()`, viene chiamato il metodo del servizio `StatelessService.OnCloseAsync()`, se presente.</span><span class="sxs-lookup"><span data-stu-id="074f9-152">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, the service's `StatelessService.OnCloseAsync()` method is called, if present.</span></span> <span data-ttu-id="074f9-153">È insolito eseguire l'override di `StatelessService.OnCloseAsync()`.</span><span class="sxs-lookup"><span data-stu-id="074f9-153">It is uncommon to override `StatelessService.OnCloseAsync()`.</span></span>
3. <span data-ttu-id="074f9-154">Dopo il completamento di `StatelessService.OnCloseAsync()`, l'oggetto servizio viene eliminato</span><span class="sxs-lookup"><span data-stu-id="074f9-154">After `StatelessService.OnCloseAsync()` completes, the service object is destructed</span></span>

## <a name="stateful-service-startup"></a><span data-ttu-id="074f9-155">Avvio di un servizio con stato</span><span class="sxs-lookup"><span data-stu-id="074f9-155">Stateful service Startup</span></span>
<span data-ttu-id="074f9-156">I servizi con stato hanno un modello simile ai servizi senza stato, con poche modifiche.</span><span class="sxs-lookup"><span data-stu-id="074f9-156">Stateful services have a similar pattern to stateless services, with a few changes.</span></span> <span data-ttu-id="074f9-157">Quando si avvia un servizio con stato, l'ordine degli eventi è il seguente:</span><span class="sxs-lookup"><span data-stu-id="074f9-157">When starting up a stateful service, the order of events is as follows:</span></span>

1. <span data-ttu-id="074f9-158">Il servizio viene costruito</span><span class="sxs-lookup"><span data-stu-id="074f9-158">The Service is constructed</span></span>
2. <span data-ttu-id="074f9-159">Viene chiamato `StatefulServiceBase.OnOpenAsync()`.</span><span class="sxs-lookup"><span data-stu-id="074f9-159">`StatefulServiceBase.OnOpenAsync()` is called.</span></span> <span data-ttu-id="074f9-160">Viene eseguito un override insolito nel servizio.</span><span class="sxs-lookup"><span data-stu-id="074f9-160">This is uncommonly overridden in the service.</span></span>
3. <span data-ttu-id="074f9-161">Vengono eseguite contemporaneamente le operazioni seguenti</span><span class="sxs-lookup"><span data-stu-id="074f9-161">The following things happen in parallel</span></span>
    - <span data-ttu-id="074f9-162">Viene richiamato `StatefulServiceBase.CreateServiceReplicaListeners()`.</span><span class="sxs-lookup"><span data-stu-id="074f9-162">`StatefulServiceBase.CreateServiceReplicaListeners()` is invoked</span></span> 
      - <span data-ttu-id="074f9-163">Se il servizio è di tipo primario tutti i listener restituiti sono aperti.</span><span class="sxs-lookup"><span data-stu-id="074f9-163">If the service is a Primary all returned listeners are Opened.</span></span> <span data-ttu-id="074f9-164">Viene richiamato `ICommunicationListener.OpenAsync()` su ogni listener.</span><span class="sxs-lookup"><span data-stu-id="074f9-164">`ICommunicationListener.OpenAsync()` is called on each listener.</span></span>
      - <span data-ttu-id="074f9-165">Se il servizio è di tipo secondario, solo i listener contrassegnati come `ListenOnSecondary = true` sono aperti.</span><span class="sxs-lookup"><span data-stu-id="074f9-165">If the service is a Secondary, only those listeners marked as `ListenOnSecondary = true` are opened.</span></span> <span data-ttu-id="074f9-166">L'apertura di listener aperti su servizi di tipo secondario è meno comune.</span><span class="sxs-lookup"><span data-stu-id="074f9-166">Having listeners that are open on Secondaries is less common.</span></span>
    - <span data-ttu-id="074f9-167">Se il servizio è attualmente di tipo primario, viene chiamato il metodo `StatefulServiceBase.RunAsync()` del servizio</span><span class="sxs-lookup"><span data-stu-id="074f9-167">The if the Service is currently a Primary, the service's `StatefulServiceBase.RunAsync()` method is called</span></span>
4. <span data-ttu-id="074f9-168">Quando tutte le chiamate `OpenAsync()` del listener della replica vengono completate e viene chiamato `RunAsync()`, viene chiamato `StatefulServiceBase.OnChangeRoleAsync()`.</span><span class="sxs-lookup"><span data-stu-id="074f9-168">Once all the replica listener's `OpenAsync()` calls complete and `RunAsync()` is called, `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="074f9-169">Viene eseguito un override insolito nel servizio.</span><span class="sxs-lookup"><span data-stu-id="074f9-169">This is uncommonly overridden in the service.</span></span>

<span data-ttu-id="074f9-170">Analogamente ai servizi senza stato, non c'è alcun collegamento tra l'ordine in cui vengono completate la creazione e l'apertura dei listener e il momento in cui viene chiamato RunAsync.</span><span class="sxs-lookup"><span data-stu-id="074f9-170">Similarly to stateless services, there's no coordination between the order in which the listeners are created and opened and when RunAsync is called.</span></span> <span data-ttu-id="074f9-171">Se è necessario che queste operazioni siano coordinate, le soluzioni sono perlopiù simili.</span><span class="sxs-lookup"><span data-stu-id="074f9-171">If you need coordination, the solutions are much the same.</span></span> <span data-ttu-id="074f9-172">Ecco un caso in più: si supponga che le chiamate in arrivo ai listener di comunicazione, per funzionare, richiedano informazioni mantenute all'interno di alcune [raccolte Reliable Collections](service-fabric-reliable-services-reliable-collections.md).</span><span class="sxs-lookup"><span data-stu-id="074f9-172">THere is one additional case: say that the calls arriving at the communication listeners require information kept inside some [Reliable Collections](service-fabric-reliable-services-reliable-collections.md).</span></span> <span data-ttu-id="074f9-173">Poiché i listener di comunicazione potrebbero essere aperti prima che le raccolte Reliable Collections siano leggibili o scrivibili e prima che RunAsync si avvii, è necessario un po' di coordinamento aggiuntivo.</span><span class="sxs-lookup"><span data-stu-id="074f9-173">Because the communication listeners could open before the reliable collections are readable or writeable, and before RunAsync could start, some additional coordination is necessary.</span></span> <span data-ttu-id="074f9-174">La soluzione più semplice e più comune è che i listener di comunicazione restituiscano un codice di errore che il client usa per ripetere la richiesta.</span><span class="sxs-lookup"><span data-stu-id="074f9-174">The simplest and most common solution is for the communication listeners to return some error code that the client uses to know to retry the request.</span></span>

## <a name="stateful-service-shutdown"></a><span data-ttu-id="074f9-175">Arresto di un servizio con stato</span><span class="sxs-lookup"><span data-stu-id="074f9-175">Stateful service Shutdown</span></span>
<span data-ttu-id="074f9-176">Analogamente ai servizi senza stato, gli eventi del ciclo di vita durante l'arresto sono gli stesse dell'avvio, ma invertiti.</span><span class="sxs-lookup"><span data-stu-id="074f9-176">Similarly to Stateless services, the lifecycle events during shutdown are the same as during startup, but reversed.</span></span> <span data-ttu-id="074f9-177">Quando viene arrestato un servizio con stato, si verificano gli eventi seguenti:</span><span class="sxs-lookup"><span data-stu-id="074f9-177">When a stateful service is being shut down, the following events occur:</span></span>

1. <span data-ttu-id="074f9-178">In parallelo</span><span class="sxs-lookup"><span data-stu-id="074f9-178">In parallel</span></span>
    - <span data-ttu-id="074f9-179">Gli eventuali listener aperti vengono chiusi.</span><span class="sxs-lookup"><span data-stu-id="074f9-179">Any open listeners are Closed.</span></span> <span data-ttu-id="074f9-180">Viene richiamato `ICommunicationListener.CloseAsync()` su ogni listener.</span><span class="sxs-lookup"><span data-stu-id="074f9-180">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="074f9-181">Il token di annullamento passato a `RunAsync()` viene annullato.</span><span class="sxs-lookup"><span data-stu-id="074f9-181">The cancellation token passed to `RunAsync()` is canceled.</span></span> <span data-ttu-id="074f9-182">La verifica della proprietà `IsCancellationRequested` del token di annullamento restituisce true e se viene chiamato il metodo del token `ThrowIfCancellationRequested` genera `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="074f9-182">Checking the cancellation token's `IsCancellationRequested` property returns true, and if called the token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="074f9-183">Dopo il completamento di `CloseAsync()` su ogni listener e il completamento di `RunAsync()`, viene chiamato il servizio `StatefulServiceBase.OnChangeRoleAsync()`.</span><span class="sxs-lookup"><span data-stu-id="074f9-183">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, the service's `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="074f9-184">Viene eseguito un overridde insolito nel servizio.</span><span class="sxs-lookup"><span data-stu-id="074f9-184">(This is uncommonly overridden in the service.)</span></span>
    - <span data-ttu-id="074f9-185">È necessario attendere il completamento di RunAsync solo se la replica di questo servizio è primario.</span><span class="sxs-lookup"><span data-stu-id="074f9-185">Waiting for RunAsync to complete is only necessary if this service replica was a Primary.</span></span>
3. <span data-ttu-id="074f9-186">Quando il metodo `StatefulServiceBase.OnChangeRoleAsync()` viene completato, viene chiamato il metodo `StatefulServiceBase.OnCloseAsync()`.</span><span class="sxs-lookup"><span data-stu-id="074f9-186">Once the `StatefulServiceBase.OnChangeRoleAsync()` method completes, the `StatefulServiceBase.OnCloseAsync()` method is called.</span></span> <span data-ttu-id="074f9-187">Si tratta di un override insolito ma comunque disponibile.</span><span class="sxs-lookup"><span data-stu-id="074f9-187">This is an uncommon override, but it is available.</span></span>
3. <span data-ttu-id="074f9-188">Dopo il completamento di `StatefulServiceBase.OnCloseAsync()`, l'oggetto servizio viene eliminato.</span><span class="sxs-lookup"><span data-stu-id="074f9-188">After `StatefulServiceBase.OnCloseAsync()` completes, the service object is destructed.</span></span>

## <a name="stateful-service-primary-swaps"></a><span data-ttu-id="074f9-189">Scambi primari di un servizio con stato</span><span class="sxs-lookup"><span data-stu-id="074f9-189">Stateful service primary swaps</span></span>
<span data-ttu-id="074f9-190">Durante l'esecuzione di un servizio con stato, solo per le repliche primarie di quei servizi con stato vengono aperti i listener di comunicazione e viene chiamato il metodo RunAsync.</span><span class="sxs-lookup"><span data-stu-id="074f9-190">While a stateful service is running, only the Primary replicas of that stateful services have their communication listeners opened and their RunAsync method called.</span></span> <span data-ttu-id="074f9-191">Quelli secondari vengono costruiti ma non vedono ulteriori chiamate.</span><span class="sxs-lookup"><span data-stu-id="074f9-191">Secondary are constructed but see no further calls.</span></span> <span data-ttu-id="074f9-192">Durante l'esecuzione di un servizio con stato, tuttavia, è possibile cambiare la replica che attualmente è primaria.</span><span class="sxs-lookup"><span data-stu-id="074f9-192">While a stateful service is running however, which replica is currently the Primary can change.</span></span> <span data-ttu-id="074f9-193">Che cosa significa questo in termini di eventi del ciclo di vita che una replica può vedere?</span><span class="sxs-lookup"><span data-stu-id="074f9-193">What does this mean in terms of the lifecycle events that a replica can see?</span></span> <span data-ttu-id="074f9-194">Il comportamento che la replica con stato vede dipende dal fatto che la replica venga abbassata o alzata di livello durante lo scambio.</span><span class="sxs-lookup"><span data-stu-id="074f9-194">The behavior the stateful replica sees depends on whether it is the replica being demoted or promoted during the swap.</span></span>

### <a name="for-the-primary-being-demoted"></a><span data-ttu-id="074f9-195">Se la replica primaria viene abbassata di livello</span><span class="sxs-lookup"><span data-stu-id="074f9-195">For the primary being demoted</span></span>
<span data-ttu-id="074f9-196">Service Fabric ha bisogno che questa replica arresti l'elaborazione dei messaggi ed esca da qualsiasi attività in background che sta eseguendo.</span><span class="sxs-lookup"><span data-stu-id="074f9-196">Service Fabric needs this replica to stop processing messages and quit any background work it is doing.</span></span> <span data-ttu-id="074f9-197">Di conseguenza questo passaggio è simile a quando il servizio viene arrestato.</span><span class="sxs-lookup"><span data-stu-id="074f9-197">As a result, this step looks similar to when the service is being shut down.</span></span> <span data-ttu-id="074f9-198">Una differenza è che il servizio non viene eliminato o chiuso, in quanto rimane come secondario.</span><span class="sxs-lookup"><span data-stu-id="074f9-198">One difference is that the Service isn't destructed or closed since it remains as a Secondary.</span></span> <span data-ttu-id="074f9-199">Vengono chiamate le API seguenti:</span><span class="sxs-lookup"><span data-stu-id="074f9-199">The following APIs are called:</span></span>

1. <span data-ttu-id="074f9-200">In parallelo</span><span class="sxs-lookup"><span data-stu-id="074f9-200">In parallel</span></span>
    - <span data-ttu-id="074f9-201">Gli eventuali listener aperti vengono chiusi.</span><span class="sxs-lookup"><span data-stu-id="074f9-201">Any open listeners are Closed.</span></span> <span data-ttu-id="074f9-202">Viene richiamato `ICommunicationListener.CloseAsync()` su ogni listener.</span><span class="sxs-lookup"><span data-stu-id="074f9-202">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="074f9-203">Il token di annullamento passato a `RunAsync()` viene annullato.</span><span class="sxs-lookup"><span data-stu-id="074f9-203">The cancellation token passed to `RunAsync()` is canceled.</span></span> <span data-ttu-id="074f9-204">La verifica della proprietà `IsCancellationRequested` del token di annullamento restituisce true e se viene chiamato il metodo del token `ThrowIfCancellationRequested` genera `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="074f9-204">Checking the cancellation token's `IsCancellationRequested` property returns true, and if called the token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="074f9-205">Dopo il completamento di `CloseAsync()` su ogni listener e il completamento di `RunAsync()`, viene chiamato il servizio `StatefulServiceBase.OnChangeRoleAsync()`.</span><span class="sxs-lookup"><span data-stu-id="074f9-205">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, the service's `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="074f9-206">Viene eseguito un override insolito nel servizio.</span><span class="sxs-lookup"><span data-stu-id="074f9-206">This is uncommonly overridden in the service.</span></span>

### <a name="for-the-secondary-being-promoted"></a><span data-ttu-id="074f9-207">Se la replica secondaria viene alzata di livello</span><span class="sxs-lookup"><span data-stu-id="074f9-207">For the secondary being promoted</span></span>
<span data-ttu-id="074f9-208">Service Fabric ha bisogno analogamente che questa replica inizi ad ascoltare i messaggi in transito e avvii le attività necessarie in background.</span><span class="sxs-lookup"><span data-stu-id="074f9-208">Similarly, Service Fabric needs this replica to start listening for messages on the wire and start any background tasks it cares about.</span></span> <span data-ttu-id="074f9-209">Di conseguenza questo processo è simile a quando viene creato il servizio, ad eccezione del fatto che la replica esiste già.</span><span class="sxs-lookup"><span data-stu-id="074f9-209">As a result, this process looks similar to when the service is created, except that the replica itself already exists.</span></span> <span data-ttu-id="074f9-210">Vengono chiamate le API seguenti:</span><span class="sxs-lookup"><span data-stu-id="074f9-210">The following APIs are called:</span></span>

1. <span data-ttu-id="074f9-211">In parallelo</span><span class="sxs-lookup"><span data-stu-id="074f9-211">In parallel</span></span>
    - <span data-ttu-id="074f9-212">`StatefulServiceBase.CreateServiceReplicaListeners()` viene richiamato e qualsiasi listener restituito è aperto.</span><span class="sxs-lookup"><span data-stu-id="074f9-212">`StatefulServiceBase.CreateServiceReplicaListeners()` is invoked and any returned listeners are Opened.</span></span> <span data-ttu-id="074f9-213">Viene richiamato `ICommunicationListener.OpenAsync()` su ogni listener.</span><span class="sxs-lookup"><span data-stu-id="074f9-213">`ICommunicationListener.OpenAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="074f9-214">Viene chiamato il metodo `StatefulServiceBase.RunAsync()` del servizio.</span><span class="sxs-lookup"><span data-stu-id="074f9-214">The service's `StatefulServiceBase.RunAsync()` method is called</span></span>
2. <span data-ttu-id="074f9-215">Una volta che tutte le repliche delle chiamate `OpenAsync()` del listener  vengono completate ed è stato chiamato `RunAsync()`, viene chiamato `StatefulServiceBase.OnChangeRoleAsync()`.</span><span class="sxs-lookup"><span data-stu-id="074f9-215">Once all the replica listener's `OpenAsync()` calls complete and `RunAsync()` has been called,  `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="074f9-216">Viene eseguito un override insolito nel servizio.</span><span class="sxs-lookup"><span data-stu-id="074f9-216">This is uncommonly overridden in the service.</span></span>

### <a name="common-issues-during-stateful-service-shutdown-and-primary-demotion"></a><span data-ttu-id="074f9-217">Problemi comuni durante l'arresto del servizio con stato e l'abbassamento di livello primario</span><span class="sxs-lookup"><span data-stu-id="074f9-217">Common issues during stateful service shutdown and primary demotion</span></span>
<span data-ttu-id="074f9-218">Service Fabric modifica lo stato Primario di un servizio con stato per una serie di motivi.</span><span class="sxs-lookup"><span data-stu-id="074f9-218">Service Fabric changes the Primary of a stateful service for a variety of reasons.</span></span> <span data-ttu-id="074f9-219">I più comuni sono il [ribilanciamento del cluster](service-fabric-cluster-resource-manager-balancing.md) e l'[aggiornamento dell'applicazione](service-fabric-application-upgrade.md).</span><span class="sxs-lookup"><span data-stu-id="074f9-219">The most common are [cluster rebalancing](service-fabric-cluster-resource-manager-balancing.md) and [application upgrade](service-fabric-application-upgrade.md).</span></span> <span data-ttu-id="074f9-220">Durante queste operazioni (nonché durante il normale arresto del servizio, come è possibile notare in caso di eliminazione del servizio), è importante che il servizio rispetti `CancellationToken`.</span><span class="sxs-lookup"><span data-stu-id="074f9-220">During these operations (as well as during normal service shutdown, like you'd see if the service was deleted), it is important that the service respect the `CancellationToken`.</span></span> <span data-ttu-id="074f9-221">I servizi che non gestiscono correttamente l'annullamento sperimenteranno diversi problemi.</span><span class="sxs-lookup"><span data-stu-id="074f9-221">Services that do not handle cancellation cleanly will experience several issues.</span></span> <span data-ttu-id="074f9-222">In particolare, queste operazioni saranno lente poiché Service Fabric attende dell'arresto normale dei servizi.</span><span class="sxs-lookup"><span data-stu-id="074f9-222">In particular, these operations will be slow since Service Fabric waits for the services to stop gracefully.</span></span> <span data-ttu-id="074f9-223">Questo può infine comportare la mancata riuscita degli aggiornamenti che raggiungono timeout ed eseguono il rollback.</span><span class="sxs-lookup"><span data-stu-id="074f9-223">This can ultimately lead to failed upgrades that time out and roll back.</span></span> <span data-ttu-id="074f9-224">La mancata accettazione del token di annullamento può provocare cluster sbilanciati, perché i nodi si riscaldano, ma i servizi non possono essere ribilanciati, dal momento che ci vuole troppo tempo per spostarli altrove.</span><span class="sxs-lookup"><span data-stu-id="074f9-224">Failure to honor the cancellation token can also cause imbalanced clusters because nodes get hot but the services can't be rebalanced since it takes too long to move them elsewhere.</span></span> 

<span data-ttu-id="074f9-225">Poiché si tratta di servizi con stato, è inoltre probabile che usino [raccolte Reliable Collections](service-fabric-reliable-services-reliable-collections.md).</span><span class="sxs-lookup"><span data-stu-id="074f9-225">Since the services are stateful, it is also likely that they are using the [Reliable Collections](service-fabric-reliable-services-reliable-collections.md).</span></span> <span data-ttu-id="074f9-226">In Service Fabric, quando un servizio primario viene abbassato di livello, una delle prime cose che accade è che viene revocato l'accesso in scrittura allo stato sottostante.</span><span class="sxs-lookup"><span data-stu-id="074f9-226">In Service Fabric, when a Primary is demoted, one of the first things that happens is that write access to the underlying state is revoked.</span></span> <span data-ttu-id="074f9-227">Ciò comporta un secondo set di problemi che possono influire sul ciclo di vita del servizio.</span><span class="sxs-lookup"><span data-stu-id="074f9-227">This leads to a second set of issues that can impact the service lifecycle.</span></span> <span data-ttu-id="074f9-228">Le raccolte restituiscono eccezioni in base alla tempistica e al fatto che la replica sia spostata o arrestata.</span><span class="sxs-lookup"><span data-stu-id="074f9-228">The collections return Exceptions based on the timing and whether the replica is being moved or shut down.</span></span> <span data-ttu-id="074f9-229">Queste eccezioni devono essere gestite correttamente.</span><span class="sxs-lookup"><span data-stu-id="074f9-229">These exceptions should be handled correctly.</span></span> <span data-ttu-id="074f9-230">Le eccezioni generate da Service Fabric rientrano nelle categorie permanente [(`FabricException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabricexception?view=azure-dotnet) e temporanea [(`FabricTransientException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabrictransientexception?view=azure-dotnet).</span><span class="sxs-lookup"><span data-stu-id="074f9-230">Exceptions thrown by Service Fabric fall into permanent [(`FabricException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabricexception?view=azure-dotnet) and transient [(`FabricTransientException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabrictransientexception?view=azure-dotnet) categories.</span></span> <span data-ttu-id="074f9-231">Le eccezioni permanenti devono essere registrate e generate, mentre le eccezioni temporanee possono essere ripetute in base a una logica di ripetizione.</span><span class="sxs-lookup"><span data-stu-id="074f9-231">Permanent exceptions should be logged and thrown, while the transient exceptions may be retried based on some retry logic.</span></span>

<span data-ttu-id="074f9-232">La gestione delle eccezioni che derivano dall'uso di `ReliableCollections` in combinazione con gli eventi del ciclo di vita del servizio è una parte importante di test e convalida di un servizio Reliable.</span><span class="sxs-lookup"><span data-stu-id="074f9-232">Handling the exceptions that come from use of the `ReliableCollections` in conjunction with service lifecycle events is an important part of testing and validating a Reliable Service.</span></span> <span data-ttu-id="074f9-233">Si consiglia sempre di eseguire il servizio in condizioni di carico durante l'esecuzione di aggiornamenti e [test di caos](service-fabric-controlled-chaos.md) prima della distribuzione nell'ambiente di produzione.</span><span class="sxs-lookup"><span data-stu-id="074f9-233">The recommendation is always to run your service under load while performing upgrades and [chaos testing](service-fabric-controlled-chaos.md) before ever deploying to production.</span></span> <span data-ttu-id="074f9-234">Questi passaggi di base contribuiscono ad assicurare che il servizio sia implementato correttamente e gestisca gli eventi del ciclo di vita in modo corretto.</span><span class="sxs-lookup"><span data-stu-id="074f9-234">These basic steps help ensure that your service is correctly implemented and handles lifecycle events correctly.</span></span>


## <a name="notes-on-service-lifecycle"></a><span data-ttu-id="074f9-235">Note sul ciclo di vita del servizio</span><span class="sxs-lookup"><span data-stu-id="074f9-235">Notes on service lifecycle</span></span>
  - <span data-ttu-id="074f9-236">Entrambe le chiamate del metodo `RunAsync()` e di `CreateServiceReplicaListeners/CreateServiceInstanceListeners` sono facoltative.</span><span class="sxs-lookup"><span data-stu-id="074f9-236">Both the `RunAsync()` method and the `CreateServiceReplicaListeners/CreateServiceInstanceListeners` calls are optional.</span></span> <span data-ttu-id="074f9-237">Un servizio può averne una, entrambe o nessuna.</span><span class="sxs-lookup"><span data-stu-id="074f9-237">A service may have one of them, both, or neither.</span></span> <span data-ttu-id="074f9-238">Ad esempio, se il servizio esegue tutte le attività in risposta alle chiamate dell'utente, non è necessario implementare `RunAsync()`.</span><span class="sxs-lookup"><span data-stu-id="074f9-238">For example, if the service does all its work in response to user calls, there is no need for it to implement `RunAsync()`.</span></span> <span data-ttu-id="074f9-239">Sono necessari solo i listener di comunicazione e il codice associato.</span><span class="sxs-lookup"><span data-stu-id="074f9-239">Only the communication listeners and their associated code are necessary.</span></span> <span data-ttu-id="074f9-240">Analogamente creare e restituire i listener di comunicazione è facoltativo, in quanto il servizio potrebbe avere solo operazioni in background da eseguire e perciò richiedere solo l'implementazione di `RunAsync()`</span><span class="sxs-lookup"><span data-stu-id="074f9-240">Similarly, creating and returning communication listeners is optional, as the service may have only background work to do, and so only needs to implement `RunAsync()`</span></span>
  - <span data-ttu-id="074f9-241">È un comportamento valido per un servizio completare `RunAsync()` correttamente e ritornare.</span><span class="sxs-lookup"><span data-stu-id="074f9-241">It is valid for a service to complete `RunAsync()` successfully and return from it.</span></span> <span data-ttu-id="074f9-242">Il completamento non è una condizione di errore.</span><span class="sxs-lookup"><span data-stu-id="074f9-242">Completing is not a failure condition.</span></span> <span data-ttu-id="074f9-243">Il completamento di `RunAsync()` indica che le operazioni in background del servizio sono state completate.</span><span class="sxs-lookup"><span data-stu-id="074f9-243">Completing `RunAsync()` indicates that the background work of the service has completed.</span></span> <span data-ttu-id="074f9-244">Per i servizi Reliable con stato viene chiamato nuovamente `RunAsync()` se le repliche sono state abbassate di livello da primarie a secondarie e poi alzate di nuovo al livello primario.</span><span class="sxs-lookup"><span data-stu-id="074f9-244">For stateful reliable services, `RunAsync()` is called again if the replica were demoted from Primary to Secondary and then promoted back to Primary.</span></span>
  - <span data-ttu-id="074f9-245">Se un servizio esce da `RunAsync()` generando un'eccezione imprevista, questo è un errore.</span><span class="sxs-lookup"><span data-stu-id="074f9-245">If a service exits from `RunAsync()` by throwing some unexpected exception, this constitutes a failure.</span></span> <span data-ttu-id="074f9-246">L'oggetto servizio viene arrestato e viene segnalato un errore di integrità.</span><span class="sxs-lookup"><span data-stu-id="074f9-246">The service object is shut down and a health error reported.</span></span>
  - <span data-ttu-id="074f9-247">Mentre non c'è alcun limite di tempo per il completamento di questi metodi, si perde immediatamente la possibilità di scrivere nelle raccolte Reliable Collections e quindi non è possibile completare alcuna operazione effettiva.</span><span class="sxs-lookup"><span data-stu-id="074f9-247">While there is no time limit on returning from these methods, you immediately lose the ability to write to Reliable Collections and therefore cannot complete any real work.</span></span> <span data-ttu-id="074f9-248">È consigliabile completare al più presto la richiesta di annullamento ricevuta.</span><span class="sxs-lookup"><span data-stu-id="074f9-248">It is recommended that you return as quickly as possible upon receiving the cancellation request.</span></span> <span data-ttu-id="074f9-249">Se il servizio non risponde a queste chiamate API entro un intervallo di tempo ragionevole, Service Fabric può terminare forzatamente il servizio.</span><span class="sxs-lookup"><span data-stu-id="074f9-249">If your service does not respond to these API calls in a reasonable amount of time Service Fabric may forcibly terminate your service.</span></span> <span data-ttu-id="074f9-250">In genere ciò accade solo durante gli aggiornamenti delle applicazioni o quando viene eliminato un servizio.</span><span class="sxs-lookup"><span data-stu-id="074f9-250">Usually this only happens during application upgrades or when a service is being deleted.</span></span> <span data-ttu-id="074f9-251">Questo timeout è di 15 minuti per impostazione predefinita.</span><span class="sxs-lookup"><span data-stu-id="074f9-251">This timeout is 15 minutes by default.</span></span>
  - <span data-ttu-id="074f9-252">Gli errori nel percorso `OnCloseAsync()` generano la chiamata di `OnAbort()` che rappresenta l'ultima e migliore opportunità del servizio di pulire e rilasciare le risorse che sono state richieste.</span><span class="sxs-lookup"><span data-stu-id="074f9-252">Failures in the `OnCloseAsync()` path result in `OnAbort()` being called which is a last-chance best-effort opportunity for the service to clean up and release any resources that they have claimed.</span></span>

## <a name="next-steps"></a><span data-ttu-id="074f9-253">Passaggi successivi</span><span class="sxs-lookup"><span data-stu-id="074f9-253">Next steps</span></span>
- [<span data-ttu-id="074f9-254">Introduzione a Reliable Services</span><span class="sxs-lookup"><span data-stu-id="074f9-254">Introduction to Reliable Services</span></span>](service-fabric-reliable-services-introduction.md)
- [<span data-ttu-id="074f9-255">Guida introduttiva a Reliable Services di Microsoft Azure Service Fabric</span><span class="sxs-lookup"><span data-stu-id="074f9-255">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
- [<span data-ttu-id="074f9-256">Uso avanzato del modello di programmazione Reliable Services</span><span class="sxs-lookup"><span data-stu-id="074f9-256">Reliable Services advanced usage</span></span>](service-fabric-reliable-services-advanced-usage.md)
