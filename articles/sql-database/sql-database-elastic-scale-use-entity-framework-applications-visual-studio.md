---
title: libreria client di database elastico aaaUsing con Entity Framework | Documenti Microsoft
description: Usare la libreria client del database elastico e Entity Framework per la codifica di database
services: sql-database
documentationcenter: 
manager: jhubbard
author: torsteng
editor: 
ms.assetid: b9c3065b-cb92-41be-aa7f-deba23e7e159
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 03/06/2017
ms.author: torsteng
ms.openlocfilehash: 917f6d28d9855c0b42afe2c008613a9bbb3ec6b6
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 10/06/2017
---
# <a name="elastic-database-client-library-with-entity-framework"></a><span data-ttu-id="75b04-103">Libreria client dei database elastici con Entity Framework</span><span class="sxs-lookup"><span data-stu-id="75b04-103">Elastic Database client library with Entity Framework</span></span>
<span data-ttu-id="75b04-104">Questo documento illustra le modifiche di hello in un'applicazione Entity Framework che sono necessari toointegrate con hello [strumenti di Database elastico](sql-database-elastic-scale-introduction.md).</span><span class="sxs-lookup"><span data-stu-id="75b04-104">This document shows hello changes in an Entity Framework application that are needed toointegrate with hello [Elastic Database tools](sql-database-elastic-scale-introduction.md).</span></span> <span data-ttu-id="75b04-105">Hello è attiva la composizione [gestione mappa partizioni](sql-database-elastic-scale-shard-map-management.md) e [routing dipendente dai dati](sql-database-elastic-scale-data-dependent-routing.md) con Entity Framework hello **Code First** approccio.</span><span class="sxs-lookup"><span data-stu-id="75b04-105">hello focus is on composing [shard map management](sql-database-elastic-scale-shard-map-management.md) and [data-dependent routing](sql-database-elastic-scale-data-dependent-routing.md) with hello Entity Framework **Code First** approach.</span></span> <span data-ttu-id="75b04-106">Hello [codice innanzitutto - Nuovo Database](http://msdn.microsoft.com/data/jj193542.aspx) esercitazione per Entity Framework viene utilizzato come esempio in esecuzione in questo documento.</span><span class="sxs-lookup"><span data-stu-id="75b04-106">hello [Code First - New Database](http://msdn.microsoft.com/data/jj193542.aspx) tutorial for EF serves as our running example throughout this document.</span></span> <span data-ttu-id="75b04-107">codice di esempio Hello che accompagna questo documento fa parte degli strumenti di database elastico set di campioni in hello esempi di codice di Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="75b04-107">hello sample code accompanying this document is part of elastic database tools' set of samples in hello Visual Studio Code Samples.</span></span>

## <a name="downloading-and-running-hello-sample-code"></a><span data-ttu-id="75b04-108">Scaricare ed eseguire l'esempio di codice hello</span><span class="sxs-lookup"><span data-stu-id="75b04-108">Downloading and Running hello Sample Code</span></span>
<span data-ttu-id="75b04-109">codice di hello toodownload per questo articolo:</span><span class="sxs-lookup"><span data-stu-id="75b04-109">toodownload hello code for this article:</span></span>

* <span data-ttu-id="75b04-110">È richiesto Visual Studio 2012 o versione successiva.</span><span class="sxs-lookup"><span data-stu-id="75b04-110">Visual Studio 2012 or later is required.</span></span> 
* <span data-ttu-id="75b04-111">Scaricare hello [elastico strumenti DB per SQL Azure - esempio di integrazione di Entity Framework](https://code.msdn.microsoft.com/windowsapps/Elastic-Scale-with-Azure-bae904ba) da MSDN.</span><span class="sxs-lookup"><span data-stu-id="75b04-111">Download hello [Elastic DB Tools for Azure SQL - Entity Framework Integration sample](https://code.msdn.microsoft.com/windowsapps/Elastic-Scale-with-Azure-bae904ba) from MSDN.</span></span> <span data-ttu-id="75b04-112">Decomprimere percorso tooa di esempio hello di propria scelta.</span><span class="sxs-lookup"><span data-stu-id="75b04-112">Unzip hello sample tooa location of your choosing.</span></span>
* <span data-ttu-id="75b04-113">Avviare Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="75b04-113">Start Visual Studio.</span></span> 
* <span data-ttu-id="75b04-114">In Visual Studio selezionare File -> Apri progetto/soluzione.</span><span class="sxs-lookup"><span data-stu-id="75b04-114">In Visual Studio, select File -> Open Project/Solution.</span></span> 
* <span data-ttu-id="75b04-115">In hello **Apri progetto** finestra di dialogo, passare toohello esempio scaricato e selezionare **EntityFrameworkCodeFirst.sln** tooopen: esempio hello.</span><span class="sxs-lookup"><span data-stu-id="75b04-115">In hello **Open Project** dialog, navigate toohello sample you downloaded and select **EntityFrameworkCodeFirst.sln** tooopen hello sample.</span></span> 

<span data-ttu-id="75b04-116">esempio hello toorun, è necessario toocreate tre database vuoto nel Database SQL di Azure:</span><span class="sxs-lookup"><span data-stu-id="75b04-116">toorun hello sample, you need toocreate three empty databases in Azure SQL Database:</span></span>

* <span data-ttu-id="75b04-117">Database di gestione delle mappe partizioni</span><span class="sxs-lookup"><span data-stu-id="75b04-117">Shard Map Manager database</span></span>
* <span data-ttu-id="75b04-118">Database partizione 1</span><span class="sxs-lookup"><span data-stu-id="75b04-118">Shard 1 database</span></span>
* <span data-ttu-id="75b04-119">Database partizione 2</span><span class="sxs-lookup"><span data-stu-id="75b04-119">Shard 2 database</span></span>

<span data-ttu-id="75b04-120">Dopo aver creato questi database, compilare segnaposto hello in **Program.cs** con il nome del server di database SQL di Azure, i nomi dei database hello e i database di toohello tooconnect le credenziali.</span><span class="sxs-lookup"><span data-stu-id="75b04-120">Once you have created these databases, fill in hello place holders in **Program.cs** with your Azure SQL DB server name, hello database names and your credentials tooconnect toohello databases.</span></span> <span data-ttu-id="75b04-121">Compilare la soluzione hello in Visual Studio.</span><span class="sxs-lookup"><span data-stu-id="75b04-121">Build hello solution in Visual Studio.</span></span> <span data-ttu-id="75b04-122">Visual Studio verranno scaricati i pacchetti NuGet hello necessario per la libreria client di database elastico hello, Entity Framework e la gestione come parte del processo di compilazione hello di errori temporanei.</span><span class="sxs-lookup"><span data-stu-id="75b04-122">Visual Studio will download hello required NuGet packages for hello elastic database client library, Entity Framework, and Transient Fault handling as part of hello build process.</span></span> <span data-ttu-id="75b04-123">Verificare che per la soluzione sia abilitato il ripristino dei pacchetti NuGet.</span><span class="sxs-lookup"><span data-stu-id="75b04-123">Make sure that restoring NuGet packages is enabled for your solution.</span></span> <span data-ttu-id="75b04-124">È possibile abilitare questa impostazione facendo clic sul file della soluzione in Esplora soluzioni di Visual Studio hello hello.</span><span class="sxs-lookup"><span data-stu-id="75b04-124">You can enable this setting by right-clicking on hello solution file in hello Visual Studio Solution Explorer.</span></span> 

## <a name="entity-framework-workflows"></a><span data-ttu-id="75b04-125">Flussi di lavoro di Entity Framework</span><span class="sxs-lookup"><span data-stu-id="75b04-125">Entity Framework workflows</span></span>
<span data-ttu-id="75b04-126">Gli sviluppatori di Entity Framework si basano su uno dei seguenti quattro applicazioni toobuild flussi di lavoro e la persistenza tooensure per gli oggetti dell'applicazione hello:</span><span class="sxs-lookup"><span data-stu-id="75b04-126">Entity Framework developers rely on one of hello following four workflows toobuild applications and tooensure persistence for application objects:</span></span> 

* <span data-ttu-id="75b04-127">**Code First (Database nuovo)**: hello developer EF Crea modello hello nel codice dell'applicazione hello ed EF genera quindi il database di hello da esso.</span><span class="sxs-lookup"><span data-stu-id="75b04-127">**Code First (New Database)**: hello EF developer creates hello model in hello application code and then EF generates hello database from it.</span></span> 
* <span data-ttu-id="75b04-128">**Code First (Database esistente)**: hello developer consente a Entity Framework di generare codice dell'applicazione hello per modello hello da un database esistente.</span><span class="sxs-lookup"><span data-stu-id="75b04-128">**Code First (Existing Database)**: hello developer lets EF generate hello application code for hello model from an existing database.</span></span>
* <span data-ttu-id="75b04-129">**Prima del modello**: developer hello Crea modello hello nella finestra di progettazione EF hello e quindi EF database hello dal modello hello.</span><span class="sxs-lookup"><span data-stu-id="75b04-129">**Model First**: hello developer creates hello model in hello EF designer and then EF creates hello database from hello model.</span></span>
* <span data-ttu-id="75b04-130">**Database First**: developer hello utilizza EF tooling modello hello tooinfer da un database esistente.</span><span class="sxs-lookup"><span data-stu-id="75b04-130">**Database First**: hello developer uses EF tooling tooinfer hello model from an existing database.</span></span> 

<span data-ttu-id="75b04-131">Tutti questi approcci si basano su hello DbContext classe tootransparently gestire connessioni al database e lo schema del database per un'applicazione.</span><span class="sxs-lookup"><span data-stu-id="75b04-131">All these approaches rely on hello DbContext class tootransparently manage database connections and database schema for an application.</span></span> <span data-ttu-id="75b04-132">Come si parlerà in dettaglio più avanti nel documento hello, costruttori diversi nella classe di base di hello DbContext consentano per diversi livelli di controllo sulla creazione di connessione, la creazione di avvio automatico e dello schema del database.</span><span class="sxs-lookup"><span data-stu-id="75b04-132">As we will discuss in more detail later in hello document, different constructors on hello DbContext base class allow for different levels of control over connection creation, database bootstrapping and schema creation.</span></span> <span data-ttu-id="75b04-133">Difficoltà sorgono principalmente da tabelle dei fatti hello che Gestione connessione di database hello fornita da Entity Framework si interseca con funzionalità di gestione connessione hello hello dati dipendenti interfacce di routing fornite dalla libreria client di database elastico hello.</span><span class="sxs-lookup"><span data-stu-id="75b04-133">Challenges arise primarily from hello fact that hello database connection management provided by EF intersects with hello connection management capabilities of hello data dependent routing interfaces provided by hello elastic database client library.</span></span> 

## <a name="elastic-database-tools-assumptions"></a><span data-ttu-id="75b04-134">Presupposti degli strumenti dei database elastici</span><span class="sxs-lookup"><span data-stu-id="75b04-134">Elastic database tools assumptions</span></span>
<span data-ttu-id="75b04-135">Per le definizioni dei termini, vedere il [glossario degli strumenti del database elastico](sql-database-elastic-scale-glossary.md).</span><span class="sxs-lookup"><span data-stu-id="75b04-135">For term definitions, see [Elastic Database tools glossary](sql-database-elastic-scale-glossary.md).</span></span>

<span data-ttu-id="75b04-136">La libreria client dei database elastici consente di definire partizioni dei dati applicativi denominate shardlet.</span><span class="sxs-lookup"><span data-stu-id="75b04-136">With elastic database client library, you define partitions of your application data called shardlets.</span></span> <span data-ttu-id="75b04-137">Gli Shardlet vengono identificati da una chiave di partizionamento orizzontale e sono mappate toospecific database.</span><span class="sxs-lookup"><span data-stu-id="75b04-137">Shardlets are identified by a sharding key and are mapped toospecific databases.</span></span> <span data-ttu-id="75b04-138">Un'applicazione può avere tutti i database in base alle esigenze e distribuire hello shardlet tooprovide sufficiente capacità o prestazioni ha requisiti di business corrente.</span><span class="sxs-lookup"><span data-stu-id="75b04-138">An application may have as many databases as needed and distribute hello shardlets tooprovide enough capacity or performance given current business requirements.</span></span> <span data-ttu-id="75b04-139">mapping di Hello dei database toohello valori di chiave di partizionamento orizzontale vengono archiviati per una mappa partizioni fornita dal client di database elastico hello API.</span><span class="sxs-lookup"><span data-stu-id="75b04-139">hello mapping of sharding key values toohello databases is stored by a shard map provided by hello elastic database client APIs.</span></span> <span data-ttu-id="75b04-140">Questa funzionalità è denominata **Gestione mappe partizioni**.</span><span class="sxs-lookup"><span data-stu-id="75b04-140">We call this capability **Shard Map Management**, or SMM for short.</span></span> <span data-ttu-id="75b04-141">mappa partizioni Hello funge anche da Service broker hello di connessioni di database per le richieste che contengono una chiave di partizionamento orizzontale.</span><span class="sxs-lookup"><span data-stu-id="75b04-141">hello shard map also serves as hello broker of database connections for requests that carry a sharding key.</span></span> <span data-ttu-id="75b04-142">Facciamo riferimento toothis funzionalità come **routing dipendente dai dati**.</span><span class="sxs-lookup"><span data-stu-id="75b04-142">We refer toothis capability as **data-dependent routing**.</span></span> 

<span data-ttu-id="75b04-143">gestore mappe partizioni di Hello protegge gli utenti da visualizzazioni incoerenti nei dati di shardlet che possono verificarsi quando vengono eseguite operazioni di gestione di shardlet simultanee (ad esempio rilocazione dati da una partizione tooanother).</span><span class="sxs-lookup"><span data-stu-id="75b04-143">hello shard map manager protects users from inconsistent views into shardlet data that can occur when concurrent shardlet management operations (such as relocating data from one shard tooanother) are happening.</span></span> <span data-ttu-id="75b04-144">toodo hello in tal caso, le mappe partizioni gestite da hello client libreria broker hello connessioni al database per un'applicazione.</span><span class="sxs-lookup"><span data-stu-id="75b04-144">toodo so, hello shard maps managed by hello client library broker hello database connections for an application.</span></span> <span data-ttu-id="75b04-145">In questo modo, kill tooautomatically funzionalità di hello partizioni mappa una connessione al database quando le operazioni di gestione di partizioni potrebbe influire sulla hello shardlet che hello connessione è stata creata per.</span><span class="sxs-lookup"><span data-stu-id="75b04-145">This allows hello shard map functionality tooautomatically kill a database connection when shard management operations could impact hello shardlet that hello connection has been created for.</span></span> <span data-ttu-id="75b04-146">Questo approccio è necessario toointegrate con alcune delle funzionalità di Entity Framework, ad esempio la creazione di nuove connessioni da un uno toocheck esistente per l'esistenza del database.</span><span class="sxs-lookup"><span data-stu-id="75b04-146">This approach needs toointegrate with some of EF’s functionality, such as creating new connections from an existing one toocheck for database existence.</span></span> <span data-ttu-id="75b04-147">In generale, l'osservazione è stata che costruttori DbContext standard hello solo funzionano in maniera affidabile chiuse le connessioni ai database che possono essere clonate in modo sicuro per il lavoro di Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="75b04-147">In general, our observation has been that hello standard DbContext constructors only work reliably for closed database connections that can safely be cloned for EF work.</span></span> <span data-ttu-id="75b04-148">il principio di progettazione Hello di database elastico è invece tooonly broker aperto connessioni.</span><span class="sxs-lookup"><span data-stu-id="75b04-148">hello design principle of elastic database instead is tooonly broker opened connections.</span></span> <span data-ttu-id="75b04-149">Si pensa di chiusura della connessione negoziata dalla libreria client hello passandolo tramite toohello EF DbContext potrebbe risolvere il problema.</span><span class="sxs-lookup"><span data-stu-id="75b04-149">One might think that closing a connection brokered by hello client library before handing it over toohello EF DbContext may solve this issue.</span></span> <span data-ttu-id="75b04-150">Chiusura della connessione hello e basarsi su apertura toore EF, tuttavia, uno foregoes controlli di convalida e la coerenza di hello eseguiti dalla libreria hello.</span><span class="sxs-lookup"><span data-stu-id="75b04-150">However, by closing hello connection and relying on EF toore-open it, one foregoes hello validation and consistency checks performed by hello library.</span></span> <span data-ttu-id="75b04-151">funzionalità di migrazioni Hello in Entity Framework, tuttavia, utilizza queste hello toomanage connessioni dello schema di database in modo trasparente toohello applicazione sottostante.</span><span class="sxs-lookup"><span data-stu-id="75b04-151">hello migrations functionality in EF, however, uses these connections toomanage hello underlying database schema in a way that is transparent toohello application.</span></span> <span data-ttu-id="75b04-152">In teoria, si desideri tooretain e combinare tutte le funzionalità dalla libreria client di database elastico hello sia EF in hello stessa applicazione.</span><span class="sxs-lookup"><span data-stu-id="75b04-152">Ideally, we would like tooretain and combine all these capabilities from both hello elastic database client library and EF in hello same application.</span></span> <span data-ttu-id="75b04-153">Hello nella sezione seguente vengono illustrate queste proprietà e i requisiti in modo più dettagliato.</span><span class="sxs-lookup"><span data-stu-id="75b04-153">hello following section discusses these properties and requirements in more detail.</span></span> 

## <a name="requirements"></a><span data-ttu-id="75b04-154">Requisiti</span><span class="sxs-lookup"><span data-stu-id="75b04-154">Requirements</span></span>
<span data-ttu-id="75b04-155">Quando si utilizzano con libreria client di database elastico hello e le API di Entity Framework, è necessario hello tooretain le proprietà seguenti:</span><span class="sxs-lookup"><span data-stu-id="75b04-155">When working with both hello elastic database client library and Entity Framework APIs, we want tooretain hello following properties:</span></span> 

* <span data-ttu-id="75b04-156">**Scalabilità orizzontale**: tooadd o Rimuovi database dal livello dati hello applicazione partizionati hello necessarie per le esigenze di capacità hello di un'applicazione hello.</span><span class="sxs-lookup"><span data-stu-id="75b04-156">**Scale-out**: tooadd or remove databases from hello data tier of hello sharded application as necessary for hello capacity demands of hello application.</span></span> <span data-ttu-id="75b04-157">Ciò significa controllo sulla creazione di hello hello e l'eliminazione del database e l'utilizzo di hello elastico partizioni mappa gestione API toomanage del database e i mapping di shardlet.</span><span class="sxs-lookup"><span data-stu-id="75b04-157">This means control over hello hello creation and deletion of databases and using hello elastic database shard map manager APIs toomanage databases, and mappings of shardlets.</span></span> 
* <span data-ttu-id="75b04-158">**Coerenza**: partizionamento orizzontale si avvale di un'applicazione hello e utilizza hello funzionalità routing dipendente di dati della libreria client hello.</span><span class="sxs-lookup"><span data-stu-id="75b04-158">**Consistency**: hello application employs sharding, and uses hello data dependent routing capabilities of hello client library.</span></span> <span data-ttu-id="75b04-159">danneggiamento tooavoid o risultati della query non corretto, le connessioni sono negoziate mediante gestore mappe partizioni di hello.</span><span class="sxs-lookup"><span data-stu-id="75b04-159">tooavoid corruption or wrong query results, connections are brokered through hello shard map manager.</span></span> <span data-ttu-id="75b04-160">In questo modo vengono mantenute anche la convalida e la coerenza.</span><span class="sxs-lookup"><span data-stu-id="75b04-160">This also retains validation and consistency.</span></span>
* <span data-ttu-id="75b04-161">**Code First**: praticità hello tooretain del primo paradigma del EF codice.</span><span class="sxs-lookup"><span data-stu-id="75b04-161">**Code First**: tooretain hello convenience of EF’s code first paradigm.</span></span> <span data-ttu-id="75b04-162">In Code First, le classi in un'applicazione hello vengono eseguito il mapping in modo trasparente toohello strutture di database sottostanti.</span><span class="sxs-lookup"><span data-stu-id="75b04-162">In Code First, classes in hello application are mapped transparently toohello underlying database structures.</span></span> <span data-ttu-id="75b04-163">il codice dell'applicazione Hello interagisce con DbSets che mascherare la maggior parte dei relativi aspetti hello sottostante l'elaborazione del database.</span><span class="sxs-lookup"><span data-stu-id="75b04-163">hello application code interacts with DbSets that mask most aspects involved in hello underlying database processing.</span></span>
* <span data-ttu-id="75b04-164">**Schema**: Entity Framework gestisce la creazione iniziale dello schema del database e la successiva evoluzione dello schema mediante migrazioni.</span><span class="sxs-lookup"><span data-stu-id="75b04-164">**Schema**: Entity Framework handles initial database schema creation and subsequent schema evolution through migrations.</span></span> <span data-ttu-id="75b04-165">Con il mantenimento di queste funzionalità, è semplice come dati si evolve hello adattamento dell'app.</span><span class="sxs-lookup"><span data-stu-id="75b04-165">By retaining these capabilities, adapting your app is easy as hello data evolves.</span></span> 

<span data-ttu-id="75b04-166">indica a Hello materiale sussidiario seguente come toosatisfy questi requisiti per le applicazioni prima di codice utilizzando gli strumenti di database elastico.</span><span class="sxs-lookup"><span data-stu-id="75b04-166">hello following guidance instructs how toosatisfy these requirements for Code First applications using elastic database tools.</span></span> 

## <a name="data-dependent-routing-using-ef-dbcontext"></a><span data-ttu-id="75b04-167">Routing dipendente dai dati con DbContext di Entity Framework</span><span class="sxs-lookup"><span data-stu-id="75b04-167">Data dependent routing using EF DbContext</span></span>
<span data-ttu-id="75b04-168">Le connessioni di database con Entity Framework vengono in genere gestite tramite sottoclassi di **DbContext**.</span><span class="sxs-lookup"><span data-stu-id="75b04-168">Database connections with Entity Framework are typically managed through subclasses of **DbContext**.</span></span> <span data-ttu-id="75b04-169">Creare le sottoclassi derivandole da **DbContext**.</span><span class="sxs-lookup"><span data-stu-id="75b04-169">Create these subclasses by deriving from **DbContext**.</span></span> <span data-ttu-id="75b04-170">In questo campo definire il **DbSets** che implementano le raccolte di database di backup di hello di oggetti CLR per l'applicazione.</span><span class="sxs-lookup"><span data-stu-id="75b04-170">This is where you define your **DbSets** that implement hello database-backed collections of CLR objects for your application.</span></span> <span data-ttu-id="75b04-171">Nel contesto di hello di routing dipendente dai dati, è possibile identificare diverse proprietà utile che non contengono necessariamente per altri scenari di applicazioni Entity Framework prima di codice:</span><span class="sxs-lookup"><span data-stu-id="75b04-171">In hello context of data dependent routing, we can identify several helpful properties that do not necessarily hold for other EF code first application scenarios:</span></span> 

* <span data-ttu-id="75b04-172">database Hello esiste già e registrata nella mappa partizioni di database elastico hello.</span><span class="sxs-lookup"><span data-stu-id="75b04-172">hello database already exists and has been registered in hello elastic database shard map.</span></span> 
* <span data-ttu-id="75b04-173">schema di Hello dell'applicazione hello è già stato distribuito toohello database (come illustrato di seguito).</span><span class="sxs-lookup"><span data-stu-id="75b04-173">hello schema of hello application has already been deployed toohello database (explained below).</span></span> 
* <span data-ttu-id="75b04-174">Database toohello connessioni di routing dipendente dai dati sono negoziata da mappa partizioni hello.</span><span class="sxs-lookup"><span data-stu-id="75b04-174">Data-dependent routing connections toohello database are brokered by hello shard map.</span></span> 

<span data-ttu-id="75b04-175">toointegrate **DbContexts** con il routing dipendente dai dati per la scalabilità orizzontale:</span><span class="sxs-lookup"><span data-stu-id="75b04-175">toointegrate **DbContexts** with data-dependent routing for scale-out:</span></span>

1. <span data-ttu-id="75b04-176">Creare connessioni fisica del database tramite le interfacce client di database elastico hello di gestore mappe partizioni di hello,</span><span class="sxs-lookup"><span data-stu-id="75b04-176">Create physical database connections through hello elastic database client interfaces of hello shard map manager,</span></span> 
2. <span data-ttu-id="75b04-177">Eseguire il wrapping connessione hello con hello **DbContext** sottoclasse</span><span class="sxs-lookup"><span data-stu-id="75b04-177">Wrap hello connection with hello **DbContext** subclass</span></span>
3. <span data-ttu-id="75b04-178">Passare la connessione hello verso il basso in hello **DbContext** tutta l'elaborazione sul lato EF hello hello accade anche tooensure di classi di base.</span><span class="sxs-lookup"><span data-stu-id="75b04-178">Pass hello connection down into hello **DbContext** base classes tooensure all hello processing on hello EF side happens as well.</span></span> 

<span data-ttu-id="75b04-179">Hello esempio di codice seguente viene illustrato questo approccio.</span><span class="sxs-lookup"><span data-stu-id="75b04-179">hello following code example illustrates this approach.</span></span> <span data-ttu-id="75b04-180">(Questo codice è anche in hello che accompagna il progetto di Visual Studio)</span><span class="sxs-lookup"><span data-stu-id="75b04-180">(This code is also in hello accompanying Visual Studio project)</span></span>

    public class ElasticScaleContext<T> : DbContext
    {
    public DbSet<Blog> Blogs { get; set; }
    …

        // C'tor for data dependent routing. This call will open a validated connection 
        // routed toohello proper shard by hello shard map manager. 
        // Note that hello base class c'tor call will fail for an open connection
        // if migrations need toobe done and SQL credentials are used. This is hello reason for hello 
        // separation of c'tors into hello data-dependent routing case (this c'tor) and hello internal c'tor for new shards.
        public ElasticScaleContext(ShardMap shardMap, T shardingKey, string connectionStr)
            : base(CreateDDRConnection(shardMap, shardingKey, connectionStr), 
            true /* contextOwnsConnection */)
        {
        }

        // Only static methods are allowed in calls into base class c'tors.
        private static DbConnection CreateDDRConnection(
        ShardMap shardMap, 
        T shardingKey, 
        string connectionStr)
        {
            // No initialization
            Database.SetInitializer<ElasticScaleContext<T>>(null);

            // Ask shard map toobroker a validated connection for hello given key
            SqlConnection conn = shardMap.OpenConnectionForKey<T>
                                (shardingKey, connectionStr, ConnectionOptions.Validate);
            return conn;
        }    

## <a name="main-points"></a><span data-ttu-id="75b04-181">Punti principali</span><span class="sxs-lookup"><span data-stu-id="75b04-181">Main points</span></span>
* <span data-ttu-id="75b04-182">Un nuovo costruttore sostituisce il costruttore predefinito hello in sottoclasse DbContext hello</span><span class="sxs-lookup"><span data-stu-id="75b04-182">A new constructor replaces hello default constructor in hello DbContext subclass</span></span> 
* <span data-ttu-id="75b04-183">Hello nuovo costruttore accetta gli argomenti hello necessari per il routing dipendente dai dati tramite una libreria client di database elastico:</span><span class="sxs-lookup"><span data-stu-id="75b04-183">hello new constructor takes hello arguments that are required for data dependent routing through elastic database client library:</span></span>
  
  * <span data-ttu-id="75b04-184">Hello partizioni mappa tooaccess hello interfacce di routing dipendente dai dati,</span><span class="sxs-lookup"><span data-stu-id="75b04-184">hello shard map tooaccess hello data-dependent routing interfaces,</span></span>
  * <span data-ttu-id="75b04-185">Hello shardlet hello tooidentify chiave di partizionamento orizzontale,</span><span class="sxs-lookup"><span data-stu-id="75b04-185">hello sharding key tooidentify hello shardlet,</span></span>
  * <span data-ttu-id="75b04-186">una stringa di connessione con le credenziali di hello per partizioni di toohello routing connessione di hello dipendente dai dati.</span><span class="sxs-lookup"><span data-stu-id="75b04-186">a connection string with hello credentials for hello data-dependent routing connection toohello shard.</span></span> 
* <span data-ttu-id="75b04-187">costruttore della classe base toohello Hello chiamata prende una deviazione in un metodo statico che esegue tutte le fasi hello necessarie per il routing dipendente dai dati.</span><span class="sxs-lookup"><span data-stu-id="75b04-187">hello call toohello base class constructor takes a detour into a static method that performs all hello steps necessary for data-dependent routing.</span></span> 
  
  * <span data-ttu-id="75b04-188">Usa chiamata OpenConnectionForKey hello delle interfacce di client di database elastico hello in hello partizioni mappa tooestablish una connessione aperta.</span><span class="sxs-lookup"><span data-stu-id="75b04-188">It uses hello OpenConnectionForKey call of hello elastic database client interfaces on hello shard map tooestablish an open connection.</span></span>
  * <span data-ttu-id="75b04-189">mappa partizioni Hello Crea partizioni di toohello connessione aperta hello che contiene shardlet hello per hello data chiave di partizionamento orizzontale.</span><span class="sxs-lookup"><span data-stu-id="75b04-189">hello shard map creates hello open connection toohello shard that holds hello shardlet for hello given sharding key.</span></span>
  * <span data-ttu-id="75b04-190">Questa connessione aperta viene passata il costruttore della classe base toohello indietro di tooindicate DbContext che questa connessione è toobe utilizzato da Entity Framework anziché consentire a Entity Framework crea automaticamente una nuova connessione.</span><span class="sxs-lookup"><span data-stu-id="75b04-190">This open connection is passed back toohello base class constructor of DbContext tooindicate that this connection is toobe used by EF instead of letting EF create a new connection automatically.</span></span> <span data-ttu-id="75b04-191">Connessione di hello in questo modo è stata contrassegnata dal client di database elastico hello API in modo che sia possibile garantire la coerenza con le operazioni di gestione di partizioni della mappa.</span><span class="sxs-lookup"><span data-stu-id="75b04-191">This way hello connection has been tagged by hello elastic database client API so that it can guarantee consistency under shard map management operations.</span></span>

<span data-ttu-id="75b04-192">Utilizzare il nuovo costruttore di hello per la sottoclasse DbContext anziché il costruttore predefinito hello nel codice.</span><span class="sxs-lookup"><span data-stu-id="75b04-192">Use hello new constructor for your DbContext subclass instead of hello default constructor in your code.</span></span> <span data-ttu-id="75b04-193">Di seguito è fornito un esempio:</span><span class="sxs-lookup"><span data-stu-id="75b04-193">Here is an example:</span></span> 

    // Create and save a new blog.

    Console.Write("Enter a name for a new blog: "); 
    var name = Console.ReadLine(); 

    using (var db = new ElasticScaleContext<int>( 
                            sharding.ShardMap,  
                            tenantId1,  
                            connStrBldr.ConnectionString)) 
    { 
        var blog = new Blog { Name = name }; 
        db.Blogs.Add(blog); 
        db.SaveChanges(); 

        // Display all Blogs for tenant 1 
        var query = from b in db.Blogs 
                    orderby b.Name 
                    select b; 
     … 
    }

<span data-ttu-id="75b04-194">nuovo costruttore Hello verrà visualizzata la partizione di toohello connessione hello contenente dati hello per shardlet hello identificato dal valore hello **tenantid1**.</span><span class="sxs-lookup"><span data-stu-id="75b04-194">hello new constructor opens hello connection toohello shard that holds hello data for hello shardlet identified by hello value of **tenantid1**.</span></span> <span data-ttu-id="75b04-195">Hello codice hello **utilizzando** blocco rimane invariato tooaccess hello **DbSet** per i blog mediante EF in partizioni hello per **tenantid1**.</span><span class="sxs-lookup"><span data-stu-id="75b04-195">hello code in hello **using** block stays unchanged tooaccess hello **DbSet** for blogs using EF on hello shard for **tenantid1**.</span></span> <span data-ttu-id="75b04-196">In questo modo la semantica per una partizione toohello con ambito di codice hello in hello utilizzando blocco in modo che tutte le operazioni di database sono ora in cui **tenantid1** viene mantenuta.</span><span class="sxs-lookup"><span data-stu-id="75b04-196">This changes semantics for hello code in hello using block such that all database operations are now scoped toohello one shard where **tenantid1** is kept.</span></span> <span data-ttu-id="75b04-197">Ad esempio, una query LINQ sul blog di hello **DbSet** potrebbe restituire solo i blog archiviati nella partizione corrente hello, ma non hello quelli archiviati in altre partizioni.</span><span class="sxs-lookup"><span data-stu-id="75b04-197">For instance, a LINQ query over hello blogs **DbSet** would only return blogs stored on hello current shard, but not hello ones stored on other shards.</span></span>  

#### <a name="transient-faults-handling"></a><span data-ttu-id="75b04-198">Gestione degli errori temporanei</span><span class="sxs-lookup"><span data-stu-id="75b04-198">Transient faults handling</span></span>
<span data-ttu-id="75b04-199">Hello Microsoft Patterns & Practices team hello pubblicato [hello Transient Fault Handling Application Block](https://msdn.microsoft.com/library/dn440719.aspx).</span><span class="sxs-lookup"><span data-stu-id="75b04-199">hello Microsoft Patterns & Practices team published hello [hello Transient Fault Handling Application Block](https://msdn.microsoft.com/library/dn440719.aspx).</span></span> <span data-ttu-id="75b04-200">libreria di Hello viene utilizzata con una libreria client di scalabilità elastica in combinazione con Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="75b04-200">hello library is used with elastic scale client library in combination with EF.</span></span> <span data-ttu-id="75b04-201">Tuttavia, assicurarsi che qualsiasi eccezione temporanea restituisce tooa luogo in cui è possibile assicurare che il nuovo costruttore hello utilizzato dopo un errore temporaneo in modo che qualsiasi nuovo tentativo di connessione utilizzando i costruttori di hello che sono stati modificati.</span><span class="sxs-lookup"><span data-stu-id="75b04-201">However, ensure that any transient exception returns tooa place where we can ensure that hello new constructor is being used after a transient fault so that any new connection attempt is made using hello constructors we have tweaked.</span></span> <span data-ttu-id="75b04-202">In caso contrario, un toohello connessione corretto partizione non è garantito e non sono garanzie connessione hello viene mantenuta come mappa partizioni toohello si verificano modifiche.</span><span class="sxs-lookup"><span data-stu-id="75b04-202">Otherwise, a connection toohello correct shard is not guaranteed, and there are no assurances hello connection is maintained as changes toohello shard map occur.</span></span> 

<span data-ttu-id="75b04-203">Hello nell'esempio di codice seguente illustra l'utilizzo un criterio di ripetizione SQL possibile intorno hello nuovo **DbContext** costruttori sottoclasse:</span><span class="sxs-lookup"><span data-stu-id="75b04-203">hello following code sample illustrates how a SQL retry policy can be used around hello new **DbContext** subclass constructors:</span></span> 

    SqlDatabaseUtils.SqlRetryPolicy.ExecuteAction(() => 
    { 
        using (var db = new ElasticScaleContext<int>( 
                                sharding.ShardMap,  
                                tenantId1,  
                                connStrBldr.ConnectionString)) 
            { 
                    var blog = new Blog { Name = name }; 
                    db.Blogs.Add(blog); 
                    db.SaveChanges(); 
            … 
            } 
        }); 

<span data-ttu-id="75b04-204">**SqlDatabaseUtils.SqlRetryPolicy** in hello codice precedente viene definito come un **SqlDatabaseTransientErrorDetectionStrategy** con un numero di tentativi di 10 e 5 secondi di attesa tra i tentativi.</span><span class="sxs-lookup"><span data-stu-id="75b04-204">**SqlDatabaseUtils.SqlRetryPolicy** in hello code above is defined as a **SqlDatabaseTransientErrorDetectionStrategy** with a retry count of 10, and 5 seconds wait time between retries.</span></span> <span data-ttu-id="75b04-205">Questo approccio è simile toohello indicazioni per Entity Framework e le transazioni avviate dall'utente (vedere [limitazioni con nuovo tentativo di strategie di esecuzione (a partire EF6)](http://msdn.microsoft.com/data/dn307226).</span><span class="sxs-lookup"><span data-stu-id="75b04-205">This approach is similar toohello guidance for EF and user-initiated transactions (see [Limitations with Retrying Execution Strategies (EF6 onwards)](http://msdn.microsoft.com/data/dn307226).</span></span> <span data-ttu-id="75b04-206">Entrambe le situazioni richiedono tale applicazione hello controlla hello ambito toowhich hello eccezione temporanea restituisce: tooeither riaprire transazione hello o (come illustrato) ricreare contesto hello dal costruttore di hello corretto che utilizza hello database elastico libreria client.</span><span class="sxs-lookup"><span data-stu-id="75b04-206">Both situations require that hello application program controls hello scope toowhich hello transient exception returns: tooeither reopen hello transaction, or (as shown) recreate hello context from hello proper constructor that uses hello elastic database client library.</span></span>

<span data-ttu-id="75b04-207">Hello toocontrol necessità in eccezioni temporanee Iniziamo in ambito impedisce anche utilizzare hello incorporati hello **SqlAzureExecutionStrategy** fornito con Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="75b04-207">hello need toocontrol where transient exceptions take us back in scope also precludes hello use of hello built-in **SqlAzureExecutionStrategy** that comes with EF.</span></span> <span data-ttu-id="75b04-208">**SqlAzureExecutionStrategy** verrebbe riaprire una connessione, ma non utilizzare **OpenConnectionForKey** e pertanto Ignora tutte le convalide hello che viene eseguita come parte di hello **OpenConnectionForKey** chiamare.</span><span class="sxs-lookup"><span data-stu-id="75b04-208">**SqlAzureExecutionStrategy** would reopen a connection but not use **OpenConnectionForKey** and therefore bypass all hello validation that is performed as part of hello **OpenConnectionForKey** call.</span></span> <span data-ttu-id="75b04-209">Nell'esempio di codice hello utilizza invece incorporato hello **DefaultExecutionStrategy** anche fornito con Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="75b04-209">Instead, hello code sample uses hello built-in **DefaultExecutionStrategy** that also comes with EF.</span></span> <span data-ttu-id="75b04-210">Anziché troppo**SqlAzureExecutionStrategy**, funziona correttamente in combinazione con criteri di ripetizione hello dalla gestione degli errori temporanei.</span><span class="sxs-lookup"><span data-stu-id="75b04-210">As opposed too**SqlAzureExecutionStrategy**, it works correctly in combination with hello retry policy from Transient Fault Handling.</span></span> <span data-ttu-id="75b04-211">criteri di esecuzione Hello sono impostato in hello **ElasticScaleDbConfiguration** classe.</span><span class="sxs-lookup"><span data-stu-id="75b04-211">hello execution policy is set in hello **ElasticScaleDbConfiguration** class.</span></span> <span data-ttu-id="75b04-212">Si noti che si è deciso di non toouse **DefaultSqlExecutionStrategy** poiché si consiglia di toouse **SqlAzureExecutionStrategy** se si verificano eccezioni temporanee - ciò provocherebbe toowrong comportamento come illustrato.</span><span class="sxs-lookup"><span data-stu-id="75b04-212">Note that we decided not toouse **DefaultSqlExecutionStrategy** since it suggests toouse **SqlAzureExecutionStrategy** if transient exceptions occur - which would lead toowrong behavior as discussed.</span></span> <span data-ttu-id="75b04-213">Per ulteriori informazioni sui criteri di tentativi diverso hello ed Entity Framework, vedere [resilienza delle connessioni in EF](http://msdn.microsoft.com/data/dn456835.aspx).</span><span class="sxs-lookup"><span data-stu-id="75b04-213">For more information on hello different retry policies and EF, see [Connection Resiliency in EF](http://msdn.microsoft.com/data/dn456835.aspx).</span></span>     

#### <a name="constructor-rewrites"></a><span data-ttu-id="75b04-214">Riscritture dei costruttori</span><span class="sxs-lookup"><span data-stu-id="75b04-214">Constructor rewrites</span></span>
<span data-ttu-id="75b04-215">esempi di codice precedenti Hello illustrano predefinito hello costruttore riscrive richiesto per l'applicazione in ordine toouse dipendente dai dati di routing con hello Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="75b04-215">hello code examples above illustrate hello default constructor re-writes required for your application in order toouse  data dependent routing with hello Entity Framework.</span></span> <span data-ttu-id="75b04-216">Hello nella tabella seguente consente di generalizzare costruttori di tooother questo approccio.</span><span class="sxs-lookup"><span data-stu-id="75b04-216">hello following table generalizes this approach tooother constructors.</span></span> 

| <span data-ttu-id="75b04-217">Costruttore corrente</span><span class="sxs-lookup"><span data-stu-id="75b04-217">Current Constructor</span></span> | <span data-ttu-id="75b04-218">Costruttore riscritto per i dati</span><span class="sxs-lookup"><span data-stu-id="75b04-218">Rewritten Constructor for data</span></span> | <span data-ttu-id="75b04-219">Costruttore base</span><span class="sxs-lookup"><span data-stu-id="75b04-219">Base Constructor</span></span> | <span data-ttu-id="75b04-220">Note</span><span class="sxs-lookup"><span data-stu-id="75b04-220">Notes</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="75b04-221">MyContext()</span><span class="sxs-lookup"><span data-stu-id="75b04-221">MyContext()</span></span> |<span data-ttu-id="75b04-222">ElasticScaleContext(ShardMap, TKey)</span><span class="sxs-lookup"><span data-stu-id="75b04-222">ElasticScaleContext(ShardMap, TKey)</span></span> |<span data-ttu-id="75b04-223">DbContext(DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="75b04-223">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="75b04-224">connessione Hello deve toobe una funzione della mappa partizioni hello e la chiave di routing dipendente dai dati hello.</span><span class="sxs-lookup"><span data-stu-id="75b04-224">hello connection needs toobe a function of hello shard map and hello data-dependent routing key.</span></span> <span data-ttu-id="75b04-225">Necessaria la creazione di connessione automatica tooby passata da Entity Framework e usare connessione hello toobroker di hello partizioni della mappa.</span><span class="sxs-lookup"><span data-stu-id="75b04-225">You need tooby-pass automatic connection creation by EF and instead use hello shard map toobroker hello connection.</span></span> |
| <span data-ttu-id="75b04-226">MyContext(string)</span><span class="sxs-lookup"><span data-stu-id="75b04-226">MyContext(string)</span></span> |<span data-ttu-id="75b04-227">ElasticScaleContext(ShardMap, TKey)</span><span class="sxs-lookup"><span data-stu-id="75b04-227">ElasticScaleContext(ShardMap, TKey)</span></span> |<span data-ttu-id="75b04-228">DbContext(DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="75b04-228">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="75b04-229">connessione Hello è una funzione della mappa partizioni hello e la chiave di routing dipendente dai dati hello.</span><span class="sxs-lookup"><span data-stu-id="75b04-229">hello connection is a function of hello shard map and hello data-dependent routing key.</span></span> <span data-ttu-id="75b04-230">Una stringa di connessione o nome del database non funzionerà man mano che la convalida di elementi da ignorare dalla mappa partizioni hello.</span><span class="sxs-lookup"><span data-stu-id="75b04-230">A fixed database name or connection string will not work as they by-pass validation by hello shard map.</span></span> |
| <span data-ttu-id="75b04-231">MyContext(DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="75b04-231">MyContext(DbCompiledModel)</span></span> |<span data-ttu-id="75b04-232">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="75b04-232">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span></span> |<span data-ttu-id="75b04-233">DbContext(DbConnection, DbCompiledModel, bool)</span><span class="sxs-lookup"><span data-stu-id="75b04-233">DbContext(DbConnection, DbCompiledModel, bool)</span></span> |<span data-ttu-id="75b04-234">connessione Hello verrà vengono create per hello specificato chiave di partizionamento orizzontale e di mappa partizioni con il modello di hello forniti.</span><span class="sxs-lookup"><span data-stu-id="75b04-234">hello connection will get created for hello given shard map and sharding key with hello model provided.</span></span> <span data-ttu-id="75b04-235">modello compilato Hello verrà passata in toohello c'tor di base.</span><span class="sxs-lookup"><span data-stu-id="75b04-235">hello compiled model will be passed on toohello base c’tor.</span></span> |
| <span data-ttu-id="75b04-236">MyContext(DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="75b04-236">MyContext(DbConnection, bool)</span></span> |<span data-ttu-id="75b04-237">ElasticScaleContext(ShardMap, TKey, bool)</span><span class="sxs-lookup"><span data-stu-id="75b04-237">ElasticScaleContext(ShardMap, TKey, bool)</span></span> |<span data-ttu-id="75b04-238">DbContext(DbConnection, bool)</span><span class="sxs-lookup"><span data-stu-id="75b04-238">DbContext(DbConnection, bool)</span></span> |<span data-ttu-id="75b04-239">connessione Hello deve toobe dedotto dalla mappa partizioni hello e la chiave di hello.</span><span class="sxs-lookup"><span data-stu-id="75b04-239">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="75b04-240">Ma non può essere fornita come input (a meno che tale input era già in uso mappa partizioni hello e la chiave di hello).</span><span class="sxs-lookup"><span data-stu-id="75b04-240">It cannot be provided as an input (unless that input was already using hello shard map and hello key).</span></span> <span data-ttu-id="75b04-241">Hello Boolean verrà passato.</span><span class="sxs-lookup"><span data-stu-id="75b04-241">hello Boolean will be passed on.</span></span> |
| <span data-ttu-id="75b04-242">MyContext(string, DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="75b04-242">MyContext(string, DbCompiledModel)</span></span> |<span data-ttu-id="75b04-243">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span><span class="sxs-lookup"><span data-stu-id="75b04-243">ElasticScaleContext(ShardMap, TKey, DbCompiledModel)</span></span> |<span data-ttu-id="75b04-244">DbContext(DbConnection, DbCompiledModel, bool)</span><span class="sxs-lookup"><span data-stu-id="75b04-244">DbContext(DbConnection, DbCompiledModel, bool)</span></span> |<span data-ttu-id="75b04-245">connessione Hello deve toobe dedotto dalla mappa partizioni hello e la chiave di hello.</span><span class="sxs-lookup"><span data-stu-id="75b04-245">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="75b04-246">Ma non può essere fornita come input (a meno che tale input utilizzava mappa partizioni hello e la chiave di hello).</span><span class="sxs-lookup"><span data-stu-id="75b04-246">It cannot be provided as an input (unless that input was using hello shard map and hello key).</span></span> <span data-ttu-id="75b04-247">modello compilato Hello verrà passato.</span><span class="sxs-lookup"><span data-stu-id="75b04-247">hello compiled model will be passed on.</span></span> |
| <span data-ttu-id="75b04-248">MyContext(ObjectContext, bool)</span><span class="sxs-lookup"><span data-stu-id="75b04-248">MyContext(ObjectContext, bool)</span></span> |<span data-ttu-id="75b04-249">ElasticScaleContext(ShardMap, TKey, ObjectContext, bool)</span><span class="sxs-lookup"><span data-stu-id="75b04-249">ElasticScaleContext(ShardMap, TKey, ObjectContext, bool)</span></span> |<span data-ttu-id="75b04-250">DbContext(ObjectContext, bool)</span><span class="sxs-lookup"><span data-stu-id="75b04-250">DbContext(ObjectContext, bool)</span></span> |<span data-ttu-id="75b04-251">nuovo costruttore Hello deve tooensure che qualsiasi connessione in hello che ObjectContext passato come input è nuovamente indirizzato tooa gestiti da scalabilità elastica.</span><span class="sxs-lookup"><span data-stu-id="75b04-251">hello new constructor needs tooensure that any connection in hello ObjectContext passed as an input is re-routed tooa connection managed by Elastic Scale.</span></span> <span data-ttu-id="75b04-252">Una descrizione dettagliata dei ObjectContexts esula dall'ambito di hello di questo documento.</span><span class="sxs-lookup"><span data-stu-id="75b04-252">A detailed discussion of ObjectContexts is beyond hello scope of this document.</span></span> |
| <span data-ttu-id="75b04-253">MyContext(DbConnection, DbCompiledModel,bool)</span><span class="sxs-lookup"><span data-stu-id="75b04-253">MyContext(DbConnection, DbCompiledModel,bool)</span></span> |<span data-ttu-id="75b04-254">ElasticScaleContext(ShardMap, TKey, DbCompiledModel, bool)</span><span class="sxs-lookup"><span data-stu-id="75b04-254">ElasticScaleContext(ShardMap, TKey, DbCompiledModel, bool)</span></span> |<span data-ttu-id="75b04-255">DbContext(DbConnection, DbCompiledModel, bool);</span><span class="sxs-lookup"><span data-stu-id="75b04-255">DbContext(DbConnection, DbCompiledModel, bool);</span></span> |<span data-ttu-id="75b04-256">connessione Hello deve toobe dedotto dalla mappa partizioni hello e la chiave di hello.</span><span class="sxs-lookup"><span data-stu-id="75b04-256">hello connection needs toobe inferred from hello shard map and hello key.</span></span> <span data-ttu-id="75b04-257">connessione Hello non può essere fornito come input (a meno che tale input era già in uso mappa partizioni hello e la chiave di hello).</span><span class="sxs-lookup"><span data-stu-id="75b04-257">hello connection cannot be provided as an input (unless that input was already using hello shard map and hello key).</span></span> <span data-ttu-id="75b04-258">Modello e un valore booleano vengono passati nel costruttore della classe base toohello.</span><span class="sxs-lookup"><span data-stu-id="75b04-258">Model and Boolean are passed on toohello base class constructor.</span></span> |

## <a name="shard-schema-deployment-through-ef-migrations"></a><span data-ttu-id="75b04-259">Distribuzione dello schema partizione tramite migrazioni di Entity Framework</span><span class="sxs-lookup"><span data-stu-id="75b04-259">Shard schema deployment through EF migrations</span></span>
<span data-ttu-id="75b04-260">Gestione automatica dello schema è un'utile fornita da Entity Framework hello.</span><span class="sxs-lookup"><span data-stu-id="75b04-260">Automatic schema management is a convenience provided by hello Entity Framework.</span></span> <span data-ttu-id="75b04-261">Nel contesto di hello delle applicazioni che utilizzano gli strumenti di database elastici, si desidera tooretain questa funzionalità tooautomatically provisioning hello schema toonewly creato le partizioni quando i database vengono aggiunti toohello partizionati applicazione.</span><span class="sxs-lookup"><span data-stu-id="75b04-261">In hello context of applications using elastic database tools, we want tooretain this capability tooautomatically provision hello schema toonewly created shards when databases are added toohello sharded application.</span></span> <span data-ttu-id="75b04-262">Hello viene usata principalmente tooincrease capacità a livello di dati hello per le applicazioni partizionate mediante EF.</span><span class="sxs-lookup"><span data-stu-id="75b04-262">hello primary use case is tooincrease capacity at hello data tier for sharded applications using EF.</span></span> <span data-ttu-id="75b04-263">Utilizzare la funzionalità di Entity Framework per la gestione dello schema di riduce l'attività di amministrazione di database hello con un'applicazione partizionata basata su Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="75b04-263">Relying on EF’s capabilities for schema management reduces hello database administration effort with a sharded application built on EF.</span></span> 

<span data-ttu-id="75b04-264">La distribuzione dello schema tramite migrazioni di Entity Framework funziona al meglio con le **connessioni non aperte**.</span><span class="sxs-lookup"><span data-stu-id="75b04-264">Schema deployment through EF migrations works best on **unopened connections**.</span></span> <span data-ttu-id="75b04-265">Si tratta invece di scenario di toohello per routing dipendente dai dati che si basa su una connessione aperta hello fornita dall'API client di database elastico hello.</span><span class="sxs-lookup"><span data-stu-id="75b04-265">This is in contrast toohello scenario for data dependent routing that relies on hello opened connection provided by hello elastic database client API.</span></span> <span data-ttu-id="75b04-266">Un'altra differenza è il requisito di coerenza hello: durante la verifica coerenza tooensure auspicabile per tutti i dati dipendenti dal routing connessioni tooprotect contro la manipolazione del mappa partizioni simultanee, non è un problema con nuovo database tooa distribuzione dello schema iniziale che non è ancora stato registrato nella mappa partizioni hello e non è ancora stato allocato toohold shardlet.</span><span class="sxs-lookup"><span data-stu-id="75b04-266">Another difference is hello consistency requirement: While desirable tooensure consistency for all data-dependent routing connections tooprotect against concurrent shard map manipulation, it is not a concern with initial schema deployment tooa new database that has not yet been registered in hello shard map, and not yet been allocated toohold shardlets.</span></span> <span data-ttu-id="75b04-267">È pertanto possibile basarsi su connessioni di database normale per questa scenari, come il routing dipendente dai toodata anziché.</span><span class="sxs-lookup"><span data-stu-id="75b04-267">We can therefore rely on regular database connections for this scenarios, as opposed toodata-dependent routing.</span></span>  

<span data-ttu-id="75b04-268">In tal modo in cui la distribuzione dello schema tramite le migrazioni di Entity Framework è strettamente con la registrazione di hello del nuovo database hello come una partizione nella mappa partizioni dell'applicazione hello tooan approccio.</span><span class="sxs-lookup"><span data-stu-id="75b04-268">This leads tooan approach where schema deployment through EF migrations is tightly coupled with hello registration of hello new database as a shard in hello application’s shard map.</span></span> <span data-ttu-id="75b04-269">Questo comportamento si basa su hello seguenti prerequisiti:</span><span class="sxs-lookup"><span data-stu-id="75b04-269">This relies on hello following prerequisites:</span></span> 

* <span data-ttu-id="75b04-270">database Hello è già stato creato.</span><span class="sxs-lookup"><span data-stu-id="75b04-270">hello database has already been created.</span></span> 
* <span data-ttu-id="75b04-271">database Hello è vuoto, contiene nessuno schema utente e nessun dato utente.</span><span class="sxs-lookup"><span data-stu-id="75b04-271">hello database is empty - it holds no user schema and no user data.</span></span>
* <span data-ttu-id="75b04-272">database Hello non sono ancora accessibili attraverso le API client di database elastico hello per il routing dipendente dai dati.</span><span class="sxs-lookup"><span data-stu-id="75b04-272">hello database cannot yet be accessed through hello elastic database client APIs for data-dependent routing.</span></span> 

<span data-ttu-id="75b04-273">Con questi prerequisiti soddisfatti, è possibile creare una normale non aperto **SqlConnection** tookick off le migrazioni di Entity Framework per la distribuzione dello schema.</span><span class="sxs-lookup"><span data-stu-id="75b04-273">With these prerequisites in place, we can create a regular un-opened **SqlConnection** tookick off EF migrations for schema deployment.</span></span> <span data-ttu-id="75b04-274">Questo approccio viene illustrato nell'esempio di codice seguente Hello.</span><span class="sxs-lookup"><span data-stu-id="75b04-274">hello following code sample illustrates this approach.</span></span> 

        // Enter a new shard - i.e. an empty database - toohello shard map, allocate a first tenant tooit  
        // and kick off EF intialization of hello database toodeploy schema 

        public void RegisterNewShard(string server, string database, string connStr, int key) 
        { 

            Shard shard = this.ShardMap.CreateShard(new ShardLocation(server, database)); 

            SqlConnectionStringBuilder connStrBldr = new SqlConnectionStringBuilder(connStr); 
            connStrBldr.DataSource = server; 
            connStrBldr.InitialCatalog = database; 

            // Go into a DbContext tootrigger migrations and schema deployment for hello new shard. 
            // This requires an un-opened connection. 
            using (var db = new ElasticScaleContext<int>(connStrBldr.ConnectionString)) 
            { 
                // Run a query tooengage EF migrations 
                (from b in db.Blogs 
                    select b).Count(); 
            } 

            // Register hello mapping of hello tenant toohello shard in hello shard map. 
            // After this step, data-dependent routing on hello shard map can be used 

            this.ShardMap.CreatePointMapping(key, shard); 
        } 


<span data-ttu-id="75b04-275">Questo esempio viene illustrato il metodo hello **RegisterNewShard** che registri hello partizioni nella mappa partizioni hello, distribuisce lo schema di hello tramite migrazioni EF e archivia un mapping di una partizione toohello chiave di partizionamento orizzontale.</span><span class="sxs-lookup"><span data-stu-id="75b04-275">This sample shows hello method **RegisterNewShard** that registers hello shard in hello shard map, deploys hello schema through EF migrations, and stores a mapping of a sharding key toohello shard.</span></span> <span data-ttu-id="75b04-276">Si basa su un costruttore di hello **DbContext** sottoclasse (**ElasticScaleContext** nell'esempio hello) che accetta come input una stringa di connessione SQL.</span><span class="sxs-lookup"><span data-stu-id="75b04-276">It relies on a constructor of hello **DbContext** subclass (**ElasticScaleContext** in hello sample) that takes a SQL connection string as input.</span></span> <span data-ttu-id="75b04-277">codice Hello di questo costruttore è semplice, come hello esempio illustrato di seguito:</span><span class="sxs-lookup"><span data-stu-id="75b04-277">hello code of this constructor is straight-forward, as hello following example shows:</span></span> 

        // C'tor toodeploy schema and migrations tooa new shard 
        protected internal ElasticScaleContext(string connectionString) 
            : base(SetInitializerForConnection(connectionString)) 
        { 
        } 

        // Only static methods are allowed in calls into base class c'tors 
        private static string SetInitializerForConnection(string connnectionString) 
        { 
            // We want existence checks so that hello schema can get deployed 
            Database.SetInitializer<ElasticScaleContext<T>>( 
        new CreateDatabaseIfNotExists<ElasticScaleContext<T>>()); 

            return connnectionString; 
        } 

<span data-ttu-id="75b04-278">Versione di hello del costruttore hello ereditati dalla classe base hello uno potrebbe avere usato.</span><span class="sxs-lookup"><span data-stu-id="75b04-278">One might have used hello version of hello constructor inherited from hello base class.</span></span> <span data-ttu-id="75b04-279">Ma hello codice esigenze tooensure che hello inizializzatore predefinito per Entity Framework viene usato durante la connessione.</span><span class="sxs-lookup"><span data-stu-id="75b04-279">But hello code needs tooensure that hello default initializer for EF is used when connecting.</span></span> <span data-ttu-id="75b04-280">Di conseguenza hello deviazione breve in un metodo statico hello prima di chiamare il costruttore della classe base hello con la stringa di connessione hello.</span><span class="sxs-lookup"><span data-stu-id="75b04-280">Hence hello short detour into hello static method before calling into hello base class constructor with hello connection string.</span></span> <span data-ttu-id="75b04-281">Si noti che la registrazione di hello di partizioni deve essere eseguito in un tooensure dominio o un processo app diverse impostazioni di inizializzatore hello per Entity Framework non sono in conflitto.</span><span class="sxs-lookup"><span data-stu-id="75b04-281">Note that hello registration of shards should run in a different app domain or process tooensure that hello initializer settings for EF do not conflict.</span></span> 

## <a name="limitations"></a><span data-ttu-id="75b04-282">Limitazioni</span><span class="sxs-lookup"><span data-stu-id="75b04-282">Limitations</span></span>
<span data-ttu-id="75b04-283">approcci Hello descritti nel presente documento comportano un paio di limitazioni:</span><span class="sxs-lookup"><span data-stu-id="75b04-283">hello approaches outlined in this document entail a couple of limitations:</span></span> 

* <span data-ttu-id="75b04-284">Le applicazioni Entity Framework che utilizzano **LocalDb** prima di tutto necessario database di SQL Server toomigrate tooa normale prima di utilizzare una libreria client di database elastico.</span><span class="sxs-lookup"><span data-stu-id="75b04-284">EF applications that use **LocalDb** first need toomigrate tooa regular SQL Server database before using elastic database client library.</span></span> <span data-ttu-id="75b04-285">Con **LocalDb**non è possibile scalare orizzontalmente un'applicazione mediante il partizionamento orizzontale con la scalabilità elastica.</span><span class="sxs-lookup"><span data-stu-id="75b04-285">Scaling out an application through sharding with Elastic Scale is not possible with **LocalDb**.</span></span> <span data-ttu-id="75b04-286">Per lo sviluppo è comunque possibile usare **LocalDb**.</span><span class="sxs-lookup"><span data-stu-id="75b04-286">Note that development can still use **LocalDb**.</span></span> 
* <span data-ttu-id="75b04-287">Qualsiasi applicazione toohello modifiche che implicano modifiche dello schema di database è necessario toogo tramite le migrazioni di EF su tutte le partizioni.</span><span class="sxs-lookup"><span data-stu-id="75b04-287">Any changes toohello application that imply database schema changes need toogo through EF migrations on all shards.</span></span> <span data-ttu-id="75b04-288">codice di esempio Hello per questo documento viene illustrato come toodo questo.</span><span class="sxs-lookup"><span data-stu-id="75b04-288">hello sample code for this document does not demonstrate how toodo this.</span></span> <span data-ttu-id="75b04-289">Considerare l'utilizzo di Update-Database con un tooiterate parametro ConnectionString su tutte le partizioni; estrazione hello T-SQL script o del hello in sospeso la migrazione tramite Update-Database con hello - opzione di Script e applicare le partizioni tooyour script hello T-SQL.</span><span class="sxs-lookup"><span data-stu-id="75b04-289">Consider using Update-Database with a ConnectionString parameter tooiterate over all shards; or extract hello T-SQL script for hello pending migration using Update-Database with hello -Script option and apply hello T-SQL script tooyour shards.</span></span>  
* <span data-ttu-id="75b04-290">Data una richiesta, si presuppone che tutti i processi del database è contenuto all'interno di una singola partizione come identificato dalla chiave di partizionamento orizzontale hello fornita dalla richiesta hello.</span><span class="sxs-lookup"><span data-stu-id="75b04-290">Given a request, it is assumed that all of its database processing is contained within a single shard as identified by hello sharding key provided by hello request.</span></span> <span data-ttu-id="75b04-291">Questo presupposto, tuttavia, non è sempre valido,</span><span class="sxs-lookup"><span data-stu-id="75b04-291">However, this assumption does not always hold true.</span></span> <span data-ttu-id="75b04-292">Ad esempio, quando non è possibile toomake una chiave di partizionamento orizzontale disponibile.</span><span class="sxs-lookup"><span data-stu-id="75b04-292">For example, when it is not possible toomake a sharding key available.</span></span> <span data-ttu-id="75b04-293">tooaddress, hello libreria client fornisce hello **MultiShardQuery** classe che implementa un'astrazione di connessione per l'esecuzione di query su più partizioni.</span><span class="sxs-lookup"><span data-stu-id="75b04-293">tooaddress this, hello client library provides hello **MultiShardQuery** class that implements a connection abstraction for querying over several shards.</span></span> <span data-ttu-id="75b04-294">Apprendimento hello toouse **MultiShardQuery** in combinazione con Entity Framework è oltre l'ambito di hello di questo documento</span><span class="sxs-lookup"><span data-stu-id="75b04-294">Learning toouse hello **MultiShardQuery** in combination with EF is beyond hello scope of this document</span></span>

## <a name="conclusion"></a><span data-ttu-id="75b04-295">Conclusioni</span><span class="sxs-lookup"><span data-stu-id="75b04-295">Conclusion</span></span>
<span data-ttu-id="75b04-296">Passaggi hello descritte nel presente documento, le applicazioni di EF possono utilizzare funzionalità della libreria di hello database elastico client per i dati dipendenti routing effettuando il refactoring di costruttori di hello **DbContext** sottoclassi utilizzate in hello EF applicazione.</span><span class="sxs-lookup"><span data-stu-id="75b04-296">Through hello steps outlined in this document, EF applications can use hello elastic database client library's capability for data dependent routing by refactoring constructors of hello **DbContext** subclasses used in hello EF application.</span></span> <span data-ttu-id="75b04-297">Toothose punti in cui è necessaria la modifica di hello limiti **DbContext** classi esistono già.</span><span class="sxs-lookup"><span data-stu-id="75b04-297">This limits hello  changes required toothose places where **DbContext** classes already exist.</span></span> <span data-ttu-id="75b04-298">Inoltre, le applicazioni Entity Framework è possono continuare toobenefit dalla distribuzione automatica dello schema combinando i passaggi di hello che richiamano hello necessarie EF migrazioni con la registrazione di hello di nuove partizioni e i mapping nella mappa partizioni hello.</span><span class="sxs-lookup"><span data-stu-id="75b04-298">In addition, EF applications can continue toobenefit from automatic schema deployment by combining hello steps that invoke hello necessary EF migrations with hello registration of new shards and mappings in hello shard map.</span></span> 

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-scale-use-entity-framework-applications-visual-studio/sample.png
