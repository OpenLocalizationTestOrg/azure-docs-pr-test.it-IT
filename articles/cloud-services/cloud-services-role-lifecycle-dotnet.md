---
title: Gestire eventi del ciclo di vita dei servizi cloud | Documentazione Microsoft
description: Informazioni su come utilizzare i metodi del ciclo di vita di un ruolo del Servizio Cloud in .NET
services: cloud-services
documentationcenter: .net
author: Thraka
manager: timlt
editor: 
ms.assetid: 39b30acd-57b9-48b7-a7c4-40ea3430e451
ms.service: cloud-services
ms.workload: tbd
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/18/2017
ms.author: adegeo
ms.openlocfilehash: eb78c05df3b3cdf3887334c11bdabd5cebb74747
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/03/2017
---
# <a name="customize-the-lifecycle-of-a-web-or-worker-role-in-net"></a><span data-ttu-id="2915b-103">Personalizzare il ciclo di vita di un ruolo Web o di lavoro in .NET</span><span class="sxs-lookup"><span data-stu-id="2915b-103">Customize the Lifecycle of a Web or Worker role in .NET</span></span>
<span data-ttu-id="2915b-104">Quando si crea un ruolo di lavoro, si estende la classe [RoleEntryPoint](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.aspx) che fornisce metodi per la sovrascrittura che consentono di rispondere agli eventi del ciclo di vita.</span><span class="sxs-lookup"><span data-stu-id="2915b-104">When you create a worker role, you extend the [RoleEntryPoint](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.aspx) class which provides methods for you to override that let you respond to lifecycle events.</span></span> <span data-ttu-id="2915b-105">Per i ruoli Web questa classe è facoltativa, molto utilizzata per rispondere agli eventi del ciclo di vita.</span><span class="sxs-lookup"><span data-stu-id="2915b-105">For web roles this class is optional, so you must use it to respond to lifecycle events.</span></span>

## <a name="extend-the-roleentrypoint-class"></a><span data-ttu-id="2915b-106">Estendere la classe RoleEntryPoint</span><span class="sxs-lookup"><span data-stu-id="2915b-106">Extend the RoleEntryPoint class</span></span>
<span data-ttu-id="2915b-107">La classe [RoleEntryPoint](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.aspx) include metodi che vengono chiamati da Azure quando **avvia**, **esegue** o **arresta** un ruolo Web o di lavoro.</span><span class="sxs-lookup"><span data-stu-id="2915b-107">The [RoleEntryPoint](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.aspx) class includes methods that are called by Azure when it **starts**, **runs**, or **stops** a web or worker role.</span></span> <span data-ttu-id="2915b-108">Facoltativamente, è possibile ignorare questi metodi per gestire l'inizializzazione, sequenze di arresto o il thread di esecuzione del ruolo.</span><span class="sxs-lookup"><span data-stu-id="2915b-108">You can optionally override these methods to manage role initialization, role shutdown sequences, or the execution thread of the role.</span></span> 

<span data-ttu-id="2915b-109">Quando si estende **RoleEntryPoint**è necessario tenere presente i seguenti comportamenti dei metodi:</span><span class="sxs-lookup"><span data-stu-id="2915b-109">When extending **RoleEntryPoint**, you should be aware of the following behaviors of the methods:</span></span>

* <span data-ttu-id="2915b-110">I metodi [OnStart](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.onstart.aspx) e [OnStop](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx) restituiscono un valore booleano ed è quindi possibile che da questi metodi venga restituito **false**.</span><span class="sxs-lookup"><span data-stu-id="2915b-110">The [OnStart](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.onstart.aspx) and [OnStop](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.onstop.aspx) methods return a boolean value, so it is possible to return **false** from these methods.</span></span>
  
   <span data-ttu-id="2915b-111">Se il codice restituisce **false**il processo del ruolo viene interrotto improvvisamente, senza eseguire nessuna sequenza di arresto in programma.</span><span class="sxs-lookup"><span data-stu-id="2915b-111">If your code returns **false**, the role process is abruptly terminated, without running any shutdown sequence you may have in place.</span></span> <span data-ttu-id="2915b-112">In generale, è consigliabile evitare la restituzione di **false** dal metodo **OnStart**.</span><span class="sxs-lookup"><span data-stu-id="2915b-112">In general, you should avoid returning **false** from the **OnStart** method.</span></span>
* <span data-ttu-id="2915b-113">Qualsiasi eccezione non rilevata all'interno di un overload di un metodo **RoleEntryPoint** viene considerato come un'eccezione non gestita.</span><span class="sxs-lookup"><span data-stu-id="2915b-113">Any uncaught exception within an overload of a **RoleEntryPoint** method is treated as an unhandled exception.</span></span>
  
   <span data-ttu-id="2915b-114">Se si verifica un'eccezione all'interno di uno dei metodi del ciclo di vita, Azure genera l’evento [UnhandledException](https://msdn.microsoft.com/library/system.appdomain.unhandledexception.aspx) e il processo viene interrotto.</span><span class="sxs-lookup"><span data-stu-id="2915b-114">If an exception occurs within one of the lifecycle methods, Azure will raise the [UnhandledException](https://msdn.microsoft.com/library/system.appdomain.unhandledexception.aspx) event, and then the process is terminated.</span></span> <span data-ttu-id="2915b-115">Quando il ruolo viene portato offline, viene riavviato da Azure.</span><span class="sxs-lookup"><span data-stu-id="2915b-115">After your role has been taken offline, it will be restarted by Azure.</span></span> <span data-ttu-id="2915b-116">Quando si verifica un'eccezione non gestita, l’evento [Stopping](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleenvironment.stopping.aspx) non viene generato e il metodo **OnStop** non viene chiamato.</span><span class="sxs-lookup"><span data-stu-id="2915b-116">When an unhandled exception occurs, the [Stopping](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleenvironment.stopping.aspx) event is not raised, and the **OnStop** method is not called.</span></span>

<span data-ttu-id="2915b-117">Se il ruolo non viene avviato o passa in modo ciclico tra gli stati di arresto, di inizializzazione e di occupato, il codice potrebbe generare un'eccezione non gestita all'interno di uno degli eventi del ciclo di vita ogni volta che il ruolo viene riavviato.</span><span class="sxs-lookup"><span data-stu-id="2915b-117">If your role does not start, or is recycling between the initializing, busy, and stopping states, your code may be throwing an unhandled exception within one of the lifecycle events each time the role restarts.</span></span> <span data-ttu-id="2915b-118">In questo caso, utilizzare l’evento [UnhandledException](https://msdn.microsoft.com/library/system.appdomain.unhandledexception.aspx) per determinare la causa dell'eccezione e gestirla nel modo appropriato.</span><span class="sxs-lookup"><span data-stu-id="2915b-118">In this case, use the [UnhandledException](https://msdn.microsoft.com/library/system.appdomain.unhandledexception.aspx) event to determine the cause of the exception and handle it appropriately.</span></span> <span data-ttu-id="2915b-119">Il ruolo potrebbe anche essere restituito dal metodo [Run](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.run.aspx) che causa il riavvio del ruolo.</span><span class="sxs-lookup"><span data-stu-id="2915b-119">Your role may also be returning from the [Run](https://msdn.microsoft.com/library/azure/microsoft.windowsazure.serviceruntime.roleentrypoint.run.aspx) method, which causes the role to restart.</span></span> <span data-ttu-id="2915b-120">Per ulteriori informazioni sugli stati di distribuzione, vedere [problemi comuni che causano il riciclo dei ruoli](cloud-services-troubleshoot-common-issues-which-cause-roles-recycle.md).</span><span class="sxs-lookup"><span data-stu-id="2915b-120">For more information about deployment states, see [Common Issues Which Cause Roles to Recycle](cloud-services-troubleshoot-common-issues-which-cause-roles-recycle.md).</span></span>

> [!NOTE]
> <span data-ttu-id="2915b-121">Se si usano gli **strumenti di Azure per Microsoft Visual Studio** per sviluppare l'applicazione, i modelli di progetto di ruolo estendono automaticamente la classe **RoleEntryPoint** nei file *WebRole.cs* e *WorkerRole.cs*.</span><span class="sxs-lookup"><span data-stu-id="2915b-121">If you are using the **Azure Tools for Microsoft Visual Studio** to develop your application, the role project templates automatically extend the **RoleEntryPoint** class for you, in the *WebRole.cs* and *WorkerRole.cs* files.</span></span>
> 
> 

## <a name="onstart-method"></a><span data-ttu-id="2915b-122">Metodo OnStart</span><span class="sxs-lookup"><span data-stu-id="2915b-122">OnStart method</span></span>
<span data-ttu-id="2915b-123">Il metodo **OnStart** viene chiamato quando l'istanza del ruolo viene portata online da Azure.</span><span class="sxs-lookup"><span data-stu-id="2915b-123">The **OnStart** method is called when your role instance is brought online by Azure.</span></span> <span data-ttu-id="2915b-124">Mentre il codice OnStart viene eseguito, l'istanza del ruolo è contrassegnata come **occupata** e non verrà indirizzato alcun traffico esterno dal bilanciamento del carico.</span><span class="sxs-lookup"><span data-stu-id="2915b-124">While the OnStart code is executing, the role instance is marked as **Busy** and no external traffic will be directed to it by the load balancer.</span></span> <span data-ttu-id="2915b-125">È possibile eseguire l'override di questo metodo per eseguire operazioni di inizializzazione, ad esempio implementare i gestori eventi e avviare la [diagnostica Azure](cloud-services-how-to-monitor.md).</span><span class="sxs-lookup"><span data-stu-id="2915b-125">You can override this method to perform initialization work, such as implementing event handlers and starting [Azure Diagnostics](cloud-services-how-to-monitor.md).</span></span>

<span data-ttu-id="2915b-126">Se **OnStart** restituisce **true**, l'inizializzazione dell'istanza viene completata e Azure chiama il metodo **RoleEntryPoint.Run**.</span><span class="sxs-lookup"><span data-stu-id="2915b-126">If **OnStart** returns **true**, the instance is successfully initialized and Azure calls the **RoleEntryPoint.Run** method.</span></span> <span data-ttu-id="2915b-127">Se **OnStart** restituisce **false**, il ruolo termina immediatamente senza eseguire alcuna sequenza di arresto pianificata.</span><span class="sxs-lookup"><span data-stu-id="2915b-127">If **OnStart** returns **false**, the role terminates immediately, without executing any planned shutdown sequences.</span></span>

<span data-ttu-id="2915b-128">Il seguente esempio di codice illustra come eseguire l'override del metodo **OnStart** .</span><span class="sxs-lookup"><span data-stu-id="2915b-128">The following code example shows how to override the **OnStart** method.</span></span> <span data-ttu-id="2915b-129">Questo metodo configura e avvia un monitor di diagnostica all’avvio dell'istanza del ruolo e imposta il trasferimento dei dati di registrazione in un account di archiviazione:</span><span class="sxs-lookup"><span data-stu-id="2915b-129">This method configures and starts a diagnostic monitor when the role instance starts and sets up a transfer of logging data to a storage account:</span></span>

```csharp
public override bool OnStart()
{
    var config = DiagnosticMonitor.GetDefaultInitialConfiguration();

    config.DiagnosticInfrastructureLogs.ScheduledTransferLogLevelFilter = LogLevel.Error;
    config.DiagnosticInfrastructureLogs.ScheduledTransferPeriod = TimeSpan.FromMinutes(5);

    DiagnosticMonitor.Start("DiagnosticsConnectionString", config);

    return true;
}
```

## <a name="onstop-method"></a><span data-ttu-id="2915b-130">Metodo OnStop</span><span class="sxs-lookup"><span data-stu-id="2915b-130">OnStop method</span></span>
<span data-ttu-id="2915b-131">Il metodo **OnStop** viene chiamato quando un'istanza del ruolo viene portata offline da Azure e prima della chiusura del processo.</span><span class="sxs-lookup"><span data-stu-id="2915b-131">The **OnStop** method is called after a role instance has been taken offline by Azure and before the process exits.</span></span> <span data-ttu-id="2915b-132">È possibile eseguire l'override di questo metodo per chiamare il codice necessario affinché l'istanza del ruolo effettui un arresto normale.</span><span class="sxs-lookup"><span data-stu-id="2915b-132">You can override this method to call code required for your role instance to cleanly shut down.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="2915b-133">Il codice in esecuzione nel metodo **OnStop** presenta un tempo di completamento limitato quando viene chiamato per motivi diversi da un arresto avviato dall'utente.</span><span class="sxs-lookup"><span data-stu-id="2915b-133">Code running in the **OnStop** method has a limited time to finish when it is called for reasons other than a user-initiated shutdown.</span></span> <span data-ttu-id="2915b-134">Trascorso tale tempo, il processo viene terminato ed è quindi necessario assicurarsi che il codice del metodo **OnStop** possa essere eseguito rapidamente o tolleri il mancato completamento.</span><span class="sxs-lookup"><span data-stu-id="2915b-134">After this time elapses, the process is terminated, so you must make sure that code in the **OnStop** method can run quickly or tolerates not running to completion.</span></span> <span data-ttu-id="2915b-135">Il metodo **OnStop** viene chiamato dopo la generazione dell'evento **Stopping**.</span><span class="sxs-lookup"><span data-stu-id="2915b-135">The **OnStop** method is called after the **Stopping** event is raised.</span></span>
> 
> 

## <a name="run-method"></a><span data-ttu-id="2915b-136">Metodo Run</span><span class="sxs-lookup"><span data-stu-id="2915b-136">Run method</span></span>
<span data-ttu-id="2915b-137">È possibile eseguire l'override del metodo **Run** per implementare un thread a esecuzione prolungata per l'istanza del ruolo.</span><span class="sxs-lookup"><span data-stu-id="2915b-137">You can override the **Run** method to implement a long-running thread for your role instance.</span></span>

<span data-ttu-id="2915b-138">L’esecuzione dell'override del metodo **Run** non è obbligatoria, l'implementazione predefinita avvia un thread in costante stato di sospensione.</span><span class="sxs-lookup"><span data-stu-id="2915b-138">Overriding the **Run** method is not required; the default implementation starts a thread that sleeps forever.</span></span> <span data-ttu-id="2915b-139">Se si esegue l'override del metodo **Run** , il codice dovrebbe bloccarsi in modo indefinito.</span><span class="sxs-lookup"><span data-stu-id="2915b-139">If you do override the **Run** method, your code should block indefinitely.</span></span> <span data-ttu-id="2915b-140">Se il metodo **Run** restituisce un valore, il ruolo viene riciclato normalmente in modo automatico. In altre parole, Azure genera l'evento **Stopping** e chiama il metodo **OnStop** in modo che le sequenze di arresto possano essere eseguite prima che il ruolo venga portato offline.</span><span class="sxs-lookup"><span data-stu-id="2915b-140">If the **Run** method returns, the role is automatically gracefully recycled; in other words, Azure raises the **Stopping** event and calls the **OnStop** method so that your shutdown sequences may be executed before the role is taken offline.</span></span>

### <a name="implementing-the-aspnet-lifecycle-methods-for-a-web-role"></a><span data-ttu-id="2915b-141">Implementazione dei metodi del ciclo di vita ASP.NET per un ruolo web</span><span class="sxs-lookup"><span data-stu-id="2915b-141">Implementing the ASP.NET lifecycle methods for a web role</span></span>
<span data-ttu-id="2915b-142">È possibile utilizzare i metodi del ciclo di vita ASP.NET, oltre a quelli forniti dalla classe **RoleEntryPoint** , per gestire le sequenze di inizializzazione e di arresto per un ruolo web.</span><span class="sxs-lookup"><span data-stu-id="2915b-142">You can use the ASP.NET lifecycle methods, in addition to those provided by the **RoleEntryPoint** class, to manage initialization and shutdown sequences for a web role.</span></span> <span data-ttu-id="2915b-143">Potrebbe essere utile per motivi di compatibilità se si trasferisce un'applicazione ASP.NET esistente in Azure.</span><span class="sxs-lookup"><span data-stu-id="2915b-143">This may be useful for compatibility purposes if you are porting an existing ASP.NET application to Azure.</span></span> <span data-ttu-id="2915b-144">I metodi del ciclo di vita ASP.NET vengono chiamati dall'interno dei metodi **RoleEntryPoint** .</span><span class="sxs-lookup"><span data-stu-id="2915b-144">The ASP.NET lifecycle methods are called from within the **RoleEntryPoint** methods.</span></span> <span data-ttu-id="2915b-145">Il metodo **Application\_Start** viene chiamato al termine del metodo **RoleEntryPoint.OnStart**.</span><span class="sxs-lookup"><span data-stu-id="2915b-145">The **Application\_Start** method is called after the **RoleEntryPoint.OnStart** method finishes.</span></span> <span data-ttu-id="2915b-146">Il metodo **Application\_End** viene chiamato prima del metodo **RoleEntryPoint.OnStop**.</span><span class="sxs-lookup"><span data-stu-id="2915b-146">The **Application\_End** method is called before the **RoleEntryPoint.OnStop** method is called.</span></span>

## <a name="next-steps"></a><span data-ttu-id="2915b-147">Passaggi successivi</span><span class="sxs-lookup"><span data-stu-id="2915b-147">Next steps</span></span>
<span data-ttu-id="2915b-148">Informazioni su come [creare un pacchetto del servizio cloud](cloud-services-model-and-package.md).</span><span class="sxs-lookup"><span data-stu-id="2915b-148">Learn how to [create a cloud service package](cloud-services-model-and-package.md).</span></span>

