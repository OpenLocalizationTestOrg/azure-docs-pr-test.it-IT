---
title: Proteggere Active Directory e DNS con Azure Site Recovery | Documentazione Microsoft
description: Questo articolo descrive come implementare una soluzione di ripristino di emergenza per Active Directory usando Azure Site Recovery.
services: site-recovery
documentationcenter: 
author: prateek9us
manager: gauravd
editor: 
ms.assetid: af1d9b26-1956-46ef-bd05-c545980b72dc
ms.service: site-recovery
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: storage-backup-recovery
ms.date: 7/20/2017
ms.author: pratshar
ms.openlocfilehash: 197441fc24c178695d4eada6db59f503b21672ad
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/03/2017
---
# <a name="protect-active-directory-and-dns-with-azure-site-recovery"></a><span data-ttu-id="1b434-103">Proteggere Active Directory e DNS con Azure Site Recovery</span><span class="sxs-lookup"><span data-stu-id="1b434-103">Protect Active Directory and DNS with Azure Site Recovery</span></span>
<span data-ttu-id="1b434-104">Le applicazioni aziendali, ad esempio SharePoint, Dynamics AX e SAP, dipendono dall'infrastruttura di Active Directory e DNS per funzionare correttamente.</span><span class="sxs-lookup"><span data-stu-id="1b434-104">Enterprise applications such as SharePoint, Dynamics AX, and SAP depend on Active Directory and a DNS infrastructure to function correctly.</span></span> <span data-ttu-id="1b434-105">Quando si crea una soluzione di ripristino di emergenza per le applicazioni, è importante ricordare che è necessario proteggere e ripristinare Active Directory e DNS prima degli altri componenti di un'applicazione, per assicurarsi che tutto funzioni correttamente in caso di emergenza.</span><span class="sxs-lookup"><span data-stu-id="1b434-105">When you create a disaster recovery solution for applications, it's important to remember that you need to protect and recover Active Directory and DNS before the other application components, to ensure that things function correctly when disaster occurs.</span></span>

<span data-ttu-id="1b434-106">Site Recovery è un servizio di Azure che fornisce il ripristino di emergenza orchestrando la replica, il failover e il ripristino delle macchine virtuali.</span><span class="sxs-lookup"><span data-stu-id="1b434-106">Site Recovery is an Azure service that provides disaster recovery by orchestrating replication, failover, and recovery of virtual machines.</span></span> <span data-ttu-id="1b434-107">Site Recovery supporta vari scenari di replica per la protezione e il failover semplice delle macchine virtuali e delle applicazioni nei cloud pubblici, privati o di provider di servizi di hosting.</span><span class="sxs-lookup"><span data-stu-id="1b434-107">Site Recovery supports a number of replication scenarios to consistently protect, and seamlessly failover virtual machines and applications to private, public, or hoster clouds.</span></span>

<span data-ttu-id="1b434-108">Con Site Recovery è possibile creare un piano di ripristino di emergenza interamente automatizzato per Active Directory.</span><span class="sxs-lookup"><span data-stu-id="1b434-108">Using Site Recovery, you can create a complete automated disaster recovery plan for Active Directory.</span></span> <span data-ttu-id="1b434-109">In caso di interruzione, è possibile avviare un failover in pochi secondi da qualsiasi luogo e fare in modo che Active Directory sia operativo in pochi minuti.</span><span class="sxs-lookup"><span data-stu-id="1b434-109">When disruptions occur, you can initiate a failover within seconds from anywhere and get Active Directory up and running in a few minutes.</span></span> <span data-ttu-id="1b434-110">Se si è distribuito Active Directory per più applicazioni, ad esempio SharePoint e SAP nel sito primario, e si vuole eseguire il failover del sito completo, è possibile eseguire prima il failover di Active Directory tramite Site Recovery e quindi il failover delle altre applicazioni usando piani di ripristino specifici per ogni applicazione.</span><span class="sxs-lookup"><span data-stu-id="1b434-110">If you've deployed Active Directory for multiple applications such as SharePoint and SAP in your primary site, and you want to fail over the complete site, you can fail over Active Directory first using Site Recovery, and then fail over the other applications using application-specific recovery plans.</span></span>

<span data-ttu-id="1b434-111">In questo articolo viene spiegato come creare una soluzione di ripristino di emergenza per Active Directory, come eseguire failover pianificati, non pianificati e di test usando un piano di ripristino con un solo clic, le configurazioni supportate e i prerequisiti.</span><span class="sxs-lookup"><span data-stu-id="1b434-111">This article explains how to create a disaster recovery solution for Active Directory, how to perform planned, unplanned, and test failovers using a one-click recovery plan, the supported configurations, and prerequisites.</span></span>  <span data-ttu-id="1b434-112">È necessario conoscere Active Directory e Azure Site Recovery prima di iniziare.</span><span class="sxs-lookup"><span data-stu-id="1b434-112">You should be familiar with Active Directory and Azure Site Recovery before you start.</span></span>

## <a name="replicating-domain-controller"></a><span data-ttu-id="1b434-113">Replica del controller di dominio</span><span class="sxs-lookup"><span data-stu-id="1b434-113">Replicating Domain Controller</span></span>

<span data-ttu-id="1b434-114">È necessario configurare la [replica con Site Recovery](#enable-protection-using-site-recovery) in almeno una macchina virtuale che ospita controller di dominio e DNS.</span><span class="sxs-lookup"><span data-stu-id="1b434-114">You need to setup [Site Recovery replication](#enable-protection-using-site-recovery) on at least one virtual machine hosting Domain Controller and DNS.</span></span> <span data-ttu-id="1b434-115">Se nell'ambiente sono presenti [più controller di dominio](#environment-with-multiple-domain-controllers), oltre a replicare la macchina virtuale controller di dominio con Site Recovery sarà necessario anche configurare un [controller di dominio aggiuntivo](#protect-active-directory-with-active-directory-replication) nel sito di destinazione (Azure o un data center secondario locale).</span><span class="sxs-lookup"><span data-stu-id="1b434-115">If you have [multiple domain controllers](#environment-with-multiple-domain-controllers) in your environment, in addition to replicating the domain controller virtual machine with Site Recovery you would also have to set up an [additional domain controller](#protect-active-directory-with-active-directory-replication) on the target site (Azure or a secondary on-premises datacenter).</span></span> 

### <a name="single-domain-controller-environment"></a><span data-ttu-id="1b434-116">Ambiente con singolo controller di dominio</span><span class="sxs-lookup"><span data-stu-id="1b434-116">Single domain controller environment</span></span>
<span data-ttu-id="1b434-117">Se sono presenti un numero ridotto di applicazioni e un singolo controller di dominio e si vuole eseguire il failover dell'intero sito, è consigliabile usare Site Recovery per replicare il controller di dominio nel sito secondario, indipendentemente dal fatto che si esegua il failover in Azure o in un sito secondario.</span><span class="sxs-lookup"><span data-stu-id="1b434-117">If you have a few applications and only a single domain controller, and you want to fail over the entire site together, then we recommend using Site Recovery to replicate the domain controller to the secondary site (whether you're failing over to Azure or to a secondary site).</span></span> <span data-ttu-id="1b434-118">La stessa macchina virtuale controller di dominio/DNS replicata può essere usata anche per il [failover di test](#test-failover-considerations).</span><span class="sxs-lookup"><span data-stu-id="1b434-118">The same replicated domain controller/DNS virtual machine can be used for [test failover](#test-failover-considerations) as well.</span></span>

### <a name="environment-with-multiple-domain-controllers"></a><span data-ttu-id="1b434-119">Ambiente con più controller di dominio</span><span class="sxs-lookup"><span data-stu-id="1b434-119">Environment with multiple domain controllers</span></span>
<span data-ttu-id="1b434-120">Se il numero di applicazioni è elevato e l'ambiente include più controller di dominio o se si intende eseguire il failover di poche applicazioni alla volta, oltre a replicare la macchina virtuale controller di dominio con Site Recovery è consigliabile anche configurare un [controller di dominio aggiuntivo](#protect-active-directory-with-active-directory-replication) nel sito di destinazione (Azure o data center secondario locale).</span><span class="sxs-lookup"><span data-stu-id="1b434-120">If you have many applications and there's more than one domain controller in the environment, or if you plan to fail over a few applications at a time, we recommend that in addition to replicating the domain controller virtual machine with Site Recovery you also set up an [additional domain controller](#protect-active-directory-with-active-directory-replication) on the target site (Azure or a secondary on-premises datacenter).</span></span> <span data-ttu-id="1b434-121">Per il [failover di test](#test-failover-considerations), usare il controller di dominio replicato da Site Recovery e per il failover, il controller di dominio aggiuntivo nel sito di destinazione.</span><span class="sxs-lookup"><span data-stu-id="1b434-121">For [test failover](#test-failover-considerations), you use domain controller replicated by Site Recovery and for failover, the additional domain controller on the target site.</span></span> 


<span data-ttu-id="1b434-122">Le sezioni seguenti illustrano come abilitare la protezione per un controller di dominio in Site Recovery e come configurare un controller di dominio in Azure.</span><span class="sxs-lookup"><span data-stu-id="1b434-122">The following sections explain how to enable protection for a domain controller in Site Recovery, and how to set up a domain controller in Azure.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="1b434-123">Prerequisiti</span><span class="sxs-lookup"><span data-stu-id="1b434-123">Prerequisites</span></span>
* <span data-ttu-id="1b434-124">Una distribuzione locale del server DNS e di Active Directory.</span><span class="sxs-lookup"><span data-stu-id="1b434-124">An on-premises deployment of Active Directory and DNS server.</span></span>
* <span data-ttu-id="1b434-125">Un insieme di credenziali dei servizi Azure Site Recovery in una sottoscrizione di Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="1b434-125">An Azure Site Recovery Services vault in a Microsoft Azure subscription.</span></span>
* <span data-ttu-id="1b434-126">Se si esegue la replica in Azure, eseguire lo strumento Azure Virtual Machine Readiness Assessment nelle VM per assicurarsi che siano compatibili con le VM di Azure e i servizi di Azure Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="1b434-126">If you're replicating to Azure, run the Azure Virtual Machine Readiness Assessment tool on VMs to ensure they're compatible with Azure VMs and Azure Site Recovery Services.</span></span>

## <a name="enable-protection-using-site-recovery"></a><span data-ttu-id="1b434-127">Abilitare la protezione usando Site Recovery</span><span class="sxs-lookup"><span data-stu-id="1b434-127">Enable protection using Site Recovery</span></span>
### <a name="protect-the-virtual-machine"></a><span data-ttu-id="1b434-128">Proteggere la macchina virtuale</span><span class="sxs-lookup"><span data-stu-id="1b434-128">Protect the virtual machine</span></span>
<span data-ttu-id="1b434-129">Abilitare la protezione della macchina virtuale controller di dominio/DNS in Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="1b434-129">Enable protection of the domain controller/DNS virtual machine in Site Recovery.</span></span> <span data-ttu-id="1b434-130">Configurare le impostazioni di Site Recovery in base al tipo di macchina virtuale (Hyper-V o VMware).</span><span class="sxs-lookup"><span data-stu-id="1b434-130">Configure Site Recovery settings based on the virtual machine type (Hyper-V or VMware).</span></span> <span data-ttu-id="1b434-131">Il controller di dominio replicato con Site Recovery viene usato per il [test di failover](#test-failover-considerations).</span><span class="sxs-lookup"><span data-stu-id="1b434-131">The domain controller replicated using Site Recovery is used for [test failover](#test-failover-considerations).</span></span> <span data-ttu-id="1b434-132">Assicurarsi che vengano soddisfatti i requisiti seguenti:</span><span class="sxs-lookup"><span data-stu-id="1b434-132">Make sure it meets the following requirements:</span></span>

1. <span data-ttu-id="1b434-133">Il controller di dominio è un server di catalogo globale</span><span class="sxs-lookup"><span data-stu-id="1b434-133">The domain controller is a global catalog server</span></span>
2. <span data-ttu-id="1b434-134">Il controller di dominio deve essere proprietario del ruolo FSMO per i ruoli che saranno necessari durante un failover di test; altrimenti questi ruoli dovranno essere [riassegnati](http://aka.ms/ad_seize_fsmo) dopo il failover.</span><span class="sxs-lookup"><span data-stu-id="1b434-134">The domain controller should be the FSMO role owner for roles that will be needed during a test failover (else these roles will need to be [seized](http://aka.ms/ad_seize_fsmo) after the failover)</span></span>

### <a name="configure-virtual-machine-network-settings"></a><span data-ttu-id="1b434-135">Configurare le impostazioni di rete della macchina virtuale</span><span class="sxs-lookup"><span data-stu-id="1b434-135">Configure virtual machine network settings</span></span>
<span data-ttu-id="1b434-136">Per la macchina virtuale controller di dominio/DNS, configurare le impostazioni di rete in Site Recovery in modo che la macchina virtuale venga collegata alla rete corretta dopo il failover.</span><span class="sxs-lookup"><span data-stu-id="1b434-136">For the domain controller/DNS virtual machine, configure network settings in Site Recovery so that the virtual machine will be attached to the right network after failover.</span></span> 

![Impostazioni di rete della VM](./media/site-recovery-active-directory/DNS-Target-IP.png)

## <a name="protect-active-directory-with-active-directory-replication"></a><span data-ttu-id="1b434-138">Proteggere Active Directory con la replica di Active Directory</span><span class="sxs-lookup"><span data-stu-id="1b434-138">Protect Active Directory with Active Directory replication</span></span>
### <a name="site-to-site-protection"></a><span data-ttu-id="1b434-139">Protezione da sito a sito</span><span class="sxs-lookup"><span data-stu-id="1b434-139">Site-to-site protection</span></span>
<span data-ttu-id="1b434-140">Creare un controller di dominio nel sito secondario.</span><span class="sxs-lookup"><span data-stu-id="1b434-140">Create a domain controller on the secondary site.</span></span> <span data-ttu-id="1b434-141">Quando si alza di livello il server al ruolo di controller di dominio, specificare il nome dello stesso dominio usato nel sito primario.</span><span class="sxs-lookup"><span data-stu-id="1b434-141">When you promote the server to a domain controller role, specify the name of the same domain that is being used on the primary site.</span></span> <span data-ttu-id="1b434-142">È possibile usare lo snap-in **Siti e servizi di Active Directory** per configurare le impostazioni nell'oggetto collegamento di sito a cui i siti vengono aggiunti.</span><span class="sxs-lookup"><span data-stu-id="1b434-142">You can use the **Active Directory Sites and Services** snap-in to configure settings on the site link object to which the sites are added.</span></span> <span data-ttu-id="1b434-143">Configurando le impostazioni in un collegamento di sito, è possibile controllare quando viene eseguita la replica tra due o più siti e con quale frequenza.</span><span class="sxs-lookup"><span data-stu-id="1b434-143">By configuring settings on a site link, you can control when replication occurs between two or more sites, and how often.</span></span> <span data-ttu-id="1b434-144">Per altre informazioni, vedere [Pianificazione della replica tra siti](https://technet.microsoft.com/library/cc731862.aspx) .</span><span class="sxs-lookup"><span data-stu-id="1b434-144">For more information, see [Scheduling Replication Between Sites](https://technet.microsoft.com/library/cc731862.aspx).</span></span>

### <a name="site-to-azure-protection"></a><span data-ttu-id="1b434-145">Protezione da sito ad Azure</span><span class="sxs-lookup"><span data-stu-id="1b434-145">Site-to-Azure protection</span></span>
<span data-ttu-id="1b434-146">Seguire le istruzioni per creare un [controller di dominio in una rete virtuale di Azure](../active-directory/active-directory-install-replica-active-directory-domain-controller.md).</span><span class="sxs-lookup"><span data-stu-id="1b434-146">Follow the instructions to [create a domain controller in an Azure virtual network](../active-directory/active-directory-install-replica-active-directory-domain-controller.md).</span></span> <span data-ttu-id="1b434-147">Quando si alza di livello il server al ruolo di controller di dominio, specificare lo stesso nome di dominio usato nel sito primario.</span><span class="sxs-lookup"><span data-stu-id="1b434-147">When you promote the server to a domain controller role, specify the same domain name that's used on the primary site.</span></span>

<span data-ttu-id="1b434-148">[Riconfigurare quindi il server DNS per la rete virtuale](../active-directory/active-directory-install-replica-active-directory-domain-controller.md#reconfigure-dns-server-for-the-virtual-network), per usare il server DNS in Azure.</span><span class="sxs-lookup"><span data-stu-id="1b434-148">Then [reconfigure the DNS server for the virtual network](../active-directory/active-directory-install-replica-active-directory-domain-controller.md#reconfigure-dns-server-for-the-virtual-network), to use the DNS server in Azure.</span></span>

![Azure Network](./media/site-recovery-active-directory/azure-network.png)

<span data-ttu-id="1b434-150">**DNS nella rete di produzione di Azure**</span><span class="sxs-lookup"><span data-stu-id="1b434-150">**DNS in Azure Production Network**</span></span>

## <a name="test-failover-considerations"></a><span data-ttu-id="1b434-151">considerazioni sul failover di test</span><span class="sxs-lookup"><span data-stu-id="1b434-151">Test failover considerations</span></span>
<span data-ttu-id="1b434-152">Il failover di test si verifica in una rete isolata dalla rete di produzione, in modo che non si verifichi alcun impatto sui carichi di lavoro di produzione.</span><span class="sxs-lookup"><span data-stu-id="1b434-152">Test failover occurs in a network that's isolated from production network so that there's no impact on production workloads.</span></span>

<span data-ttu-id="1b434-153">Inoltre la maggior parte delle applicazioni richiede la presenza di un controller di dominio e di un server DNS per funzionare.</span><span class="sxs-lookup"><span data-stu-id="1b434-153">Most applications also require the presence of a domain controller and a DNS server to function.</span></span> <span data-ttu-id="1b434-154">Prima del failover di un'applicazione, è quindi necessario creare nella rete isolata un controller di dominio da usare per il failover di test.</span><span class="sxs-lookup"><span data-stu-id="1b434-154">Therefore, before the application is failed over, a domain controller needs to be created in the isolated network to be used for test failover.</span></span> <span data-ttu-id="1b434-155">Il modo più semplice per eseguire questa operazione è replicare una macchina virtuale DNS o controller di dominio con Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="1b434-155">The easiest way to do this is to replicate a domain controller/DNS virtual machine with Site Recovery.</span></span> <span data-ttu-id="1b434-156">Eseguire quindi un failover di test della macchina virtuale controller di dominio prima di eseguire un failover di test del piano di ripristino per l'applicazione.</span><span class="sxs-lookup"><span data-stu-id="1b434-156">Then run a test failover of the domain controller virtual machine before running a test failover of the recovery plan for the application.</span></span> <span data-ttu-id="1b434-157">Di seguito viene indicato come procedere:</span><span class="sxs-lookup"><span data-stu-id="1b434-157">Here's how you do that:</span></span>

1. <span data-ttu-id="1b434-158">[Replicare](site-recovery-replicate-vmware-to-azure.md) la macchina virtuale controller di dominio/DNS usando Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="1b434-158">[Replicate](site-recovery-replicate-vmware-to-azure.md) the domain controller/DNS virtual machine using Site Recovery.</span></span>
1. <span data-ttu-id="1b434-159">Creare una rete isolata.</span><span class="sxs-lookup"><span data-stu-id="1b434-159">Create an isolated network.</span></span> <span data-ttu-id="1b434-160">Qualsiasi rete virtuale creata in Azure per impostazione predefinita è isolata dalle altre reti.</span><span class="sxs-lookup"><span data-stu-id="1b434-160">Any virtual network created in Azure by default is isolated from other networks.</span></span> <span data-ttu-id="1b434-161">È consigliabile che l'intervallo di indirizzi IP di questa rete sia lo stesso della rete di produzione.</span><span class="sxs-lookup"><span data-stu-id="1b434-161">We recommend that the IP address range for this network is same as that of your production network.</span></span> <span data-ttu-id="1b434-162">Non abilitare la connettività da sito a sito in questa rete.</span><span class="sxs-lookup"><span data-stu-id="1b434-162">Don't enable site-to-site connectivity on this network.</span></span>
1. <span data-ttu-id="1b434-163">Specificare un indirizzo IP DNS nella rete creata, come indirizzo IP previsto per la macchina virtuale DNS.</span><span class="sxs-lookup"><span data-stu-id="1b434-163">Provide a DNS IP address in the network created, as the IP address that you expect the DNS virtual machine to get.</span></span> <span data-ttu-id="1b434-164">Se si esegue la replica in Azure, specificare l'indirizzo IP per la VM usata nel failover nell'impostazione **IP di destinazione** in **Calcolo e rete**.</span><span class="sxs-lookup"><span data-stu-id="1b434-164">If you're replicating to Azure, then provide the IP address for the VM that is used on failover in **Target IP** setting in **Compute and Network** settings.</span></span> 

    <span data-ttu-id="1b434-165">![IP di destinazione](./media/site-recovery-active-directory/DNS-Target-IP.png)**IP di destinazione**</span><span class="sxs-lookup"><span data-stu-id="1b434-165">![Target IP](./media/site-recovery-active-directory/DNS-Target-IP.png) **Target IP**</span></span>

    ![Rete di test di Azure](./media/site-recovery-active-directory/azure-test-network.png)

    <span data-ttu-id="1b434-167">**DNS nella rete di test di Azure**</span><span class="sxs-lookup"><span data-stu-id="1b434-167">**DNS in Azure Test Network**</span></span>

> [!TIP]
> <span data-ttu-id="1b434-168">Site Recovery tenta di creare le macchine virtuali di test in una subnet con lo stesso nome e con lo stesso IP specificati nelle impostazioni **Calcolo e rete** della macchina virtuale.</span><span class="sxs-lookup"><span data-stu-id="1b434-168">Site Recovery attempts to create test virtual machines in a subnet of same name and using the same IP as that provided in **Compute and Network** settings of the virtual machine.</span></span> <span data-ttu-id="1b434-169">Se nella rete virtuale di Azure specificata per il failover di test non è disponibile una subnet con lo stesso nome, la macchina virtuale di test verrà creata nella prima subnet in ordine alfabetico.</span><span class="sxs-lookup"><span data-stu-id="1b434-169">If subnet of same name is not available in the Azure virtual network provided for test failover, then test virtual machine is created in the first subnet alphabetically.</span></span> <span data-ttu-id="1b434-170">Se l'indirizzo IP di destinazione fa parte della subnet scelta, Site Recovery tenta di creare la macchina virtuale per il failover di test usando l'indirizzo IP di destinazione.</span><span class="sxs-lookup"><span data-stu-id="1b434-170">If the target IP is part of the chosen subnet, then Site Recovery tries to create the test failover virtual machine using the target IP.</span></span> <span data-ttu-id="1b434-171">Se l'indirizzo IP di destinazione non fa parte della subnet scelta, la macchina virtuale del failover di test viene creata usando qualsiasi indirizzo IP disponibile nella subnet scelta.</span><span class="sxs-lookup"><span data-stu-id="1b434-171">If the target IP is not part of the chosen subnet, then test failover virtual machine gets created using any available IP in the chosen subnet.</span></span> 
>
>


1. <span data-ttu-id="1b434-172">Se si esegue la replica in un altro sito locale e si usa DHCP, seguire le istruzioni per [configurare DNS e DHCP per il failover di test](site-recovery-test-failover-vmm-to-vmm.md#prepare-dhcp)</span><span class="sxs-lookup"><span data-stu-id="1b434-172">If you're replicating to another on-premises site and you're using DHCP, follow the instructions to [setup DNS and DHCP for test failover](site-recovery-test-failover-vmm-to-vmm.md#prepare-dhcp)</span></span>
1. <span data-ttu-id="1b434-173">Eseguire un failover di test della macchina virtuale controller di dominio nella rete isolata.</span><span class="sxs-lookup"><span data-stu-id="1b434-173">Do a test failover of the domain controller virtual machine run in the isolated network.</span></span> <span data-ttu-id="1b434-174">Per effettuare il failover di test, usare il più recente punto di ripristino **coerente con l'applicazione** disponibile della macchina virtuale controller di dominio.</span><span class="sxs-lookup"><span data-stu-id="1b434-174">Use latest available **application consistent** recovery point of the domain controller virtual machine to do the test failover.</span></span> 
1. <span data-ttu-id="1b434-175">Eseguire un failover di test per il piano di ripristino che contiene le macchine virtuali dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="1b434-175">Run a test failover for the recovery plan that contains virtual machines of the application.</span></span> 
1. <span data-ttu-id="1b434-176">Al termine del test, eseguire la **pulizia del failover di test** nella macchina virtuale controller di dominio.</span><span class="sxs-lookup"><span data-stu-id="1b434-176">After testing is complete, **Cleanup test failover** on the domain controller virtual machine.</span></span> <span data-ttu-id="1b434-177">Questo passaggio consente di eliminare il controller di dominio creato per il failover di test.</span><span class="sxs-lookup"><span data-stu-id="1b434-177">This step deletes the domain controller that was created for test failover.</span></span>


### <a name="removing-reference-to-other-domain-controllers"></a><span data-ttu-id="1b434-178">Rimozione del riferimento ad altri controller di dominio</span><span class="sxs-lookup"><span data-stu-id="1b434-178">Removing reference to other domain controllers</span></span>
<span data-ttu-id="1b434-179">Quando si esegue un failover di test, nella rete di test non si includono tutti i controller di dominio.</span><span class="sxs-lookup"><span data-stu-id="1b434-179">When you are doing a test failover, you don't bring all the domain controllers in the test network.</span></span> <span data-ttu-id="1b434-180">Per rimuovere il riferimento ad altri controller di dominio presenti nell'ambiente di produzione, è necessario [riassegnare i ruoli FSMO](http://aka.ms/ad_seize_fsmo) ed [eseguire la pulizia](https://technet.microsoft.com/library/cc816907.aspx) dei metadati per i controller di dominio mancanti.</span><span class="sxs-lookup"><span data-stu-id="1b434-180">To remove the reference of other domain controllers that exist in your production environment, you might need to [seize FSMO Active Directory roles](http://aka.ms/ad_seize_fsmo) and do [metadata cleanup](https://technet.microsoft.com/library/cc816907.aspx) for missing domain controllers.</span></span> 



> [!IMPORTANT]
> <span data-ttu-id="1b434-181">Alcune configurazioni descritte nella sezione seguente non sono le configurazioni di controller di dominio standard/predefinite.</span><span class="sxs-lookup"><span data-stu-id="1b434-181">Some of the configurations described in the following section are not the standard/default domain controller configurations.</span></span> <span data-ttu-id="1b434-182">Se non si vuole apportare queste modifiche a un controller di dominio in produzione, è possibile creare un controller di dominio dedicato da usare per il failover del test di Site Recovery e apportarvi queste modifiche.</span><span class="sxs-lookup"><span data-stu-id="1b434-182">If you don't want to make these changes to a production domain controller, then you can create a domain controller dedicated to be used for Site Recovery test failover and make these changes to that.</span></span>  
>
>

### <a name="issues-because-of-virtualization-safeguards"></a><span data-ttu-id="1b434-183">Problemi dovuti alle misure di sicurezza della virtualizzazione</span><span class="sxs-lookup"><span data-stu-id="1b434-183">Issues because of virtualization safeguards</span></span> 

<span data-ttu-id="1b434-184">A partire da Windows Server 2012, [sono state integrate misure di sicurezza aggiuntive in Active Directory Domain Services](https://technet.microsoft.com/windows-server-docs/identity/ad-ds/introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100).</span><span class="sxs-lookup"><span data-stu-id="1b434-184">Beginning with Windows Server 2012, [additional safeguards have been built into Active Directory Domain Services](https://technet.microsoft.com/windows-server-docs/identity/ad-ds/introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100).</span></span> <span data-ttu-id="1b434-185">Queste misure di sicurezza consentono di proteggere i controller di dominio virtualizzati dai ripristino dello stato precedente USN, purché la piattaforma hypervisor sottostante supporti VM-GenerationID.</span><span class="sxs-lookup"><span data-stu-id="1b434-185">These safeguards help protect virtualized domain controllers against USN Rollbacks, as long as the underlying hypervisor platform supports VM-GenerationID.</span></span> <span data-ttu-id="1b434-186">Azure supporta VM-GenerationID e ciò significa che nei controller di dominio che eseguono Windows Server 2012 o versione successiva in macchine virtuali di Azure sono disponibili misure di sicurezza aggiuntive.</span><span class="sxs-lookup"><span data-stu-id="1b434-186">Azure supports VM-GenerationID, which means that domain controllers that run Windows Server 2012 or later on Azure virtual machines have the additional safeguards.</span></span> 


<span data-ttu-id="1b434-187">Quando VM-GenerationID viene reimpostato, anche l'attributo invocationID del database di Servizi di dominio Active Directory viene reimpostato, il pool di RID viene eliminato e SYSVOL è contrassegnato come non autorevole.</span><span class="sxs-lookup"><span data-stu-id="1b434-187">When the VM-GenerationID is reset, the invocationID of the AD DS database is also reset, the RID pool is discarded, and SYSVOL is marked as non-authoritative.</span></span> <span data-ttu-id="1b434-188">Per altre informazioni, vedere [Introduzione alla virtualizzazione di Servizi di dominio Active Directory](https://technet.microsoft.com/windows-server-docs/identity/ad-ds/introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100) e il blog relativo alla [virtualizzazione di DFSR in modo sicuro](https://blogs.technet.microsoft.com/filecab/2013/04/05/safely-virtualizing-dfsr/)</span><span class="sxs-lookup"><span data-stu-id="1b434-188">For more information, see [Introduction to Active Directory Domain Services Virtualization](https://technet.microsoft.com/windows-server-docs/identity/ad-ds/introduction-to-active-directory-domain-services-ad-ds-virtualization-level-100) and [Safely Virtualizing DFSR](https://blogs.technet.microsoft.com/filecab/2013/04/05/safely-virtualizing-dfsr/)</span></span>

<span data-ttu-id="1b434-189">Il failover in Azure può causare la reimpostazione dell'ID di generazione di VM e ciò interviene nelle misure di sicurezza aggiuntive quando la macchina virtuale controller di dominio viene avviata in Azure.</span><span class="sxs-lookup"><span data-stu-id="1b434-189">Failing over to Azure may cause resetting of VM-GenerationID and that kicks in the additional safeguards when the domain controller virtual machine starts in Azure.</span></span> <span data-ttu-id="1b434-190">Ciò può comportare un **ritardo significativo** nella possibilità dell'utente di accedere alla macchina virtuale controller di dominio.</span><span class="sxs-lookup"><span data-stu-id="1b434-190">This may result in a **significant delay** in user being able to login to the domain controller virtual machine.</span></span> <span data-ttu-id="1b434-191">Poiché questo controller di dominio viene usato solo in un failover di test, non sono necessari misure di sicurezza della virtualizzazione.</span><span class="sxs-lookup"><span data-stu-id="1b434-191">Since this domain controller would be used only in a test failover, virtualization safeguards are not necessary.</span></span> <span data-ttu-id="1b434-192">Per assicurarsi che non cambi l'ID di generazione VM per la macchina virtuale controller di dominio, è possibile modificare il valore DWORD seguente a 4 nel controller di dominio locale.</span><span class="sxs-lookup"><span data-stu-id="1b434-192">To ensure that VM-GenerationID for the domain controller virtual machine doesn't change, then you can change the value of following DWORD to 4 in the on-premises domain controller.</span></span>

        
        HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\gencounter\Start
 

#### <a name="symptoms-of-virtualization-safeguards"></a><span data-ttu-id="1b434-193">Sintomi delle misure di sicurezza della virtualizzazione</span><span class="sxs-lookup"><span data-stu-id="1b434-193">Symptoms of virtualization safeguards</span></span>
 
<span data-ttu-id="1b434-194">Se le misure di sicurezza della virtualizzazione sono intervenute dopo un failover di test, è possibile che si verifichi uno o più dei seguenti sintomi:</span><span class="sxs-lookup"><span data-stu-id="1b434-194">If virtualization safeguards have kicked in after a test failover, you may see one or more of following symptoms:</span></span>  

<span data-ttu-id="1b434-195">Modifica dell'ID di generazione</span><span class="sxs-lookup"><span data-stu-id="1b434-195">Generation ID change</span></span>

![Modifica dell'ID di generazione](./media/site-recovery-active-directory/Event2170.png)

<span data-ttu-id="1b434-197">Modifica dell'ID di chiamata</span><span class="sxs-lookup"><span data-stu-id="1b434-197">Invocation ID change</span></span>

![Modifica dell'ID di chiamata](./media/site-recovery-active-directory/Event1109.png)

<span data-ttu-id="1b434-199">Condivisioni SYSVOL e Netlogon non disponibili</span><span class="sxs-lookup"><span data-stu-id="1b434-199">Sysvol and Netlogon shares are not available</span></span>

![Condivisione SYSVOL](./media/site-recovery-active-directory/sysvolshare.png)

![NTFRS Sysvol](./media/site-recovery-active-directory/Event13565.png)

<span data-ttu-id="1b434-202">Vengono eliminati tutti i database DFSR</span><span class="sxs-lookup"><span data-stu-id="1b434-202">Any DFSR databases are deleted</span></span>

![Eliminazione del database DFSR](./media/site-recovery-active-directory/Event2208.png)


> [!IMPORTANT]
> <span data-ttu-id="1b434-204">Alcune configurazioni descritte nella sezione seguente non sono le configurazioni di controller di dominio standard/predefinite.</span><span class="sxs-lookup"><span data-stu-id="1b434-204">Some of the configurations described in the following section are not the standard/default domain controller configurations.</span></span> <span data-ttu-id="1b434-205">Se non si vuole apportare queste modifiche a un controller di dominio in produzione, è possibile creare un controller di dominio dedicato da usare per il failover del test di Site Recovery e apportarvi queste modifiche.</span><span class="sxs-lookup"><span data-stu-id="1b434-205">If you don't want to make these changes to a production domain controller, then you can create a domain controller dedicated to be used for Site Recovery test failover and make these changes to that.</span></span>  
>
>


### <a name="troubleshooting-domain-controller-issues-during-test-failover"></a><span data-ttu-id="1b434-206">Risolvere i problemi del controller di dominio durante il failover di test</span><span class="sxs-lookup"><span data-stu-id="1b434-206">Troubleshooting domain controller issues during test failover</span></span>


<span data-ttu-id="1b434-207">Al prompt dei comandi eseguire questo comando per verificare se le cartelle SYSVOL e NETLOGON sono condivise:</span><span class="sxs-lookup"><span data-stu-id="1b434-207">On a command prompt, run the following command to check whether SYSVOL and NETLOGON folders are shared:</span></span>

    NET SHARE

<span data-ttu-id="1b434-208">Al prompt dei comandi eseguire questo comando per verificare che il controller di dominio funzioni correttamente.</span><span class="sxs-lookup"><span data-stu-id="1b434-208">On the command prompt, run the following command to ensure that the domain controller is functioning properly.</span></span>

    dcdiag /v > dcdiag.txt

<span data-ttu-id="1b434-209">Nel log di output cercare il testo seguente per verificare il corretto funzionamento del controller di dominio.</span><span class="sxs-lookup"><span data-stu-id="1b434-209">In the output log, look for following text to confirm that the domain controller is functioning well.</span></span> 

* <span data-ttu-id="1b434-210">"passed test Connectivity"</span><span class="sxs-lookup"><span data-stu-id="1b434-210">"passed test Connectivity"</span></span>
* <span data-ttu-id="1b434-211">"passed test Advertising"</span><span class="sxs-lookup"><span data-stu-id="1b434-211">"passed test Advertising"</span></span>
* <span data-ttu-id="1b434-212">"passed test MachineAccount"</span><span class="sxs-lookup"><span data-stu-id="1b434-212">"passed test MachineAccount"</span></span>

<span data-ttu-id="1b434-213">Se le condizioni precedenti vengono soddisfatte, è probabile che il controller di dominio stia funzionando correttamente.</span><span class="sxs-lookup"><span data-stu-id="1b434-213">If the preceding conditions are satisfied, it is likely that the domain controller is functioning well.</span></span> <span data-ttu-id="1b434-214">In caso contrario, attenersi alla procedura seguente.</span><span class="sxs-lookup"><span data-stu-id="1b434-214">If not, try following steps.</span></span>


* <span data-ttu-id="1b434-215">Eseguire un ripristino autorevole del controller di dominio.</span><span class="sxs-lookup"><span data-stu-id="1b434-215">Do an authoritative restore of the domain controller.</span></span>
    * <span data-ttu-id="1b434-216">Nonostante [non sia consigliabile usare il servizio Replica file](https://blogs.technet.microsoft.com/filecab/2014/06/25/the-end-is-nigh-for-frs/), se viene comunque usato, seguire la procedura riportata [qui](https://support.microsoft.com/kb/290762) per eseguire un ripristino autorevole.</span><span class="sxs-lookup"><span data-stu-id="1b434-216">Although it is [not recommended to use FRS replication](https://blogs.technet.microsoft.com/filecab/2014/06/25/the-end-is-nigh-for-frs/), but if you are still using it then follow the steps provided [here](https://support.microsoft.com/kb/290762) to do an authoritative restore.</span></span> <span data-ttu-id="1b434-217">Per altre informazioni sui valori BURFLAG citati nel collegamento precedente, vedere [qui](https://blogs.technet.microsoft.com/janelewis/2006/09/18/d2-and-d4-what-is-it-for/).</span><span class="sxs-lookup"><span data-stu-id="1b434-217">You can read more about Burflags talked about in the previous link [here](https://blogs.technet.microsoft.com/janelewis/2006/09/18/d2-and-d4-what-is-it-for/).</span></span>
    * <span data-ttu-id="1b434-218">Se si usa la replica DFSR, per eseguire un ripristino autorevole seguire la procedura disponibile [qui](https://support.microsoft.com/kb/2218556).</span><span class="sxs-lookup"><span data-stu-id="1b434-218">If you are using DFSR replication, then follow the steps available [here](https://support.microsoft.com/kb/2218556) to do an authoritative restore.</span></span> <span data-ttu-id="1b434-219">A tale scopo è anche possibile usare le funzioni di Powershell disponibili in questo [collegamento](https://blogs.technet.microsoft.com/thbouche/2013/08/28/dfsr-sysvol-authoritative-non-authoritative-restore-powershell-functions/).</span><span class="sxs-lookup"><span data-stu-id="1b434-219">You can also use Powershell functions available on this [link](https://blogs.technet.microsoft.com/thbouche/2013/08/28/dfsr-sysvol-authoritative-non-authoritative-restore-powershell-functions/) for this purpose.</span></span> 
    
* <span data-ttu-id="1b434-220">Ignorare il requisito della sincronizzazione iniziale impostando la chiave del Registro di sistema seguente su 0 nel controller di dominio locale.</span><span class="sxs-lookup"><span data-stu-id="1b434-220">Bypass initial synchronization requirement by setting following registry key to 0 in the on-premises domain controller.</span></span> <span data-ttu-id="1b434-221">Se questo valore DWORD non esiste, può essere creato nel nodo "Parameters".</span><span class="sxs-lookup"><span data-stu-id="1b434-221">If this DWORD doesn't exist, then you can create it under node 'Parameters'.</span></span> <span data-ttu-id="1b434-222">Per altre informazioni, vedere [qui](https://support.microsoft.com/kb/2001093).</span><span class="sxs-lookup"><span data-stu-id="1b434-222">You can read more about it [here](https://support.microsoft.com/kb/2001093)</span></span>

        HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NTDS\Parameters\Repl Perform Initial Synchronizations

* <span data-ttu-id="1b434-223">Disabilitare il requisito della disponibilità di un server di catalogo globale per la convalida dell'accesso utente impostando la chiave del Registro di sistema seguente su 1 nel controller di dominio locale.</span><span class="sxs-lookup"><span data-stu-id="1b434-223">Disable the requirement that a global catalog server is available to validate user logon by setting following registry key to 1 in the on-premises domain controller.</span></span> <span data-ttu-id="1b434-224">Se questo valore DWORD non esiste, può essere creato nel nodo "Lsa".</span><span class="sxs-lookup"><span data-stu-id="1b434-224">If this DWORD doesn't exist, then you can create it under node 'Lsa'.</span></span> <span data-ttu-id="1b434-225">Per altre informazioni, vedere [qui](http://support.microsoft.com/kb/241789).</span><span class="sxs-lookup"><span data-stu-id="1b434-225">You can read more about it [here](http://support.microsoft.com/kb/241789)</span></span>

        HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa\IgnoreGCFailures



### <a name="dns-and-domain-controller-on-different-machines"></a><span data-ttu-id="1b434-226">DNS e controller di dominio su computer diversi</span><span class="sxs-lookup"><span data-stu-id="1b434-226">DNS and domain controller on different machines</span></span>
<span data-ttu-id="1b434-227">Se DNS non è presente nella stessa macchina virtuale del controller di dominio, è necessario creare una VM DNS per il failover di test.</span><span class="sxs-lookup"><span data-stu-id="1b434-227">If DNS isn't on the same virtual machine as the domain controller, you need to create a DNS VM for the test failover.</span></span> <span data-ttu-id="1b434-228">Se si trovano nella stessa VM, è possibile ignorare questa sezione.</span><span class="sxs-lookup"><span data-stu-id="1b434-228">If they're on the same VM, you can skip this section.</span></span>

<span data-ttu-id="1b434-229">È possibile utilizzare un server DNS nuovo e creare tutte le zone necessarie.</span><span class="sxs-lookup"><span data-stu-id="1b434-229">You can use a fresh DNS server and create all the required zones.</span></span> <span data-ttu-id="1b434-230">Ad esempio, se il dominio di Active Directory è contoso.com, è possibile creare una zona DNS con il nome contoso.com.</span><span class="sxs-lookup"><span data-stu-id="1b434-230">For example, if your Active Directory domain is contoso.com, you can create a DNS zone with the name contoso.com.</span></span> <span data-ttu-id="1b434-231">Le voci corrispondenti a Active Directory devono essere aggiornate in DNS, come segue:</span><span class="sxs-lookup"><span data-stu-id="1b434-231">The entries corresponding to Active Directory must be updated in DNS, as follows:</span></span>

1. <span data-ttu-id="1b434-232">Verificare che queste impostazioni siano state definite prima che vengano attivate altre macchine virtuali del piano di ripristino:</span><span class="sxs-lookup"><span data-stu-id="1b434-232">Ensure these settings are in place before any other virtual machine in the recovery plan comes up:</span></span>
   
   * <span data-ttu-id="1b434-233">La zona deve avere il nome radice della foresta.</span><span class="sxs-lookup"><span data-stu-id="1b434-233">The zone must be named after the forest root name.</span></span>
   * <span data-ttu-id="1b434-234">La zona deve essere sottoposta a backup.</span><span class="sxs-lookup"><span data-stu-id="1b434-234">The zone must be file-backed.</span></span>
   * <span data-ttu-id="1b434-235">La zona deve essere abilitata per aggiornamenti protetti e non protetti.</span><span class="sxs-lookup"><span data-stu-id="1b434-235">The zone must be enabled for secure and non-secure updates.</span></span>
   * <span data-ttu-id="1b434-236">Il sistema di risoluzione della macchina virtuale controller di dominio deve puntare all'indirizzo IP della macchina virtuale DNS.</span><span class="sxs-lookup"><span data-stu-id="1b434-236">The resolver of the domain controller virtual machine should point to the IP address of the DNS virtual machine.</span></span>
2. <span data-ttu-id="1b434-237">Eseguire il comando seguente nella macchina virtuale controller di dominio:</span><span class="sxs-lookup"><span data-stu-id="1b434-237">Run the following command on domain controller virtual machine:</span></span>
   
    `nltest /dsregdns`
3. <span data-ttu-id="1b434-238">Aggiungere una zona nel server DNS, consentire aggiornamenti non protetti e aggiungere una voce al DNS:</span><span class="sxs-lookup"><span data-stu-id="1b434-238">Add a zone on the DNS server, allow non-secure updates, and add an entry for it to DNS:</span></span>
   
        dnscmd /zoneadd contoso.com  /Primary
        dnscmd /recordadd contoso.com  contoso.com. SOA %computername%.contoso.com. hostmaster. 1 15 10 1 1
        dnscmd /recordadd contoso.com %computername%  A <IP_OF_DNS_VM>
        dnscmd /config contoso.com /allowupdate 1

## <a name="next-steps"></a><span data-ttu-id="1b434-239">Passaggi successivi</span><span class="sxs-lookup"><span data-stu-id="1b434-239">Next steps</span></span>
<span data-ttu-id="1b434-240">Per altre informazioni sulla protezione dei carichi di lavoro aziendali con Azure Site Recovery, leggere [Quali carichi di lavoro è possibile proteggere?](site-recovery-workload.md).</span><span class="sxs-lookup"><span data-stu-id="1b434-240">Read [What workloads can I protect?](site-recovery-workload.md) to learn more about protecting enterprise workloads with Azure Site Recovery.</span></span>

