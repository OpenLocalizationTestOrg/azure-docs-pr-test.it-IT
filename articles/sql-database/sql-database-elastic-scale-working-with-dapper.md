---
title: Uso della libreria client di database elastico con Dapper | Microsoft Docs
description: Utilizzo della libreria client dei database elastici con Dapper.
services: sql-database
documentationcenter: 
manager: jhubbard
author: torsteng
ms.assetid: 463d2676-3b19-47c2-83df-f8c50492c9d2
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 05/27/2016
ms.author: torsteng
ms.openlocfilehash: f0efd37a39c1a60eee7b47304483c27727ca8833
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 07/11/2017
---
# <a name="using-elastic-database-client-library-with-dapper"></a><span data-ttu-id="370a4-103">Utilizzo della libreria client dei database elastici con Dapper</span><span class="sxs-lookup"><span data-stu-id="370a4-103">Using elastic database client library with Dapper</span></span>
<span data-ttu-id="370a4-104">Questo documento è rivolto agli sviluppatori che si basano su Dapper per creare applicazioni, ma desiderano avvalersi degli [strumenti dei database elastici](sql-database-elastic-scale-introduction.md) per creare applicazioni che implementano il partizionamento per la scalabilità orizzontale del livello dati.</span><span class="sxs-lookup"><span data-stu-id="370a4-104">This document is for developers that rely on Dapper to build applications, but also want to embrace [elastic database tooling](sql-database-elastic-scale-introduction.md) to create applications that implement sharding to scale-out their data tier.</span></span>  <span data-ttu-id="370a4-105">Questo documento illustra le modifiche da apportare nelle applicazioni basate su Dapper per l'integrazione con gli strumenti dei database elastici.</span><span class="sxs-lookup"><span data-stu-id="370a4-105">This document illustrates the changes in Dapper-based applications that are necessary to integrate with elastic database tools.</span></span> <span data-ttu-id="370a4-106">L'obiettivo è comporre la gestione delle partizioni dei database elastici e il routing dipendente dai dati con Dapper.</span><span class="sxs-lookup"><span data-stu-id="370a4-106">Our focus is on composing the elastic database shard management and data dependent routing with Dapper.</span></span> 

<span data-ttu-id="370a4-107">**Codice di esempio**: [Strumenti dei database elastici per il database SQL di Azure - Integrazione con Dapper](https://code.msdn.microsoft.com/Elastic-Scale-with-Azure-e19fc77f).</span><span class="sxs-lookup"><span data-stu-id="370a4-107">**Sample Code**: [Elastic database tools for Azure SQL Database - Dapper integration](https://code.msdn.microsoft.com/Elastic-Scale-with-Azure-e19fc77f).</span></span>

<span data-ttu-id="370a4-108">L'integrazione di **Dapper** e **DapperExtensions** con la libreria client dei database elastici per il database SQL di Azure è semplice.</span><span class="sxs-lookup"><span data-stu-id="370a4-108">Integrating **Dapper** and **DapperExtensions** with the elastic database client library for Azure SQL Database is easy.</span></span> <span data-ttu-id="370a4-109">Le applicazioni possono usare il routing dipendente dai dati modificando la creazione e l'apertura di nuovi oggetti [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) per usare la chiamata a [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) dalla [libreria client](http://msdn.microsoft.com/library/azure/dn765902.aspx).</span><span class="sxs-lookup"><span data-stu-id="370a4-109">Your applications can use data dependent routing by changing the creation and opening of new [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) objects to use the [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) call from the [client library](http://msdn.microsoft.com/library/azure/dn765902.aspx).</span></span> <span data-ttu-id="370a4-110">Questo limita le modifiche nell'applicazione solo ai punti in cui vengono create e aperte nuove connessioni.</span><span class="sxs-lookup"><span data-stu-id="370a4-110">This limits changes in your application to only where new connections are created and opened.</span></span> 

## <a name="dapper-overview"></a><span data-ttu-id="370a4-111">Informazioni generali su Dapper</span><span class="sxs-lookup"><span data-stu-id="370a4-111">Dapper overview</span></span>
<span data-ttu-id="370a4-112">**Dapper** è un mapper object-relational.</span><span class="sxs-lookup"><span data-stu-id="370a4-112">**Dapper** is an object-relational mapper.</span></span> <span data-ttu-id="370a4-113">Esegue il mapping degli oggetti .NET dell'applicazione con un database relazionale e viceversa.</span><span class="sxs-lookup"><span data-stu-id="370a4-113">It maps .NET objects from your application to a relational database (and vice versa).</span></span> <span data-ttu-id="370a4-114">La prima parte del codice di esempio illustra come integrare la libreria client dei database elastici con applicazioni basate su Dapper.</span><span class="sxs-lookup"><span data-stu-id="370a4-114">The first part of the sample code illustrates how you can integrate the elastic database client library with Dapper-based applications.</span></span> <span data-ttu-id="370a4-115">La seconda parte del codice di esempio illustra come eseguire l’integrazione quando si usano Dapper e DapperExtensions.</span><span class="sxs-lookup"><span data-stu-id="370a4-115">The second part of the sample code illustrates how to integrate when using both Dapper and DapperExtensions.</span></span>  

<span data-ttu-id="370a4-116">La funzionalità di mapper in Dapper fornisce metodi di estensione per le connessioni di database che semplificano l'invio di istruzioni T-SQL per l'esecuzione o per l'esecuzione di query del database.</span><span class="sxs-lookup"><span data-stu-id="370a4-116">The mapper functionality in Dapper provides extension methods on database connections that simplify submitting T-SQL statements for execution or querying the database.</span></span> <span data-ttu-id="370a4-117">Ad esempio, Dapper consente di eseguire il mapping tra gli oggetti .NET e i parametri delle istruzioni SQL per le chiamate **Execute** o di usare i risultati delle query SQL negli oggetti .NET mediante chiamate **Query** da Dapper.</span><span class="sxs-lookup"><span data-stu-id="370a4-117">For instance, Dapper makes it easy to map between your .NET objects and the parameters of SQL statements for **Execute** calls, or to consume the results of your SQL queries into .NET objects using **Query** calls from Dapper.</span></span> 

<span data-ttu-id="370a4-118">Quando si usa DapperExtensions, non è più necessario fornire le istruzioni SQL.</span><span class="sxs-lookup"><span data-stu-id="370a4-118">When using DapperExtensions, you no longer need to provide the SQL statements.</span></span> <span data-ttu-id="370a4-119">I metodi di estensione, ad esempio **GetList** o **Insert** per la connessione di database, creano le istruzioni SQL dietro le quinte.</span><span class="sxs-lookup"><span data-stu-id="370a4-119">Extensions methods such as **GetList** or **Insert** over the database connection create the SQL statements behind the scenes.</span></span>

<span data-ttu-id="370a4-120">Un altro vantaggio offerto da Dapper e anche da DapperExtensions è il controllo della creazione della connessione di database da parte dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="370a4-120">Another benefit of Dapper and also DapperExtensions is that the application controls the creation of the database connection.</span></span> <span data-ttu-id="370a4-121">Ciò consente di interagire con la libreria client dei database elastici che negozia le connessioni di database in base al mapping tra shardlet e database.</span><span class="sxs-lookup"><span data-stu-id="370a4-121">This helps interact with the elastic database client library which brokers database connections based on the mapping of shardlets to databases.</span></span>

<span data-ttu-id="370a4-122">Per ottenere gli assembly Dapper, vedere la pagina relativa a [Dapper dot net](http://www.nuget.org/packages/Dapper/).</span><span class="sxs-lookup"><span data-stu-id="370a4-122">To get the Dapper assemblies, see [Dapper dot net](http://www.nuget.org/packages/Dapper/).</span></span> <span data-ttu-id="370a4-123">Per le estensioni Dapper, vedere la pagina relativa a [DapperExtensions](http://www.nuget.org/packages/DapperExtensions).</span><span class="sxs-lookup"><span data-stu-id="370a4-123">For the Dapper extensions, see [DapperExtensions](http://www.nuget.org/packages/DapperExtensions).</span></span>

## <a name="a-quick-look-at-the-elastic-database-client-library"></a><span data-ttu-id="370a4-124">Panoramica della libreria client dei database elastici</span><span class="sxs-lookup"><span data-stu-id="370a4-124">A quick Look at the elastic database client library</span></span>
<span data-ttu-id="370a4-125">Con libreria client dei database elastici è possibile definire partizioni di dati di applicazione denominate *shardlet*, eseguirne il mapping con i database e identificarli in base a *chiavi di partizionamento orizzontale*.</span><span class="sxs-lookup"><span data-stu-id="370a4-125">With the elastic database client library, you define partitions of your application data called *shardlets* , map them to databases, and identify them by *sharding keys*.</span></span> <span data-ttu-id="370a4-126">È possibile disporre di tutti i database desiderati e distribuire gli shardlet su tali database.</span><span class="sxs-lookup"><span data-stu-id="370a4-126">You can have as many databases as you need and distribute your shardlets across these databases.</span></span> <span data-ttu-id="370a4-127">Il mapping dei valori delle chiavi di partizionamento orizzontale ai database è archiviato in una mappa partizioni fornita dalle API della libreria.</span><span class="sxs-lookup"><span data-stu-id="370a4-127">The mapping of sharding key values to the databases is stored by a shard map provided by the library’s APIs.</span></span> <span data-ttu-id="370a4-128">Questa funzionalità è denominata **gestione mappe partizioni**.</span><span class="sxs-lookup"><span data-stu-id="370a4-128">This capability is called **shard map management**.</span></span> <span data-ttu-id="370a4-129">La mappa partizioni funge anche da gestore delle connessioni di database per le richieste che contengono una chiave di partizionamento orizzontale.</span><span class="sxs-lookup"><span data-stu-id="370a4-129">The shard map also serves as the broker of database connections for requests that carry a sharding key.</span></span> <span data-ttu-id="370a4-130">Questa funzionalità è indicata come **routing dipendente dai dati**.</span><span class="sxs-lookup"><span data-stu-id="370a4-130">This capability is referred to as **data dependent routing**.</span></span>

![Mappe di partizione e routing dipendente dai dati][1]

<span data-ttu-id="370a4-132">Il gestore mappe partizioni protegge gli utenti da visualizzazioni non coerenti in dati di shardlet che possono verificarsi quando vengono eseguite operazioni di gestione shardlet simultanee nei database.</span><span class="sxs-lookup"><span data-stu-id="370a4-132">The shard map manager protects users from inconsistent views into shardlet data that can occur when concurrent shardlet management operations are happening on the databases.</span></span> <span data-ttu-id="370a4-133">A tale scopo, le mappe partizioni gestiscono le connessioni al database per un'applicazione compilata con la libreria.</span><span class="sxs-lookup"><span data-stu-id="370a4-133">To do so, the shard maps broker the database connections for an application built with the library.</span></span> <span data-ttu-id="370a4-134">Se esiste il rischio che le operazioni di gestione delle partizioni abbiano impatto sullo shardlet, in questo modo la funzionalità delle mappe di partizioni può terminare automaticamente una connessione al database.</span><span class="sxs-lookup"><span data-stu-id="370a4-134">When shard management operations could impact the shardlet, this allows the shard map functionality to automatically kill a database connection.</span></span> 

<span data-ttu-id="370a4-135">Anziché usare il sistema tradizionale per creare connessioni per Dapper, è necessario usare il [metodo OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn824099.aspx).</span><span class="sxs-lookup"><span data-stu-id="370a4-135">Instead of using the traditional way to create connections for Dapper, we need to use the [OpenConnectionForKey method](http://msdn.microsoft.com/library/azure/dn824099.aspx).</span></span> <span data-ttu-id="370a4-136">Ciò garantisce che vengano eseguite tutte le convalide e vengano gestite correttamente le connessioni durante lo spostamento di dati tra le partizioni.</span><span class="sxs-lookup"><span data-stu-id="370a4-136">This ensures that all the validation takes place and connections are managed properly when any data moves between shards.</span></span>

### <a name="requirements-for-dapper-integration"></a><span data-ttu-id="370a4-137">Requisiti per l'integrazione con Dapper</span><span class="sxs-lookup"><span data-stu-id="370a4-137">Requirements for Dapper integration</span></span>
<span data-ttu-id="370a4-138">Quando si usano sia la libreria client dei database elastici che le API di Dapper, si desidera mantenere le seguenti proprietà:</span><span class="sxs-lookup"><span data-stu-id="370a4-138">When working with both the elastic database client library and the Dapper APIs, we want to retain the following properties:</span></span>

* <span data-ttu-id="370a4-139">**Scalabilità orizzontale**: si desidera aggiungere o rimuovere database dal livello dati dell'applicazione partizionata a seconda delle necessità per soddisfare le esigenze di capacità dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="370a4-139">**Scaleout**: We want to add or remove databases from the data tier of the sharded application as necessary for the capacity demands of the application.</span></span> 
* <span data-ttu-id="370a4-140">**Coerenza**: poiché nell'applicazione viene implementata la scalabilità orizzontale con il partizionamento orizzontale, è necessario eseguire il routing dipendente dai dati.</span><span class="sxs-lookup"><span data-stu-id="370a4-140">**Consistency**: Since our application is scaled out using sharding, we need to perform data dependent routing.</span></span> <span data-ttu-id="370a4-141">A tale scopo, è possibile usare le funzionalità di routing dipendente dai dati della libreria.</span><span class="sxs-lookup"><span data-stu-id="370a4-141">We want to use the Data dependent routing capabilities of the library to do so.</span></span> <span data-ttu-id="370a4-142">In particolare, si desidera mantenere le garanzie di convalida e coerenza fornite dalle connessioni negoziate tramite il gestore mappe partizioni per evitare problemi di danneggiamento o di risultati di query non corretti.</span><span class="sxs-lookup"><span data-stu-id="370a4-142">In particular, we want to retain the validation and consistency guarantees provided by connections that are brokered through the shard map manager in order to avoid corruption or wrong query results.</span></span> <span data-ttu-id="370a4-143">Ciò garantisce che le connessioni a un determinato shardlet vengano rifiutate o arrestate se ad esempio lo shardlet è attualmente spostato in una partizione diversa tramite API di suddivisione/unione.</span><span class="sxs-lookup"><span data-stu-id="370a4-143">This ensures that connections to a given shardlet are rejected or stopped if (for instance) the shardlet is currently moved to a different shard using Split/Merge APIs.</span></span>
* <span data-ttu-id="370a4-144">**Mapping degli oggetti**: si desidera mantenere i vantaggi dei mapping forniti da Dapper per la conversione tra le classi nell'applicazione e le strutture di database sottostanti.</span><span class="sxs-lookup"><span data-stu-id="370a4-144">**Object Mapping**: We want to retain the convenience of the mappings provided by Dapper to translate between classes in the application and the underlying database structures.</span></span> 

<span data-ttu-id="370a4-145">La seguente sezione fornisce indicazioni per tali requisiti per le applicazioni basate su **Dapper** e **DapperExtensions**.</span><span class="sxs-lookup"><span data-stu-id="370a4-145">The following section provides guidance for these requirements for applications based on **Dapper** and **DapperExtensions**.</span></span>

## <a name="technical-guidance"></a><span data-ttu-id="370a4-146">Indicazioni tecniche</span><span class="sxs-lookup"><span data-stu-id="370a4-146">Technical Guidance</span></span>
### <a name="data-dependent-routing-with-dapper"></a><span data-ttu-id="370a4-147">Routing dipendente dai dati con Dapper</span><span class="sxs-lookup"><span data-stu-id="370a4-147">Data dependent routing with Dapper</span></span>
<span data-ttu-id="370a4-148">Con Dapper l'applicazione è in genere responsabile della creazione e l'apertura delle connessioni al database sottostante.</span><span class="sxs-lookup"><span data-stu-id="370a4-148">With Dapper, the application is typically responsible for creating and opening the connections to the underlying database.</span></span> <span data-ttu-id="370a4-149">Sulla base di un tipo T fornito dall'applicazione, Dapper restituisce risultati di query come raccolte .NET di tipo T. Dapper esegue il mapping tra le righe di risultati di T-SQL e gli oggetti di tipo T. Analogamente, Dapper esegue il mapping tra oggetti .NET e parametri o valori SQL per istruzioni Data Manipulation Language (DML).</span><span class="sxs-lookup"><span data-stu-id="370a4-149">Given a type T by the application, Dapper returns query results as .NET collections of type T. Dapper performs the mapping from the T-SQL result rows to the objects of type T. Similarly, Dapper maps .NET objects into SQL values or parameters for data manipulation language (DML) statements.</span></span> <span data-ttu-id="370a4-150">Dapper offre questa funzionalità tramite i metodi di estensione nel normale oggetto [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) delle librerie client SQL ADO.NET.</span><span class="sxs-lookup"><span data-stu-id="370a4-150">Dapper offers this functionality via extension methods on the regular [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) object from the ADO .NET SQL Client libraries.</span></span> <span data-ttu-id="370a4-151">Anche la connessione SQL restituita dalle API di scalabilità elastica per record dei dati di individuazione sono normali oggetti [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx).</span><span class="sxs-lookup"><span data-stu-id="370a4-151">The SQL connection returned by the Elastic Scale APIs for DDR are also regular [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) objects.</span></span> <span data-ttu-id="370a4-152">In questo modo è possibile usare direttamente le estensioni Dapper sul tipo restituito dall'API di record dei dati della libreria client, perché anche in questo caso si tratta di una semplice connessione client SQL.</span><span class="sxs-lookup"><span data-stu-id="370a4-152">This allows us to directly use Dapper extensions over the type returned by the client library’s DDR API, as it is also a simple SQL Client connection.</span></span>

<span data-ttu-id="370a4-153">Queste osservazioni semplificano l'utilizzo delle connessioni negoziate dalla libreria client dei database elastici per Dapper.</span><span class="sxs-lookup"><span data-stu-id="370a4-153">These observations make it straightforward to use connections brokered by the elastic database client library for Dapper.</span></span>

<span data-ttu-id="370a4-154">Questo esempio di codice (dall'esempio di accompagnamento) illustra il metodo in cui la chiave di partizionamento viene fornita dall'applicazione alla libreria per negoziare la connessione al partizionamento corretto.</span><span class="sxs-lookup"><span data-stu-id="370a4-154">This code example (from the accompanying sample) illustrates the approach where the sharding key is provided by the application to the library to broker the connection to the right shard.</span></span>   

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                     key: tenantId1, 
                     connectionString: connStrBldr.ConnectionString, 
                     options: ConnectionOptions.Validate))
    {
        var blog = new Blog { Name = name };
        sqlconn.Execute(@"
                      INSERT INTO
                            Blog (Name)
                            VALUES (@name)", new { name = blog.Name }
                        );
    }

<span data-ttu-id="370a4-155">La chiamata all'API [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) sostituisce la creazione predefinita e l'apertura di una connessione client SQL.</span><span class="sxs-lookup"><span data-stu-id="370a4-155">The call to the [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) API replaces the default creation and opening of a SQL Client connection.</span></span> <span data-ttu-id="370a4-156">La chiamata a [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) accetta gli argomenti necessari per il routing dipendente dai dati:</span><span class="sxs-lookup"><span data-stu-id="370a4-156">The [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) call takes the arguments that are required for data dependent routing:</span></span> 

* <span data-ttu-id="370a4-157">La mappa partizioni per l'accesso alle interfacce di routing dipendente dai dati</span><span class="sxs-lookup"><span data-stu-id="370a4-157">The shard map to access the data dependent routing interfaces</span></span>
* <span data-ttu-id="370a4-158">La chiave di partizionamento orizzontale per l'identificazione dello shardlet</span><span class="sxs-lookup"><span data-stu-id="370a4-158">The sharding key to identify the shardlet</span></span>
* <span data-ttu-id="370a4-159">Le credenziali (nome utente e password) per la connessione alla partizione</span><span class="sxs-lookup"><span data-stu-id="370a4-159">The credentials (user name and password) to connect to the shard</span></span>

<span data-ttu-id="370a4-160">L'oggetto mappa partizioni crea una connessione alla partizione che contiene lo shardlet per la chiave di partizionamento orizzontale specificata.</span><span class="sxs-lookup"><span data-stu-id="370a4-160">The shard map object creates a connection to the shard that holds the shardlet for the given sharding key.</span></span> <span data-ttu-id="370a4-161">Le API della libreria client dei database elastici aggiungono inoltre un tag alla connessione per implementare le garanzie di coerenza.</span><span class="sxs-lookup"><span data-stu-id="370a4-161">The elastic database client APIs also tag the connection to implement its consistency guarantees.</span></span> <span data-ttu-id="370a4-162">Poiché la chiamata a [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) restituisce un normale oggetto di connessione client SQL, la chiamata successiva al metodo di estensione **Execute** da Dapper segue la procedura Dapper standard.</span><span class="sxs-lookup"><span data-stu-id="370a4-162">Since the call to [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) returns a regular SQL Client connection object, the subsequent call to the **Execute** extension method from Dapper follows the standard Dapper practice.</span></span>

<span data-ttu-id="370a4-163">Le query funzionano in modo molto simile: si apre innanzitutto la connessione usando [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) dall'API client.</span><span class="sxs-lookup"><span data-stu-id="370a4-163">Queries work very much the same way - you first open the connection using [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) from the client API.</span></span> <span data-ttu-id="370a4-164">Si usano quindi i normali metodi di estensione Dapper per il mapping tra i risultati della query SQL negli oggetti .NET:</span><span class="sxs-lookup"><span data-stu-id="370a4-164">Then you use the regular Dapper extension methods to map the results of your SQL query into .NET objects:</span></span>

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                    key: tenantId1, 
                    connectionString: connStrBldr.ConnectionString, 
                    options: ConnectionOptions.Validate ))
    {    
           // Display all Blogs for tenant 1
           IEnumerable<Blog> result = sqlconn.Query<Blog>(@"
                                SELECT * 
                                FROM Blog
                                ORDER BY Name");

           Console.WriteLine("All blogs for tenant id {0}:", tenantId1);
           foreach (var item in result)
           {
                Console.WriteLine(item.Name);
            }
    }

<span data-ttu-id="370a4-165">Si noti che il blocco **using** con la connessione di record di dati di individuazione definisce l'ambito di tutte le operazioni di database all'interno del blocco per la partizione in cui viene mantenuto tenantId1.</span><span class="sxs-lookup"><span data-stu-id="370a4-165">Note that the **using** block with the DDR connection scopes all database operations within the block to the one shard where tenantId1 is kept.</span></span> <span data-ttu-id="370a4-166">La query restituisce solo blog archiviati nella partizione corrente, ma non quelli archiviati nelle altre partizioni.</span><span class="sxs-lookup"><span data-stu-id="370a4-166">The query only returns blogs stored on the current shard, but not the ones stored on any other shards.</span></span> 

## <a name="data-dependent-routing-with-dapper-and-dapperextensions"></a><span data-ttu-id="370a4-167">Routing dipendente dai dati con Dapper e DapperExtensions</span><span class="sxs-lookup"><span data-stu-id="370a4-167">Data dependent routing with Dapper and DapperExtensions</span></span>
<span data-ttu-id="370a4-168">Dapper viene fornito con un ecosistema di estensioni aggiuntive che garantiscono praticità e astrazione dal database durante lo sviluppo di applicazioni di database.</span><span class="sxs-lookup"><span data-stu-id="370a4-168">Dapper comes with an ecosystem of additional extensions that can provide further convenience and abstraction from the database when developing database applications.</span></span> <span data-ttu-id="370a4-169">Un esempio è rappresentato da DapperExtensions.</span><span class="sxs-lookup"><span data-stu-id="370a4-169">DapperExtensions is an example.</span></span> 

<span data-ttu-id="370a4-170">L'uso di DapperExtensions nell'applicazione non comporta la modifica della modalità di creazione e gestione delle connessioni di database.</span><span class="sxs-lookup"><span data-stu-id="370a4-170">Using DapperExtensions in your application does not change how database connections are created and managed.</span></span> <span data-ttu-id="370a4-171">È comunque responsabilità dell'applicazione aprire le connessioni e sono previsti normali oggetti di connessione client SQL dai metodi di estensione.</span><span class="sxs-lookup"><span data-stu-id="370a4-171">It is still the application’s responsibility to open connections, and regular SQL Client connection objects are expected by the extension methods.</span></span> <span data-ttu-id="370a4-172">È possibile basarsi sul metodo [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) come illustrato in precedenza.</span><span class="sxs-lookup"><span data-stu-id="370a4-172">We can rely on the [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) as outlined above.</span></span> <span data-ttu-id="370a4-173">Come mostrato nei seguenti esempi di codice, come unica differenza non è necessario scrivere le istruzioni T-SQL:</span><span class="sxs-lookup"><span data-stu-id="370a4-173">As the following code samples show, the only change is that we do no longer have to write the T-SQL statements:</span></span>

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                    key: tenantId2, 
                    connectionString: connStrBldr.ConnectionString, 
                    options: ConnectionOptions.Validate))
    {
           var blog = new Blog { Name = name2 };
           sqlconn.Insert(blog);
    }

<span data-ttu-id="370a4-174">Questo è l'esempio di codice per la query:</span><span class="sxs-lookup"><span data-stu-id="370a4-174">And here is the code sample for the query:</span></span> 

    using (SqlConnection sqlconn = shardingLayer.ShardMap.OpenConnectionForKey(
                    key: tenantId2, 
                    connectionString: connStrBldr.ConnectionString, 
                    options: ConnectionOptions.Validate))
    {
           // Display all Blogs for tenant 2
           IEnumerable<Blog> result = sqlconn.GetList<Blog>();
           Console.WriteLine("All blogs for tenant id {0}:", tenantId2);
           foreach (var item in result)
           {
               Console.WriteLine(item.Name);
           }
    }

### <a name="handling-transient-faults"></a><span data-ttu-id="370a4-175">Gestione degli errori temporanei</span><span class="sxs-lookup"><span data-stu-id="370a4-175">Handling transient faults</span></span>
<span data-ttu-id="370a4-176">Il team Microsoft Patterns & Practices ha pubblicato un articolo relativo al [blocco di applicazioni per la gestione degli errori temporanei](http://msdn.microsoft.com/library/hh680934.aspx) per consentire agli sviluppatori di applicazioni di attenuare le comuni condizioni di errori temporanei rilevate durante l'esecuzione nel cloud.</span><span class="sxs-lookup"><span data-stu-id="370a4-176">The Microsoft Patterns & Practices team published the [Transient Fault Handling Application Block](http://msdn.microsoft.com/library/hh680934.aspx) to help application developers mitigate common transient fault conditions encountered when running in the cloud.</span></span> <span data-ttu-id="370a4-177">Per ulteriori informazioni, vedere [Perseveranza, il segreto di tutti i successi: uso del Blocco di applicazioni per la gestione degli errori temporanei](http://msdn.microsoft.com/library/dn440719.aspx).</span><span class="sxs-lookup"><span data-stu-id="370a4-177">For more information, see [Perseverance, Secret of All Triumphs: Using the Transient Fault Handling Application Block](http://msdn.microsoft.com/library/dn440719.aspx).</span></span>

<span data-ttu-id="370a4-178">L'esempio di codice si basa sulla libreria di errori temporanei per proteggersi da questo tipo di errori.</span><span class="sxs-lookup"><span data-stu-id="370a4-178">The code sample relies on the transient fault library to protect against transient faults.</span></span> 

    SqlDatabaseUtils.SqlRetryPolicy.ExecuteAction(() =>
    {
       using (SqlConnection sqlconn = 
          shardingLayer.ShardMap.OpenConnectionForKey(tenantId2, connStrBldr.ConnectionString, ConnectionOptions.Validate))
          {
              var blog = new Blog { Name = name2 };
              sqlconn.Insert(blog);
          }
    });

<span data-ttu-id="370a4-179">**SqlDatabaseUtils.SqlRetryPolicy** nel codice precedente viene definito come **SqlDatabaseTransientErrorDetectionStrategy** con un numero di tentativi pari a 10 e un tempo di attesa tra i tentativi pari a 5 secondi.</span><span class="sxs-lookup"><span data-stu-id="370a4-179">**SqlDatabaseUtils.SqlRetryPolicy** in the code above is defined as a **SqlDatabaseTransientErrorDetectionStrategy** with a retry count of 10, and 5 seconds wait time between retries.</span></span> <span data-ttu-id="370a4-180">Se si usano le transazioni, assicurarsi che l'ambito delle ripetizioni risalga all'inizio della transazione in caso di errore temporaneo.</span><span class="sxs-lookup"><span data-stu-id="370a4-180">If you are using transactions, make sure that your retry scope goes back to the beginning of the transaction in the case of a transient fault.</span></span>

## <a name="limitations"></a><span data-ttu-id="370a4-181">Limitazioni</span><span class="sxs-lookup"><span data-stu-id="370a4-181">Limitations</span></span>
<span data-ttu-id="370a4-182">Gli approcci descritti in questo documento implicano due limitazioni:</span><span class="sxs-lookup"><span data-stu-id="370a4-182">The approaches outlined in this document entail a couple of limitations:</span></span>

* <span data-ttu-id="370a4-183">Il codice di esempio per questo documento non illustra come gestire lo schema tra partizioni.</span><span class="sxs-lookup"><span data-stu-id="370a4-183">The sample code for this document does not demonstrate how to manage schema across shards.</span></span>
* <span data-ttu-id="370a4-184">Data una richiesta, si presuppone che tutta la relativa elaborazione di database sia contenuta in una singola partizione identificata dalla chiave di partizionamento orizzontale fornita dalla richiesta.</span><span class="sxs-lookup"><span data-stu-id="370a4-184">Given a request, we assume that all its database processing is contained within a single shard as identified by the sharding key provided by the request.</span></span> <span data-ttu-id="370a4-185">Tuttavia, questo presupposto non ha sempre valore, ad esempio quando non è possibile rendere disponibile una chiave di partizionamento orizzontale.</span><span class="sxs-lookup"><span data-stu-id="370a4-185">However, this assumption does not always hold, for example, when it is not possible to make a sharding key available.</span></span> <span data-ttu-id="370a4-186">Per risolvere questo problema, la libreria client dei database elastici include la [classe MultiShardQuery](http://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardexception.aspx).</span><span class="sxs-lookup"><span data-stu-id="370a4-186">To address this, the elastic database client library includes the [MultiShardQuery class](http://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardexception.aspx).</span></span> <span data-ttu-id="370a4-187">Questa classe implementa un'astrazione di connessione per l'esecuzione di query su più partizioni.</span><span class="sxs-lookup"><span data-stu-id="370a4-187">The class implements a connection abstraction for querying over several shards.</span></span> <span data-ttu-id="370a4-188">L'uso di MultiShardQuery in combinazione con Dapper esula dall'ambito di questo documento.</span><span class="sxs-lookup"><span data-stu-id="370a4-188">Using MultiShardQuery in combination with Dapper is beyond the scope of this document.</span></span>

## <a name="conclusion"></a><span data-ttu-id="370a4-189">Conclusioni</span><span class="sxs-lookup"><span data-stu-id="370a4-189">Conclusion</span></span>
<span data-ttu-id="370a4-190">Le applicazioni che usano Dapper e DapperExtensions possono trarre vantaggio facilmente dagli strumenti dei database elastici del database SQL di Azure.</span><span class="sxs-lookup"><span data-stu-id="370a4-190">Applications using Dapper and DapperExtensions can easily benefit from elastic database tools for Azure SQL Database.</span></span> <span data-ttu-id="370a4-191">Tramite le procedure descritte in questo documento, tali applicazioni possono usare la funzionalità dello strumento per il routing dipendente dai dati modificando la creazione e l'apertura di nuovi oggetti [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) per usare la chiamata a [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) della libreria client dei database elastici.</span><span class="sxs-lookup"><span data-stu-id="370a4-191">Through the steps outlined in this document, those applications can use the tool's capability for data dependent routing by changing the creation and opening of new [SqlConnection](http://msdn.microsoft.com/library/system.data.sqlclient.sqlconnection.aspx) objects to use the [OpenConnectionForKey](http://msdn.microsoft.com/library/azure/dn807226.aspx) call of the elastic database client library.</span></span> <span data-ttu-id="370a4-192">In questo modo si limitano le modifiche dell'applicazione ai punti in cui vengono create e aperte nuove connessioni.</span><span class="sxs-lookup"><span data-stu-id="370a4-192">This limits the application changes required to those places where new connections are created and opened.</span></span> 

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

<!--Image references-->
[1]: ./media/sql-database-elastic-scale-working-with-dapper/dapperimage1.png
