---
title: Messaggi, payload e serializzazione del bus di servizio di Azure | Microsoft Docs
description: Panoramica dei payload dei messaggi del bus di servizio
services: service-bus-messaging
documentationcenter: 
author: clemensv
manager: timlt
editor: 
ms.service: service-bus-messaging
ms.workload: na
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 09/28/2017
ms.author: sethm
ms.openlocfilehash: 7c18cc4a0e6a8dbf3a47c146707666c5538ff7c3
ms.sourcegitcommit: 6699c77dcbd5f8a1a2f21fba3d0a0005ac9ed6b7
ms.translationtype: HT
ms.contentlocale: it-IT
ms.lasthandoff: 10/11/2017
---
# <a name="messages-payloads-and-serialization"></a>Messaggi, payload e serializzazione

Il bus di servizio di Microsoft Azure gestisce i messaggi. I messaggi includono un payload e metadati, sotto forma di proprietà delle coppie chiave-valore, che illustrano il payload e forniscono istruzioni di gestione al bus di servizio e alle applicazioni. In alcuni casi i soli metadati sono sufficienti per includere le informazioni che il mittente vuole comunicare ai ricevitori e il payload rimane vuoto.

Il modello a oggetti dei client ufficiali del bus di servizio per .NET e Java riflette la struttura astratta dei messaggi del bus di servizio, che viene mappata verso e dai protocolli di rete supportati dal bus di servizio.
 
Un messaggio del bus di servizio è costituito da una sezione di paylod binario che non viene mai gestita in alcun modo dal bus di servizio sul lato server e da due set di proprietà. Le *proprietà del broker* sono predefinite dal sistema. Queste proprietà predefinite controllano le funzionalità a livello di messaggio all'interno del broker oppure sono mappate a elementi comuni e standardizzati dei metadati. Le *proprietà utente* sono una raccolta di coppie chiave-valore che possono essere definite e configurate dall'applicazione.
 
Le proprietà predefinite del broker sono elencate nella tabella seguente. I nomi vengono usati con tutte le API client ufficiali e anche nell'oggetto JSON [BrokerProperties](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage#Properties_) del mapping di protocolli HTTP.
 
I nomi equivalenti usati a livello del protocollo AMQP sono elencati tra parentesi. 

| Nome proprietà                         | Descrizione                                                                                                                                                                                                                                                                                                                                                                                                                               |
|---------------------------------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
|  [ContentType](/dotnet/api/microsoft.azure.servicebus.message.contenttype) (content-type)           | Descrive facoltativamente il payload del messaggio, con un descrittore che segue il formato RFC2045, Sezione 5, ad esempio `application/json`.                                                                                                                                                                                                                                                                                             |
|  [CorrelationId](/dotnet/api/microsoft.azure.servicebus.message.correlationid#Microsoft_Azure_ServiceBus_Message_CorrelationId) (correlation-id)       | Consente a un'applicazione di specificare un contesto per il messaggio per finalità di correlazione, ad esempio rispecchiando il valore **MessageId** di un messaggio a cui si risponde.                                                                                                                                                                                                                                                                  |
| [DeadLetterSource](/dotnet/api/microsoft.azure.servicebus.message.deadlettersource)                      | Viene configurata solo nei messaggi impostati come non recapitabili e quindi inoltrati automaticamente dalla coda di messaggi non recapitabili a un'altra entità. Indica l'entità in cui il messaggio è stato impostato come non recapitabile. Questa proprietà è di sola lettura.                                                                                                                                                                                                                                  |
| [DeliveryCount](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.deliverycount)                         | Numero di tentativi di recapito per questo messaggio. Il numero viene incrementato allo scadere di un blocco di messaggio oppure quando il messaggio viene abbandonato esplicitamente dal ricevitore. Questa proprietà è di sola lettura.                                                                                                                                                                                                                                                  |
| [EnqueuedSequenceNumber](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.enqueuedsequencenumber)                | Per i messaggi inoltrati automaticamente questa proprietà rispecchia il numero di sequenza assegnato inizialmente al messaggio nel punto di invio originale. Questa proprietà è di sola lettura.                                                                                                                                                                                                                                                                |
| [EnqueuedTimeUtc](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.enqueuedtimeutc)                       | Istante UTC in cui il messaggio è stato accettato e archiviato nell'entità. Questo valore può essere usato come indicatore autorevole e neutro dell'ora di arrivo quando il ricevitore non vuole considerare attendibile il clock del mittente. Questa proprietà è di sola lettura.                                                                                                                                                                                                   |
|  [ExpiresAtUtc](/dotnet/api/microsoft.azure.servicebus.message.expiresatutc) (absolute-expiry-time) | Istante UTC in cui il messaggio viene contrassegnato per la rimozione e non risulta più disponibile per il recupero dall'entità a causa della scadenza. La scadenza viene controllata dalla proprietà **TimeToLive** e questa proprietà viene calcolata da EnqueuedTimeUtc+TimeToLive. Questa proprietà è di sola lettura.                                                                                                                                                                           |
| [ForcePersistence](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.forcepersistence)                      | Per le code o gli argomenti per cui è configurato il flag [EnableExpress](/dotnet/api/microsoft.servicebus.messaging.queuedescription.enableexpress?view=azureservicebus-4.1.1#Microsoft_ServiceBus_Messaging_QueueDescription_EnableExpress), questa proprietà può essere impostata in modo da indicare che il messaggio deve essere salvato in modo permanente su disco prima dell'acknowledgment. Questo è il comportamento standard per tutte le entità non Express.                                                                                                                                                                                                         |
| [Label](/dotnet/api/microsoft.azure.servicebus.message.label) (subject)                       | Questa proprietà consente all'applicazione di indicare la finalità del messaggio al ricevitore in modo standardizzato, analogamente alla riga dell'oggetto del messaggio di posta elettronica.                                                                                                                                                                                                                                                                                  |
| [LockedUntilUtc](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.lockeduntilutc)                        | Per i messaggi recuperati in caso di blocco (modalità di ricezione blocco di visualizzazione, non pre-finalizzati), questa proprietà rispecchia l'istante UTC di termine del blocco del messaggio nella coda/sottoscrizione. Alla scadenza del blocco, la proprietà [DeliveryCount](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.deliverycount) viene incrementata e il messaggio è di nuovo disponibile per il recupero. Questa proprietà è di sola lettura.                                                                                                                         |
| [LockToken](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.locktoken)                             | Il token di blocco è un riferimento al blocco mantenuto dal broker nella modalità di ricezione *blocco di visualizzazione*. Il token può essere usato per aggiungere in modo permanente il blocco tramite l'API [Differimento](message-deferral.md) e quindi di estrarre il messaggio dal flusso normale dello stato di recapito. Questa proprietà è di sola lettura.                                                                                                                                                               |
| [MessageId](/dotnet/api/microsoft.azure.servicebus.message.messageid) (message-id)                | Questo identificatore di messaggio è un valore definito dall'applicazione che identifica in modo univoco il messaggio e il rispettivo payload. L'identificatore è una stringa freeform e può rispecchiare un GUID o un identificatore derivato dal contesto dell'applicazione. Se abilitata, la funzionalità di [rilevamento duplicati](duplicate-detection.md) identifica e rimuove il secondo invio e gli invii successivi di messaggi con lo stesso valore **MessageId**.                                                                |
| [PartitionKey](/dotnet/api/microsoft.azure.servicebus.message.partitionkey)                          | Per le [entità partizionate](service-bus-partitioning.md), la configurazione di questo valore consente di assegnare i messaggi correlati alla stessa partizione interna, in modo che l'ordine della sequenza di invio sia registrato correttamente. La partizione viene scelta in base a una funzione hash su questo valore e non può essere scelta direttamente. Per entità con riconoscimento della sessione, la proprietà **SessionId** esegue l'override di questo valore.                                                                                                       |
| [ReplyTo](/dotnet/api/microsoft.azure.servicebus.message.replyto) (reply-to)                    | Questo valore facoltativo e definito dall'applicazione è un modo standard per esprimere un percorso di risposta verso il ricevitore del messaggio. Quando un mittente si aspetta una risposta, imposta il valore sul percorso assoluto o relativo della coda o dell'argomento a cui si prevede che venga inviata la risposta.                                                                                                                                           |
| [ReplyToSessionId](/dotnet/api/microsoft.azure.servicebus.message.replytosessionid) (reply-to-group-id)  | Questo valore aumenta l'informazione **ReplyTo** e specifica quale valore **SessionId** deve essere impostato per la risposta in caso di invio all'entità di risposta.                                                                                                                                                                                                                                                                            |
| [ScheduledEnqueueTimeUtc](/dotnet/api/microsoft.azure.servicebus.message.scheduledenqueuetimeutc)               | Per i messaggi che vengono resi disponibili solo per il recupero dopo un ritardo, questa proprietà definisce l'istante UTC in cui il messaggio verrà sottoposto logicamente ad accodamento e sequenziamento e verrà quindi reso disponibile per il recupero.                                                                                                                                                                                                                 |
| [SequenceNumber](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.sequencenumber)                        | Il numero di sequenza è un numero intero univoco a 64 bit assegnato a un messaggio quando viene accettato e archiviato dal broker. Viene usato come identificatore effettivo del messaggio. Per le entità partizionate, i primi 16 bit rispecchiano l'identificatore della partizione. I numeri di sequenza vengono incrementati in modo progressivo costante e senza pause. Viene eseguito il rollover a 0 all'esaurimento dell'intervallo compreso tra 48 e 64 bit. Questa proprietà è di sola lettura.                                                                |
| [SessionId](/dotnet/api/microsoft.azure.servicebus.message.sessionid) (group-id)                  | Per le entità con riconoscimento della sessione, questo valore definito dall'applicazione specifica l'affiliazione di sessione del messaggio. I messaggi con lo stesso identificatore di sessione sono soggetti al blocco di riepilogo e consentono l'elaborazione esatta in ordine e il demultiplexing. Per le entità senza riconoscimento della sessione, questo valore viene ignorato.                                                                                                                                     |
| [Dimensione](/dotnet/api/microsoft.azure.servicebus.message.size)                                  | Rispecchia le dimensioni archiviate del messaggio nel log del broker come conteggio di byte e viene inclusa nel calcolo della quota di archiviazione. Questa proprietà è di sola lettura.                                                                                                                                                                                                                                                                                                       |
| [State](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.state)                                 | Indica lo stato del messaggio nel log. Questa proprietà è rilevante solo durante l'esplorazione dei messaggi ("anteprima") e consente di determinare se un messaggio è "attivo" e disponibile per il recupero quando raggiunge la parte superiore della coda oppure se viene posticipato o è in attesa di pianificazione. Questa proprietà è di sola lettura.                                                                                                                                           |
| [TimeToLive](/dotnet/api/microsoft.azure.servicebus.message.timetolive)                            | Questo valore indica la durata relativa dopo cui il messaggio scade, a partire dall'istante in cui il messaggio è stato accettato e archiviato dal broker, in base a quanto acquisito in **EnqueueTimeUtc**. Se non è configurata in modo esplicito, il valore predefinito è il **DefaultTimeToLive** per la coda o l'argomento corrispondente. Un valore **TimeToLive** a livello di messaggio non può essere superiore all'impostazione **DefaultTimeToLive** dell'entità e viene modificato automaticamente nel caso in cui sia troppo elevato. |
| [To](/dotnet/api/microsoft.azure.servicebus.message.to) (to)                               | Questa proprietà è riservata per l'uso futuro negli scenari di routing e viene attualmente ignorata dal broker. Le applicazioni possono usare questo valore in scenari di concatenamento con inoltro automatico basato su regole, per indicare la destinazione logica prevista per il messaggio.                                                                                                                                                                                   |
| [ViaPartitionKey](/dotnet/api/microsoft.azure.servicebus.message.viapartitionkey)                       | Se un messaggio viene inviato tramite una coda di trasferimento nell'ambito di una transazione, questo valore seleziona la partizione della coda di trasferimento.                                                                                                                                                                                                                                                                                                                 |

Il modello di messaggio astratto consente l'inserimento di un messaggio in una coda tramite HTTP (in effetti sempre HTTPS) e ne consente il recupero tramite AMQP. In entrambi i casi, l'aspetto del messaggio è normale nel contesto del rispettivo protocollo. Le proprietà del broker vengono convertite in base alla necessità e le proprietà utente sono mappate alla posizione più appropriata nel rispettivo modello di messaggi relativo al protocollo. In HTTP le proprietà utente sono mappate direttamente verso e dalle intestazioni HTTP. In AMQP sono mappate verso e dalla mappa **applicazione-proprietà**.

## <a name="message-routing-and-correlation"></a>Routing e correlazione dei messaggi

Un sottoinsieme delle proprietà del broker illustrate in precedenza, in particolare [To](/dotnet/api/microsoft.azure.servicebus.message.to), [ReplyTo](/dotnet/api/microsoft.azure.servicebus.message.replyto), [ReplyToSessionId](/dotnet/api/microsoft.azure.servicebus.message.replytosessionid), [MessageId](/dotnet/api/microsoft.azure.servicebus.message.messageid), [CorrelationId](/dotnet/api/microsoft.azure.servicebus.message.correlationid) e [SessionId](/dotnet/api/microsoft.azure.servicebus.message.sessionid), viene usato per consentire alle applicazioni di indirizzare i messaggi verso destinazioni specifiche. Per illustrare questo scenario, esaminare alcuni modelli:

- **Semplice richiesta/risposta**: un'entità di pubblicazione invia un messaggio a una coda e si aspetta una risposta dal consumer di messaggi. Per ricevere la risposta, l'entità di pubblicazione è proprietaria di una coda in cui si aspetta che vengano recapitate le risposte. L'indirizzo di tale coda viene espresso nella proprietà **ReplyTo** del messaggio in uscita. Quando il consumer risponde, copia il valore **MessageId** del messaggio gestito nella proprietà **CorrelationId** del messaggio di risposta e recapita il messaggio alla destinazione indicata dalla proprietà **ReplyTo**. Un messaggio può ottenere più risposte, in base al contesto dell'applicazione.
- **Richiesta/Risposta multicast**: come variazione rispetto al modello precedente, un'entità di pubblicazione invia il messaggio in un argomento e più sottoscrittori risultano idonei all'utilizzo del messaggio. Ogni sottoscrittore può rispondere come illustrato in precedenza. Questo modello viene usato in scenari di individuazione o di verifica di presenze e l'intervistato si identifica in genere con una proprietà utente o all'interno del payload. Se **ReplyTo** fa riferimento a un argomento, tale set di risposte di individuazione può essere distribuito a un gruppo di destinatari.
- **Multiplexing**: questa funzionalità della sessione consente il multiplexing dei flussi di messaggi correlati tramite una singola coda o sottoscrizione, in modo che ogni sessione o gruppo di messaggi correlati, identificati da valori **SessionId** corrispondenti, venga indirizzato a un ricevitore specifico mentre il ricevitore applica un blocco alla sessione. Altre informazioni sui dettagli delle sessioni sono disponibili [qui](message-sessions.md).
- **Richiesta/Risposta con multiplexing**: questa funzionalità della sessione abilita le risposte con multiplexing, consentendo a diverse entità di pubblicazione di condividere una coda di risposte. Configurando il valore **ReplyToSessionId**, l'entità di pubblicazione può richiedere ai consumer di copiare tale valore nella proprietà **SessionId** del messaggio di risposta. Non è necessario che la coda o l'argomento di pubblicazione sia in grado di riconoscere la sessione. Quando il messaggio viene inviato, l'entità di pubblicazione può quindi attendere in modo specifico che nella coda si materializzi una sessione con il valore **SessionId** specificato, accettando in modo condizionale un ricevitore di sessione. 

È possibile ottenere il routing all'interno di uno spazio dei nomi del bus di servizio tramite il concatenamento di inoltro automatico e le regole di sottoscrizione degli argomenti. È possibile ottenere il routing tra spazi dei nomi tramite le [app per la logica di Azure](https://azure.microsoft.com/services/logic-apps/). Come indicato nell'esempio precedente, la proprietà **To** è riservata per l'uso futuro e potrebbe essere interpretata dal broker con una funzionalità abilitata in modo specifico. Le applicazioni che vogliono implementare il routing devono eseguire questa operazione in base alle proprietà utente, senza affidarsi alla proprietà **To**. Questo approccio, tuttavia, non provocherà problemi di compatibilità.

## <a name="payload-serialization"></a>Serializzazione del payload

Durante il transito o l'archiviazione nel bus di servizio, il payload è sempre un blocco binario opaco. La proprietà [ContentType](/dotnet/api/microsoft.azure.servicebus.message.contenttype) consente all'applicazione di descrivere il payload, con il formato suggerito per i valori della proprietà corrispondente a una descrizione di tipo contenuto MIME basata su IETF RFC2045, ad esempio `application/json;charset=utf-8`.

A differenza delle varianti per Java o .NET Standard, la versione .NET Framework dell'API Bus di servizio supporta la creazione di istanze di **BrokeredMessage** tramite il passaggio di oggetti .NET arbitrari al costruttore. 

Quando si usa il protocollo SBMP legacy, questi oggetti vengono quindi serializzati con il serializzatore binario predefinito o con un serializzatore fornito esternamente. Quando si usa il protocollo AMQP, l'oggetto viene serializzato in un oggetto AMQP. Il ricevitore può recuperare questi oggetti con il metodo [GetBody<T>()](/dotnet/api/microsoft.servicebus.messaging.brokeredmessage.getbody#Microsoft_ServiceBus_Messaging_BrokeredMessage_GetBody__1), specificando il tipo previsto. Con AMQP, gli oggetti vengono serializzati in un grafico AMQP di oggetti **ArrayList** e **IDictionary<stringa,oggetto>** e possono essere decodificati da un client AMQP. 

Anche se questo approccio di serializzazione nascosta risulta utile, è consigliabile che le applicazioni abbiano il controllo esplicito della serializzazione degli oggetti e trasformino i grafici di oggetti in flussi prima di includerli in un messaggio e che l'operazione inversa venga eseguita sul lato del ricevitore. In questo modo si ottengono risultati interoperativi. Occorre anche notare che, anche se AMQP ha un modello di codifica binaria avanzato, è associato all'ecosistema di messaggistica AMQP e i client HTTP decodificheranno con difficoltà tali payload. 

È in genere consigliabili usare JSON e Apache Avro come formati di payload per i dati strutturati.

Le varianti di API .NET Standard e Java accettano solo matrici di byte e quindi l'applicazione deve gestire il controllo della serializzazione degli oggetti. 

## <a name="next-steps"></a>Passaggi successivi

Per altre informazioni sulla messaggistica del bus di servizio, vedere gli argomenti seguenti:

* [Dati fondamentali del bus di servizio](service-bus-fundamentals-hybrid-solutions.md)
* [Code, argomenti e sottoscrizioni del bus di servizio](service-bus-queues-topics-subscriptions.md)
* [Introduzione alle code del bus di servizio](service-bus-dotnet-get-started-with-queues.md)
* [Come usare gli argomenti e le sottoscrizioni del bus di servizio](service-bus-dotnet-how-to-use-topics-subscriptions.md)