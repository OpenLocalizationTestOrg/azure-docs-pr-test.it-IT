---
title: Backup e ripristino di Service Fabric | Documentazione Microsoft
description: Documentazione concettuale per il backup e ripristino di Service Fabric
services: service-fabric
documentationcenter: .net
author: mcoskun
manager: timlt
editor: subramar,jessebenson
ms.assetid: 91ea6ca4-cc2a-4155-9823-dcbd0b996349
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 08/18/2017
ms.author: mcoskun
ms.openlocfilehash: 4242962e7e03053ef25f198a0b2f6c8012e693eb
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/29/2017
---
# <a name="back-up-and-restore-reliable-services-and-reliable-actors"></a><span data-ttu-id="02dab-103">Eseguire il backup e il ripristino di Reliable Services e Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="02dab-103">Back up and restore Reliable Services and Reliable Actors</span></span>
<span data-ttu-id="02dab-104">Azure Service Fabric è una piattaforma a disponibilità elevata che replica lo stato in più nodi per mantenere questa disponibilità elevata.</span><span class="sxs-lookup"><span data-stu-id="02dab-104">Azure Service Fabric is a high-availability platform that replicates the state across multiple nodes to maintain this high availability.</span></span>  <span data-ttu-id="02dab-105">Anche in caso di errore di un nodo nel cluster, il servizio rimarrà quindi comunque disponibile.</span><span class="sxs-lookup"><span data-stu-id="02dab-105">Thus, even if one node in the cluster fails, the services continue to be available.</span></span> <span data-ttu-id="02dab-106">Anche se questa ridondanza predefinita fornita dalla piattaforma può essere sufficiente per alcune situazioni, in determinati casi è preferibile che il servizio esegua il backup dei dati in un archivio esterno.</span><span class="sxs-lookup"><span data-stu-id="02dab-106">While this in-built redundancy provided by the platform may be sufficient for some, in certain cases it is desirable for the service to back up data (to an external store).</span></span>

> [!NOTE]
> <span data-ttu-id="02dab-107">È fondamentale eseguire il backup e il ripristino dei dati (e verificare che funzionino come previsto) per poter eseguire il ripristino in caso di perdita di dati.</span><span class="sxs-lookup"><span data-stu-id="02dab-107">It is critical to backup and restore your data (and test that it works as expected) so you can recover from data loss scenarios.</span></span>
> 
> 

<span data-ttu-id="02dab-108">Ad esempio, è possibile che in un servizio sia consigliabile eseguire il backup dei dati per evitare gli scenari seguenti:</span><span class="sxs-lookup"><span data-stu-id="02dab-108">For example, a service may want to back up data in order to protect from the following scenarios:</span></span>

- <span data-ttu-id="02dab-109">Perdita definitiva di un intero cluster di Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="02dab-109">In the event of the permanent loss of an entire Service Fabric cluster.</span></span>
- <span data-ttu-id="02dab-110">Perdita definitiva della maggior parte delle repliche di una partizione del servizio.</span><span class="sxs-lookup"><span data-stu-id="02dab-110">Permanent loss of a majority of the replicas of a service partition</span></span>
- <span data-ttu-id="02dab-111">Errori amministrativi che provocano l'eliminazione o il danneggiamento accidentale dello stato.</span><span class="sxs-lookup"><span data-stu-id="02dab-111">Administrative errors whereby the state accidentally gets deleted or corrupted.</span></span> <span data-ttu-id="02dab-112">Ad esempio, questo problema può verificarsi se un amministratore con privilegi sufficienti elimina accidentalmente il servizio.</span><span class="sxs-lookup"><span data-stu-id="02dab-112">For example, this may happen if an administrator with sufficient privilege erroneously deletes the service.</span></span>
- <span data-ttu-id="02dab-113">Bug nel servizio che provocano il danneggiamento dei dati.</span><span class="sxs-lookup"><span data-stu-id="02dab-113">Bugs in the service that cause data corruption.</span></span> <span data-ttu-id="02dab-114">Ad esempio, questo problema può verificarsi quando un aggiornamento del codice di servizio inizia a scrivere dati non corretti in una raccolta Reliable Collections.</span><span class="sxs-lookup"><span data-stu-id="02dab-114">For example, this may happen when a service code upgrade starts writing faulty data to a Reliable Collection.</span></span> <span data-ttu-id="02dab-115">In tal caso, potrebbe essere necessario ripristinare uno stato precedente sia per il codice che per i dati.</span><span class="sxs-lookup"><span data-stu-id="02dab-115">In such a case, both the code and the data may have to be reverted to an earlier state.</span></span>
- <span data-ttu-id="02dab-116">Elaborazione dati offline.</span><span class="sxs-lookup"><span data-stu-id="02dab-116">Offline data processing.</span></span> <span data-ttu-id="02dab-117">Potrebbe essere utile eseguire offline l'elaborazione dei dati per la business intelligence separatamente dal servizio che genera i dati.</span><span class="sxs-lookup"><span data-stu-id="02dab-117">It might be convenient to have offline processing of data for business intelligence that happens separately from the service that generates the data.</span></span>

<span data-ttu-id="02dab-118">La funzionalità Backup/Ripristino consente ai servizi basati sull'API Reliable Services di creare e ripristinare i backup.</span><span class="sxs-lookup"><span data-stu-id="02dab-118">The Backup/Restore feature allows services built on the Reliable Services API to create and restore backups.</span></span> <span data-ttu-id="02dab-119">Le API di backup fornite dalla piattaforma consentono il backup dello stato di una partizione del servizio senza bloccare le operazioni di lettura o scrittura.</span><span class="sxs-lookup"><span data-stu-id="02dab-119">The backup APIs provided by the platform allow backup(s) of a service partition's state, without blocking read or write operations.</span></span> <span data-ttu-id="02dab-120">Le API di ripristino consentono il ripristino dello stato di una partizione del servizio da un backup specificato.</span><span class="sxs-lookup"><span data-stu-id="02dab-120">The restore APIs allow a service partition's state to be restored from a chosen backup.</span></span>

## <a name="types-of-backup"></a><span data-ttu-id="02dab-121">Tipi di backup</span><span class="sxs-lookup"><span data-stu-id="02dab-121">Types of Backup</span></span>
<span data-ttu-id="02dab-122">Sono disponibili due opzioni di backup: completo e incrementale.</span><span class="sxs-lookup"><span data-stu-id="02dab-122">There are two backup options: Full and Incremental.</span></span>
<span data-ttu-id="02dab-123">Un backup completo contiene tutti i dati necessari per ricreare lo stato della replica, ossia i checkpoint e tutti i record di log.</span><span class="sxs-lookup"><span data-stu-id="02dab-123">A full backup is a backup that contains all the data required to recreate the state of the replica: checkpoints and all log records.</span></span>
<span data-ttu-id="02dab-124">Visto che contiene i checkpoint e il log, un backup completo può ripristinarsi autonomamente.</span><span class="sxs-lookup"><span data-stu-id="02dab-124">Since it has the checkpoints and the log, a full backup can be restored by itself.</span></span>

<span data-ttu-id="02dab-125">I problemi con i backup completi si verificano quando i checkpoint sono di grandi dimensioni.</span><span class="sxs-lookup"><span data-stu-id="02dab-125">The problem with full backups arises when the checkpoints are large.</span></span>
<span data-ttu-id="02dab-126">Ad esempio, una replica con un stato di 16 GB avrà checkpoint che aggiungono circa 16 GB.</span><span class="sxs-lookup"><span data-stu-id="02dab-126">For example, a replica that has 16 GB of state will have checkpoints that add up approximately to 16 GB.</span></span>
<span data-ttu-id="02dab-127">Se l'obiettivo del punto di ripristino è di 5 minuti, il backup della replica deve essere eseguito ogni 5 minuti.</span><span class="sxs-lookup"><span data-stu-id="02dab-127">If we have a Recovery Point Objective of five minutes, the replica needs to be backed up every five minutes.</span></span>
<span data-ttu-id="02dab-128">A ogni backup, dovranno essere copiati 16 GB dei checkpoint oltre a 50 MB di log (configurabili usando `CheckpointThresholdInMB`).</span><span class="sxs-lookup"><span data-stu-id="02dab-128">Each time it backs up it needs to copy 16 GB of checkpoints in addition to 50 MB (configurable using `CheckpointThresholdInMB`) worth of logs.</span></span>

![Esempio di backup completo.](media/service-fabric-reliable-services-backup-restore/FullBackupExample.PNG)

<span data-ttu-id="02dab-130">Per risolvere questo problema è possibile usare i backup incrementali, in cui il backup contiene solo i record del log modificati dopo l'ultimo backup.</span><span class="sxs-lookup"><span data-stu-id="02dab-130">The solution to this problem is incremental backups, where backup only contains the changed log records since the last backup.</span></span>

![Esempio di backup incrementale.](media/service-fabric-reliable-services-backup-restore/IncrementalBackupExample.PNG)

<span data-ttu-id="02dab-132">I backup incrementali includono solo le modifiche successive all'ultimo backup, senza checkpoint, quindi tendono a essere più veloci ma non possono essere ripristinati in modo indipendente.</span><span class="sxs-lookup"><span data-stu-id="02dab-132">Since incremental backups are only changes since the last backup (does not include the checkpoints), they tend to be faster but they cannot be restored on their own.</span></span>
<span data-ttu-id="02dab-133">Per ripristinare un backup incrementale, è necessaria l'intera catena di backup.</span><span class="sxs-lookup"><span data-stu-id="02dab-133">To restore an incremental backup, the entire backup chain is required.</span></span>
<span data-ttu-id="02dab-134">Una catena di backup inizia con un backup completo e prosegue con diversi backup incrementali contigui.</span><span class="sxs-lookup"><span data-stu-id="02dab-134">A backup chain is a chain of backups starting with a full backup and followed by a number of contiguous incremental backups.</span></span>

## <a name="backup-reliable-services"></a><span data-ttu-id="02dab-135">Eseguire il backup di Reliable Services</span><span class="sxs-lookup"><span data-stu-id="02dab-135">Backup Reliable Services</span></span>
<span data-ttu-id="02dab-136">L'autore del servizio ha il controllo completo sul momento di esecuzione dei backup e sulla posizione in cui vengono archiviati.</span><span class="sxs-lookup"><span data-stu-id="02dab-136">The service author has full control of when to make backups and where backups will be stored.</span></span>

<span data-ttu-id="02dab-137">Per avviare un backup, il servizio deve chiamare la funzione membro ereditata `BackupAsync`.</span><span class="sxs-lookup"><span data-stu-id="02dab-137">To start a backup, the service needs to invoke the inherited member function `BackupAsync`.</span></span>  
<span data-ttu-id="02dab-138">I backup possono essere eseguiti solo da repliche primarie e richiedono la concessione dello stato di scrittura.</span><span class="sxs-lookup"><span data-stu-id="02dab-138">Backups can be made only from primary replicas, and they require write status to be granted.</span></span>

<span data-ttu-id="02dab-139">Come mostrato di seguito, `BackupAsync` accetta un oggetto `BackupDescription`, in cui è possibile specificare un backup completo o incrementale, nonché una funzione di callback, `Func<< BackupInfo, CancellationToken, Task<bool>>>`, che viene chiamata quando la cartella di backup è stata creata in locale e può essere spostata in un archivio esterno.</span><span class="sxs-lookup"><span data-stu-id="02dab-139">As shown below, `BackupAsync` takes in a `BackupDescription` object, where one can specify a full or incremental backup, as well as a callback function, `Func<< BackupInfo, CancellationToken, Task<bool>>>` that is invoked when the backup folder has been created locally and is ready to be moved out to some external storage.</span></span>

```csharp

BackupDescription myBackupDescription = new BackupDescription(backupOption.Incremental,this.BackupCallbackAsync);

await this.BackupAsync(myBackupDescription);

```

<span data-ttu-id="02dab-140">La richiesta di esecuzione di un backup incrementale può non riuscire con `FabricMissingFullBackupException`.</span><span class="sxs-lookup"><span data-stu-id="02dab-140">Request to take an incremental backup can fail with `FabricMissingFullBackupException`.</span></span> <span data-ttu-id="02dab-141">Questa eccezione segnala il verificarsi di una delle condizioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="02dab-141">This exception indicates that one of the following things is happening:</span></span>

- <span data-ttu-id="02dab-142">la replica non ha mai eseguito un backup completo dopo essere diventata primaria,</span><span class="sxs-lookup"><span data-stu-id="02dab-142">the replica has never taken a full backup since it has become primary,</span></span>
- <span data-ttu-id="02dab-143">che alcuni dei record di log dall'ultimo backup sono stati troncati o</span><span class="sxs-lookup"><span data-stu-id="02dab-143">some of the log records since the last backup has been truncated or</span></span>
- <span data-ttu-id="02dab-144">la replica ha superato il limite `MaxAccumulatedBackupLogSizeInMB`.</span><span class="sxs-lookup"><span data-stu-id="02dab-144">replica passed the `MaxAccumulatedBackupLogSizeInMB` limit.</span></span>

<span data-ttu-id="02dab-145">Gli utenti possono aumentare le probabilità di riuscire a eseguire i backup incrementali configurando `MinLogSizeInMB` o `TruncationThresholdFactor`.</span><span class="sxs-lookup"><span data-stu-id="02dab-145">Users can increase the likelihood of being able to do incremental backups by configuring `MinLogSizeInMB` or `TruncationThresholdFactor`.</span></span>
<span data-ttu-id="02dab-146">Si noti che l'aumento di questi valori comporta un aumento dell'utilizzo del disco per replica.</span><span class="sxs-lookup"><span data-stu-id="02dab-146">Note that increasing these values increases the per replica disk usage.</span></span>
<span data-ttu-id="02dab-147">Per altre informazioni, vedere [Configurazione di Reliable Services](service-fabric-reliable-services-configuration.md)</span><span class="sxs-lookup"><span data-stu-id="02dab-147">For more information, see [Reliable Services Configuration](service-fabric-reliable-services-configuration.md)</span></span>

<span data-ttu-id="02dab-148">`BackupInfo` fornisce le informazioni relative al backup, incluso il percorso della cartella in cui il runtime ha salvato il backup (`BackupInfo.Directory`).</span><span class="sxs-lookup"><span data-stu-id="02dab-148">`BackupInfo` provides information regarding the backup, including the location of the folder where the runtime saved the backup (`BackupInfo.Directory`).</span></span> <span data-ttu-id="02dab-149">La funzione di callback può spostare `BackupInfo.Directory` in un archivio esterno o in un'altra posizione.</span><span class="sxs-lookup"><span data-stu-id="02dab-149">The callback function can move the `BackupInfo.Directory` to an external store or another location.</span></span>  <span data-ttu-id="02dab-150">Questa funzione restituisce anche un valore booleano che indica se è riuscita a spostare la cartella di backup nel percorso di destinazione.</span><span class="sxs-lookup"><span data-stu-id="02dab-150">This function also returns a bool that indicates whether it was able to successfully move the backup folder to its target location.</span></span>

<span data-ttu-id="02dab-151">Il codice seguente illustra in che modo è possibile usare il metodo `BackupCallbackAsync` per caricare il backup in Archiviazione di Azure:</span><span class="sxs-lookup"><span data-stu-id="02dab-151">The following code demonstrates how the `BackupCallbackAsync` method can be used to upload the backup to Azure Storage:</span></span>

```csharp
private async Task<bool> BackupCallbackAsync(BackupInfo backupInfo, CancellationToken cancellationToken)
{
    var backupId = Guid.NewGuid();

    await externalBackupStore.UploadBackupFolderAsync(backupInfo.Directory, backupId, cancellationToken);

    return true;
}
```

<span data-ttu-id="02dab-152">Nell'esempio precedente `ExternalBackupStore` corrisponde alla classe di esempio usata per interfacciarsi con il servizio di archiviazione BLOB di Azure e `UploadBackupFolderAsync` è il metodo che comprime la cartella e la inserisce nell'archivio BLOB di Azure.</span><span class="sxs-lookup"><span data-stu-id="02dab-152">In the preceeding example, `ExternalBackupStore` is the sample class that is used to interface with Azure Blob storage, and `UploadBackupFolderAsync` is the method that compresses the folder and places it in the Azure Blob store.</span></span>

<span data-ttu-id="02dab-153">Si noti che:</span><span class="sxs-lookup"><span data-stu-id="02dab-153">Note that:</span></span>

  - <span data-ttu-id="02dab-154">In un dato momento può essere in corso una sola operazione di backup per replica.</span><span class="sxs-lookup"><span data-stu-id="02dab-154">There can be only one backup operation in-flight per replica at any given time.</span></span> <span data-ttu-id="02dab-155">Se si hanno più chiamate `BackupAsync` simultanee, `FabricBackupInProgressException` limita a una le esecuzioni dei backup.</span><span class="sxs-lookup"><span data-stu-id="02dab-155">More than one `BackupAsync` call at a time will throw `FabricBackupInProgressException` to limit inflight backups to one.</span></span>
  - <span data-ttu-id="02dab-156">In caso di failover di una replica durante l'esecuzione di un backup, è possibile che il backup non venga completato.</span><span class="sxs-lookup"><span data-stu-id="02dab-156">If a replica fails over while a backup is in progress, the backup may not have been completed.</span></span> <span data-ttu-id="02dab-157">Al termine del failover, il servizio dovrà quindi riavviare il backup chiamando `BackupAsync`, se necessario.</span><span class="sxs-lookup"><span data-stu-id="02dab-157">Thus, once the failover finishes, it is the service's responsibility to restart the backup by invoking `BackupAsync` as necessary.</span></span>

## <a name="restore-reliable-services"></a><span data-ttu-id="02dab-158">Ripristinare Reliable Services</span><span class="sxs-lookup"><span data-stu-id="02dab-158">Restore Reliable Services</span></span>
<span data-ttu-id="02dab-159">In generale, i casi in cui potrebbe essere necessario eseguire un'operazione di ripristino rientrano in una di queste categorie:</span><span class="sxs-lookup"><span data-stu-id="02dab-159">In general, the cases when you might need to perform a restore operation fall into one of these categories:</span></span>

  - <span data-ttu-id="02dab-160">La partizione del servizio ha perso dati.</span><span class="sxs-lookup"><span data-stu-id="02dab-160">The service partition lost data.</span></span> <span data-ttu-id="02dab-161">Ad esempio, il disco per due su tre repliche per una partizione, inclusa la replica primaria, viene danneggiato o cancellato.</span><span class="sxs-lookup"><span data-stu-id="02dab-161">For example, the disk for two out of three replicas for a partition (including the primary replica) gets corrupted or wiped.</span></span> <span data-ttu-id="02dab-162">La nuova replica primaria potrebbe dover ripristinare i dati da un backup.</span><span class="sxs-lookup"><span data-stu-id="02dab-162">The new primary may need to restore data from a backup.</span></span>
  - <span data-ttu-id="02dab-163">L'intero servizio è andato perso.</span><span class="sxs-lookup"><span data-stu-id="02dab-163">The entire service is lost.</span></span> <span data-ttu-id="02dab-164">Ad esempio, un amministratore rimuove l'intero servizio ed è quindi necessario ripristinare il servizio e i dati.</span><span class="sxs-lookup"><span data-stu-id="02dab-164">For example, an administrator removes the entire service and thus the service and the data need to be restored.</span></span>
  - <span data-ttu-id="02dab-165">Il servizio ha replicato dati danneggiati dell'applicazione, ad esempio a causa di un bug dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="02dab-165">The service replicated corrupt application data (e.g., because of an application bug).</span></span> <span data-ttu-id="02dab-166">Sarà quindi necessario aggiornare o ripristinare il servizio per rimuovere la causa del danneggiamento e ripristinare dati non danneggiati.</span><span class="sxs-lookup"><span data-stu-id="02dab-166">In this case, the service has to be upgraded or reverted to remove the cause of the corruption, and non-corrupt data has to be restored.</span></span>

<span data-ttu-id="02dab-167">Anche se sono possibili molti approcci, gli esempi seguenti sono basati sull'uso di `RestoreAsync` per il ripristino dagli scenari precedenti.</span><span class="sxs-lookup"><span data-stu-id="02dab-167">While many approaches are possible, we offer some examples on using `RestoreAsync` to recover from the above scenarios.</span></span>

## <a name="partition-data-loss-in-reliable-services"></a><span data-ttu-id="02dab-168">Perdita di dati della partizione in Reliable Services</span><span class="sxs-lookup"><span data-stu-id="02dab-168">Partition data loss in Reliable Services</span></span>
<span data-ttu-id="02dab-169">In questo caso, il runtime rileva automaticamente la perdita dei dati e chiama l'API `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="02dab-169">In this case, the runtime would automatically detect the data loss and invoke the `OnDataLossAsync` API.</span></span>

<span data-ttu-id="02dab-170">L'autore del servizio deve eseguire le operazioni seguenti per il ripristino:</span><span class="sxs-lookup"><span data-stu-id="02dab-170">The service author needs to perform the following to recover:</span></span>

  - <span data-ttu-id="02dab-171">Eseguire l'override del metodo della classe base virtuale `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="02dab-171">Override the virtual base class method `OnDataLossAsync`.</span></span>
  - <span data-ttu-id="02dab-172">Trovare il backup più recente nella posizione esterna che include i backup del servizio.</span><span class="sxs-lookup"><span data-stu-id="02dab-172">Find the latest backup in the external location that contains the service's backups.</span></span>
  - <span data-ttu-id="02dab-173">Scaricare il backup più recente e decomprimerlo nella cartella di backup, se è compresso</span><span class="sxs-lookup"><span data-stu-id="02dab-173">Download the latest backup (and uncompress the backup into the backup folder if it was compressed).</span></span>
  - <span data-ttu-id="02dab-174">Il metodo `OnDataLossAsync` restituisce `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="02dab-174">The `OnDataLossAsync` method provides a `RestoreContext`.</span></span> <span data-ttu-id="02dab-175">Chiamare l'API `RestoreAsync` nel `RestoreContext` restituito.</span><span class="sxs-lookup"><span data-stu-id="02dab-175">Call the `RestoreAsync` API on the provided `RestoreContext`.</span></span>
  - <span data-ttu-id="02dab-176">Restituire true se il ripristino è stato completato.</span><span class="sxs-lookup"><span data-stu-id="02dab-176">Return true if the restoration was a success.</span></span>

<span data-ttu-id="02dab-177">Di seguito è riportato un esempio di implementazione del metodo `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="02dab-177">Following is an example implementation of the `OnDataLossAsync` method:</span></span>

```csharp
protected override async Task<bool> OnDataLossAsync(RestoreContext restoreCtx, CancellationToken cancellationToken)
{
    var backupFolder = await this.externalBackupStore.DownloadLastBackupAsync(cancellationToken);

    var restoreDescription = new RestoreDescription(backupFolder);

    await restoreCtx.RestoreAsync(restoreDescription);

    return true;
}
```

<span data-ttu-id="02dab-178">Il metodo `RestoreDescription` passato alla chiamata `RestoreContext.RestoreAsync` contiene un membro chiamato `BackupFolderPath`.</span><span class="sxs-lookup"><span data-stu-id="02dab-178">`RestoreDescription` passed in to the `RestoreContext.RestoreAsync` call contains a member called `BackupFolderPath`.</span></span>
<span data-ttu-id="02dab-179">Quando si ripristina un singolo backup completo, `BackupFolderPath` deve essere impostato sul percorso locale della cartella che contiene il backup completo.</span><span class="sxs-lookup"><span data-stu-id="02dab-179">When restoring a single full backup, this `BackupFolderPath` should be set to the local path of the folder that contains your full backup.</span></span>
<span data-ttu-id="02dab-180">Quando si ripristina un backup completo e alcuni backup incrementali, `BackupFolderPath` deve essere impostato sul percorso locale della cartella che contiene sia il backup completo che tutti i backup incrementali.</span><span class="sxs-lookup"><span data-stu-id="02dab-180">When restoring a full backup and a number of incremental backups, `BackupFolderPath` should be set to the local path of the folder that not only contains the full backup, but also all the incremental backups.</span></span>
<span data-ttu-id="02dab-181">La chiamata `RestoreAsync` può generare `FabricMissingFullBackupException` se il metodo `BackupFolderPath` restituito non contiene un backup completo.</span><span class="sxs-lookup"><span data-stu-id="02dab-181">`RestoreAsync` call can throw `FabricMissingFullBackupException` if the `BackupFolderPath` provided does not contain a full backup.</span></span>
<span data-ttu-id="02dab-182">Può anche generare `ArgumentException` se `BackupFolderPath` contiene una catena interrotta di backup incrementali,</span><span class="sxs-lookup"><span data-stu-id="02dab-182">It can also throw `ArgumentException` if `BackupFolderPath` has a broken chain of incremental backups.</span></span>
<span data-ttu-id="02dab-183">ad esempio, se contiene il backup completo e il primo e il terzo backup incrementale, ma non il secondo.</span><span class="sxs-lookup"><span data-stu-id="02dab-183">For example, if it contains the full backup, the first incremental and the third incremental backup but no the second incremental backup.</span></span>

> [!NOTE]
> <span data-ttu-id="02dab-184">Il valore RestorePolicy è Safe per impostazione predefinita.</span><span class="sxs-lookup"><span data-stu-id="02dab-184">The RestorePolicy is set to Safe by default.</span></span>  <span data-ttu-id="02dab-185">L'API `RestoreAsync` non riuscirà con ArgumentException se rileva che la cartella di backup include uno stato precedente o uguale allo stato contenuto nella replica.</span><span class="sxs-lookup"><span data-stu-id="02dab-185">This means that the `RestoreAsync` API will fail with ArgumentException if it detects that the backup folder contains a state that is older than or equal to the state contained in this replica.</span></span>  <span data-ttu-id="02dab-186">Per ignorare questo controllo di sicurezza è possibile usare `RestorePolicy.Force`.</span><span class="sxs-lookup"><span data-stu-id="02dab-186">`RestorePolicy.Force` can be used to skip this safety check.</span></span> <span data-ttu-id="02dab-187">Viene specificato come parte di `RestoreDescription`.</span><span class="sxs-lookup"><span data-stu-id="02dab-187">This is specified as part of `RestoreDescription`.</span></span>
> 

## <a name="deleted-or-lost-service"></a><span data-ttu-id="02dab-188">Servizio eliminato o perso</span><span class="sxs-lookup"><span data-stu-id="02dab-188">Deleted or lost service</span></span>
<span data-ttu-id="02dab-189">Se un servizio viene rimosso, per ripristinare i dati sarà prima di tutto necessario ricrearlo.</span><span class="sxs-lookup"><span data-stu-id="02dab-189">If a service is removed, you must first re-create the service before the data can be restored.</span></span>  <span data-ttu-id="02dab-190">È importante creare il servizio con la stessa configurazione, ad esempio con lo stesso schema di partizionamento, in modo che sia possibile ripristinare i dati senza problemi.</span><span class="sxs-lookup"><span data-stu-id="02dab-190">It is important to create the service with the same configuration, e.g., partitioning scheme, so that the data can be restored seamlessly.</span></span>  <span data-ttu-id="02dab-191">Quando il servizio è attivo, è necessario chiamare l'API per il ripristino dei dati (`OnDataLossAsync`, come indicato sopra) su ogni partizione del servizio.</span><span class="sxs-lookup"><span data-stu-id="02dab-191">Once the service is up, the API to restore data (`OnDataLossAsync` above) has to be invoked on every partition of this service.</span></span> <span data-ttu-id="02dab-192">A tal fine, è possibile usare `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` su ogni partizione.</span><span class="sxs-lookup"><span data-stu-id="02dab-192">One way of achieving this is by using `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` on every partition.</span></span>  

<span data-ttu-id="02dab-193">A partire da questo punto, l'implementazione è uguale a quella dello scenario precedente.</span><span class="sxs-lookup"><span data-stu-id="02dab-193">From this point, implementation is the same as the above scenario.</span></span> <span data-ttu-id="02dab-194">Ogni partizione deve ripristinare il backup rilevante più recente dall'archivio esterno.</span><span class="sxs-lookup"><span data-stu-id="02dab-194">Each partition needs to restore the latest relevant backup from the external store.</span></span> <span data-ttu-id="02dab-195">Occorre prestare attenzione al fatto che ora l'ID della partizione potrebbe essere diverso, perché il runtime crea dinamicamente gli ID delle partizioni.</span><span class="sxs-lookup"><span data-stu-id="02dab-195">One caveat is that the partition ID may have now changed, since the runtime creates partition IDs dynamically.</span></span> <span data-ttu-id="02dab-196">Il servizio deve quindi archiviare le informazioni sulla partizione e il nome del servizio appropriati per identificare il più recente backup corretto da ripristinare per ogni partizione.</span><span class="sxs-lookup"><span data-stu-id="02dab-196">Thus, the service needs to store the appropriate partition information and service name to identify the correct latest backup to restore from for each partition.</span></span>

> [!NOTE]
> <span data-ttu-id="02dab-197">Non è consigliabile usare `FabricClient.ServiceManager.InvokeDataLossAsync` su ogni partizione per ripristinare l'intero servizio perché può danneggiare lo stato del cluster.</span><span class="sxs-lookup"><span data-stu-id="02dab-197">It is not recommended to use `FabricClient.ServiceManager.InvokeDataLossAsync` on each partition to restore the entire service, since that may corrupt your cluster state.</span></span>
> 

## <a name="replication-of-corrupt-application-data"></a><span data-ttu-id="02dab-198">Replica di dati dell'applicazione danneggiati</span><span class="sxs-lookup"><span data-stu-id="02dab-198">Replication of corrupt application data</span></span>
<span data-ttu-id="02dab-199">Se l'aggiornamento dell'applicazione appena distribuito include un bug, potrebbe provocare il danneggiamento dei dati.</span><span class="sxs-lookup"><span data-stu-id="02dab-199">If the newly deployed application upgrade has a bug, that may cause corruption of data.</span></span> <span data-ttu-id="02dab-200">È ad esempio possibile che l'aggiornamento di un'applicazione inizi ad aggiornare ogni record relativo a numeri di telefono in un oggetto ReliableDictionary specificando un prefisso non valido.</span><span class="sxs-lookup"><span data-stu-id="02dab-200">For example, an application upgrade may start to update every phone number record in a Reliable Dictionary with an invalid area code.</span></span>  <span data-ttu-id="02dab-201">In questo caso, i numeri di telefono non validi verranno replicati, perché Service Fabric non conosce la natura dei dati archiviati.</span><span class="sxs-lookup"><span data-stu-id="02dab-201">In this case, the invalid phone numbers will be replicated since Service Fabric is not aware of the nature of the data that is being stored.</span></span>

<span data-ttu-id="02dab-202">Dopo avere rilevato un bug così grave da causare il danneggiamento dei dati, è prima di tutto necessario bloccare il servizio a livello di applicazione e, se possibile, eseguire l'aggiornamento alla versione del codice dell'applicazione che non include il bug.</span><span class="sxs-lookup"><span data-stu-id="02dab-202">The first thing to do after you detect such an egregious bug that causes data corruption is to freeze the service at the application level and, if possible, upgrade to the version of the application code that does not have the bug.</span></span>  <span data-ttu-id="02dab-203">Anche dopo la correzione del codice del servizio è tuttavia possibile che i dati siano ancora danneggiati e che sia necessario ripristinarli.</span><span class="sxs-lookup"><span data-stu-id="02dab-203">However, even after the service code is fixed, the data may still be corrupt and thus data may need to be restored.</span></span>  <span data-ttu-id="02dab-204">In questi casi potrebbe non essere sufficiente ripristinare il backup più recente, perché è possibile che anche i backup più recenti siano danneggiati.</span><span class="sxs-lookup"><span data-stu-id="02dab-204">In such cases, it may not be sufficient to restore the latest backup, since the latest backups may also be corrupt.</span></span>  <span data-ttu-id="02dab-205">È quindi necessario trovare il backup più recente eseguito prima del danneggiamento dei dati.</span><span class="sxs-lookup"><span data-stu-id="02dab-205">Thus, you have to find the last backup that was made before the data got corrupted.</span></span>

<span data-ttu-id="02dab-206">Se non si sa con esattezza quali siano i backup danneggiati, è possibile distribuire un nuovo Service Fabric Cluster e ripristinare i backup delle partizioni interessate con la stessa procedura dello scenario "Servizio eliminato o perso" precedente.</span><span class="sxs-lookup"><span data-stu-id="02dab-206">If you are not sure which backups are corrupt, you could deploy a new Service Fabric cluster and restore the backups of affected partitions just like the above "Deleted or lost service" scenario.</span></span>  <span data-ttu-id="02dab-207">Per ogni partizione, avviare il ripristino dei backup dal più recente al meno recente.</span><span class="sxs-lookup"><span data-stu-id="02dab-207">For each partition, start restoring the backups from the most recent to the least.</span></span> <span data-ttu-id="02dab-208">Dopo aver trovato un backup non danneggiato, spostare o eliminare tutti i backup della partizione più recenti di quel backup.</span><span class="sxs-lookup"><span data-stu-id="02dab-208">Once you find a backup that does not have the corruption, move/delete all backups of this partition that were more recent (than that backup).</span></span> <span data-ttu-id="02dab-209">Ripetere questo processo per ogni partizione.</span><span class="sxs-lookup"><span data-stu-id="02dab-209">Repeat this process for each partition.</span></span> <span data-ttu-id="02dab-210">Quando `OnDataLossAsync` viene chiamata sulla partizione nel cluster di produzione, il backup più recente trovato nell'archivio esterno verrà selezionato dal processo precedente.</span><span class="sxs-lookup"><span data-stu-id="02dab-210">Now, when `OnDataLossAsync` is called on the partition in the production cluster, the last backup found in the external store will be the one picked by the above process.</span></span>

<span data-ttu-id="02dab-211">È ora possibile usare la procedura illustrata nella sezione "Servizio eliminato o perso" per ripristinare lo stato del servizio sul valore precedente al danneggiamento da parte del codice con bug.</span><span class="sxs-lookup"><span data-stu-id="02dab-211">Now, the steps in the "Deleted or lost service" section can be used to restore the state of the service to the state before the buggy code corrupted the state.</span></span>

<span data-ttu-id="02dab-212">Si noti che:</span><span class="sxs-lookup"><span data-stu-id="02dab-212">Note that:</span></span>

  - <span data-ttu-id="02dab-213">Quando si esegue il ripristino è possibile che il backup ripristinato sia precedente allo stato della partizione prima della perdita dei dati.</span><span class="sxs-lookup"><span data-stu-id="02dab-213">When you restore, there is a chance that the backup being restored is older than the state of the partition before the data was lost.</span></span> <span data-ttu-id="02dab-214">È quindi necessario procedere al ripristino solo come ultima risorsa per recuperare la quantità maggiore possibile di dati.</span><span class="sxs-lookup"><span data-stu-id="02dab-214">Because of this, you should restore only as a last resort to recover as much data as possible.</span></span>
  - <span data-ttu-id="02dab-215">La stringa che rappresenta il percorso della cartella di backup e i percorsi dei file nella cartella di backup può superare i 255 caratteri, in base al percorso FabricDataRoot e alla lunghezza del nome del tipo di applicazione.</span><span class="sxs-lookup"><span data-stu-id="02dab-215">The string that represents the backup folder path and the paths of files inside the backup folder can be greater than 255 characters, depending on the FabricDataRoot path and Application Type name's length.</span></span> <span data-ttu-id="02dab-216">Questo approccio può far sì che alcuni metodi .NET, come `Directory.Move`, generino l'eccezione `PathTooLongException`.</span><span class="sxs-lookup"><span data-stu-id="02dab-216">This can cause some .NET methods, like `Directory.Move`, to throw the `PathTooLongException` exception.</span></span> <span data-ttu-id="02dab-217">Una soluzione alternativa consiste nel chiamare direttamente le API kernel32, come `CopyFile`.</span><span class="sxs-lookup"><span data-stu-id="02dab-217">One workaround is to directly call kernel32 APIs, like `CopyFile`.</span></span>

## <a name="backup-and-restore-reliable-actors"></a><span data-ttu-id="02dab-218">Eseguire il backup e il ripristino di Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="02dab-218">Backup and restore Reliable Actors</span></span>


<span data-ttu-id="02dab-219">Reliable Actors Framework si basa su Reliable Services.</span><span class="sxs-lookup"><span data-stu-id="02dab-219">Reliable Actors Framework is built on top of Reliable Services.</span></span> <span data-ttu-id="02dab-220">L'ActorService che ospita l'attore o gli attori è un servizio Reliable con stato.</span><span class="sxs-lookup"><span data-stu-id="02dab-220">The ActorService which hosts the actor(s) is a stateful reliable service.</span></span> <span data-ttu-id="02dab-221">Di conseguenza, tutte le funzionalità di backup e ripristino disponibili in Reliable Services sono disponibili anche per Reliable Actors (tranne i comportamenti specifici per il provider di stato).</span><span class="sxs-lookup"><span data-stu-id="02dab-221">Hence, all the backup and restore functionality available in Reliable Services is also available to Reliable Actors (except behaviors that are state provider specific).</span></span> <span data-ttu-id="02dab-222">Poiché i backup verranno eseguiti per partizione, verrà eseguito il backup degli stati per tutti gli attori in quella partizione (il ripristino è simile e verrà eseguito anch'esso per partizione).</span><span class="sxs-lookup"><span data-stu-id="02dab-222">Since backups will be taken on a per-partition basis, states for all actors in that partition will be backed up (and restoration is similar and will happen on a per-partition basis).</span></span> <span data-ttu-id="02dab-223">Per eseguire il backup/ripristino, il proprietario del servizio deve creare un servizio Actor personalizzato che deriva da ActorService e quindi eseguire il backup/ripristino analogamente a quanto descritto nella sezione precedente per Reliable Services.</span><span class="sxs-lookup"><span data-stu-id="02dab-223">To perform backup/restore, the service owner should create a custom actor service class that derives from ActorService class and then do backup/restore similar to Reliable Services as described above in previous sections.</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo)
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="02dab-224">Quando si crea una classe di servizio Actor personalizzata, è necessario registrarla insieme all'attore.</span><span class="sxs-lookup"><span data-stu-id="02dab-224">When you create a custom actor service class, you need to register that as well when registering the actor.</span></span>

```csharp
ActorRuntime.RegisterActorAsync<MyActor>(
   (context, typeInfo) => new MyCustomActorService(context, typeInfo)).GetAwaiter().GetResult();
```

<span data-ttu-id="02dab-225">Il provider di stato predefinito per Reliable Actors è `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="02dab-225">The default state provider for Reliable Actors is `KvsActorStateProvider`.</span></span> <span data-ttu-id="02dab-226">Per impostazione predefinita, il backup incrementale non è abilitato per `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="02dab-226">Incremental backup is not enabled by default for `KvsActorStateProvider`.</span></span> <span data-ttu-id="02dab-227">È possibile abilitare il backup incrementale creando `KvsActorStateProvider` con l'impostazione appropriata nel relativo costruttore e quindi passandolo al costruttore ActorService come illustrato nel frammento di codice seguente:</span><span class="sxs-lookup"><span data-stu-id="02dab-227">You can enable incremental backup by creating `KvsActorStateProvider` with the appropriate setting in its constructor and then passing it to ActorService constructor as shown in following code snippet:</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo, null, null, new KvsActorStateProvider(true)) // Enable incremental backup
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="02dab-228">Dopo aver abilitato il backup incrementale, quest'ultimo può avere esito negativo con FabricMissingFullBackupException per uno dei motivi seguenti. Sarà pertanto necessario eseguire un backup completo prima di effettuarne di incrementali:</span><span class="sxs-lookup"><span data-stu-id="02dab-228">After incremental backup has been enabled, taking an incremental backup can fail with FabricMissingFullBackupException for one of following reasons and you will need to take a full backup before taking incremental backup(s):</span></span>

  - <span data-ttu-id="02dab-229">La replica non ha mai eseguito un backup completo dopo essere diventata primaria.</span><span class="sxs-lookup"><span data-stu-id="02dab-229">The replica has never taken a full backup since it became primary.</span></span>
  - <span data-ttu-id="02dab-230">Alcuni dei record di log sono stati troncati in seguito all'ultimo backup.</span><span class="sxs-lookup"><span data-stu-id="02dab-230">Some of the log records were truncated since last backup was taken.</span></span>

<span data-ttu-id="02dab-231">Quando è abilitato il backup incrementale, `KvsActorStateProvider` non usa il buffer circolare per gestire i propri record di log e lo tronca periodicamente.</span><span class="sxs-lookup"><span data-stu-id="02dab-231">When incremental backup is enabled, `KvsActorStateProvider` does not use circular buffer to manage its log records and periodically truncates it.</span></span> <span data-ttu-id="02dab-232">Se in 45 minuti non viene eseguito alcun backup da parte dell'utente, il sistema tronca automaticamente i record di log.</span><span class="sxs-lookup"><span data-stu-id="02dab-232">If no backup is taken by user for a period of 45 minutes, the system automatically truncates the log records.</span></span> <span data-ttu-id="02dab-233">Questo intervallo può essere configurato specificando `logTrunctationIntervalInMinutes` nel costruttore `KvsActorStateProvider`, in maniera simile a quando si abilita il backup incrementale.</span><span class="sxs-lookup"><span data-stu-id="02dab-233">This interval can be configured by specifying `logTrunctationIntervalInMinutes` in `KvsActorStateProvider` constructor (similar to when enabling incremental backup).</span></span> <span data-ttu-id="02dab-234">I record di log potrebbero essere troncati anche se la replica primaria deve creare un'altra replica inviando tutti i propri dati.</span><span class="sxs-lookup"><span data-stu-id="02dab-234">The log records may also get truncated if primary replica need to build another replica by sending all its data.</span></span>

<span data-ttu-id="02dab-235">Quando si esegue il ripristino da una catena di backup, in maniera simile a Reliable Services, BackupFolderPath deve contenere sottodirectory con una di queste contenente il backup completo e le altre contenenti i backup incrementali.</span><span class="sxs-lookup"><span data-stu-id="02dab-235">When doing restore from a backup chain, similar to Reliable Services, the BackupFolderPath should contain subdirectories with one subdirectory containing full backup and others subdirectories containing incremental backup(s).</span></span> <span data-ttu-id="02dab-236">Se la convalida della catena di backup non riesce, l'API di ripristino genererà FabricException con un messaggio di errore appropriato.</span><span class="sxs-lookup"><span data-stu-id="02dab-236">The restore API will throw FabricException with appropriate error message if the backup chain validation fails.</span></span> 

> [!NOTE]
> <span data-ttu-id="02dab-237">Al momento l'opzione RestorePolicy.Safe viene ignorata da `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="02dab-237">`KvsActorStateProvider` currently ignores the option RestorePolicy.Safe.</span></span> <span data-ttu-id="02dab-238">Il supporto per questa funzionalità è pianificato per una versione futura.</span><span class="sxs-lookup"><span data-stu-id="02dab-238">Support for this feature is planned in an upcoming release.</span></span>
> 

## <a name="testing-backup-and-restore"></a><span data-ttu-id="02dab-239">Test del backup e del ripristino</span><span class="sxs-lookup"><span data-stu-id="02dab-239">Testing Backup and Restore</span></span>
<span data-ttu-id="02dab-240">È importante assicurarsi che i dati critici vengano sottoposti a backup e che possano essere ripristinati.</span><span class="sxs-lookup"><span data-stu-id="02dab-240">It is important to ensure that critical data is being backed up, and can be restored from.</span></span> <span data-ttu-id="02dab-241">Per farlo, chiamare il cmdlet `Start-ServiceFabricPartitionDataLoss` in PowerShell che può indurre la perdita di dati in una determinata partizione per verificare se la funzionalità di backup e ripristino dei dati per il servizio funziona nel modo previsto.</span><span class="sxs-lookup"><span data-stu-id="02dab-241">This can be done by invoking the `Start-ServiceFabricPartitionDataLoss` cmdlet in PowerShell that can induce data loss in a particular partition to test whether the data backup and restore functionality for your service is working as expected.</span></span>  <span data-ttu-id="02dab-242">Si può anche richiamare la perdita e il ripristino dei dati a livello di codice da tale evento.</span><span class="sxs-lookup"><span data-stu-id="02dab-242">It is also possible to programmatically invoke data loss and restore from that event as well.</span></span>

> [!NOTE]
> <span data-ttu-id="02dab-243">Nell'app di riferimento Web su GitHub è disponibile un esempio di implementazione della funzionalità di backup e ripristino.</span><span class="sxs-lookup"><span data-stu-id="02dab-243">You can find a sample implementation of backup and restore functionality in the Web Reference App on GitHub.</span></span> <span data-ttu-id="02dab-244">Per informazioni più dettagliate, vedere il servizio `Inventory.Service`.</span><span class="sxs-lookup"><span data-stu-id="02dab-244">Please look at the `Inventory.Service` service for more details.</span></span>
> 
> 

## <a name="under-the-hood-more-details-on-backup-and-restore"></a><span data-ttu-id="02dab-245">Approfondimento: altri dettagli sul backup e ripristino</span><span class="sxs-lookup"><span data-stu-id="02dab-245">Under the hood: more details on backup and restore</span></span>
<span data-ttu-id="02dab-246">Ecco altri dettagli sul backup e ripristino.</span><span class="sxs-lookup"><span data-stu-id="02dab-246">Here's some more details on backup and restore.</span></span>

### <a name="backup"></a><span data-ttu-id="02dab-247">Backup</span><span class="sxs-lookup"><span data-stu-id="02dab-247">Backup</span></span>
<span data-ttu-id="02dab-248">Reliable State Manager consente di creare backup coerenti senza bloccare alcuna operazione di lettura o scrittura.</span><span class="sxs-lookup"><span data-stu-id="02dab-248">The Reliable State Manager provides the ability to create consistent backups without blocking any read or write operations.</span></span> <span data-ttu-id="02dab-249">A questo scopo, utilizza un checkpoint e un meccanismo di persistenza dei log.</span><span class="sxs-lookup"><span data-stu-id="02dab-249">To do so, it utilizes a checkpoint and log persistence mechanism.</span></span>  <span data-ttu-id="02dab-250">Reliable State Manager accetta checkpoint fuzzy (semplici) in determinati punti per ridurre la pressione sul log transazionale e migliorare i tempi di ripristino.</span><span class="sxs-lookup"><span data-stu-id="02dab-250">The Reliable State Manager takes fuzzy (lightweight) checkpoints at certain points to relieve pressure from the transactional log and improve recovery times.</span></span>  <span data-ttu-id="02dab-251">Quando si chiama `BackupAsync`, Reliable State Manager indica a tutti gli oggetti Reliable di copiare i file di checkpoint più recenti in una cartella di backup locale.</span><span class="sxs-lookup"><span data-stu-id="02dab-251">When `BackupAsync` is called, the Reliable State Manager instructs all Reliable objects to copy their latest checkpoint files to a local backup folder.</span></span>  <span data-ttu-id="02dab-252">Reliable State Manager copia quindi tutti i record del log a partire dal "puntatore iniziale" fino all'ultimo record del log nella cartella di backup.</span><span class="sxs-lookup"><span data-stu-id="02dab-252">Then, the Reliable State Manager copies all log records, starting from the "start pointer" to the latest log record into the backup folder.</span></span>  <span data-ttu-id="02dab-253">Nel backup sono inclusi tutti i record di log fino all'ultimo e Reliable State Manager conserva i log write-ahead, di conseguenza Reliable State Manager assicura che nel backup siano incluse tutte le transazioni di cui viene eseguito il commit, ovvero di cui viene restituito correttamente `CommitAsync`.</span><span class="sxs-lookup"><span data-stu-id="02dab-253">Since all the log records up to the latest log record are included in the backup and the Reliable State Manager preserves write-ahead logging, the Reliable State Manager guarantees that all transactions that are committed (`CommitAsync` has returned successfully) are included in the backup.</span></span>

<span data-ttu-id="02dab-254">Eventuali transazioni di cui viene eseguito il commit dopo la chiamata di `BackupAsync` potrebbero essere incluse o meno nel backup.</span><span class="sxs-lookup"><span data-stu-id="02dab-254">Any transaction that commits after `BackupAsync` has been called may or may not be in the backup.</span></span>  <span data-ttu-id="02dab-255">Dopo il popolamento della cartella di backup locale da parte della piattaforma, ovvero dopo un backup locale completato dal runtime, verrà richiamato il callback del backup del servizio.</span><span class="sxs-lookup"><span data-stu-id="02dab-255">Once the local backup folder has been populated by the platform (i.e., local backup is completed by the runtime), the service's backup callback is invoked.</span></span>  <span data-ttu-id="02dab-256">Il callback è responsabile dello spostamento della cartella di backup in una posizione esterna, ad esempio nell'Archiviazione di Azure.</span><span class="sxs-lookup"><span data-stu-id="02dab-256">This callback is responsible for moving the backup folder to an external location such as Azure Storage.</span></span>

### <a name="restore"></a><span data-ttu-id="02dab-257">Ripristino</span><span class="sxs-lookup"><span data-stu-id="02dab-257">Restore</span></span>
<span data-ttu-id="02dab-258">Reliable State Manager consente di eseguire il ripristino da un backup con l'API `RestoreAsync`.</span><span class="sxs-lookup"><span data-stu-id="02dab-258">The Reliable State Manager provides the ability to restore from a backup by using the `RestoreAsync` API.</span></span>  
<span data-ttu-id="02dab-259">È possibile chiamare il metodo `RestoreAsync` su `RestoreContext` solo all'interno del metodo `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="02dab-259">The `RestoreAsync` method on `RestoreContext` can be called only inside the `OnDataLossAsync` method.</span></span>
<span data-ttu-id="02dab-260">Il valore booleano restituito da `OnDataLossAsync` indica se il servizio ha ripristinato il rispettivo stato da un'origine esterna.</span><span class="sxs-lookup"><span data-stu-id="02dab-260">The bool returned by `OnDataLossAsync` indicates whether the service restored its state from an external source.</span></span>
<span data-ttu-id="02dab-261">Se `OnDataLossAsync` restituisce true, Service Fabric ricompila tutte le altre repliche sulla base di questa replica primaria.</span><span class="sxs-lookup"><span data-stu-id="02dab-261">If the `OnDataLossAsync` returns true, Service Fabric will rebuild all other replicas from this primary.</span></span> <span data-ttu-id="02dab-262">Service Fabric fa in modo che le repliche che ricevono la chiamata `OnDataLossAsync` eseguano prima la transizione al ruolo primario, senza che venga concesso lo stato di lettura o scrittura.</span><span class="sxs-lookup"><span data-stu-id="02dab-262">Service Fabric ensures that replicas that will receive `OnDataLossAsync` call first transition to the primary role but are not granted read status or write status.</span></span>
<span data-ttu-id="02dab-263">Per i responsabili dell'implementazione di StatefulService significa che `RunAsync` viene chiamato solo dopo il completamento corretto di `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="02dab-263">This implies that for StatefulService implementers, `RunAsync` will not be called until `OnDataLossAsync` finishes successfully.</span></span>
<span data-ttu-id="02dab-264">`OnDataLossAsync` viene quindi chiamato nella nuova replica primaria.</span><span class="sxs-lookup"><span data-stu-id="02dab-264">Then, `OnDataLossAsync` will be invoked on the new primary.</span></span>
<span data-ttu-id="02dab-265">Fino a quando un servizio non completa correttamente l'API, restituendo true o false, e non viene completata la relativa riconfigurazione, l'API continuerà a essere chiamata singolarmente.</span><span class="sxs-lookup"><span data-stu-id="02dab-265">Until a service completes this API successfully (by returning true or false) and finishes the relevant reconfiguration, the API will keep being called one at a time.</span></span>

<span data-ttu-id="02dab-266">`RestoreAsync` rilascia prima di tutto ogni stato esistente nella replica primaria in cui è stato chiamato.</span><span class="sxs-lookup"><span data-stu-id="02dab-266">`RestoreAsync` first drops all existing state in the primary replica that it was called on.</span></span>  
<span data-ttu-id="02dab-267">Reliable State Manager crea quindi tutti gli oggetti Reliable esistenti nella cartella di backup.</span><span class="sxs-lookup"><span data-stu-id="02dab-267">Then the Reliable State Manager creates all the Reliable objects that exist in the backup folder.</span></span>  
<span data-ttu-id="02dab-268">Viene quindi indicato agli oggetti Reliable di eseguire il ripristino dai rispettivi checkpoint nella cartella di backup.</span><span class="sxs-lookup"><span data-stu-id="02dab-268">Next, the Reliable objects are instructed to restore from their checkpoints in the backup folder.</span></span>  
<span data-ttu-id="02dab-269">Reliable State Manager ripristina infine il proprio stato dai record dei log nella cartella di backup ed esegue il ripristino.</span><span class="sxs-lookup"><span data-stu-id="02dab-269">Finally, the Reliable State Manager recovers its own state from the log records in the backup folder and performs recovery.</span></span>  
<span data-ttu-id="02dab-270">Come parte del processo di ripristino, le operazioni a partire dal "punto iniziale" con record di log di commit nella cartella di backup vengono riprodotte negli oggetti Reliable.</span><span class="sxs-lookup"><span data-stu-id="02dab-270">As part of the recovery process, operations starting from the "starting point" that have commit log records in the backup folder are replayed to the Reliable objects.</span></span>  
<span data-ttu-id="02dab-271">Questo passaggio assicura che lo stato ripristinato sia coerente.</span><span class="sxs-lookup"><span data-stu-id="02dab-271">This step ensures that the recovered state is consistent.</span></span>

## <a name="next-steps"></a><span data-ttu-id="02dab-272">Passaggi successivi</span><span class="sxs-lookup"><span data-stu-id="02dab-272">Next steps</span></span>
  - [<span data-ttu-id="02dab-273">Reliable Collections</span><span class="sxs-lookup"><span data-stu-id="02dab-273">Reliable Collections</span></span>](service-fabric-work-with-reliable-collections.md)
  - [<span data-ttu-id="02dab-274">Guida introduttiva a Reliable Services di Microsoft Azure Service Fabric</span><span class="sxs-lookup"><span data-stu-id="02dab-274">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
  - [<span data-ttu-id="02dab-275">Notifiche di Reliable Services</span><span class="sxs-lookup"><span data-stu-id="02dab-275">Reliable Services notifications</span></span>](service-fabric-reliable-services-notifications.md)
  - [<span data-ttu-id="02dab-276">Configurazione di Reliable Services</span><span class="sxs-lookup"><span data-stu-id="02dab-276">Reliable Services configuration</span></span>](service-fabric-reliable-services-configuration.md)
  - [<span data-ttu-id="02dab-277">Guida di riferimento per gli sviluppatori per Reliable Collections</span><span class="sxs-lookup"><span data-stu-id="02dab-277">Developer reference for Reliable Collections</span></span>](https://msdn.microsoft.com/library/azure/microsoft.servicefabric.data.collections.aspx)

