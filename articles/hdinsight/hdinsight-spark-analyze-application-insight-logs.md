---
title: Analizzare i log di Application Insights con Spark in Azure HDInsight | Microsoft Docs
description: Informazioni su come esportare i log di Application Insight nell'archiviazione BLOB e analizzare i log con Spark in HDInsight.
services: hdinsight
documentationcenter: 
author: Blackmist
manager: jhubbard
editor: cgronlun
ms.assetid: 883beae6-9839-45b5-94f7-7eb0f4534ad5
ms.service: hdinsight
ms.custom: hdinsightactive
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: big-data
ms.date: 08/15/2017
ms.author: larryfr
ms.openlocfilehash: d98e403683618ef6115372f99e4949af87af4490
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/18/2017
---
# <a name="analyze-application-insights-telemetry-logs-with-spark-on-hdinsight"></a><span data-ttu-id="52559-103">Analizzare i log di Application Insights Telemetry con Spark in HDInsight</span><span class="sxs-lookup"><span data-stu-id="52559-103">Analyze Application Insights telemetry logs with Spark on HDInsight</span></span>

<span data-ttu-id="52559-104">Informazioni su come usare Spark in HDInsight per analizzare i dati di telemetria di Application Insights.</span><span class="sxs-lookup"><span data-stu-id="52559-104">Learn how to use Spark on HDInsight to analyze Application Insight telemetry data.</span></span>

<span data-ttu-id="52559-105">[Visual Studio Application Insights](../application-insights/app-insights-overview.md) è un servizio di analisi dei dati che consente di monitorare le applicazioni Web.</span><span class="sxs-lookup"><span data-stu-id="52559-105">[Visual Studio Application Insights](../application-insights/app-insights-overview.md) is an analytics service that monitors your web applications.</span></span> <span data-ttu-id="52559-106">I dati di telemetria generati da Application Insights possono essere esportati in Archiviazione di Azure.</span><span class="sxs-lookup"><span data-stu-id="52559-106">Telemetry data generated by Application Insights can be exported to Azure Storage.</span></span> <span data-ttu-id="52559-107">Una volta che i dati si trovano in Archiviazione di Azure, è possibile usare HDInsight per analizzarli.</span><span class="sxs-lookup"><span data-stu-id="52559-107">Once the data is in Azure Storage, HDInsight can be used to analyze it.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="52559-108">Prerequisiti</span><span class="sxs-lookup"><span data-stu-id="52559-108">Prerequisites</span></span>

* <span data-ttu-id="52559-109">Un'applicazione configurata per l'uso di Application Insights.</span><span class="sxs-lookup"><span data-stu-id="52559-109">An application that is configured to use Application Insights.</span></span>

* <span data-ttu-id="52559-110">Familiarità con la creazione di un cluster HDInsight basato su Linux.</span><span class="sxs-lookup"><span data-stu-id="52559-110">Familiarity with creating a Linux-based HDInsight cluster.</span></span> <span data-ttu-id="52559-111">Per altre informazioni, vedere [Introduzione: Creare un cluster Apache Spark in Azure HDInsight ed eseguire query interattive usando Spark SQL](hdinsight-apache-spark-jupyter-spark-sql.md).</span><span class="sxs-lookup"><span data-stu-id="52559-111">For more information, see [Create Spark on HDInsight](hdinsight-apache-spark-jupyter-spark-sql.md).</span></span>

  > [!IMPORTANT]
  > <span data-ttu-id="52559-112">I passaggi descritti in questo documento richiedono un cluster HDInsight che usa Linux.</span><span class="sxs-lookup"><span data-stu-id="52559-112">The steps in this document require an HDInsight cluster that uses Linux.</span></span> <span data-ttu-id="52559-113">Linux è l'unico sistema operativo usato in HDInsight versione 3.4 o successiva.</span><span class="sxs-lookup"><span data-stu-id="52559-113">Linux is the only operating system used on HDInsight version 3.4 or greater.</span></span> <span data-ttu-id="52559-114">Per altre informazioni, vedere la sezione relativa al [ritiro di HDInsight in Windows](hdinsight-component-versioning.md#hdinsight-windows-retirement).</span><span class="sxs-lookup"><span data-stu-id="52559-114">For more information, see [HDInsight retirement on Windows](hdinsight-component-versioning.md#hdinsight-windows-retirement).</span></span>

* <span data-ttu-id="52559-115">Un Web browser.</span><span class="sxs-lookup"><span data-stu-id="52559-115">A web browser.</span></span>

<span data-ttu-id="52559-116">Per lo sviluppo e il test di questo documento, sono state usate le risorse seguenti:</span><span class="sxs-lookup"><span data-stu-id="52559-116">The following resources were used in developing and testing this document:</span></span>

* <span data-ttu-id="52559-117">I dati di Application Insights Telemetry sono stati generati tramite un' [app Web Node.js configurata per l'uso di Application Insights](../application-insights/app-insights-nodejs.md).</span><span class="sxs-lookup"><span data-stu-id="52559-117">Application Insights telemetry data was generated using a [Node.js web app configured to use Application Insights](../application-insights/app-insights-nodejs.md).</span></span>

* <span data-ttu-id="52559-118">Per analizzare i dati, è stato usato uno Spark basato su Linux nel cluster HDInsight versione 3.5.</span><span class="sxs-lookup"><span data-stu-id="52559-118">A Linux-based Spark on HDInsight cluster version 3.5 was used to analyze the data.</span></span>

## <a name="architecture-and-planning"></a><span data-ttu-id="52559-119">Architettura e pianificazione</span><span class="sxs-lookup"><span data-stu-id="52559-119">Architecture and planning</span></span>

<span data-ttu-id="52559-120">Il diagramma seguente illustra l'architettura del servizio dell'esempio:</span><span class="sxs-lookup"><span data-stu-id="52559-120">The following diagram illustrates the service architecture of this example:</span></span>

![diagramma che illustra un flusso di dati da Application Insights nell'archiviazione BLOB e la fase di elaborazione Spark in HDInsight](./media/hdinsight-spark-analyze-application-insight-logs/appinsightshdinsight.png)

### <a name="azure-storage"></a><span data-ttu-id="52559-122">Archiviazione di Azure</span><span class="sxs-lookup"><span data-stu-id="52559-122">Azure storage</span></span>

<span data-ttu-id="52559-123">Application Insights può essere configurato per l'esportazione continua delle informazioni di telemetria nei BLOB.</span><span class="sxs-lookup"><span data-stu-id="52559-123">Application Insights can be configured to continuously export telemetry information to blobs.</span></span> <span data-ttu-id="52559-124">HDInsight sarà quindi in grado di leggere i dati archiviati nei BLOB.</span><span class="sxs-lookup"><span data-stu-id="52559-124">HDInsight can then read data stored in the blobs.</span></span> <span data-ttu-id="52559-125">Tuttavia, esistono alcuni requisiti da seguire:</span><span class="sxs-lookup"><span data-stu-id="52559-125">However, there are some requirements that you must follow:</span></span>

* <span data-ttu-id="52559-126">**Posizione**: se l'account di archiviazione e HDInsight si trovano in posizioni diverse, la latenza potrebbe aumentare.</span><span class="sxs-lookup"><span data-stu-id="52559-126">**Location**: If the Storage Account and HDInsight are in different locations, it may increase latency.</span></span> <span data-ttu-id="52559-127">Ciò comporta anche un aumento dei costi dal momento che vengono applicati costi di uscita per lo spostamento di dati tra le aree.</span><span class="sxs-lookup"><span data-stu-id="52559-127">It also increases cost, as egress charges are applied to data moving between regions.</span></span>

    > [!WARNING]
    > <span data-ttu-id="52559-128">L'uso di un account di archiviazione in una località diversa rispetto a HDInsight non è supportato.</span><span class="sxs-lookup"><span data-stu-id="52559-128">Using a Storage Account in a different location than HDInsight is not supported.</span></span>

* <span data-ttu-id="52559-129">**Tipo di BLOB**: in HDInsight sono supportati solo BLOB in blocchi.</span><span class="sxs-lookup"><span data-stu-id="52559-129">**Blob type**: HDInsight only supports block blobs.</span></span> <span data-ttu-id="52559-130">Application Insights usa per impostazione predefinita i BLOB in blocchi, quindi funzionerà con HDInsight.</span><span class="sxs-lookup"><span data-stu-id="52559-130">Application Insights defaults to using block blobs, so should work by default with HDInsight.</span></span>

<span data-ttu-id="52559-131">Per informazioni sull'aggiunta di altro spazio di archiviazione a un cluster HDInsight esistente, vedere il documento [Aggiungere altri account di archiviazione](hdinsight-hadoop-add-storage.md).</span><span class="sxs-lookup"><span data-stu-id="52559-131">For information on adding additional storage to an existing HDInsight cluster, see the [Add additional storage accounts](hdinsight-hadoop-add-storage.md) document.</span></span>

### <a name="data-schema"></a><span data-ttu-id="52559-132">Schema dei dati</span><span class="sxs-lookup"><span data-stu-id="52559-132">Data schema</span></span>

<span data-ttu-id="52559-133">Application Insights offre informazione sul [modello di esportazione dei dati](../application-insights/app-insights-export-data-model.md) per il formato di dati di telemetria esportati nei BLOB.</span><span class="sxs-lookup"><span data-stu-id="52559-133">Application Insights provides [export data model](../application-insights/app-insights-export-data-model.md) information for the telemetry data format exported to blobs.</span></span> <span data-ttu-id="52559-134">La procedura descritta in questo documento usa Spark SQL per lavorare con i dati.</span><span class="sxs-lookup"><span data-stu-id="52559-134">The steps in this document use Spark SQL to work with the data.</span></span> <span data-ttu-id="52559-135">Spark SQL può generare automaticamente uno schema per la struttura di dati JSON registrato da Application Insights.</span><span class="sxs-lookup"><span data-stu-id="52559-135">Spark SQL can automatically generate a schema for the JSON data structure logged by Application Insights.</span></span>

## <a name="export-telemetry-data"></a><span data-ttu-id="52559-136">Esportare i dati di telemetria</span><span class="sxs-lookup"><span data-stu-id="52559-136">Export telemetry data</span></span>

<span data-ttu-id="52559-137">Seguire la procedura in [Configure Continuous Export](../application-insights/app-insights-export-telemetry.md) (Configurare l'esportazione continua) per configurare Application Insights per l'esportazione delle informazioni di telemetria in un BLOB di archiviazione di Azure.</span><span class="sxs-lookup"><span data-stu-id="52559-137">Follow the steps in [Configure Continuous Export](../application-insights/app-insights-export-telemetry.md) to configure your Application Insights to export telemetry information to an Azure storage blob.</span></span>

## <a name="configure-hdinsight-to-access-the-data"></a><span data-ttu-id="52559-138">Configurare HDInsight per l'accesso ai dati</span><span class="sxs-lookup"><span data-stu-id="52559-138">Configure HDInsight to access the data</span></span>

<span data-ttu-id="52559-139">Se si sta creando un cluster HDInsight, aggiungere l'account di archiviazione durante la creazione del cluster.</span><span class="sxs-lookup"><span data-stu-id="52559-139">If you are creating an HDInsight cluster, add the storage account during cluster creation.</span></span>

<span data-ttu-id="52559-140">Per aggiungere l'account di Archiviazione di Azure a un cluster esistente, usare le informazioni riportate nel documento [Aggiungere altri account di archiviazione](hdinsight-hadoop-add-storage.md).</span><span class="sxs-lookup"><span data-stu-id="52559-140">To add the Azure Storage Account to an existing cluster, use the information in the [Add additional Storage Accounts](hdinsight-hadoop-add-storage.md) document.</span></span>

## <a name="analyze-the-data-pyspark"></a><span data-ttu-id="52559-141">Analizzare i dati: PySpark</span><span class="sxs-lookup"><span data-stu-id="52559-141">Analyze the data: PySpark</span></span>

1. <span data-ttu-id="52559-142">Nel [Portale di Azure](https://portal.azure.com)selezionare il proprio Spark sul cluster HDInsight.</span><span class="sxs-lookup"><span data-stu-id="52559-142">From the [Azure portal](https://portal.azure.com), select your Spark on HDInsight cluster.</span></span> <span data-ttu-id="52559-143">Nella sezione **Collegamenti rapidi** selezionare **Dashboard cluster** e quindi selezionare **Notebook di Jupyter** nel pannello Dashboard cluster.</span><span class="sxs-lookup"><span data-stu-id="52559-143">From the **Quick Links** section, select **Cluster Dashboards**, and then select **Jupyter Notebook** from the Cluster Dashboard__ blade.</span></span>

    ![Il dashboard del cluster](./media/hdinsight-spark-analyze-application-insight-logs/clusterdashboards.png)

2. <span data-ttu-id="52559-145">Nell'angolo superiore destro della pagina Jupyter selezionare **Nuovo** e quindi **PySpark**.</span><span class="sxs-lookup"><span data-stu-id="52559-145">In the upper right corner of the Jupyter page, select **New**, and then **PySpark**.</span></span> <span data-ttu-id="52559-146">Si apre una nuova scheda del browser contenente un notebook di Jupyter basato su Python.</span><span class="sxs-lookup"><span data-stu-id="52559-146">A new browser tab containing a Python-based Jupyter Notebook opens.</span></span>

3. <span data-ttu-id="52559-147">Nel primo campo della pagina (denominato **cella**) immettere il testo seguente:</span><span class="sxs-lookup"><span data-stu-id="52559-147">In the first field (called a **cell**) on the page, enter the following text:</span></span>

   ```python
   sc._jsc.hadoopConfiguration().set('mapreduce.input.fileinputformat.input.dir.recursive', 'true')
   ```

    <span data-ttu-id="52559-148">Questo codice configura Spark per l'accesso continuo alla struttura della directory per i dati di input.</span><span class="sxs-lookup"><span data-stu-id="52559-148">This code configures Spark to recursively access the directory structure for the input data.</span></span> <span data-ttu-id="52559-149">Application Insights Telemetry è connesso a una struttura di directory simile alla seguente: `/{telemetry type}/YYYY-MM-DD/{##}/`.</span><span class="sxs-lookup"><span data-stu-id="52559-149">Application Insights telemetry is logged to a directory structure similar to the `/{telemetry type}/YYYY-MM-DD/{##}/`.</span></span>

4. <span data-ttu-id="52559-150">Premere **MAIUSC+INVIO** per eseguire il codice.</span><span class="sxs-lookup"><span data-stu-id="52559-150">Use **SHIFT+ENTER** to run the code.</span></span> <span data-ttu-id="52559-151">Sul lato sinistro della cella viene visualizzato \* tra parentesi per indicare che il codice contenuto nella cella è in esecuzione.</span><span class="sxs-lookup"><span data-stu-id="52559-151">On the left side of the cell, an '\*' appears between the brackets to indicate that the code in this cell is being executed.</span></span> <span data-ttu-id="52559-152">Al termine, \* viene sostituito da un numero e sotto la cella viene visualizzato un output simile al testo seguente:</span><span class="sxs-lookup"><span data-stu-id="52559-152">Once it completes, the '\*' changes to a number, and output similar to the following text is displayed below the cell:</span></span>

        Creating SparkContext as 'sc'

        ID    YARN Application ID    Kind    State    Spark UI    Driver log    Current session?
        3    application_1468969497124_0001    pyspark    idle    Link    Link    ✔

        Creating HiveContext as 'sqlContext'
        SparkContext and HiveContext created. Executing user code ...
5. <span data-ttu-id="52559-153">Una nuova cella viene creata sotto la prima.</span><span class="sxs-lookup"><span data-stu-id="52559-153">A new cell is created below the first one.</span></span> <span data-ttu-id="52559-154">Immettere il testo seguente nella nuova cella.</span><span class="sxs-lookup"><span data-stu-id="52559-154">Enter the following text in the new cell.</span></span> <span data-ttu-id="52559-155">Sostituire `CONTAINER` e `STORAGEACCOUNT` con il nome dell'account di Archiviazione di Azure e il nome del contenitore BLOB che contiene dati di Application Insights.</span><span class="sxs-lookup"><span data-stu-id="52559-155">Replace `CONTAINER` and `STORAGEACCOUNT` with the Azure storage account name and blob container name that contains Application Insights data.</span></span>

   ```python
   %%bash
   hdfs dfs -ls wasb://CONTAINER@STORAGEACCOUNT.blob.core.windows.net/
   ```

    <span data-ttu-id="52559-156">Premere **MAIUSC+INVIO** per eseguire la cella.</span><span class="sxs-lookup"><span data-stu-id="52559-156">Use **SHIFT+ENTER** to execute this cell.</span></span> <span data-ttu-id="52559-157">Il risultato visualizzato è simile al testo seguente:</span><span class="sxs-lookup"><span data-stu-id="52559-157">You see a result similar to the following text:</span></span>

        Found 1 items
        drwxrwxrwx   -          0 1970-01-01 00:00 wasb://appinsights@contosostore.blob.core.windows.net/contosoappinsights_2bededa61bc741fbdee6b556571a4831

    <span data-ttu-id="52559-158">Il percorso wasb restituito è il percorso dei dati di Application Insights Telemetry.</span><span class="sxs-lookup"><span data-stu-id="52559-158">The wasb path returned is the location of the Application Insights telemetry data.</span></span> <span data-ttu-id="52559-159">Modificare la riga `hdfs dfs -ls` nella cella per usare il percorso wasb restituito e quindi premere **MAIUSC+INVIO** per eseguire di nuovo la cella.</span><span class="sxs-lookup"><span data-stu-id="52559-159">Change the `hdfs dfs -ls` line in the cell to use the wasb path returned, and then use **SHIFT+ENTER** to run the cell again.</span></span> <span data-ttu-id="52559-160">Questa volta, il risultato dovrebbe visualizzare le directory che contengono i dati di telemetria.</span><span class="sxs-lookup"><span data-stu-id="52559-160">This time, the results should display the directories that contain telemetry data.</span></span>

   > [!NOTE]
   > <span data-ttu-id="52559-161">Per il resto dei passaggi in questa sezione è stata usata la directory `wasb://appinsights@contosostore.blob.core.windows.net/contosoappinsights_{ID}/Requests`.</span><span class="sxs-lookup"><span data-stu-id="52559-161">For the remainder of the steps in this section, the `wasb://appinsights@contosostore.blob.core.windows.net/contosoappinsights_{ID}/Requests` directory was used.</span></span> <span data-ttu-id="52559-162">La struttura della directory potrebbe essere diversa.</span><span class="sxs-lookup"><span data-stu-id="52559-162">Your directory structure may be different.</span></span>

6. <span data-ttu-id="52559-163">Nella cella successiva immettere il codice seguente: sostituire `WASB_PATH` con il percorso del passaggio precedente.</span><span class="sxs-lookup"><span data-stu-id="52559-163">In the next cell, enter the following code: Replace `WASB_PATH` with the path from the previous step.</span></span>

   ```python
   jsonFiles = sc.textFile('WASB_PATH')
   jsonData = sqlContext.read.json(jsonFiles)
   ```

    <span data-ttu-id="52559-164">Questo codice crea un frame di dati dai file JSON esportati dal processo di esportazione continua.</span><span class="sxs-lookup"><span data-stu-id="52559-164">This code creates a dataframe from the JSON files exported by the continuous export process.</span></span> <span data-ttu-id="52559-165">Premere **MAIUSC+INVIO** per eseguire la cella.</span><span class="sxs-lookup"><span data-stu-id="52559-165">Use **SHIFT+ENTER** to run this cell.</span></span>
7. <span data-ttu-id="52559-166">Nella prossima cella, immettere ed eseguire il comando seguente per visualizzare lo schema Spark creato per i file JSON:</span><span class="sxs-lookup"><span data-stu-id="52559-166">In the next cell, enter and run the following to view the schema that Spark created for the JSON files:</span></span>

   ```python
   jsonData.printSchema()
   ```

    <span data-ttu-id="52559-167">Lo schema per ogni tipo di dati di telemetria è diverso.</span><span class="sxs-lookup"><span data-stu-id="52559-167">The schema for each type of telemetry is different.</span></span> <span data-ttu-id="52559-168">Di seguito è riportato lo schema di esempio generato per le richieste Web (dati archiviati nella sottodirectory `Requests`):</span><span class="sxs-lookup"><span data-stu-id="52559-168">The following example is the schema that is generated for web requests (data stored in the `Requests` subdirectory):</span></span>

        root
        |-- context: struct (nullable = true)
        |    |-- application: struct (nullable = true)
        |    |    |-- version: string (nullable = true)
        |    |-- custom: struct (nullable = true)
        |    |    |-- dimensions: array (nullable = true)
        |    |    |    |-- element: string (containsNull = true)
        |    |    |-- metrics: array (nullable = true)
        |    |    |    |-- element: string (containsNull = true)
        |    |-- data: struct (nullable = true)
        |    |    |-- eventTime: string (nullable = true)
        |    |    |-- isSynthetic: boolean (nullable = true)
        |    |    |-- samplingRate: double (nullable = true)
        |    |    |-- syntheticSource: string (nullable = true)
        |    |-- device: struct (nullable = true)
        |    |    |-- browser: string (nullable = true)
        |    |    |-- browserVersion: string (nullable = true)
        |    |    |-- deviceModel: string (nullable = true)
        |    |    |-- deviceName: string (nullable = true)
        |    |    |-- id: string (nullable = true)
        |    |    |-- osVersion: string (nullable = true)
        |    |    |-- type: string (nullable = true)
        |    |-- location: struct (nullable = true)
        |    |    |-- city: string (nullable = true)
        |    |    |-- clientip: string (nullable = true)
        |    |    |-- continent: string (nullable = true)
        |    |    |-- country: string (nullable = true)
        |    |    |-- province: string (nullable = true)
        |    |-- operation: struct (nullable = true)
        |    |    |-- name: string (nullable = true)
        |    |-- session: struct (nullable = true)
        |    |    |-- id: string (nullable = true)
        |    |    |-- isFirst: boolean (nullable = true)
        |    |-- user: struct (nullable = true)
        |    |    |-- anonId: string (nullable = true)
        |    |    |-- isAuthenticated: boolean (nullable = true)
        |-- internal: struct (nullable = true)
        |    |-- data: struct (nullable = true)
        |    |    |-- documentVersion: string (nullable = true)
        |    |    |-- id: string (nullable = true)
        |-- request: array (nullable = true)
        |    |-- element: struct (containsNull = true)
        |    |    |-- count: long (nullable = true)
        |    |    |-- durationMetric: struct (nullable = true)
        |    |    |    |-- count: double (nullable = true)
        |    |    |    |-- max: double (nullable = true)
        |    |    |    |-- min: double (nullable = true)
        |    |    |    |-- sampledValue: double (nullable = true)
        |    |    |    |-- stdDev: double (nullable = true)
        |    |    |    |-- value: double (nullable = true)
        |    |    |-- id: string (nullable = true)
        |    |    |-- name: string (nullable = true)
        |    |    |-- responseCode: long (nullable = true)
        |    |    |-- success: boolean (nullable = true)
        |    |    |-- url: string (nullable = true)
        |    |    |-- urlData: struct (nullable = true)
        |    |    |    |-- base: string (nullable = true)
        |    |    |    |-- hashTag: string (nullable = true)
        |    |    |    |-- host: string (nullable = true)
        |    |    |    |-- protocol: string (nullable = true)
8. <span data-ttu-id="52559-169">Per registrare il frame di dati come una tabella temporanea ed eseguire una query sui dati, usare quanto segue:</span><span class="sxs-lookup"><span data-stu-id="52559-169">Use the following to register the dataframe as a temporary table and run a query against the data:</span></span>

   ```python
   jsonData.registerTempTable("requests")
   df = sqlContext.sql("select context.location.city from requests where context.location.city is not null")
   df.show()
   ```

    <span data-ttu-id="52559-170">Questa query restituisce le informazioni sulla città per i primi 20 record in cui context.location.city non ha valore Null.</span><span class="sxs-lookup"><span data-stu-id="52559-170">This query returns the city information for the top 20 records where context.location.city is not null.</span></span>

   > [!NOTE]
   > <span data-ttu-id="52559-171">La struttura di contesto è presente in tutti i dati di telemetria registrati da Application Insights.</span><span class="sxs-lookup"><span data-stu-id="52559-171">The context structure is present in all telemetry logged by Application Insights.</span></span> <span data-ttu-id="52559-172">L'elemento città potrebbe non essere popolato nei log.</span><span class="sxs-lookup"><span data-stu-id="52559-172">The city element may not be populated in your logs.</span></span> <span data-ttu-id="52559-173">Usare lo schema per identificare altri elementi su cui è possibile eseguire una query che potrebbe contenere i dati per i log.</span><span class="sxs-lookup"><span data-stu-id="52559-173">Use the schema to identify other elements that you can query that may contain data for your logs.</span></span>

    <span data-ttu-id="52559-174">La query restituisce informazioni simili al testo seguente:</span><span class="sxs-lookup"><span data-stu-id="52559-174">This query returns information similar to the following text:</span></span>

        +---------+
        |     city|
        +---------+
        | Bellevue|
        |  Redmond|
        |  Seattle|
        |Charlotte|
        ...
        +---------+

## <a name="analyze-the-data-scala"></a><span data-ttu-id="52559-175">Analizzare i dati: Scala</span><span class="sxs-lookup"><span data-stu-id="52559-175">Analyze the data: Scala</span></span>

1. <span data-ttu-id="52559-176">Nel [Portale di Azure](https://portal.azure.com)selezionare il proprio Spark sul cluster HDInsight.</span><span class="sxs-lookup"><span data-stu-id="52559-176">From the [Azure portal](https://portal.azure.com), select your Spark on HDInsight cluster.</span></span> <span data-ttu-id="52559-177">Nella sezione **Collegamenti rapidi** selezionare **Dashboard cluster** e quindi selezionare **Notebook di Jupyter** nel pannello Dashboard cluster.</span><span class="sxs-lookup"><span data-stu-id="52559-177">From the **Quick Links** section, select **Cluster Dashboards**, and then select **Jupyter Notebook** from the Cluster Dashboard__ blade.</span></span>

    ![Il dashboard del cluster](./media/hdinsight-spark-analyze-application-insight-logs/clusterdashboards.png)
2. <span data-ttu-id="52559-179">Nell'angolo superiore destro della pagina Jupyter selezionare **Nuovo** e quindi **Scala**.</span><span class="sxs-lookup"><span data-stu-id="52559-179">In the upper right corner of the Jupyter page, select **New**, and then **Scala**.</span></span> <span data-ttu-id="52559-180">Si apre una nuova scheda del browser contenente un notebook di Jupyter basato su Scala.</span><span class="sxs-lookup"><span data-stu-id="52559-180">A new browser tab containing a Scala-based Jupyter Notebook appears.</span></span>
3. <span data-ttu-id="52559-181">Nel primo campo della pagina (denominato **cella**) immettere il testo seguente:</span><span class="sxs-lookup"><span data-stu-id="52559-181">In the first field (called a **cell**) on the page, enter the following text:</span></span>

   ```scala
   sc.hadoopConfiguration.set("mapreduce.input.fileinputformat.input.dir.recursive", "true")
   ```

    <span data-ttu-id="52559-182">Questo codice configura Spark per l'accesso continuo alla struttura della directory per i dati di input.</span><span class="sxs-lookup"><span data-stu-id="52559-182">This code configures Spark to recursively access the directory structure for the input data.</span></span> <span data-ttu-id="52559-183">Application Insights Telemetry è connesso a una struttura di directory simile alla seguente: `/{telemetry type}/YYYY-MM-DD/{##}/`.</span><span class="sxs-lookup"><span data-stu-id="52559-183">Application Insights telemetry is logged to a directory structure similar to `/{telemetry type}/YYYY-MM-DD/{##}/`.</span></span>

4. <span data-ttu-id="52559-184">Premere **MAIUSC+INVIO** per eseguire il codice.</span><span class="sxs-lookup"><span data-stu-id="52559-184">Use **SHIFT+ENTER** to run the code.</span></span> <span data-ttu-id="52559-185">Sul lato sinistro della cella viene visualizzato \* tra parentesi per indicare che il codice contenuto nella cella è in esecuzione.</span><span class="sxs-lookup"><span data-stu-id="52559-185">On the left side of the cell, an '\*' appears between the brackets to indicate that the code in this cell is being executed.</span></span> <span data-ttu-id="52559-186">Al termine, \* viene sostituito da un numero e sotto la cella viene visualizzato un output simile al testo seguente:</span><span class="sxs-lookup"><span data-stu-id="52559-186">Once it completes, the '\*' changes to a number, and output similar to the following text is displayed below the cell:</span></span>

        Creating SparkContext as 'sc'

        ID    YARN Application ID    Kind    State    Spark UI    Driver log    Current session?
        3    application_1468969497124_0001    spark    idle    Link    Link    ✔

        Creating HiveContext as 'sqlContext'
        SparkContext and HiveContext created. Executing user code ...
5. <span data-ttu-id="52559-187">Una nuova cella viene creata sotto la prima.</span><span class="sxs-lookup"><span data-stu-id="52559-187">A new cell is created below the first one.</span></span> <span data-ttu-id="52559-188">Immettere il testo seguente nella nuova cella.</span><span class="sxs-lookup"><span data-stu-id="52559-188">Enter the following text in the new cell.</span></span> <span data-ttu-id="52559-189">Sostituire `CONTAINER` e `STORAGEACCOUNT` con il nome dell'account di Archiviazione di Azure e il nome del contenitore BLOB che contiene i log di Application Insights.</span><span class="sxs-lookup"><span data-stu-id="52559-189">Replace `CONTAINER` and `STORAGEACCOUNT` with the Azure storage account name and blob container name that contains Application Insights logs.</span></span>

   ```scala
   %%bash
   hdfs dfs -ls wasb://CONTAINER@STORAGEACCOUNT.blob.core.windows.net/
   ```

    <span data-ttu-id="52559-190">Premere **MAIUSC+INVIO** per eseguire la cella.</span><span class="sxs-lookup"><span data-stu-id="52559-190">Use **SHIFT+ENTER** to execute this cell.</span></span> <span data-ttu-id="52559-191">Il risultato visualizzato è simile al testo seguente:</span><span class="sxs-lookup"><span data-stu-id="52559-191">You see a result similar to the following text:</span></span>

        Found 1 items
        drwxrwxrwx   -          0 1970-01-01 00:00 wasb://appinsights@contosostore.blob.core.windows.net/contosoappinsights_2bededa61bc741fbdee6b556571a4831

    <span data-ttu-id="52559-192">Il percorso wasb restituito è il percorso dei dati di Application Insights Telemetry.</span><span class="sxs-lookup"><span data-stu-id="52559-192">The wasb path returned is the location of the Application Insights telemetry data.</span></span> <span data-ttu-id="52559-193">Modificare la riga `hdfs dfs -ls` nella cella per usare il percorso wasb restituito e quindi premere **MAIUSC+INVIO** per eseguire di nuovo la cella.</span><span class="sxs-lookup"><span data-stu-id="52559-193">Change the `hdfs dfs -ls` line in the cell to use the wasb path returned, and then use **SHIFT+ENTER** to run the cell again.</span></span> <span data-ttu-id="52559-194">Questa volta, il risultato dovrebbe visualizzare le directory che contengono i dati di telemetria.</span><span class="sxs-lookup"><span data-stu-id="52559-194">This time, the results should display the directories that contain telemetry data.</span></span>

   > [!NOTE]
   > <span data-ttu-id="52559-195">Per il resto dei passaggi in questa sezione è stata usata la directory `wasb://appinsights@contosostore.blob.core.windows.net/contosoappinsights_{ID}/Requests`.</span><span class="sxs-lookup"><span data-stu-id="52559-195">For the remainder of the steps in this section, the `wasb://appinsights@contosostore.blob.core.windows.net/contosoappinsights_{ID}/Requests` directory was used.</span></span> <span data-ttu-id="52559-196">Questa directory potrebbe non esistere, a meno che i dati di telemetria non siano destinati a un'app Web.</span><span class="sxs-lookup"><span data-stu-id="52559-196">This directory may not exist unless your telemetry data is for a web app.</span></span>

6. <span data-ttu-id="52559-197">Nella cella successiva immettere il codice seguente: sostituire `WASB\_PATH` con il percorso del passaggio precedente.</span><span class="sxs-lookup"><span data-stu-id="52559-197">In the next cell, enter the following code: Replace `WASB\_PATH` with the path from the previous step.</span></span>

   ```scala
   var jsonFiles = sc.textFile('WASB_PATH')
   val sqlContext = new org.apache.spark.sql.SQLContext(sc)
   var jsonData = sqlContext.read.json(jsonFiles)
   ```

    <span data-ttu-id="52559-198">Questo codice crea un frame di dati dai file JSON esportati dal processo di esportazione continua.</span><span class="sxs-lookup"><span data-stu-id="52559-198">This code creates a dataframe from the JSON files exported by the continuous export process.</span></span> <span data-ttu-id="52559-199">Premere **MAIUSC+INVIO** per eseguire la cella.</span><span class="sxs-lookup"><span data-stu-id="52559-199">Use **SHIFT+ENTER** to run this cell.</span></span>

7. <span data-ttu-id="52559-200">Nella prossima cella, immettere ed eseguire il comando seguente per visualizzare lo schema Spark creato per i file JSON:</span><span class="sxs-lookup"><span data-stu-id="52559-200">In the next cell, enter and run the following to view the schema that Spark created for the JSON files:</span></span>

   ```scala
   jsonData.printSchema
   ```

    <span data-ttu-id="52559-201">Lo schema per ogni tipo di dati di telemetria è diverso.</span><span class="sxs-lookup"><span data-stu-id="52559-201">The schema for each type of telemetry is different.</span></span> <span data-ttu-id="52559-202">Di seguito è riportato lo schema di esempio generato per le richieste Web (dati archiviati nella sottodirectory `Requests`):</span><span class="sxs-lookup"><span data-stu-id="52559-202">The following example is the schema that is generated for web requests (data stored in the `Requests` subdirectory):</span></span>

        root
        |-- context: struct (nullable = true)
        |    |-- application: struct (nullable = true)
        |    |    |-- version: string (nullable = true)
        |    |-- custom: struct (nullable = true)
        |    |    |-- dimensions: array (nullable = true)
        |    |    |    |-- element: string (containsNull = true)
        |    |    |-- metrics: array (nullable = true)
        |    |    |    |-- element: string (containsNull = true)
        |    |-- data: struct (nullable = true)
        |    |    |-- eventTime: string (nullable = true)
        |    |    |-- isSynthetic: boolean (nullable = true)
        |    |    |-- samplingRate: double (nullable = true)
        |    |    |-- syntheticSource: string (nullable = true)
        |    |-- device: struct (nullable = true)
        |    |    |-- browser: string (nullable = true)
        |    |    |-- browserVersion: string (nullable = true)
        |    |    |-- deviceModel: string (nullable = true)
        |    |    |-- deviceName: string (nullable = true)
        |    |    |-- id: string (nullable = true)
        |    |    |-- osVersion: string (nullable = true)
        |    |    |-- type: string (nullable = true)
        |    |-- location: struct (nullable = true)
        |    |    |-- city: string (nullable = true)
        |    |    |-- clientip: string (nullable = true)
        |    |    |-- continent: string (nullable = true)
        |    |    |-- country: string (nullable = true)
        |    |    |-- province: string (nullable = true)
        |    |-- operation: struct (nullable = true)
        |    |    |-- name: string (nullable = true)
        |    |-- session: struct (nullable = true)
        |    |    |-- id: string (nullable = true)
        |    |    |-- isFirst: boolean (nullable = true)
        |    |-- user: struct (nullable = true)
        |    |    |-- anonId: string (nullable = true)
        |    |    |-- isAuthenticated: boolean (nullable = true)
        |-- internal: struct (nullable = true)
        |    |-- data: struct (nullable = true)
        |    |    |-- documentVersion: string (nullable = true)
        |    |    |-- id: string (nullable = true)
        |-- request: array (nullable = true)
        |    |-- element: struct (containsNull = true)
        |    |    |-- count: long (nullable = true)
        |    |    |-- durationMetric: struct (nullable = true)
        |    |    |    |-- count: double (nullable = true)
        |    |    |    |-- max: double (nullable = true)
        |    |    |    |-- min: double (nullable = true)
        |    |    |    |-- sampledValue: double (nullable = true)
        |    |    |    |-- stdDev: double (nullable = true)
        |    |    |    |-- value: double (nullable = true)
        |    |    |-- id: string (nullable = true)
        |    |    |-- name: string (nullable = true)
        |    |    |-- responseCode: long (nullable = true)
        |    |    |-- success: boolean (nullable = true)
        |    |    |-- url: string (nullable = true)
        |    |    |-- urlData: struct (nullable = true)
        |    |    |    |-- base: string (nullable = true)
        |    |    |    |-- hashTag: string (nullable = true)
        |    |    |    |-- host: string (nullable = true)
        |    |    |    |-- protocol: string (nullable = true)

8. <span data-ttu-id="52559-203">Per registrare il frame di dati come una tabella temporanea ed eseguire una query sui dati, usare quanto segue:</span><span class="sxs-lookup"><span data-stu-id="52559-203">Use the following to register the dataframe as a temporary table and run a query against the data:</span></span>

   ```scala
   jsonData.registerTempTable("requests")
   var city = sqlContext.sql("select context.location.city from requests where context.location.city is not null limit 10").show()
   ```

    <span data-ttu-id="52559-204">Questa query restituisce le informazioni sulla città per i primi 20 record in cui context.location.city non ha valore Null.</span><span class="sxs-lookup"><span data-stu-id="52559-204">This query returns the city information for the top 20 records where context.location.city is not null.</span></span>

   > [!NOTE]
   > <span data-ttu-id="52559-205">La struttura di contesto è presente in tutti i dati di telemetria registrati da Application Insights.</span><span class="sxs-lookup"><span data-stu-id="52559-205">The context structure is present in all telemetry logged by Application Insights.</span></span> <span data-ttu-id="52559-206">L'elemento città potrebbe non essere popolato nei log.</span><span class="sxs-lookup"><span data-stu-id="52559-206">The city element may not be populated in your logs.</span></span> <span data-ttu-id="52559-207">Usare lo schema per identificare altri elementi su cui è possibile eseguire una query che potrebbe contenere i dati per i log.</span><span class="sxs-lookup"><span data-stu-id="52559-207">Use the schema to identify other elements that you can query that may contain data for your logs.</span></span>
   >
   >

    <span data-ttu-id="52559-208">La query restituisce informazioni simili al testo seguente:</span><span class="sxs-lookup"><span data-stu-id="52559-208">This query returns information similar to the following text:</span></span>

        +---------+
        |     city|
        +---------+
        | Bellevue|
        |  Redmond|
        |  Seattle|
        |Charlotte|
        ...
        +---------+

## <a name="next-steps"></a><span data-ttu-id="52559-209">Passaggi successivi</span><span class="sxs-lookup"><span data-stu-id="52559-209">Next steps</span></span>

<span data-ttu-id="52559-210">Per altri esempi sull'uso di Spark per lavorare con dati e servizi di Azure, vedere i documenti seguenti:</span><span class="sxs-lookup"><span data-stu-id="52559-210">For more examples of using Spark to work with data and services in Azure, see the following documents:</span></span>

* [<span data-ttu-id="52559-211">Spark con Business Intelligence: eseguire l'analisi interattiva dei dati con strumenti di Business Intelligence mediante Spark in HDInsight</span><span class="sxs-lookup"><span data-stu-id="52559-211">Spark with BI: Perform interactive data analysis using Spark in HDInsight with BI tools</span></span>](hdinsight-apache-spark-use-bi-tools.md)
* [<span data-ttu-id="52559-212">Spark con Machine Learning: utilizzare Spark in HDInsight per l'analisi della temperatura di compilazione utilizzando dati HVAC</span><span class="sxs-lookup"><span data-stu-id="52559-212">Spark with Machine Learning: Use Spark in HDInsight for analyzing building temperature using HVAC data</span></span>](hdinsight-apache-spark-ipython-notebook-machine-learning.md)
* [<span data-ttu-id="52559-213">Spark con Machine Learning: usare Spark in HDInsight per prevedere i risultati del controllo degli alimenti</span><span class="sxs-lookup"><span data-stu-id="52559-213">Spark with Machine Learning: Use Spark in HDInsight to predict food inspection results</span></span>](hdinsight-apache-spark-machine-learning-mllib-ipython.md)
* [<span data-ttu-id="52559-214">Streaming Spark: usare Spark in HDInsight per la compilazione di applicazioni di streaming</span><span class="sxs-lookup"><span data-stu-id="52559-214">Spark Streaming: Use Spark in HDInsight for building streaming applications</span></span>](hdinsight-apache-spark-eventhub-streaming.md)
* [<span data-ttu-id="52559-215">Analisi dei log del sito Web mediante Spark in HDInsight</span><span class="sxs-lookup"><span data-stu-id="52559-215">Website log analysis using Spark in HDInsight</span></span>](hdinsight-apache-spark-custom-library-website-log-analysis.md)

<span data-ttu-id="52559-216">Per informazioni sulla creazione e l'esecuzione delle applicazioni Spark, vedere i documenti seguenti:</span><span class="sxs-lookup"><span data-stu-id="52559-216">For information on creating and running Spark applications, see the following documents:</span></span>

* [<span data-ttu-id="52559-217">Creare un'applicazione autonoma con Scala</span><span class="sxs-lookup"><span data-stu-id="52559-217">Create a standalone application using Scala</span></span>](hdinsight-apache-spark-create-standalone-application.md)
* [<span data-ttu-id="52559-218">Eseguire processi in modalità remota in un cluster Spark usando Livy</span><span class="sxs-lookup"><span data-stu-id="52559-218">Run jobs remotely on a Spark cluster using Livy</span></span>](hdinsight-apache-spark-livy-rest-interface.md)
