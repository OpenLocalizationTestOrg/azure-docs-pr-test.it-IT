---
title: Gestire il carico dei microservizi di Azure con le metriche | Documentazione Microsoft
description: Informazioni su come configurare e usare le metriche in Service Fabric per gestire il consumo delle risorse dei servizi.
services: service-fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: 
ms.assetid: 0d622ea6-a7c7-4bef-886b-06e6b85a97fb
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: 7e020bb6c02c80127e4225ba695017dff9b5a168
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/18/2017
---
# <a name="managing-resource-consumption-and-load-in-service-fabric-with-metrics"></a><span data-ttu-id="752df-103">Gestione dell'utilizzo delle risorse e del carico in Service Fabric con le metriche</span><span class="sxs-lookup"><span data-stu-id="752df-103">Managing resource consumption and load in Service Fabric with metrics</span></span>
<span data-ttu-id="752df-104">Con *metriche* si intendono le risorse rilevanti per i servizi, che sono fornite dai nodi nel cluster.</span><span class="sxs-lookup"><span data-stu-id="752df-104">*Metrics* are the resources that your services care about and which are provided by the nodes in the cluster.</span></span> <span data-ttu-id="752df-105">Una metrica è un qualsiasi elemento che si vuole gestire per controllare o migliorare le prestazioni dei servizi.</span><span class="sxs-lookup"><span data-stu-id="752df-105">A metric is anything that you want to manage in order to improve or monitor the performance of your services.</span></span> <span data-ttu-id="752df-106">Ad esempio, è possibile osservare il consumo di memoria per capire se il servizio è sovraccarico.</span><span class="sxs-lookup"><span data-stu-id="752df-106">For example, you might watch memory consumption to know if your service is overloaded.</span></span> <span data-ttu-id="752df-107">Le metriche possono essere usate per determinare se il servizio può essere spostato in un'altra posizione con memoria meno vincolata, per ottenere prestazioni migliori.</span><span class="sxs-lookup"><span data-stu-id="752df-107">Another use is to figure out whether the service could move elsewhere where memory is less constrained in order to get better performance.</span></span>

<span data-ttu-id="752df-108">Sono metriche, ad esempio, l'utilizzo della CPU, della memoria e dei dischi.</span><span class="sxs-lookup"><span data-stu-id="752df-108">Things like Memory, Disk, and CPU usage are examples of metrics.</span></span> <span data-ttu-id="752df-109">In questo caso si tratta di metriche fisiche, ovvero risorse che corrispondono alle risorse fisiche nel nodo e che devono essere gestite.</span><span class="sxs-lookup"><span data-stu-id="752df-109">These metrics are physical metrics, resources that correspond to physical resources on the node that need to be managed.</span></span> <span data-ttu-id="752df-110">Le metriche possono anche essere logiche e in genere sono di questo tipo.</span><span class="sxs-lookup"><span data-stu-id="752df-110">Metrics can also be (and commonly are) logical metrics.</span></span> <span data-ttu-id="752df-111">Sono metriche logiche, ad esempio, "MyWorkQueueDepth", "MessagesToProcess" e "TotalRecords".</span><span class="sxs-lookup"><span data-stu-id="752df-111">Logical metrics are things like “MyWorkQueueDepth” or "MessagesToProcess" or "TotalRecords".</span></span> <span data-ttu-id="752df-112">Le metriche logiche sono definite dall'applicazione e corrispondono indirettamente al consumo di alcune risorse fisiche.</span><span class="sxs-lookup"><span data-stu-id="752df-112">Logical metrics are application-defined and indirectly correspond to some physical resource consumption.</span></span> <span data-ttu-id="752df-113">Sono comuni in quanto può essere difficile misurare e creare report sul consumo delle risorse fisiche per ogni servizio.</span><span class="sxs-lookup"><span data-stu-id="752df-113">Logical metrics are common because it can be hard to measure and report consumption of physical resources on a per-service basis.</span></span> <span data-ttu-id="752df-114">La complessità della misurazione e della creazione di report delle metriche è anche il motivo per cui in Service Fabric vengono fornite alcune metriche predefinite.</span><span class="sxs-lookup"><span data-stu-id="752df-114">The complexity of measuring and reporting your own physical metrics is also why Service Fabric provides some default metrics.</span></span>

## <a name="default-metrics"></a><span data-ttu-id="752df-115">Metriche predefinite</span><span class="sxs-lookup"><span data-stu-id="752df-115">Default metrics</span></span>
<span data-ttu-id="752df-116">Si supponga che si desideri iniziare a scrivere e a distribuire il servizio.</span><span class="sxs-lookup"><span data-stu-id="752df-116">Let’s say that you want to get started writing and deploying your service.</span></span> <span data-ttu-id="752df-117">Ancora non si conoscono le risorse fisiche o logiche che il servizio consuma.</span><span class="sxs-lookup"><span data-stu-id="752df-117">At this point you don’t know what physical or logical resources it consumes.</span></span> <span data-ttu-id="752df-118">Questo approccio non presenta problemi.</span><span class="sxs-lookup"><span data-stu-id="752df-118">That’s fine!</span></span> <span data-ttu-id="752df-119">Cluster Resource Manager di Service Fabric usa alcune metriche predefinite quando non vengono specificate altre metriche.</span><span class="sxs-lookup"><span data-stu-id="752df-119">The Service Fabric Cluster Resource Manager uses some default metrics when no other metrics are specified.</span></span> <span data-ttu-id="752df-120">Sono:</span><span class="sxs-lookup"><span data-stu-id="752df-120">They are:</span></span>

  - <span data-ttu-id="752df-121">PrimaryCount - Numero di repliche primarie nel nodo</span><span class="sxs-lookup"><span data-stu-id="752df-121">PrimaryCount - count of Primary replicas on the node</span></span> 
  - <span data-ttu-id="752df-122">ReplicaCount - Numero di repliche con stato totali nel nodo</span><span class="sxs-lookup"><span data-stu-id="752df-122">ReplicaCount - count of total stateful replicas on the node</span></span>
  - <span data-ttu-id="752df-123">Count - Numero di oggetti servizio (con e senza stato) nel nodo</span><span class="sxs-lookup"><span data-stu-id="752df-123">Count - count of all service objects (stateless and stateful) on the node</span></span>

| <span data-ttu-id="752df-124">Metrica</span><span class="sxs-lookup"><span data-stu-id="752df-124">Metric</span></span> | <span data-ttu-id="752df-125">Carico di istanza senza stato</span><span class="sxs-lookup"><span data-stu-id="752df-125">Stateless Instance Load</span></span> | <span data-ttu-id="752df-126">Carico secondario con stato</span><span class="sxs-lookup"><span data-stu-id="752df-126">Stateful Secondary Load</span></span> | <span data-ttu-id="752df-127">Carico primario con stato</span><span class="sxs-lookup"><span data-stu-id="752df-127">Stateful Primary Load</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="752df-128">PrimaryCount</span><span class="sxs-lookup"><span data-stu-id="752df-128">PrimaryCount</span></span> |<span data-ttu-id="752df-129">0</span><span class="sxs-lookup"><span data-stu-id="752df-129">0</span></span> |<span data-ttu-id="752df-130">0</span><span class="sxs-lookup"><span data-stu-id="752df-130">0</span></span> |<span data-ttu-id="752df-131">1</span><span class="sxs-lookup"><span data-stu-id="752df-131">1</span></span> |
| <span data-ttu-id="752df-132">ReplicaCount</span><span class="sxs-lookup"><span data-stu-id="752df-132">ReplicaCount</span></span> |<span data-ttu-id="752df-133">0</span><span class="sxs-lookup"><span data-stu-id="752df-133">0</span></span> |<span data-ttu-id="752df-134">1</span><span class="sxs-lookup"><span data-stu-id="752df-134">1</span></span> |<span data-ttu-id="752df-135">1</span><span class="sxs-lookup"><span data-stu-id="752df-135">1</span></span> |
| <span data-ttu-id="752df-136">Numero</span><span class="sxs-lookup"><span data-stu-id="752df-136">Count</span></span> |<span data-ttu-id="752df-137">1</span><span class="sxs-lookup"><span data-stu-id="752df-137">1</span></span> |<span data-ttu-id="752df-138">1</span><span class="sxs-lookup"><span data-stu-id="752df-138">1</span></span> |<span data-ttu-id="752df-139">1</span><span class="sxs-lookup"><span data-stu-id="752df-139">1</span></span> |

<span data-ttu-id="752df-140">Per i carichi di lavoro di base, le metriche predefinite forniscono una distribuzione ragionevole del lavoro nel cluster.</span><span class="sxs-lookup"><span data-stu-id="752df-140">For basic workloads, the default metrics provide a decent distribution of work in the cluster.</span></span> <span data-ttu-id="752df-141">L'esempio seguente illustra che cosa accade quando si creano due servizi e ci si affida alle metriche predefinite per il bilanciamento.</span><span class="sxs-lookup"><span data-stu-id="752df-141">In the following example, let’s see what happens when we create two services and rely on the default metrics for balancing.</span></span> <span data-ttu-id="752df-142">Il primo è un servizio con stato con tre partizioni e dimensioni del set di repliche di destinazione pari a tre.</span><span class="sxs-lookup"><span data-stu-id="752df-142">The first service is a stateful service with three partitions and a target replica set size of three.</span></span> <span data-ttu-id="752df-143">Il secondo è un servizio senza stato con una partizione e un numero di istanze pari a tre.</span><span class="sxs-lookup"><span data-stu-id="752df-143">The second service is a stateless service with one partition and an instance count of three.</span></span>

<span data-ttu-id="752df-144">Il risultato è il seguente:</span><span class="sxs-lookup"><span data-stu-id="752df-144">Here's what you get:</span></span>

<span data-ttu-id="752df-145"><center>
![Layout dei cluster con metriche predefinite][Image1]
</center></span><span class="sxs-lookup"><span data-stu-id="752df-145"><center>
![Cluster Layout with Default Metrics][Image1]
</center></span></span>

<span data-ttu-id="752df-146">Alcuni punti di cui tenere conto:</span><span class="sxs-lookup"><span data-stu-id="752df-146">Some things to note:</span></span>
  - <span data-ttu-id="752df-147">Le repliche primarie per il servizio con stato vengono distribuite tra più nodi.</span><span class="sxs-lookup"><span data-stu-id="752df-147">Primary replicas for the stateful service are distributed across several nodes</span></span>
  - <span data-ttu-id="752df-148">Le repliche della stessa partizione si trovano su nodi differenti.</span><span class="sxs-lookup"><span data-stu-id="752df-148">Replicas for the same partition are on different nodes</span></span>
  - <span data-ttu-id="752df-149">Il numero totale di elementi primari e secondari è distribuito nel cluster.</span><span class="sxs-lookup"><span data-stu-id="752df-149">The total number of primaries and secondaries is distributed in the cluster</span></span>
  - <span data-ttu-id="752df-150">Il numero totale di oggetti di servizio è allocato in modo uniforme in ogni nodo.</span><span class="sxs-lookup"><span data-stu-id="752df-150">The total number of service objects are evenly allocated on each node</span></span>

<span data-ttu-id="752df-151">Ottimo.</span><span class="sxs-lookup"><span data-stu-id="752df-151">Good!</span></span>

<span data-ttu-id="752df-152">Le metriche predefinite sono un punto di partenza ideale,</span><span class="sxs-lookup"><span data-stu-id="752df-152">The default metrics work great as a start.</span></span> <span data-ttu-id="752df-153">ma non consentono di andare troppo oltre.</span><span class="sxs-lookup"><span data-stu-id="752df-153">However, the default metrics will only carry you so far.</span></span> <span data-ttu-id="752df-154">Sono infatti un approccio efficace fino a quando non si prende in considerazione l'effettiva probabilità che lo schema di partizionamento selezionato produca un consumo perfettamente uniforme in tutte le partizioni,</span><span class="sxs-lookup"><span data-stu-id="752df-154">For example: What's the likelihood that the partitioning scheme you picked results in perfectly even utilization by all partitions?</span></span> <span data-ttu-id="752df-155">e che il carico per un determinato servizio sia costante nel tempo o resti invariato.</span><span class="sxs-lookup"><span data-stu-id="752df-155">What’s the chance that the load for a given service is constant over time, or even just the same across multiple partitions right now?</span></span>

<span data-ttu-id="752df-156">È possibile operare solo con le metriche predefinite,</span><span class="sxs-lookup"><span data-stu-id="752df-156">You could run with just the default metrics.</span></span> <span data-ttu-id="752df-157">tuttavia, in genere ciò significa che il consumo del cluster è inferiore e non uniforme come desiderato.</span><span class="sxs-lookup"><span data-stu-id="752df-157">However, doing so usually means that your cluster utilization is lower and more uneven than you’d like.</span></span> <span data-ttu-id="752df-158">Ciò è dovuto al fatto che le metriche predefinite non sono adattive e presuppongono che tutti gli elementi siano equivalenti.</span><span class="sxs-lookup"><span data-stu-id="752df-158">This is because the default metrics aren't adaptive and presume everything is equivalent.</span></span> <span data-ttu-id="752df-159">Ad esempio, una replica primaria e una che non lo è contribuiscono entrambe con "1" alla metrica PrimaryCount.</span><span class="sxs-lookup"><span data-stu-id="752df-159">For example, a Primary that is busy and one that is not both contribute "1" to the PrimaryCount metric.</span></span> <span data-ttu-id="752df-160">Nel peggiore dei casi, l'uso delle sole metriche predefinite può determinare anche la sovrapianificazione dei nodi e di conseguenza problemi di prestazioni.</span><span class="sxs-lookup"><span data-stu-id="752df-160">In the worst case, using only the default metrics can also result in overscheduled nodes resulting in performance issues.</span></span> <span data-ttu-id="752df-161">Se si è interessati a sfruttare al meglio il cluster e a evitare problemi di prestazioni, è opportuno prendere in considerazione metriche personalizzate e creazione di report sul carico dinamico.</span><span class="sxs-lookup"><span data-stu-id="752df-161">If you're interested in getting the most out of your cluster and avoiding performance issues, you need to use custom metrics and dynamic load reporting.</span></span>

## <a name="custom-metrics"></a><span data-ttu-id="752df-162">Metriche personalizzate</span><span class="sxs-lookup"><span data-stu-id="752df-162">Custom metrics</span></span>
<span data-ttu-id="752df-163">Le metriche sono configurate in base alle singole istanze del servizio durante la creazione del servizio.</span><span class="sxs-lookup"><span data-stu-id="752df-163">Metrics are configured on a per-named-service-instance basis when you’re creating the service.</span></span>

<span data-ttu-id="752df-164">Qualsiasi metrica è descritta da alcune proprietà: nome, carico predefinito e peso.</span><span class="sxs-lookup"><span data-stu-id="752df-164">Any metric has some properties that describe it: a name, a weight, and a default load.</span></span>

* <span data-ttu-id="752df-165">Nome della metrica: il nome della metrica,</span><span class="sxs-lookup"><span data-stu-id="752df-165">Metric Name: The name of the metric.</span></span> <span data-ttu-id="752df-166">che è un identificatore univoco della metrica nel cluster dal punto di vista di Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="752df-166">The metric name is a unique identifier for the metric within the cluster from the Resource Manager’s perspective.</span></span>
* <span data-ttu-id="752df-167">Peso: il peso della metrica ne definisce l'importanza rispetto alle altre metriche per il servizio.</span><span class="sxs-lookup"><span data-stu-id="752df-167">Weight: Metric weight defines how important this metric is relative to the other metrics for this service.</span></span>
* <span data-ttu-id="752df-168">Default Load: il carico predefinito è rappresentato in modo diverso a seconda che il servizio sia con o senza stato.</span><span class="sxs-lookup"><span data-stu-id="752df-168">Default Load: The default load is represented differently depending on whether the service is stateless or stateful.</span></span>
  * <span data-ttu-id="752df-169">Per i servizi senza stato, ogni metrica ha un'unica proprietà denominata DefaultLoad</span><span class="sxs-lookup"><span data-stu-id="752df-169">For stateless services, each metric has a single property named DefaultLoad</span></span>
  * <span data-ttu-id="752df-170">Per i servizi con stato si definiscono le proprietà seguenti.</span><span class="sxs-lookup"><span data-stu-id="752df-170">For stateful services you define:</span></span>
    * <span data-ttu-id="752df-171">PrimaryDefaultLoad: quantità predefinita della metrica utilizzata dal servizio quando è primario</span><span class="sxs-lookup"><span data-stu-id="752df-171">PrimaryDefaultLoad: The default amount of this metric this service consumes when it is a Primary</span></span>
    * <span data-ttu-id="752df-172">SecondaryDefaultLoad: quantità predefinita della metrica utilizzata dal servizio quando è secondario</span><span class="sxs-lookup"><span data-stu-id="752df-172">SecondaryDefaultLoad: The default amount of this metric this service consumes when it is a Secondary</span></span>

> [!NOTE]
> <span data-ttu-id="752df-173">Se si definiscono metriche personalizzate e si vogliono usare _anche_ le metriche predefinite, è necessario aggiungerle _esplicitamente_, e definire per queste pesi e valori,</span><span class="sxs-lookup"><span data-stu-id="752df-173">If you define custom metrics and you want to _also_ use the default metrics, you need to _explicitly_ add the default metrics back and define weights and values for them.</span></span> <span data-ttu-id="752df-174">così da stabilire la relazione tra le metriche predefinite e quelle personalizzate.</span><span class="sxs-lookup"><span data-stu-id="752df-174">This is because you must define the relationship between the default metrics and your custom metrics.</span></span> <span data-ttu-id="752df-175">Ad esempio, si può essere più interessati a una metrico di tipo ConnectionCount o WorkQueueDepth che alla distribuzione della metrica primaria.</span><span class="sxs-lookup"><span data-stu-id="752df-175">For example, maybe you care about ConnectionCount or WorkQueueDepth more than Primary distribution.</span></span> <span data-ttu-id="752df-176">Per impostazione predefinita il peso della metrica PrimaryCount è elevato, pertanto si desidera ridurlo a medio se si aggiungono altre metriche, per garantire che abbiano la precedenza.</span><span class="sxs-lookup"><span data-stu-id="752df-176">By default the weight of the PrimaryCount metric is High, so you want to reduce it to Medium when you add your other metrics to ensure they take precedence.</span></span>
>

### <a name="defining-metrics-for-your-service---an-example"></a><span data-ttu-id="752df-177">Definizione delle metriche per il servizio: esempio</span><span class="sxs-lookup"><span data-stu-id="752df-177">Defining metrics for your service - an example</span></span>
<span data-ttu-id="752df-178">Si supponga di voler ottenere la configurazione seguente:</span><span class="sxs-lookup"><span data-stu-id="752df-178">Let’s say you want the following configuration:</span></span>

  - <span data-ttu-id="752df-179">Il servizio segnala una metrica denominata "ConnectionCount".</span><span class="sxs-lookup"><span data-stu-id="752df-179">Your service reports a metric named "ConnectionCount”</span></span>
  - <span data-ttu-id="752df-180">Si desidera usare anche le metriche predefinite.</span><span class="sxs-lookup"><span data-stu-id="752df-180">You also want to use the default metrics</span></span> 
  - <span data-ttu-id="752df-181">Sono state eseguite alcune misurazioni rilevando che normalmente per una replica primaria del servizio sono necessarie 20 unità di "ConnectionCount",</span><span class="sxs-lookup"><span data-stu-id="752df-181">You’ve done some measurements and know that normally a Primary replica of that service takes up 20 units of "ConnectionCount"</span></span>
  - <span data-ttu-id="752df-182">mentre per quelle secondarie ne sono necessarie cinque.</span><span class="sxs-lookup"><span data-stu-id="752df-182">Secondaries use 5 units of "ConnectionCount"</span></span>
  - <span data-ttu-id="752df-183">Si è consapevoli del fatto che "ConnectionCount" è la metrica più importante in termini di gestione delle prestazioni del servizio specifico,</span><span class="sxs-lookup"><span data-stu-id="752df-183">You know that "ConnectionCount" is the most important metric in terms of managing the performance of this particular service</span></span>
  - <span data-ttu-id="752df-184">ma si vuole comunque che le repliche primarie siano bilanciate.</span><span class="sxs-lookup"><span data-stu-id="752df-184">You still want Primary replicas balanced.</span></span> <span data-ttu-id="752df-185">Il bilanciamento delle repliche primarie è comunque un approccio consigliabile.</span><span class="sxs-lookup"><span data-stu-id="752df-185">Balancing primary replicas is generally a good idea no matter what.</span></span> <span data-ttu-id="752df-186">Consente infatti di evitare che la perdita di alcuni nodi o domini di errore abbia conseguenze anche su un gran numero di repliche primarie.</span><span class="sxs-lookup"><span data-stu-id="752df-186">This helps prevent the loss of some node or fault domain from impacting a majority of primary replicas along with it.</span></span> 
  - <span data-ttu-id="752df-187">Altrimenti, le metriche predefinite sono comunque una scelta valida.</span><span class="sxs-lookup"><span data-stu-id="752df-187">Otherwise, the default metrics are fine</span></span>

<span data-ttu-id="752df-188">Di seguito è riportato il codice da scrivere per creare un servizio con tale configurazione delle metriche:</span><span class="sxs-lookup"><span data-stu-id="752df-188">Here’s the code that you would write to create a service with that metric configuration:</span></span>

<span data-ttu-id="752df-189">Codice:</span><span class="sxs-lookup"><span data-stu-id="752df-189">Code:</span></span>

```csharp
StatefulServiceDescription serviceDescription = new StatefulServiceDescription();
StatefulServiceLoadMetricDescription connectionMetric = new StatefulServiceLoadMetricDescription();
connectionMetric.Name = "ConnectionCount";
connectionMetric.PrimaryDefaultLoad = 20;
connectionMetric.SecondaryDefaultLoad = 5;
connectionMetric.Weight = ServiceLoadMetricWeight.High;

StatefulServiceLoadMetricDescription primaryCountMetric = new StatefulServiceLoadMetricDescription();
primaryCountMetric.Name = "PrimaryCount";
primaryCountMetric.PrimaryDefaultLoad = 1;
primaryCountMetric.SecondaryDefaultLoad = 0;
primaryCountMetric.Weight = ServiceLoadMetricWeight.Medium;

StatefulServiceLoadMetricDescription replicaCountMetric = new StatefulServiceLoadMetricDescription();
replicaCountMetric.Name = "ReplicaCount";
replicaCountMetric.PrimaryDefaultLoad = 1;
replicaCountMetric.SecondaryDefaultLoad = 1;
replicaCountMetric.Weight = ServiceLoadMetricWeight.Low;

StatefulServiceLoadMetricDescription totalCountMetric = new StatefulServiceLoadMetricDescription();
totalCountMetric.Name = "Count";
totalCountMetric.PrimaryDefaultLoad = 1;
totalCountMetric.SecondaryDefaultLoad = 1;
totalCountMetric.Weight = ServiceLoadMetricWeight.Low;

serviceDescription.Metrics.Add(connectionMetric);
serviceDescription.Metrics.Add(primaryCountMetric);
serviceDescription.Metrics.Add(replicaCountMetric);
serviceDescription.Metrics.Add(totalCountMetric);

await fabricClient.ServiceManager.CreateServiceAsync(serviceDescription);
```

<span data-ttu-id="752df-190">Powershell:</span><span class="sxs-lookup"><span data-stu-id="752df-190">Powershell:</span></span>

```posh
New-ServiceFabricService -ApplicationName $applicationName -ServiceName $serviceName -ServiceTypeName $serviceTypeName –Stateful -MinReplicaSetSize 3 -TargetReplicaSetSize 3 -PartitionSchemeSingleton –Metric @("ConnectionCount,High,20,5”,"PrimaryCount,Medium,1,0”,"ReplicaCount,Low,1,1”,"Count,Low,1,1”)
```

> [!NOTE]
> <span data-ttu-id="752df-191">Gli esempi precedenti e ciò che segue in questo documento illustrano come gestire le metriche di gestione di ogni specifico servizio.</span><span class="sxs-lookup"><span data-stu-id="752df-191">The above examples and the rest of this document describe managing metrics on a per-named-service basis.</span></span> <span data-ttu-id="752df-192">È anche possibile definire le metriche per i servizi a livello di _tipo_ del servizio.</span><span class="sxs-lookup"><span data-stu-id="752df-192">It is also possible to define metrics for your services at the service _type_ level.</span></span> <span data-ttu-id="752df-193">A tal fine, specificarle nei manifesti del servizio.</span><span class="sxs-lookup"><span data-stu-id="752df-193">This is accomplished by specifying them in your service manifests.</span></span> <span data-ttu-id="752df-194">La definizione delle metriche a livello di tipo non è consigliata per diversi motivi.</span><span class="sxs-lookup"><span data-stu-id="752df-194">Defining type level metrics is not recommended for several reasons.</span></span> <span data-ttu-id="752df-195">Il primo è che i nomi delle metriche sono spesso specifici dell'ambiente.</span><span class="sxs-lookup"><span data-stu-id="752df-195">The first reason is that metric names are frequently environment-specific.</span></span> <span data-ttu-id="752df-196">A meno che non sia disponibile un contratto aziendale, non è possibile assicurarsi che la metrica "Cores" in un ambiente non sia "MiliCores" o "CoRes" in altri.</span><span class="sxs-lookup"><span data-stu-id="752df-196">Unless there is a firm contract in place, you cannot be sure that the metric "Cores" in one environment isn't "MiliCores" or "CoReS" in others.</span></span> <span data-ttu-id="752df-197">Se le metriche vengono definite nel manifesto è necessario creare nuovi manifesti per ogni ambiente.</span><span class="sxs-lookup"><span data-stu-id="752df-197">If your metrics are defined in your manifest you need to create new manifests per environment.</span></span> <span data-ttu-id="752df-198">Questo comporta in genere una proliferazione di manifesti diversi che presentano solo piccole differenze, e ciò può implicare difficoltà di gestione.</span><span class="sxs-lookup"><span data-stu-id="752df-198">This usually leads to a proliferation of different manifests with only minor differences, which can lead to management difficulties.</span></span>  
>
> <span data-ttu-id="752df-199">I carichi delle metriche vengono in genere assegnati in base a determinate istanze del servizio.</span><span class="sxs-lookup"><span data-stu-id="752df-199">Metric loads are commonly assigned on a per-named-service-instance basis.</span></span> <span data-ttu-id="752df-200">Si supponga, ad esempio, di creare un'istanza del servizio per ClienteA, che ne prevede un utilizzo saltuario.</span><span class="sxs-lookup"><span data-stu-id="752df-200">For example, let's say you create one instance of the service for CustomerA who plans to use it only lightly.</span></span> <span data-ttu-id="752df-201">Si supponga quindi di crearne un'altra per ClienteB, che ha un carico di lavoro maggiore.</span><span class="sxs-lookup"><span data-stu-id="752df-201">Let's also say you create another for CustomerB who has a larger workload.</span></span> <span data-ttu-id="752df-202">In questo caso probabilmente si desidera ottimizzare i carichi predefiniti per tali servizi.</span><span class="sxs-lookup"><span data-stu-id="752df-202">In this case, you'd probably want to tweak the default loads for those services.</span></span> <span data-ttu-id="752df-203">In presenza di metriche e carichi definiti tramite i manifesti e si desidera supportare questo scenario, sono necessari tipi di servizio e applicazione diversi per ogni cliente.</span><span class="sxs-lookup"><span data-stu-id="752df-203">If you have metrics and loads defined via manifests and you want to support this scenario, it requires different application and service types for each customer.</span></span> <span data-ttu-id="752df-204">I valori definiti al momento della creazione del servizio sostituiscono quelli definiti nel manifesto, ed è pertanto possibile usarli per impostare valori predefiniti specifici.</span><span class="sxs-lookup"><span data-stu-id="752df-204">The values defined at service creation time override those defined in the manifest, so you could use that to set the specific defaults.</span></span> <span data-ttu-id="752df-205">Tuttavia, questa operazione determina che i valori dichiarati nei manifesti non corrispondano a quelli con i quali viene eseguito il servizio.</span><span class="sxs-lookup"><span data-stu-id="752df-205">However, doing that causes the values declared in the manifests to not match those the service actually runs with.</span></span> <span data-ttu-id="752df-206">Ciò può causare confusione.</span><span class="sxs-lookup"><span data-stu-id="752df-206">This can lead to confusion.</span></span> 
>

<span data-ttu-id="752df-207">Promemoria: se si vogliono usare solo le metriche predefinite, non è necessario modificare in alcun modo la raccolta di metriche né eseguire operazioni speciali durante la creazione del servizio.</span><span class="sxs-lookup"><span data-stu-id="752df-207">As a reminder: if you just want to use the default metrics, you don’t need to touch the metrics collection at all or do anything special when creating your service.</span></span> <span data-ttu-id="752df-208">Le metriche predefinite vengono usate automaticamente quando non ne sono definite altre.</span><span class="sxs-lookup"><span data-stu-id="752df-208">The default metrics get used automatically when no others are defined.</span></span> 

<span data-ttu-id="752df-209">Di seguito ognuna di queste impostazioni viene esaminata in modo più dettagliato; viene inoltre descritto il comportamento sul quale essa agisce.</span><span class="sxs-lookup"><span data-stu-id="752df-209">Now, let's go through each of these settings in more detail and talk about the behavior that it influences.</span></span>

## <a name="load"></a><span data-ttu-id="752df-210">Caricamento</span><span class="sxs-lookup"><span data-stu-id="752df-210">Load</span></span>
<span data-ttu-id="752df-211">La definizione di metriche consiste essenzialmente nella rappresentazione di un carico.</span><span class="sxs-lookup"><span data-stu-id="752df-211">The whole point of defining metrics is to represent some load.</span></span> <span data-ttu-id="752df-212">Il *carico* è la quantità di una determinata metrica che viene consumata da una replica o un'istanza del servizio in un nodo specifico.</span><span class="sxs-lookup"><span data-stu-id="752df-212">*Load* is how much of a given metric is consumed by some service instance or replica on a given node.</span></span> <span data-ttu-id="752df-213">Il carico può essere configurato in qualsiasi momento,</span><span class="sxs-lookup"><span data-stu-id="752df-213">Load can be configured at almost any point.</span></span> <span data-ttu-id="752df-214">ad esempio:</span><span class="sxs-lookup"><span data-stu-id="752df-214">For example:</span></span>

  - <span data-ttu-id="752df-215">Può essere definito quando viene creato un servizio.</span><span class="sxs-lookup"><span data-stu-id="752df-215">Load can be defined when a service is created.</span></span> <span data-ttu-id="752df-216">Si tratta in questo caso del _carico predefinito_.</span><span class="sxs-lookup"><span data-stu-id="752df-216">This is called _default load_.</span></span>
  - <span data-ttu-id="752df-217">Le informazioni sulla metrica, inclusi i carichi predefiniti per un servizio possono essere aggiornati dopo aver creato il servizio.</span><span class="sxs-lookup"><span data-stu-id="752df-217">The metric information, including default loads, for a service can updated after the service is created.</span></span> <span data-ttu-id="752df-218">Si tratta in questo caso di _aggiornamento di un servizio_.</span><span class="sxs-lookup"><span data-stu-id="752df-218">This is called _updating a service_.</span></span> 
  - <span data-ttu-id="752df-219">Il carico di una determinata partizione può essere reimpostato sui valori predefiniti per il servizio.</span><span class="sxs-lookup"><span data-stu-id="752df-219">The loads for a given partition can be reset to the default values for that service.</span></span> <span data-ttu-id="752df-220">Viene definita _reimpostazione del carico della partizione_.</span><span class="sxs-lookup"><span data-stu-id="752df-220">This is called _resetting partition load_.</span></span>
  - <span data-ttu-id="752df-221">Il carico può essere restituito per ogni oggetto servizio in modo dinamico in fase di esecuzione.</span><span class="sxs-lookup"><span data-stu-id="752df-221">Load can be reported on a per service object basis dynamically during runtime.</span></span> <span data-ttu-id="752df-222">Si ha in questo caso la _creazione di report di carico_.</span><span class="sxs-lookup"><span data-stu-id="752df-222">This is called _reporting load_.</span></span> 
  
<span data-ttu-id="752df-223">Tutte queste strategie possono essere usate nello stesso servizio per tutta la relativa durata.</span><span class="sxs-lookup"><span data-stu-id="752df-223">All of these strategies can be used within the same service over its lifetime.</span></span> 

## <a name="default-load"></a><span data-ttu-id="752df-224">Carico predefinito</span><span class="sxs-lookup"><span data-stu-id="752df-224">Default load</span></span>
<span data-ttu-id="752df-225">Il *carico predefinito* è la quantità di metrica consumata da ogni oggetto servizio (istanza senza stato o replica con stato) del servizio specifico.</span><span class="sxs-lookup"><span data-stu-id="752df-225">*Default load* is how much of the metric each service object (stateless instance or stateful replica) of this service consumes.</span></span> <span data-ttu-id="752df-226">Cluster Resource Manager usa questo numero per il carico dell'oggetto servizio finché non riceve altre informazioni, ad esempio un report del carico dinamico.</span><span class="sxs-lookup"><span data-stu-id="752df-226">The Cluster Resource Manager uses this number for the load of the service object until it receives other information, such as a dynamic load report.</span></span> <span data-ttu-id="752df-227">Per i servizi più semplici, il carico predefinito è una definizione statica.</span><span class="sxs-lookup"><span data-stu-id="752df-227">For simpler services, the default load is a static definition.</span></span> <span data-ttu-id="752df-228">Non viene mai aggiornato e viene usato per tutta la durata del servizio.</span><span class="sxs-lookup"><span data-stu-id="752df-228">The default load is never updated and is used for the lifetime of the service.</span></span> <span data-ttu-id="752df-229">Il carico predefinito è efficace per scenari di pianificazione della capacità semplici, in cui determinate quantità di risorse sono dedicate a diversi carichi di lavoro e non vengono modificate.</span><span class="sxs-lookup"><span data-stu-id="752df-229">Default loads works great for simple capacity planning scenarios where certain amounts of resources are dedicated to different workloads and do not change.</span></span>

> [!NOTE]
> <span data-ttu-id="752df-230">Per altre informazioni sulla gestione della capacità e su come definire le capacità dei nodi del cluster, vedere [questo articolo](service-fabric-cluster-resource-manager-cluster-description.md#capacity).</span><span class="sxs-lookup"><span data-stu-id="752df-230">For more information on capacity management and defining capacities for the nodes in your cluster, please see [this article](service-fabric-cluster-resource-manager-cluster-description.md#capacity).</span></span>
> 

<span data-ttu-id="752df-231">Cluster Resource Manager consente ai servizi con stato di definire un carico predefinito diverso per le repliche primarie e quelle secondarie,</span><span class="sxs-lookup"><span data-stu-id="752df-231">The Cluster Resource Manager allows stateful services to specify a different default load for their Primaries and Secondaries.</span></span> <span data-ttu-id="752df-232">mentre per i servizi senza stato può essere specificato un solo valore, applicato a tutte le istanze.</span><span class="sxs-lookup"><span data-stu-id="752df-232">Stateless services can only specify one value that applies to all instances.</span></span> <span data-ttu-id="752df-233">Per i servizi con stato, il carico predefinito per le repliche primarie e secondarie è in genere diverso perché le repliche eseguono diverse tipologie di lavoro nel rispettivo ruolo.</span><span class="sxs-lookup"><span data-stu-id="752df-233">For stateful services, the default load for Primary and Secondary replicas are typically different since replicas do different kinds of work in each role.</span></span> <span data-ttu-id="752df-234">A differenza delle repliche secondarie, ad esempio, le repliche primarie gestiscono in genere operazioni sia di lettura che di scrittura, oltre alla maggior parte delle operazioni di calcolo.</span><span class="sxs-lookup"><span data-stu-id="752df-234">For example, Primaries usually serve both reads and writes, and handle most of the computational burden, while secondaries do not.</span></span> <span data-ttu-id="752df-235">In genere il carico predefinito di una replica primaria è superiore rispetto al carico predefinito delle repliche secondarie.</span><span class="sxs-lookup"><span data-stu-id="752df-235">Usually the default load for a primary replica is higher than the default load for secondary replicas.</span></span> <span data-ttu-id="752df-236">I valori effettivi dipendono dalle proprie misurazioni.</span><span class="sxs-lookup"><span data-stu-id="752df-236">The real numbers should depend on your own measurements.</span></span>

## <a name="dynamic-load"></a><span data-ttu-id="752df-237">Carico dinamico</span><span class="sxs-lookup"><span data-stu-id="752df-237">Dynamic load</span></span>
<span data-ttu-id="752df-238">Si supponga di aver eseguito un servizio per un determinato periodo di tempo</span><span class="sxs-lookup"><span data-stu-id="752df-238">Let’s say that you’ve been running your service for a while.</span></span> <span data-ttu-id="752df-239">e di aver rilevato, con alcune attività di monitoraggio, quanto segue:</span><span class="sxs-lookup"><span data-stu-id="752df-239">With some monitoring, you’ve noticed that:</span></span>

1. <span data-ttu-id="752df-240">Alcune partizioni o istanze di un determinato servizio utilizzano più risorse di altre.</span><span class="sxs-lookup"><span data-stu-id="752df-240">Some partitions or instances of a given service consume more resources than others</span></span>
2. <span data-ttu-id="752df-241">Il carico di alcuni servizi varia nel tempo.</span><span class="sxs-lookup"><span data-stu-id="752df-241">Some services have load that varies over time.</span></span>

<span data-ttu-id="752df-242">Fluttuazioni del carico di questo tipo possono avere diverse cause.</span><span class="sxs-lookup"><span data-stu-id="752df-242">There's lots of things that could cause these types of load fluctuations.</span></span> <span data-ttu-id="752df-243">Ad esempio, servizi o partizioni diversi sono associati a clienti diversi con esigenze differenti.</span><span class="sxs-lookup"><span data-stu-id="752df-243">For example, different services or partitions are associated with different customers with different requirements.</span></span> <span data-ttu-id="752df-244">Il carico può anche cambiare, perché la quantità di lavoro svolto dal servizio varia nel corso della giornata.</span><span class="sxs-lookup"><span data-stu-id="752df-244">Load could also change because the amount of work the service does varies over the course of the day.</span></span> <span data-ttu-id="752df-245">Indipendentemente dal motivo, non esiste un singolo numero che possa essere usato come valore predefinito.</span><span class="sxs-lookup"><span data-stu-id="752df-245">Regardless of the reason, there’s usually no single number that you can use for default.</span></span> <span data-ttu-id="752df-246">Ciò vale soprattutto se si desidera ottimizzare al massimo il consumo del cluster.</span><span class="sxs-lookup"><span data-stu-id="752df-246">This is especially true if you want to get the most utilization out of the cluster.</span></span> <span data-ttu-id="752df-247">Qualsiasi valore selezionato come carico predefinito risulterà errato in determinati momenti.</span><span class="sxs-lookup"><span data-stu-id="752df-247">Any value you pick for default load is wrong some of the time.</span></span> <span data-ttu-id="752df-248">Carichi predefiniti non corretti causano un'allocazione eccessiva o insufficiente di risorse per il servizio da parte di Cluster Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="752df-248">Incorrect default loads result in the Cluster Resource Manager either over or under allocating resources.</span></span> <span data-ttu-id="752df-249">Di conseguenza, i nodi saranno sovrautilizzati o sottoutilizzati nonostante Cluster Resource Manager ritenga che il cluster sia bilanciato.</span><span class="sxs-lookup"><span data-stu-id="752df-249">As a result, you have nodes that are over or under utilized even though the Cluster Resource Manager thinks the cluster is balanced.</span></span> <span data-ttu-id="752df-250">I carichi predefiniti sono comunque validi perché forniscono alcune informazioni, ma non rappresentano interamente i carichi di lavoro reali.</span><span class="sxs-lookup"><span data-stu-id="752df-250">Default loads are still good since they provide some information for initial placement, but they're not a complete story for real workloads.</span></span> <span data-ttu-id="752df-251">È possibile acquisire in modo preciso le variazioni dei requisiti delle risorse. Cluster Resource Manager consente a ogni oggetto servizio di aggiornare il proprio carico in fase di esecuzione,</span><span class="sxs-lookup"><span data-stu-id="752df-251">To accurately capture changing resource requirements, the Cluster Resource Manager allows each service object to update its own load during runtime.</span></span> <span data-ttu-id="752df-252">con la creazione di report di carico dinamici.</span><span class="sxs-lookup"><span data-stu-id="752df-252">This is called dynamic load reporting.</span></span>

<span data-ttu-id="752df-253">I report di carico dinamici consentono alle repliche o alle istanze di modificare l'allocazione o il carico segnalato delle metriche nel corso della propria durata.</span><span class="sxs-lookup"><span data-stu-id="752df-253">Dynamic load reports allow replicas or instances to adjust their allocation/reported load of metrics over their lifetime.</span></span> <span data-ttu-id="752df-254">Una replica o un'istanza del servizio che è inattiva e non esegue alcuna operazione segnalerà in genere un uso ridotto di una determinata metrica,</span><span class="sxs-lookup"><span data-stu-id="752df-254">A service replica or instance that was cold and not doing any work would usually report that it was using low amounts of a given metric.</span></span> <span data-ttu-id="752df-255">mentre una replica o un'istanza occupata segnalerà un uso superiore.</span><span class="sxs-lookup"><span data-stu-id="752df-255">A busy replica or instance would report that they are using more.</span></span>

<span data-ttu-id="752df-256">La creazione di report per ogni replica o istanza consente a Cluster Resource Manager di riorganizzare i singoli oggetti di servizio nel cluster,</span><span class="sxs-lookup"><span data-stu-id="752df-256">Reporting load per replica or instance allows the Cluster Resource Manager to reorganize the individual service objects in the cluster.</span></span> <span data-ttu-id="752df-257">in modo da garantire che i servizi ottengano le risorse necessarie.</span><span class="sxs-lookup"><span data-stu-id="752df-257">Reorganizing the services helps ensure that they get the resources they require.</span></span> <span data-ttu-id="752df-258">I servizi occupati riescono effettivamente a "recuperare" le risorse da altre repliche o istanze attualmente inattive o meno occupate.</span><span class="sxs-lookup"><span data-stu-id="752df-258">Busy services effectively get to "reclaim" resources from other replicas or instances that are currently cold or doing less work.</span></span>

<span data-ttu-id="752df-259">In Reliable Services, il codice per la creazione di report di carico dinamici si presenterà come riportato di seguito.</span><span class="sxs-lookup"><span data-stu-id="752df-259">Within Reliable Services, the code to report load dynamically looks like this:</span></span>

<span data-ttu-id="752df-260">Codice:</span><span class="sxs-lookup"><span data-stu-id="752df-260">Code:</span></span>

```csharp
this.Partition.ReportLoad(new List<LoadMetric> { new LoadMetric("CurrentConnectionCount", 1234), new LoadMetric("metric1", 42) });
```

<span data-ttu-id="752df-261">Un servizio può segnalare in un report una qualsiasi delle metriche definite al momento della creazione.</span><span class="sxs-lookup"><span data-stu-id="752df-261">A service can report on any of the metrics defined for it at creation time.</span></span> <span data-ttu-id="752df-262">Se un servizio segnala il carico per una metrica non configurata per l'utilizzo, Service Fabric ignora il report.</span><span class="sxs-lookup"><span data-stu-id="752df-262">If a service reports load for a metric that it is not configured to use, Service Fabric ignores that report.</span></span> <span data-ttu-id="752df-263">Se nello stesso momento vengono segnalate altre metriche valide, i report vengono accettati.</span><span class="sxs-lookup"><span data-stu-id="752df-263">If there are other metrics reported at the same time that are valid, those reports are accepted.</span></span> <span data-ttu-id="752df-264">Il codice del servizio può eseguire la misurazione e la creazione di report per tutte le metriche configurate e gli operatori possono specificare la configurazione delle metriche da usare senza dover modificare il codice.</span><span class="sxs-lookup"><span data-stu-id="752df-264">Service code can measure and report all the metrics it knows how to, and operators can specify the metric configuration to use without having to change the service code.</span></span> 

### <a name="updating-a-services-metric-configuration"></a><span data-ttu-id="752df-265">Aggiornamento della configurazione delle metriche di un servizio</span><span class="sxs-lookup"><span data-stu-id="752df-265">Updating a service's metric configuration</span></span>
<span data-ttu-id="752df-266">È possibile aggiornare in modo dinamico e in tempo reale l'elenco delle metriche associate al servizio e le proprietà di tali metriche.</span><span class="sxs-lookup"><span data-stu-id="752df-266">The list of metrics associated with the service, and the properties of those metrics can be updated dynamically while the service is live.</span></span> <span data-ttu-id="752df-267">Questo approccio consente di sperimentare con flessibilità.</span><span class="sxs-lookup"><span data-stu-id="752df-267">This allows for experimentation and flexibility.</span></span> <span data-ttu-id="752df-268">Di seguito alcuni esempi che mostrano l'utilità di questo tipo di aggiornamento:</span><span class="sxs-lookup"><span data-stu-id="752df-268">Some examples of when this is useful are:</span></span>

  - <span data-ttu-id="752df-269">disabilitazione di una metrica con un report anomalo per un determinato servizio;</span><span class="sxs-lookup"><span data-stu-id="752df-269">disabling a metric with a buggy report for a particular service</span></span>
  - <span data-ttu-id="752df-270">riconfigurazione dei pesi di metriche in base al comportamento desiderato;</span><span class="sxs-lookup"><span data-stu-id="752df-270">reconfiguring the weights of metrics based on desired behavior</span></span>
  - <span data-ttu-id="752df-271">abilitazione di una nuova metrica solo dopo che il codice è stato distribuito e convalidato tramite altri meccanismi;</span><span class="sxs-lookup"><span data-stu-id="752df-271">enabling a new metric only after the code has already been deployed and validated via other mechanisms</span></span>
  - <span data-ttu-id="752df-272">modifica del carico predefinito per un servizio in base al consumo e al comportamento osservato.</span><span class="sxs-lookup"><span data-stu-id="752df-272">changing the default load for a service based on observed behavior and consumption</span></span>

<span data-ttu-id="752df-273">Le principali API per modificare la configurazione della metrica sono disponibili `FabricClient.ServiceManagementClient.UpdateServiceAsync` in C# e `Update-ServiceFabricService` in PowerShell.</span><span class="sxs-lookup"><span data-stu-id="752df-273">The main APIs for changing metric configuration are `FabricClient.ServiceManagementClient.UpdateServiceAsync` in C# and `Update-ServiceFabricService` in PowerShell.</span></span> <span data-ttu-id="752df-274">Tutte le informazioni specificate con queste API sostituiscono immediatamente le informazioni sulla metrica esistenti relative al servizio.</span><span class="sxs-lookup"><span data-stu-id="752df-274">Whatever information you specify with these APIs replaces the existing metric information for the service immediately.</span></span> 

## <a name="mixing-default-load-values-and-dynamic-load-reports"></a><span data-ttu-id="752df-275">Combinazione di valori di carico predefiniti e report sul carico dinamico</span><span class="sxs-lookup"><span data-stu-id="752df-275">Mixing default load values and dynamic load reports</span></span>
<span data-ttu-id="752df-276">È possibile usare per lo stesso servizio il carico predefinito e carichi dinamici.</span><span class="sxs-lookup"><span data-stu-id="752df-276">Default load and dynamic loads can be used for the same service.</span></span> <span data-ttu-id="752df-277">Quando un servizio usa sia il carico predefinito sia i report di carico dinamici, il carico predefinito funge da stima finché non sono disponibili i report dinamici.</span><span class="sxs-lookup"><span data-stu-id="752df-277">When a service utilizes both default load and dynamic load reports, default load serves as an estimate until dynamic reports show up.</span></span> <span data-ttu-id="752df-278">Il carico predefinito è efficace perché offre a Cluster Resource Manager elementi su cui lavorare.</span><span class="sxs-lookup"><span data-stu-id="752df-278">Default load is good because it gives the Cluster Resource Manager something to work with.</span></span> <span data-ttu-id="752df-279">Consente anche di posizionare in modo ottimale gli oggetti servizio quando vengono creati.</span><span class="sxs-lookup"><span data-stu-id="752df-279">The default load allows the Cluster Resource Manager to place the service objects in good locations when they are created.</span></span> <span data-ttu-id="752df-280">Se non vengono specificate informazione sul carico predefinito, i servizi vengono posizionati in modo casuale.</span><span class="sxs-lookup"><span data-stu-id="752df-280">If no default load information is provided, placement of services is effectively random.</span></span> <span data-ttu-id="752df-281">Quando i report di carico vengono ricevuti in un secondo momento, il posizionamento casuale iniziale è spesso errato e Cluster Resource Manager deve spostare i servizi.</span><span class="sxs-lookup"><span data-stu-id="752df-281">When load reports arrive later the initial random placement is often wrong and the Cluster Resource Manager has to move services.</span></span>

<span data-ttu-id="752df-282">Partendo dall'esempio precedente, è possibile verificare le conseguenze dell'aggiunta di alcune metriche personalizzate e dei report di carico dinamici.</span><span class="sxs-lookup"><span data-stu-id="752df-282">Let’s take our previous example and see what happens when we add some custom metrics and dynamic load reporting.</span></span> <span data-ttu-id="752df-283">In questo esempio verrà usata la metrica "MemoryInMb".</span><span class="sxs-lookup"><span data-stu-id="752df-283">In this example, we use “MemoryInMb” as an example metric.</span></span>

> [!NOTE]
> <span data-ttu-id="752df-284">La memoria è una delle metriche di sistema che Service Fabric è in grado di [controllare come risorsa](service-fabric-resource-governance.md); la creazione manuale dei relativi report in genere è difficile.</span><span class="sxs-lookup"><span data-stu-id="752df-284">Memory is one of the system metrics that Service Fabric can [resource govern](service-fabric-resource-governance.md), and reporting it yourself is typically difficult.</span></span> <span data-ttu-id="752df-285">In realtà non si prevede che l'utente crei report sul consumo di memoria; la memoria viene usata come supporto per comprendere le funzionalità di Cluster Resource Manager,</span><span class="sxs-lookup"><span data-stu-id="752df-285">We don't actually expect you to report on Memory consumption; Memory is used here as an aid to learning about the capabilities of the Cluster Resource Manager.</span></span>
>

<span data-ttu-id="752df-286">e si presuppone che il servizio con stato sia stato inizialmente creato con il comando riportato di seguito.</span><span class="sxs-lookup"><span data-stu-id="752df-286">Let’s presume that we initially created the stateful service with the following command:</span></span>

<span data-ttu-id="752df-287">Powershell:</span><span class="sxs-lookup"><span data-stu-id="752df-287">Powershell:</span></span>

```posh
New-ServiceFabricService -ApplicationName $applicationName -ServiceName $serviceName -ServiceTypeName $serviceTypeName –Stateful -MinReplicaSetSize 3 -TargetReplicaSetSize 3 -PartitionSchemeSingleton –Metric @("MemoryInMb,High,21,11”,"PrimaryCount,Medium,1,0”,"ReplicaCount,Low,1,1”,"Count,Low,1,1”)
```

<span data-ttu-id="752df-288">Si ricordi che la sintassi è ("MetricName, MetricWeight, PrimaryDefaultLoad, SecondaryDefaultLoad").</span><span class="sxs-lookup"><span data-stu-id="752df-288">As a reminder, this syntax is ("MetricName, MetricWeight, PrimaryDefaultLoad, SecondaryDefaultLoad").</span></span>

<span data-ttu-id="752df-289">Un layout di cluster può avere un aspetto analogo al seguente:</span><span class="sxs-lookup"><span data-stu-id="752df-289">Let's see what one possible cluster layout could look like:</span></span>

<span data-ttu-id="752df-290"><center>
![Cluster bilanciato con metriche sia predefinite che personalizzate][Image2]
</center></span><span class="sxs-lookup"><span data-stu-id="752df-290"><center>
![Cluster Balanced with both Default and Custom metrics][Image2]
</center></span></span>

<span data-ttu-id="752df-291">Occorre notare alcuni aspetti:</span><span class="sxs-lookup"><span data-stu-id="752df-291">Some things that are worth noting:</span></span>

* <span data-ttu-id="752df-292">Le repliche secondarie in una partizione possono avere un carico specifico.</span><span class="sxs-lookup"><span data-stu-id="752df-292">Secondary replicas within a partition can each have their own load</span></span>
* <span data-ttu-id="752df-293">Complessivamente, le metriche appaiono bilanciate.</span><span class="sxs-lookup"><span data-stu-id="752df-293">Overall the metrics look balanced.</span></span> <span data-ttu-id="752df-294">Per la memoria, il rapporto tra carico massimo e minimo è 1,75. Il nodo con il carico maggiore è N3, quello con il carico minore è N2 e 28/16 = 1,75.</span><span class="sxs-lookup"><span data-stu-id="752df-294">For Memory, the ratio between the maximum and minimum load is 1.75 (the node with the most load is N3, the least is N2, and 28/16 = 1.75).</span></span>

<span data-ttu-id="752df-295">Restano ancora da spiegare alcuni aspetti:</span><span class="sxs-lookup"><span data-stu-id="752df-295">There are some things that we still need to explain:</span></span>

* <span data-ttu-id="752df-296">In che modo è stato stabilito se un rapporto di 1,75 è ragionevole?</span><span class="sxs-lookup"><span data-stu-id="752df-296">What determined whether a ratio of 1.75 was reasonable or not?</span></span> <span data-ttu-id="752df-297">Come determina Cluster Resource Manager se la configurazione è ottimale o deve essere modificata?</span><span class="sxs-lookup"><span data-stu-id="752df-297">How does the Cluster Resource Manager know if that’s good enough or if there is more work to do?</span></span>
* <span data-ttu-id="752df-298">Quando viene applicato il bilanciamento?</span><span class="sxs-lookup"><span data-stu-id="752df-298">When does balancing happen?</span></span>
* <span data-ttu-id="752df-299">Cosa significa che il peso di Memory è "High"?</span><span class="sxs-lookup"><span data-stu-id="752df-299">What does it mean that Memory was weighted “High”?</span></span>

## <a name="metric-weights"></a><span data-ttu-id="752df-300">Pesi metrici</span><span class="sxs-lookup"><span data-stu-id="752df-300">Metric weights</span></span>
<span data-ttu-id="752df-301">La possibilità di tenere traccia delle stesse metriche in diversi servizi è importante,</span><span class="sxs-lookup"><span data-stu-id="752df-301">Tracking the same metrics across different services is important.</span></span> <span data-ttu-id="752df-302">perché consente a Cluster Resource Manager di tenere traccia del consumo nel cluster, bilanciare il consumo tra i nodi e garantire che non ne venga superata la capacità.</span><span class="sxs-lookup"><span data-stu-id="752df-302">That global view is what allows the Cluster Resource Manager to track consumption in the cluster, balance consumption across nodes, and ensure that nodes don’t go over capacity.</span></span> <span data-ttu-id="752df-303">La stessa metrica, tuttavia, può assumere una diversa importanza per i diversi servizi.</span><span class="sxs-lookup"><span data-stu-id="752df-303">However, services may have different views as to the importance of the same metric.</span></span> <span data-ttu-id="752df-304">In un cluster con molte metriche e numerosi servizi, inoltre, potrebbero non esistere soluzioni perfettamente bilanciate per tutte le metriche.</span><span class="sxs-lookup"><span data-stu-id="752df-304">Also, in a cluster with many metrics and lots of services, perfectly balanced solutions may not exist for all metrics.</span></span> <span data-ttu-id="752df-305">Come devono essere gestite queste situazioni in Cluster Resource Manager?</span><span class="sxs-lookup"><span data-stu-id="752df-305">How should the Cluster Resource Manager handle these situations?</span></span>

<span data-ttu-id="752df-306">I pesi delle metriche consentono a Cluster Resource Manager di decidere come bilanciare il cluster quando non esiste una risposta perfetta,</span><span class="sxs-lookup"><span data-stu-id="752df-306">Metric weights allow the Cluster Resource Manager to decide how to balance the cluster when there’s no perfect answer.</span></span> <span data-ttu-id="752df-307">nonché di bilanciare in modo diverso servizi specifici.</span><span class="sxs-lookup"><span data-stu-id="752df-307">Metric weights also allow the Cluster Resource Manager to balance specific services differently.</span></span> <span data-ttu-id="752df-308">Le metriche possono avere quattro livelli di peso diversi: Zero, Low, Medium e High.</span><span class="sxs-lookup"><span data-stu-id="752df-308">Metrics can have four different weight levels: Zero, Low, Medium, and High.</span></span> <span data-ttu-id="752df-309">Una metrica con peso zero non ha impatto quando si valuta se gli elementi sono bilanciati o meno,</span><span class="sxs-lookup"><span data-stu-id="752df-309">A metric with a weight of Zero contributes nothing when considering whether things are balanced or not.</span></span> <span data-ttu-id="752df-310">ma il suo carico ha conseguenze sulla gestione della capacità.</span><span class="sxs-lookup"><span data-stu-id="752df-310">However, its load does still contribute to capacity management.</span></span> <span data-ttu-id="752df-311">Le metriche con peso zero sono comunque utili e vengono spesso usate come componenti del comportamento del servizio e del monitoraggio delle prestazioni.</span><span class="sxs-lookup"><span data-stu-id="752df-311">Metrics with Zero weight are still useful and are frequently used as a part of service behavior and performance monitoring.</span></span> <span data-ttu-id="752df-312">[Questo articolo](service-fabric-diagnostics-event-generation-infra.md) offre altre informazioni sull'uso delle metriche per il monitoraggio e la diagnostica dei servizi.</span><span class="sxs-lookup"><span data-stu-id="752df-312">[This article](service-fabric-diagnostics-event-generation-infra.md) provides more information on the use of metrics for monitoring and diagnostics of your services.</span></span> 

<span data-ttu-id="752df-313">L'impatto effettivo di pesi delle metriche diversi nel cluster consiste nel fatto che Cluster Resource Manager genera soluzioni diverse.</span><span class="sxs-lookup"><span data-stu-id="752df-313">The real impact of different metric weights in the cluster is that the Cluster Resource Manager generates different solutions.</span></span> <span data-ttu-id="752df-314">I pesi indicano a Cluster Resource Manager che determinate metriche sono più importanti di altre.</span><span class="sxs-lookup"><span data-stu-id="752df-314">Metric weights tell the Cluster Resource Manager that certain metrics are more important than others.</span></span> <span data-ttu-id="752df-315">Quando non esiste una soluzione perfetta, Cluster Resource Manager può preferire soluzioni con un migliore bilanciamento delle metriche con peso superiore.</span><span class="sxs-lookup"><span data-stu-id="752df-315">When there's no perfect solution the Cluster Resource Manager can prefer solutions which balance the higher weighted metrics better.</span></span> <span data-ttu-id="752df-316">Se una particolare metrica non è importante per un servizio, potrebbe sbilanciarne l'uso</span><span class="sxs-lookup"><span data-stu-id="752df-316">If a service thinks a particular metric is unimportant, it may find their use of that metric imbalanced.</span></span> <span data-ttu-id="752df-317">in modo da garantire a un altro servizio, per cui è importante, una distribuzione uniforme.</span><span class="sxs-lookup"><span data-stu-id="752df-317">This allows another service to get an even distribution of some metric that is important to it.</span></span>

<span data-ttu-id="752df-318">L'esempio seguente illustra alcuni report di carico e come pesi diversi delle metriche possono determinare allocazioni diverse nel cluster.</span><span class="sxs-lookup"><span data-stu-id="752df-318">Let’s look at an example of some load reports and how different metric weights results in different allocations in the cluster.</span></span> <span data-ttu-id="752df-319">In questo esempio si può notare che la modifica del peso relativo delle metriche fa sì che Cluster Resource Manager crei disposizioni diverse dei servizi.</span><span class="sxs-lookup"><span data-stu-id="752df-319">In this example, we see that switching the relative weight of the metrics causes the Cluster Resource Manager to create different arrangements of services.</span></span>

<span data-ttu-id="752df-320"><center>
![Esempio di peso delle metriche e del relativo impatto sulle soluzioni di bilanciamento][Image3]
</center></span><span class="sxs-lookup"><span data-stu-id="752df-320"><center>
![Metric Weight Example and Its Impact on Balancing Solutions][Image3]
</center></span></span>

<span data-ttu-id="752df-321">In questo esempio sono presenti quattro diversi servizi, tutti con valori diversi nei report di due diverse metriche, MetricA e MetricB.</span><span class="sxs-lookup"><span data-stu-id="752df-321">In this example, there are four different services, all reporting different values for two different metrics, MetricA and MetricB.</span></span> <span data-ttu-id="752df-322">In un caso, tutti i servizi definiscono MetricA come la più importante (Peso = High) e MetricB come non importante (Peso = Low).</span><span class="sxs-lookup"><span data-stu-id="752df-322">In one case, all the services define MetricA is the most important one (Weight = High) and MetricB as unimportant (Weight = Low).</span></span> <span data-ttu-id="752df-323">Di conseguenza, Cluster Resource Manager posiziona i servizi in modo da ottenere per MetricA un bilanciamento migliore rispetto a MetricB.</span><span class="sxs-lookup"><span data-stu-id="752df-323">As a result, we see that the Cluster Resource Manager places the services so that MetricA is better balanced than MetricB.</span></span> <span data-ttu-id="752df-324">"Bilanciamento migliore" significa che MetricA presenta una deviazione standard inferiore rispetto a MetricB.</span><span class="sxs-lookup"><span data-stu-id="752df-324">"Better balanced" means that MetricA has a lower has a lower standard deviation than MetricB.</span></span> <span data-ttu-id="752df-325">Nel secondo caso, i pesi delle metriche sono invertiti.</span><span class="sxs-lookup"><span data-stu-id="752df-325">In the second case, we reverse the metric weights.</span></span> <span data-ttu-id="752df-326">Di conseguenza, Cluster Resource Manager scambia i servizi A e B in modo da ottenere un'allocazione in cui il bilanciamento di MetricB è migliore rispetto a MetricA.</span><span class="sxs-lookup"><span data-stu-id="752df-326">As a result, the Cluster Resource Manager swaps services A and B to come up with an allocation where MetricB is better balanced than MetricA.</span></span>

> [!NOTE]
> <span data-ttu-id="752df-327">I pesi della metrica determinano il modo in cui Cluster Resource Manager esegue il bilanciamento, ma non quando questo debba verificarsi.</span><span class="sxs-lookup"><span data-stu-id="752df-327">Metric weights determine how the Cluster Resource Manager should balance, but not when balancing should happen.</span></span> <span data-ttu-id="752df-328">Per altre informazioni sul bilanciamento, vedere [questo articolo](service-fabric-cluster-resource-manager-balancing.md).</span><span class="sxs-lookup"><span data-stu-id="752df-328">For more information on balancing, check out [this article](service-fabric-cluster-resource-manager-balancing.md)</span></span>
>

### <a name="global-metric-weights"></a><span data-ttu-id="752df-329">Pesi metrici globali</span><span class="sxs-lookup"><span data-stu-id="752df-329">Global metric weights</span></span>
<span data-ttu-id="752df-330">Si supponga che ServiceA definisca il peso di MetricA come High e ServiceB imposta il peso di MetricA su Low o Zero.</span><span class="sxs-lookup"><span data-stu-id="752df-330">Let's say ServiceA defines MetricA as weight High, and ServiceB sets the weight for MetricA to Low or Zero.</span></span> <span data-ttu-id="752df-331">Qual è il peso che verrà effettivamente usato?</span><span class="sxs-lookup"><span data-stu-id="752df-331">What’s the actual weight that ends up getting used?</span></span>

<span data-ttu-id="752df-332">Per ogni metrica esistono più pesi di cui tenere traccia.</span><span class="sxs-lookup"><span data-stu-id="752df-332">There are multiple weights that are tracked for every metric.</span></span> <span data-ttu-id="752df-333">Il primo peso è quello definito per la metrica al momento della creazione del servizio.</span><span class="sxs-lookup"><span data-stu-id="752df-333">The first weight is the one defined for the metric when the service is created.</span></span> <span data-ttu-id="752df-334">L'altro è un peso globale, che viene calcolato automaticamente.</span><span class="sxs-lookup"><span data-stu-id="752df-334">The other weight is a global weight, which is computed automatically.</span></span> <span data-ttu-id="752df-335">Cluster Resource Manager usa entrambi questi pesi per calcolare i punteggi delle soluzioni.</span><span class="sxs-lookup"><span data-stu-id="752df-335">The Cluster Resource Manager uses both these weights when scoring solutions.</span></span> <span data-ttu-id="752df-336">Considerare entrambi i pesi è importante.</span><span class="sxs-lookup"><span data-stu-id="752df-336">Taking both weights into account is important.</span></span> <span data-ttu-id="752df-337">Ciò consente a Cluster Resource Manager di bilanciare ogni servizio in base alle relative priorità e di verificare anche che il cluster nel suo complesso sia stato allocato correttamente.</span><span class="sxs-lookup"><span data-stu-id="752df-337">This allows the Cluster Resource Manager to balance each service according to its own priorities, and also ensure that the cluster as a whole is allocated correctly.</span></span>

<span data-ttu-id="752df-338">Se Cluster Resource Manager non tiene conto del bilanciamento globale e locale,</span><span class="sxs-lookup"><span data-stu-id="752df-338">What would happen if the Cluster Resource Manager didn’t care about both global and local balance?</span></span> <span data-ttu-id="752df-339">si possono avere soluzioni bilanciate a livello globale, ma che determinano allocazioni inefficienti delle risorse per i singoli servizi.</span><span class="sxs-lookup"><span data-stu-id="752df-339">Well, it’s easy to construct solutions that are globally balanced, but which result in poor resource balance for individual services.</span></span> <span data-ttu-id="752df-340">L'esempio seguente illustra un servizio configurato esclusivamente con le metriche predefinite e mostra cosa accade se viene considerato solo il bilanciamento globale:</span><span class="sxs-lookup"><span data-stu-id="752df-340">In the following example, let’s look at a service configured with just the default metrics, and see what happens when only global balance is considered:</span></span>

<span data-ttu-id="752df-341"><center>
![Impatto di una soluzione solo globale][Image4]
</center></span><span class="sxs-lookup"><span data-stu-id="752df-341"><center>
![The Impact of a Global Only Solution][Image4]
</center></span></span>

<span data-ttu-id="752df-342">Nell'esempio in alto, basato solo sul bilanciamento globale, il cluster nel suo complesso è effettivamente bilanciato.</span><span class="sxs-lookup"><span data-stu-id="752df-342">In the top example based only on global balance, the cluster as a whole is indeed balanced.</span></span> <span data-ttu-id="752df-343">Tutti i nodi hanno lo stesso numero di repliche primarie e di repliche totali.</span><span class="sxs-lookup"><span data-stu-id="752df-343">All nodes have the same count of primaries and the same number total replicas.</span></span> <span data-ttu-id="752df-344">Se tuttavia si esamina l'impatto effettivo di questa allocazione, si notano alcuni problemi. La perdita di un nodo influisce in modo sproporzionato su un carico di lavoro specifico, perché rende inattive tutte le repliche primarie.</span><span class="sxs-lookup"><span data-stu-id="752df-344">However, if you look at the actual impact of this allocation it’s not so good: the loss of any node impacts a particular workload disproportionately, because it takes out all of its primaries.</span></span> <span data-ttu-id="752df-345">In caso di errore nel primo nodo, ad esempio, tutte e tre le repliche primarie per le tre diverse partizioni del servizio rappresentato con il cerchio andrebbero perse.</span><span class="sxs-lookup"><span data-stu-id="752df-345">For example, if the first node fails the three primaries for the three different partitions of the Circle service would all be lost.</span></span> <span data-ttu-id="752df-346">Le partizioni dei servizi rappresentati con il triangolo e con l'esagono perdono invece una replica.</span><span class="sxs-lookup"><span data-stu-id="752df-346">Conversely, the Triangle and Hexagon services have their partitions lose a replica.</span></span> <span data-ttu-id="752df-347">L'unica interruzione di servizio, in questo caso, consiste nel ripristinare la replica perduta.</span><span class="sxs-lookup"><span data-stu-id="752df-347">This causes no disruption, other than having to recover the down replica.</span></span>

<span data-ttu-id="752df-348">Nell'esempio in basso, Cluster Resource Manager ha distribuito le repliche in base al bilanciamento globale e per i singoli servizi.</span><span class="sxs-lookup"><span data-stu-id="752df-348">In the bottom example, the Cluster Resource Manager has distributed the replicas based on both the global and per-service balance.</span></span> <span data-ttu-id="752df-349">Quando calcola il punteggio della soluzione, assegna la maggior parte del peso alla soluzione globale e una parte (configurabile) ai singoli servizi.</span><span class="sxs-lookup"><span data-stu-id="752df-349">When calculating the score of the solution it gives most of the weight to the global solution, and a (configurable) portion to individual services.</span></span> <span data-ttu-id="752df-350">Il bilanciamento globale della metrica viene calcolato in base alla media dei pesi delle metriche per ogni servizio.</span><span class="sxs-lookup"><span data-stu-id="752df-350">Global balance for a metric is calculated based on the average of the metric weights from each service.</span></span> <span data-ttu-id="752df-351">Ogni servizio viene bilanciato in base ai pesi delle metriche specificamente definiti.</span><span class="sxs-lookup"><span data-stu-id="752df-351">Each service is balanced according to its own defined metric weights.</span></span> <span data-ttu-id="752df-352">In questo modo, i servizi sono bilanciati internamente in base alle specifiche esigenze.</span><span class="sxs-lookup"><span data-stu-id="752df-352">This ensures that the services are balanced within themselves according to their own needs.</span></span> <span data-ttu-id="752df-353">In caso di errore nel primo nodo, quindi, la perdita viene distribuita in tutte le partizioni di tutti i servizi.</span><span class="sxs-lookup"><span data-stu-id="752df-353">As a result, if the same first node fails the failure is distributed across all partitions of all services.</span></span> <span data-ttu-id="752df-354">L'impatto su ogni elemento è uguale.</span><span class="sxs-lookup"><span data-stu-id="752df-354">The impact to each is the same.</span></span>

## <a name="next-steps"></a><span data-ttu-id="752df-355">Passaggi successivi</span><span class="sxs-lookup"><span data-stu-id="752df-355">Next steps</span></span>
- <span data-ttu-id="752df-356">Per altre informazioni sulla configurazione dei servizi vedere [Informazioni sulla configurazione dei servizi](service-fabric-cluster-resource-manager-configure-services.md)(service-fabric-cluster-resource-manager-configure-services.md)</span><span class="sxs-lookup"><span data-stu-id="752df-356">For more information on configuring services, [Learn about configuring Services](service-fabric-cluster-resource-manager-configure-services.md)(service-fabric-cluster-resource-manager-configure-services.md)</span></span>
- <span data-ttu-id="752df-357">Definire la metrica di deframmentazione rappresenta un modo per consolidare il carico sui nodi anziché distribuirlo. Per informazioni su come configurare la deframmentazione, vedere [questo articolo](service-fabric-cluster-resource-manager-defragmentation-metrics.md)</span><span class="sxs-lookup"><span data-stu-id="752df-357">Defining Defragmentation Metrics is one way to consolidate load on nodes instead of spreading it out. To learn how to configure defragmentation, refer to [this article](service-fabric-cluster-resource-manager-defragmentation-metrics.md)</span></span>
- <span data-ttu-id="752df-358">Per informazioni sul modo in cui Cluster Resource Manager gestisce e bilancia il carico nel cluster, vedere l'articolo relativo al [bilanciamento del carico](service-fabric-cluster-resource-manager-balancing.md)</span><span class="sxs-lookup"><span data-stu-id="752df-358">To find out about how the Cluster Resource Manager manages and balances load in the cluster, check out the article on [balancing load](service-fabric-cluster-resource-manager-balancing.md)</span></span>
- <span data-ttu-id="752df-359">Partire dall'inizio e vedere l' [introduzione a Cluster Resource Manager di Service Fabric](service-fabric-cluster-resource-manager-introduction.md)</span><span class="sxs-lookup"><span data-stu-id="752df-359">Start from the beginning and [get an Introduction to the Service Fabric Cluster Resource Manager](service-fabric-cluster-resource-manager-introduction.md)</span></span>
- <span data-ttu-id="752df-360">Il costo dello spostamento è un modo per segnalare a Cluster Resource Manager che alcuni servizi sono più costosi da spostare rispetto ad altri.</span><span class="sxs-lookup"><span data-stu-id="752df-360">Movement Cost is one way of signaling to the Cluster Resource Manager that certain services are more expensive to move than others.</span></span> <span data-ttu-id="752df-361">Per altre informazioni sui costi di spostamento, vedere [questo articolo](service-fabric-cluster-resource-manager-movement-cost.md)</span><span class="sxs-lookup"><span data-stu-id="752df-361">To learn more about movement cost, refer to [this article](service-fabric-cluster-resource-manager-movement-cost.md)</span></span>

[Image1]:./media/service-fabric-cluster-resource-manager-metrics/cluster-resource-manager-cluster-layout-with-default-metrics.png
[Image2]:./media/service-fabric-cluster-resource-manager-metrics/Service-Fabric-Resource-Manager-Dynamic-Load-Reports.png
[Image3]:./media/service-fabric-cluster-resource-manager-metrics/cluster-resource-manager-metric-weights-impact.png
[Image4]:./media/service-fabric-cluster-resource-manager-metrics/cluster-resource-manager-global-vs-local-balancing.png
