---
title: Configurare VMM e Hyper-V per la replica in un sito secondario con Azure Site Recovery | Microsoft Docs
description: Descrive come configurare i server di System Center VMM e gli host Hyper-V per la replica in un sito VMM secondario.
services: site-recovery
documentationcenter: 
author: rayne-wiselman
manager: carmonm
editor: 
ms.assetid: d0389e3b-3737-496c-bda6-77152264dd98
ms.service: site-recovery
ms.workload: storage-backup-recovery
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/30/2017
ms.author: raynew
ms.openlocfilehash: 73bd1790c56ac52166f638de2e80c2a2cfb87e53
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/03/2017
---
# <a name="step-4-set-up-vmm-and-hyper-v-for-hyper-v-vm-replication-to-a-secondary-site"></a><span data-ttu-id="58151-103">Passaggio 4: Configurare VMM e Hyper-V per la replica di VM Hyper-V in un sito secondario</span><span class="sxs-lookup"><span data-stu-id="58151-103">Step 4: Set up VMM and Hyper-V for Hyper-V VM replication to a secondary site</span></span> 

<span data-ttu-id="58151-104">Dopo aver predisposto la rete, configurare i server di System Center Virtual Machine Manager (VMM) e gli host Hyper-V per la replica di macchine virtuali Hyper-V in un sito secondario tramite [Azure Site Recovery](site-recovery-overview.md) nel portale di Azure.</span><span class="sxs-lookup"><span data-stu-id="58151-104">After you've prepared for networking, set up System Center Virtual Machine Manager (VMM) servers and Hyper-V hosts for Hyper-V virtual machine (VM) replication to a secondary site, using [Azure Site Recovery](site-recovery-overview.md) in the Azure portal.</span></span> 

<span data-ttu-id="58151-105">È possibile inviare commenti nella parte inferiore di questo articolo oppure nel [forum sui servizi di ripristino di Azure](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span><span class="sxs-lookup"><span data-stu-id="58151-105">After reading this article, post any comments at the bottom, or on the [Azure Recovery Services Forum](https://social.msdn.microsoft.com/forums/azure/home?forum=hypervrecovmgr).</span></span>



## <a name="prepare-vmm-servers"></a><span data-ttu-id="58151-106">Preparare i server VMM</span><span class="sxs-lookup"><span data-stu-id="58151-106">Prepare VMM servers</span></span> 

<span data-ttu-id="58151-107">Preparare la distribuzione:</span><span class="sxs-lookup"><span data-stu-id="58151-107">To prepare for deployment:</span></span>


1. <span data-ttu-id="58151-108">Assicurarsi che i server VMM siano conformi ai [requisiti di supporto](site-recovery-support-matrix-to-sec-site.md#on-premises-servers) e ai [prerequisiti di distribuzione](vmm-to-vmm-walkthrough-prerequisites.md).</span><span class="sxs-lookup"><span data-stu-id="58151-108">Make sure VMM servers comply with the [support requirements](site-recovery-support-matrix-to-sec-site.md#on-premises-servers), and [deployment prerequisites](vmm-to-vmm-walkthrough-prerequisites.md).</span></span>
2. <span data-ttu-id="58151-109">Verificare che i server VMM siano connessi a Internet e abbiano accesso a questi URL.</span><span class="sxs-lookup"><span data-stu-id="58151-109">Make sure VMM servers are connected to the internet and have access to these URLs.</span></span>
    
    [!INCLUDE [site-recovery-URLS](../../includes/site-recovery-URLS.md)]
    
    - <span data-ttu-id="58151-110">Se sono presenti regole del firewall basate sull'indirizzo IP, verificare che consentano la comunicazione con Azure.</span><span class="sxs-lookup"><span data-stu-id="58151-110">If you have IP address-based firewall rules, ensure they allow communication to Azure.</span></span>
    - <span data-ttu-id="58151-111">Consentire gli [intervalli IP del data center di Azure ](https://www.microsoft.com/download/confirmation.aspx?id=41653) e la porta HTTPS (443).</span><span class="sxs-lookup"><span data-stu-id="58151-111">Allow the [Azure Datacenter IP Ranges](https://www.microsoft.com/download/confirmation.aspx?id=41653), and the HTTPS (443) port.</span></span>
    - <span data-ttu-id="58151-112">Consentire gli intervalli di indirizzi IP per l'area di Azure della sottoscrizione e per gli Stati Uniti occidentali (usati per il controllo di accesso e la gestione delle identità).</span><span class="sxs-lookup"><span data-stu-id="58151-112">Allow IP address ranges for the Azure region of your subscription, and for West US (used for Access Control and Identity Management).</span></span>
3. <span data-ttu-id="58151-113">Assicurarsi che il server VMM sia [pronto per il mapping di rete](vmm-to-vmm-walkthrough-network.md#prepare-for-network-mapping)</span><span class="sxs-lookup"><span data-stu-id="58151-113">Make sure the VMM server is [prepared for network mapping](vmm-to-vmm-walkthrough-network.md#prepare-for-network-mapping)</span></span>


## <a name="prepare-hyper-v-hostsclusters"></a><span data-ttu-id="58151-114">Preparare gli host/cluster Hyper-V</span><span class="sxs-lookup"><span data-stu-id="58151-114">Prepare Hyper-V hosts/clusters</span></span>

1. <span data-ttu-id="58151-115">Assicurarsi che gli host/cluster Hyper-V siano conformi ai [requisiti di supporto](site-recovery-support-matrix-to-sec-site.md#on-premises-servers) e ai [prerequisiti di distribuzione](vmm-to-vmm-walkthrough-prerequisites.md).</span><span class="sxs-lookup"><span data-stu-id="58151-115">Make sure Hyper-V hosts/clusters comply with the [support requirements](site-recovery-support-matrix-to-sec-site.md#on-premises-servers), and [deployment prerequisites](vmm-to-vmm-walkthrough-prerequisites.md).</span></span>
2. <span data-ttu-id="58151-116">Verificare i requisiti per le [VM Hyper-V](site-recovery-support-matrix-to-sec-site.md#support-for-replicated-machine-os-versions)</span><span class="sxs-lookup"><span data-stu-id="58151-116">Verify the requirements for [Hyper-V VMs](site-recovery-support-matrix-to-sec-site.md#support-for-replicated-machine-os-versions)</span></span>
3. <span data-ttu-id="58151-117">Verificare i requisiti di [rete](site-recovery-support-matrix-to-sec-site.md#network-configuration) e [archiviazione](site-recovery-support-matrix-to-sec-site.md#storage).</span><span class="sxs-lookup"><span data-stu-id="58151-117">Verify [network](site-recovery-support-matrix-to-sec-site.md#network-configuration) and [storage](site-recovery-support-matrix-to-sec-site.md#storage) requirements.</span></span>
4. <span data-ttu-id="58151-118">Verificare che gli host Hyper-V siano connessi a Internet e abbiano accesso a questi URL.</span><span class="sxs-lookup"><span data-stu-id="58151-118">Make sure Hyper-V hosts are connected to the internet and have access to these URLs.</span></span>
    
    [!INCLUDE [site-recovery-URLS](../../includes/site-recovery-URLS.md)]
    
    - <span data-ttu-id="58151-119">Se sono presenti regole del firewall basate sull'indirizzo IP, verificare che consentano la comunicazione con Azure.</span><span class="sxs-lookup"><span data-stu-id="58151-119">If you have IP address-based firewall rules, ensure they allow communication to Azure.</span></span>
    - <span data-ttu-id="58151-120">Consentire gli [intervalli IP del data center di Azure ](https://www.microsoft.com/download/confirmation.aspx?id=41653) e la porta HTTPS (443).</span><span class="sxs-lookup"><span data-stu-id="58151-120">Allow the [Azure Datacenter IP Ranges](https://www.microsoft.com/download/confirmation.aspx?id=41653), and the HTTPS (443) port.</span></span>
    - <span data-ttu-id="58151-121">Consentire gli intervalli di indirizzi IP per l'area di Azure della sottoscrizione e per gli Stati Uniti occidentali (usati per il controllo di accesso e la gestione delle identità).</span><span class="sxs-lookup"><span data-stu-id="58151-121">Allow IP address ranges for the Azure region of your subscription, and for West US (used for Access Control and Identity Management).</span></span>

## <a name="prepare-for-single-server-deployment"></a><span data-ttu-id="58151-122">Prepararsi per una distribuzione a server singolo</span><span class="sxs-lookup"><span data-stu-id="58151-122">Prepare for single server deployment</span></span>


<span data-ttu-id="58151-123">Se è disponibile un unico server VMM, è possibile replicare le macchine virtuali degli host Hyper-V presenti nel cloud VMM in [Azure](hyper-v-site-walkthrough-overview.md) o in un cloud VMM secondario, come descritto in questo documento.</span><span class="sxs-lookup"><span data-stu-id="58151-123">If you only have a single VMM server, you can replicate VMs in Hyper-V hosts in the VMM cloud to [Azure](hyper-v-site-walkthrough-overview.md) or to a secondary VMM cloud, as described in this document.</span></span> <span data-ttu-id="58151-124">La prima opzione è consigliabile perché la replica tra cloud non è uniforme.</span><span class="sxs-lookup"><span data-stu-id="58151-124">We recommend the first option because replicating between clouds isn't seamless.</span></span>

<span data-ttu-id="58151-125">Se si desidera replicare tra cloud, è possibile replicare con un singolo server VMM autonomo o con un singolo server VMM distribuito in un cluster di Windows esteso</span><span class="sxs-lookup"><span data-stu-id="58151-125">If you do want to replicate between clouds, you can replicate with a single standalone VMM server, or with a single VMM server deployed in a stretched Windows cluster</span></span>

### <a name="replicate-with-a-standalone-vmm-server"></a><span data-ttu-id="58151-126">Eseguire la replica con un server VMM autonomo</span><span class="sxs-lookup"><span data-stu-id="58151-126">Replicate with a standalone VMM server</span></span>

<span data-ttu-id="58151-127">In questo scenario distribuire il singolo server VMM come macchina virtuale nel sito primario e replicare questa VM in un sito secondario con Site Recovery e Hyper-V Replica.</span><span class="sxs-lookup"><span data-stu-id="58151-127">In this scenario, you deploy the single VMM server as a virtual machine in the primary site, and replicate this VM to a secondary site using Site Recovery and Hyper-V Replica.</span></span>

1. <span data-ttu-id="58151-128">**Configurare VMM in una VM Hyper-V**.</span><span class="sxs-lookup"><span data-stu-id="58151-128">**Set up VMM on a Hyper-V VM**.</span></span> <span data-ttu-id="58151-129">È consigliabile condividere il percorso dell'istanza di SQL Server usata da VMM nella stessa macchina virtuale.</span><span class="sxs-lookup"><span data-stu-id="58151-129">We suggest that you colocate the SQL Server instance used by VMM on the same VM.</span></span> <span data-ttu-id="58151-130">In questo modo, infatti, deve essere creata una sola macchina virtuale, con un conseguente risparmio di tempo.</span><span class="sxs-lookup"><span data-stu-id="58151-130">This saves time as only one VM has to be created.</span></span> <span data-ttu-id="58151-131">Se si vuole usare un'istanza remota di SQL Server e si verifica un'interruzione, è necessario ripristinare l'istanza prima di ripristinare VMM.</span><span class="sxs-lookup"><span data-stu-id="58151-131">If you want to use remote instance of SQL Server and an outage occurs, you need to recover that instance before you can recover VMM.</span></span>
2. <span data-ttu-id="58151-132">**Assicurarsi che il server VMM abbia almeno due cloud configurati**.</span><span class="sxs-lookup"><span data-stu-id="58151-132">**Ensure the VMM server has at least two clouds configured**.</span></span> <span data-ttu-id="58151-133">Un cloud conterrà le VM da replicare e l’altro cloud verrà usato come posizione secondaria.</span><span class="sxs-lookup"><span data-stu-id="58151-133">One cloud will contain the VMs you want to replicate and the other cloud will serve as the secondary location.</span></span> <span data-ttu-id="58151-134">Il cloud che contiene le VM da proteggere deve essere conforme ai [prerequisiti](#prerequisites).</span><span class="sxs-lookup"><span data-stu-id="58151-134">The cloud that contains the VMs you want to protect should comply with [prerequisites](#prerequisites).</span></span>
3. <span data-ttu-id="58151-135">Configurare Site Recovery come descritto in questo articolo.</span><span class="sxs-lookup"><span data-stu-id="58151-135">Set up Site Recovery as described in this article.</span></span> <span data-ttu-id="58151-136">Creare e registrare il server VMM in un insieme di credenziali, impostare un criterio di replica e abilitare la replica.</span><span class="sxs-lookup"><span data-stu-id="58151-136">Create and register the VMM server in a vault, set up a replication policy, and enable replication.</span></span> <span data-ttu-id="58151-137">I nomi VMM di origine e di destinazione saranno uguali.</span><span class="sxs-lookup"><span data-stu-id="58151-137">The source and target VMM names will be the same.</span></span> <span data-ttu-id="58151-138">Specificare che la replica iniziale venga eseguita tramite la rete.</span><span class="sxs-lookup"><span data-stu-id="58151-138">Specify that initial replication takes place over the network.</span></span>
4. <span data-ttu-id="58151-139">Se si configura il mapping di rete, verrà eseguito il mapping della rete VM relativa al cloud primario alla rete VM relativa al cloud secondario.</span><span class="sxs-lookup"><span data-stu-id="58151-139">When you set up network mapping you map the VM network for the primary cloud to the VM network for the secondary cloud.</span></span>
5. <span data-ttu-id="58151-140">Nella console di gestione Hyper-V, abilitare la Replica Hyper-V nell'host Hyper-V che contiene le VM VMM e abilitare la replica sulla VM.</span><span class="sxs-lookup"><span data-stu-id="58151-140">In the Hyper-V Manager console, enable Hyper-V Replica on the Hyper-V host that contains the VMM VM, and enable replication on the VM.</span></span> <span data-ttu-id="58151-141">Assicurarsi di non aggiungere la macchina virtuale VMM ai cloud protetti mediante Ripristino sito, per garantire che le impostazioni di Replica Hyper-V non siano sottoposte a override da Ripristino sito.</span><span class="sxs-lookup"><span data-stu-id="58151-141">Make sure you don't add the VMM virtual machine to clouds that are protected by Site Recovery, to ensure that Hyper-V Replica settings aren't overridden by Site Recovery.</span></span>
6. <span data-ttu-id="58151-142">Se si creano piani di ripristino per il failover, si userà lo stesso server VMM per l'origine e la destinazione.</span><span class="sxs-lookup"><span data-stu-id="58151-142">If you create recovery plans for failover you use the same VMM server for source and target.</span></span>
7. <span data-ttu-id="58151-143">In caso di interruzione totale, eseguire il failover e il ripristino come riportato di seguito:</span><span class="sxs-lookup"><span data-stu-id="58151-143">In a complete outage, you fail over and recover as follows:</span></span>

   1. <span data-ttu-id="58151-144">Nella console di gestione Hyper-V nel sito secondario, eseguire un failover non pianificato per eseguire il failover della macchina virtuale VMM primaria al sito secondario.</span><span class="sxs-lookup"><span data-stu-id="58151-144">Run an unplanned failover in the Hyper-V Manager console in the secondary site, to fail over the primary VMM VM to the secondary site.</span></span>
   2. <span data-ttu-id="58151-145">Verificare che la macchina virtuale VMM sia attiva e in esecuzione e, nell'insieme di credenziali, eseguire un failover non pianificato per eseguire il failover delle macchine virtuali dal cloud primario a quello secondario.</span><span class="sxs-lookup"><span data-stu-id="58151-145">Verify that the VMM VM is up and running, and in the vault, run an unplanned failover to fail over the VMs from primary to secondary clouds.</span></span> <span data-ttu-id="58151-146">Eseguire il commit del failover e selezionare un punto di ripristino alternativo, se necessario.</span><span class="sxs-lookup"><span data-stu-id="58151-146">Commit the failover, and select an alternate recovery point if required.</span></span>
   3. <span data-ttu-id="58151-147">Al termine del failover non pianificato, è di nuovo possibile accedere a tutte le risorse dal sito primario.</span><span class="sxs-lookup"><span data-stu-id="58151-147">After the unplanned failover is complete, all resources can be accessed from the primary site again.</span></span>
   4. <span data-ttu-id="58151-148">Quando il sito primario sarà nuovamente disponibile, abilitare la replica inversa per la macchina virtuale VMM nella console di gestione Hyper-V nel sito secondario.</span><span class="sxs-lookup"><span data-stu-id="58151-148">When the primary site is available again, in the Hyper-V Manager console in the secondary site, enable reverse replication for the VMM VM.</span></span> <span data-ttu-id="58151-149">Verrà avviata la replica per la macchina virtuale dal sito secondario al sito primario.</span><span class="sxs-lookup"><span data-stu-id="58151-149">This starts replication for the VM from secondary to primary.</span></span>
   5. <span data-ttu-id="58151-150">Nella console di gestione Hyper-V nel sito secondario, eseguire un failover pianificato per eseguire il failover della macchina virtuale VMM al sito primario.</span><span class="sxs-lookup"><span data-stu-id="58151-150">Run a planned failover in the Hyper-V Manager console in the secondary site, to fail over the VMM VM to the primary site.</span></span> <span data-ttu-id="58151-151">Eseguire il commit del failover.</span><span class="sxs-lookup"><span data-stu-id="58151-151">Commit the failover.</span></span> <span data-ttu-id="58151-152">Viene abilitata la replica inversa per avviare nuovamente la replica della macchina virtuale VMM dal sito primario a quello secondario.</span><span class="sxs-lookup"><span data-stu-id="58151-152">Then enable reverse replication, so that the VMM VM is again replicating from primary to secondary.</span></span>
   6. <span data-ttu-id="58151-153">Nell'insieme di credenziali dei Servizi di ripristino abilitare la replica inversa per le VM del carico di lavoro per avviarne la replica dal sito secondario a quello primario.</span><span class="sxs-lookup"><span data-stu-id="58151-153">In the Recovery Services vault, enable reverse replication for the workload VMs, to start replicating them from secondary to primary.</span></span>
   7. <span data-ttu-id="58151-154">Nell'insieme di credenziali dei Servizi di ripristino eseguire un failover pianificato per eseguire il failback delle VM del carico di lavoro nel sito primario.</span><span class="sxs-lookup"><span data-stu-id="58151-154">In the Recovery Services vault, run a planned failover to fail back the workload VMs to the primary site.</span></span> <span data-ttu-id="58151-155">Eseguire il commit del failover per completare le operazioni.</span><span class="sxs-lookup"><span data-stu-id="58151-155">Commit the failover to complete it.</span></span> <span data-ttu-id="58151-156">Abilitare la replica inversa per avviare la replica delle VM del carico di lavoro dal sito primario a quello secondario.</span><span class="sxs-lookup"><span data-stu-id="58151-156">Then enable reverse replication to start replicating the workload VMs from primary to secondary.</span></span>

### <a name="replicate-with-a-stretched-vmm-cluster"></a><span data-ttu-id="58151-157">Eseguire la replica con un cluster VMM con estensione</span><span class="sxs-lookup"><span data-stu-id="58151-157">Replicate with a stretched VMM cluster</span></span>

<span data-ttu-id="58151-158">Anziché distribuire un server VMM autonomo come VM che replica in un sito secondario, è possibile garantire la disponibilità elevata di VMM distribuendolo come VM in un cluster di failover di Windows,</span><span class="sxs-lookup"><span data-stu-id="58151-158">Instead of deploying a standalone VMM server as a VM that replicates to a secondary site, you can make VMM highly available by deploying it as a VM in a Windows failover cluster.</span></span> <span data-ttu-id="58151-159">assicurando così flessibilità al carico di lavoro e protezione da errori hardware.</span><span class="sxs-lookup"><span data-stu-id="58151-159">This provides workload resilience and protection against hardware failure.</span></span> <span data-ttu-id="58151-160">Per effettuare la distribuzione usando Site Recovery, la macchina virtuale di VMM deve essere distribuita in un cluster esteso in siti geograficamente separati.</span><span class="sxs-lookup"><span data-stu-id="58151-160">To deploy with Site Recovery the VMM VM should be deployed in a stretch cluster across geographically separate sites.</span></span> <span data-ttu-id="58151-161">A tale scopo, seguire questa procedura:</span><span class="sxs-lookup"><span data-stu-id="58151-161">To do this:</span></span>

1. <span data-ttu-id="58151-162">Installare VMM su una macchina virtuale in un cluster di failover di Windows e selezionare l'opzione per eseguire il server come disponibilità elevata durante l'installazione.</span><span class="sxs-lookup"><span data-stu-id="58151-162">Install VMM on a virtual machine in a Windows failover cluster, and select the option to run the server as highly available during setup.</span></span>
2. <span data-ttu-id="58151-163">L'istanza di SQL Server usata da VMM deve essere replicata con gruppi di disponibilità AlwaysOn di SQL Server in modo che sia disponibile una replica del database nel sito secondario.</span><span class="sxs-lookup"><span data-stu-id="58151-163">The SQL Server instance that's used by VMM should be replicated with SQL Server AlwaysOn availability groups, so that there's a replica of the database in the secondary site.</span></span>
3. <span data-ttu-id="58151-164">Seguire le istruzioni in questo articolo per creare un insieme di credenziali, registrare il server e configurare la protezione.</span><span class="sxs-lookup"><span data-stu-id="58151-164">Follow the instructions in this article to create a vault, register the server, and set up protection.</span></span> <span data-ttu-id="58151-165">È necessario registrare ogni server VMM nel cluster nell'insieme di credenziali di Servizi di ripristino.</span><span class="sxs-lookup"><span data-stu-id="58151-165">You need to register each VMM server in the cluster in the Recovery Services vault.</span></span> <span data-ttu-id="58151-166">A tale scopo, installare il Provider in un nodo attivo e registrare il server VMM.</span><span class="sxs-lookup"><span data-stu-id="58151-166">To do this, you install the Provider on an active node, and register the VMM server.</span></span> <span data-ttu-id="58151-167">Quindi installare il provider sugli altri nodi.</span><span class="sxs-lookup"><span data-stu-id="58151-167">Then you install the Provider on other nodes.</span></span>
4. <span data-ttu-id="58151-168">Se si verifica un'interruzione, il server VMM e il database SQL Server corrispondente sono sottoposti a failover e l'accesso viene eseguito dal sito secondario.</span><span class="sxs-lookup"><span data-stu-id="58151-168">When an outage occurs, the VMM server and its corresponding SQL Server database are failed over, and accessed from the secondary site.</span></span>



## <a name="next-steps"></a><span data-ttu-id="58151-169">Passaggi successivi</span><span class="sxs-lookup"><span data-stu-id="58151-169">Next steps</span></span>

<span data-ttu-id="58151-170">Vedere [Passaggio 5: Configurare un insieme di credenziali](vmm-to-vmm-walkthrough-create-vault.md).</span><span class="sxs-lookup"><span data-stu-id="58151-170">Go to [Step 5: Set up a vault](vmm-to-vmm-walkthrough-create-vault.md).</span></span>