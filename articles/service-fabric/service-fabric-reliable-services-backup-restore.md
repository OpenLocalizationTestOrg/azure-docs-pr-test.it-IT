---
title: aaaService infrastruttura Backup e ripristino | Documenti Microsoft
description: Documentazione concettuale per il backup e ripristino di Service Fabric
services: service-fabric
documentationcenter: .net
author: mcoskun
manager: timlt
editor: subramar,jessebenson
ms.assetid: 91ea6ca4-cc2a-4155-9823-dcbd0b996349
ms.service: service-fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: na
ms.date: 08/18/2017
ms.author: mcoskun
ms.openlocfilehash: e502b59c84999c3fe825167383f00a5ebd70c9b5
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 10/06/2017
---
# <a name="back-up-and-restore-reliable-services-and-reliable-actors"></a><span data-ttu-id="52700-103">Eseguire il backup e il ripristino di Reliable Services e Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="52700-103">Back up and restore Reliable Services and Reliable Actors</span></span>
<span data-ttu-id="52700-104">Azure Service Fabric è una piattaforma a disponibilità elevata che replica stato hello in più nodi toomaintain la disponibilità elevata.</span><span class="sxs-lookup"><span data-stu-id="52700-104">Azure Service Fabric is a high-availability platform that replicates hello state across multiple nodes toomaintain this high availability.</span></span>  <span data-ttu-id="52700-105">Di conseguenza, anche se un nodo cluster hello non riesce, servizi hello continuano toobe disponibili.</span><span class="sxs-lookup"><span data-stu-id="52700-105">Thus, even if one node in hello cluster fails, hello services continue toobe available.</span></span> <span data-ttu-id="52700-106">Sebbene questa ridondanza integrata fornita dalla piattaforma hello potrebbe essere sufficiente per alcuni, in alcuni casi è consigliabile che hello servizio tooback dei dati (archivio esterno tooan).</span><span class="sxs-lookup"><span data-stu-id="52700-106">While this in-built redundancy provided by hello platform may be sufficient for some, in certain cases it is desirable for hello service tooback up data (tooan external store).</span></span>

> [!NOTE]
> <span data-ttu-id="52700-107">È toobackup critici e il ripristino dei dati (e i test che funziona come previsto) in modo è possibile ripristinare da scenari di perdita dei dati.</span><span class="sxs-lookup"><span data-stu-id="52700-107">It is critical toobackup and restore your data (and test that it works as expected) so you can recover from data loss scenarios.</span></span>
> 
> 

<span data-ttu-id="52700-108">Ad esempio, un servizio necessario tooback dei dati in ordine tooprotect da hello seguenti scenari:</span><span class="sxs-lookup"><span data-stu-id="52700-108">For example, a service may want tooback up data in order tooprotect from hello following scenarios:</span></span>

- <span data-ttu-id="52700-109">Nell'evento hello di perdita definitiva di hello di un intero cluster di Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="52700-109">In hello event of hello permanent loss of an entire Service Fabric cluster.</span></span>
- <span data-ttu-id="52700-110">Perdita definitiva di una maggioranza delle repliche hello di una partizione di servizio</span><span class="sxs-lookup"><span data-stu-id="52700-110">Permanent loss of a majority of hello replicas of a service partition</span></span>
- <span data-ttu-id="52700-111">Errori amministrativi, in base al quale hello stato accidentalmente Ottiene eliminato o danneggiato.</span><span class="sxs-lookup"><span data-stu-id="52700-111">Administrative errors whereby hello state accidentally gets deleted or corrupted.</span></span> <span data-ttu-id="52700-112">Questo problema può verificarsi, ad esempio, se un amministratore con privilegi sufficienti elimina erroneamente servizio hello.</span><span class="sxs-lookup"><span data-stu-id="52700-112">For example, this may happen if an administrator with sufficient privilege erroneously deletes hello service.</span></span>
- <span data-ttu-id="52700-113">Bug nel servizio hello che provocano il danneggiamento dei dati.</span><span class="sxs-lookup"><span data-stu-id="52700-113">Bugs in hello service that cause data corruption.</span></span> <span data-ttu-id="52700-114">Ad esempio, ciò può verificarsi quando un aggiornamento del codice del servizio inizia la scrittura di dati difettoso tooa insieme affidabile.</span><span class="sxs-lookup"><span data-stu-id="52700-114">For example, this may happen when a service code upgrade starts writing faulty data tooa Reliable Collection.</span></span> <span data-ttu-id="52700-115">In tal caso, entrambi hello codice e dati di hello possono avere toobe ripristinato tooan stato in precedenza.</span><span class="sxs-lookup"><span data-stu-id="52700-115">In such a case, both hello code and hello data may have toobe reverted tooan earlier state.</span></span>
- <span data-ttu-id="52700-116">Elaborazione dati offline.</span><span class="sxs-lookup"><span data-stu-id="52700-116">Offline data processing.</span></span> <span data-ttu-id="52700-117">Potrebbe essere toohave pratico l'elaborazione offline dei dati per la business intelligence che si verifica separatamente dal servizio hello che genera dati hello.</span><span class="sxs-lookup"><span data-stu-id="52700-117">It might be convenient toohave offline processing of data for business intelligence that happens separately from hello service that generates hello data.</span></span>

<span data-ttu-id="52700-118">funzionalità di Backup/ripristino Hello consente servizi basati su backup toocreate e il ripristino di API per servizi affidabili hello.</span><span class="sxs-lookup"><span data-stu-id="52700-118">hello Backup/Restore feature allows services built on hello Reliable Services API toocreate and restore backups.</span></span> <span data-ttu-id="52700-119">Hello API backup fornite dalla piattaforma hello consentono il/i backup dello stato di una partizione servizio, senza blocco lettura o di operazioni di scrittura.</span><span class="sxs-lookup"><span data-stu-id="52700-119">hello backup APIs provided by hello platform allow backup(s) of a service partition's state, without blocking read or write operations.</span></span> <span data-ttu-id="52700-120">ripristino di Hello API consente toobe di una partizione servizio stato ripristinato da un backup scelto.</span><span class="sxs-lookup"><span data-stu-id="52700-120">hello restore APIs allow a service partition's state toobe restored from a chosen backup.</span></span>

## <a name="types-of-backup"></a><span data-ttu-id="52700-121">Tipi di backup</span><span class="sxs-lookup"><span data-stu-id="52700-121">Types of Backup</span></span>
<span data-ttu-id="52700-122">Sono disponibili due opzioni di backup: completo e incrementale.</span><span class="sxs-lookup"><span data-stu-id="52700-122">There are two backup options: Full and Incremental.</span></span>
<span data-ttu-id="52700-123">Un backup completo è una copia di backup che contiene tutti hello dati necessari toorecreate hello lo stato della replica hello: Checkpoint e tutti i record di log.</span><span class="sxs-lookup"><span data-stu-id="52700-123">A full backup is a backup that contains all hello data required toorecreate hello state of hello replica: checkpoints and all log records.</span></span>
<span data-ttu-id="52700-124">Poiché dispone di checkpoint hello e log di hello, un backup completo può essere ripristinato da solo.</span><span class="sxs-lookup"><span data-stu-id="52700-124">Since it has hello checkpoints and hello log, a full backup can be restored by itself.</span></span>

<span data-ttu-id="52700-125">Quando i checkpoint hello sono di grandi dimensioni, si verifica il problema di Hello con backup completi.</span><span class="sxs-lookup"><span data-stu-id="52700-125">hello problem with full backups arises when hello checkpoints are large.</span></span>
<span data-ttu-id="52700-126">Ad esempio, una replica che dispone di 16 GB di stato i checkpoint saranno che costituiscono circa too16 GB.</span><span class="sxs-lookup"><span data-stu-id="52700-126">For example, a replica that has 16 GB of state will have checkpoints that add up approximately too16 GB.</span></span>
<span data-ttu-id="52700-127">Se si dispone di un obiettivo del punto di ripristino di cinque minuti, hello replica sono necessari toobe backup ogni cinque minuti.</span><span class="sxs-lookup"><span data-stu-id="52700-127">If we have a Recovery Point Objective of five minutes, hello replica needs toobe backed up every five minutes.</span></span>
<span data-ttu-id="52700-128">Ogni volta che viene eseguito il backup deve toocopy 16 GB di checkpoint inoltre too50 MB (configurabile utilizzando `CheckpointThresholdInMB`) relativi registri.</span><span class="sxs-lookup"><span data-stu-id="52700-128">Each time it backs up it needs toocopy 16 GB of checkpoints in addition too50 MB (configurable using `CheckpointThresholdInMB`) worth of logs.</span></span>

![Esempio di backup completo.](media/service-fabric-reliable-services-backup-restore/FullBackupExample.PNG)

<span data-ttu-id="52700-130">problema di toothis soluzione hello è backup incrementali, in cui backup contiene solo i record del log hello modificato dall'ultimo backup hello.</span><span class="sxs-lookup"><span data-stu-id="52700-130">hello solution toothis problem is incremental backups, where backup only contains hello changed log records since hello last backup.</span></span>

![Esempio di backup incrementale.](media/service-fabric-reliable-services-backup-restore/IncrementalBackupExample.PNG)

<span data-ttu-id="52700-132">Poiché i backup incrementali sono solo le modifiche apportate dall'ultimo backup hello (non include i checkpoint hello), toobe sono in genere più veloce, ma non possono essere ripristinati in modo autonomo.</span><span class="sxs-lookup"><span data-stu-id="52700-132">Since incremental backups are only changes since hello last backup (does not include hello checkpoints), they tend toobe faster but they cannot be restored on their own.</span></span>
<span data-ttu-id="52700-133">toorestore un backup incrementale, hello intera catena di backup è obbligatorio.</span><span class="sxs-lookup"><span data-stu-id="52700-133">toorestore an incremental backup, hello entire backup chain is required.</span></span>
<span data-ttu-id="52700-134">Una catena di backup inizia con un backup completo e prosegue con diversi backup incrementali contigui.</span><span class="sxs-lookup"><span data-stu-id="52700-134">A backup chain is a chain of backups starting with a full backup and followed by a number of contiguous incremental backups.</span></span>

## <a name="backup-reliable-services"></a><span data-ttu-id="52700-135">Eseguire il backup di Reliable Services</span><span class="sxs-lookup"><span data-stu-id="52700-135">Backup Reliable Services</span></span>
<span data-ttu-id="52700-136">Hello autore servizio abbia il pieno controllo sul momento in backup toomake e in cui verranno archiviati i backup.</span><span class="sxs-lookup"><span data-stu-id="52700-136">hello service author has full control of when toomake backups and where backups will be stored.</span></span>

<span data-ttu-id="52700-137">toostart una copia di backup, il servizio di hello deve tooinvoke hello ereditata membro funzione `BackupAsync`.</span><span class="sxs-lookup"><span data-stu-id="52700-137">toostart a backup, hello service needs tooinvoke hello inherited member function `BackupAsync`.</span></span>  
<span data-ttu-id="52700-138">I backup possono essere composto solo da repliche primarie e richiedono toobe di scrittura stato concesso.</span><span class="sxs-lookup"><span data-stu-id="52700-138">Backups can be made only from primary replicas, and they require write status toobe granted.</span></span>

<span data-ttu-id="52700-139">Come illustrato di seguito, `BackupAsync` accetta un `BackupDescription` oggetto, uno in cui è possibile specificare un backup completo o incrementale, nonché una funzione di callback, `Func<< BackupInfo, CancellationToken, Task<bool>>>` che è richiamato quando la cartella di backup hello è stato creato in locale ed è pronto toobe spostati toosome archiviazione esterna.</span><span class="sxs-lookup"><span data-stu-id="52700-139">As shown below, `BackupAsync` takes in a `BackupDescription` object, where one can specify a full or incremental backup, as well as a callback function, `Func<< BackupInfo, CancellationToken, Task<bool>>>` that is invoked when hello backup folder has been created locally and is ready toobe moved out toosome external storage.</span></span>

```csharp

BackupDescription myBackupDescription = new BackupDescription(backupOption.Incremental,this.BackupCallbackAsync);

await this.BackupAsync(myBackupDescription);

```

<span data-ttu-id="52700-140">Richiesta tootake un backup incrementale può non riuscire con `FabricMissingFullBackupException`.</span><span class="sxs-lookup"><span data-stu-id="52700-140">Request tootake an incremental backup can fail with `FabricMissingFullBackupException`.</span></span> <span data-ttu-id="52700-141">Questa eccezione indica che uno dei seguenti aspetti hello è in corso:</span><span class="sxs-lookup"><span data-stu-id="52700-141">This exception indicates that one of hello following things is happening:</span></span>

- <span data-ttu-id="52700-142">replica Hello non è mai eseguito un backup completo, poiché è stato contrassegnato come primario,</span><span class="sxs-lookup"><span data-stu-id="52700-142">hello replica has never taken a full backup since it has become primary,</span></span>
- <span data-ttu-id="52700-143">alcune delle hello i record di log dall'ultimo backup hello è stato troncato o</span><span class="sxs-lookup"><span data-stu-id="52700-143">some of hello log records since hello last backup has been truncated or</span></span>
- <span data-ttu-id="52700-144">replica passato hello `MaxAccumulatedBackupLogSizeInMB` limite.</span><span class="sxs-lookup"><span data-stu-id="52700-144">replica passed hello `MaxAccumulatedBackupLogSizeInMB` limit.</span></span>

<span data-ttu-id="52700-145">Gli utenti possono aumentare la probabilità hello di essere in grado di toodo i backup incrementali configurando `MinLogSizeInMB` o `TruncationThresholdFactor`.</span><span class="sxs-lookup"><span data-stu-id="52700-145">Users can increase hello likelihood of being able toodo incremental backups by configuring `MinLogSizeInMB` or `TruncationThresholdFactor`.</span></span>
<span data-ttu-id="52700-146">Si noti che l'aumento di questi valori aumenta hello in base all'utilizzo del disco di replica.</span><span class="sxs-lookup"><span data-stu-id="52700-146">Note that increasing these values increases hello per replica disk usage.</span></span>
<span data-ttu-id="52700-147">Per altre informazioni, vedere [Configurazione di Reliable Services](service-fabric-reliable-services-configuration.md)</span><span class="sxs-lookup"><span data-stu-id="52700-147">For more information, see [Reliable Services Configuration](service-fabric-reliable-services-configuration.md)</span></span>

<span data-ttu-id="52700-148">`BackupInfo`vengono fornite informazioni sui backup di hello, incluso il percorso di hello hello cartella in cui il runtime hello backup hello (`BackupInfo.Directory`).</span><span class="sxs-lookup"><span data-stu-id="52700-148">`BackupInfo` provides information regarding hello backup, including hello location of hello folder where hello runtime saved hello backup (`BackupInfo.Directory`).</span></span> <span data-ttu-id="52700-149">funzione di callback Hello è possibile spostare hello `BackupInfo.Directory` tooan archivio esterno o in un'altra posizione.</span><span class="sxs-lookup"><span data-stu-id="52700-149">hello callback function can move hello `BackupInfo.Directory` tooan external store or another location.</span></span>  <span data-ttu-id="52700-150">Questa funzione restituisce anche valore booleano che indica se è il percorso di destinazione tooits toosuccessfully in grado di spostare hello cartella di backup.</span><span class="sxs-lookup"><span data-stu-id="52700-150">This function also returns a bool that indicates whether it was able toosuccessfully move hello backup folder tooits target location.</span></span>

<span data-ttu-id="52700-151">Hello codice seguente viene illustrato come hello `BackupCallbackAsync` metodo può essere utilizzato tooupload hello backup tooAzure archiviazione:</span><span class="sxs-lookup"><span data-stu-id="52700-151">hello following code demonstrates how hello `BackupCallbackAsync` method can be used tooupload hello backup tooAzure Storage:</span></span>

```csharp
private async Task<bool> BackupCallbackAsync(BackupInfo backupInfo, CancellationToken cancellationToken)
{
    var backupId = Guid.NewGuid();

    await externalBackupStore.UploadBackupFolderAsync(backupInfo.Directory, backupId, cancellationToken);

    return true;
}
```

<span data-ttu-id="52700-152">Nell'esempio precedente hello `ExternalBackupStore` è una classe di esempio hello toointerface utilizzato con l'archiviazione Blob di Azure, e `UploadBackupFolderAsync` metodo hello che comprime cartella hello e lo inserisce nell'archivio Blob di Azure hello.</span><span class="sxs-lookup"><span data-stu-id="52700-152">In hello preceeding example, `ExternalBackupStore` is hello sample class that is used toointerface with Azure Blob storage, and `UploadBackupFolderAsync` is hello method that compresses hello folder and places it in hello Azure Blob store.</span></span>

<span data-ttu-id="52700-153">Si noti che:</span><span class="sxs-lookup"><span data-stu-id="52700-153">Note that:</span></span>

  - <span data-ttu-id="52700-154">In un dato momento può essere in corso una sola operazione di backup per replica.</span><span class="sxs-lookup"><span data-stu-id="52700-154">There can be only one backup operation in-flight per replica at any given time.</span></span> <span data-ttu-id="52700-155">Più `BackupAsync` chiamata alla volta genererà `FabricBackupInProgressException` toolimit in-Flight backup tooone.</span><span class="sxs-lookup"><span data-stu-id="52700-155">More than one `BackupAsync` call at a time will throw `FabricBackupInProgressException` toolimit inflight backups tooone.</span></span>
  - <span data-ttu-id="52700-156">Se una replica viene eseguito il failover mentre è in corso un backup, backup hello non sia stato completato.</span><span class="sxs-lookup"><span data-stu-id="52700-156">If a replica fails over while a backup is in progress, hello backup may not have been completed.</span></span> <span data-ttu-id="52700-157">Pertanto, al termine del failover hello, si tratta responsabilità toorestart hello backup del servizio hello richiamando `BackupAsync` in base alle esigenze.</span><span class="sxs-lookup"><span data-stu-id="52700-157">Thus, once hello failover finishes, it is hello service's responsibility toorestart hello backup by invoking `BackupAsync` as necessary.</span></span>

## <a name="restore-reliable-services"></a><span data-ttu-id="52700-158">Ripristinare Reliable Services</span><span class="sxs-lookup"><span data-stu-id="52700-158">Restore Reliable Services</span></span>
<span data-ttu-id="52700-159">In generale, hello casi potrebbe essere necessario tooperform un'operazione di ripristino rientrano in una di queste categorie:</span><span class="sxs-lookup"><span data-stu-id="52700-159">In general, hello cases when you might need tooperform a restore operation fall into one of these categories:</span></span>

  - <span data-ttu-id="52700-160">servizio Hello partizionare i dati persi.</span><span class="sxs-lookup"><span data-stu-id="52700-160">hello service partition lost data.</span></span> <span data-ttu-id="52700-161">Ad esempio, disco hello per due dei tre repliche per una partizione (inclusa la replica primaria di hello) Ottiene danneggiato o cancellato.</span><span class="sxs-lookup"><span data-stu-id="52700-161">For example, hello disk for two out of three replicas for a partition (including hello primary replica) gets corrupted or wiped.</span></span> <span data-ttu-id="52700-162">nuovo database primario di Hello potrebbe essere necessario toorestore dati da un backup.</span><span class="sxs-lookup"><span data-stu-id="52700-162">hello new primary may need toorestore data from a backup.</span></span>
  - <span data-ttu-id="52700-163">intero servizio Hello viene persa.</span><span class="sxs-lookup"><span data-stu-id="52700-163">hello entire service is lost.</span></span> <span data-ttu-id="52700-164">Ad esempio, un amministratore rimuove intero servizio hello e devono toobe ripristinato hello servizio e dati di hello.</span><span class="sxs-lookup"><span data-stu-id="52700-164">For example, an administrator removes hello entire service and thus hello service and hello data need toobe restored.</span></span>
  - <span data-ttu-id="52700-165">servizio Hello replicati i dati di applicazione danneggiata (ad esempio, a causa di un bug dell'applicazione).</span><span class="sxs-lookup"><span data-stu-id="52700-165">hello service replicated corrupt application data (e.g., because of an application bug).</span></span> <span data-ttu-id="52700-166">In questo caso, il servizio di hello ha toobe aggiornato o ripristinato tooremove hello causa del danneggiamento hello e non danneggiare i dati ha ripristinato toobe.</span><span class="sxs-lookup"><span data-stu-id="52700-166">In this case, hello service has toobe upgraded or reverted tooremove hello cause of hello corruption, and non-corrupt data has toobe restored.</span></span>

<span data-ttu-id="52700-167">Anche se molti approcci sono possibili, si offrono alcuni esempi sull'utilizzo di `RestoreAsync` toorecover da hello sopra gli scenari.</span><span class="sxs-lookup"><span data-stu-id="52700-167">While many approaches are possible, we offer some examples on using `RestoreAsync` toorecover from hello above scenarios.</span></span>

## <a name="partition-data-loss-in-reliable-services"></a><span data-ttu-id="52700-168">Perdita di dati della partizione in Reliable Services</span><span class="sxs-lookup"><span data-stu-id="52700-168">Partition data loss in Reliable Services</span></span>
<span data-ttu-id="52700-169">In questo caso, hello runtime verrà automaticamente rilevare perdite di dati hello e richiamare hello `OnDataLossAsync` API.</span><span class="sxs-lookup"><span data-stu-id="52700-169">In this case, hello runtime would automatically detect hello data loss and invoke hello `OnDataLossAsync` API.</span></span>

<span data-ttu-id="52700-170">autore servizio Hello deve hello tooperform toorecover seguenti:</span><span class="sxs-lookup"><span data-stu-id="52700-170">hello service author needs tooperform hello following toorecover:</span></span>

  - <span data-ttu-id="52700-171">Eseguire l'override di metodo della classe base virtuale hello `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="52700-171">Override hello virtual base class method `OnDataLossAsync`.</span></span>
  - <span data-ttu-id="52700-172">Trovare hello più recente backup nel percorso esterno hello che contiene il backup del servizio hello.</span><span class="sxs-lookup"><span data-stu-id="52700-172">Find hello latest backup in hello external location that contains hello service's backups.</span></span>
  - <span data-ttu-id="52700-173">Scaricare l'ultimo backup hello (e decomprimere i backup hello nella cartella di backup hello se compresso).</span><span class="sxs-lookup"><span data-stu-id="52700-173">Download hello latest backup (and uncompress hello backup into hello backup folder if it was compressed).</span></span>
  - <span data-ttu-id="52700-174">Hello `OnDataLossAsync` metodo fornisce un `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="52700-174">hello `OnDataLossAsync` method provides a `RestoreContext`.</span></span> <span data-ttu-id="52700-175">Chiamare hello `RestoreAsync` API in hello fornito `RestoreContext`.</span><span class="sxs-lookup"><span data-stu-id="52700-175">Call hello `RestoreAsync` API on hello provided `RestoreContext`.</span></span>
  - <span data-ttu-id="52700-176">Restituisce true se il ripristino di hello riuscita.</span><span class="sxs-lookup"><span data-stu-id="52700-176">Return true if hello restoration was a success.</span></span>

<span data-ttu-id="52700-177">Ecco un esempio di implementazione di hello `OnDataLossAsync` metodo:</span><span class="sxs-lookup"><span data-stu-id="52700-177">Following is an example implementation of hello `OnDataLossAsync` method:</span></span>

```csharp
protected override async Task<bool> OnDataLossAsync(RestoreContext restoreCtx, CancellationToken cancellationToken)
{
    var backupFolder = await this.externalBackupStore.DownloadLastBackupAsync(cancellationToken);

    var restoreDescription = new RestoreDescription(backupFolder);

    await restoreCtx.RestoreAsync(restoreDescription);

    return true;
}
```

<span data-ttu-id="52700-178">`RestoreDescription`passato toohello `RestoreContext.RestoreAsync` chiamata contiene un membro denominato `BackupFolderPath`.</span><span class="sxs-lookup"><span data-stu-id="52700-178">`RestoreDescription` passed in toohello `RestoreContext.RestoreAsync` call contains a member called `BackupFolderPath`.</span></span>
<span data-ttu-id="52700-179">Quando si ripristina un backup completo, questo `BackupFolderPath` deve essere impostato toohello percorso locale della cartella hello che contiene il backup completo.</span><span class="sxs-lookup"><span data-stu-id="52700-179">When restoring a single full backup, this `BackupFolderPath` should be set toohello local path of hello folder that contains your full backup.</span></span>
<span data-ttu-id="52700-180">Quando si ripristina un backup completo e un numero di backup incrementali, `BackupFolderPath` deve essere impostato toohello percorso locale della cartella hello che contiene non solo backup completi di hello, ma anche tutti i hello backup incrementali.</span><span class="sxs-lookup"><span data-stu-id="52700-180">When restoring a full backup and a number of incremental backups, `BackupFolderPath` should be set toohello local path of hello folder that not only contains hello full backup, but also all hello incremental backups.</span></span>
<span data-ttu-id="52700-181">`RestoreAsync`chiamata può generare `FabricMissingFullBackupException` se hello `BackupFolderPath` fornito non contiene un backup completo.</span><span class="sxs-lookup"><span data-stu-id="52700-181">`RestoreAsync` call can throw `FabricMissingFullBackupException` if hello `BackupFolderPath` provided does not contain a full backup.</span></span>
<span data-ttu-id="52700-182">Può anche generare `ArgumentException` se `BackupFolderPath` contiene una catena interrotta di backup incrementali,</span><span class="sxs-lookup"><span data-stu-id="52700-182">It can also throw `ArgumentException` if `BackupFolderPath` has a broken chain of incremental backups.</span></span>
<span data-ttu-id="52700-183">Ad esempio, se contiene hello backup completo, innanzitutto hello incrementale e hello terzo backup incrementale, ma nessun backup incrementale secondo hello.</span><span class="sxs-lookup"><span data-stu-id="52700-183">For example, if it contains hello full backup, hello first incremental and hello third incremental backup but no hello second incremental backup.</span></span>

> [!NOTE]
> <span data-ttu-id="52700-184">Hello RestorePolicy è tooSafe per impostazione predefinita.</span><span class="sxs-lookup"><span data-stu-id="52700-184">hello RestorePolicy is set tooSafe by default.</span></span>  <span data-ttu-id="52700-185">Ciò significa che hello `RestoreAsync` API avrà esito negativo con ArgumentException se rileva tale cartella di backup hello contiene uno stato che è stato più vecchi di o uguale toohello contenuto in questa replica.</span><span class="sxs-lookup"><span data-stu-id="52700-185">This means that hello `RestoreAsync` API will fail with ArgumentException if it detects that hello backup folder contains a state that is older than or equal toohello state contained in this replica.</span></span>  <span data-ttu-id="52700-186">`RestorePolicy.Force`può essere utilizzato tooskip il controllo di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="52700-186">`RestorePolicy.Force` can be used tooskip this safety check.</span></span> <span data-ttu-id="52700-187">Viene specificato come parte di `RestoreDescription`.</span><span class="sxs-lookup"><span data-stu-id="52700-187">This is specified as part of `RestoreDescription`.</span></span>
> 

## <a name="deleted-or-lost-service"></a><span data-ttu-id="52700-188">Servizio eliminato o perso</span><span class="sxs-lookup"><span data-stu-id="52700-188">Deleted or lost service</span></span>
<span data-ttu-id="52700-189">Se viene rimosso un servizio, è necessario innanzitutto creare nuovamente servizio hello prima di ripristinare i dati di hello.</span><span class="sxs-lookup"><span data-stu-id="52700-189">If a service is removed, you must first re-create hello service before hello data can be restored.</span></span>  <span data-ttu-id="52700-190">È importante toocreate hello servizio con hello stessa configurazione, ad esempio, il partizionamento di schema, in modo che hello dati può essere ripristinata senza problemi.</span><span class="sxs-lookup"><span data-stu-id="52700-190">It is important toocreate hello service with hello same configuration, e.g., partitioning scheme, so that hello data can be restored seamlessly.</span></span>  <span data-ttu-id="52700-191">Una volta servizio hello è attivo, hello dati toorestore API (`OnDataLossAsync` sopra) ha toobe richiamata per ogni partizione del servizio.</span><span class="sxs-lookup"><span data-stu-id="52700-191">Once hello service is up, hello API toorestore data (`OnDataLossAsync` above) has toobe invoked on every partition of this service.</span></span> <span data-ttu-id="52700-192">A tal fine, è possibile usare `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` su ogni partizione.</span><span class="sxs-lookup"><span data-stu-id="52700-192">One way of achieving this is by using `[FabricClient.TestManagementClient.StartPartitionDataLossAsync](https://msdn.microsoft.com/library/mt693569.aspx)` on every partition.</span></span>  

<span data-ttu-id="52700-193">A questo punto, implementazione è hello come hello sopra scenario.</span><span class="sxs-lookup"><span data-stu-id="52700-193">From this point, implementation is hello same as hello above scenario.</span></span> <span data-ttu-id="52700-194">Ogni partizione deve toorestore hello ultimo rilevanti backup dall'archivio esterno hello.</span><span class="sxs-lookup"><span data-stu-id="52700-194">Each partition needs toorestore hello latest relevant backup from hello external store.</span></span> <span data-ttu-id="52700-195">Uno svantaggio è tale partizione hello che ID sia stato ora modificato, poiché hello runtime crea gli ID di partizione in modo dinamico.</span><span class="sxs-lookup"><span data-stu-id="52700-195">One caveat is that hello partition ID may have now changed, since hello runtime creates partition IDs dynamically.</span></span> <span data-ttu-id="52700-196">Di conseguenza, il servizio di hello necessita di informazioni di partizione appropriato toostore hello e servizio nome tooidentify hello corretto più recente backup toorestore da per ogni partizione.</span><span class="sxs-lookup"><span data-stu-id="52700-196">Thus, hello service needs toostore hello appropriate partition information and service name tooidentify hello correct latest backup toorestore from for each partition.</span></span>

> [!NOTE]
> <span data-ttu-id="52700-197">Non è consigliabile toouse `FabricClient.ServiceManager.InvokeDataLossAsync` in ogni partizione toorestore hello intero servizio, dal momento che potrebbe danneggiare lo stato del cluster.</span><span class="sxs-lookup"><span data-stu-id="52700-197">It is not recommended toouse `FabricClient.ServiceManager.InvokeDataLossAsync` on each partition toorestore hello entire service, since that may corrupt your cluster state.</span></span>
> 

## <a name="replication-of-corrupt-application-data"></a><span data-ttu-id="52700-198">Replica di dati dell'applicazione danneggiati</span><span class="sxs-lookup"><span data-stu-id="52700-198">Replication of corrupt application data</span></span>
<span data-ttu-id="52700-199">Se l'aggiornamento dell'applicazione hello appena distribuito dispone di un bug, che può causare il danneggiamento dei dati.</span><span class="sxs-lookup"><span data-stu-id="52700-199">If hello newly deployed application upgrade has a bug, that may cause corruption of data.</span></span> <span data-ttu-id="52700-200">Ad esempio, un aggiornamento dell'applicazione può avviare tooupdate ogni record al numero di telefono in un dizionario affidabile con un prefisso non valido.</span><span class="sxs-lookup"><span data-stu-id="52700-200">For example, an application upgrade may start tooupdate every phone number record in a Reliable Dictionary with an invalid area code.</span></span>  <span data-ttu-id="52700-201">In questo caso, i numeri di telefono non valido di hello verranno replicati poiché Service Fabric non è a conoscenza di natura hello dei dati di hello che viene archiviati.</span><span class="sxs-lookup"><span data-stu-id="52700-201">In this case, hello invalid phone numbers will be replicated since Service Fabric is not aware of hello nature of hello data that is being stored.</span></span>

<span data-ttu-id="52700-202">Hello in primo luogo toodo dopo è rilevare tali un bug che causa il danneggiamento dei dati egregious è toofreeze hello servizio a livello di applicazione hello e, se possibile, aggiornare la versione toohello hello codice dell'applicazione che non dispone di bug hello.</span><span class="sxs-lookup"><span data-stu-id="52700-202">hello first thing toodo after you detect such an egregious bug that causes data corruption is toofreeze hello service at hello application level and, if possible, upgrade toohello version of hello application code that does not have hello bug.</span></span>  <span data-ttu-id="52700-203">Tuttavia, anche dopo il codice di servizio hello è fissa, dati hello ancora potrebbero essere danneggiati e pertanto dati potrebbe essere necessario toobe ripristinato.</span><span class="sxs-lookup"><span data-stu-id="52700-203">However, even after hello service code is fixed, hello data may still be corrupt and thus data may need toobe restored.</span></span>  <span data-ttu-id="52700-204">In questi casi, potrebbe non essere sufficiente toorestore hello backup più recente, poiché i backup più recenti di hello inoltre potrebbero essere danneggiati.</span><span class="sxs-lookup"><span data-stu-id="52700-204">In such cases, it may not be sufficient toorestore hello latest backup, since hello latest backups may also be corrupt.</span></span>  <span data-ttu-id="52700-205">Pertanto, si è toofind hello ultimo backup eseguito prima dati hello sono danneggiati.</span><span class="sxs-lookup"><span data-stu-id="52700-205">Thus, you have toofind hello last backup that was made before hello data got corrupted.</span></span>

<span data-ttu-id="52700-206">Se non sei sicuro che i backup sono danneggiati, è possibile distribuire un nuovo cluster di Service Fabric e ripristinare i backup hello di partizioni interessate come hello sopra "Deleted o perdita di servizio" scenario.</span><span class="sxs-lookup"><span data-stu-id="52700-206">If you are not sure which backups are corrupt, you could deploy a new Service Fabric cluster and restore hello backups of affected partitions just like hello above "Deleted or lost service" scenario.</span></span>  <span data-ttu-id="52700-207">Per ogni partizione, avviare minimo per il ripristino dei backup hello da toohello più recente di hello.</span><span class="sxs-lookup"><span data-stu-id="52700-207">For each partition, start restoring hello backups from hello most recent toohello least.</span></span> <span data-ttu-id="52700-208">Dopo aver trovato una copia di backup che non dispone di danneggiamento hello, spostamento o eliminazione della partizione di tutti i backup che erano più recenti (backup).</span><span class="sxs-lookup"><span data-stu-id="52700-208">Once you find a backup that does not have hello corruption, move/delete all backups of this partition that were more recent (than that backup).</span></span> <span data-ttu-id="52700-209">Ripetere questo processo per ogni partizione.</span><span class="sxs-lookup"><span data-stu-id="52700-209">Repeat this process for each partition.</span></span> <span data-ttu-id="52700-210">A questo punto, quando `OnDataLossAsync` viene chiamato nella partizione hello in cluster in produzione hello, hello ultimo backup disponibile in hello esterno archivio sarà hello uno prelevati da hello di sopra di processo.</span><span class="sxs-lookup"><span data-stu-id="52700-210">Now, when `OnDataLossAsync` is called on hello partition in hello production cluster, hello last backup found in hello external store will be hello one picked by hello above process.</span></span>

<span data-ttu-id="52700-211">A questo punto, i passaggi in hello, "Deleted o perdita di servizio" hello sezione può essere utilizzato lo stato di hello toorestore dello stato di toohello hello del servizio prima codice anomalo hello hello danneggiato.</span><span class="sxs-lookup"><span data-stu-id="52700-211">Now, hello steps in hello "Deleted or lost service" section can be used toorestore hello state of hello service toohello state before hello buggy code corrupted hello state.</span></span>

<span data-ttu-id="52700-212">Si noti che:</span><span class="sxs-lookup"><span data-stu-id="52700-212">Note that:</span></span>

  - <span data-ttu-id="52700-213">Quando si ripristina, esiste la possibilità che hello backup viene ripristinato è precedente rispetto allo stato della partizione hello hello prima hello dati sono andati persi.</span><span class="sxs-lookup"><span data-stu-id="52700-213">When you restore, there is a chance that hello backup being restored is older than hello state of hello partition before hello data was lost.</span></span> <span data-ttu-id="52700-214">Per questo motivo, è necessario ripristinare solo come un ultimo toorecover risorsa quanti più dati possibile.</span><span class="sxs-lookup"><span data-stu-id="52700-214">Because of this, you should restore only as a last resort toorecover as much data as possible.</span></span>
  - <span data-ttu-id="52700-215">stringa che rappresenta il percorso di cartella di backup hello Hello e hello percorsi dei file nella cartella di backup hello possono essere maggiori di 255 caratteri, in base al percorso FabricDataRoot hello e lunghezza del nome del tipo di applicazione.</span><span class="sxs-lookup"><span data-stu-id="52700-215">hello string that represents hello backup folder path and hello paths of files inside hello backup folder can be greater than 255 characters, depending on hello FabricDataRoot path and Application Type name's length.</span></span> <span data-ttu-id="52700-216">Ciò può causare alcuni metodi di .NET, ad esempio `Directory.Move`, hello toothrow `PathTooLongException` eccezione.</span><span class="sxs-lookup"><span data-stu-id="52700-216">This can cause some .NET methods, like `Directory.Move`, toothrow hello `PathTooLongException` exception.</span></span> <span data-ttu-id="52700-217">Una soluzione alternativa consiste toodirectly chiamare le API kernel32, ad esempio `CopyFile`.</span><span class="sxs-lookup"><span data-stu-id="52700-217">One workaround is toodirectly call kernel32 APIs, like `CopyFile`.</span></span>

## <a name="backup-and-restore-reliable-actors"></a><span data-ttu-id="52700-218">Eseguire il backup e il ripristino di Reliable Actors</span><span class="sxs-lookup"><span data-stu-id="52700-218">Backup and restore Reliable Actors</span></span>


<span data-ttu-id="52700-219">Reliable Actors Framework si basa su Reliable Services.</span><span class="sxs-lookup"><span data-stu-id="52700-219">Reliable Actors Framework is built on top of Reliable Services.</span></span> <span data-ttu-id="52700-220">Hello ActorService che ospita actor(s) hello è un servizio affidabile con stato.</span><span class="sxs-lookup"><span data-stu-id="52700-220">hello ActorService which hosts hello actor(s) is a stateful reliable service.</span></span> <span data-ttu-id="52700-221">Di conseguenza, tutti i backup di hello e funzionalità di ripristino disponibili in servizi affidabili anche attori tooReliable disponibili (eccetto i comportamenti specifico del provider di stato).</span><span class="sxs-lookup"><span data-stu-id="52700-221">Hence, all hello backup and restore functionality available in Reliable Services is also available tooReliable Actors (except behaviors that are state provider specific).</span></span> <span data-ttu-id="52700-222">Poiché i backup verranno eseguiti per partizione, verrà eseguito il backup degli stati per tutti gli attori in quella partizione (il ripristino è simile e verrà eseguito anch'esso per partizione).</span><span class="sxs-lookup"><span data-stu-id="52700-222">Since backups will be taken on a per-partition basis, states for all actors in that partition will be backed up (and restoration is similar and will happen on a per-partition basis).</span></span> <span data-ttu-id="52700-223">tooperform backup/ripristino, il proprietario del servizio hello deve creare una classe di servizio actor personalizzata che deriva dalla classe ActorService e quindi backup/ripristino simile tooReliable Services come descritto in precedenza nella sezione precedente.</span><span class="sxs-lookup"><span data-stu-id="52700-223">tooperform backup/restore, hello service owner should create a custom actor service class that derives from ActorService class and then do backup/restore similar tooReliable Services as described above in previous sections.</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo)
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="52700-224">Quando si crea una classe del servizio actor personalizzato, è necessario che anche tooregister durante la registrazione attore hello.</span><span class="sxs-lookup"><span data-stu-id="52700-224">When you create a custom actor service class, you need tooregister that as well when registering hello actor.</span></span>

```csharp
ActorRuntime.RegisterActorAsync<MyActor>(
   (context, typeInfo) => new MyCustomActorService(context, typeInfo)).GetAwaiter().GetResult();
```

<span data-ttu-id="52700-225">provider di stato predefinito Hello per Reliable Actors `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="52700-225">hello default state provider for Reliable Actors is `KvsActorStateProvider`.</span></span> <span data-ttu-id="52700-226">Per impostazione predefinita, il backup incrementale non è abilitato per `KvsActorStateProvider`.</span><span class="sxs-lookup"><span data-stu-id="52700-226">Incremental backup is not enabled by default for `KvsActorStateProvider`.</span></span> <span data-ttu-id="52700-227">È possibile abilitare il backup incrementale creando `KvsActorStateProvider` con hello appropriato impostando nel relativo costruttore e passando quindi tooActorService costruttore come illustrato nel frammento di codice seguente:</span><span class="sxs-lookup"><span data-stu-id="52700-227">You can enable incremental backup by creating `KvsActorStateProvider` with hello appropriate setting in its constructor and then passing it tooActorService constructor as shown in following code snippet:</span></span>

```csharp
class MyCustomActorService : ActorService
{
     public MyCustomActorService(StatefulServiceContext context, ActorTypeInformation actorTypeInfo)
            : base(context, actorTypeInfo, null, null, new KvsActorStateProvider(true)) // Enable incremental backup
     {                  
     }
    
    //
   // Method overrides and other code.
    //
}
```

<span data-ttu-id="52700-228">Dopo il backup incrementale è stato abilitato, eseguire un backup incrementale può non riuscire con FabricMissingFullBackupException per uno dei seguenti motivi e sarà necessario tootake un backup completo prima di portare il/i backup incrementali:</span><span class="sxs-lookup"><span data-stu-id="52700-228">After incremental backup has been enabled, taking an incremental backup can fail with FabricMissingFullBackupException for one of following reasons and you will need tootake a full backup before taking incremental backup(s):</span></span>

  - <span data-ttu-id="52700-229">replica Hello non è mai eseguito un backup completo perché era primario.</span><span class="sxs-lookup"><span data-stu-id="52700-229">hello replica has never taken a full backup since it became primary.</span></span>
  - <span data-ttu-id="52700-230">Alcuni dei record di log hello è stati troncati perché è stato eseguito l'ultimo backup.</span><span class="sxs-lookup"><span data-stu-id="52700-230">Some of hello log records were truncated since last backup was taken.</span></span>

<span data-ttu-id="52700-231">Quando è abilitato il backup incrementale, `KvsActorStateProvider` non utilizza toomanage circolare del buffer relativo log registra e lo tronca periodicamente.</span><span class="sxs-lookup"><span data-stu-id="52700-231">When incremental backup is enabled, `KvsActorStateProvider` does not use circular buffer toomanage its log records and periodically truncates it.</span></span> <span data-ttu-id="52700-232">Se viene eseguito alcun backup dall'utente per un periodo di 45 minuti, il sistema hello tronca automaticamente i record del log hello.</span><span class="sxs-lookup"><span data-stu-id="52700-232">If no backup is taken by user for a period of 45 minutes, hello system automatically truncates hello log records.</span></span> <span data-ttu-id="52700-233">Questo intervallo può essere configurato specificando `logTrunctationIntervalInMinutes` in `KvsActorStateProvider` costruttore (analoga toowhen Abilita il backup incrementale).</span><span class="sxs-lookup"><span data-stu-id="52700-233">This interval can be configured by specifying `logTrunctationIntervalInMinutes` in `KvsActorStateProvider` constructor (similar toowhen enabling incremental backup).</span></span> <span data-ttu-id="52700-234">i record del log Hello possono inoltre ottenere troncati se la replica primaria necessario toobuild un'altra replica mediante l'invio di tutti i relativi dati.</span><span class="sxs-lookup"><span data-stu-id="52700-234">hello log records may also get truncated if primary replica need toobuild another replica by sending all its data.</span></span>

<span data-ttu-id="52700-235">Quando si esegue il ripristino da una catena di backup, servizi tooReliable analoghi, hello BackupFolderPath deve contenere sottodirectory con una sottodirectory contenente backup completo e altri sottodirectory che includono il/i backup incrementali.</span><span class="sxs-lookup"><span data-stu-id="52700-235">When doing restore from a backup chain, similar tooReliable Services, hello BackupFolderPath should contain subdirectories with one subdirectory containing full backup and others subdirectories containing incremental backup(s).</span></span> <span data-ttu-id="52700-236">Se si verifica un errore di convalida della catena di backup di hello, Hello ripristino API genererà FabricException con messaggio di errore appropriato.</span><span class="sxs-lookup"><span data-stu-id="52700-236">hello restore API will throw FabricException with appropriate error message if hello backup chain validation fails.</span></span> 

> [!NOTE]
> <span data-ttu-id="52700-237">`KvsActorStateProvider`Ignora attualmente opzione hello RestorePolicy.Safe.</span><span class="sxs-lookup"><span data-stu-id="52700-237">`KvsActorStateProvider` currently ignores hello option RestorePolicy.Safe.</span></span> <span data-ttu-id="52700-238">Il supporto per questa funzionalità è pianificato per una versione futura.</span><span class="sxs-lookup"><span data-stu-id="52700-238">Support for this feature is planned in an upcoming release.</span></span>
> 

## <a name="testing-backup-and-restore"></a><span data-ttu-id="52700-239">Test del backup e del ripristino</span><span class="sxs-lookup"><span data-stu-id="52700-239">Testing Backup and Restore</span></span>
<span data-ttu-id="52700-240">È importante tooensure che i dati critici durante il backup e possono essere ripristinati da.</span><span class="sxs-lookup"><span data-stu-id="52700-240">It is important tooensure that critical data is being backed up, and can be restored from.</span></span> <span data-ttu-id="52700-241">Questa operazione può essere eseguita richiamando hello `Start-ServiceFabricPartitionDataLoss` cmdlet di PowerShell che possono provocare la perdita di dati in una partizione specifica di tootest se dati hello backup e ripristino delle funzionalità per il servizio funzioni come previsto.</span><span class="sxs-lookup"><span data-stu-id="52700-241">This can be done by invoking hello `Start-ServiceFabricPartitionDataLoss` cmdlet in PowerShell that can induce data loss in a particular partition tootest whether hello data backup and restore functionality for your service is working as expected.</span></span>  <span data-ttu-id="52700-242">È inoltre possibile tooprogrammatically richiamare la perdita di dati e il ripristino da anche tale evento.</span><span class="sxs-lookup"><span data-stu-id="52700-242">It is also possible tooprogrammatically invoke data loss and restore from that event as well.</span></span>

> [!NOTE]
> <span data-ttu-id="52700-243">È possibile trovare un'implementazione di esempio di backup e ripristino delle funzionalità in hello App riferimento Web in GitHub.</span><span class="sxs-lookup"><span data-stu-id="52700-243">You can find a sample implementation of backup and restore functionality in hello Web Reference App on GitHub.</span></span> <span data-ttu-id="52700-244">Consultare hello `Inventory.Service` servizio per altri dettagli.</span><span class="sxs-lookup"><span data-stu-id="52700-244">Please look at hello `Inventory.Service` service for more details.</span></span>
> 
> 

## <a name="under-hello-hood-more-details-on-backup-and-restore"></a><span data-ttu-id="52700-245">Quinte hello: ulteriori dettagli su backup e ripristino</span><span class="sxs-lookup"><span data-stu-id="52700-245">Under hello hood: more details on backup and restore</span></span>
<span data-ttu-id="52700-246">Ecco altri dettagli sul backup e ripristino.</span><span class="sxs-lookup"><span data-stu-id="52700-246">Here's some more details on backup and restore.</span></span>

### <a name="backup"></a><span data-ttu-id="52700-247">Backup</span><span class="sxs-lookup"><span data-stu-id="52700-247">Backup</span></span>
<span data-ttu-id="52700-248">Hello affidabile di gestione dello stato fornisce backup coerenti hello possibilità toocreate senza il blocco di lettura o le operazioni di scrittura.</span><span class="sxs-lookup"><span data-stu-id="52700-248">hello Reliable State Manager provides hello ability toocreate consistent backups without blocking any read or write operations.</span></span> <span data-ttu-id="52700-249">toodo in tal caso, utilizza un meccanismo di persistenza di checkpoint e di log.</span><span class="sxs-lookup"><span data-stu-id="52700-249">toodo so, it utilizes a checkpoint and log persistence mechanism.</span></span>  <span data-ttu-id="52700-250">Hello affidabile di gestione dello stato accetta fuzzy checkpoint (lightweight) determinati pressione toorelieve punti dal log delle transazioni hello e migliorare i tempi di ripristino.</span><span class="sxs-lookup"><span data-stu-id="52700-250">hello Reliable State Manager takes fuzzy (lightweight) checkpoints at certain points toorelieve pressure from hello transactional log and improve recovery times.</span></span>  <span data-ttu-id="52700-251">Quando `BackupAsync` viene chiamato, hello affidabile di gestione dello stato indica tutti gli oggetti affidabile toocopy loro più recente del punto di controllo file tooa backup cartella locale.</span><span class="sxs-lookup"><span data-stu-id="52700-251">When `BackupAsync` is called, hello Reliable State Manager instructs all Reliable objects toocopy their latest checkpoint files tooa local backup folder.</span></span>  <span data-ttu-id="52700-252">Quindi, hello affidabile di gestione dello stato copia tutti i record di log, a partire da hello "start puntatore" toohello ultimo record di log nella cartella di backup hello.</span><span class="sxs-lookup"><span data-stu-id="52700-252">Then, hello Reliable State Manager copies all log records, starting from hello "start pointer" toohello latest log record into hello backup folder.</span></span>  <span data-ttu-id="52700-253">Poiché tutti i record di log hello dei record del log più recente toohello siano incluse nel backup hello e affidabile di gestione dello stato di hello mantiene registrazione write-ahead, hello gestore degli stati affidabile garantisce che tutte le transazioni che viene eseguito il commit (`CommitAsync` ha restituito correttamente) sono inclusi nel backup hello.</span><span class="sxs-lookup"><span data-stu-id="52700-253">Since all hello log records up toohello latest log record are included in hello backup and hello Reliable State Manager preserves write-ahead logging, hello Reliable State Manager guarantees that all transactions that are committed (`CommitAsync` has returned successfully) are included in hello backup.</span></span>

<span data-ttu-id="52700-254">Qualsiasi transazione di cui viene eseguito il commit dopo `BackupAsync` è stato chiamato maggio o potrebbe non essere in backup di hello.</span><span class="sxs-lookup"><span data-stu-id="52700-254">Any transaction that commits after `BackupAsync` has been called may or may not be in hello backup.</span></span>  <span data-ttu-id="52700-255">Una volta che la cartella di backup locale di hello è stata popolata dalla piattaforma hello (ad esempio, backup locale viene completato tramite il runtime hello), del servizio hello backup richiamata.</span><span class="sxs-lookup"><span data-stu-id="52700-255">Once hello local backup folder has been populated by hello platform (i.e., local backup is completed by hello runtime), hello service's backup callback is invoked.</span></span>  <span data-ttu-id="52700-256">Il callback è responsabile dello spostamento hello backup tooan esterno percorso della cartella, ad esempio l'archiviazione di Azure.</span><span class="sxs-lookup"><span data-stu-id="52700-256">This callback is responsible for moving hello backup folder tooan external location such as Azure Storage.</span></span>

### <a name="restore"></a><span data-ttu-id="52700-257">Ripristino</span><span class="sxs-lookup"><span data-stu-id="52700-257">Restore</span></span>
<span data-ttu-id="52700-258">Hello affidabile di gestione dello stato fornisce hello possibilità toorestore da un backup utilizzando hello `RestoreAsync` API.</span><span class="sxs-lookup"><span data-stu-id="52700-258">hello Reliable State Manager provides hello ability toorestore from a backup by using hello `RestoreAsync` API.</span></span>  
<span data-ttu-id="52700-259">Hello `RestoreAsync` metodo `RestoreContext` può essere chiamato solo all'interno di hello `OnDataLossAsync` metodo.</span><span class="sxs-lookup"><span data-stu-id="52700-259">hello `RestoreAsync` method on `RestoreContext` can be called only inside hello `OnDataLossAsync` method.</span></span>
<span data-ttu-id="52700-260">Hello restituito da bool `OnDataLossAsync` indica se il servizio di hello ripristinato lo stato da un'origine esterna.</span><span class="sxs-lookup"><span data-stu-id="52700-260">hello bool returned by `OnDataLossAsync` indicates whether hello service restored its state from an external source.</span></span>
<span data-ttu-id="52700-261">Se hello `OnDataLossAsync` restituisce true, tutte le altre repliche da questo primario causerà la ricostruzione Service Fabric.</span><span class="sxs-lookup"><span data-stu-id="52700-261">If hello `OnDataLossAsync` returns true, Service Fabric will rebuild all other replicas from this primary.</span></span> <span data-ttu-id="52700-262">Service Fabric garantisce che le repliche che riceveranno `OnDataLossAsync` chiamare primo ruolo primario di transizione toohello ma stato non vengono concesse lettura o scrittura dello stato.</span><span class="sxs-lookup"><span data-stu-id="52700-262">Service Fabric ensures that replicas that will receive `OnDataLossAsync` call first transition toohello primary role but are not granted read status or write status.</span></span>
<span data-ttu-id="52700-263">Per i responsabili dell'implementazione di StatefulService significa che `RunAsync` viene chiamato solo dopo il completamento corretto di `OnDataLossAsync`.</span><span class="sxs-lookup"><span data-stu-id="52700-263">This implies that for StatefulService implementers, `RunAsync` will not be called until `OnDataLossAsync` finishes successfully.</span></span>
<span data-ttu-id="52700-264">Quindi, `OnDataLossAsync` verrà richiamato nel nuovo database primario di hello.</span><span class="sxs-lookup"><span data-stu-id="52700-264">Then, `OnDataLossAsync` will be invoked on hello new primary.</span></span>
<span data-ttu-id="52700-265">Fino a quando un servizio consente di completare questa API correttamente (restituisce true o false) e termina la riconfigurazione rilevanti hello, hello API verrà mantenere viene chiamato uno alla volta.</span><span class="sxs-lookup"><span data-stu-id="52700-265">Until a service completes this API successfully (by returning true or false) and finishes hello relevant reconfiguration, hello API will keep being called one at a time.</span></span>

<span data-ttu-id="52700-266">`RestoreAsync`prima Elimina tutti gli stati esistenti nella replica primaria hello che è stata chiamata su.</span><span class="sxs-lookup"><span data-stu-id="52700-266">`RestoreAsync` first drops all existing state in hello primary replica that it was called on.</span></span>  
<span data-ttu-id="52700-267">Hello affidabile stato Manager crea quindi tutti gli oggetti affidabile hello che esistono nella cartella di backup hello.</span><span class="sxs-lookup"><span data-stu-id="52700-267">Then hello Reliable State Manager creates all hello Reliable objects that exist in hello backup folder.</span></span>  
<span data-ttu-id="52700-268">Successivamente, gli oggetti affidabile di hello sono istruzioni riportate toorestore dai loro checkpoint nella cartella di backup hello.</span><span class="sxs-lookup"><span data-stu-id="52700-268">Next, hello Reliable objects are instructed toorestore from their checkpoints in hello backup folder.</span></span>  
<span data-ttu-id="52700-269">Infine, hello affidabile di gestione dello stato consente di recuperare il proprio stato da record del log nella cartella di backup hello hello ed esegue il ripristino.</span><span class="sxs-lookup"><span data-stu-id="52700-269">Finally, hello Reliable State Manager recovers its own state from hello log records in hello backup folder and performs recovery.</span></span>  
<span data-ttu-id="52700-270">Come parte del processo di ripristino hello, a partire da hello "punto di partenza" le operazioni che include i record di commit del log nella cartella di backup di hello sono oggetti affidabile toohello riprodotto.</span><span class="sxs-lookup"><span data-stu-id="52700-270">As part of hello recovery process, operations starting from hello "starting point" that have commit log records in hello backup folder are replayed toohello Reliable objects.</span></span>  
<span data-ttu-id="52700-271">Questo passaggio garantisce che hello ripristinato lo stato è coerente.</span><span class="sxs-lookup"><span data-stu-id="52700-271">This step ensures that hello recovered state is consistent.</span></span>

## <a name="next-steps"></a><span data-ttu-id="52700-272">Passaggi successivi</span><span class="sxs-lookup"><span data-stu-id="52700-272">Next steps</span></span>
  - [<span data-ttu-id="52700-273">Reliable Collections</span><span class="sxs-lookup"><span data-stu-id="52700-273">Reliable Collections</span></span>](service-fabric-work-with-reliable-collections.md)
  - [<span data-ttu-id="52700-274">Guida introduttiva a Reliable Services di Microsoft Azure Service Fabric</span><span class="sxs-lookup"><span data-stu-id="52700-274">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
  - [<span data-ttu-id="52700-275">Notifiche di Reliable Services</span><span class="sxs-lookup"><span data-stu-id="52700-275">Reliable Services notifications</span></span>](service-fabric-reliable-services-notifications.md)
  - [<span data-ttu-id="52700-276">Configurazione di Reliable Services</span><span class="sxs-lookup"><span data-stu-id="52700-276">Reliable Services configuration</span></span>](service-fabric-reliable-services-configuration.md)
  - [<span data-ttu-id="52700-277">Guida di riferimento per gli sviluppatori per Reliable Collections</span><span class="sxs-lookup"><span data-stu-id="52700-277">Developer reference for Reliable Collections</span></span>](https://msdn.microsoft.com/library/azure/microsoft.servicefabric.data.collections.aspx)

