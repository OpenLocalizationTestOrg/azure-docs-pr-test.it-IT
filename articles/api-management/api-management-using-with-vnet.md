---
title: Come usare Gestione API di Azure con le reti virtuali
description: Informazioni su come configurare una connessione a una rete virtuale in Gestione API di Azure e usarla per accedere ai servizi Web.
services: api-management
documentationcenter: 
author: antonba
manager: erikre
editor: 
ms.assetid: 64b58f7b-ca22-47dc-89c0-f6bb0af27a48
ms.service: api-management
ms.workload: mobile
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 12/15/2016
ms.author: apimpm
ms.openlocfilehash: 268cee739188d81feffc36ac07fcdfa18ff95a4d
ms.sourcegitcommit: 50e23e8d3b1148ae2d36dad3167936b4e52c8a23
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/18/2017
---
# <a name="how-to-use-azure-api-management-with-virtual-networks"></a><span data-ttu-id="72bea-103">Come usare Gestione API di Azure con le reti virtuali</span><span class="sxs-lookup"><span data-stu-id="72bea-103">How to use Azure API Management with virtual networks</span></span>
<span data-ttu-id="72bea-104">Le reti virtuali di Azure (VNET) consentono di posizionare le risorse di Azure in una rete instradabile non Internet a cui si controlla l'accesso.</span><span class="sxs-lookup"><span data-stu-id="72bea-104">Azure Virtual Networks (VNETs) allow you to place any of your Azure resources in a non-internet routeable network that you control access to.</span></span> <span data-ttu-id="72bea-105">Queste reti possono quindi essere connesse alle reti locali usando diverse tecnologie VPN.</span><span class="sxs-lookup"><span data-stu-id="72bea-105">These networks can then be connected to your on-premises networks using various VPN technologies.</span></span> <span data-ttu-id="72bea-106">Per altre informazioni sulle reti virtuali di Azure, è possibile iniziare dalla [Panoramica sulla rete virtuale di Azure](../virtual-network/virtual-networks-overview.md).</span><span class="sxs-lookup"><span data-stu-id="72bea-106">To learn more about Azure Virtual Networks start with the information here: [Azure Virtual Network Overview](../virtual-network/virtual-networks-overview.md).</span></span>

<span data-ttu-id="72bea-107">Gestione API di Azure può essere distribuito all'interno della rete virtuale (VNET) in modo che possa accedere ai servizi di back-end all'interno della rete.</span><span class="sxs-lookup"><span data-stu-id="72bea-107">Azure API Management can be deployed inside the virtual network (VNET), so it can access backend services within the network.</span></span> <span data-ttu-id="72bea-108">Il portale per sviluppatori e il gateway dell'API possono essere configurati in modo che siano accessibili da Internet o solo all'interno della rete virtuale.</span><span class="sxs-lookup"><span data-stu-id="72bea-108">The developer portal and API gateway, can be configured to be accessible either from the Internet or only within the virtual network.</span></span>

> [!NOTE]
> <span data-ttu-id="72bea-109">Gestione API di Azure supporta le reti virtuali classiche e Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="72bea-109">Azure API Management supports both classic and Azure Resource Manager VNets.</span></span>
>
>

## <span data-ttu-id="72bea-110"><a name="enable-vpn"> </a>Attivare la connessione VNET</span><span class="sxs-lookup"><span data-stu-id="72bea-110"><a name="enable-vpn"> </a>Enable VNET connection</span></span>
> [!NOTE]
> <span data-ttu-id="72bea-111">La connettività della rete virtuale è disponibile per i livelli **Premium** e **Sviluppatore**.</span><span class="sxs-lookup"><span data-stu-id="72bea-111">VNET connectivity is available in the **Premium** and **Developer** tiers.</span></span> <span data-ttu-id="72bea-112">Per spostarsi tra i livelli, aprire il servizio Gestione API nel portale di Azure e quindi la scheda **Scale and pricing** (Scalabilità e prezzi). Nella sezione **Piano tariffario** selezionare il livello Premium o Sviluppatore e fare clic su Salva.</span><span class="sxs-lookup"><span data-stu-id="72bea-112">To switch between the tiers, open your API Management service in the Azure portal and then open the **Scale and pricing** tab. Under the **Pricing tier** section, select the Premium or Developer tier and click Save.</span></span>
>

<span data-ttu-id="72bea-113">Per abilitare la connettività della rete virtuale, aprire il servizio Gestione API nel portale di Azure e quindi la pagina **Rete virtuale**.</span><span class="sxs-lookup"><span data-stu-id="72bea-113">To enable VNET connectivity, open your API Management service in the Azure portal and open the **Virtual network** page.</span></span>

![Menu della rete virtuale di Gestione API][api-management-using-vnet-menu]

<span data-ttu-id="72bea-115">Selezionare il tipo di accesso da usare:</span><span class="sxs-lookup"><span data-stu-id="72bea-115">Select the desired access type:</span></span>

* <span data-ttu-id="72bea-116">**Esterno**: il gateway di Gestione API e il portale per gli sviluppatori sono accessibili dalla rete internet pubblica tramite un servizio di bilanciamento del carico esterno.</span><span class="sxs-lookup"><span data-stu-id="72bea-116">**External**: the API Management gateway and developer portal are accessible from the public internet via an external load balancer.</span></span> <span data-ttu-id="72bea-117">Il gateway può accedere alle risorse all'interno della rete virtuale.</span><span class="sxs-lookup"><span data-stu-id="72bea-117">The gateway can access resources within the virtual network.</span></span>

![Peering pubblico][api-management-vnet-public]

* <span data-ttu-id="72bea-119">**Interno**: il gateway di Gestione API e il portale per gli sviluppatori sono accessibili soltanto dalla rete virtuale tramite un servizio di bilanciamento del carico interno.</span><span class="sxs-lookup"><span data-stu-id="72bea-119">**Internal**: the API Management gateway and developer portal are accessible only from within the virtual network via an internal load balancer.</span></span> <span data-ttu-id="72bea-120">Il gateway può accedere alle risorse all'interno della rete virtuale.</span><span class="sxs-lookup"><span data-stu-id="72bea-120">The gateway can access resources within the virtual network.</span></span>

![Peering privato][api-management-vnet-private]

<span data-ttu-id="72bea-122">Verrà ora visualizzato un elenco di tutte le aree in cui viene eseguito il provisioning del servizio Gestione API.</span><span class="sxs-lookup"><span data-stu-id="72bea-122">You will now see a list of all regions where your API Management service is provisioned.</span></span> <span data-ttu-id="72bea-123">Selezionare una VNET e una subnet per ogni area.</span><span class="sxs-lookup"><span data-stu-id="72bea-123">Select a VNET and subnet for every region.</span></span> <span data-ttu-id="72bea-124">L'elenco viene popolato con le reti virtuali classiche e Resource Manager disponibili nelle sottoscrizioni di Azure, impostate nell'area che si sta configurando.</span><span class="sxs-lookup"><span data-stu-id="72bea-124">The list is populated with both classic and Resource Manager virtual networks available in your Azure subscriptions that are setup in the region you are configuring.</span></span>

> [!NOTE]
> <span data-ttu-id="72bea-125">**Endpoint di servizio** nel diagramma precedente include Gateway/Proxy, Portale di pubblicazione, Portale per sviluppatori, GIT e l'endpoint di gestione diretta.</span><span class="sxs-lookup"><span data-stu-id="72bea-125">**Service Endpoint** in the above diagram includes Gateway/Proxy, Publisher Portal, Developer Portal, GIT, and the Direct Management Endpoint.</span></span>
> <span data-ttu-id="72bea-126">**Endpoint di gestione** nel diagramma precedente è l'endpoint ospitato nel servizio per la gestione della configurazione tramite il portale di Azure e Powershell.</span><span class="sxs-lookup"><span data-stu-id="72bea-126">**Management Endpoint** in the above diagram is the endpoint hosted on the service to manage configuration via Azure portal and Powershell.</span></span>
> <span data-ttu-id="72bea-127">Inoltre si noti che, sebbene il diagramma mostra gli indirizzi IP per i vari endpoint, il servizio Gestione API risponde **solo** ai relativi nomi host configurati.</span><span class="sxs-lookup"><span data-stu-id="72bea-127">Also, note, that, even though, the diagram shows IP Addresses for its various endpoints, API Management service **only** responds on its configured Hostnames.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="72bea-128">Quando si distribuisce un'istanza di gestione API di Azure a una rete virtuale Resource Manager, il servizio deve essere in una subnet dedicata che non contiene altre risorse, a eccezione di istanze di gestione API di Azure.</span><span class="sxs-lookup"><span data-stu-id="72bea-128">When deploying an Azure API Management instance to a Resource Manager VNET, the service must be in a dedicated subnet that contains no other resources except for Azure API Management instances.</span></span> <span data-ttu-id="72bea-129">Se si tenta di distribuire un'istanza di gestione API di Azure a una subnet della rete virtuale Resource Manager contenente altre risorse, la distribuzione avrà esito negativo.</span><span class="sxs-lookup"><span data-stu-id="72bea-129">If an attempt is made to deploy an Azure API Management instance to a Resource Manager VNET subnet that contains other resources, the deployment will fail.</span></span>
>
>

![Selezionare una VPN][api-management-setup-vpn-select]

<span data-ttu-id="72bea-131">Fare clic su **Salva** nella parte superiore della schermata.</span><span class="sxs-lookup"><span data-stu-id="72bea-131">Click **Save** at the top of the screen.</span></span>

> [!NOTE]
> <span data-ttu-id="72bea-132">L'indirizzo VIP dell'istanza di Gestione API può cambiare ogni volta che la rete virtuale viene abilitata o disabilitata.</span><span class="sxs-lookup"><span data-stu-id="72bea-132">The VIP address of the API Management instance will change each time VNET is enabled or disabled.</span></span>  
> <span data-ttu-id="72bea-133">L'indirizzo VIP viene modificato quando Gestione API passa da **Esterna** a **Interna** o viceversa</span><span class="sxs-lookup"><span data-stu-id="72bea-133">The VIP address will also change when API Management is moved from **External** to **Internal** or vice-versa</span></span>
>


> [!IMPORTANT]
> <span data-ttu-id="72bea-134">Se si rimuove Gestione API da una rete virtuale o si modifica quella in cui è distribuito, la rete virtuale utilizzata in precedenza può rimanere bloccata fino a 4 ore.</span><span class="sxs-lookup"><span data-stu-id="72bea-134">If you remove API Management from a VNET or change the one it is deployed in, the previously used VNET can remain locked for up to 4 hours.</span></span> <span data-ttu-id="72bea-135">Durante questo periodo non sarà possibile eliminare la rete virtuale o distribuirvi una nuova risorsa.</span><span class="sxs-lookup"><span data-stu-id="72bea-135">During this period it will not be possible to delete the VNET or deploy a new resource to it.</span></span>

## <span data-ttu-id="72bea-136"><a name="enable-vnet-powershell"> </a>Abilitare la connessione della rete virtuale usando i cmdlet di PowerShell</span><span class="sxs-lookup"><span data-stu-id="72bea-136"><a name="enable-vnet-powershell"> </a>Enable VNET connection using PowerShell cmdlets</span></span>
<span data-ttu-id="72bea-137">È inoltre possibile abilitare la connettività della rete virtuale utilizzando i cmdlet di PowerShell</span><span class="sxs-lookup"><span data-stu-id="72bea-137">You can also enable VNET connectivity using the PowerShell cmdlets</span></span>

* <span data-ttu-id="72bea-138">**Creare un servizio Gestione API all'interno di una rete virtuale**: usare il cmdlet [New-AzureRmApiManagement](/powershell/module/azurerm.apimanagement/new-azurermapimanagement) per creare un servizio Gestione API di Azure all'interno di una rete virtuale.</span><span class="sxs-lookup"><span data-stu-id="72bea-138">**Create an API Management service inside a VNET**: Use the cmdlet [New-AzureRmApiManagement](/powershell/module/azurerm.apimanagement/new-azurermapimanagement) to create an Azure API Management service inside a VNET.</span></span>

* <span data-ttu-id="72bea-139">**Distribuire un servizio Gestione API esistente all'interno di una rete virtuale**: usare il cmdlet [Update-AzureRmApiManagementDeployment](/powershell/module/azurerm.apimanagement/update-azurermapimanagementdeployment) per spostare un servizio Gestione API di Azure esistente all'interno di una rete virtuale.</span><span class="sxs-lookup"><span data-stu-id="72bea-139">**Deploy an existing API Management service inside a VNET**: Use the cmdlet [Update-AzureRmApiManagementDeployment](/powershell/module/azurerm.apimanagement/update-azurermapimanagementdeployment) to move an existing Azure API Management service inside a Virtual Network.</span></span>

## <span data-ttu-id="72bea-140"><a name="connect-vnet"> </a>Connettersi a un servizio Web ospitato all'interno di una rete virtuale</span><span class="sxs-lookup"><span data-stu-id="72bea-140"><a name="connect-vnet"> </a>Connect to a web service hosted within a virtual Network</span></span>
<span data-ttu-id="72bea-141">Dopo che il servizio Gestione API è stato connesso alla VNET, l'accesso ai servizi di back-end all'interno della rete virtuale non è diverso dall'accesso ai servizi pubblici.</span><span class="sxs-lookup"><span data-stu-id="72bea-141">After your API Management service is connected to the VNET, accessing backend services within it is no different than accessing public services.</span></span> <span data-ttu-id="72bea-142">È sufficiente digitare l'indirizzo locale o il nome host (se è stato configurato un server DNS per la VNET) del servizio Web nel campo **URL del servizio Web** quando si crea una nuova API o se ne modifica una esistente.</span><span class="sxs-lookup"><span data-stu-id="72bea-142">Just type in the local IP address or the host name (if a DNS server is configured for the VNET) of your web service into the **Web service URL** field when creating a new API or editing an existing one.</span></span>

![Aggiungere un'API dalla VPN][api-management-setup-vpn-add-api]

## <span data-ttu-id="72bea-144"><a name="network-configuration-issues"> </a>Problemi comuni di configurazione di rete</span><span class="sxs-lookup"><span data-stu-id="72bea-144"><a name="network-configuration-issues"> </a>Common Network Configuration Issues</span></span>
<span data-ttu-id="72bea-145">Di seguito è riportato un elenco di problemi di configurazione comuni che possono verificarsi durante la distribuzione del servizio Gestione API in una rete virtuale.</span><span class="sxs-lookup"><span data-stu-id="72bea-145">Following is a list of common misconfiguration issues that can occur while deploying API Management service into a Virtual Network.</span></span>

* <span data-ttu-id="72bea-146">**Installazione di server DNS personalizzata**: il servizio Gestione API dipende da vari servizi di Azure.</span><span class="sxs-lookup"><span data-stu-id="72bea-146">**Custom DNS server setup**: The API Management service depends on several Azure services.</span></span> <span data-ttu-id="72bea-147">Quando Gestione API è ospitata in una rete virtuale con un server DNS personalizzato, deve risolvere i nomi host dei servizi di Azure.</span><span class="sxs-lookup"><span data-stu-id="72bea-147">When API Management is hosted in a VNET with a custom DNS server, it needs to resolve the hostnames of those Azure services.</span></span> <span data-ttu-id="72bea-148">Vedere [queste](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server) informazioni aggiuntive sulla configurazione del DNS personalizzato.</span><span class="sxs-lookup"><span data-stu-id="72bea-148">Please follow [this](../virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances.md#name-resolution-using-your-own-dns-server) guidance on custom DNS setup.</span></span> <span data-ttu-id="72bea-149">Vedere la tabella delle porte e altri requisiti di rete per riferimento.</span><span class="sxs-lookup"><span data-stu-id="72bea-149">See the ports table below and other network requirements for reference.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="72bea-150">Se si usa un server DNS personalizzato per la rete virtuale, è consigliabile impostarlo **prima** di distribuirvi un servizio Gestione API.</span><span class="sxs-lookup"><span data-stu-id="72bea-150">It is recommended that, if you are using a Custom DNS Server(s) for the VNET, you set that up **before** deploying an API Management service into it.</span></span> <span data-ttu-id="72bea-151">In caso contrario è necessario aggiornare il servizio Gestione API ogni volta che si modifica il server DNS eseguendo [l'operazione di applicazione della configurazione di rete](https://docs.microsoft.com/en-us/rest/api/apimanagement/apimanagementservice#ApiManagementService_ApplyNetworkConfigurationUpdates)</span><span class="sxs-lookup"><span data-stu-id="72bea-151">Otherwise you need to update the API Management service each time you change the DNS Servers(s) by running the [Apply Network Configuration Operation](https://docs.microsoft.com/en-us/rest/api/apimanagement/apimanagementservice#ApiManagementService_ApplyNetworkConfigurationUpdates)</span></span>

* <span data-ttu-id="72bea-152">**Porte necessarie per il servizio Gestione API**: il traffico in ingresso e in uscita nella subnet in cui viene distribuita la gestione delle API può essere controllato usando il [gruppo di sicurezza di rete][Network Security Group].</span><span class="sxs-lookup"><span data-stu-id="72bea-152">**Ports required for API Management**: Inbound and Outbound traffic into the Subnet in which API Management is deployed can be controlled using [Network Security Group][Network Security Group].</span></span> <span data-ttu-id="72bea-153">Se una qualsiasi di queste porte non è disponibile, Gestione API potrebbe non funzionare correttamente e potrebbe diventare inaccessibile.</span><span class="sxs-lookup"><span data-stu-id="72bea-153">If any of these ports are unavailable, API Management may not operate properly and may become inaccessible.</span></span> <span data-ttu-id="72bea-154">Il blocco di una o più di tali porte è un problema di configurazione comune nell'uso di Gestione API in una rete virtuale.</span><span class="sxs-lookup"><span data-stu-id="72bea-154">Having one or more of these ports blocked is another common misconfiguration issue when using API Management with a VNET.</span></span>

<span data-ttu-id="72bea-155">Quando un'istanza del servizio Gestione API è ospitata in una rete virtuale, vengono usate le porte indicate nella tabella seguente.</span><span class="sxs-lookup"><span data-stu-id="72bea-155">When an API Management service instance is hosted in a VNET, the ports in the following table are used.</span></span>

| <span data-ttu-id="72bea-156">Porte di origine/destinazione</span><span class="sxs-lookup"><span data-stu-id="72bea-156">Source / Destination Port(s)</span></span> | <span data-ttu-id="72bea-157">Direzione</span><span class="sxs-lookup"><span data-stu-id="72bea-157">Direction</span></span> | <span data-ttu-id="72bea-158">Protocollo di trasporto</span><span class="sxs-lookup"><span data-stu-id="72bea-158">Transport protocol</span></span> | <span data-ttu-id="72bea-159">Scopo</span><span class="sxs-lookup"><span data-stu-id="72bea-159">Purpose</span></span> | <span data-ttu-id="72bea-160">Origine/Destinazione</span><span class="sxs-lookup"><span data-stu-id="72bea-160">Source / Destination</span></span> | <span data-ttu-id="72bea-161">Tipo di accesso</span><span class="sxs-lookup"><span data-stu-id="72bea-161">Access type</span></span> |
| --- | --- | --- | --- | --- | --- |
| <span data-ttu-id="72bea-162">* / 80, 443</span><span class="sxs-lookup"><span data-stu-id="72bea-162">* / 80, 443</span></span> |<span data-ttu-id="72bea-163">In ingresso</span><span class="sxs-lookup"><span data-stu-id="72bea-163">Inbound</span></span> |<span data-ttu-id="72bea-164">TCP</span><span class="sxs-lookup"><span data-stu-id="72bea-164">TCP</span></span> |<span data-ttu-id="72bea-165">Comunicazione tra client e Gestione API</span><span class="sxs-lookup"><span data-stu-id="72bea-165">Client communication to API Management</span></span> |<span data-ttu-id="72bea-166">INTERNET / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="72bea-166">INTERNET / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="72bea-167">Esterno</span><span class="sxs-lookup"><span data-stu-id="72bea-167">External</span></span> |
| <span data-ttu-id="72bea-168">*/3443</span><span class="sxs-lookup"><span data-stu-id="72bea-168">* / 3443</span></span> |<span data-ttu-id="72bea-169">In ingresso</span><span class="sxs-lookup"><span data-stu-id="72bea-169">Inbound</span></span> |<span data-ttu-id="72bea-170">TCP</span><span class="sxs-lookup"><span data-stu-id="72bea-170">TCP</span></span> |<span data-ttu-id="72bea-171">Endpoint di gestione per il portale di Azure e PowerShell</span><span class="sxs-lookup"><span data-stu-id="72bea-171">Management endpoint for Azure portal and Powershell</span></span> |<span data-ttu-id="72bea-172">INTERNET / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="72bea-172">INTERNET / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="72bea-173">Esterno e interno</span><span class="sxs-lookup"><span data-stu-id="72bea-173">External & Internal</span></span> |
| <span data-ttu-id="72bea-174">* / 80, 443</span><span class="sxs-lookup"><span data-stu-id="72bea-174">* / 80, 443</span></span> |<span data-ttu-id="72bea-175">In uscita</span><span class="sxs-lookup"><span data-stu-id="72bea-175">Outbound</span></span> |<span data-ttu-id="72bea-176">TCP</span><span class="sxs-lookup"><span data-stu-id="72bea-176">TCP</span></span> |<span data-ttu-id="72bea-177">Dipendenza da Archiviazione di Azure e dal bus di servizio di Azure</span><span class="sxs-lookup"><span data-stu-id="72bea-177">Dependency on Azure Storage and Azure Service Bus</span></span> |<span data-ttu-id="72bea-178">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="72bea-178">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="72bea-179">Esterno e interno</span><span class="sxs-lookup"><span data-stu-id="72bea-179">External & Internal</span></span> |
| <span data-ttu-id="72bea-180">* / 1433</span><span class="sxs-lookup"><span data-stu-id="72bea-180">* / 1433</span></span> |<span data-ttu-id="72bea-181">In uscita</span><span class="sxs-lookup"><span data-stu-id="72bea-181">Outbound</span></span> |<span data-ttu-id="72bea-182">TCP</span><span class="sxs-lookup"><span data-stu-id="72bea-182">TCP</span></span> |<span data-ttu-id="72bea-183">Dipendenza da SQL di Azure</span><span class="sxs-lookup"><span data-stu-id="72bea-183">Dependency on Azure SQL</span></span> |<span data-ttu-id="72bea-184">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="72bea-184">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="72bea-185">Esterno e interno</span><span class="sxs-lookup"><span data-stu-id="72bea-185">External & Internal</span></span> |
| <span data-ttu-id="72bea-186">* / 11000 - 11999</span><span class="sxs-lookup"><span data-stu-id="72bea-186">* / 11000 - 11999</span></span> |<span data-ttu-id="72bea-187">In uscita</span><span class="sxs-lookup"><span data-stu-id="72bea-187">Outbound</span></span> |<span data-ttu-id="72bea-188">TCP</span><span class="sxs-lookup"><span data-stu-id="72bea-188">TCP</span></span> |<span data-ttu-id="72bea-189">Dipendenza da Azure SQL V12</span><span class="sxs-lookup"><span data-stu-id="72bea-189">Dependency on Azure SQL V12</span></span> |<span data-ttu-id="72bea-190">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="72bea-190">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="72bea-191">Esterno e interno</span><span class="sxs-lookup"><span data-stu-id="72bea-191">External & Internal</span></span> |
| <span data-ttu-id="72bea-192">* / 14000 - 14999</span><span class="sxs-lookup"><span data-stu-id="72bea-192">* / 14000 - 14999</span></span> |<span data-ttu-id="72bea-193">In uscita</span><span class="sxs-lookup"><span data-stu-id="72bea-193">Outbound</span></span> |<span data-ttu-id="72bea-194">TCP</span><span class="sxs-lookup"><span data-stu-id="72bea-194">TCP</span></span> |<span data-ttu-id="72bea-195">Dipendenza da Azure SQL V12</span><span class="sxs-lookup"><span data-stu-id="72bea-195">Dependency on Azure SQL V12</span></span> |<span data-ttu-id="72bea-196">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="72bea-196">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="72bea-197">Esterno e interno</span><span class="sxs-lookup"><span data-stu-id="72bea-197">External & Internal</span></span> |
| <span data-ttu-id="72bea-198">* / 5671</span><span class="sxs-lookup"><span data-stu-id="72bea-198">* / 5671</span></span> |<span data-ttu-id="72bea-199">In uscita</span><span class="sxs-lookup"><span data-stu-id="72bea-199">Outbound</span></span> |<span data-ttu-id="72bea-200">AMQP</span><span class="sxs-lookup"><span data-stu-id="72bea-200">AMQP</span></span> |<span data-ttu-id="72bea-201">Dipendenza per il criterio Registra a Hub eventi</span><span class="sxs-lookup"><span data-stu-id="72bea-201">Dependency for Log to Event Hub policy and monitoring agent</span></span> |<span data-ttu-id="72bea-202">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="72bea-202">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="72bea-203">Esterno e interno</span><span class="sxs-lookup"><span data-stu-id="72bea-203">External & Internal</span></span> |
| <span data-ttu-id="72bea-204">6381 - 6383/6381 - 6383</span><span class="sxs-lookup"><span data-stu-id="72bea-204">6381 - 6383 / 6381 - 6383</span></span> |<span data-ttu-id="72bea-205">In ingresso e in uscita</span><span class="sxs-lookup"><span data-stu-id="72bea-205">Inbound & Outbound</span></span> |<span data-ttu-id="72bea-206">UDP</span><span class="sxs-lookup"><span data-stu-id="72bea-206">UDP</span></span> |<span data-ttu-id="72bea-207">Dipendenza dalla cache Redis</span><span class="sxs-lookup"><span data-stu-id="72bea-207">Dependency on Redis Cache</span></span> |<span data-ttu-id="72bea-208">VIRTUAL_NETWORK / VIRTUAL_NETWORK</span><span class="sxs-lookup"><span data-stu-id="72bea-208">VIRTUAL_NETWORK / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="72bea-209">Esterno e interno</span><span class="sxs-lookup"><span data-stu-id="72bea-209">External & Internal</span></span> |-
| <span data-ttu-id="72bea-210">* / 445</span><span class="sxs-lookup"><span data-stu-id="72bea-210">* / 445</span></span> |<span data-ttu-id="72bea-211">In uscita</span><span class="sxs-lookup"><span data-stu-id="72bea-211">Outbound</span></span> |<span data-ttu-id="72bea-212">TCP</span><span class="sxs-lookup"><span data-stu-id="72bea-212">TCP</span></span> |<span data-ttu-id="72bea-213">Dipendenza dalla condivisione file di Azure per GIT</span><span class="sxs-lookup"><span data-stu-id="72bea-213">Dependency on Azure File Share for GIT</span></span> |<span data-ttu-id="72bea-214">VIRTUAL_NETWORK / INTERNET</span><span class="sxs-lookup"><span data-stu-id="72bea-214">VIRTUAL_NETWORK / INTERNET</span></span> |<span data-ttu-id="72bea-215">Esterno e interno</span><span class="sxs-lookup"><span data-stu-id="72bea-215">External & Internal</span></span> |
| <span data-ttu-id="72bea-216">* / *</span><span class="sxs-lookup"><span data-stu-id="72bea-216">* / *</span></span> | <span data-ttu-id="72bea-217">In ingresso</span><span class="sxs-lookup"><span data-stu-id="72bea-217">Inbound</span></span> |<span data-ttu-id="72bea-218">TCP</span><span class="sxs-lookup"><span data-stu-id="72bea-218">TCP</span></span> |<span data-ttu-id="72bea-219">Bilanciamento del carico di infrastruttura di Azure</span><span class="sxs-lookup"><span data-stu-id="72bea-219">Azure Infrastructure Load Balancer</span></span> | <span data-ttu-id="72bea-220">VIRTUAL_NETWORK/AZURE_LOADBALANCER</span><span class="sxs-lookup"><span data-stu-id="72bea-220">AZURE_LOAD_BALANCER / VIRTUAL_NETWORK</span></span> |<span data-ttu-id="72bea-221">Esterno e interno</span><span class="sxs-lookup"><span data-stu-id="72bea-221">External & Internal</span></span> |

* <span data-ttu-id="72bea-222">**Funzionalità SSL**: per abilitare la creazione e la convalida della catena di certificati SSL, il servizio Gestione API richiede la connettività di rete in uscita a ocsp.msocsp.com, mscrl.microsoft.com e crl.microsoft.com. Questa dipendenza non è necessaria se un certificato caricato in Gestione API contiene l'intera catena per la radice dell'autorità di certificazione.</span><span class="sxs-lookup"><span data-stu-id="72bea-222">**SSL functionality**: To enable SSL certificate chain building and validation the API Management service needs Outbound network connectivity to ocsp.msocsp.com, mscrl.microsoft.com and crl.microsoft.com. This dependency is not required, if any certificate you upload to API Management contain the full chain to the CA root.</span></span>

* <span data-ttu-id="72bea-223">**Accesso a DNS**: l'accesso in uscita sulla porta 53 è necessario per la comunicazione con i server DNS.</span><span class="sxs-lookup"><span data-stu-id="72bea-223">**DNS Access**: Outbound access on port 53 is required for communication with DNS servers.</span></span> <span data-ttu-id="72bea-224">Se è presente un server DNS personalizzato all'altra estremità di un gateway VPN, il server DNS deve essere raggiungibile dalla subnet che ospita Gestione API.</span><span class="sxs-lookup"><span data-stu-id="72bea-224">If a custom DNS server exists on the other end of a VPN gateway, the DNS server must be reachable from the subnet hosting API Management.</span></span>

* <span data-ttu-id="72bea-225">**Le metriche e il monitoraggio dell'integrità**: la connettività di rete in uscita agli endpoint di Monitoraggio di Azure, che si risolve nei domini seguenti: global.metrics.nsatc.net, shoebox2.metrics.nsatc.net, prod3.metrics.nsatc.net.</span><span class="sxs-lookup"><span data-stu-id="72bea-225">**Metrics and Health Monitoring**: Outbound network connectivity to Azure Monitoring endpoints, which resolve under the following domains: global.metrics.nsatc.net, shoebox2.metrics.nsatc.net, prod3.metrics.nsatc.net.</span></span>

* <span data-ttu-id="72bea-226">**Installazione di Express Route**: secondo una diffusa configurazione, i clienti definiscono la propria route predefinita (0.0.0.0/0) verso la quale viene forzato il traffico Internet in uscita invece di far passare il flusso localmente.</span><span class="sxs-lookup"><span data-stu-id="72bea-226">**Express Route Setup**: A common customer configuration is to define their own default route (0.0.0.0/0) which forces outbound Internet traffic to instead flow on-premises.</span></span> <span data-ttu-id="72bea-227">Questo flusso di traffico interrompe sempre la connettività con Gestione API di Azure perché il traffico in uscita è bloccato in locale o convertito tramite NAT in un set non riconoscibile di indirizzi che non usano più i diversi endpoint di Azure.</span><span class="sxs-lookup"><span data-stu-id="72bea-227">This traffic flow invariably breaks connectivity with Azure API Management because the outbound traffic is either blocked on-premises, or NAT'd to an unrecognizable set of addresses that no longer work with various Azure endpoints.</span></span> <span data-ttu-id="72bea-228">La soluzione consiste nel definire una o più route definite dall'utente ([UDR][UDRs], User Defined Routes) o nella subnet contenente il servizio Gestione API di Azure.</span><span class="sxs-lookup"><span data-stu-id="72bea-228">The solution is to define one (or more) user-defined routes ([UDRs][UDRs]) on the subnet that contains the Azure API Management.</span></span> <span data-ttu-id="72bea-229">Una route UDR definisce le route specifiche della subnet che verranno accettate invece della route predefinita.</span><span class="sxs-lookup"><span data-stu-id="72bea-229">A UDR defines subnet-specific routes that will be honored instead of the default route.</span></span>
  <span data-ttu-id="72bea-230">Se possibile, è consigliabile utilizzare la seguente configurazione:</span><span class="sxs-lookup"><span data-stu-id="72bea-230">If possible, it is recommended to use the following configuration:</span></span>
 * <span data-ttu-id="72bea-231">La configurazione di ExpressRoute annuncia 0.0.0.0/0 e per impostazione predefinita esegue il tunneling forzato di tutto il traffico in uscita in un ambiente locale.</span><span class="sxs-lookup"><span data-stu-id="72bea-231">The ExpressRoute configuration advertises 0.0.0.0/0 and by default force tunnels all outbound traffic on-premises.</span></span>
 * <span data-ttu-id="72bea-232">L'UDR applicata alla subnet contenente il servizio Gestione API di Azure definisce 0.0.0.0/0 con un tipo di hop successivo di Internet.</span><span class="sxs-lookup"><span data-stu-id="72bea-232">The UDR applied to the subnet containing the Azure API Management defines 0.0.0.0/0 with a next hop type of Internet.</span></span>
 <span data-ttu-id="72bea-233">L'effetto combinato di questi passaggi è che il livello di subnet UDR avrà la precedenza sul tunneling forzato di ExpressRoute, garantendo l'accesso a Internet in uscita dal servizio Gestione API di Azure.</span><span class="sxs-lookup"><span data-stu-id="72bea-233">The combined effect of these steps is that the subnet level UDR takes precedence over the ExpressRoute forced tunneling, thus ensuring outbound Internet access from the Azure API Management.</span></span>

>[!WARNING]  
><span data-ttu-id="72bea-234">Gestione API di Azure non è supportato con le configurazioni di ExpressRoute che **annunciano erroneamente route dal percorso di peering pubblico al percorso di peering privato**.</span><span class="sxs-lookup"><span data-stu-id="72bea-234">Azure API Management is not supported with ExpressRoute configurations that **incorrectly cross-advertise routes from the public peering path to the private peering path**.</span></span> <span data-ttu-id="72bea-235">Le configurazioni di ExpressRoute che dispongono di peering pubblico configurato, riceveranno gli annunci di route da Microsoft per un elevato numero di intervalli di indirizzi IP di Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="72bea-235">ExpressRoute configurations that have public peering configured, will receive route advertisements from Microsoft for a large set of Microsoft Azure IP address ranges.</span></span> <span data-ttu-id="72bea-236">Se questi intervalli di indirizzi vengono annunciati in modo non corretto nel percorso di peering privato, il risultato finale è che tutti i pacchetti di rete in uscita dalla subnet dell'istanza di Gestione API di Azure verranno erroneamente sottoposti a tunneling forzato verso l'infrastruttura di rete locale del cliente.</span><span class="sxs-lookup"><span data-stu-id="72bea-236">If these address ranges are incorrectly cross-advertised on the private peering path, the end result is that all outbound network packets from the Azure API Management instance's subnet are incorrectly force-tunneled to a customer's on-premises network infrastructure.</span></span> <span data-ttu-id="72bea-237">Questo flusso di rete interromperà il servizio Gestione API di Azure.</span><span class="sxs-lookup"><span data-stu-id="72bea-237">This network flow breaks Azure API Management.</span></span> <span data-ttu-id="72bea-238">La soluzione a questo problema consiste nell'interrompere l'annuncio di più route dal percorso di peering pubblico al percorso di peering privato.</span><span class="sxs-lookup"><span data-stu-id="72bea-238">The solution to this problem is to stop cross-advertising routes from the public peering path to the private peering path.</span></span>


## <span data-ttu-id="72bea-239"><a name="troubleshooting"> </a>Risoluzione dei problemi</span><span class="sxs-lookup"><span data-stu-id="72bea-239"><a name="troubleshooting"> </a>Troubleshooting</span></span>
<span data-ttu-id="72bea-240">Quando si apportano modifiche alla rete, per verificare che il servizio Gestione API non abbia perso l'accesso a risorse critiche da cui dipende, vedere l'articolo relativo all'[API per lo stato di rete](https://docs.microsoft.com/en-us/rest/api/apimanagement/networkstatus).</span><span class="sxs-lookup"><span data-stu-id="72bea-240">When making changes to your network, refer to [NetworkStatus API](https://docs.microsoft.com/en-us/rest/api/apimanagement/networkstatus), to validate if the API Management service has not lost access to any of the critical resources which it depends upon.</span></span> <span data-ttu-id="72bea-241">Lo stato della connettività dovrebbe essere aggiornato ogni 15 minuti.</span><span class="sxs-lookup"><span data-stu-id="72bea-241">The connectivity status should be updated every 15 minutes.</span></span>

## <span data-ttu-id="72bea-242"><a name="limitations"> </a>Limitazioni</span><span class="sxs-lookup"><span data-stu-id="72bea-242"><a name="limitations"> </a>Limitations</span></span>
* <span data-ttu-id="72bea-243">Una subnet contenente le istanze di Gestione API non può contenere altri tipi di risorse di Azure.</span><span class="sxs-lookup"><span data-stu-id="72bea-243">A subnet containing API Management instances cannot contain any other Azure resource types.</span></span>
* <span data-ttu-id="72bea-244">La subnet e il servizio di Gestione API devono essere nella stessa sottoscrizione.</span><span class="sxs-lookup"><span data-stu-id="72bea-244">The subnet and the API Management service must be in the same subscription.</span></span>
* <span data-ttu-id="72bea-245">Una subnet contenente le istanze di gestione API non può essere spostata da una sottoscrizione all'altra.</span><span class="sxs-lookup"><span data-stu-id="72bea-245">A subnet containing API Management instances cannot be moved across subscriptions.</span></span>
* <span data-ttu-id="72bea-246">Quando si usa una rete virtuale interna sarà disponibile un solo indirizzo IP interno proveniente dall'intervallo indicato in [RFC 1918](https://tools.ietf.org/html/rfc1918), mentre non verrà fornito alcun indirizzo IP pubblico.</span><span class="sxs-lookup"><span data-stu-id="72bea-246">When using an internal virtual network, only an internal IP address will be available from the range stated in [RFC 1918](https://tools.ietf.org/html/rfc1918), a public IP address cannot be provided.</span></span>
* <span data-ttu-id="72bea-247">Per le distribuzioni di Gestione API su più aree con reti virtuali interne configurate, gli utenti sono responsabili della gestione diretta del bilanciamento del carico poiché sono titolari del DNS.</span><span class="sxs-lookup"><span data-stu-id="72bea-247">For multi-region API Management deployments, with Internal virtual networks configured, users are responsible for managing their own load balancing as they own the DNS.</span></span>


## <span data-ttu-id="72bea-248"><a name="related-content"> </a>Contenuti correlati</span><span class="sxs-lookup"><span data-stu-id="72bea-248"><a name="related-content"> </a>Related content</span></span>
* [<span data-ttu-id="72bea-249">Connessione di una rete virtuale al back-end tramite Gateway VPN</span><span class="sxs-lookup"><span data-stu-id="72bea-249">Connecting a Virtual Network to backend using Vpn Gateway</span></span>](../vpn-gateway/vpn-gateway-about-vpngateways.md#s2smulti)
* [<span data-ttu-id="72bea-250">Connessione di una rete virtuale da modelli di distribuzione differenti</span><span class="sxs-lookup"><span data-stu-id="72bea-250">Connecting a Virtual Network from different deployment models</span></span>](../vpn-gateway/vpn-gateway-connect-different-deployment-models-powershell.md)
* [<span data-ttu-id="72bea-251">Come usare Controllo API per tenere traccia delle chiamate in Gestione API di Azure</span><span class="sxs-lookup"><span data-stu-id="72bea-251">How to use the API Inspector to trace calls in Azure API Management</span></span>](api-management-howto-api-inspector.md)

[api-management-using-vnet-menu]: ./media/api-management-using-with-vnet/api-management-menu-vnet.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-type.png
[api-management-setup-vpn-select]: ./media/api-management-using-with-vnet/api-management-using-vnet-select.png
[api-management-setup-vpn-add-api]: ./media/api-management-using-with-vnet/api-management-using-vnet-add-api.png
[api-management-vnet-private]: ./media/api-management-using-with-vnet/api-management-vnet-private.png
[api-management-vnet-public]: ./media/api-management-using-with-vnet/api-management-vnet-public.png

[Enable VPN connections]: #enable-vpn
[Connect to a web service behind VPN]: #connect-vpn
[Related content]: #related-content

[UDRs]: ../virtual-network/virtual-networks-udr-overview.md
[Network Security Group]: ../virtual-network/virtual-networks-nsg.md
