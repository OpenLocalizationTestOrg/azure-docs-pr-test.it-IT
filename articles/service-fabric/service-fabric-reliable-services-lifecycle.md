---
title: aaaOverview di hello del ciclo di vita di servizi di Azure Service Fabric affidabile | Documenti Microsoft
description: Informazioni sugli eventi del ciclo di vita diversi hello in servizi di Service Fabric affidabili
services: Service-Fabric
documentationcenter: .net
author: masnider
manager: timlt
editor: vturecek;
ms.assetid: 
ms.service: Service-Fabric
ms.devlang: dotnet
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 08/18/2017
ms.author: masnider
ms.openlocfilehash: 0d75ed5ee7cda85ac9af6a02e160727277804a2b
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 10/06/2017
---
# <a name="reliable-services-lifecycle-overview"></a><span data-ttu-id="a8c75-103">Panoramica del ciclo di vita di Reliable Services</span><span class="sxs-lookup"><span data-stu-id="a8c75-103">Reliable services lifecycle overview</span></span>
> [!div class="op_single_selector"]
> * [<span data-ttu-id="a8c75-104">C# su Windows</span><span class="sxs-lookup"><span data-stu-id="a8c75-104">C# on Windows</span></span>](service-fabric-reliable-services-lifecycle.md)
> * [<span data-ttu-id="a8c75-105">Java su Linux</span><span class="sxs-lookup"><span data-stu-id="a8c75-105">Java on Linux</span></span>](service-fabric-reliable-services-lifecycle-java.md)
>
>

<span data-ttu-id="a8c75-106">Quando si pensa hello cicli di vita di servizi affidabili, funzionalità di base di hello del ciclo di vita hello sono hello più importante.</span><span class="sxs-lookup"><span data-stu-id="a8c75-106">When thinking about hello lifecycles of Reliable Services, hello basics of hello lifecycle are hello most important.</span></span> <span data-ttu-id="a8c75-107">In generale:</span><span class="sxs-lookup"><span data-stu-id="a8c75-107">In general:</span></span>

- <span data-ttu-id="a8c75-108">Durante l'avvio</span><span class="sxs-lookup"><span data-stu-id="a8c75-108">During Startup</span></span>
  - <span data-ttu-id="a8c75-109">I servizi vengono costruiti</span><span class="sxs-lookup"><span data-stu-id="a8c75-109">Services are constructed</span></span>
  - <span data-ttu-id="a8c75-110">Hanno un tooconstruct opportunità e restituire zero o più listener</span><span class="sxs-lookup"><span data-stu-id="a8c75-110">They have an opportunity tooconstruct and return zero or more listeners</span></span>
  - <span data-ttu-id="a8c75-111">Qualsiasi listener restituito sono aperte, consentendo la comunicazione con il servizio hello</span><span class="sxs-lookup"><span data-stu-id="a8c75-111">Any returned listeners are opened, allowing communication with hello service</span></span>
  - <span data-ttu-id="a8c75-112">RunAsync Hello del servizio viene chiamato, consentendo di hello servizio toodo a esecuzione prolungata o lavoro in background</span><span class="sxs-lookup"><span data-stu-id="a8c75-112">hello Service's RunAsync method is called, allowing hello service toodo long running or background work</span></span>
- <span data-ttu-id="a8c75-113">Durante l'arresto</span><span class="sxs-lookup"><span data-stu-id="a8c75-113">During shutdown</span></span>
  - <span data-ttu-id="a8c75-114">tooRunAsync passato di Hello annullamento token viene annullato e vengono chiuse listener hello</span><span class="sxs-lookup"><span data-stu-id="a8c75-114">hello cancellation token passed tooRunAsync is canceled, and hello listeners are closed</span></span>
  - <span data-ttu-id="a8c75-115">Una volta completato, hello servizio oggetto eliminato</span><span class="sxs-lookup"><span data-stu-id="a8c75-115">Once that is complete, hello service object itself is destructed</span></span>

<span data-ttu-id="a8c75-116">Sono disponibili informazioni dettagliate sugli hello esatto di ordinamento di questi eventi.</span><span class="sxs-lookup"><span data-stu-id="a8c75-116">There are details around hello exact ordering of these events.</span></span> <span data-ttu-id="a8c75-117">In particolare, ordine hello degli eventi può cambiare leggermente a seconda che sia di hello servizio affidabile Stateless o informazioni sullo stato.</span><span class="sxs-lookup"><span data-stu-id="a8c75-117">In particular, hello order of events may change slightly depending on whether hello Reliable Service is Stateless or Stateful.</span></span> <span data-ttu-id="a8c75-118">Inoltre, per i servizi con stati, abbiamo toodeal con uno scenario di scambio primario hello.</span><span class="sxs-lookup"><span data-stu-id="a8c75-118">In addition, for stateful services, we have toodeal with hello Primary swap scenario.</span></span> <span data-ttu-id="a8c75-119">Durante questa sequenza, ruolo hello database primario replica tooanother trasferiti (o torna) senza l'arresto del servizio hello.</span><span class="sxs-lookup"><span data-stu-id="a8c75-119">During this sequence, hello role of Primary is transferred tooanother replica (or comes back) without hello service shutting down.</span></span> <span data-ttu-id="a8c75-120">Infine, abbiamo toothink sulle condizioni di errore o di.</span><span class="sxs-lookup"><span data-stu-id="a8c75-120">Finally, we have toothink about error or failure conditions.</span></span>

## <a name="stateless-service-startup"></a><span data-ttu-id="a8c75-121">Avvio di un servizio senza stato</span><span class="sxs-lookup"><span data-stu-id="a8c75-121">Stateless service startup</span></span>
<span data-ttu-id="a8c75-122">Hello ciclo di vita di un servizio senza stato è piuttosto semplice.</span><span class="sxs-lookup"><span data-stu-id="a8c75-122">hello lifecycle of a stateless service is fairly straightforward.</span></span> <span data-ttu-id="a8c75-123">Ecco l'ordine di hello degli eventi:</span><span class="sxs-lookup"><span data-stu-id="a8c75-123">Here's hello order of events:</span></span>

1. <span data-ttu-id="a8c75-124">Hello servizio viene costruito</span><span class="sxs-lookup"><span data-stu-id="a8c75-124">hello Service is constructed</span></span>
2. <span data-ttu-id="a8c75-125">Quindi si verificano due cose in parallelo:</span><span class="sxs-lookup"><span data-stu-id="a8c75-125">Then, in parallel two things happen:</span></span>
    - <span data-ttu-id="a8c75-126">Viene richiamato `StatelessService.CreateServiceInstanceListeners()` e vengono aperti eventuali listener restituiti.</span><span class="sxs-lookup"><span data-stu-id="a8c75-126">`StatelessService.CreateServiceInstanceListeners()` is invoked and any returned listeners are Opened.</span></span> <span data-ttu-id="a8c75-127">Viene richiamato `ICommunicationListener.OpenAsync()` su ogni listener</span><span class="sxs-lookup"><span data-stu-id="a8c75-127">`ICommunicationListener.OpenAsync()` is called on each listener</span></span>
    - <span data-ttu-id="a8c75-128">Hello del servizio `StatelessService.RunAsync()` viene chiamato</span><span class="sxs-lookup"><span data-stu-id="a8c75-128">hello service's `StatelessService.RunAsync()` method is called</span></span>
3. <span data-ttu-id="a8c75-129">Se presente, hello del servizio `StatelessService.OnOpenAsync()` viene chiamato.</span><span class="sxs-lookup"><span data-stu-id="a8c75-129">If present, hello service's `StatelessService.OnOpenAsync()` method is called.</span></span> <span data-ttu-id="a8c75-130">Si tratta di un override insolito ma comunque disponibile.</span><span class="sxs-lookup"><span data-stu-id="a8c75-130">This is an uncommon override, but it is available.</span></span>

<span data-ttu-id="a8c75-131">È importante toonote che non vi sia alcun ordinamento tra toocreate chiamate hello e i listener hello aperto e RunAsync.</span><span class="sxs-lookup"><span data-stu-id="a8c75-131">It is important toonote that there is no ordering between hello calls toocreate and open hello listeners and RunAsync.</span></span> <span data-ttu-id="a8c75-132">listener Hello venga aperto prima dell'avvio di RunAsync.</span><span class="sxs-lookup"><span data-stu-id="a8c75-132">hello listeners may open before RunAsync is started.</span></span> <span data-ttu-id="a8c75-133">Analogamente, RunAsync rischia di richiamato prima che il listener di comunicazione hello è aperto o anche costruito.</span><span class="sxs-lookup"><span data-stu-id="a8c75-133">Similarly, RunAsync may end up invoked before hello communication listeners are open or have even been constructed.</span></span> <span data-ttu-id="a8c75-134">Se è necessario eseguire qualsiasi sincronizzazione, viene lasciato in qualità di implementatore toohello esercizio.</span><span class="sxs-lookup"><span data-stu-id="a8c75-134">If any synchronization is required, it is left as an exercise toohello implementer.</span></span> <span data-ttu-id="a8c75-135">Soluzioni comuni:</span><span class="sxs-lookup"><span data-stu-id="a8c75-135">Common solutions:</span></span>

  - <span data-ttu-id="a8c75-136">Talvolta i listener non possono funzionare fino a quando non vengono create altre informazioni o eseguite determinate operazioni.</span><span class="sxs-lookup"><span data-stu-id="a8c75-136">Sometimes listeners can't function until some other information is created or work done.</span></span> <span data-ttu-id="a8c75-137">Per i servizi senza stato le cui operazioni possono essere in genere eseguite in altre posizioni, ad esempio:</span><span class="sxs-lookup"><span data-stu-id="a8c75-137">For stateless services that work can usually be done in other locations, such as:</span></span> 
    - <span data-ttu-id="a8c75-138">nel costruttore del servizio hello</span><span class="sxs-lookup"><span data-stu-id="a8c75-138">in hello service's constructor</span></span>
    - <span data-ttu-id="a8c75-139">durante la hello `CreateServiceInstanceListeners()` chiamare</span><span class="sxs-lookup"><span data-stu-id="a8c75-139">during hello `CreateServiceInstanceListeners()` call</span></span>
    - <span data-ttu-id="a8c75-140">come parte della costruzione di hello del listener hello stesso</span><span class="sxs-lookup"><span data-stu-id="a8c75-140">as a part of hello construction of hello listener itself</span></span>
  - <span data-ttu-id="a8c75-141">Hello codice RunAsync non talvolta toostart fino a quando non sono aperti listener hello.</span><span class="sxs-lookup"><span data-stu-id="a8c75-141">Sometimes hello code in RunAsync does not want toostart until hello listeners are open.</span></span> <span data-ttu-id="a8c75-142">In questo caso è necessario un po' di coordinamento in più.</span><span class="sxs-lookup"><span data-stu-id="a8c75-142">In this case additional coordination is necessary.</span></span> <span data-ttu-id="a8c75-143">Una soluzione comune è alcuni flag all'interno di listener hello che indica quando è stata completata.</span><span class="sxs-lookup"><span data-stu-id="a8c75-143">One common solution is some flag within hello listeners indicating when they have completed.</span></span> <span data-ttu-id="a8c75-144">Questo flag viene quindi archiviato RunAsync prima di continuare a utilizzare tooactual.</span><span class="sxs-lookup"><span data-stu-id="a8c75-144">This flag is then checked in RunAsync before continuing tooactual work.</span></span>

## <a name="stateless-service-shutdown"></a><span data-ttu-id="a8c75-145">Arresto di un servizio senza stato</span><span class="sxs-lookup"><span data-stu-id="a8c75-145">Stateless service shutdown</span></span>
<span data-ttu-id="a8c75-146">Quando un servizio senza stato di arresto, hello stesso modello viene seguito, solo in senso inverso:</span><span class="sxs-lookup"><span data-stu-id="a8c75-146">When shutting down a stateless service, hello same pattern is followed, just in reverse:</span></span>

1. <span data-ttu-id="a8c75-147">In parallelo</span><span class="sxs-lookup"><span data-stu-id="a8c75-147">In parallel</span></span>
    - <span data-ttu-id="a8c75-148">Gli eventuali listener aperti vengono chiusi.</span><span class="sxs-lookup"><span data-stu-id="a8c75-148">Any open listeners are Closed.</span></span> <span data-ttu-id="a8c75-149">Viene richiamato `ICommunicationListener.CloseAsync()` su ogni listener.</span><span class="sxs-lookup"><span data-stu-id="a8c75-149">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="a8c75-150">token di annullamento Hello passato troppo`RunAsync()` viene annullata.</span><span class="sxs-lookup"><span data-stu-id="a8c75-150">hello cancellation token passed too`RunAsync()` is canceled.</span></span> <span data-ttu-id="a8c75-151">Del controllo hello token di annullamento `IsCancellationRequested` proprietà restituisce true e se la chiamata del token hello `ThrowIfCancellationRequested` metodo genera un `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="a8c75-151">Checking hello cancellation token's `IsCancellationRequested` property returns true, and if called hello token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="a8c75-152">Una volta `CloseAsync()` completa per ogni listener e `RunAsync()` completa inoltre del servizio hello `StatelessService.OnCloseAsync()` metodo viene chiamato, se presente.</span><span class="sxs-lookup"><span data-stu-id="a8c75-152">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, hello service's `StatelessService.OnCloseAsync()` method is called, if present.</span></span> <span data-ttu-id="a8c75-153">È comune toooverride `StatelessService.OnCloseAsync()`.</span><span class="sxs-lookup"><span data-stu-id="a8c75-153">It is uncommon toooverride `StatelessService.OnCloseAsync()`.</span></span>
3. <span data-ttu-id="a8c75-154">Dopo aver `StatelessService.OnCloseAsync()` viene completato, viene eliminato l'oggetto servizio hello</span><span class="sxs-lookup"><span data-stu-id="a8c75-154">After `StatelessService.OnCloseAsync()` completes, hello service object is destructed</span></span>

## <a name="stateful-service-startup"></a><span data-ttu-id="a8c75-155">Avvio di un servizio con stato</span><span class="sxs-lookup"><span data-stu-id="a8c75-155">Stateful service Startup</span></span>
<span data-ttu-id="a8c75-156">Servizi con stati hanno un servizi toostateless modello simile, con poche modifiche.</span><span class="sxs-lookup"><span data-stu-id="a8c75-156">Stateful services have a similar pattern toostateless services, with a few changes.</span></span> <span data-ttu-id="a8c75-157">All'avvio di un servizio con stato, ordine di hello degli eventi è come segue:</span><span class="sxs-lookup"><span data-stu-id="a8c75-157">When starting up a stateful service, hello order of events is as follows:</span></span>

1. <span data-ttu-id="a8c75-158">Hello servizio viene costruito</span><span class="sxs-lookup"><span data-stu-id="a8c75-158">hello Service is constructed</span></span>
2. <span data-ttu-id="a8c75-159">Viene chiamato `StatefulServiceBase.OnOpenAsync()`.</span><span class="sxs-lookup"><span data-stu-id="a8c75-159">`StatefulServiceBase.OnOpenAsync()` is called.</span></span> <span data-ttu-id="a8c75-160">Questo viene eseguito l'override uncommonly nel servizio hello.</span><span class="sxs-lookup"><span data-stu-id="a8c75-160">This is uncommonly overridden in hello service.</span></span>
3. <span data-ttu-id="a8c75-161">Hello eseguite le operazioni seguenti in parallelo</span><span class="sxs-lookup"><span data-stu-id="a8c75-161">hello following things happen in parallel</span></span>
    - <span data-ttu-id="a8c75-162">Viene richiamato `StatefulServiceBase.CreateServiceReplicaListeners()`.</span><span class="sxs-lookup"><span data-stu-id="a8c75-162">`StatefulServiceBase.CreateServiceReplicaListeners()` is invoked</span></span> 
      - <span data-ttu-id="a8c75-163">Se il servizio di hello è un database primario vengono aperti tutti i listener restituiti.</span><span class="sxs-lookup"><span data-stu-id="a8c75-163">If hello service is a Primary all returned listeners are Opened.</span></span> <span data-ttu-id="a8c75-164">Viene richiamato `ICommunicationListener.OpenAsync()` su ogni listener.</span><span class="sxs-lookup"><span data-stu-id="a8c75-164">`ICommunicationListener.OpenAsync()` is called on each listener.</span></span>
      - <span data-ttu-id="a8c75-165">Se il servizio di hello è un database secondario, solo i listener è contrassegnato come `ListenOnSecondary = true` siano aperte.</span><span class="sxs-lookup"><span data-stu-id="a8c75-165">If hello service is a Secondary, only those listeners marked as `ListenOnSecondary = true` are opened.</span></span> <span data-ttu-id="a8c75-166">L'apertura di listener aperti su servizi di tipo secondario è meno comune.</span><span class="sxs-lookup"><span data-stu-id="a8c75-166">Having listeners that are open on Secondaries is less common.</span></span>
    - <span data-ttu-id="a8c75-167">Hello se hello servizio è attualmente un servizio hello primario, `StatefulServiceBase.RunAsync()` metodo viene chiamato</span><span class="sxs-lookup"><span data-stu-id="a8c75-167">hello if hello Service is currently a Primary, hello service's `StatefulServiceBase.RunAsync()` method is called</span></span>
4. <span data-ttu-id="a8c75-168">Una volta tutti hello del listener replica `OpenAsync()` effettua le chiamate e `RunAsync()` viene chiamato, `StatefulServiceBase.OnChangeRoleAsync()` viene chiamato.</span><span class="sxs-lookup"><span data-stu-id="a8c75-168">Once all hello replica listener's `OpenAsync()` calls complete and `RunAsync()` is called, `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="a8c75-169">Questo viene eseguito l'override uncommonly nel servizio hello.</span><span class="sxs-lookup"><span data-stu-id="a8c75-169">This is uncommonly overridden in hello service.</span></span>

<span data-ttu-id="a8c75-170">Allo stesso modo toostateless services, non vi è alcun ordine hello in cui hello listener sono creati e aperto di coordinamento e quando viene chiamato RunAsync.</span><span class="sxs-lookup"><span data-stu-id="a8c75-170">Similarly toostateless services, there's no coordination between hello order in which hello listeners are created and opened and when RunAsync is called.</span></span> <span data-ttu-id="a8c75-171">Se è necessario il coordinamento, soluzioni hello sono molto hello stesso.</span><span class="sxs-lookup"><span data-stu-id="a8c75-171">If you need coordination, hello solutions are much hello same.</span></span> <span data-ttu-id="a8c75-172">Caso aggiuntive: ad esempio che le chiamate di hello in arrivo presso il listener di comunicazione hello richiedono informazioni contenute in alcune [raccolte affidabile](service-fabric-reliable-services-reliable-collections.md).</span><span class="sxs-lookup"><span data-stu-id="a8c75-172">THere is one additional case: say that hello calls arriving at hello communication listeners require information kept inside some [Reliable Collections](service-fabric-reliable-services-reliable-collections.md).</span></span> <span data-ttu-id="a8c75-173">Poiché è stato possibile aprire il listener di comunicazione hello prima raccolte affidabile hello sono leggibile o scrivibile e prima di RunAsync è stato possibile avviare, alcuni coordinamento aggiuntivo è necessario.</span><span class="sxs-lookup"><span data-stu-id="a8c75-173">Because hello communication listeners could open before hello reliable collections are readable or writeable, and before RunAsync could start, some additional coordination is necessary.</span></span> <span data-ttu-id="a8c75-174">soluzione più semplice e più comune di Hello è per hello comunicazione listener tooreturn un codice di errore che hello client utilizza tooknow tooretry hello richiesta.</span><span class="sxs-lookup"><span data-stu-id="a8c75-174">hello simplest and most common solution is for hello communication listeners tooreturn some error code that hello client uses tooknow tooretry hello request.</span></span>

## <a name="stateful-service-shutdown"></a><span data-ttu-id="a8c75-175">Arresto di un servizio con stato</span><span class="sxs-lookup"><span data-stu-id="a8c75-175">Stateful service Shutdown</span></span>
<span data-ttu-id="a8c75-176">Allo stesso modo tooStateless servizi, gli eventi del ciclo di vita di hello durante l'arresto vengono hello stesso durante l'avvio, ma invertita.</span><span class="sxs-lookup"><span data-stu-id="a8c75-176">Similarly tooStateless services, hello lifecycle events during shutdown are hello same as during startup, but reversed.</span></span> <span data-ttu-id="a8c75-177">Quando un servizio con stato verrà arrestato, hello si verificano eventi seguenti:</span><span class="sxs-lookup"><span data-stu-id="a8c75-177">When a stateful service is being shut down, hello following events occur:</span></span>

1. <span data-ttu-id="a8c75-178">In parallelo</span><span class="sxs-lookup"><span data-stu-id="a8c75-178">In parallel</span></span>
    - <span data-ttu-id="a8c75-179">Gli eventuali listener aperti vengono chiusi.</span><span class="sxs-lookup"><span data-stu-id="a8c75-179">Any open listeners are Closed.</span></span> <span data-ttu-id="a8c75-180">Viene richiamato `ICommunicationListener.CloseAsync()` su ogni listener.</span><span class="sxs-lookup"><span data-stu-id="a8c75-180">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="a8c75-181">token di annullamento Hello passato troppo`RunAsync()` viene annullata.</span><span class="sxs-lookup"><span data-stu-id="a8c75-181">hello cancellation token passed too`RunAsync()` is canceled.</span></span> <span data-ttu-id="a8c75-182">Del controllo hello token di annullamento `IsCancellationRequested` proprietà restituisce true e se la chiamata del token hello `ThrowIfCancellationRequested` metodo genera un `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="a8c75-182">Checking hello cancellation token's `IsCancellationRequested` property returns true, and if called hello token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="a8c75-183">Una volta `CloseAsync()` completa per ogni listener e `RunAsync()` completa inoltre del servizio hello `StatefulServiceBase.OnChangeRoleAsync()` viene chiamato.</span><span class="sxs-lookup"><span data-stu-id="a8c75-183">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, hello service's `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="a8c75-184">(Questo uncommonly sottoposto a override in servizio hello.)</span><span class="sxs-lookup"><span data-stu-id="a8c75-184">(This is uncommonly overridden in hello service.)</span></span>
    - <span data-ttu-id="a8c75-185">In attesa di RunAsync toocomplete è necessaria solo se questa replica del servizio è un database primario.</span><span class="sxs-lookup"><span data-stu-id="a8c75-185">Waiting for RunAsync toocomplete is only necessary if this service replica was a Primary.</span></span>
3. <span data-ttu-id="a8c75-186">Una volta hello `StatefulServiceBase.OnChangeRoleAsync()` metodo viene completato, hello `StatefulServiceBase.OnCloseAsync()` metodo viene chiamato.</span><span class="sxs-lookup"><span data-stu-id="a8c75-186">Once hello `StatefulServiceBase.OnChangeRoleAsync()` method completes, hello `StatefulServiceBase.OnCloseAsync()` method is called.</span></span> <span data-ttu-id="a8c75-187">Si tratta di un override insolito ma comunque disponibile.</span><span class="sxs-lookup"><span data-stu-id="a8c75-187">This is an uncommon override, but it is available.</span></span>
3. <span data-ttu-id="a8c75-188">Dopo aver `StatefulServiceBase.OnCloseAsync()` viene completato, viene eliminato l'oggetto servizio hello.</span><span class="sxs-lookup"><span data-stu-id="a8c75-188">After `StatefulServiceBase.OnCloseAsync()` completes, hello service object is destructed.</span></span>

## <a name="stateful-service-primary-swaps"></a><span data-ttu-id="a8c75-189">Scambi primari di un servizio con stato</span><span class="sxs-lookup"><span data-stu-id="a8c75-189">Stateful service primary swaps</span></span>
<span data-ttu-id="a8c75-190">Durante l'esecuzione di un servizio con stato hello repliche primarie di che i servizi con stato può contenere solo i listener di comunicazione aperti e il relativo metodo RunAsync chiamato.</span><span class="sxs-lookup"><span data-stu-id="a8c75-190">While a stateful service is running, only hello Primary replicas of that stateful services have their communication listeners opened and their RunAsync method called.</span></span> <span data-ttu-id="a8c75-191">Quelli secondari vengono costruiti ma non vedono ulteriori chiamate.</span><span class="sxs-lookup"><span data-stu-id="a8c75-191">Secondary are constructed but see no further calls.</span></span> <span data-ttu-id="a8c75-192">Durante l'esecuzione un servizio con stato, tuttavia, è possibile modificare la replica è attualmente hello primario.</span><span class="sxs-lookup"><span data-stu-id="a8c75-192">While a stateful service is running however, which replica is currently hello Primary can change.</span></span> <span data-ttu-id="a8c75-193">Cosa significa in termini di eventi del ciclo di vita hello che può visualizzare una replica? Hello comportamento hello replica con stato vede varia a seconda che si tratti di replica hello viene abbassato di livello o innalzate di livello durante lo scambio di hello.</span><span class="sxs-lookup"><span data-stu-id="a8c75-193">What does this mean in terms of hello lifecycle events that a replica can see? hello behavior hello stateful replica sees depends on whether it is hello replica being demoted or promoted during hello swap.</span></span>

### <a name="for-hello-primary-being-demoted"></a><span data-ttu-id="a8c75-194">Per hello viene abbassato di livello principale</span><span class="sxs-lookup"><span data-stu-id="a8c75-194">For hello primary being demoted</span></span>
<span data-ttu-id="a8c75-195">Service Fabric deve toostop questa replica l'elaborazione dei messaggi e chiudere eventuali operazioni in background che viene eseguito.</span><span class="sxs-lookup"><span data-stu-id="a8c75-195">Service Fabric needs this replica toostop processing messages and quit any background work it is doing.</span></span> <span data-ttu-id="a8c75-196">Di conseguenza, questo passaggio ha un aspetto simile toowhen hello servizio viene arrestato.</span><span class="sxs-lookup"><span data-stu-id="a8c75-196">As a result, this step looks similar toowhen hello service is being shut down.</span></span> <span data-ttu-id="a8c75-197">Una differenza è che hello servizio non viene eliminato o chiuso, in quanto rimane un database secondario.</span><span class="sxs-lookup"><span data-stu-id="a8c75-197">One difference is that hello Service isn't destructed or closed since it remains as a Secondary.</span></span> <span data-ttu-id="a8c75-198">viene chiamato Hello API seguenti:</span><span class="sxs-lookup"><span data-stu-id="a8c75-198">hello following APIs are called:</span></span>

1. <span data-ttu-id="a8c75-199">In parallelo</span><span class="sxs-lookup"><span data-stu-id="a8c75-199">In parallel</span></span>
    - <span data-ttu-id="a8c75-200">Gli eventuali listener aperti vengono chiusi.</span><span class="sxs-lookup"><span data-stu-id="a8c75-200">Any open listeners are Closed.</span></span> <span data-ttu-id="a8c75-201">Viene richiamato `ICommunicationListener.CloseAsync()` su ogni listener.</span><span class="sxs-lookup"><span data-stu-id="a8c75-201">`ICommunicationListener.CloseAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="a8c75-202">token di annullamento Hello passato troppo`RunAsync()` viene annullata.</span><span class="sxs-lookup"><span data-stu-id="a8c75-202">hello cancellation token passed too`RunAsync()` is canceled.</span></span> <span data-ttu-id="a8c75-203">Del controllo hello token di annullamento `IsCancellationRequested` proprietà restituisce true e se la chiamata del token hello `ThrowIfCancellationRequested` metodo genera un `OperationCanceledException`.</span><span class="sxs-lookup"><span data-stu-id="a8c75-203">Checking hello cancellation token's `IsCancellationRequested` property returns true, and if called hello token's `ThrowIfCancellationRequested` method throws an `OperationCanceledException`.</span></span>
2. <span data-ttu-id="a8c75-204">Una volta `CloseAsync()` completa per ogni listener e `RunAsync()` completa inoltre del servizio hello `StatefulServiceBase.OnChangeRoleAsync()` viene chiamato.</span><span class="sxs-lookup"><span data-stu-id="a8c75-204">Once `CloseAsync()` completes on each listener and `RunAsync()` also completes, hello service's `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="a8c75-205">Questo viene eseguito l'override uncommonly nel servizio hello.</span><span class="sxs-lookup"><span data-stu-id="a8c75-205">This is uncommonly overridden in hello service.</span></span>

### <a name="for-hello-secondary-being-promoted"></a><span data-ttu-id="a8c75-206">Per hello secondario innalzato di livello</span><span class="sxs-lookup"><span data-stu-id="a8c75-206">For hello secondary being promoted</span></span>
<span data-ttu-id="a8c75-207">Analogamente, Service Fabric deve toostart questa replica in attesa di messaggi in transito hello e avviare qualsiasi attività in background che interessano le.</span><span class="sxs-lookup"><span data-stu-id="a8c75-207">Similarly, Service Fabric needs this replica toostart listening for messages on hello wire and start any background tasks it cares about.</span></span> <span data-ttu-id="a8c75-208">Di conseguenza, ha un aspetto questo processo viene creato simile toowhen hello servizio, ad eccezione di quella replica hello stesso esiste già.</span><span class="sxs-lookup"><span data-stu-id="a8c75-208">As a result, this process looks similar toowhen hello service is created, except that hello replica itself already exists.</span></span> <span data-ttu-id="a8c75-209">viene chiamato Hello API seguenti:</span><span class="sxs-lookup"><span data-stu-id="a8c75-209">hello following APIs are called:</span></span>

1. <span data-ttu-id="a8c75-210">In parallelo</span><span class="sxs-lookup"><span data-stu-id="a8c75-210">In parallel</span></span>
    - <span data-ttu-id="a8c75-211">`StatefulServiceBase.CreateServiceReplicaListeners()` viene richiamato e qualsiasi listener restituito è aperto.</span><span class="sxs-lookup"><span data-stu-id="a8c75-211">`StatefulServiceBase.CreateServiceReplicaListeners()` is invoked and any returned listeners are Opened.</span></span> <span data-ttu-id="a8c75-212">Viene richiamato `ICommunicationListener.OpenAsync()` su ogni listener.</span><span class="sxs-lookup"><span data-stu-id="a8c75-212">`ICommunicationListener.OpenAsync()` is called on each listener.</span></span>
    - <span data-ttu-id="a8c75-213">Hello del servizio `StatefulServiceBase.RunAsync()` viene chiamato</span><span class="sxs-lookup"><span data-stu-id="a8c75-213">hello service's `StatefulServiceBase.RunAsync()` method is called</span></span>
2. <span data-ttu-id="a8c75-214">Una volta tutti hello del listener replica `OpenAsync()` effettua le chiamate e `RunAsync()` è stato chiamato, `StatefulServiceBase.OnChangeRoleAsync()` viene chiamato.</span><span class="sxs-lookup"><span data-stu-id="a8c75-214">Once all hello replica listener's `OpenAsync()` calls complete and `RunAsync()` has been called,  `StatefulServiceBase.OnChangeRoleAsync()` is called.</span></span> <span data-ttu-id="a8c75-215">Questo viene eseguito l'override uncommonly nel servizio hello.</span><span class="sxs-lookup"><span data-stu-id="a8c75-215">This is uncommonly overridden in hello service.</span></span>

### <a name="common-issues-during-stateful-service-shutdown-and-primary-demotion"></a><span data-ttu-id="a8c75-216">Problemi comuni durante l'arresto del servizio con stato e l'abbassamento di livello primario</span><span class="sxs-lookup"><span data-stu-id="a8c75-216">Common issues during stateful service shutdown and primary demotion</span></span>
<span data-ttu-id="a8c75-217">Modifiche di Service Fabric hello primario di un servizio con stato per una serie di motivi.</span><span class="sxs-lookup"><span data-stu-id="a8c75-217">Service Fabric changes hello Primary of a stateful service for a variety of reasons.</span></span> <span data-ttu-id="a8c75-218">sono Hello più frequente [cluster ribilanciamento](service-fabric-cluster-resource-manager-balancing.md) e [l'aggiornamento dell'applicazione](service-fabric-application-upgrade.md).</span><span class="sxs-lookup"><span data-stu-id="a8c75-218">hello most common are [cluster rebalancing](service-fabric-cluster-resource-manager-balancing.md) and [application upgrade](service-fabric-application-upgrade.md).</span></span> <span data-ttu-id="a8c75-219">Durante queste operazioni (nonché durante la chiusura normale del servizio, come è possibile visualizzare se il servizio di hello è stato eliminato), è importante che hello riguardo di hello servizio `CancellationToken`.</span><span class="sxs-lookup"><span data-stu-id="a8c75-219">During these operations (as well as during normal service shutdown, like you'd see if hello service was deleted), it is important that hello service respect hello `CancellationToken`.</span></span> <span data-ttu-id="a8c75-220">I servizi che non gestiscono correttamente l'annullamento sperimenteranno diversi problemi.</span><span class="sxs-lookup"><span data-stu-id="a8c75-220">Services that do not handle cancellation cleanly will experience several issues.</span></span> <span data-ttu-id="a8c75-221">In particolare, queste operazioni sarà lente poiché Service Fabric è in attesa di hello servizi toostop normalmente.</span><span class="sxs-lookup"><span data-stu-id="a8c75-221">In particular, these operations will be slow since Service Fabric waits for hello services toostop gracefully.</span></span> <span data-ttu-id="a8c75-222">Questo può infine toofailed aggiornamenti che scadono e rollback.</span><span class="sxs-lookup"><span data-stu-id="a8c75-222">This can ultimately lead toofailed upgrades that time out and roll back.</span></span> <span data-ttu-id="a8c75-223">Token di annullamento hello toohonor errore può essere causato anche sbilanciato cluster perché accedere a caldo nodi, ma non è possibile ribilanciati servizi hello poiché toomove troppo lungo li altrove.</span><span class="sxs-lookup"><span data-stu-id="a8c75-223">Failure toohonor hello cancellation token can also cause imbalanced clusters because nodes get hot but hello services can't be rebalanced since it takes too long toomove them elsewhere.</span></span> 

<span data-ttu-id="a8c75-224">Poiché i servizi di hello con stati, è inoltre probabile che utilizzano hello [raccolte affidabile](service-fabric-reliable-services-reliable-collections.md).</span><span class="sxs-lookup"><span data-stu-id="a8c75-224">Since hello services are stateful, it is also likely that they are using hello [Reliable Collections](service-fabric-reliable-services-reliable-collections.md).</span></span> <span data-ttu-id="a8c75-225">Nell'infrastruttura del servizio, quando viene modificato un database primario, una delle operazioni che si verificano hello è che sia stato revocato l'accesso in scrittura toohello sottostante stato.</span><span class="sxs-lookup"><span data-stu-id="a8c75-225">In Service Fabric, when a Primary is demoted, one of hello first things that happens is that write access toohello underlying state is revoked.</span></span> <span data-ttu-id="a8c75-226">In tal modo tooa secondo set di problemi che possono influire sulla hello del ciclo di vita del servizio.</span><span class="sxs-lookup"><span data-stu-id="a8c75-226">This leads tooa second set of issues that can impact hello service lifecycle.</span></span> <span data-ttu-id="a8c75-227">gli insiemi di Hello eccezioni restituite basate sull'intervallo hello e se è stato spostato replica hello o arresta.</span><span class="sxs-lookup"><span data-stu-id="a8c75-227">hello collections return Exceptions based on hello timing and whether hello replica is being moved or shut down.</span></span> <span data-ttu-id="a8c75-228">Queste eccezioni devono essere gestite correttamente.</span><span class="sxs-lookup"><span data-stu-id="a8c75-228">These exceptions should be handled correctly.</span></span> <span data-ttu-id="a8c75-229">Le eccezioni generate da Service Fabric rientrano nelle categorie permanente [(`FabricException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabricexception?view=azure-dotnet) e temporanea [(`FabricTransientException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabrictransientexception?view=azure-dotnet).</span><span class="sxs-lookup"><span data-stu-id="a8c75-229">Exceptions thrown by Service Fabric fall into permanent [(`FabricException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabricexception?view=azure-dotnet) and transient [(`FabricTransientException`)](https://docs.microsoft.com/en-us/dotnet/api/system.fabric.fabrictransientexception?view=azure-dotnet) categories.</span></span> <span data-ttu-id="a8c75-230">Eccezioni permanenti devono registrate e verrà generata un'eccezione, mentre possono essere ripetute eccezioni temporanee hello in base a una logica di ripetizione.</span><span class="sxs-lookup"><span data-stu-id="a8c75-230">Permanent exceptions should be logged and thrown, while hello transient exceptions may be retried based on some retry logic.</span></span>

<span data-ttu-id="a8c75-231">La gestione delle eccezioni hello provengono dall'uso di hello `ReliableCollections` in combinazione con gli eventi del ciclo di vita del servizio è una parte importante di test e convalidando un servizio affidabile.</span><span class="sxs-lookup"><span data-stu-id="a8c75-231">Handling hello exceptions that come from use of hello `ReliableCollections` in conjunction with service lifecycle events is an important part of testing and validating a Reliable Service.</span></span> <span data-ttu-id="a8c75-232">Hello raccomandazione è toorun il servizio in condizioni di carico durante l'esecuzione di aggiornamenti e [chaos test](service-fabric-controlled-chaos.md) prima di distribuire mai tooproduction.</span><span class="sxs-lookup"><span data-stu-id="a8c75-232">hello recommendation is always toorun your service under load while performing upgrades and [chaos testing](service-fabric-controlled-chaos.md) before ever deploying tooproduction.</span></span> <span data-ttu-id="a8c75-233">Questi passaggi di base contribuiscono ad assicurare che il servizio sia implementato correttamente e gestisca gli eventi del ciclo di vita nel modo giusto.</span><span class="sxs-lookup"><span data-stu-id="a8c75-233">These basic steps help ensure that your service is correctly implemented and handles lifecycle events correctly.</span></span>


## <a name="notes-on-service-lifecycle"></a><span data-ttu-id="a8c75-234">Note sul ciclo di vita del servizio</span><span class="sxs-lookup"><span data-stu-id="a8c75-234">Notes on service lifecycle</span></span>
  - <span data-ttu-id="a8c75-235">Entrambi hello `RunAsync()` metodo e hello `CreateServiceReplicaListeners/CreateServiceInstanceListeners` chiamate sono facoltative.</span><span class="sxs-lookup"><span data-stu-id="a8c75-235">Both hello `RunAsync()` method and hello `CreateServiceReplicaListeners/CreateServiceInstanceListeners` calls are optional.</span></span> <span data-ttu-id="a8c75-236">Un servizio può averne una, entrambe o nessuna.</span><span class="sxs-lookup"><span data-stu-id="a8c75-236">A service may have one of them, both, or neither.</span></span> <span data-ttu-id="a8c75-237">Ad esempio, se il servizio di hello non tutto il relativo lavoro risposta toouser chiamate, non è necessario per tale tooimplement `RunAsync()`.</span><span class="sxs-lookup"><span data-stu-id="a8c75-237">For example, if hello service does all its work in response toouser calls, there is no need for it tooimplement `RunAsync()`.</span></span> <span data-ttu-id="a8c75-238">Sono necessari solo i listener di comunicazione hello e il codice associato.</span><span class="sxs-lookup"><span data-stu-id="a8c75-238">Only hello communication listeners and their associated code are necessary.</span></span> <span data-ttu-id="a8c75-239">Analogamente, la creazione e la restituzione di listener di comunicazione è facoltativo, come servizio di hello potrebbe avere solo sfondo toodo di lavoro e deve pertanto solo tooimplement`RunAsync()`</span><span class="sxs-lookup"><span data-stu-id="a8c75-239">Similarly, creating and returning communication listeners is optional, as hello service may have only background work toodo, and so only needs tooimplement `RunAsync()`</span></span>
  - <span data-ttu-id="a8c75-240">È valido per un servizio toocomplete `RunAsync()` correttamente e restituito da esso.</span><span class="sxs-lookup"><span data-stu-id="a8c75-240">It is valid for a service toocomplete `RunAsync()` successfully and return from it.</span></span> <span data-ttu-id="a8c75-241">Il completamento non è una condizione di errore.</span><span class="sxs-lookup"><span data-stu-id="a8c75-241">Completing is not a failure condition.</span></span> <span data-ttu-id="a8c75-242">Completamento `RunAsync()` indica il completamento di operazioni in background hello del servizio hello.</span><span class="sxs-lookup"><span data-stu-id="a8c75-242">Completing `RunAsync()` indicates that hello background work of hello service has completed.</span></span> <span data-ttu-id="a8c75-243">Per i servizi reliable con stati, `RunAsync()` viene chiamato nuovamente se replica hello sono stati abbassato di livello da tooSecondary primaria e quindi promossa tooPrimary indietro.</span><span class="sxs-lookup"><span data-stu-id="a8c75-243">For stateful reliable services, `RunAsync()` is called again if hello replica were demoted from Primary tooSecondary and then promoted back tooPrimary.</span></span>
  - <span data-ttu-id="a8c75-244">Se un servizio esce da `RunAsync()` generando un'eccezione imprevista, questo è un errore.</span><span class="sxs-lookup"><span data-stu-id="a8c75-244">If a service exits from `RunAsync()` by throwing some unexpected exception, this constitutes a failure.</span></span> <span data-ttu-id="a8c75-245">oggetto servizio Hello è stato arrestato e segnalato un errore di integrità.</span><span class="sxs-lookup"><span data-stu-id="a8c75-245">hello service object is shut down and a health error reported.</span></span>
  - <span data-ttu-id="a8c75-246">Sebbene non esista alcun limite di tempo restituito da questi metodi, immediatamente perdere hello possibilità toowrite tooReliable raccolte e pertanto non è possibile completare qualsiasi lavoro effettivo.</span><span class="sxs-lookup"><span data-stu-id="a8c75-246">While there is no time limit on returning from these methods, you immediately lose hello ability toowrite tooReliable Collections and therefore cannot complete any real work.</span></span> <span data-ttu-id="a8c75-247">È consigliabile che venga restituito al più presto dopo aver ricevuto la richiesta di annullamento hello.</span><span class="sxs-lookup"><span data-stu-id="a8c75-247">It is recommended that you return as quickly as possible upon receiving hello cancellation request.</span></span> <span data-ttu-id="a8c75-248">Se il servizio non risponde toothese API chiamate in una quantità ragionevole di tempo che Service Fabric potrebbe forzare la terminazione del servizio.</span><span class="sxs-lookup"><span data-stu-id="a8c75-248">If your service does not respond toothese API calls in a reasonable amount of time Service Fabric may forcibly terminate your service.</span></span> <span data-ttu-id="a8c75-249">In genere ciò accade solo durante gli aggiornamenti delle applicazioni o quando viene eliminato un servizio.</span><span class="sxs-lookup"><span data-stu-id="a8c75-249">Usually this only happens during application upgrades or when a service is being deleted.</span></span> <span data-ttu-id="a8c75-250">Questo timeout è di 15 minuti per impostazione predefinita.</span><span class="sxs-lookup"><span data-stu-id="a8c75-250">This timeout is 15 minutes by default.</span></span>
  - <span data-ttu-id="a8c75-251">Errori di hello `OnCloseAsync()` comporterà percorso `OnAbort()` la chiamata che è un'opportunità di sforzo ultima possibilità per hello service tooclean backup e rilasciare le risorse che sono richiesti.</span><span class="sxs-lookup"><span data-stu-id="a8c75-251">Failures in hello `OnCloseAsync()` path result in `OnAbort()` being called which is a last-chance best-effort opportunity for hello service tooclean up and release any resources that they have claimed.</span></span>

## <a name="next-steps"></a><span data-ttu-id="a8c75-252">Passaggi successivi</span><span class="sxs-lookup"><span data-stu-id="a8c75-252">Next steps</span></span>
- [<span data-ttu-id="a8c75-253">Introduzione tooReliable servizi</span><span class="sxs-lookup"><span data-stu-id="a8c75-253">Introduction tooReliable Services</span></span>](service-fabric-reliable-services-introduction.md)
- [<span data-ttu-id="a8c75-254">Guida introduttiva a Reliable Services di Microsoft Azure Service Fabric</span><span class="sxs-lookup"><span data-stu-id="a8c75-254">Reliable Services quick start</span></span>](service-fabric-reliable-services-quick-start.md)
- [<span data-ttu-id="a8c75-255">Uso avanzato del modello di programmazione Reliable Services</span><span class="sxs-lookup"><span data-stu-id="a8c75-255">Reliable Services advanced usage</span></span>](service-fabric-reliable-services-advanced-usage.md)
