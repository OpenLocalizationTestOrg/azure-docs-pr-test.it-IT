---
title: "Progettazione di applicazioni a disponibilità elevata con l'archiviazione con ridondanza geografica e accesso in lettura di Azure (RA-GRS) | Documentazione Microsoft"
description: "Informazioni su come usare l'archiviazione RA-GRS di Azure per progettare un'applicazione a disponibilità elevata con flessibilità sufficiente per la gestione delle interruzioni."
services: storage
documentationcenter: .net
author: robinsh
manager: timlt
editor: tysonn
ms.assetid: 8f040b0f-8926-4831-ac07-79f646f31926
ms.service: storage
ms.workload: storage
ms.tgt_pltfrm: na
ms.devlang: dotnet
ms.topic: article
ms.date: 1/19/2017
ms.author: robinsh
ms.openlocfilehash: adc7e23d8c9f869f2951490020e3d0f1a2b2e81c
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/03/2017
---
# <a name="designing-highly-available-applications-using-ra-grs"></a><span data-ttu-id="0489f-103">Progettazione di applicazioni a disponibilità elevata con RA-GRS</span><span class="sxs-lookup"><span data-stu-id="0489f-103">Designing Highly Available Applications using RA-GRS</span></span>

<span data-ttu-id="0489f-104">Una funzionalità comune delle infrastrutture basate su cloud è che offrono una piattaforma a disponibilità elevata per l'hosting di applicazioni.</span><span class="sxs-lookup"><span data-stu-id="0489f-104">A common feature of cloud-based infrastructures is that they provide a highly available platform for hosting applications.</span></span> <span data-ttu-id="0489f-105">Gli sviluppatori di applicazioni basate su cloud devono valutare attentamente il modo in cui sfruttare questa piattaforma per fornire applicazioni a disponibilità elevata agli utenti.</span><span class="sxs-lookup"><span data-stu-id="0489f-105">Developers of cloud-based applications must consider carefully how to leverage this platform to deliver highly available applications to their users.</span></span> <span data-ttu-id="0489f-106">Questo articolo è incentrato specificamente sul modo in cui gli sviluppatori possono usare l'archiviazione con ridondanza geografica e accesso in lettura di Azure (RA-GRS) per aumentare la disponibilità delle applicazioni.</span><span class="sxs-lookup"><span data-stu-id="0489f-106">This article focuses specifically on how developers can use the Azure Storage Read Access Geo Redundant Storage (RA-GRS) to make their applications more available.</span></span>

<span data-ttu-id="0489f-107">Sono disponibili quattro opzioni di ridondanza: archiviazione con ridondanza locale (LRS), archiviazione con ridondanza della zona (ZRS), archiviazione con ridondanza geografica (GRS) e archiviazione con ridondanza geografica e accesso in lettura (RA-GRS).</span><span class="sxs-lookup"><span data-stu-id="0489f-107">There are four choices for redundancy – LRS (Locally Redundant Storage), ZRS (Zone Redundant Storage), GRS (Geo-Redundant Storage), and RA-GRS (Read Access Geo-Redundant Storage).</span></span> <span data-ttu-id="0489f-108">Questo articolo tratta l'archiviazione con ridondanza geografica e l'archiviazione con ridondanza geografica e accesso in lettura.</span><span class="sxs-lookup"><span data-stu-id="0489f-108">We are going to discuss GRS and RA-GRS in this article.</span></span> <span data-ttu-id="0489f-109">Con l'archiviazione con ridondanza geografica, vengono mantenute tre copie dei dati nell'area primaria selezionata durante la configurazione dell'account di archiviazione.</span><span class="sxs-lookup"><span data-stu-id="0489f-109">With GRS, three copies of your data are kept in the primary region you selected when setting up the storage account.</span></span> <span data-ttu-id="0489f-110">Altre tre copie vengono mantenute in modo asincrono in un'area secondaria specificata da Azure.</span><span class="sxs-lookup"><span data-stu-id="0489f-110">Three additional copies are maintained asynchronously in a secondary region specified by Azure.</span></span> <span data-ttu-id="0489f-111">L'archiviazione con ridondanza geografica e accesso in lettura è uguale all'archiviazione con ridondanza geografica, fatta eccezione per l'accesso in lettura alla copia secondaria.</span><span class="sxs-lookup"><span data-stu-id="0489f-111">RA-GRS is the same thing as GRS except that you have read access to the secondary copy.</span></span> <span data-ttu-id="0489f-112">Per altre informazioni sulle opzioni di ridondanza di Archiviazione di Azure, vedere [Replica di Archiviazione di Azure](https://docs.microsoft.com/en-us/azure/storage/storage-redundancy).</span><span class="sxs-lookup"><span data-stu-id="0489f-112">For more information about the different Azure Storage redundancy options, see [Azure Storage replication](https://docs.microsoft.com/en-us/azure/storage/storage-redundancy).</span></span> <span data-ttu-id="0489f-113">L'articolo sulla replica illustra anche le associazioni tra aree primarie e secondarie.</span><span class="sxs-lookup"><span data-stu-id="0489f-113">The replication article also shows the pairings of the primary and secondary regions.</span></span>

<span data-ttu-id="0489f-114">Questo articolo include frammenti di codice e un collegamento a un esempio completo alla fine che è possibile scaricare ed eseguire.</span><span class="sxs-lookup"><span data-stu-id="0489f-114">There are code snippets included in this article, and a link to a complete sample at the end that you can download and run.</span></span>

## <a name="key-features-of-ra-grs"></a><span data-ttu-id="0489f-115">Funzionalità principali dell'archiviazione con ridondanza geografica e accesso in lettura</span><span class="sxs-lookup"><span data-stu-id="0489f-115">Key features of RA-GRS</span></span>

<span data-ttu-id="0489f-116">Prima di descrivere come usare l'archiviazione con ridondanza geografica e accesso in lettura, verranno esaminati il comportamento e le proprietà.</span><span class="sxs-lookup"><span data-stu-id="0489f-116">Before we talk about how to use RA-GRS storage, let's talk about its properties and behavior.</span></span>

* <span data-ttu-id="0489f-117">Archiviazione di Azure conserva in un'area secondaria una copia di sola lettura dei dati archiviati nell'area primaria. Come indicato in precedenza, il servizio di archiviazione determina la posizione dell'area secondaria.</span><span class="sxs-lookup"><span data-stu-id="0489f-117">Azure Storage maintains a read-only copy of the data you store in your primary region in a secondary region; as noted above, the storage service determines the location of the secondary region.</span></span>

* <span data-ttu-id="0489f-118">La copia di sola lettura ha [coerenza finale](https://en.wikipedia.org/wiki/Eventual_consistency) con i dati dell'area primaria.</span><span class="sxs-lookup"><span data-stu-id="0489f-118">The read-only copy is [eventually consistent](https://en.wikipedia.org/wiki/Eventual_consistency) with the data in the primary region.</span></span>

* <span data-ttu-id="0489f-119">Per BLOB, tabelle e code è possibile eseguire query nell'area secondaria per trovare un valore *Ora ultima sincronizzazione* che indica quando è stata eseguita l'ultima replica dall'area primaria all'area secondaria.</span><span class="sxs-lookup"><span data-stu-id="0489f-119">For blobs, tables, and queues, you can query the secondary region for a *Last Sync Time* value that tells you when the last replication from the primary to the secondary region occurred.</span></span> <span data-ttu-id="0489f-120">Questa operazione non è supportata per Archiviazione file di Azure, che non ha attualmente l'archiviazione con ridondanza geografica e accesso in lettura.</span><span class="sxs-lookup"><span data-stu-id="0489f-120">(This is not supported for Azure File storage, which doesn't have RA-GRS redundancy at this time.)</span></span>

* <span data-ttu-id="0489f-121">È possibile usare la libreria client di archiviazione per interagire con i dati nell'area primaria o secondaria.</span><span class="sxs-lookup"><span data-stu-id="0489f-121">You can use the Storage Client Library to interact with the data in either the primary or secondary region.</span></span> <span data-ttu-id="0489f-122">È anche possibile reindirizzare automaticamente le richieste di lettura all'area secondaria in caso di timeout della richiesta di lettura per l'area primaria.</span><span class="sxs-lookup"><span data-stu-id="0489f-122">You can also redirect read requests automatically to the secondary region if a read request to the primary region times out.</span></span>

* <span data-ttu-id="0489f-123">Se si verifica un problema grave che interessa l'accessibilità dei dati nell'area primaria, il team di Azure può attivare un failover geografico; le voci DNS che puntano all'area primaria verranno quindi modificate per puntare all'area secondaria.</span><span class="sxs-lookup"><span data-stu-id="0489f-123">If there is a major issue affecting the accessibility of the data in the primary region, the Azure team may trigger a geo-failover, at which point the DNS entries pointing to the primary region will be changed to point to the secondary region.</span></span>

* <span data-ttu-id="0489f-124">Se si verifica un failover geografico, Azure selezionerà una nuova posizione secondaria e replicherà i dati in tale posizione, puntandovi quindi le voci DNS secondarie.</span><span class="sxs-lookup"><span data-stu-id="0489f-124">If a geo-failover occurs, Azure will select a new secondary location and replicate the data to that location, then point the secondary DNS entries to it.</span></span> <span data-ttu-id="0489f-125">L'endpoint secondario non sarà disponibile fino al termine della replica dell'account di archiviazione.</span><span class="sxs-lookup"><span data-stu-id="0489f-125">The secondary endpoint will be unavailable until the storage account has finished replicating.</span></span> <span data-ttu-id="0489f-126">Per altre informazioni, vedere [Cosa fare se si verifica un'interruzione di Archiviazione di Azure](https://docs.microsoft.com/en-us/azure/storage/storage-disaster-recovery-guidance).</span><span class="sxs-lookup"><span data-stu-id="0489f-126">For more information, please see [What to do if an Azure Storage outage occurs](https://docs.microsoft.com/en-us/azure/storage/storage-disaster-recovery-guidance).</span></span>

## <a name="application-design-considerations-when-using-ra-grs"></a><span data-ttu-id="0489f-127">Considerazioni sulla progettazione di applicazioni quando si usa l'archiviazione con ridondanza geografica e accesso in lettura</span><span class="sxs-lookup"><span data-stu-id="0489f-127">Application design considerations when using RA-GRS</span></span>

<span data-ttu-id="0489f-128">Lo scopo principale di questo articolo è illustrare come progettare un'applicazione che continuerà a funzionare anche nel caso di emergenza grave nel data center primario, anche se con capacità limitata.</span><span class="sxs-lookup"><span data-stu-id="0489f-128">The main purpose of this article is to show you how to design an application that will continue to function (albeit in a limited capacity) even in the event of a major disaster at the primary data center.</span></span> <span data-ttu-id="0489f-129">A tale scopo, configurare l'applicazione in modo che gestisca problemi temporanei o prolungati passando alla lettura dell'area secondaria mentre il problema è presente e tornando all'area primaria quando questa è nuovamente disponibile.</span><span class="sxs-lookup"><span data-stu-id="0489f-129">You do this by having your application to handle transient or long-running issues by switching to read from the secondary region while there is a problem, and switching back when the primary region is available again.</span></span>

### <a name="using-eventually-consistent-data"></a><span data-ttu-id="0489f-130">Uso di dati con coerenza finale</span><span class="sxs-lookup"><span data-stu-id="0489f-130">Using eventually consistent data</span></span>

<span data-ttu-id="0489f-131">Questa soluzione proposta presuppone che sia accettabile restituire eventuali dati non aggiornati all'applicazione chiamante.</span><span class="sxs-lookup"><span data-stu-id="0489f-131">This proposed solution assumes that it is okay to return what could be stale data to the calling application.</span></span> <span data-ttu-id="0489f-132">Poiché i dati secondari hanno coerenza finale, è possibile che i dati siano stati scritti nell'area primaria, ma che la replica dell'aggiornamento nell'area secondaria non fosse ancora terminata quando l'area primaria è diventata inaccessibile.</span><span class="sxs-lookup"><span data-stu-id="0489f-132">Because the secondary data is eventually consistent, it is possible that the data was written to the primary but the update to the secondary had not finished replicating when the primary region became inaccessible.</span></span>

<span data-ttu-id="0489f-133">È ad esempio possibile che il cliente invii un aggiornamento completato correttamente, ma che successivamente l'area primaria diventi non disponibile prima che l'aggiornamento venga propagato all'area secondaria.</span><span class="sxs-lookup"><span data-stu-id="0489f-133">For example, your customer could submit an update that is successful, and then the primary could go down before the update is propagated to the secondary.</span></span> <span data-ttu-id="0489f-134">In questo caso, se il cliente chiede di leggere nuovamente i dati riceverà dati non aggiornati al posto di quelli aggiornati.</span><span class="sxs-lookup"><span data-stu-id="0489f-134">In this case, if the customer then asks to read the data back, he receives the stale data instead of the updated data.</span></span> <span data-ttu-id="0489f-135">È necessario stabilire se ciò sia accettabile e in tal caso come informare il cliente.</span><span class="sxs-lookup"><span data-stu-id="0489f-135">You must decide if this is acceptable, and if so, how you will message the customer.</span></span> <span data-ttu-id="0489f-136">Più avanti nell'articolo verrà illustrato come verificare l'ora dell'ultima sincronizzazione sui dati secondari per determinare se l'area secondaria è aggiornata.</span><span class="sxs-lookup"><span data-stu-id="0489f-136">You'll see how to check the Last Sync Time on the secondary data later in this article to see if the secondary is up-to-date.</span></span>

### <a name="handling-services-separately-or-all-together"></a><span data-ttu-id="0489f-137">Gestione separata o collettiva dei servizi</span><span class="sxs-lookup"><span data-stu-id="0489f-137">Handling services separately or all together</span></span>

<span data-ttu-id="0489f-138">Anche se improbabile, è possibile che un servizio diventi indisponibile mentre gli altri servizi rimangono pienamente funzionali.</span><span class="sxs-lookup"><span data-stu-id="0489f-138">While not likely, it is possible for one service to become unavailable while the other services are still fully functional.</span></span> <span data-ttu-id="0489f-139">È possibile gestire i tentativi e la modalità di sola lettura per ogni servizio separatamente (BLOB, code, tabelle) oppure gestire i tentativi in modo generico e collettivamente per tutti i servizi di archiviazione.</span><span class="sxs-lookup"><span data-stu-id="0489f-139">You can handle the retries and read-only mode for each service separately (blobs, queues, tables), or you can handle retries generically for all the storage services together.</span></span>

<span data-ttu-id="0489f-140">Se ad esempio si usano code e BLOB nell'applicazione, si può decidere di inserire codice separato per gestire gli errori non irreversibili per ognuno di essi.</span><span class="sxs-lookup"><span data-stu-id="0489f-140">For example, if you use queues and blobs in your application, you may decide to put in separate code to handle retryable errors for each of these.</span></span> <span data-ttu-id="0489f-141">Se quindi si riceve un tentativo dal servizio BLOB, ma il servizio di accodamento funziona ancora, sarà interessata solo la parte dell'applicazione che gestisce i BLOB.</span><span class="sxs-lookup"><span data-stu-id="0489f-141">Then if you get a retry from the blob service, but the queue service is still working, only the part of your application that handles blobs will be impacted.</span></span> <span data-ttu-id="0489f-142">Se si decide di gestire tutti i tentativi dei servizi di archiviazione in modo generico e una chiamata al servizio BLOB restituisce un errore non irreversibile, saranno interessate le richieste al servizio BLOB e le richieste al servizio di accodamento.</span><span class="sxs-lookup"><span data-stu-id="0489f-142">If you decide to handle all storage service retries generically and a call to the blob service returns a retryable error, then requests to both the blob service and the queue service will be impacted.</span></span>

<span data-ttu-id="0489f-143">Ciò dipende in definitiva dalla complessità dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="0489f-143">Ultimately, this depends on the complexity of your application.</span></span> <span data-ttu-id="0489f-144">È possibile decidere di non gestire gli errori in base al servizio, ma di reindirizzare all'area secondaria le richieste di lettura per tutti i servizi ed eseguire l'applicazione in modalità di sola lettura quando viene rilevato un problema con qualsiasi servizio di archiviazione nell'area primaria.</span><span class="sxs-lookup"><span data-stu-id="0489f-144">You may decide not to handle the failures by service, but instead to redirect read requests for all storage services to the secondary region and run the application in read-only mode when you detect a problem with any storage service in the primary region.</span></span>

### <a name="other-considerations"></a><span data-ttu-id="0489f-145">Altre considerazioni</span><span class="sxs-lookup"><span data-stu-id="0489f-145">Other considerations</span></span>

<span data-ttu-id="0489f-146">Di seguito sono indicate le altre considerazioni che verranno illustrate nella parte restante di questo articolo.</span><span class="sxs-lookup"><span data-stu-id="0489f-146">These are the other considerations we will discuss in the rest of this article.</span></span>

*   <span data-ttu-id="0489f-147">Gestione dei tentativi delle richieste di lettura con il modello a interruttore</span><span class="sxs-lookup"><span data-stu-id="0489f-147">Handling retries of read requests using the Circuit Breaker pattern</span></span>

*   <span data-ttu-id="0489f-148">Dati con coerenza finale e ora dell'ultima sincronizzazione</span><span class="sxs-lookup"><span data-stu-id="0489f-148">Eventually-consistent data and the Last Sync Time</span></span>

*   <span data-ttu-id="0489f-149">Test</span><span class="sxs-lookup"><span data-stu-id="0489f-149">Testing</span></span>

## <a name="running-your-application-in-read-only-mode"></a><span data-ttu-id="0489f-150">Esecuzione dell'applicazione in modalità di sola lettura</span><span class="sxs-lookup"><span data-stu-id="0489f-150">Running your application in read-only mode</span></span>

<span data-ttu-id="0489f-151">Per usare l'archiviazione con ridondanza geografica e accesso in lettura si devono poter gestire sia le richieste di lettura non riuscite che le richieste di aggiornamento non riuscite. In questo caso, per "aggiornamento" si intendono inserimenti, aggiornamenti ed eliminazioni.</span><span class="sxs-lookup"><span data-stu-id="0489f-151">To use RA-GRS storage, you must be able to handle both failed read requests and failed update requests (with update in this case meaning inserts, updates, and deletions).</span></span> <span data-ttu-id="0489f-152">In caso di errore del data center primario, le richieste di lettura possono essere reindirizzate al data center secondario, ma questa operazione non può essere eseguita per le richieste di aggiornamento perché il data center secondario è di sola lettura.</span><span class="sxs-lookup"><span data-stu-id="0489f-152">If the primary data center fails, read requests can be redirected to the secondary data center, but update requests cannot because the secondary is read only.</span></span> <span data-ttu-id="0489f-153">Per questo motivo è necessario un modo per eseguire l'applicazione in modalità di sola lettura.</span><span class="sxs-lookup"><span data-stu-id="0489f-153">For this reason, you need some way to run your application in read-only mode.</span></span>

<span data-ttu-id="0489f-154">È ad esempio possibile impostare un flag che verrà verificato prima di inviare le richieste di aggiornamento al servizio di archiviazione.</span><span class="sxs-lookup"><span data-stu-id="0489f-154">For example, you can set a flag that will be checked before submitting any update requests to the storage service.</span></span> <span data-ttu-id="0489f-155">Alla ricezione di una delle richieste di aggiornamento, è possibile ignorare la richiesta e restituire una risposta appropriata al cliente.</span><span class="sxs-lookup"><span data-stu-id="0489f-155">When one of the update requests comes through, you can skip it and return an appropriate response to the customer.</span></span> <span data-ttu-id="0489f-156">È anche possibile disabilitare completamente determinate funzionalità finché il problema è risolto e informare gli utenti che tali funzionalità sono temporaneamente non disponibili.</span><span class="sxs-lookup"><span data-stu-id="0489f-156">You may even want to disable certain features altogether until the problem is resolved and notify users that those features are temporarily unavailable.</span></span>

<span data-ttu-id="0489f-157">Se si decide di gestire gli errori separatamente per ogni servizio, è anche necessario gestire la possibilità di eseguire l'applicazione in modalità di sola lettura per ogni servizio.</span><span class="sxs-lookup"><span data-stu-id="0489f-157">If you decide to handle errors for each service separately, you will also need to handle the ability to run your application in read-only mode by service.</span></span> <span data-ttu-id="0489f-158">È possibile abilitare o disabilitare flag di sola lettura per ogni servizio e gestire il flag appropriato nel punto corrispondente del codice.</span><span class="sxs-lookup"><span data-stu-id="0489f-158">You could have read-only flags for each service that can be enabled and disabled and handle the appropriate flag in the appropriate places in your code.</span></span>

<span data-ttu-id="0489f-159">La possibilità di eseguire l'applicazione in modalità di sola lettura offre un altro vantaggio: consente di garantire funzionalità limitate durante un aggiornamento principale dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="0489f-159">Being able to run your application in read-only mode has another side benefit – it gives you the ability to ensure limited functionality during a major application upgrade.</span></span> <span data-ttu-id="0489f-160">È possibile impostare l'applicazione in modo che venga eseguita in sola lettura e punti al data center secondario, impedendo così l'accesso ai dati nell'area primaria durante gli aggiornamenti.</span><span class="sxs-lookup"><span data-stu-id="0489f-160">You can trigger your application to run in read-only mode and point to the secondary data center, ensuring nobody is accessing the data in the primary region while you're making upgrades.</span></span>

## <a name="handling-updates-when-running-in-read-only-mode"></a><span data-ttu-id="0489f-161">Gestione degli aggiornamenti durante l'esecuzione in modalità di sola lettura</span><span class="sxs-lookup"><span data-stu-id="0489f-161">Handling updates when running in read-only mode</span></span>

<span data-ttu-id="0489f-162">Esistono molti modi per gestire le richieste di aggiornamento durante l'esecuzione in modalità di sola lettura.</span><span class="sxs-lookup"><span data-stu-id="0489f-162">There are many ways to handle update requests when running in read-only mode.</span></span> <span data-ttu-id="0489f-163">Questi modi non verranno illustrati nei dettagli, ma in linea generale vengono presi in considerazione due modelli.</span><span class="sxs-lookup"><span data-stu-id="0489f-163">We won't cover this comprehensively, but generally, there are a couple of patterns that you consider.</span></span>

1.  <span data-ttu-id="0489f-164">È possibile rispondere all'utente e indicare che gli aggiornamenti non sono attualmente accettati.</span><span class="sxs-lookup"><span data-stu-id="0489f-164">You can respond to your user and tell them you are not currently accepting updates.</span></span> <span data-ttu-id="0489f-165">Un sistema di gestione dei contatti potrebbe ad esempio consentire ai clienti di accedere alle informazioni di contatto, ma non di eseguire aggiornamenti.</span><span class="sxs-lookup"><span data-stu-id="0489f-165">For example, a contact management system could enable customers to access contact information but not make updates.</span></span>

2.  <span data-ttu-id="0489f-166">È possibile accodare gli aggiornamenti in un'altra area.</span><span class="sxs-lookup"><span data-stu-id="0489f-166">You can enqueue your updates in another region.</span></span> <span data-ttu-id="0489f-167">In questo caso, le richieste di aggiornamento in sospeso vengono scritte in una coda di un'area diversa e quindi elaborate in un modo specifico quando il data center primario è nuovamente online.</span><span class="sxs-lookup"><span data-stu-id="0489f-167">In this case, you would write your pending update requests to a queue in a different region, and then have a way to process those requests after the primary data center comes online again.</span></span> <span data-ttu-id="0489f-168">In questo scenario è necessario informare il cliente che l'aggiornamento richiesto è in coda e verrà elaborato in un secondo momento.</span><span class="sxs-lookup"><span data-stu-id="0489f-168">In this scenario, you should let the customer know that the update requested is queued for later processing.</span></span>

3.  <span data-ttu-id="0489f-169">È possibile scrivere gli aggiornamenti in un account di archiviazione di un'altra area.</span><span class="sxs-lookup"><span data-stu-id="0489f-169">You can write your updates to a storage account in another region.</span></span> <span data-ttu-id="0489f-170">Quando il data center principale è nuovamente online, è possibile configurare un modo per unire gli aggiornamenti nei dati primari, a seconda della struttura dei dati.</span><span class="sxs-lookup"><span data-stu-id="0489f-170">Then when the primary data center comes back online, you can have a way to merge those updates into the primary data, depending on the structure of the data.</span></span> <span data-ttu-id="0489f-171">Se ad esempio si creano file separati con indicatore di data e ora nel nome, è possibile copiare di nuovo tali file nell'area primaria.</span><span class="sxs-lookup"><span data-stu-id="0489f-171">For example, if you are creating separate files with a date/time stamp in the name, you can copy those files back to the primary region.</span></span> <span data-ttu-id="0489f-172">Questa procedura funziona per alcuni carichi di lavoro, ad esempio dati di registrazione e iOT.</span><span class="sxs-lookup"><span data-stu-id="0489f-172">This works for some workloads such as logging and iOT data.</span></span>

## <a name="handling-retries"></a><span data-ttu-id="0489f-173">Gestione dei tentativi</span><span class="sxs-lookup"><span data-stu-id="0489f-173">Handling retries</span></span>

<span data-ttu-id="0489f-174">Come si possono identificare gli errori non irreversibili?</span><span class="sxs-lookup"><span data-stu-id="0489f-174">How do you know which errors are retryable?</span></span> <span data-ttu-id="0489f-175">Questo stato è determinato dalla libreria client di archiviazione.</span><span class="sxs-lookup"><span data-stu-id="0489f-175">This is determined by the storage client library.</span></span> <span data-ttu-id="0489f-176">Un errore 404 (risorsa non trovata) è ad esempio irreversibile perché è improbabile che la ripetizione del tentativo abbia esito positivo.</span><span class="sxs-lookup"><span data-stu-id="0489f-176">For example, a 404 error (resource not found) is not retryable because retrying it is not likely to result in success.</span></span> <span data-ttu-id="0489f-177">Al contrario, un errore 500 è reversibile perché è un errore del server e potrebbe essere trattarsi semplicemente di un problema temporaneo.</span><span class="sxs-lookup"><span data-stu-id="0489f-177">On the other hand, a 500 error is retryable because it is a server error, and it may simply be a transient issue.</span></span> <span data-ttu-id="0489f-178">Per altri dettagli, vedere il [codice open source per la classe ExponentialRetry](https://github.com/Azure/azure-storage-net/blob/87b84b3d5ee884c7adc10e494e2c7060956515d0/Lib/Common/RetryPolicies/ExponentialRetry.cs) nella libreria client di archiviazione .NET.</span><span class="sxs-lookup"><span data-stu-id="0489f-178">For more details, check out the [open source code for the ExponentialRetry class](https://github.com/Azure/azure-storage-net/blob/87b84b3d5ee884c7adc10e494e2c7060956515d0/Lib/Common/RetryPolicies/ExponentialRetry.cs) in the .NET storage client library.</span></span> <span data-ttu-id="0489f-179">Cercare il metodo ShouldRetry.</span><span class="sxs-lookup"><span data-stu-id="0489f-179">(Look for the ShouldRetry method.)</span></span>

### <a name="read-requests"></a><span data-ttu-id="0489f-180">Richieste di lettura</span><span class="sxs-lookup"><span data-stu-id="0489f-180">Read requests</span></span>

<span data-ttu-id="0489f-181">Se si è verificato un problema con l'archiviazione primaria, le richieste di lettura possono essere reindirizzate all'archiviazione secondaria.</span><span class="sxs-lookup"><span data-stu-id="0489f-181">Read requests can be redirected to secondary storage if there is a problem with primary storage.</span></span> <span data-ttu-id="0489f-182">Come indicato in precedenza in [Uso di dati con coerenza finale](#using-eventually-consistent-data), deve essere accettabile l'ipotesi che l'applicazione legga dati non aggiornati.</span><span class="sxs-lookup"><span data-stu-id="0489f-182">As noted above in [Using Eventually Consistent Data](#using-eventually-consistent-data), it must be acceptable for your application to potentially read stale data.</span></span> <span data-ttu-id="0489f-183">Se si usa la libreria client di archiviazione per accedere ai dati di archiviazione con ridondanza geografica e accesso in lettura, è possibile specificare il comportamento dei tentativi di una richiesta di lettura impostando la proprietà **LocationMode** su uno dei valori seguenti:</span><span class="sxs-lookup"><span data-stu-id="0489f-183">If you are using the storage client library to access RA-GRS data, you can specify the retry behavior of a read request by setting a value for the **LocationMode** property to one of the following:</span></span>

*   <span data-ttu-id="0489f-184">**PrimaryOnly** (impostazione predefinita)</span><span class="sxs-lookup"><span data-stu-id="0489f-184">**PrimaryOnly** (the default)</span></span>

*   <span data-ttu-id="0489f-185">**PrimaryThenSecondary**</span><span class="sxs-lookup"><span data-stu-id="0489f-185">**PrimaryThenSecondary**</span></span>

*   <span data-ttu-id="0489f-186">**SecondaryOnly**</span><span class="sxs-lookup"><span data-stu-id="0489f-186">**SecondaryOnly**</span></span>

*   <span data-ttu-id="0489f-187">**SecondaryThenPrimary**</span><span class="sxs-lookup"><span data-stu-id="0489f-187">**SecondaryThenPrimary**</span></span>

<span data-ttu-id="0489f-188">Quando si imposta la proprietà **LocationMode** su **PrimaryThenSecondary**, se la richiesta di lettura iniziale all'endpoint primario ha esito negativo con errore non irreversibile, il client invia automaticamente un'altra richiesta di lettura all'endpoint secondario.</span><span class="sxs-lookup"><span data-stu-id="0489f-188">When you set the **LocationMode** to **PrimaryThenSecondary**, if the initial read request to the primary endpoint fails with a retryable error, the client automatically makes another read request to the secondary endpoint.</span></span> <span data-ttu-id="0489f-189">Se l'errore è un timeout del server, il client dovrà attendere che il timeout scada prima di ricevere un errore non irreversibile dal servizio.</span><span class="sxs-lookup"><span data-stu-id="0489f-189">If the error is a server timeout, then the client will have to wait for the timeout to expire before it receives a retryable error from the service.</span></span>

<span data-ttu-id="0489f-190">Esistono essenzialmente due scenari da considerare quando si decide come rispondere a un errore non irreversibile:</span><span class="sxs-lookup"><span data-stu-id="0489f-190">There are basically two scenarios to consider when you are deciding how to respond to a retryable error:</span></span>

*   <span data-ttu-id="0489f-191">Si tratta di un problema isolato e le richieste successive all'endpoint primario non restituiranno un errore non irreversibile.</span><span class="sxs-lookup"><span data-stu-id="0489f-191">This is an isolated problem and subsequent requests to the primary endpoint will not return a retryable error.</span></span> <span data-ttu-id="0489f-192">Un esempio di questa situazione può verificarsi in caso di errore di rete temporaneo.</span><span class="sxs-lookup"><span data-stu-id="0489f-192">An example of where this might happen is when there is a transient network error.</span></span>

    <span data-ttu-id="0489f-193">In questo scenario, le prestazioni non verranno penalizzate impostando **LocationMode** su **PrimaryThenSecondary** perché questo evento si verifica raramente.</span><span class="sxs-lookup"><span data-stu-id="0489f-193">In this scenario, there is no significant performance penalty in having **LocationMode** set to **PrimaryThenSecondary** as this only happens infrequently.</span></span>

*   <span data-ttu-id="0489f-194">Si tratta di un problema che interessa almeno uno dei servizi di archiviazione nell'area primaria e tutte le richieste successive al servizio nell'area primaria restituiranno probabilmente errori non irreversibili per un periodo di tempo.</span><span class="sxs-lookup"><span data-stu-id="0489f-194">This is a problem with at least one of the storage services in the primary region and all subsequent requests to that service in the primary region are likely to return retryable errors for a period of time.</span></span> <span data-ttu-id="0489f-195">Un esempio è quando l'area primaria è completamente inaccessibile.</span><span class="sxs-lookup"><span data-stu-id="0489f-195">An example of this is if the primary region is completely inaccessible.</span></span>

    <span data-ttu-id="0489f-196">In questo scenario, le prestazioni vengono penalizzate perché tutte le richieste di lettura proveranno prima a contattare l'endpoint primario, attenderanno la scadenza del timeout, quindi passeranno all'endpoint secondario.</span><span class="sxs-lookup"><span data-stu-id="0489f-196">In this scenario, there is a performance penalty because all your read requests will try the primary endpoint first, wait for the timeout to expire, then switch to the secondary endpoint.</span></span>

<span data-ttu-id="0489f-197">Per questi scenari è necessario identificare la presenza di un problema con l'endpoint primario e inviare tutte le richieste di lettura direttamente all'endpoint secondario impostando la proprietà **LocationMode** su **SecondaryOnly**.</span><span class="sxs-lookup"><span data-stu-id="0489f-197">For these scenarios, you should identify that there is an ongoing issue with the primary endpoint and send all read requests directly to the secondary endpoint by setting the **LocationMode** property to **SecondaryOnly**.</span></span> <span data-ttu-id="0489f-198">In questa fase è anche necessario attivare l'esecuzione in modalità di sola lettura per l'applicazione.</span><span class="sxs-lookup"><span data-stu-id="0489f-198">At this time, you should also change the application to run in read-only mode.</span></span> <span data-ttu-id="0489f-199">Questo approccio è noto come [modello a interruttore](https://msdn.microsoft.com/library/dn589784.aspx).</span><span class="sxs-lookup"><span data-stu-id="0489f-199">This approach is known as the [Circuit Breaker Pattern](https://msdn.microsoft.com/library/dn589784.aspx).</span></span>

### <a name="update-requests"></a><span data-ttu-id="0489f-200">Richieste di aggiornamento</span><span class="sxs-lookup"><span data-stu-id="0489f-200">Update requests</span></span>

<span data-ttu-id="0489f-201">Il modello a interruttore può anche essere applicato alle richieste di aggiornamento.</span><span class="sxs-lookup"><span data-stu-id="0489f-201">The Circuit Breaker pattern can also be applied to update requests.</span></span> <span data-ttu-id="0489f-202">Le richieste di aggiornamento non possono essere tuttavia reindirizzate a un archivio secondario, trattandosi di un archivio di sola lettura.</span><span class="sxs-lookup"><span data-stu-id="0489f-202">However, update requests cannot be redirected to secondary storage, which is read-only.</span></span> <span data-ttu-id="0489f-203">Per queste richieste è consigliabile lasciare la proprietà **LocationMode** impostata su **PrimaryOnly** (impostazione predefinita).</span><span class="sxs-lookup"><span data-stu-id="0489f-203">For these requests, you should leave the **LocationMode** property set to **PrimaryOnly** (the default).</span></span> <span data-ttu-id="0489f-204">Per gestire questi errori è possibile applicare una metrica a queste richieste, ad esempio 10 errori consecutivi, e quando viene raggiunta la soglia attivare la modalità di sola lettura per l'applicazione.</span><span class="sxs-lookup"><span data-stu-id="0489f-204">To handle these errors, you can apply a metric to these requests – such as 10 failures in a row – and when your threshold is met, switch the application into read-only mode.</span></span> <span data-ttu-id="0489f-205">Per tornare alla modalità di aggiornamento è possibile usare gli stessi metodi descritti di seguito, nella sezione relativa al modello a interruttore.</span><span class="sxs-lookup"><span data-stu-id="0489f-205">You can use the same methods for returning to update mode as those described below in the next section about the Circuit Breaker pattern.</span></span>

## <a name="circuit-breaker-pattern"></a><span data-ttu-id="0489f-206">Modello a interruttore</span><span class="sxs-lookup"><span data-stu-id="0489f-206">Circuit Breaker pattern</span></span>

<span data-ttu-id="0489f-207">L'uso del modello a interruttore nell'applicazione può impedire all'applicazione stessa di riprovare un'operazione che probabilmente continuerà a restituire un errore.</span><span class="sxs-lookup"><span data-stu-id="0489f-207">Using the Circuit Breaker pattern in your application can prevent it from retrying an operation that is likely to fail repeatedly.</span></span> <span data-ttu-id="0489f-208">Consente di continuare a eseguire l'applicazione, invece di impegnarla ripetendo l'operazione in modo esponenziale.</span><span class="sxs-lookup"><span data-stu-id="0489f-208">It allows the application to continue to run rather than taking up time while the operation is retried exponentially.</span></span> <span data-ttu-id="0489f-209">Rileva anche quando l'errore è stato corretto e da quel momento l'applicazione può riprovare l'operazione.</span><span class="sxs-lookup"><span data-stu-id="0489f-209">It also detects when the fault has been fixed, at which time the application can try the operation again.</span></span>

### <a name="how-to-implement-the-circuit-breaker-pattern"></a><span data-ttu-id="0489f-210">Come implementare il modello a interruttore</span><span class="sxs-lookup"><span data-stu-id="0489f-210">How to implement the circuit breaker pattern</span></span>

<span data-ttu-id="0489f-211">Per identificare la presenza di un problema con un endpoint primario è possibile monitorare la frequenza con cui il client rileva errori non irreversibili.</span><span class="sxs-lookup"><span data-stu-id="0489f-211">To identify that there is an ongoing problem with a primary endpoint, you can monitor how frequently the client encounters retryable errors.</span></span> <span data-ttu-id="0489f-212">Essendo ogni caso diverso, è necessario stabilire la soglia da usare per passare all'endpoint secondario ed eseguire l'applicazione in modalità di sola lettura.</span><span class="sxs-lookup"><span data-stu-id="0489f-212">Because each case is different, you have to decide on the threshold you want to use for the decision to switch to the secondary endpoint and run the application in read-only mode.</span></span> <span data-ttu-id="0489f-213">Si può ad esempio decidere di eseguire il passaggio in presenza di 10 errori consecutivi senza esiti positivi.</span><span class="sxs-lookup"><span data-stu-id="0489f-213">For example, you could decide to perform the switch if there are 10 failures in a row with no successes.</span></span> <span data-ttu-id="0489f-214">Un altro esempio è l'esecuzione del passaggio se il 90% delle richieste ha esito negativo in un periodo di 2 minuti.</span><span class="sxs-lookup"><span data-stu-id="0489f-214">Another example is to switch if 90% of the requests in a 2-minute period fail.</span></span>

<span data-ttu-id="0489f-215">Per il primo scenario è possibile tenere semplicemente un conteggio degli errori e nel caso di esito positivo prima di raggiungere il valore massimo, impostare nuovamente il conteggio su zero.</span><span class="sxs-lookup"><span data-stu-id="0489f-215">For the first scenario, you can simply keep a count of the failures, and if there is a success before reaching the maximum, set the count back to zero.</span></span> <span data-ttu-id="0489f-216">Per il secondo scenario, una possibile modalità di implementazione è l'oggetto MemoryCache in .NET.</span><span class="sxs-lookup"><span data-stu-id="0489f-216">For the second scenario, one way to implement it is to use the MemoryCache object (in .NET).</span></span> <span data-ttu-id="0489f-217">Per ogni richiesta, aggiungere un elemento CacheItem alla cache, impostare il valore su esito positivo (1) o negativo (0) e impostare la scadenza su 2 minuti da adesso o in base al vincolo temporale.</span><span class="sxs-lookup"><span data-stu-id="0489f-217">For each request, add a CacheItem to the cache, set the value to success (1) or fail (0), and set the expiration time to 2 minutes from now (or whatever your time constraint is).</span></span> <span data-ttu-id="0489f-218">Quando viene raggiunta la scadenza di una voce, questa viene rimossa automaticamente.</span><span class="sxs-lookup"><span data-stu-id="0489f-218">When an entry's expiration time is reached, the entry is automatically removed.</span></span> <span data-ttu-id="0489f-219">Sarà così disponibile una finestra continua di 2 minuti.</span><span class="sxs-lookup"><span data-stu-id="0489f-219">This will give you a rolling 2-minute window.</span></span> <span data-ttu-id="0489f-220">Ogni volta che si effettua una richiesta al servizio di archiviazione, si usa prima una query Linq sull'oggetto MemoryCache per calcolare la percentuale di riuscita sommando i valori e dividendo per il numero.</span><span class="sxs-lookup"><span data-stu-id="0489f-220">Each time you make a request to the storage service, you first use a Linq query across the MemoryCache object to calculate the percent success by summing the values and dividing by the count.</span></span> <span data-ttu-id="0489f-221">Quando la percentuale di riuscita scende sotto una soglia (ad esempio il 10%), impostare la proprietà **LocationMode** per le richieste di lettura su **SecondaryOnly** e attivare la modalità di sola lettura per l'applicazione prima di continuare.</span><span class="sxs-lookup"><span data-stu-id="0489f-221">When the percent success drops below some threshold (such as 10%), set the **LocationMode** property for read requests to **SecondaryOnly** and switch the application into read-only mode before continuing.</span></span>

<span data-ttu-id="0489f-222">La soglia degli errori usata per determinare quando passare alla modalità di sola lettura può variare da servizio a servizio nell'applicazione, quindi è consigliabile usare parametri configurabili.</span><span class="sxs-lookup"><span data-stu-id="0489f-222">The threshold of errors used to determine when to make the switch may vary from service to service in your application, so you should consider making them configurable parameters.</span></span> <span data-ttu-id="0489f-223">Con questi parametri si stabilisce anche se gestire gli errori non irreversibili di ogni servizio separatamente o collettivamente, come illustrato in precedenza.</span><span class="sxs-lookup"><span data-stu-id="0489f-223">This is also where you decide to handle retryable errors from each service separately or as one, as discussed previously.</span></span>

<span data-ttu-id="0489f-224">È necessario considerare anche come gestire più istanze di un'applicazione e come procedere quando si rilevano errori non irreversibili in ogni istanza.</span><span class="sxs-lookup"><span data-stu-id="0489f-224">Another consideration is how to handle multiple instances of an application, and what to do when you detect retryable errors in each instance.</span></span> <span data-ttu-id="0489f-225">È ad esempio possibile avere in esecuzione 20 macchine virtuali nelle quali è caricata la stessa applicazione.</span><span class="sxs-lookup"><span data-stu-id="0489f-225">For example, you may have 20 VMs running with the same application loaded.</span></span> <span data-ttu-id="0489f-226">Ogni istanza viene gestita separatamente?</span><span class="sxs-lookup"><span data-stu-id="0489f-226">Do you handle each instance separately?</span></span> <span data-ttu-id="0489f-227">Se un'istanza inizia ad avere problemi, si vuole limitare la risposta solo a quell'istanza oppure si vuole che tutte le istanze rispondano allo stesso modo quando una sola istanza ha un problema?</span><span class="sxs-lookup"><span data-stu-id="0489f-227">If one instance starts having problems, do you want to limit the response to just that one instance, or do you want to try to have all instances respond in the same way when one instance has a problem?</span></span> <span data-ttu-id="0489f-228">Gestire le istanze separatamente è molto più semplice che provare a coordinare le risposte tra tutte, ma il modo in cui questa operazione viene eseguita dipende dall'architettura dell'applicazione.</span><span class="sxs-lookup"><span data-stu-id="0489f-228">Handling the instances separately is much simpler than trying to coordinate the response across them, but how you do this depends on your application's architecture.</span></span>

### <a name="options-for-monitoring-the-error-frequency"></a><span data-ttu-id="0489f-229">Opzioni per il monitoraggio della frequenza di errore</span><span class="sxs-lookup"><span data-stu-id="0489f-229">Options for monitoring the error frequency</span></span>

<span data-ttu-id="0489f-230">Sono disponibili tre opzioni principali per monitorare la frequenza dei tentativi nell'area primaria per determinare quando passare all'area secondaria e attivare la modalità di sola lettura per l'applicazione.</span><span class="sxs-lookup"><span data-stu-id="0489f-230">You have three main options for monitoring the frequency of retries in the primary region in order to determine when to switch over to the secondary region and change the application to run in read-only mode.</span></span>

*   <span data-ttu-id="0489f-231">Aggiungere un gestore per l'evento [**Retrying** ](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.operationcontext.retrying.aspx) nell'oggetto [ **OperationContext** ](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.operationcontext.aspx) passato alle richieste di archiviazione: si tratta del metodo illustrato in questo articolo e usato nell'esempio di codice correlato.</span><span class="sxs-lookup"><span data-stu-id="0489f-231">Add a handler for the [**Retrying**](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.operationcontext.retrying.aspx) event on the [**OperationContext**](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.operationcontext.aspx) object you pass to your storage requests – this is the method displayed in this article and used in the accompanying sample.</span></span> <span data-ttu-id="0489f-232">Questi eventi vengono attivati ogni volta che il client riprova una richiesta, consentendo così di determinare la frequenza con cui il client rileva errori non irreversibili in un endpoint primario.</span><span class="sxs-lookup"><span data-stu-id="0489f-232">These events fire whenever the client retries a request, enabling you to track how often the client encounters retryable errors on a primary endpoint.</span></span>

    ```csharp 
    operationContext.Retrying += (sender, arguments) =>
    {
        // Retrying in the primary region
        if (arguments.Request.Host == primaryhostname)
            ...
    };
    ```

*   <span data-ttu-id="0489f-233">Nel metodo [**Evaluate**](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.retrypolicies.iextendedretrypolicy.evaluate.aspx) in un criterio di tentativi personalizzato è possibile eseguire codice personalizzato ogni volta che viene eseguito un tentativo.</span><span class="sxs-lookup"><span data-stu-id="0489f-233">In the [**Evaluate**](http://msdn.microsoft.com/en-us/library/microsoft.windowsazure.storage.retrypolicies.iextendedretrypolicy.evaluate.aspx) method in a custom retry policy, you can run custom code whenever a retry takes place.</span></span> <span data-ttu-id="0489f-234">Oltre a registrare l'esecuzione di un tentativo, il metodo consente di modificare il comportamento dei tentativi.</span><span class="sxs-lookup"><span data-stu-id="0489f-234">In addition to recording when a retry happens, this also gives you the opportunity to modify your retry behavior.</span></span>

    ```csharp 
    public RetryInfo Evaluate(RetryContext retryContext,
    OperationContext operationContext)
    {
        var statusCode = retryContext.LastRequestResult.HttpStatusCode;
        if (retryContext.CurrentRetryCount >= this.maximumAttempts
        || ((statusCode &gt;= 300 && statusCode &lt; 500 && statusCode != 408)
        || statusCode == 501 // Not Implemented
        || statusCode == 505 // Version Not Supported
            ))
        {
        // Do not retry
            return null;
        }

        // Monitor retries in the primary location
        ...

        // Determine RetryInterval and TargetLocation
        RetryInfo info =
            CreateRetryInfo(retryContext.CurrentRetryCount);

        return info;
    }
    ```

*   <span data-ttu-id="0489f-235">Il terzo approccio consiste nell'implementazione di un componente di monitoraggio personalizzato nell'applicazione che esegue continuamente il ping dell'endpoint di archiviazione primario con richieste di lettura fittizie, ad esempio la lettura di un BLOB di piccole dimensioni, per determinarne l'integrità.</span><span class="sxs-lookup"><span data-stu-id="0489f-235">The third approach is to implement a custom monitoring component in your application that continually pings your primary storage endpoint with dummy read requests (such as reading a small blob) to determine its health.</span></span> <span data-ttu-id="0489f-236">Questa operazione impiegherà alcune risorse, ma non molte.</span><span class="sxs-lookup"><span data-stu-id="0489f-236">This would take up some resources, but not a significant amount.</span></span> <span data-ttu-id="0489f-237">Quando viene rilevato un problema che raggiunge la soglia, verranno attivate l'impostazione **SecondaryOnly** e la modalità di sola lettura.</span><span class="sxs-lookup"><span data-stu-id="0489f-237">When a problem is discovered that reaches your threshold, you would then perform the switch to **SecondaryOnly** and read-only mode.</span></span>

<span data-ttu-id="0489f-238">A un certo punto sarà necessario tornare a usare l'endpoint primario e consentire gli aggiornamenti.</span><span class="sxs-lookup"><span data-stu-id="0489f-238">At some point, you will want to switch back to using the primary endpoint and allowing updates.</span></span> <span data-ttu-id="0489f-239">Se si usa uno dei primi due metodi elencati in precedenza, è possibile tornare semplicemente all'endpoint primario e abilitare la modalità di aggiornamento dopo un periodo di tempo o un numero di operazioni selezionato dall'utente.</span><span class="sxs-lookup"><span data-stu-id="0489f-239">If using one of the first two methods listed above, you could simply switch back to the primary endpoint and enable update mode after an arbitrarily selected amount of time or number of operations has been performed.</span></span> <span data-ttu-id="0489f-240">Si potrà quindi riprendere la logica dei tentativi.</span><span class="sxs-lookup"><span data-stu-id="0489f-240">You can then let it go through the retry logic again.</span></span> <span data-ttu-id="0489f-241">Se il problema è stato risolto, si continuerà a usare l'endpoint primario e a consentire gli aggiornamenti.</span><span class="sxs-lookup"><span data-stu-id="0489f-241">If the problem has been fixed, it will continue to use the primary endpoint and allow updates.</span></span> <span data-ttu-id="0489f-242">Se il problema è ancora presente, l'applicazione passerà di nuovo all'endpoint secondario e alla modalità di sola lettura dopo non aver soddisfatto i criteri impostati.</span><span class="sxs-lookup"><span data-stu-id="0489f-242">If there is still a problem, it will once more switch back to the secondary endpoint and read-only mode after failing the criteria you've set.</span></span>

<span data-ttu-id="0489f-243">Per il terzo scenario, quando il ping dell'endpoint di archiviazione primario ha nuovamente esito positivo, è possibile riattivare l'opzione **PrimaryOnly** e continuare a consentire gli aggiornamenti.</span><span class="sxs-lookup"><span data-stu-id="0489f-243">For the third scenario, when pinging the primary storage endpoint becomes successful again, you can trigger the switch back to **PrimaryOnly** and continue allowing updates.</span></span>

## <a name="handling-eventually-consistent-data"></a><span data-ttu-id="0489f-244">Gestione di dati con coerenza finale</span><span class="sxs-lookup"><span data-stu-id="0489f-244">Handling eventually consistent data</span></span>

<span data-ttu-id="0489f-245">L'archiviazione con ridondanza geografica e accesso in lettura funziona replicando le transazioni dall'area primaria all'area secondaria.</span><span class="sxs-lookup"><span data-stu-id="0489f-245">RA-GRS works by replicating transactions from the primary to the secondary region.</span></span> <span data-ttu-id="0489f-246">Il processo di replica garantisce che i dati nell'area secondaria abbiano *coerenza finale*.</span><span class="sxs-lookup"><span data-stu-id="0489f-246">This replication process guarantees that the data in the secondary region is *eventually consistent*.</span></span> <span data-ttu-id="0489f-247">Questo significa che tutte le transazioni nell'area primaria saranno alla fine presenti nell'area secondaria, ma potrebbe verificarsi un ritardo prima che vengano visualizzate e che non è possibile garantire che giungano nell'area secondaria nello stesso ordine in cui si trovavano originariamente nell'area primaria.</span><span class="sxs-lookup"><span data-stu-id="0489f-247">This means that all the transactions in the primary region will eventually appear in the secondary region, but that there may be a lag before they appear, and that there is no guarantee the transactions arrive in the secondary region in the same order as that in which they were originally applied in the primary region.</span></span> <span data-ttu-id="0489f-248">Se le transazioni non giungono nell'area secondaria nell'ordine originario, è *possibile* che i dati nell'area secondaria siano incoerenti finché il servizio non si allinea.</span><span class="sxs-lookup"><span data-stu-id="0489f-248">If your transactions arrive in the secondary region out of order, you *may* consider your data in the secondary region to be in an inconsistent state until the service catches up.</span></span>

<span data-ttu-id="0489f-249">La tabella seguente illustra un esempio del risultato ottenuto quando si aggiornano i dettagli di un dipendente per renderlo membro del ruolo *amministratori*.</span><span class="sxs-lookup"><span data-stu-id="0489f-249">The following table shows an example of what might happen when you update the details of an employee to make her a member of the *administrators* role.</span></span> <span data-ttu-id="0489f-250">Ai fini di questo esempio è necessario aggiornare l'entità **employee** e aggiornare un'entità **administrator role** con un conteggio del numero totale di amministratori.</span><span class="sxs-lookup"><span data-stu-id="0489f-250">For the sake of this example, this requires you update the **employee** entity and update an **administrator role** entity with a count of the total number of administrators.</span></span> <span data-ttu-id="0489f-251">Si noti il modo in cui gli aggiornamenti vengono applicati in un ordine diverso nell'area secondaria.</span><span class="sxs-lookup"><span data-stu-id="0489f-251">Notice how the updates are applied out of order in the secondary region.</span></span>

| <span data-ttu-id="0489f-252">**Ora**</span><span class="sxs-lookup"><span data-stu-id="0489f-252">**Time**</span></span> | <span data-ttu-id="0489f-253">**Transazione**</span><span class="sxs-lookup"><span data-stu-id="0489f-253">**Transaction**</span></span>                                            | <span data-ttu-id="0489f-254">**Replica**</span><span class="sxs-lookup"><span data-stu-id="0489f-254">**Replication**</span></span>                       | <span data-ttu-id="0489f-255">**Ora ultima sincronizzazione**</span><span class="sxs-lookup"><span data-stu-id="0489f-255">**Last Sync Time**</span></span> | <span data-ttu-id="0489f-256">**Risultato**</span><span class="sxs-lookup"><span data-stu-id="0489f-256">**Result**</span></span> |
|----------|------------------------------------------------------------|---------------------------------------|--------------------|------------| 
| <span data-ttu-id="0489f-257">T0</span><span class="sxs-lookup"><span data-stu-id="0489f-257">T0</span></span>       | <span data-ttu-id="0489f-258">Transazione A:</span><span class="sxs-lookup"><span data-stu-id="0489f-258">Transaction A:</span></span> <br> <span data-ttu-id="0489f-259">Inserimento dell'entità</span><span class="sxs-lookup"><span data-stu-id="0489f-259">Insert employee</span></span> <br> <span data-ttu-id="0489f-260">employee nell'area primaria</span><span class="sxs-lookup"><span data-stu-id="0489f-260">entity in primary</span></span> |                                   |                    | <span data-ttu-id="0489f-261">Transazione A inserita nell'area primaria,</span><span class="sxs-lookup"><span data-stu-id="0489f-261">Transaction A inserted to primary,</span></span><br> <span data-ttu-id="0489f-262">non ancora replicata.</span><span class="sxs-lookup"><span data-stu-id="0489f-262">not replicated yet.</span></span> |
| <span data-ttu-id="0489f-263">T1</span><span class="sxs-lookup"><span data-stu-id="0489f-263">T1</span></span>       |                                                            | <span data-ttu-id="0489f-264">Transazione A</span><span class="sxs-lookup"><span data-stu-id="0489f-264">Transaction A</span></span> <br> <span data-ttu-id="0489f-265">replicata</span><span class="sxs-lookup"><span data-stu-id="0489f-265">replicated to</span></span><br> <span data-ttu-id="0489f-266">nell'area secondaria</span><span class="sxs-lookup"><span data-stu-id="0489f-266">secondary</span></span> | <span data-ttu-id="0489f-267">T1</span><span class="sxs-lookup"><span data-stu-id="0489f-267">T1</span></span> | <span data-ttu-id="0489f-268">Transazione A replicata nell'area secondaria.</span><span class="sxs-lookup"><span data-stu-id="0489f-268">Transaction A replicated to secondary.</span></span> <br><span data-ttu-id="0489f-269">Ora ultima sincronizzazione aggiornata.</span><span class="sxs-lookup"><span data-stu-id="0489f-269">Last Sync Time updated.</span></span>    |
| <span data-ttu-id="0489f-270">T2</span><span class="sxs-lookup"><span data-stu-id="0489f-270">T2</span></span>       | <span data-ttu-id="0489f-271">Transazione B:</span><span class="sxs-lookup"><span data-stu-id="0489f-271">Transaction B:</span></span><br><span data-ttu-id="0489f-272">Aggiornamento</span><span class="sxs-lookup"><span data-stu-id="0489f-272">Update</span></span><br> <span data-ttu-id="0489f-273">dell'entità employee</span><span class="sxs-lookup"><span data-stu-id="0489f-273">employee entity</span></span><br> <span data-ttu-id="0489f-274">nell'area primaria</span><span class="sxs-lookup"><span data-stu-id="0489f-274">in primary</span></span>  |                                | <span data-ttu-id="0489f-275">T1</span><span class="sxs-lookup"><span data-stu-id="0489f-275">T1</span></span>                 | <span data-ttu-id="0489f-276">Transazione B scritta nell'area primaria,</span><span class="sxs-lookup"><span data-stu-id="0489f-276">Transaction B written to primary,</span></span><br> <span data-ttu-id="0489f-277">non ancora replicata.</span><span class="sxs-lookup"><span data-stu-id="0489f-277">not replicated yet.</span></span>  |
| <span data-ttu-id="0489f-278">T3</span><span class="sxs-lookup"><span data-stu-id="0489f-278">T3</span></span>       | <span data-ttu-id="0489f-279">Transazione C:</span><span class="sxs-lookup"><span data-stu-id="0489f-279">Transaction C:</span></span><br> <span data-ttu-id="0489f-280">Aggiornamento</span><span class="sxs-lookup"><span data-stu-id="0489f-280">Update</span></span> <br><span data-ttu-id="0489f-281">entità</span><span class="sxs-lookup"><span data-stu-id="0489f-281">administrator</span></span><br><span data-ttu-id="0489f-282">administrator role nell'area</span><span class="sxs-lookup"><span data-stu-id="0489f-282">role entity in</span></span><br><span data-ttu-id="0489f-283">primaria</span><span class="sxs-lookup"><span data-stu-id="0489f-283">primary</span></span> |                    | <span data-ttu-id="0489f-284">T1</span><span class="sxs-lookup"><span data-stu-id="0489f-284">T1</span></span>                 | <span data-ttu-id="0489f-285">Transazione C scritta nell'area primaria,</span><span class="sxs-lookup"><span data-stu-id="0489f-285">Transaction C written to primary,</span></span><br> <span data-ttu-id="0489f-286">non ancora replicata.</span><span class="sxs-lookup"><span data-stu-id="0489f-286">not replicated yet.</span></span>  |
| <span data-ttu-id="0489f-287">*T4*</span><span class="sxs-lookup"><span data-stu-id="0489f-287">*T4*</span></span>     |                                                       | <span data-ttu-id="0489f-288">Transazione C</span><span class="sxs-lookup"><span data-stu-id="0489f-288">Transaction C</span></span> <br><span data-ttu-id="0489f-289">replicata</span><span class="sxs-lookup"><span data-stu-id="0489f-289">replicated to</span></span><br> <span data-ttu-id="0489f-290">nell'area secondaria</span><span class="sxs-lookup"><span data-stu-id="0489f-290">secondary</span></span> | <span data-ttu-id="0489f-291">T1</span><span class="sxs-lookup"><span data-stu-id="0489f-291">T1</span></span>         | <span data-ttu-id="0489f-292">Transazione C replicata nell'area secondaria.</span><span class="sxs-lookup"><span data-stu-id="0489f-292">Transaction C replicated to secondary.</span></span><br><span data-ttu-id="0489f-293">LastSyncTime non aggiornato perché</span><span class="sxs-lookup"><span data-stu-id="0489f-293">LastSyncTime not updated because</span></span> <br><span data-ttu-id="0489f-294">la transazione B non è stata ancora replicata.</span><span class="sxs-lookup"><span data-stu-id="0489f-294">transaction B has not been replicated yet.</span></span>|
| <span data-ttu-id="0489f-295">*T5*</span><span class="sxs-lookup"><span data-stu-id="0489f-295">*T5*</span></span>     | <span data-ttu-id="0489f-296">Lettura delle entità</span><span class="sxs-lookup"><span data-stu-id="0489f-296">Read entities</span></span> <br><span data-ttu-id="0489f-297">dall'area secondaria</span><span class="sxs-lookup"><span data-stu-id="0489f-297">from secondary</span></span>                           |                                  | <span data-ttu-id="0489f-298">T1</span><span class="sxs-lookup"><span data-stu-id="0489f-298">T1</span></span>                 | <span data-ttu-id="0489f-299">Si ottiene un valore non aggiornato per l'entità</span><span class="sxs-lookup"><span data-stu-id="0489f-299">You get the stale value for employee</span></span> <br> <span data-ttu-id="0489f-300">employee perché la transazione B</span><span class="sxs-lookup"><span data-stu-id="0489f-300">entity because transaction B hasn't</span></span> <br> <span data-ttu-id="0489f-301">non è stata ancora replicata.</span><span class="sxs-lookup"><span data-stu-id="0489f-301">replicated yet.</span></span> <span data-ttu-id="0489f-302">Si ottiene il nuovo valore per</span><span class="sxs-lookup"><span data-stu-id="0489f-302">You get the new value for</span></span><br> <span data-ttu-id="0489f-303">l'entità administrator role perché C è stata</span><span class="sxs-lookup"><span data-stu-id="0489f-303">administrator role entity because C has</span></span><br> <span data-ttu-id="0489f-304">replicata.</span><span class="sxs-lookup"><span data-stu-id="0489f-304">replicated.</span></span> <span data-ttu-id="0489f-305">Ora ultima sincronizzazione non ancora</span><span class="sxs-lookup"><span data-stu-id="0489f-305">Last Sync Time still hasn't</span></span><br> <span data-ttu-id="0489f-306">aggiornata perché la transazione B</span><span class="sxs-lookup"><span data-stu-id="0489f-306">been updated because transaction B</span></span><br> <span data-ttu-id="0489f-307">non è stata replicata.</span><span class="sxs-lookup"><span data-stu-id="0489f-307">hasn't replicated.</span></span> <span data-ttu-id="0489f-308">È possibile stabilire che</span><span class="sxs-lookup"><span data-stu-id="0489f-308">You can tell the</span></span><br><span data-ttu-id="0489f-309">l'entità administrator role è incoerente</span><span class="sxs-lookup"><span data-stu-id="0489f-309">administrator role entity is inconsistent</span></span> <br><span data-ttu-id="0489f-310">perché la data/ora dell'entità è successiva</span><span class="sxs-lookup"><span data-stu-id="0489f-310">because the entity date/time is after</span></span> <br><span data-ttu-id="0489f-311">all'ora dell'ultima sincronizzazione.</span><span class="sxs-lookup"><span data-stu-id="0489f-311">the Last Sync Time.</span></span> |
| <span data-ttu-id="0489f-312">*T6*</span><span class="sxs-lookup"><span data-stu-id="0489f-312">*T6*</span></span>     |                                                      | <span data-ttu-id="0489f-313">Transazione B</span><span class="sxs-lookup"><span data-stu-id="0489f-313">Transaction B</span></span><br> <span data-ttu-id="0489f-314">replicata</span><span class="sxs-lookup"><span data-stu-id="0489f-314">replicated to</span></span><br> <span data-ttu-id="0489f-315">nell'area secondaria</span><span class="sxs-lookup"><span data-stu-id="0489f-315">secondary</span></span> | <span data-ttu-id="0489f-316">T6</span><span class="sxs-lookup"><span data-stu-id="0489f-316">T6</span></span>                 | <span data-ttu-id="0489f-317">*T6*: tutte le transazioni fino alla C sono</span><span class="sxs-lookup"><span data-stu-id="0489f-317">*T6* – All transactions through C have</span></span> <br><span data-ttu-id="0489f-318">state replicate, ora ultima sincronizzazione</span><span class="sxs-lookup"><span data-stu-id="0489f-318">been replicated, Last Sync Time</span></span><br> <span data-ttu-id="0489f-319">aggiornata.</span><span class="sxs-lookup"><span data-stu-id="0489f-319">is updated.</span></span> |

<span data-ttu-id="0489f-320">In questo esempio presupporre che il client passi alla lettura dell'area secondaria in corrispondenza di T5.</span><span class="sxs-lookup"><span data-stu-id="0489f-320">In this example, assume the client switches to reading from the secondary region at T5.</span></span> <span data-ttu-id="0489f-321">Può leggere correttamente l'entità **administrator role** in questa fase, ma l'entità contiene un valore di conteggio degli amministratori che non è coerente con il numero di entità **employee** attualmente contrassegnate come amministratori nell'area secondaria.</span><span class="sxs-lookup"><span data-stu-id="0489f-321">It can successfully read the **administrator role** entity at this time, but the entity contains a value for the count of administrators that is not consistent with the number of **employee** entities that are marked as administrators in the secondary region at this time.</span></span> <span data-ttu-id="0489f-322">Il client può semplicemente visualizzare questo valore, con il rischio che si tratti di informazioni incoerenti.</span><span class="sxs-lookup"><span data-stu-id="0489f-322">Your client could simply display this value, with the risk that it is inconsistent information.</span></span> <span data-ttu-id="0489f-323">In alternativa, il client può determinare che **administrator role** si trova in uno stato potenzialmente incoerente perché gli aggiornamenti non hanno seguito l'ordine e informare l'utente.</span><span class="sxs-lookup"><span data-stu-id="0489f-323">Alternatively, the client could attempt to determine that the **administrator role** is in a potentially inconsistent state because the updates have happened out of order, and then inform the user of this fact.</span></span>

<span data-ttu-id="0489f-324">Per riconoscere la presenza di dati potenzialmente incoerenti, il client può usare il valore di *Ora ultima sincronizzazione* che può essere ottenuto in qualsiasi momento eseguendo una query su un servizio di archiviazione.</span><span class="sxs-lookup"><span data-stu-id="0489f-324">To recognize that it has potentially inconsistent data, the client can use the value of the *Last Sync Time* that you can get at any time by querying a storage service.</span></span> <span data-ttu-id="0489f-325">Questo valore indica l'ora in cui i dati nell'area secondaria sono stati coerenti per l'ultima volta e l'ora in cui il servizio aveva applicato tutte le transazioni prima di quel momento.</span><span class="sxs-lookup"><span data-stu-id="0489f-325">This tells you the time when the data in the secondary region was last consistent and when the service had applied all the transactions prior to that point in time.</span></span> <span data-ttu-id="0489f-326">Nell'esempio illustrato in precedenza, dopo che il servizio ha inserito l'entità **employee** nell'area secondaria l'ora dell'ultima sincronizzazione viene impostata su *T1*.</span><span class="sxs-lookup"><span data-stu-id="0489f-326">In the example shown above, after the service inserts the **employee** entity in the secondary region, the last sync time is set to *T1*.</span></span> <span data-ttu-id="0489f-327">Resta impostata su *T1* finché il servizio non aggiorna l'entità **employee** nell'area secondaria quando viene impostata su *T6*.</span><span class="sxs-lookup"><span data-stu-id="0489f-327">It remains at *T1* until the service updates the **employee** entity in the secondary region when it is set to *T6*.</span></span> <span data-ttu-id="0489f-328">Se recupera l'ora dell'ultima sincronizzazione quando legge l'entità su *T5*, il client può confrontare questo dato con il timestamp dell'entità.</span><span class="sxs-lookup"><span data-stu-id="0489f-328">If the client retrieves the last sync time when it reads the entity at *T5*, it can compare it with the timestamp on the entity.</span></span> <span data-ttu-id="0489f-329">Se il timestamp dell'entità è successivo all'ora dell'ultima sincronizzazione, l'entità si trova in uno stato potenzialmente non coerente ed è possibile intervenire nel modo più idoneo per l'applicazione.</span><span class="sxs-lookup"><span data-stu-id="0489f-329">If the timestamp on the entity is later than the last sync time, then the entity is in a potentially inconsistent state, and you can take whatever is the appropriate action for your application.</span></span> <span data-ttu-id="0489f-330">Per usare questo campo è necessario sapere quando è stato completato l'ultimo aggiornamento nell'area primaria.</span><span class="sxs-lookup"><span data-stu-id="0489f-330">Using this field requires that you know when the last update to the primary was completed.</span></span>

## <a name="testing"></a><span data-ttu-id="0489f-331">Test</span><span class="sxs-lookup"><span data-stu-id="0489f-331">Testing</span></span>

<span data-ttu-id="0489f-332">È importante verificare che l'applicazione si comporti come previsto quando si verificano errori non irreversibili.</span><span class="sxs-lookup"><span data-stu-id="0489f-332">It's important to test that your application behaves as expected when it encounters retryable errors.</span></span> <span data-ttu-id="0489f-333">È ad esempio necessario verificare che l'applicazione passi all'area secondaria e in modalità di sola lettura quando viene rilevato un problema e torni all'area primaria quando questa è nuovamente disponibile.</span><span class="sxs-lookup"><span data-stu-id="0489f-333">For example, you need to test that the application switches to the secondary and into read-only mode when it detects a problem, and switches back when the primary region becomes available again.</span></span> <span data-ttu-id="0489f-334">A tale scopo è necessario un modo per simulare gli errori non irreversibili e la frequenza con cui si verificano.</span><span class="sxs-lookup"><span data-stu-id="0489f-334">To do this, you need a way to simulate retryable errors and control how often they occur.</span></span>

<span data-ttu-id="0489f-335">È possibile usare [Fiddler](http://www.telerik.com/fiddler) per intercettare e modificare le risposte HTTP in uno script.</span><span class="sxs-lookup"><span data-stu-id="0489f-335">You can use [Fiddler](http://www.telerik.com/fiddler) to intercept and modify HTTP responses in a script.</span></span> <span data-ttu-id="0489f-336">Questo script può identificare le risposte che provengono dall'endpoint primario e sostituire il codice di stato HTTP con un codice riconosciuto dalla libreria client di archiviazione come errore non irreversibile.</span><span class="sxs-lookup"><span data-stu-id="0489f-336">This script can identify responses that come from your primary endpoint and change the HTTP status code to one that the Storage Client Library recognizes as a retryable error.</span></span> <span data-ttu-id="0489f-337">Questo frammento di codice descrive un esempio semplice di script Fiddler che intercetta le risposte alle richieste di lettura sulla tabella **employeedata** per restituire uno stato 502:</span><span class="sxs-lookup"><span data-stu-id="0489f-337">This code snippet shows a simple example of a Fiddler script that intercepts responses to read requests against the **employeedata** table to return a 502 status:</span></span>

```java
static function OnBeforeResponse(oSession: Session) {
    ...
    if ((oSession.hostname == "\[yourstorageaccount\].table.core.windows.net")
      && (oSession.PathAndQuery.StartsWith("/employeedata?$filter"))) {
        oSession.responseCode = 502;
    }
}
```

<span data-ttu-id="0489f-338">È possibile estendere questo esempio per intercettare una gamma più ampia di richieste e modificare **responseCode** solo in alcune di esse per simulare meglio uno scenario reale.</span><span class="sxs-lookup"><span data-stu-id="0489f-338">You could extend this example to intercept a wider range of requests and only change the **responseCode** on some of them to better simulate a real-world scenario.</span></span> <span data-ttu-id="0489f-339">Per altre informazioni sulla personalizzazione degli script Fiddler, vedere [Modifying a Request or Response](http://docs.telerik.com/fiddler/KnowledgeBase/FiddlerScript/ModifyRequestOrResponse) (Modifica di una richiesta o risposta) nella documentazione di Fiddler.</span><span class="sxs-lookup"><span data-stu-id="0489f-339">For more information about customizing Fiddler scripts, see [Modifying a Request or Response](http://docs.telerik.com/fiddler/KnowledgeBase/FiddlerScript/ModifyRequestOrResponse) in the Fiddler documentation.</span></span>

<span data-ttu-id="0489f-340">Se le soglie per il passaggio dell'applicazione alla modalità di sola lettura sono state impostate come configurabili, sarà più semplice verificare il comportamento con volumi di transazioni non di produzione.</span><span class="sxs-lookup"><span data-stu-id="0489f-340">If you have made the thresholds for switching your application to read-only mode configurable, it will be easier to test the behavior with non-production transaction volumes.</span></span>

## <a name="next-steps"></a><span data-ttu-id="0489f-341">Passaggi successivi</span><span class="sxs-lookup"><span data-stu-id="0489f-341">Next Steps</span></span>

* <span data-ttu-id="0489f-342">Per altre informazioni sull'archiviazione con ridondanza geografica e accesso in lettura, incluso un altro esempio di impostazione di LastSyncTime, vedere [Windows Azure Storage Redundancy Options and Read Access Geo Redundant Storage](https://blogs.msdn.microsoft.com/windowsazurestorage/2013/12/11/windows-azure-storage-redundancy-options-and-read-access-geo-redundant-storage/) (Opzioni di ridondanza di archiviazione di Windows Azure e archiviazione con ridondanza geografica e accesso in lettura).</span><span class="sxs-lookup"><span data-stu-id="0489f-342">For more information about Read Access Geo-Redundancy, including another example of how the LastSyncTime is set, please see [Windows Azure Storage Redundancy Options and Read Access Geo Redundant Storage](https://blogs.msdn.microsoft.com/windowsazurestorage/2013/12/11/windows-azure-storage-redundancy-options-and-read-access-geo-redundant-storage/).</span></span>

* <span data-ttu-id="0489f-343">Per un esempio completo che illustra come attivare il passaggio dall'endpoint primario all'endpoint secondario e viceversa, vedere [Esempi di Azure: uso del modello a interruttore con l'archiviazione con ridondanza geografica e accesso in lettura](https://github.com/Azure-Samples/storage-dotnet-circuit-breaker-pattern-ha-apps-using-ra-grs).</span><span class="sxs-lookup"><span data-stu-id="0489f-343">For a complete sample showing how to make the switch back and forth between the Primary and Secondary endpoints, please see [Azure Samples – Using the Circuit Breaker Pattern with RA-GRS storage](https://github.com/Azure-Samples/storage-dotnet-circuit-breaker-pattern-ha-apps-using-ra-grs).</span></span>
