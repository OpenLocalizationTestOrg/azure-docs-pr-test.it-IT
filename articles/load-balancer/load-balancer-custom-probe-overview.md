---
title: "Probe personalizzati del servizio di bilanciamento del carico e monitoraggio dello stato integrità | Documentazione Microsoft"
description: Informazioni su come usare probe personalizzati per il servizio di bilanciamento del carico di Azure per monitorare le relative istanze
services: load-balancer
documentationcenter: na
author: kumudd
manager: timlt
editor: 
tags: azure-resource-manager
ms.assetid: 46b152c5-6a27-4bfc-bea3-05de9ce06a57
ms.service: load-balancer
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 10/24/2016
ms.author: kumud
ms.openlocfilehash: cab028fed58d544a56f2f6b12b72364c7baf4d86
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 07/11/2017
---
# <a name="understand-load-balancer-probes"></a><span data-ttu-id="63d72-103">Informazioni sui probe di bilanciamento del carico</span><span class="sxs-lookup"><span data-stu-id="63d72-103">Understand load balancer probes</span></span>

<span data-ttu-id="63d72-104">Il servizio di bilanciamento del carico di Azure consente di monitorare l'integrità delle istanze del server tramite probe.</span><span class="sxs-lookup"><span data-stu-id="63d72-104">Azure Load Balancer offers the capability to monitor the health of server instances by using probes.</span></span> <span data-ttu-id="63d72-105">Se un probe non risponde, il servizio di bilanciamento del carico interrompe l'invio di nuove connessioni all'istanza non integra.</span><span class="sxs-lookup"><span data-stu-id="63d72-105">When a probe fails to respond, Load Balancer stops sending new connections to the unhealthy instance.</span></span> <span data-ttu-id="63d72-106">Le connessioni esistenti non sono interessate, mentre quelle nuove vengono inviate alle istanze integre.</span><span class="sxs-lookup"><span data-stu-id="63d72-106">The existing connections are not affected, and new connections are sent to healthy instances.</span></span>

<span data-ttu-id="63d72-107">I ruoli del servizio cloud, ovvero i ruoli di lavoro e i ruoli Web, usano un agente guest per il monitoraggio probe.</span><span class="sxs-lookup"><span data-stu-id="63d72-107">Cloud service roles (worker roles and web roles) use a guest agent for probe monitoring.</span></span> <span data-ttu-id="63d72-108">I probe TCP o HTTP personalizzati devono essere configurati quando si usano macchine virtuali monitorate tramite il servizio di bilanciamento del carico.</span><span class="sxs-lookup"><span data-stu-id="63d72-108">TCP or HTTP custom probes must be configured when you use virtual machines behind Load Balancer.</span></span>

## <a name="understand-probe-count-and-timeout"></a><span data-ttu-id="63d72-109">Informazioni su conteggio e timeout dei probe</span><span class="sxs-lookup"><span data-stu-id="63d72-109">Understand probe count and timeout</span></span>

<span data-ttu-id="63d72-110">Il comportamento dei probe dipende dagli elementi seguenti:</span><span class="sxs-lookup"><span data-stu-id="63d72-110">Probe behavior depends on:</span></span>

* <span data-ttu-id="63d72-111">Numero di probe riusciti che consentono di etichettare un'istanza come attiva.</span><span class="sxs-lookup"><span data-stu-id="63d72-111">The number of successful probes that allow an instance to be labeled as up.</span></span>
* <span data-ttu-id="63d72-112">Numero di probe non riusciti che fanno sì che un'istanza sia etichettata come inattiva.</span><span class="sxs-lookup"><span data-stu-id="63d72-112">The number of failed probes that cause an instance to be labeled as down.</span></span>

<span data-ttu-id="63d72-113">Il valore relativo a timeout e frequenza impostato in SuccessFailCount determina se un'istanza è confermata come in esecuzione o non in esecuzione.</span><span class="sxs-lookup"><span data-stu-id="63d72-113">The timeout and frequency value set in  SuccessFailCount determine whether an instance is confirmed to be running or not running.</span></span> <span data-ttu-id="63d72-114">Nel portale di Azure il timeout è impostato sul doppio del valore della frequenza.</span><span class="sxs-lookup"><span data-stu-id="63d72-114">In the Azure portal, the timeout is set to two times the value of the frequency.</span></span>

<span data-ttu-id="63d72-115">La configurazione dei probe deve essere la stessa in tutte le istanze con bilanciamento del carico per un endpoint, ovvero un set con bilanciamento del carico.</span><span class="sxs-lookup"><span data-stu-id="63d72-115">The probe configuration of all load-balanced instances for an endpoint (that is, a load-balanced set) must be the same.</span></span> <span data-ttu-id="63d72-116">Ciò significa che non è possibile avere una configurazione dei probe diversa per ogni istanza del ruolo o macchina virtuale nello stesso servizio ospitato per una combinazione di endpoint particolare.</span><span class="sxs-lookup"><span data-stu-id="63d72-116">This means you cannot have a different probe configuration for each role instance or virtual machine in the same hosted service for a particular endpoint combination.</span></span> <span data-ttu-id="63d72-117">Ad esempio, ogni istanza deve avere porte locali e i timeout identici.</span><span class="sxs-lookup"><span data-stu-id="63d72-117">For example, each instance must have identical local ports and timeouts.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="63d72-118">Un probe del servizio di bilanciamento del carico usa l'indirizzo IP 168.63.129.16.</span><span class="sxs-lookup"><span data-stu-id="63d72-118">A Load Balancer probe uses the IP address 168.63.129.16.</span></span> <span data-ttu-id="63d72-119">Questo indirizzo IP pubblico facilita la comunicazione con le risorse interne della piattaforma per lo scenario Rete virtuale di Azure che prevede l'uso di un IP personale ("bring your own IP").</span><span class="sxs-lookup"><span data-stu-id="63d72-119">This public IP address facilitates communication to internal platform resources for the bring-your-own-IP Azure Virtual Network scenario.</span></span> <span data-ttu-id="63d72-120">L'indirizzo IP pubblico virtuale 168.63.129.16 viene usato in tutte le aree e non cambia.</span><span class="sxs-lookup"><span data-stu-id="63d72-120">The virtual public IP address 168.63.129.16 is used in all regions and will not change.</span></span> <span data-ttu-id="63d72-121">È consigliabile consentire questo indirizzo IP in tutti i criteri firewall locali.</span><span class="sxs-lookup"><span data-stu-id="63d72-121">We recommend that you allow this IP address in any local firewall policies.</span></span> <span data-ttu-id="63d72-122">Non deve essere considerato come un rischio per la sicurezza, perché solo la piattaforma Azure interna può generare un messaggio da questo indirizzo.</span><span class="sxs-lookup"><span data-stu-id="63d72-122">It should not be considered a security risk because only the internal Azure platform can source a message from that address.</span></span> <span data-ttu-id="63d72-123">In caso contrario, si avrà un comportamento imprevisto in diversi scenari, come la configurazione dello stesso intervallo di indirizzi IP 168.63.129.16 e la presenza di indirizzi IP duplicati.</span><span class="sxs-lookup"><span data-stu-id="63d72-123">If you do not do this, there will be unexpected behavior in a variety of scenarios like configuring the same IP address range of 168.63.129.16 and having duplicated IP addresses.</span></span>

## <a name="learn-about-the-types-of-probes"></a><span data-ttu-id="63d72-124">Informazioni sui tipi di probe</span><span class="sxs-lookup"><span data-stu-id="63d72-124">Learn about the types of probes</span></span>

### <a name="guest-agent-probe"></a><span data-ttu-id="63d72-125">Probe dell'agente guest</span><span class="sxs-lookup"><span data-stu-id="63d72-125">Guest agent probe</span></span>

<span data-ttu-id="63d72-126">Questo probe è disponibile solo per i servizi cloud di Azure.</span><span class="sxs-lookup"><span data-stu-id="63d72-126">This probe is available for Azure Cloud Services only.</span></span> <span data-ttu-id="63d72-127">Il servizio di bilanciamento del carico di Azure utilizza l'agente guest nella macchina virtuale e quindi rimane in ascolto e invia una risposta HTTP 200 OK solo quando l'istanza è nello stato Pronto, ovvero non nello stato Occupato, Riciclo in corso o Arresto.</span><span class="sxs-lookup"><span data-stu-id="63d72-127">Load Balancer utilizes the guest agent inside the virtual machine, and then listens and responds with an HTTP 200 OK response only when the instance is in the Ready state (that is, not in another state such as Busy, Recycling, or Stopping).</span></span>

<span data-ttu-id="63d72-128">Per altre informazioni, vedere l'articolo relativo alla [configurazione di file di definizione del servizio (file csdef) per i probe di integrità](https://msdn.microsoft.com/library/azure/ee758710.aspx) oppure l'articolo [Introduzione alla creazione del servizio di bilanciamento del carico per Internet per i servizi cloud](load-balancer-get-started-internet-classic-cloud.md#check-load-balancer-health-status-for-cloud-services).</span><span class="sxs-lookup"><span data-stu-id="63d72-128">For more information, see [Configuring the service definition file (csdef) for health probes](https://msdn.microsoft.com/library/azure/ee758710.aspx) or [Get started creating an Internet-facing load balancer for cloud services](load-balancer-get-started-internet-classic-cloud.md#check-load-balancer-health-status-for-cloud-services).</span></span>

### <a name="what-makes-a-guest-agent-probe-mark-an-instance-as-unhealthy"></a><span data-ttu-id="63d72-129">Perché un probe dell'agente guest contrassegna un'istanza come non integra</span><span class="sxs-lookup"><span data-stu-id="63d72-129">What makes a guest agent probe mark an instance as unhealthy?</span></span>

<span data-ttu-id="63d72-130">Se l'agente guest non risponde con un messaggio HTTP 200 OK, il servizio di bilanciamento del carico contrassegna l'istanza che non risponde e arresta l'invio di traffico a tale istanza.</span><span class="sxs-lookup"><span data-stu-id="63d72-130">If the guest agent fails to respond with HTTP 200 OK, the load balancer marks the instance as unresponsive and stops sending traffic to that instance.</span></span> <span data-ttu-id="63d72-131">Il servizio di bilanciamento del carico continua a eseguire il ping dell'istanza.</span><span class="sxs-lookup"><span data-stu-id="63d72-131">The load balancer continues to ping the instance.</span></span> <span data-ttu-id="63d72-132">Se l'agente guest risponde con un messaggio HTTP 200, il servizio di bilanciamento del carico continua a inviare il traffico a tale istanza.</span><span class="sxs-lookup"><span data-stu-id="63d72-132">If the guest agent responds with an HTTP 200, the load balancer sends traffic to that instance again.</span></span>

<span data-ttu-id="63d72-133">Quando si usa un ruolo Web, il codice del sito Web in genere viene eseguito in w3wp.exe, che non è monitorato dall'infrastruttura di Azure o dall'agente guest.</span><span class="sxs-lookup"><span data-stu-id="63d72-133">When you use a web role, the website code typically runs in w3wp.exe, which is not monitored by the Azure fabric or guest agent.</span></span> <span data-ttu-id="63d72-134">Gli errori in w3wp.exe, ad esempio le risposte HTTP 500, non vengono quindi segnalati all'agente guest e il servizio di bilanciamento del carico non esclude l'istanza dalla rotazione.</span><span class="sxs-lookup"><span data-stu-id="63d72-134">This means that failures in w3wp.exe (for example, HTTP 500 responses) will not be reported to the guest agent, and the load balancer will not take that instance out of rotation.</span></span>

### <a name="http-custom-probe"></a><span data-ttu-id="63d72-135">Probe HTTP personalizzato</span><span class="sxs-lookup"><span data-stu-id="63d72-135">HTTP custom probe</span></span>

<span data-ttu-id="63d72-136">Il probe HTTP personalizzato del servizio di bilanciamento del carico esegue l'override del probe dell'agente guest predefinito e consente di creare una logica personalizzata per determinare l'integrità dell'istanza del ruolo.</span><span class="sxs-lookup"><span data-stu-id="63d72-136">The custom HTTP Load Balancer probe overrides the default guest agent probe, which means that you can create your own custom logic to determine the health of the role instance.</span></span> <span data-ttu-id="63d72-137">Per impostazione predefinita, il servizio di bilanciamento del carico esegue regolarmente probe sull'endpoint ogni 15 secondi.</span><span class="sxs-lookup"><span data-stu-id="63d72-137">The load balancer probes your endpoint every 15 seconds, by default.</span></span> <span data-ttu-id="63d72-138">L'istanza viene considerata in rotazione dal servizio di bilanciamento del carico nel caso di risposta con un messaggio HTTP 200 entro il periodo di timeout, ovvero 31 secondi per impostazione predefinita.</span><span class="sxs-lookup"><span data-stu-id="63d72-138">The instance is considered to be in the load balancer rotation if it responds with an HTTP 200 within the timeout period (31 seconds by default).</span></span>

<span data-ttu-id="63d72-139">Questa impostazione può essere utile se si vuole implementare la logica personalizzata per rimuovere le istanze dalla rotazione del servizio di bilanciamento del carico.</span><span class="sxs-lookup"><span data-stu-id="63d72-139">This can be useful if you want to implement your own logic to remove instances from load balancer rotation.</span></span> <span data-ttu-id="63d72-140">Ad esempio, è possibile decidere di rimuovere un'istanza se presenta oltre il 90% di utilizzo della CPU e restituisce uno stato diverso da 200.</span><span class="sxs-lookup"><span data-stu-id="63d72-140">For example, you could decide to remove an instance if it is above 90% CPU and returns a non-200 status.</span></span> <span data-ttu-id="63d72-141">Nel caso di ruoli Web che usano w3wp.exe si ottiene anche il monitoraggio automatico del sito Web, perché gli errori nel codice del sito Web restituiranno uno stato diverso da 200 al probe del servizio di bilanciamento del carico.</span><span class="sxs-lookup"><span data-stu-id="63d72-141">If you have web roles that use w3wp.exe, this also means you get automatic monitoring of your website, because failures in your website code will return a non-200 status to the load balancer probe.</span></span>

> [!NOTE]
> <span data-ttu-id="63d72-142">Il probe HTTP personalizzato supporta solo percorsi relativi e il protocollo HTTP.</span><span class="sxs-lookup"><span data-stu-id="63d72-142">The HTTP custom probe supports relative paths and HTTP protocol only.</span></span> <span data-ttu-id="63d72-143">HTTPS non è supportato.</span><span class="sxs-lookup"><span data-stu-id="63d72-143">HTTPS is not supported.</span></span>

### <a name="what-makes-an-http-custom-probe-mark-an-instance-as-unhealthy"></a><span data-ttu-id="63d72-144">Perché un probe HTTP personalizzato contrassegna un'istanza come non integra</span><span class="sxs-lookup"><span data-stu-id="63d72-144">What makes an HTTP custom probe mark an instance as unhealthy?</span></span>

* <span data-ttu-id="63d72-145">L'applicazione HTTP restituisce un codice di risposta HTTP diverso da 200, ad esempio 403, 404 o 500.</span><span class="sxs-lookup"><span data-stu-id="63d72-145">The HTTP application returns an HTTP response code other than 200 (for example, 403, 404, or 500).</span></span> <span data-ttu-id="63d72-146">Si tratta di un acknowledgment positivo per indicare che l'istanza dell'applicazione deve essere esclusa immediatamente dal servizio.</span><span class="sxs-lookup"><span data-stu-id="63d72-146">This is a positive acknowledgment that the application instance should be taken out of service right away.</span></span>
* <span data-ttu-id="63d72-147">Il server HTTP non invia alcuna risposta dopo il periodo di timeout.</span><span class="sxs-lookup"><span data-stu-id="63d72-147">The HTTP server does not respond at all after the timeout period.</span></span> <span data-ttu-id="63d72-148">A seconda del valore di timeout impostato, questo può significare che più richieste di probe non riceveranno risposta prima che il probe venga contrassegnato come non in esecuzione, vale a dire prima dell'invio di probe SuccessFailCount.</span><span class="sxs-lookup"><span data-stu-id="63d72-148">Depending on the timeout value that is set, this might mean that multiple probe requests go unanswered before the probe gets marked as not running (that is, before SuccessFailCount probes are sent).</span></span>
* <span data-ttu-id="63d72-149">Il server chiude la connessione tramite l'invio di TCP Reset.</span><span class="sxs-lookup"><span data-stu-id="63d72-149">The server closes the connection via a TCP reset.</span></span>

### <a name="tcp-custom-probe"></a><span data-ttu-id="63d72-150">Probe TCP personalizzato</span><span class="sxs-lookup"><span data-stu-id="63d72-150">TCP custom probe</span></span>

<span data-ttu-id="63d72-151">I probe TCP avviano una connessione tramite l'esecuzione di un handshake a tre livelli con la porta definita.</span><span class="sxs-lookup"><span data-stu-id="63d72-151">TCP probes initiate a connection by performing a three-way handshake with the defined port.</span></span>

### <a name="what-makes-a-tcp-custom-probe-mark-an-instance-as-unhealthy"></a><span data-ttu-id="63d72-152">Perché un probe TCP personalizzato contrassegna un'istanza come non integra</span><span class="sxs-lookup"><span data-stu-id="63d72-152">What makes a TCP custom probe mark an instance as unhealthy?</span></span>

* <span data-ttu-id="63d72-153">Il server TCP non invia alcuna risposta dopo il periodo di timeout.</span><span class="sxs-lookup"><span data-stu-id="63d72-153">The TCP server does not respond at all after the timeout period.</span></span> <span data-ttu-id="63d72-154">Il probe viene contrassegnato come non in esecuzione in base alla configurazione del numero di richieste di probe non riuscite che possono rimanere senza risposta prima che il probe sia contrassegnato come non in esecuzione.</span><span class="sxs-lookup"><span data-stu-id="63d72-154">When the probe is marked as not running depends on the number of failed probe requests that were configured to go unanswered before marking the probe as not running.</span></span>
* <span data-ttu-id="63d72-155">Il probe riceve un TCP Reset dall'istanza del ruolo.</span><span class="sxs-lookup"><span data-stu-id="63d72-155">The probe receives a TCP reset from the role instance.</span></span>

<span data-ttu-id="63d72-156">Per altre informazioni sulla configurazione di un probe di integrità HTTP o di un probe TCP, vedere [Introduzione alla creazione di un servizio di bilanciamento del carico per Internet in Gestione risorse con PowerShell](load-balancer-get-started-internet-arm-ps.md).</span><span class="sxs-lookup"><span data-stu-id="63d72-156">For more information about configuring an HTTP health probe or a TCP probe, see [Get started creating an Internet-facing load balancer in Resource Manager using PowerShell](load-balancer-get-started-internet-arm-ps.md).</span></span>

## <a name="add-healthy-instances-back-into-load-balancer-rotation"></a><span data-ttu-id="63d72-157">Aggiungere di nuovo le istanze integre alla rotazione del servizio di bilanciamento del carico</span><span class="sxs-lookup"><span data-stu-id="63d72-157">Add healthy instances back into load balancer rotation</span></span>

<span data-ttu-id="63d72-158">I probe TCP e HTTP sono considerati integri e contrassegnano come integra l'istanza del ruolo quando:</span><span class="sxs-lookup"><span data-stu-id="63d72-158">TCP and HTTP probes are considered healthy and mark the role instance as healthy when:</span></span>

* <span data-ttu-id="63d72-159">Il servizio di bilanciamento del carico ottiene un probe positivo al primo avvio della macchina virtuale.</span><span class="sxs-lookup"><span data-stu-id="63d72-159">The load balancer gets a positive probe the first time the VM boots.</span></span>
* <span data-ttu-id="63d72-160">Il numero di SuccessFailCount, descritto in precedenza, definisce il valore dei probe riusciti necessario per contrassegnare l'istanza del ruolo come integra.</span><span class="sxs-lookup"><span data-stu-id="63d72-160">The number SuccessFailCount (described earlier) defines the value of successful probes that are required to mark the role instance as healthy.</span></span> <span data-ttu-id="63d72-161">Se un'istanza del ruolo è stata rimossa, il numero di probe successivi riusciti deve essere uguale o maggiore del valore di SuccessFailCount per contrassegnare l'istanza del ruolo come in esecuzione.</span><span class="sxs-lookup"><span data-stu-id="63d72-161">If a role instance was removed, the number of successful, successive probes must equal or exceed the value of SuccessFailCount to mark the role instance as running.</span></span>

> [!NOTE]
> <span data-ttu-id="63d72-162">Se l'integrità di un'istanza del ruolo varia, il servizio di bilanciamento del carico rimane in attesa più a lungo prima di ripristinarne lo stato di integrità.</span><span class="sxs-lookup"><span data-stu-id="63d72-162">If the health of a role instance is fluctuating, the load balancer waits longer before putting the role instance back in the healthy state.</span></span> <span data-ttu-id="63d72-163">Questa operazione viene eseguita tramite i criteri per la protezione dell'utente e dell'infrastruttura.</span><span class="sxs-lookup"><span data-stu-id="63d72-163">This is done via policy to protect the user and the infrastructure.</span></span>

## <a name="use-log-analytics-for-load-balancer"></a><span data-ttu-id="63d72-164">Usare Analisi dei log per il servizio di bilanciamento del carico</span><span class="sxs-lookup"><span data-stu-id="63d72-164">Use log analytics for Load Balancer</span></span>

<span data-ttu-id="63d72-165">È possibile usare [Analisi dei log per il servizio di bilanciamento del carico](load-balancer-monitor-log.md) per verificare lo stato di integrità e il conteggio dei probe.</span><span class="sxs-lookup"><span data-stu-id="63d72-165">You can use [log analytics for Load Balancer](load-balancer-monitor-log.md) to check on the probe health status and probe count.</span></span> <span data-ttu-id="63d72-166">Per fornire statistiche dello stato di integrità del servizio di bilanciamento del carico, è possibile usare la registrazione con Power BI o con Operational Insights.</span><span class="sxs-lookup"><span data-stu-id="63d72-166">Logging can be used with Power BI or Azure Operational Insights to provide statistics about Load Balancer health status.</span></span>
