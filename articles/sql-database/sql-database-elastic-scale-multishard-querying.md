---
title: database SQL di Azure partizionati aaaQuery | Documenti Microsoft
description: Eseguire query tra partizioni utilizzando hello libreria client di database elastico.
services: sql-database
documentationcenter: 
manager: jhubbard
author: torsteng
editor: 
ms.assetid: a4379c15-f213-4026-ab6f-a450ee9d5758
ms.service: sql-database
ms.custom: scale out apps
ms.workload: sql-database
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 04/12/2016
ms.author: torsteng
ms.openlocfilehash: a1f0763935a6807b74aa9dec477714e8d117417d
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 10/06/2017
---
# <a name="multi-shard-querying"></a><span data-ttu-id="74ea1-103">Esecuzione di query su più partizioni</span><span class="sxs-lookup"><span data-stu-id="74ea1-103">Multi-shard querying</span></span>
## <a name="overview"></a><span data-ttu-id="74ea1-104">Panoramica</span><span class="sxs-lookup"><span data-stu-id="74ea1-104">Overview</span></span>
<span data-ttu-id="74ea1-105">Con hello [strumenti di Database elastico](sql-database-elastic-scale-introduction.md), è possibile creare soluzioni di database partizionato.</span><span class="sxs-lookup"><span data-stu-id="74ea1-105">With hello [Elastic Database tools](sql-database-elastic-scale-introduction.md), you can create sharded database solutions.</span></span> <span data-ttu-id="74ea1-106">La funzionalità di **query su più partizioni** viene usata per attività che richiedono l'esecuzione di una query su più partizioni, ad esempio la raccolta o la creazione di report sui dati,</span><span class="sxs-lookup"><span data-stu-id="74ea1-106">**Multi-shard querying** is used for tasks such as data collection/reporting that require running a query that stretches across several shards.</span></span> <span data-ttu-id="74ea1-107">(Per ovviare a questo troppo[routing dipendente dai dati](sql-database-elastic-scale-data-dependent-routing.md), che esegue tutte le operazioni in una singola partizione.)</span><span class="sxs-lookup"><span data-stu-id="74ea1-107">(Contrast this too[data-dependent routing](sql-database-elastic-scale-data-dependent-routing.md), which performs all work on a single shard.)</span></span> 

1. <span data-ttu-id="74ea1-108">Ottenere un [ **RangeShardMap** ](https://msdn.microsoft.com/library/azure/dn807318.aspx) o [ **ListShardMap** ](https://msdn.microsoft.com/library/azure/dn807370.aspx) utilizzando hello [ **TryGetRangeShardMap** ](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.trygetrangeshardmap.aspx), hello [ **TryGetListShardMap**](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.trygetlistshardmap.aspx), o hello [ **GetShardMap** ](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getshardmap.aspx) metodo.</span><span class="sxs-lookup"><span data-stu-id="74ea1-108">Get a [**RangeShardMap**](https://msdn.microsoft.com/library/azure/dn807318.aspx) or [**ListShardMap**](https://msdn.microsoft.com/library/azure/dn807370.aspx) using hello [**TryGetRangeShardMap**](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.trygetrangeshardmap.aspx), hello [**TryGetListShardMap**](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.trygetlistshardmap.aspx), or hello [**GetShardMap**](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.shardmanagement.shardmapmanager.getshardmap.aspx) method.</span></span> <span data-ttu-id="74ea1-109">Vedere [**Creazione di un oggetto ShardMapManager**](sql-database-elastic-scale-shard-map-management.md#constructing-a-shardmapmanager) e [**Ottenere una mappa RangeShardMap o ListShardMap**](sql-database-elastic-scale-shard-map-management.md#get-a-rangeshardmap-or-listshardmap).</span><span class="sxs-lookup"><span data-stu-id="74ea1-109">See [**Constructing a ShardMapManager**](sql-database-elastic-scale-shard-map-management.md#constructing-a-shardmapmanager) and [**Get a RangeShardMap or ListShardMap**](sql-database-elastic-scale-shard-map-management.md#get-a-rangeshardmap-or-listshardmap).</span></span>
2. <span data-ttu-id="74ea1-110">Creare un oggetto **[MultiShardConnection](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardconnection.aspx)**.</span><span class="sxs-lookup"><span data-stu-id="74ea1-110">Create a **[MultiShardConnection](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardconnection.aspx)** object.</span></span>
3. <span data-ttu-id="74ea1-111">Creare un **[MultiShardCommand](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.aspx)**.</span><span class="sxs-lookup"><span data-stu-id="74ea1-111">Create a **[MultiShardCommand](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.aspx)**.</span></span> 
4. <span data-ttu-id="74ea1-112">Set hello  **[proprietà CommandText](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.commandtext.aspx#P:Microsoft.Azure.SqlDatabase.ElasticScale.Query.MultiShardCommand.CommandText)**  tooa comando T-SQL.</span><span class="sxs-lookup"><span data-stu-id="74ea1-112">Set hello **[CommandText property](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.commandtext.aspx#P:Microsoft.Azure.SqlDatabase.ElasticScale.Query.MultiShardCommand.CommandText)** tooa T-SQL command.</span></span>
5. <span data-ttu-id="74ea1-113">Eseguire il comando hello dal chiamante hello  **[metodo ExecuteReader](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.executereader.aspx)**.</span><span class="sxs-lookup"><span data-stu-id="74ea1-113">Execute hello command by calling hello **[ExecuteReader method](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multishardcommand.executereader.aspx)**.</span></span>
6. <span data-ttu-id="74ea1-114">Visualizzare i risultati di hello utilizzando hello  **[MultiShardDataReader classe](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multisharddatareader.aspx)**.</span><span class="sxs-lookup"><span data-stu-id="74ea1-114">View hello results using hello **[MultiShardDataReader class](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.multisharddatareader.aspx)**.</span></span> 

## <a name="example"></a><span data-ttu-id="74ea1-115">Esempio</span><span class="sxs-lookup"><span data-stu-id="74ea1-115">Example</span></span>
<span data-ttu-id="74ea1-116">Hello codice riportato di seguito viene illustrato hello utilizzo di più partizioni, esecuzione di query utilizzando un determinato **ShardMap** denominato *myShardMap*.</span><span class="sxs-lookup"><span data-stu-id="74ea1-116">hello following code illustrates hello usage of multi-shard querying using a given **ShardMap** named *myShardMap*.</span></span> 

    using (MultiShardConnection conn = new MultiShardConnection( 
                                        myShardMap.GetShards(), 
                                        myShardConnectionString) 
          ) 
    { 
    using (MultiShardCommand cmd = conn.CreateCommand())
           { 
            cmd.CommandText = "SELECT c1, c2, c3 FROM ShardedTable"; 
            cmd.CommandType = CommandType.Text; 
            cmd.ExecutionOptions = MultiShardExecutionOptions.IncludeShardNameColumn; 
            cmd.ExecutionPolicy = MultiShardExecutionPolicy.PartialResults; 

            using (MultiShardDataReader sdr = cmd.ExecuteReader()) 
                { 
                    while (sdr.Read())
                        { 
                            var c1Field = sdr.GetString(0); 
                            var c2Field = sdr.GetFieldValue<int>(1); 
                            var c3Field = sdr.GetFieldValue<Int64>(2);
                        } 
                 } 
           } 
    } 


<span data-ttu-id="74ea1-117">Una differenza principale è la costruzione di hello di connessioni a più partizioni.</span><span class="sxs-lookup"><span data-stu-id="74ea1-117">A key difference is hello construction of multi-shard connections.</span></span> <span data-ttu-id="74ea1-118">Dove **SqlConnection** opera su un singolo database, hello **MultiShardConnection** accetta un ***raccolta di partizioni*** come input.</span><span class="sxs-lookup"><span data-stu-id="74ea1-118">Where **SqlConnection** operates on a single database, hello **MultiShardConnection** takes a ***collection of shards*** as its input.</span></span> <span data-ttu-id="74ea1-119">Popolare la raccolta di hello di partizioni da una mappa partizioni.</span><span class="sxs-lookup"><span data-stu-id="74ea1-119">Populate hello collection of shards from a shard map.</span></span> <span data-ttu-id="74ea1-120">query Hello viene quindi eseguita sull'insieme di hello di partizioni utilizzando **UNION ALL** semantica tooassemble un singolo risultato complessivo.</span><span class="sxs-lookup"><span data-stu-id="74ea1-120">hello query is then executed on hello collection of shards using **UNION ALL** semantics tooassemble a single overall result.</span></span> <span data-ttu-id="74ea1-121">Facoltativamente, nome hello della partizione hello in riga hello ha avuto origine è possibile aggiungere l'output utilizzando hello toohello **ExecutionOptions** proprietà nel comando.</span><span class="sxs-lookup"><span data-stu-id="74ea1-121">Optionally, hello name of hello shard where hello row originates from can be added toohello output using hello **ExecutionOptions** property on command.</span></span> 

<span data-ttu-id="74ea1-122">Si noti la chiamata hello troppo**myShardMap.GetShards()**.</span><span class="sxs-lookup"><span data-stu-id="74ea1-122">Note hello call too**myShardMap.GetShards()**.</span></span> <span data-ttu-id="74ea1-123">Questo metodo recupera tutte le partizioni dalla mappa partizioni hello e fornisce un modo semplice di toorun una query in tutti i database rilevanti.</span><span class="sxs-lookup"><span data-stu-id="74ea1-123">This method retrieves all shards from hello shard map and provides an easy way toorun a query across all relevant databases.</span></span> <span data-ttu-id="74ea1-124">Hello raccolta di partizioni per una query su più partizioni può essere suddivise ulteriormente eseguendo un LINQ query su hello raccolta restituita dalla chiamata di hello troppo**myShardMap.GetShards()**.</span><span class="sxs-lookup"><span data-stu-id="74ea1-124">hello collection of shards for a multi-shard query can be refined further by performing a LINQ query over hello collection returned from hello call too**myShardMap.GetShards()**.</span></span> <span data-ttu-id="74ea1-125">In combinazione con criteri di risultati parziali hello, funzionalità di hello corrente di query su più partizioni è stato progettato toowork per decine di toohundreds di partizioni.</span><span class="sxs-lookup"><span data-stu-id="74ea1-125">In combination with hello partial results policy, hello current capability in multi-shard querying has been designed toowork well for tens up toohundreds of shards.</span></span>

<span data-ttu-id="74ea1-126">Una limitazione con più partizioni di una query è attualmente la mancanza di hello di convalida per le partizioni e shardlet che viene eseguita una query.</span><span class="sxs-lookup"><span data-stu-id="74ea1-126">A limitation with multi-shard querying is currently hello lack of validation for shards and shardlets that are queried.</span></span> <span data-ttu-id="74ea1-127">Mentre il routing dipendente dai dati verifica che una determinata partizione fa parte di mappa partizioni hello in fase di esecuzione di query di hello, le query più partizioni non eseguono questo controllo.</span><span class="sxs-lookup"><span data-stu-id="74ea1-127">While data-dependent routing verifies that a given shard is part of hello shard map at hello time of querying, multi-shard queries do not perform this check.</span></span> <span data-ttu-id="74ea1-128">Questo può causare query toomulti partizioni in esecuzione nel database che sono state rimosse dalla mappa partizioni hello.</span><span class="sxs-lookup"><span data-stu-id="74ea1-128">This can lead toomulti-shard queries running on databases that have  been removed from hello shard map.</span></span>

## <a name="multi-shard-queries-and-split-merge-operations"></a><span data-ttu-id="74ea1-129">Query su più partizioni e operazioni di suddivisione e unione</span><span class="sxs-lookup"><span data-stu-id="74ea1-129">Multi-shard queries and split-merge operations</span></span>
<span data-ttu-id="74ea1-130">Le query più partizioni non verificano se gli shardlet nel database sottoposto a query hello partecipano in corso operazioni di unione di menu combinato.</span><span class="sxs-lookup"><span data-stu-id="74ea1-130">Multi-shard queries do not verify whether shardlets on hello queried database are participating in ongoing split-merge operations.</span></span> <span data-ttu-id="74ea1-131">(Vedere [scala utilizzando lo strumento di unione di Database elastico split hello](sql-database-elastic-scale-overview-split-and-merge.md).) Questo può causare in cui le righe da hello stessa presentazione di shardlet per più database in hello tooinconsistencies stessa query su più partizioni.</span><span class="sxs-lookup"><span data-stu-id="74ea1-131">(See [Scaling using hello Elastic Database split-merge tool](sql-database-elastic-scale-overview-split-and-merge.md).) This can lead tooinconsistencies where rows from hello same shardlet show for multiple databases in hello same multi-shard query.</span></span> <span data-ttu-id="74ea1-132">Tenere presenti queste limitazioni e considerare svuotamento in corso suddivisione unione operazioni e le modifiche toohello mappa partizioni durante l'esecuzione di query su più partizioni.</span><span class="sxs-lookup"><span data-stu-id="74ea1-132">Be aware of these limitations and consider draining ongoing split-merge operations and changes toohello shard map while performing multi-shard queries.</span></span>

[!INCLUDE [elastic-scale-include](../../includes/elastic-scale-include.md)]

## <a name="see-also"></a><span data-ttu-id="74ea1-133">Vedere anche</span><span class="sxs-lookup"><span data-stu-id="74ea1-133">See also</span></span>
<span data-ttu-id="74ea1-134">Classi e metodi **[System.Data.SqlClient](http://msdn.microsoft.com/library/System.Data.SqlClient.aspx)**.</span><span class="sxs-lookup"><span data-stu-id="74ea1-134">**[System.Data.SqlClient](http://msdn.microsoft.com/library/System.Data.SqlClient.aspx)** classes and methods.</span></span>

<span data-ttu-id="74ea1-135">Gestire le partizioni utilizzando hello [libreria client di Database elastico](sql-database-elastic-database-client-library.md).</span><span class="sxs-lookup"><span data-stu-id="74ea1-135">Manage shards using hello [Elastic Database client library](sql-database-elastic-database-client-library.md).</span></span> <span data-ttu-id="74ea1-136">Include uno spazio dei nomi denominato [Microsoft.Azure.SqlDatabase.ElasticScale.Query](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.aspx) tooquery possibilità hello che fornisce più partizioni, utilizzando una singola query e risultati.</span><span class="sxs-lookup"><span data-stu-id="74ea1-136">Includes a  namespace called [Microsoft.Azure.SqlDatabase.ElasticScale.Query](https://msdn.microsoft.com/library/azure/microsoft.azure.sqldatabase.elasticscale.query.aspx) that provides hello ability tooquery multiple shards using a single query and result.</span></span> <span data-ttu-id="74ea1-137">Fornisce l'astrazione delle query su una raccolta di partizioni,</span><span class="sxs-lookup"><span data-stu-id="74ea1-137">It provides a querying abstraction over a collection of shards.</span></span> <span data-ttu-id="74ea1-138">Fornisce inoltre criteri di esecuzione alternativo, risultati parziali in particolare, toodeal con errori quando si eseguono query su molte partizioni.</span><span class="sxs-lookup"><span data-stu-id="74ea1-138">It also provides alternative execution policies, in particular partial results, toodeal with failures when querying over many shards.</span></span>  

