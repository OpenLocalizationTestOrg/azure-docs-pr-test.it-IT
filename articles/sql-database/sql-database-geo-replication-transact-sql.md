---
title: Configurare la replica geografica per il database SQL di Azure con Transact-SQL | Microsoft Docs
description: Configurare la replica geografica per il database SQL di Azure con Transact-SQL
services: sql-database
documentationcenter: 
author: CarlRabeler
manager: jhubbard
editor: 
ms.assetid: d94d89a6-3234-46c5-8279-5eb8daad10ac
ms.service: sql-database
ms.custom: business continuity
ms.devlang: NA
ms.topic: article
ms.tgt_pltfrm: NA
ms.workload: NA
ms.date: 04/14/2017
ms.author: carlrab
ms.openlocfilehash: e5011c1c67e051616d53621b72e46ba894ca3c02
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 07/11/2017
---
# <a name="configure-active-geo-replication-for-azure-sql-database-with-transact-sql"></a><span data-ttu-id="a0bab-103">Configurare la replica geografica attiva per il database SQL di Azure con Transact-SQL</span><span class="sxs-lookup"><span data-stu-id="a0bab-103">Configure active geo-replication for Azure SQL Database with Transact-SQL</span></span>

<span data-ttu-id="a0bab-104">Questo articolo illustra come configurare la replica geografica attiva per un database SQL di Azure con Transact-SQL.</span><span class="sxs-lookup"><span data-stu-id="a0bab-104">This article shows you how to configure active geo-replication for an Azure SQL Database with Transact-SQL.</span></span>

<span data-ttu-id="a0bab-105">Per avviare il failover usando Transact-SQL, vedere [Avviare un failover pianificato o non pianificato per il database SQL di Azure con Transact-SQL](sql-database-geo-replication-failover-transact-sql.md).</span><span class="sxs-lookup"><span data-stu-id="a0bab-105">To initiate failover using Transact-SQL, see [Initiate a planned or unplanned failover for Azure SQL Database with Transact-SQL](sql-database-geo-replication-failover-transact-sql.md).</span></span>

> [!NOTE]
> <span data-ttu-id="a0bab-106">Quando si usa la replica geografica attiva (database secondari leggibili) per il ripristino di emergenza è necessario configurare un gruppo di failover per tutti i database all'interno di un'applicazione per consentire il failover automatico e trasparente.</span><span class="sxs-lookup"><span data-stu-id="a0bab-106">When you use active geo-replication (readable secondaries) for disaster recovery you should configure a failover group for all databases within an application to enable automatic and transparent failover.</span></span> <span data-ttu-id="a0bab-107">Questa funzionalità è in anteprima.</span><span class="sxs-lookup"><span data-stu-id="a0bab-107">This feature is in preview.</span></span> <span data-ttu-id="a0bab-108">Per altre informazioni vedere [Panoramica: Replica geografica attiva per il database SQL di Azure](sql-database-geo-replication-overview.md).</span><span class="sxs-lookup"><span data-stu-id="a0bab-108">For more information see [Auto-failover groups and geo-replication](sql-database-geo-replication-overview.md).</span></span>
> 
> 

<span data-ttu-id="a0bab-109">Per configurare la replica geografica attiva con Transact-SQL, sono necessari gli elementi seguenti:</span><span class="sxs-lookup"><span data-stu-id="a0bab-109">To configure active geo-replication using Transact-SQL, you need the following:</span></span>

* <span data-ttu-id="a0bab-110">Una sottoscrizione di Azure.</span><span class="sxs-lookup"><span data-stu-id="a0bab-110">An Azure subscription</span></span>
* <span data-ttu-id="a0bab-111">Un server di database SQL di Azure logico <MyLocalServer> e un database SQL <MyDB>: il database primario che si vuole replicare</span><span class="sxs-lookup"><span data-stu-id="a0bab-111">A logical Azure SQL Database server <MyLocalServer> and a SQL database <MyDB> - The primary database that you want to replicate</span></span>
* <span data-ttu-id="a0bab-112">Uno o più server di database SQL di Azure logici <MySecondaryServer(n)>: i server logici saranno i server partner in cui verranno creati i database secondari</span><span class="sxs-lookup"><span data-stu-id="a0bab-112">One or more logical Azure SQL Database servers <MySecondaryServer(n)> - The logical servers that will be the partner servers in which you will create secondary databases</span></span>
* <span data-ttu-id="a0bab-113">Un account di accesso DBManager nel server primario</span><span class="sxs-lookup"><span data-stu-id="a0bab-113">A login that is DBManager on the primary</span></span>
* <span data-ttu-id="a0bab-114">Avere db_ownership del database locale di cui eseguire la replica geografica</span><span class="sxs-lookup"><span data-stu-id="a0bab-114">Have db_ownership of the local database that you will geo-replicate</span></span>
* <span data-ttu-id="a0bab-115">Essere DBManager nel server partner verso cui si configurerà la replica geografica</span><span class="sxs-lookup"><span data-stu-id="a0bab-115">Be DBManager on the partner server(s) to which you will configure geo-replication</span></span>
* <span data-ttu-id="a0bab-116">La versione più recente di SQL Server Management Studio (SSMS)</span><span class="sxs-lookup"><span data-stu-id="a0bab-116">The newest version of SQL Server Management Studio (SSMS)</span></span>

> [!IMPORTANT]
> <span data-ttu-id="a0bab-117">È consigliabile usare sempre la versione più aggiornata di Management Studio per restare sincronizzati con gli aggiornamenti di Microsoft Azure e del database SQL.</span><span class="sxs-lookup"><span data-stu-id="a0bab-117">It is recommended that you always use the latest version of Management Studio to remain synchronized with updates to Microsoft Azure and SQL Database.</span></span> <span data-ttu-id="a0bab-118">[Aggiornare SQL Server Management Studio](https://msdn.microsoft.com/library/mt238290.aspx).</span><span class="sxs-lookup"><span data-stu-id="a0bab-118">[Update SQL Server Management Studio](https://msdn.microsoft.com/library/mt238290.aspx).</span></span>
> 
> 

## <a name="add-secondary-database"></a><span data-ttu-id="a0bab-119">Aggiungere un database secondario</span><span class="sxs-lookup"><span data-stu-id="a0bab-119">Add secondary database</span></span>
<span data-ttu-id="a0bab-120">È possibile usare l'istruzione **ALTER DATABASE** per creare un database secondario in un server partner.</span><span class="sxs-lookup"><span data-stu-id="a0bab-120">You can use the **ALTER DATABASE** statement to create a geo-replicated secondary database on a partner server.</span></span> <span data-ttu-id="a0bab-121">Eseguire questa istruzione sul database master del server che contiene il database da replicare.</span><span class="sxs-lookup"><span data-stu-id="a0bab-121">You execute this statement on the master database of the server containing the database to be replicated.</span></span> <span data-ttu-id="a0bab-122">Il database con replica geografica, ovvero il "database primario", avrà lo stesso nome del database che viene replicato e, per impostazione predefinita, lo stesso livello di servizio del database primario.</span><span class="sxs-lookup"><span data-stu-id="a0bab-122">The geo-replicated database (the "primary database") will have the same name as the database being replicated and will, by default, have the same service level as the primary database.</span></span> <span data-ttu-id="a0bab-123">Il database secondario può essere leggibile o non leggibile e può essere un database singolo o in un pool elastico.</span><span class="sxs-lookup"><span data-stu-id="a0bab-123">The secondary database can be readable or non-readable, and can be a single database or in an elastic pool.</span></span> <span data-ttu-id="a0bab-124">Per altre informazioni, vedere [ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/mt574871.aspx) e [Livelli di servizio](sql-database-service-tiers.md).</span><span class="sxs-lookup"><span data-stu-id="a0bab-124">For more information, see [ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/mt574871.aspx) and [Service Tiers](sql-database-service-tiers.md).</span></span>
<span data-ttu-id="a0bab-125">Dopo la creazione e il seeding del database secondario, inizierà la replica asincrona dei dati dal database primario.</span><span class="sxs-lookup"><span data-stu-id="a0bab-125">After the secondary database is created and seeded, data will begin replicating asynchronously from the primary database.</span></span> <span data-ttu-id="a0bab-126">I passaggi seguenti descrivono come configurare la replica geografica tramite Management Studio.</span><span class="sxs-lookup"><span data-stu-id="a0bab-126">The steps below describe how to configure geo-replication using Management Studio.</span></span> <span data-ttu-id="a0bab-127">Vengono descritte le procedure per creare database secondari leggibili o non leggibili, come database singoli o in un pool elastico.</span><span class="sxs-lookup"><span data-stu-id="a0bab-127">Steps to create non-readable and readable secondaries, either as a single database or in an elastic pool, are provided.</span></span>

> [!NOTE]
> <span data-ttu-id="a0bab-128">Se nel server partner specificato è presente un database con lo stesso nome del database primario, il comando avrà esito negativo.</span><span class="sxs-lookup"><span data-stu-id="a0bab-128">If a database exists on the specified partner server with the same name as the primary database the command will fail.</span></span>
> 

### <a name="add-readable-secondary-single-database"></a><span data-ttu-id="a0bab-129">Aggiungere un database secondario accessibile in lettura (database singolo)</span><span class="sxs-lookup"><span data-stu-id="a0bab-129">Add readable secondary (single database)</span></span>
<span data-ttu-id="a0bab-130">Usare la procedura seguente per creare un database secondario accessibile in lettura come database singolo.</span><span class="sxs-lookup"><span data-stu-id="a0bab-130">Use the following steps to create a readable secondary as a single database.</span></span>

1. <span data-ttu-id="a0bab-131">In Management Studio connettersi al server logico di database SQL di Azure.</span><span class="sxs-lookup"><span data-stu-id="a0bab-131">In Management Studio, connect to your Azure SQL Database logical server.</span></span>
2. <span data-ttu-id="a0bab-132">Aprire la cartella Database, espandere la cartella **Database di sistema**, fare clic con il pulsante destro del mouse su **master** e quindi scegliere **Nuova query**.</span><span class="sxs-lookup"><span data-stu-id="a0bab-132">Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.</span></span>
3. <span data-ttu-id="a0bab-133">Usare l'istruzione **ALTER DATABASE** seguente per convertire un database locale in un database primario con replica geografica con un database secondario accessibile in lettura in un server secondario.</span><span class="sxs-lookup"><span data-stu-id="a0bab-133">Use the following **ALTER DATABASE** statement to make a local database into a geo-replication primary with a readable secondary database on a secondary server.</span></span>
   
        ALTER DATABASE <MyDB>
           ADD SECONDARY ON SERVER <MySecondaryServer2> WITH (ALLOW_CONNECTIONS = ALL);
4. <span data-ttu-id="a0bab-134">Fare clic su **Execute** per eseguire la query.</span><span class="sxs-lookup"><span data-stu-id="a0bab-134">Click **Execute** to run the query.</span></span>

### <a name="add-readable-secondary-elastic-pool"></a><span data-ttu-id="a0bab-135">Aggiungere un database secondario leggibile (pool elastico)</span><span class="sxs-lookup"><span data-stu-id="a0bab-135">Add readable secondary (elastic pool)</span></span>
<span data-ttu-id="a0bab-136">Usare la procedura seguente per creare un database secondario leggibile in un pool elastico.</span><span class="sxs-lookup"><span data-stu-id="a0bab-136">Use the following steps to create a readable secondary in an elastic pool.</span></span>

1. <span data-ttu-id="a0bab-137">In Management Studio connettersi al server logico di database SQL di Azure.</span><span class="sxs-lookup"><span data-stu-id="a0bab-137">In Management Studio, connect to your Azure SQL Database logical server.</span></span>
2. <span data-ttu-id="a0bab-138">Aprire la cartella Database, espandere la cartella **Database di sistema**, fare clic con il pulsante destro del mouse su **master** e quindi scegliere **Nuova query**.</span><span class="sxs-lookup"><span data-stu-id="a0bab-138">Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.</span></span>
3. <span data-ttu-id="a0bab-139">Usare l'istruzione **ALTER DATABASE** seguente per convertire un database locale in un database primario con replica geografica con un database secondario accessibile in lettura in un server secondario in un pool elastico.</span><span class="sxs-lookup"><span data-stu-id="a0bab-139">Use the following **ALTER DATABASE** statement to make a local database into a geo-replication primary with a readable secondary database on a secondary server in an elastic pool.</span></span>
   
        ALTER DATABASE <MyDB>
           ADD SECONDARY ON SERVER <MySecondaryServer4> WITH (ALLOW_CONNECTIONS = ALL
           , SERVICE_OBJECTIVE = ELASTIC_POOL (name = MyElasticPool2));
4. <span data-ttu-id="a0bab-140">Fare clic su **Execute** per eseguire la query.</span><span class="sxs-lookup"><span data-stu-id="a0bab-140">Click **Execute** to run the query.</span></span>

## <a name="remove-secondary-database"></a><span data-ttu-id="a0bab-141">Rimuovere un database secondario</span><span class="sxs-lookup"><span data-stu-id="a0bab-141">Remove secondary database</span></span>
<span data-ttu-id="a0bab-142">È possibile usare l'istruzione **ALTER DATABASE** per terminare definitivamente la relazione di replica tra un database secondario e il relativo database primario.</span><span class="sxs-lookup"><span data-stu-id="a0bab-142">You can use the **ALTER DATABASE** statement to permanently terminate the replication partnership between a secondary database and its primary.</span></span> <span data-ttu-id="a0bab-143">L'istruzione viene eseguita sul database master in cui risiede il database primario.</span><span class="sxs-lookup"><span data-stu-id="a0bab-143">This statement is executed on the master database on which the primary database resides.</span></span> <span data-ttu-id="a0bab-144">Dopo la terminazione della relazione, il database secondario diventa un normale database accessibile in lettura e scrittura.</span><span class="sxs-lookup"><span data-stu-id="a0bab-144">After the relationship termination, the secondary database becomes a regular read-write database.</span></span> <span data-ttu-id="a0bab-145">Se la connettività al database secondario viene interrotta, il comando riesce ma il database diventerà di nuovo accessibile in lettura e scrittura al ripristino della connettività.</span><span class="sxs-lookup"><span data-stu-id="a0bab-145">If the connectivity to secondary database is broken the command succeeds but the secondary will become read-write after connectivity is restored.</span></span> <span data-ttu-id="a0bab-146">Per altre informazioni, vedere [ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/mt574871.aspx) e [Livelli di servizio](sql-database-service-tiers.md).</span><span class="sxs-lookup"><span data-stu-id="a0bab-146">For more information, see [ALTER DATABASE (Transact-SQL)](https://msdn.microsoft.com/library/mt574871.aspx) and [Service Tiers](sql-database-service-tiers.md).</span></span>

<span data-ttu-id="a0bab-147">Usare la procedura seguente per rimuovere il database secondario con replica geografica da una relazione di replica geografica.</span><span class="sxs-lookup"><span data-stu-id="a0bab-147">Use the following steps to remove geo-replicated secondary from a geo-replication partnership.</span></span>

1. <span data-ttu-id="a0bab-148">In Management Studio connettersi al server logico di database SQL di Azure.</span><span class="sxs-lookup"><span data-stu-id="a0bab-148">In Management Studio, connect to your Azure SQL Database logical server.</span></span>
2. <span data-ttu-id="a0bab-149">Aprire la cartella Database, espandere la cartella **Database di sistema**, fare clic con il pulsante destro del mouse su **master** e quindi scegliere **Nuova query**.</span><span class="sxs-lookup"><span data-stu-id="a0bab-149">Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.</span></span>
3. <span data-ttu-id="a0bab-150">Usare l'istruzione **ALTER DATABASE** seguente per rimuovere un database secondario con replica geografica.</span><span class="sxs-lookup"><span data-stu-id="a0bab-150">Use the following **ALTER DATABASE** statement to remove a geo-replicated secondary.</span></span>
   
        ALTER DATABASE <MyDB>
           REMOVE SECONDARY ON SERVER <MySecondaryServer1>;
4. <span data-ttu-id="a0bab-151">Fare clic su **Execute** per eseguire la query.</span><span class="sxs-lookup"><span data-stu-id="a0bab-151">Click **Execute** to run the query.</span></span>

## <a name="monitor-active-geo-replication-configuration-and-health"></a><span data-ttu-id="a0bab-152">Monitorare l'integrità e la configurazione della replica geografica attiva</span><span class="sxs-lookup"><span data-stu-id="a0bab-152">Monitor active geo-replication configuration and health</span></span>

<span data-ttu-id="a0bab-153">Le attività di monitoraggio includono il controllo della configurazione della replica geografica e dell'integrità della replica dei dati.</span><span class="sxs-lookup"><span data-stu-id="a0bab-153">Monitoring tasks include monitoring of the geo-replication configuration and monitoring data replication health.</span></span>  <span data-ttu-id="a0bab-154">È possibile usare la vista a gestione dinamica (DMV) **sys.dm_geo_replication_links** in un database master per restituire informazioni su tutti i collegamenti di replica esistenti per ogni database nel server logico di database SQL di Azure.</span><span class="sxs-lookup"><span data-stu-id="a0bab-154">You can use the **sys.dm_geo_replication_links** dynamic management view in the master database to return information about all exiting replication links for each database on the Azure SQL Database logical server.</span></span> <span data-ttu-id="a0bab-155">Questa vista include una riga per ogni collegamento di replica tra i database primari e secondari.</span><span class="sxs-lookup"><span data-stu-id="a0bab-155">This view contains a row for each of the replication link between primary and secondary databases.</span></span> <span data-ttu-id="a0bab-156">È possibile usare la DMV **sys.dm_replication_link_status** per restituire una riga per ogni database SQL di Azure attualmente interessato da un collegamento di replica.</span><span class="sxs-lookup"><span data-stu-id="a0bab-156">You can use the **sys.dm_replication_link_status** dynamic management view to return a row for each Azure SQL Database that is currently engaged in a replication replication link.</span></span> <span data-ttu-id="a0bab-157">Sono inclusi il database primario e i database secondari.</span><span class="sxs-lookup"><span data-stu-id="a0bab-157">This includes both primary and secondary databases.</span></span> <span data-ttu-id="a0bab-158">Se esiste più di un collegamento di replica continua per un determinato database primario, questa tabella contiene una riga per ogni relazione.</span><span class="sxs-lookup"><span data-stu-id="a0bab-158">If more than one continuous replication link exists for a given primary database, this table contains a row for each of the relationships.</span></span> <span data-ttu-id="a0bab-159">La vista viene creata in tutti i database, incluso il database master logico.</span><span class="sxs-lookup"><span data-stu-id="a0bab-159">The view is created in all databases, including the logical master.</span></span> <span data-ttu-id="a0bab-160">Eseguendo query su questa vista in tale database, verrà tuttavia restituito un set vuoto.</span><span class="sxs-lookup"><span data-stu-id="a0bab-160">However, querying this view in the logical master returns an empty set.</span></span> <span data-ttu-id="a0bab-161">È possibile usare la DMV **sys.dm_operation_status** per visualizzare lo stato di tutte le operazioni di database, incluso lo stato dei collegamenti di replica.</span><span class="sxs-lookup"><span data-stu-id="a0bab-161">You can use the **sys.dm_operation_status** dynamic management view to show the status for all database operations including the status of the replication links.</span></span> <span data-ttu-id="a0bab-162">Per altre informazioni, vedere [sys.geo_replication_links (database SQL di Azure)](https://msdn.microsoft.com/library/mt575501.aspx), [sys.dm_geo_replication_link_status (database SQL di Azure)](https://msdn.microsoft.com/library/mt575504.aspx) e [sys.dm_operation_status (database SQL di Azure)](https://msdn.microsoft.com/library/dn270022.aspx).</span><span class="sxs-lookup"><span data-stu-id="a0bab-162">For more information, see [sys.geo_replication_links (Azure SQL Database)](https://msdn.microsoft.com/library/mt575501.aspx), [sys.dm_geo_replication_link_status (Azure SQL Database)](https://msdn.microsoft.com/library/mt575504.aspx), and [sys.dm_operation_status (Azure SQL Database)](https://msdn.microsoft.com/library/dn270022.aspx).</span></span>

<span data-ttu-id="a0bab-163">Usare la procedura seguente per monitorare una relazione di replica geografica attiva.</span><span class="sxs-lookup"><span data-stu-id="a0bab-163">Use the following steps to monitor an active geo-replication partnership.</span></span>

1. <span data-ttu-id="a0bab-164">In Management Studio connettersi al server logico di database SQL di Azure.</span><span class="sxs-lookup"><span data-stu-id="a0bab-164">In Management Studio, connect to your Azure SQL Database logical server.</span></span>
2. <span data-ttu-id="a0bab-165">Aprire la cartella Database, espandere la cartella **Database di sistema**, fare clic con il pulsante destro del mouse su **master** e quindi scegliere **Nuova query**.</span><span class="sxs-lookup"><span data-stu-id="a0bab-165">Open the Databases folder, expand the **System Databases** folder, right-click on **master**, and then click **New Query**.</span></span>
3. <span data-ttu-id="a0bab-166">Usare l'istruzione seguente per visualizzare tutti i database con collegamenti di replica geografica.</span><span class="sxs-lookup"><span data-stu-id="a0bab-166">Use the following statement to show all databases with geo-replication links.</span></span>
   
        SELECT database_id, start_date, modify_date, partner_server, partner_database, replication_state_desc, role, secondary_allow_connections_desc FROM sys.geo_replication_links;
4. <span data-ttu-id="a0bab-167">Fare clic su **Execute** per eseguire la query.</span><span class="sxs-lookup"><span data-stu-id="a0bab-167">Click **Execute** to run the query.</span></span>
5. <span data-ttu-id="a0bab-168">Aprire la cartella Database, espandere la cartella **Database di sistema**, fare clic con il pulsante destro del mouse su **MyDB** e quindi scegliere **Nuova query**.</span><span class="sxs-lookup"><span data-stu-id="a0bab-168">Open the Databases folder, expand the **System Databases** folder, right-click on **MyDB**, and then click **New Query**.</span></span>
6. <span data-ttu-id="a0bab-169">Usare l'istruzione seguente per visualizzare gli intervalli di replica e l'ultima ora di replica dei database secondari di MyDB.</span><span class="sxs-lookup"><span data-stu-id="a0bab-169">Use the following statement to show the replication lags and last replication time of my secondary databases of MyDB.</span></span>
   
        SELECT link_guid, partner_server, last_replication, replication_lag_sec FROM sys.dm_geo_replication_link_status
7. <span data-ttu-id="a0bab-170">Fare clic su **Execute** per eseguire la query.</span><span class="sxs-lookup"><span data-stu-id="a0bab-170">Click **Execute** to run the query.</span></span>
8. <span data-ttu-id="a0bab-171">Usare l'istruzione seguente per visualizzare le operazioni di replica geografica più recenti associate al database MyDB.</span><span class="sxs-lookup"><span data-stu-id="a0bab-171">Use the following statement to show the most recent geo-replication operations associated with database MyDB.</span></span>
   
        SELECT * FROM sys.dm_operation_status where major_resource_id = 'MyDB'
        ORDER BY start_time DESC
9. <span data-ttu-id="a0bab-172">Fare clic su **Execute** per eseguire la query.</span><span class="sxs-lookup"><span data-stu-id="a0bab-172">Click **Execute** to run the query.</span></span>

## <a name="next-steps"></a><span data-ttu-id="a0bab-173">Passaggi successivi</span><span class="sxs-lookup"><span data-stu-id="a0bab-173">Next steps</span></span>
* <span data-ttu-id="a0bab-174">Per altre informazioni sui gruppi di failover e la replica geografica attiva, vedere [Gruppi di failover](sql-database-geo-replication-overview.md).</span><span class="sxs-lookup"><span data-stu-id="a0bab-174">To learn more about failover groups and active geo-replication, see - [Failover groups](sql-database-geo-replication-overview.md)</span></span>
* <span data-ttu-id="a0bab-175">Per la panoramica e gli scenari della continuità aziendale, vedere [Continuità aziendale del database SQL di Azure](sql-database-business-continuity.md)</span><span class="sxs-lookup"><span data-stu-id="a0bab-175">For a business continuity overview and scenarios, see [Business continuity overview](sql-database-business-continuity.md)</span></span>

