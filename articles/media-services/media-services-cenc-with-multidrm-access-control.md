---
title: 'CENC con DRM multiplo e controllo di accesso: progettazione di riferimento e implementazione in Azure e in Servizi multimediali di Azure | Microsoft Docs'
description: "Informazioni su come ottenere la licenza per Microsoft® Smooth Streaming Client Porting Kit."
services: media-services
documentationcenter: 
author: willzhan
manager: cfowler
editor: 
ms.assetid: 7814739b-cea9-4b9b-8370-538702e5c615
ms.service: media-services
ms.workload: media
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 07/19/2017
ms.author: willzhan;kilroyh;yanmf;juliako
ms.openlocfilehash: 730917b6859f8dbd800ef2cb141062f45d7779ac
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/29/2017
---
# <a name="cenc-with-multi-drm-and-access-control-a-reference-design-and-implementation-on-azure-and-azure-media-services"></a><span data-ttu-id="d86c7-103">CENC con DRM multiplo e controllo di accesso: progettazione di riferimento e implementazione in Azure e in Servizi multimediali di Azure</span><span class="sxs-lookup"><span data-stu-id="d86c7-103">CENC with Multi-DRM and Access Control: A Reference Design and Implementation on Azure and Azure Media Services</span></span>
 
## <a name="introduction"></a><span data-ttu-id="d86c7-104">Introduzione</span><span class="sxs-lookup"><span data-stu-id="d86c7-104">Introduction</span></span>
<span data-ttu-id="d86c7-105">È risaputo che la progettazione e la compilazione di un sottosistema DRM per una soluzione di streaming online o OTT sono attività complesse.</span><span class="sxs-lookup"><span data-stu-id="d86c7-105">It is well known that it is a complex task to design and build a DRM subsystem for an OTT or online streaming solution.</span></span> <span data-ttu-id="d86c7-106">Gli operatori e i provider video online in genere danno queste attività in outsourcing a provider di servizi DRM specializzati.</span><span class="sxs-lookup"><span data-stu-id="d86c7-106">And it is a common practice for operators/online video providers to outsource this part to specialized DRM service providers.</span></span> <span data-ttu-id="d86c7-107">L'obiettivo di questo documento è presentare una progettazione di riferimento e l'implementazione del sottosistema DRM end-to-end nella soluzione di streaming online o OTT.</span><span class="sxs-lookup"><span data-stu-id="d86c7-107">The goal of this document is to present a reference design and implementation of end-to-end DRM subsystem in OTT or online streaming solution.</span></span>

<span data-ttu-id="d86c7-108">Questo documento è destinato agli ingegneri che lavorano nel sottosistema DRM di soluzioni con più schermate/di streaming online o OTT, ma anche a chi è interessato al sottosistema DRM.</span><span class="sxs-lookup"><span data-stu-id="d86c7-108">The targeted readers of this document are engineers working in DRM subsystem of OTT or online streaming/multi-screen solutions, or any readers interested in DRM subsystem.</span></span> <span data-ttu-id="d86c7-109">Il presupposto è che i lettori abbiano familiarità con almeno una delle tecnologie DRM presenti sul mercato, ad esempio PlayReady, Widevine, FairPlay o Adobe Access.</span><span class="sxs-lookup"><span data-stu-id="d86c7-109">The assumption is that readers are familiar with at least one of the DRM technologies on the market, such as PlayReady, Widevine, FairPlay or Adobe Access.</span></span>

<span data-ttu-id="d86c7-110">DRM include anche CENC (Common Encryption) con DRM multiplo.</span><span class="sxs-lookup"><span data-stu-id="d86c7-110">By DRM, we also include CENC (Common Encryption) with multi-DRM.</span></span> <span data-ttu-id="d86c7-111">Una delle tendenze principali del settore OTT e dello streaming online è quella di usare CENC con DRM nativo multiplo su diverse piattaforme client. La tendenza precedente era invece quella di usare un solo DRM e l'SDK client per più piattaforme client.</span><span class="sxs-lookup"><span data-stu-id="d86c7-111">A major trend in online streaming and OTT industry is to use CENC with multi-native-DRM on various client platforms, which is a shift from the previous trend of using a single DRM and its client SDK for various client platforms.</span></span> <span data-ttu-id="d86c7-112">Quando si usa CENC con DRM nativo multiplo, PlayReady e Widevine vengono crittografati in base alla specifica [Common Encryption (ISO/IEC 23001-7 CENC)](http://www.iso.org/iso/home/store/catalogue_ics/catalogue_detail_ics.htm?csnumber=65271/).</span><span class="sxs-lookup"><span data-stu-id="d86c7-112">When using CENC with multi-native-DRM, both PlayReady and Widevine are encrypted per the [Common Encryption (ISO/IEC 23001-7 CENC)](http://www.iso.org/iso/home/store/catalogue_ics/catalogue_detail_ics.htm?csnumber=65271/) specification.</span></span>

<span data-ttu-id="d86c7-113">I vantaggi di CENC con DRM multiplo sono i seguenti:</span><span class="sxs-lookup"><span data-stu-id="d86c7-113">The benefits of CENC with multi-DRM are as follows:</span></span>

1. <span data-ttu-id="d86c7-114">Riduce il costo della crittografia perché viene usata una sola elaborazione crittografica per piattaforme diverse con i DRM nativi.</span><span class="sxs-lookup"><span data-stu-id="d86c7-114">Reduces encryption cost since a single encryption processing is used targeting different platforms with its native DRMs;</span></span>
2. <span data-ttu-id="d86c7-115">Riduce il costo della gestione degli asset crittografati perché è necessaria una sola copia degli asset crittografati.</span><span class="sxs-lookup"><span data-stu-id="d86c7-115">Reduces the cost of managing encrypted assets since only a single copy of encrypted assets is needed;</span></span>
3. <span data-ttu-id="d86c7-116">Elimina il costo della licenza del client DRM perché il client DRM nativo è in genere gratuito sulla piattaforma nativa.</span><span class="sxs-lookup"><span data-stu-id="d86c7-116">Eliminates DRM client licensing cost since the native DRM client is usually free on its native platform.</span></span>

<span data-ttu-id="d86c7-117">Microsoft, insieme ad alcuni dei principali leader di settore, ha promosso attivamente DASH e CENC.</span><span class="sxs-lookup"><span data-stu-id="d86c7-117">Microsoft has been an active promoter of DASH and CENC together with some major industry players.</span></span> <span data-ttu-id="d86c7-118">Servizi multimediali di Microsoft Azure ha fornito il supporto di DASH e CENC.</span><span class="sxs-lookup"><span data-stu-id="d86c7-118">Microsoft Azure Media Services has been providing support of DASH and CENC.</span></span> <span data-ttu-id="d86c7-119">Per gli annunci recenti, vedere i blog di Mingfei relativi all'[annuncio dell'anteprima pubblica dei servizi di distribuzione delle licenze Google Widevine in Servizi multimediali di Azure](https://azure.microsoft.com/blog/announcing-general-availability-of-google-widevine-license-services/) e all'[aggiunta in Servizi multimediali di Azure del pacchetto Google Widevine per la distribuzione del flusso DRM multiplo](https://azure.microsoft.com/blog/azure-media-services-adds-google-widevine-packaging-for-delivering-multi-drm-stream/).</span><span class="sxs-lookup"><span data-stu-id="d86c7-119">For recent announcements, please see Mingfei’s blogs: [Announcing Google Widevine license delivery services in Azure Media Services](https://azure.microsoft.com/blog/announcing-general-availability-of-google-widevine-license-services/), and [Azure Media Services adds Google Widevine packaging for delivering multi-DRM stream](https://azure.microsoft.com/blog/azure-media-services-adds-google-widevine-packaging-for-delivering-multi-drm-stream/).</span></span>  

### <a name="overview-of-this-article"></a><span data-ttu-id="d86c7-120">Panoramica dell'articolo</span><span class="sxs-lookup"><span data-stu-id="d86c7-120">Overview of this article</span></span>
<span data-ttu-id="d86c7-121">Gli obiettivi di questo articolo sono i seguenti:</span><span class="sxs-lookup"><span data-stu-id="d86c7-121">The goal of this article includes the following:</span></span>

1. <span data-ttu-id="d86c7-122">Fornire una progettazione di riferimento del sottosistema DRM usando CENC con DRM multiplo.</span><span class="sxs-lookup"><span data-stu-id="d86c7-122">Provides a reference design of DRM subsystem using CENC with multi-DRM;</span></span>
2. <span data-ttu-id="d86c7-123">Fornire un'implementazione di riferimento nella piattaforma Microsoft Azure/Servizi multimediali di Azure.</span><span class="sxs-lookup"><span data-stu-id="d86c7-123">Provides a reference implementation on Microsoft Azure/Azure Media Services platform;</span></span>
3. <span data-ttu-id="d86c7-124">Illustrare alcuni argomenti relativi alla progettazione e all'implementazione.</span><span class="sxs-lookup"><span data-stu-id="d86c7-124">Discusses some design and implementation topics.</span></span>

<span data-ttu-id="d86c7-125">Nell'articolo, "DRM multiplo" fa riferimento a quanto segue:</span><span class="sxs-lookup"><span data-stu-id="d86c7-125">In the article, “multi-DRM” covers the following:</span></span>

1. <span data-ttu-id="d86c7-126">Microsoft PlayReady</span><span class="sxs-lookup"><span data-stu-id="d86c7-126">Microsoft PlayReady</span></span>
2. <span data-ttu-id="d86c7-127">Google Widevine</span><span class="sxs-lookup"><span data-stu-id="d86c7-127">Google Widevine</span></span>
3. <span data-ttu-id="d86c7-128">Apple FairPlay</span><span class="sxs-lookup"><span data-stu-id="d86c7-128">Apple FairPlay</span></span> 

<span data-ttu-id="d86c7-129">La tabella seguente riepiloga l'app nativa/piattaforma e i browser supportati da ogni DRM.</span><span class="sxs-lookup"><span data-stu-id="d86c7-129">The following table summarizes the native platform/native app, and browsers supported by each DRM.</span></span>

| <span data-ttu-id="d86c7-130">**Piattaforma client**</span><span class="sxs-lookup"><span data-stu-id="d86c7-130">**Client Platform**</span></span> | <span data-ttu-id="d86c7-131">**Supporto DRM nativo**</span><span class="sxs-lookup"><span data-stu-id="d86c7-131">**Native DRM Support**</span></span> | <span data-ttu-id="d86c7-132">**Browser/App**</span><span class="sxs-lookup"><span data-stu-id="d86c7-132">**Browser/App**</span></span> | <span data-ttu-id="d86c7-133">**Formati di streaming**</span><span class="sxs-lookup"><span data-stu-id="d86c7-133">**Streaming Formats**</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="d86c7-134">**Smart TV, STB operatore, STB OTT**</span><span class="sxs-lookup"><span data-stu-id="d86c7-134">**Smart TVs, operator STBs, OTT STBs**</span></span> |<span data-ttu-id="d86c7-135">Principalmente PlayReady e/o Widevine e/o altro</span><span class="sxs-lookup"><span data-stu-id="d86c7-135">PlayReady primarily, and/or Widevine, and/or other</span></span> |<span data-ttu-id="d86c7-136">Linux, Opera, WebKit, altri</span><span class="sxs-lookup"><span data-stu-id="d86c7-136">Linux, Opera, WebKit, Other</span></span> |<span data-ttu-id="d86c7-137">Vari formati</span><span class="sxs-lookup"><span data-stu-id="d86c7-137">Various formats</span></span> |
| <span data-ttu-id="d86c7-138">**Dispositivi Windows 10 (PC Windows, tablet Windows, Windows Phone, Xbox)**</span><span class="sxs-lookup"><span data-stu-id="d86c7-138">**Windows 10 devices (Windows PC, Windows Tablets, Windows Phone, Xbox)**</span></span> |<span data-ttu-id="d86c7-139">PlayReady</span><span class="sxs-lookup"><span data-stu-id="d86c7-139">PlayReady</span></span> |<span data-ttu-id="d86c7-140">MS Edge/IE11/EME</span><span class="sxs-lookup"><span data-stu-id="d86c7-140">MS Edge/IE11/EME</span></span><br/><br/><br/><span data-ttu-id="d86c7-141">UWP</span><span class="sxs-lookup"><span data-stu-id="d86c7-141">UWP</span></span> |<span data-ttu-id="d86c7-142">DASH (per HLS, PlayReady non è supportato)</span><span class="sxs-lookup"><span data-stu-id="d86c7-142">DASH (For HLS, PlayReady is not supported)</span></span><br/><br/><span data-ttu-id="d86c7-143">DASH, Smooth Streaming (per HLS, PlayReady non è supportato)</span><span class="sxs-lookup"><span data-stu-id="d86c7-143">DASH, Smooth Streaming (For HLS, PlayReady is not supported)</span></span> |
| <span data-ttu-id="d86c7-144">**Dispositivi Android (telefoni, tablet, TV)**</span><span class="sxs-lookup"><span data-stu-id="d86c7-144">**Android devices (Phone, Tablet, TV)**</span></span> |<span data-ttu-id="d86c7-145">Widevine</span><span class="sxs-lookup"><span data-stu-id="d86c7-145">Widevine</span></span> |<span data-ttu-id="d86c7-146">Chrome/EME</span><span class="sxs-lookup"><span data-stu-id="d86c7-146">Chrome/EME</span></span> |<span data-ttu-id="d86c7-147">DASH, HLS</span><span class="sxs-lookup"><span data-stu-id="d86c7-147">DASH,HLS</span></span> |
| <span data-ttu-id="d86c7-148">**iOS (iPhone, iPad), client OS X e Apple TV**</span><span class="sxs-lookup"><span data-stu-id="d86c7-148">**iOS (iPhone, iPad), OS X clients and Apple TV**</span></span> |<span data-ttu-id="d86c7-149">FairPlay</span><span class="sxs-lookup"><span data-stu-id="d86c7-149">FairPlay</span></span> |<span data-ttu-id="d86c7-150">Safari 8+/EME</span><span class="sxs-lookup"><span data-stu-id="d86c7-150">Safari 8+/EME</span></span> |<span data-ttu-id="d86c7-151">HLS</span><span class="sxs-lookup"><span data-stu-id="d86c7-151">HLS</span></span> |


<span data-ttu-id="d86c7-152">Considerando lo stato attuale della distribuzione per ogni DRM, un servizio solitamente vuole implementare 2 o 3 DRM per assicurarsi di affrontare tutti i tipi di endpoint nel modo migliore.</span><span class="sxs-lookup"><span data-stu-id="d86c7-152">Considering the current state of deployment for each DRM, a service will typically want to implement 2 or 3 DRMs to make sure you address all the types of endpoints in the best way.</span></span>

<span data-ttu-id="d86c7-153">Occorre raggiungere un compromesso tra la complessità della logica del servizio e la complessità sul lato client per ottenere un certo livello di esperienza utente nei vari client.</span><span class="sxs-lookup"><span data-stu-id="d86c7-153">There is a tradeoff between the complexity of the service logic and the complexity on the client side to reach a certain level of user experience on the various clients.</span></span>

<span data-ttu-id="d86c7-154">Per eseguire la selezione, tenere presente quanto segue:</span><span class="sxs-lookup"><span data-stu-id="d86c7-154">To make your selection, keep in mind these facts:</span></span>

* <span data-ttu-id="d86c7-155">PlayReady viene implementato in modo nativo in tutti i dispositivi Windows e in alcuni dispositivi Android ed è disponibile tramite SDK software su praticamente qualsiasi piattaforma.</span><span class="sxs-lookup"><span data-stu-id="d86c7-155">PlayReady is natively implemented in every Windows device, on some Android devices, and available through software SDKs on virtually any platform</span></span>
* <span data-ttu-id="d86c7-156">Widevine viene implementato in modo nativo in tutti i dispositivi Android, in Chrome e in alcuni altri dispositivi.</span><span class="sxs-lookup"><span data-stu-id="d86c7-156">Widevine is natively implemented in every Android device, in Chrome, and in some other devices</span></span>
* <span data-ttu-id="d86c7-157">FairPlay è disponibile solo in iOS e nei client Mac OS o tramite iTunes.</span><span class="sxs-lookup"><span data-stu-id="d86c7-157">FairPlay is available only on iOS and Mac OS clients or through iTunes.</span></span>

<span data-ttu-id="d86c7-158">Quindi, un DRM multiplo tipico corrisponde ai seguenti:</span><span class="sxs-lookup"><span data-stu-id="d86c7-158">So a typical multi-DRM would be:</span></span>

* <span data-ttu-id="d86c7-159">Opzione 1: PlayReady e Widevine</span><span class="sxs-lookup"><span data-stu-id="d86c7-159">Option 1: PlayReady and Widevine</span></span>
* <span data-ttu-id="d86c7-160">Opzione 2: PlayReady, Widevine e FairPlay</span><span class="sxs-lookup"><span data-stu-id="d86c7-160">Option 2: PlayReady, Widevine and FairPlay</span></span>

## <a name="a-reference-design"></a><span data-ttu-id="d86c7-161">Progettazione di riferimento</span><span class="sxs-lookup"><span data-stu-id="d86c7-161">A reference design</span></span>
<span data-ttu-id="d86c7-162">In questa sezione verrà presentata una progettazione di riferimento indipendente dalle tecnologie usate per implementarla.</span><span class="sxs-lookup"><span data-stu-id="d86c7-162">In this section, we will present a reference design which is agnostic to technologies used to implement it.</span></span>

<span data-ttu-id="d86c7-163">Un sottosistema DRM può contenere i componenti seguenti:</span><span class="sxs-lookup"><span data-stu-id="d86c7-163">A DRM subsystem may contain the following components:</span></span>

1. <span data-ttu-id="d86c7-164">Gestione della chiave</span><span class="sxs-lookup"><span data-stu-id="d86c7-164">Key management</span></span>
2. <span data-ttu-id="d86c7-165">Creazione pacchetto DRM</span><span class="sxs-lookup"><span data-stu-id="d86c7-165">DRM packaging</span></span>
3. <span data-ttu-id="d86c7-166">Distribuzione di licenze DRM</span><span class="sxs-lookup"><span data-stu-id="d86c7-166">DRM license delivery</span></span>
4. <span data-ttu-id="d86c7-167">Controllo dei diritti</span><span class="sxs-lookup"><span data-stu-id="d86c7-167">Entitlement check</span></span>
5. <span data-ttu-id="d86c7-168">Autenticazione/autorizzazione</span><span class="sxs-lookup"><span data-stu-id="d86c7-168">Authentication/authorization</span></span>
6. <span data-ttu-id="d86c7-169">Lettore</span><span class="sxs-lookup"><span data-stu-id="d86c7-169">Player</span></span>
7. <span data-ttu-id="d86c7-170">Origine/rete CDN</span><span class="sxs-lookup"><span data-stu-id="d86c7-170">Origin/CDN</span></span>

<span data-ttu-id="d86c7-171">Il diagramma seguente illustra l'interazione generale tra i componenti in un sottosistema DRM.</span><span class="sxs-lookup"><span data-stu-id="d86c7-171">The following diagram illustrates the high level interaction among the components in a DRM subsystem.</span></span>

![Sottosistema DRM con CENC](./media/media-services-cenc-with-multidrm-access-control/media-services-generic-drm-subsystem-with-cenc.png)

<span data-ttu-id="d86c7-173">I "livelli" di base della progettazione sono tre:</span><span class="sxs-lookup"><span data-stu-id="d86c7-173">There are three basic “layers” in the design:</span></span>

1. <span data-ttu-id="d86c7-174">Livello back office (in nero) non esposto esternamente.</span><span class="sxs-lookup"><span data-stu-id="d86c7-174">Back office layer (in black) which are not exposed externally;</span></span>
2. <span data-ttu-id="d86c7-175">Livello "rete perimetrale" (blu) contenente tutti gli endpoint pubblici.</span><span class="sxs-lookup"><span data-stu-id="d86c7-175">“DMZ” layer (blue) containing all the endpoints facing public;</span></span>
3. <span data-ttu-id="d86c7-176">Livello Internet pubblico (azzurro) contenente la rete CDN e i lettori con traffico su Internet pubblico.</span><span class="sxs-lookup"><span data-stu-id="d86c7-176">Public Internet layer (light blue) containing CDN and players with traffic across public Internet.</span></span>

<span data-ttu-id="d86c7-177">Deve essere presente uno strumento di gestione del contenuto per controllare la protezione DRM, indipendentemente dal fatto che si tratti di crittografia statica o dinamica.</span><span class="sxs-lookup"><span data-stu-id="d86c7-177">There should be a content management tool for controlling DRM protection, regardless it is static or dynamic encryption.</span></span> <span data-ttu-id="d86c7-178">Gli input per la crittografia DRM devono includere:</span><span class="sxs-lookup"><span data-stu-id="d86c7-178">The inputs for DRM encryption should include:</span></span>

1. <span data-ttu-id="d86c7-179">Contenuto video con velocità in bit multipla.</span><span class="sxs-lookup"><span data-stu-id="d86c7-179">MBR video content;</span></span>
2. <span data-ttu-id="d86c7-180">Chiave simmetrica.</span><span class="sxs-lookup"><span data-stu-id="d86c7-180">Content key;</span></span>
3. <span data-ttu-id="d86c7-181">URL di acquisizione delle licenze.</span><span class="sxs-lookup"><span data-stu-id="d86c7-181">License acquisition URLs.</span></span>

<span data-ttu-id="d86c7-182">Durante la fase di riproduzione, il flusso generale è:</span><span class="sxs-lookup"><span data-stu-id="d86c7-182">During playback time, the high level flow is:</span></span>

1. <span data-ttu-id="d86c7-183">L'utente viene autenticato.</span><span class="sxs-lookup"><span data-stu-id="d86c7-183">User is authenticated;</span></span>
2. <span data-ttu-id="d86c7-184">Viene creato il token di autorizzazione per l'utente.</span><span class="sxs-lookup"><span data-stu-id="d86c7-184">Authorization token is created for the user;</span></span>
3. <span data-ttu-id="d86c7-185">Il contenuto protetto da DRM (manifesto) viene scaricato nel lettore.</span><span class="sxs-lookup"><span data-stu-id="d86c7-185">DRM protected content (manifest) is downloaded to player;</span></span>
4. <span data-ttu-id="d86c7-186">Il lettore invia la richiesta di acquisizione di licenza ai server licenze con l'ID chiave e il token di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="d86c7-186">Player submits license acquisition request to license servers together with key ID and authorization token.</span></span>

<span data-ttu-id="d86c7-187">Prima di passare all'argomento successivo, verrà brevemente illustrata la progettazione della gestione delle chiavi.</span><span class="sxs-lookup"><span data-stu-id="d86c7-187">Before moving to the next topic, a few words about the design of key management.</span></span>

| <span data-ttu-id="d86c7-188">**Chiave simmetrica-ad-asset**</span><span class="sxs-lookup"><span data-stu-id="d86c7-188">**ContentKey–to-Asset**</span></span> | <span data-ttu-id="d86c7-189">**Scenario**</span><span class="sxs-lookup"><span data-stu-id="d86c7-189">**Scenario**</span></span> |
| --- | --- |
| <span data-ttu-id="d86c7-190">1-a-1</span><span class="sxs-lookup"><span data-stu-id="d86c7-190">1–to-1</span></span> |<span data-ttu-id="d86c7-191">È il caso più semplice.</span><span class="sxs-lookup"><span data-stu-id="d86c7-191">The simplest case.</span></span> <span data-ttu-id="d86c7-192">Consente il controllo più dettagliato,</span><span class="sxs-lookup"><span data-stu-id="d86c7-192">It provides the finest control.</span></span> <span data-ttu-id="d86c7-193">ma in genere comporta il costo maggiore di distribuzione delle licenze.</span><span class="sxs-lookup"><span data-stu-id="d86c7-193">But this generally results in the highest license delivery cost.</span></span> <span data-ttu-id="d86c7-194">È necessaria almeno una richiesta di licenza per ogni asset protetto.</span><span class="sxs-lookup"><span data-stu-id="d86c7-194">At minimum one license request is required for each protected asset.</span></span> |
| <span data-ttu-id="d86c7-195">1-a-molti</span><span class="sxs-lookup"><span data-stu-id="d86c7-195">1–to-Many</span></span> |<span data-ttu-id="d86c7-196">È possibile usare la stessa chiave simmetrica per più asset.</span><span class="sxs-lookup"><span data-stu-id="d86c7-196">You could use the same content key for multiple assets.</span></span> <span data-ttu-id="d86c7-197">Ad esempio, per tutti gli asset di un gruppo logico, come un genere o un subset del genere (o genere film), è possibile usare una singola chiave simmetrica.</span><span class="sxs-lookup"><span data-stu-id="d86c7-197">For example, for all the assets in a logical group such as a genre or subset of genre (or Movie Gene), you could use a single content key.</span></span> |
| <span data-ttu-id="d86c7-198">Molti-a-1</span><span class="sxs-lookup"><span data-stu-id="d86c7-198">Many–to-1</span></span> |<span data-ttu-id="d86c7-199">Per ogni asset sono necessarie più chiavi simmetriche.</span><span class="sxs-lookup"><span data-stu-id="d86c7-199">Multiple content keys are needed for each asset.</span></span> <br/><br/><span data-ttu-id="d86c7-200">Ad esempio, se è necessario applicare la protezione CENC dinamica con DRM multiplo per MPEG-DASH e la crittografia AES-128 dinamica per HLS, sono necessarie due chiavi simmetriche distinte, entrambe con il proprio ContentKeyType.</span><span class="sxs-lookup"><span data-stu-id="d86c7-200">For example, if you need to apply dynamic CENC protection with multi-DRM for MPEG-DASH, and dynamic AES-128 encryption for HLS, you need two separate content keys, each with its own ContentKeyType.</span></span> <span data-ttu-id="d86c7-201">Per la chiave simmetrica usata per la protezione CENC dinamica è consigliabile usare ContentKeyType.CommonEncryption, mentre per la chiave simmetrica usata per la crittografia AES-128 dinamica è consigliabile usare ContentKeyType.EnvelopeEncryption.</span><span class="sxs-lookup"><span data-stu-id="d86c7-201">(For the content key used for dynamic CENC protection, ContentKeyType.CommonEncryption should be used, while for the content key used for dynamic AES-128 encryption, ContentKeyType.EnvelopeEncryption should be used.)</span></span><br/><br/><span data-ttu-id="d86c7-202">Un altro esempio è quello della protezione CENC del contenuto DASH dove, in teoria, una chiave simmetrica può essere usata per proteggere il flusso video e un'altra chiave simmetrica per proteggere il flusso audio.</span><span class="sxs-lookup"><span data-stu-id="d86c7-202">Another example, in CENC protection of DASH content, in theory, one content key can be used to protect video stream and another content key to protect audio stream.</span></span> |
| <span data-ttu-id="d86c7-203">Molti-a-molti</span><span class="sxs-lookup"><span data-stu-id="d86c7-203">Many – to - Many</span></span> |<span data-ttu-id="d86c7-204">È una combinazione dei due scenari precedenti: per ogni asset multiplo nello stesso "gruppo" di asset viene usato un set di chiavi simmetriche.</span><span class="sxs-lookup"><span data-stu-id="d86c7-204">Combination of the above two scenarios: one set of content keys are used for each of the multiple assets in the same asset “group”.</span></span> |

<span data-ttu-id="d86c7-205">Un altro fattore importante da considerare è l'uso di licenze persistenti e non persistenti.</span><span class="sxs-lookup"><span data-stu-id="d86c7-205">Another important factor to consider is the use of persistent and non-persistent licenses.</span></span>

<span data-ttu-id="d86c7-206">Perché queste considerazioni sono importanti?</span><span class="sxs-lookup"><span data-stu-id="d86c7-206">Why are these considerations important?</span></span>

<span data-ttu-id="d86c7-207">Hanno un impatto diretto sul costo della distribuzione delle licenze se si usa il cloud pubblico a questo scopo.</span><span class="sxs-lookup"><span data-stu-id="d86c7-207">They have direct impact to license delivery cost if you use public cloud for license delivery.</span></span> <span data-ttu-id="d86c7-208">Si considerino i due seguenti casi di progettazione:</span><span class="sxs-lookup"><span data-stu-id="d86c7-208">Let’s consider the following two different design cases to illustrate:</span></span>

1. <span data-ttu-id="d86c7-209">Sottoscrizione mensile: usare una licenza persistente e il mapping chiave simmetrica-ad-asset 1-a-molti.</span><span class="sxs-lookup"><span data-stu-id="d86c7-209">Monthly subscription: Use persistent license, and 1-to-many content key-to-asset mapping.</span></span> <span data-ttu-id="d86c7-210">Ad esempio,</span><span class="sxs-lookup"><span data-stu-id="d86c7-210">E.g.</span></span> <span data-ttu-id="d86c7-211">per tutti i film per bambini, viene usata un'unica chiave simmetrica per la crittografia.</span><span class="sxs-lookup"><span data-stu-id="d86c7-211">for all the kids movies, we use a single content key for encryption.</span></span> <span data-ttu-id="d86c7-212">In questo caso:</span><span class="sxs-lookup"><span data-stu-id="d86c7-212">In this case:</span></span>

    <span data-ttu-id="d86c7-213">N. totale di licenze richieste per tutti i film per bambini/dispositivo = 1</span><span class="sxs-lookup"><span data-stu-id="d86c7-213">Total # licenses requested for all kids movies/device = 1</span></span>
2. <span data-ttu-id="d86c7-214">Sottoscrizione mensile: usare una licenza non persistente e il mapping 1-a-1 tra la chiave simmetrica e l'asset.</span><span class="sxs-lookup"><span data-stu-id="d86c7-214">Monthly subscription: Use non-persistent license, and 1-to-1 mapping between content key and asset.</span></span> <span data-ttu-id="d86c7-215">In questo caso:</span><span class="sxs-lookup"><span data-stu-id="d86c7-215">In this case:</span></span>

    <span data-ttu-id="d86c7-216">N. totale di licenze richieste per tutti i film per bambini/dispositivo = [n. di film guardati] x [n. di sessioni]</span><span class="sxs-lookup"><span data-stu-id="d86c7-216">Total # licenses requested for all kids movies/device = [# movies watched] x [# sessions]</span></span>

<span data-ttu-id="d86c7-217">Come si può notare facilmente, le due diverse progettazioni restituiscono modelli di richiesta di licenza molto diversi da cui deriva il costo della distribuzione delle licenze se il servizio di distribuzione delle licenze viene fornito da un cloud pubblico, ad esempio Servizi multimediali di Azure.</span><span class="sxs-lookup"><span data-stu-id="d86c7-217">As you can easily see, the two different designs result in very different license request patterns hence license delivery cost if license delivery service is provided by a public cloud such as Azure Media Services.</span></span>

## <a name="mapping-design-to-technology-for-implementation"></a><span data-ttu-id="d86c7-218">Mapping della progettazione alla tecnologia per l'implementazione</span><span class="sxs-lookup"><span data-stu-id="d86c7-218">Mapping design to technology for implementation</span></span>
<span data-ttu-id="d86c7-219">Ora verrà eseguito il mapping della progettazione generica alle tecnologie nella piattaforma Microsoft Azure/Servizi multimediali di Azure, specificando la tecnologia da usare per ogni blocco predefinito.</span><span class="sxs-lookup"><span data-stu-id="d86c7-219">Next, we map our generic design to technologies on Microsoft Azure/Azure Media Services platform, by specifying which technology to use for each building block.</span></span>

<span data-ttu-id="d86c7-220">La tabella seguente illustra il mapping:</span><span class="sxs-lookup"><span data-stu-id="d86c7-220">The following table shows the mapping:</span></span>

| <span data-ttu-id="d86c7-221">**Blocco predefinito**</span><span class="sxs-lookup"><span data-stu-id="d86c7-221">**Building Block**</span></span> | <span data-ttu-id="d86c7-222">**Technology**</span><span class="sxs-lookup"><span data-stu-id="d86c7-222">**Technology**</span></span> |
| --- | --- |
| <span data-ttu-id="d86c7-223">**Lettore**</span><span class="sxs-lookup"><span data-stu-id="d86c7-223">**Player**</span></span> |[<span data-ttu-id="d86c7-224">Azure Media Player</span><span class="sxs-lookup"><span data-stu-id="d86c7-224">Azure Media Player</span></span>](https://azure.microsoft.com/services/media-services/media-player/) |
| <span data-ttu-id="d86c7-225">**Provider di identità (IdP)**</span><span class="sxs-lookup"><span data-stu-id="d86c7-225">**Identity Provider (IDP)**</span></span> |<span data-ttu-id="d86c7-226">Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="d86c7-226">Azure Active Directory</span></span> |
| <span data-ttu-id="d86c7-227">**Servizio token di sicurezza**</span><span class="sxs-lookup"><span data-stu-id="d86c7-227">**Secure Token Service (STS)**</span></span> |<span data-ttu-id="d86c7-228">Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="d86c7-228">Azure Active Directory</span></span> |
| <span data-ttu-id="d86c7-229">**Flusso di lavoro protezione DRM**</span><span class="sxs-lookup"><span data-stu-id="d86c7-229">**DRM Protection Workflow**</span></span> |<span data-ttu-id="d86c7-230">Protezione dinamica di Servizi multimediali di Azure</span><span class="sxs-lookup"><span data-stu-id="d86c7-230">Azure Media Services Dynamic Protection</span></span> |
| <span data-ttu-id="d86c7-231">**Distribuzione di licenze DRM**</span><span class="sxs-lookup"><span data-stu-id="d86c7-231">**DRM License Delivery**</span></span> |<span data-ttu-id="d86c7-232">1. Distribuzione delle licenze di Servizi multimediali di Azure (PlayReady, Widevine, FairPlay) o</span><span class="sxs-lookup"><span data-stu-id="d86c7-232">1. Azure Media Services License Delivery (PlayReady, Widevine, FairPlay), or</span></span> <br/><span data-ttu-id="d86c7-233">2. Server licenze Axinom,</span><span class="sxs-lookup"><span data-stu-id="d86c7-233">2. Axinom License Server,</span></span> <br/><span data-ttu-id="d86c7-234">3. Server licenze PlayReady personalizzato</span><span class="sxs-lookup"><span data-stu-id="d86c7-234">3. Custom PlayReady License Server</span></span> |
| <span data-ttu-id="d86c7-235">**Origine**</span><span class="sxs-lookup"><span data-stu-id="d86c7-235">**Origin**</span></span> |<span data-ttu-id="d86c7-236">Endpoint di streaming di Servizi multimediali di Azure</span><span class="sxs-lookup"><span data-stu-id="d86c7-236">Azure Media Services Streaming Endpoint</span></span> |
| <span data-ttu-id="d86c7-237">**Gestione della chiave**</span><span class="sxs-lookup"><span data-stu-id="d86c7-237">**Key Management**</span></span> |<span data-ttu-id="d86c7-238">Non necessaria per l'implementazione di riferimento</span><span class="sxs-lookup"><span data-stu-id="d86c7-238">Not needed for reference implementation</span></span> |
| <span data-ttu-id="d86c7-239">**Gestione del contenuto**</span><span class="sxs-lookup"><span data-stu-id="d86c7-239">**Content Management**</span></span> |<span data-ttu-id="d86c7-240">Applicazione console in C#</span><span class="sxs-lookup"><span data-stu-id="d86c7-240">A C# console application</span></span> |

<span data-ttu-id="d86c7-241">In altre parole, sia il provider di identità (IdP) che il servizio token di sicurezza saranno Azure AD.</span><span class="sxs-lookup"><span data-stu-id="d86c7-241">In other words, both Identity Provider (IDP) and Secure Token Service (STS) will be Azure AD.</span></span> <span data-ttu-id="d86c7-242">Come lettore si userà l' [API di Azure Media Player](http://amp.azure.net/libs/amp/latest/docs/).</span><span class="sxs-lookup"><span data-stu-id="d86c7-242">For player, we will use [Azure Media Player API](http://amp.azure.net/libs/amp/latest/docs/).</span></span> <span data-ttu-id="d86c7-243">Sia Servizi multimediali di Azure che Azure Media Player supportano DASH e CENC con DRM multiplo.</span><span class="sxs-lookup"><span data-stu-id="d86c7-243">Both Azure Media Services and Azure Media Player support DASH and CENC with multi-DRM.</span></span>

<span data-ttu-id="d86c7-244">Il diagramma seguente illustra la struttura e il flusso generali con il mapping alla tecnologia precedente.</span><span class="sxs-lookup"><span data-stu-id="d86c7-244">The following diagram shows the overall structure and flow with the above technology mapping.</span></span>

![CENC in AMS](./media/media-services-cenc-with-multidrm-access-control/media-services-cenc-subsystem-on-AMS-platform.png)

<span data-ttu-id="d86c7-246">Per configurare la crittografia CENC dinamica, lo strumento di gestione del contenuto userà gli input seguenti:</span><span class="sxs-lookup"><span data-stu-id="d86c7-246">In order to set up dynamic CENC encryption, the content management tool will use the following inputs:</span></span>

1. <span data-ttu-id="d86c7-247">Contenuto aperto.</span><span class="sxs-lookup"><span data-stu-id="d86c7-247">Open content;</span></span>
2. <span data-ttu-id="d86c7-248">Chiave simmetrica dalla generazione/gestione delle chiavi.</span><span class="sxs-lookup"><span data-stu-id="d86c7-248">Content key from key generation/management;</span></span>
3. <span data-ttu-id="d86c7-249">URL di acquisizione delle licenze.</span><span class="sxs-lookup"><span data-stu-id="d86c7-249">License acquisition URLs;</span></span>
4. <span data-ttu-id="d86c7-250">Un elenco di informazioni da Azure AD.</span><span class="sxs-lookup"><span data-stu-id="d86c7-250">A list of information from Azure AD.</span></span>

<span data-ttu-id="d86c7-251">L'output dello strumento di gestione del contenuto sarà:</span><span class="sxs-lookup"><span data-stu-id="d86c7-251">The output of the content management tool will be:</span></span>

1. <span data-ttu-id="d86c7-252">ContentKeyAuthorizationPolicy contenente la specifica relativa alla verifica di un token JWT da parte della distribuzione delle licenze e le specifiche relative alle licenze DRM.</span><span class="sxs-lookup"><span data-stu-id="d86c7-252">ContentKeyAuthorizationPolicy containing the specification on how license delivery verifies a JWT token and DRM license specifications;</span></span>
2. <span data-ttu-id="d86c7-253">AssetDeliveryPolicy contenente le specifiche sul formato di streaming, sulla protezione DRM e sugli URL di acquisizione delle licenze.</span><span class="sxs-lookup"><span data-stu-id="d86c7-253">AssetDeliveryPolicy containing specifications on streaming format, DRM protection and license acquisition URLs.</span></span>

<span data-ttu-id="d86c7-254">Durante la fase di esecuzione, il flusso è il seguente:</span><span class="sxs-lookup"><span data-stu-id="d86c7-254">During runtime, the flow is as below:</span></span>

1. <span data-ttu-id="d86c7-255">Durante l'autenticazione utente, viene generato un token JWT.</span><span class="sxs-lookup"><span data-stu-id="d86c7-255">Upon user authentication, a JWT token is generated;</span></span>
2. <span data-ttu-id="d86c7-256">Una delle attestazioni contenuta nel token JWT è l'attestazione "groups" contenente l'ID oggetto gruppo di "EntitledUserGroup".</span><span class="sxs-lookup"><span data-stu-id="d86c7-256">One of the claims contained in the JWT token is “groups” claim containing the group object ID of “EntitledUserGroup”.</span></span> <span data-ttu-id="d86c7-257">Questa attestazione verrà usata per superare il controllo "entitlement check".</span><span class="sxs-lookup"><span data-stu-id="d86c7-257">This claim will be used for passing “entitlement check”.</span></span>
3. <span data-ttu-id="d86c7-258">Il lettore scarica il manifesto client di un contenuto protetto da CENC e "vede" quanto segue:</span><span class="sxs-lookup"><span data-stu-id="d86c7-258">Player downloads client manifest of a CENC protected content and “sees” the following:</span></span>

   1. <span data-ttu-id="d86c7-259">ID chiave.</span><span class="sxs-lookup"><span data-stu-id="d86c7-259">key ID,</span></span>
   2. <span data-ttu-id="d86c7-260">Il contenuto è protetto da CENC.</span><span class="sxs-lookup"><span data-stu-id="d86c7-260">the content is CENC protected,</span></span>
   3. <span data-ttu-id="d86c7-261">URL di acquisizione delle licenze.</span><span class="sxs-lookup"><span data-stu-id="d86c7-261">License acquisition URLs.</span></span>
4. <span data-ttu-id="d86c7-262">Il lettore crea una richiesta di acquisizione della licenza basata sul browser/DRM supportato.</span><span class="sxs-lookup"><span data-stu-id="d86c7-262">Player makes a license acquisition request based on the browser/DRM supported.</span></span> <span data-ttu-id="d86c7-263">Nella richiesta di acquisizione della licenza verranno inviati anche l'ID chiave e il token JWT.</span><span class="sxs-lookup"><span data-stu-id="d86c7-263">In the license acquisition request, key ID and the JWT token will also be submitted.</span></span> <span data-ttu-id="d86c7-264">Il servizio di distribuzione delle licenze verificherà il token JWT e le attestazioni contenute prima di rilasciare la licenza necessaria.</span><span class="sxs-lookup"><span data-stu-id="d86c7-264">License delivery service will verify the JWT token and the claims contained before issuing the needed license.</span></span>

## <a name="implementation"></a><span data-ttu-id="d86c7-265">Implementazione</span><span class="sxs-lookup"><span data-stu-id="d86c7-265">Implementation</span></span>
### <a name="implementation-procedures"></a><span data-ttu-id="d86c7-266">Procedure di implementazione</span><span class="sxs-lookup"><span data-stu-id="d86c7-266">Implementation procedures</span></span>
<span data-ttu-id="d86c7-267">L'implementazione includerà i passaggi seguenti:</span><span class="sxs-lookup"><span data-stu-id="d86c7-267">The implementation will include the following steps:</span></span>

1. <span data-ttu-id="d86c7-268">Preparare uno o più asset di test: codificare/creare un pacchetto per un video di test in un MP4 frammentato a più velocità in bit in Servizi multimediali di Azure.</span><span class="sxs-lookup"><span data-stu-id="d86c7-268">Prepare test asset(s): encode/package a test video to multi-bitrate fragmented MP4 in Azure Media Services.</span></span> <span data-ttu-id="d86c7-269">Questo asset NON è protetto da DRM.</span><span class="sxs-lookup"><span data-stu-id="d86c7-269">This asset is NOT DRM protected.</span></span> <span data-ttu-id="d86c7-270">La protezione DRM verrà applicata più avanti con la protezione dinamica.</span><span class="sxs-lookup"><span data-stu-id="d86c7-270">DRM protection will be done by dynamic protection later.</span></span>
2. <span data-ttu-id="d86c7-271">Creare l'ID chiave e la chiave simmetrica (facoltativamente dal seme chiave).</span><span class="sxs-lookup"><span data-stu-id="d86c7-271">Create key ID and content key (optionally from key seed).</span></span> <span data-ttu-id="d86c7-272">In questo caso, non è necessario un sistema di gestione delle chiavi perché viene usato un solo set di ID chiave e chiave simmetrica per un paio di asset di test.</span><span class="sxs-lookup"><span data-stu-id="d86c7-272">For our purpose, key management system is not needed since we are dealing with only a single set of key ID and content key for a couple of test assets;</span></span>
3. <span data-ttu-id="d86c7-273">Usare l'API AMS per configurare i servizi di distribuzione delle licenze con DRM multiplo per l'asset di test.</span><span class="sxs-lookup"><span data-stu-id="d86c7-273">Use AMS API to configure multi-DRM license delivery services for the test asset.</span></span> <span data-ttu-id="d86c7-274">Se si usano server licenze personalizzati della società o dei fornitori della società invece dei servizi di licenza in Servizi multimediali di Azure, è possibile saltare questo passaggio e specificare gli URL di acquisizione delle licenze nel passaggio relativo alla configurazione della distribuzione delle licenze.</span><span class="sxs-lookup"><span data-stu-id="d86c7-274">If you are using custom license servers by your company or your company’s vendors instead of license services in Azure Media Services, you can skip this step and specify license acquisition URLs in the step for configuring license delivery.</span></span> <span data-ttu-id="d86c7-275">L'API AMS è necessaria per specificare alcune configurazioni dettagliate, ad esempio la restrizione dei criteri di autorizzazione, i modelli di risposta di licenza per servizi di licenza DRM diversi e così via. Attualmente il portale di Azure non fornisce ancora l'interfaccia utente necessaria per questa configurazione.</span><span class="sxs-lookup"><span data-stu-id="d86c7-275">AMS API is needed to specify some detailed configurations, such as authorization policy restriction, license response templates for different DRM license services, etc. At this time, the Azure portal does not yet provide the needed UI for this configuration.</span></span> <span data-ttu-id="d86c7-276">Le info relative all'API e il codice di esempio sono disponibili nel documento di Julia Kornich: [Uso della crittografia comune dinamica PlayReady e/o Widevine](media-services-protect-with-drm.md).</span><span class="sxs-lookup"><span data-stu-id="d86c7-276">You can find API level info and sample code in Julia Kornich’s document: [Using PlayReady and/or Widevine Dynamic Common Encryption](media-services-protect-with-drm.md).</span></span>
4. <span data-ttu-id="d86c7-277">Usare l'API AMS per configurare i criteri di distribuzione per l'asset di test.</span><span class="sxs-lookup"><span data-stu-id="d86c7-277">Use AMS API to configure asset delivery policy for the test asset.</span></span> <span data-ttu-id="d86c7-278">Le info relative all'API e il codice di esempio sono disponibili nel documento di Julia Kornich: [Uso della crittografia comune dinamica PlayReady e/o Widevine](media-services-protect-with-drm.md).</span><span class="sxs-lookup"><span data-stu-id="d86c7-278">You can find API level info and sample code in Julia Kornich’s document: [Using PlayReady and/or Widevine Dynamic Common Encryption](media-services-protect-with-drm.md).</span></span>
5. <span data-ttu-id="d86c7-279">Creare e configurare un tenant di Azure Active Directory in Azure.</span><span class="sxs-lookup"><span data-stu-id="d86c7-279">Create and configure an Azure Active Directory tenant in Azure;</span></span>
6. <span data-ttu-id="d86c7-280">Creare alcuni account utente e gruppi nel tenant di Azure Active Directory: è consigliabile creare almeno un gruppo "EntitledUser" e aggiungere un utente a questo gruppo.</span><span class="sxs-lookup"><span data-stu-id="d86c7-280">Create a few user accounts and groups in your Azure Active Directory tenant: you should create at least “EntitledUser” group and add a user to this group.</span></span> <span data-ttu-id="d86c7-281">Gli utenti di questo gruppo supereranno il controllo dei diritti durante l'acquisizione della licenza, mentre gli utenti non appartenenti a questo gruppo non riusciranno a superare il controllo di autenticazione e non potranno acquisire alcuna licenza.</span><span class="sxs-lookup"><span data-stu-id="d86c7-281">Users in this group will pass entitlement check in license acquisition and users not in this group will fail to pass authentication check and will not be able to acquire any license.</span></span> <span data-ttu-id="d86c7-282">Essere membro di questo gruppo "EntitledUser" è un'attestazione "groups" obbligatoria nel token JWT rilasciato da Azure AD.</span><span class="sxs-lookup"><span data-stu-id="d86c7-282">Being a member of this “EntitledUser” group is a required “groups” claim in the JWT token issued by Azure AD.</span></span> <span data-ttu-id="d86c7-283">Questo requisito di attestazione deve essere specificato nel passaggio relativo alla configurazione dei servizi di distribuzione di licenze con DRM multiplo.</span><span class="sxs-lookup"><span data-stu-id="d86c7-283">This claim requirement should be specified in configuring multi-DRM license delivery services step.</span></span>
7. <span data-ttu-id="d86c7-284">Creare un'app MVC ASP.NET che ospiterà il lettore video.</span><span class="sxs-lookup"><span data-stu-id="d86c7-284">Create an ASP.NET MVC app which will be hosting your video player.</span></span> <span data-ttu-id="d86c7-285">Questa app ASP.NET verrà protetta con l'autenticazione utente nel tenant di Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="d86c7-285">This ASP.NET app will be protected with user authentication against the Azure Active Directory tenant.</span></span> <span data-ttu-id="d86c7-286">Le attestazioni appropriate verranno incluse nei token di accesso ottenuti dopo l'autenticazione utente.</span><span class="sxs-lookup"><span data-stu-id="d86c7-286">Proper claims will be included in the access tokens obtained after user authentication.</span></span> <span data-ttu-id="d86c7-287">Per questo passaggio, è consigliata l'API OpenID Connect.</span><span class="sxs-lookup"><span data-stu-id="d86c7-287">OpenID Connect API is recommended for this step.</span></span> <span data-ttu-id="d86c7-288">È necessario installare i pacchetti NuGet seguenti:</span><span class="sxs-lookup"><span data-stu-id="d86c7-288">You need to install the following NuGet packages:</span></span>
   * <span data-ttu-id="d86c7-289">Install-Package Microsoft.Azure.ActiveDirectory.GraphClient</span><span class="sxs-lookup"><span data-stu-id="d86c7-289">Install-Package Microsoft.Azure.ActiveDirectory.GraphClient</span></span>
   * <span data-ttu-id="d86c7-290">Install-Package Microsoft.Owin.Security.OpenIdConnect</span><span class="sxs-lookup"><span data-stu-id="d86c7-290">Install-Package Microsoft.Owin.Security.OpenIdConnect</span></span>
   * <span data-ttu-id="d86c7-291">Install-Package Microsoft.Owin.Security.Cookies</span><span class="sxs-lookup"><span data-stu-id="d86c7-291">Install-Package Microsoft.Owin.Security.Cookies</span></span>
   * <span data-ttu-id="d86c7-292">Install-Package Microsoft.Owin.Host.SystemWeb</span><span class="sxs-lookup"><span data-stu-id="d86c7-292">Install-Package Microsoft.Owin.Host.SystemWeb</span></span>
   * <span data-ttu-id="d86c7-293">Install-Package Microsoft.IdentityModel.Clients.ActiveDirectory</span><span class="sxs-lookup"><span data-stu-id="d86c7-293">Install-Package Microsoft.IdentityModel.Clients.ActiveDirectory</span></span>
8. <span data-ttu-id="d86c7-294">Creare un lettore usando l' [API di Azure Media Player](http://amp.azure.net/libs/amp/latest/docs/).</span><span class="sxs-lookup"><span data-stu-id="d86c7-294">Create a player using [Azure Media Player API](http://amp.azure.net/libs/amp/latest/docs/).</span></span> <span data-ttu-id="d86c7-295">[API ProtectionInfo di Azure Media Player](http://amp.azure.net/libs/amp/latest/docs/) consente di specificare la tecnologia DRM da usare in una piattaforma DRM diversa.</span><span class="sxs-lookup"><span data-stu-id="d86c7-295">[Azure Media Player’s ProtectionInfo API](http://amp.azure.net/libs/amp/latest/docs/) allows you to specify which DRM technology to use on different DRM platform.</span></span>
9. <span data-ttu-id="d86c7-296">Testare la matrice:</span><span class="sxs-lookup"><span data-stu-id="d86c7-296">Test matrix:</span></span>

| <span data-ttu-id="d86c7-297">**DRM**</span><span class="sxs-lookup"><span data-stu-id="d86c7-297">**DRM**</span></span> | <span data-ttu-id="d86c7-298">**Browser**</span><span class="sxs-lookup"><span data-stu-id="d86c7-298">**Browser**</span></span> | <span data-ttu-id="d86c7-299">**Risultato per un utente idoneo**</span><span class="sxs-lookup"><span data-stu-id="d86c7-299">**Result for Entitled User**</span></span> | <span data-ttu-id="d86c7-300">**Risultato per un utente non idoneo**</span><span class="sxs-lookup"><span data-stu-id="d86c7-300">**Result for Un-entitled User**</span></span> |
| --- | --- | --- | --- |
| <span data-ttu-id="d86c7-301">**PlayReady**</span><span class="sxs-lookup"><span data-stu-id="d86c7-301">**PlayReady**</span></span> |<span data-ttu-id="d86c7-302">MS Edge o IE11 in Windows 10</span><span class="sxs-lookup"><span data-stu-id="d86c7-302">MS Edge or IE11 on Windows 10</span></span> |<span data-ttu-id="d86c7-303">Succeed</span><span class="sxs-lookup"><span data-stu-id="d86c7-303">Succeed</span></span> |<span data-ttu-id="d86c7-304">Fail</span><span class="sxs-lookup"><span data-stu-id="d86c7-304">Fail</span></span> |
| <span data-ttu-id="d86c7-305">**Widevine**</span><span class="sxs-lookup"><span data-stu-id="d86c7-305">**Widevine**</span></span> |<span data-ttu-id="d86c7-306">Chrome in Windows 10</span><span class="sxs-lookup"><span data-stu-id="d86c7-306">Chrome on Windows 10</span></span> |<span data-ttu-id="d86c7-307">Succeed</span><span class="sxs-lookup"><span data-stu-id="d86c7-307">Succeed</span></span> |<span data-ttu-id="d86c7-308">Fail</span><span class="sxs-lookup"><span data-stu-id="d86c7-308">Fail</span></span> |
| <span data-ttu-id="d86c7-309">**FairPlay**</span><span class="sxs-lookup"><span data-stu-id="d86c7-309">**FairPlay**</span></span> |<span data-ttu-id="d86c7-310">Da definire</span><span class="sxs-lookup"><span data-stu-id="d86c7-310">TBD</span></span> | | |

<span data-ttu-id="d86c7-311">George Trifonov del team di Servizi multimediali di Azure ha scritto un blog con i passaggi dettagliati per configurare Azure Active Directory per un'app lettore ASP.NET MVC: [Integrare l'app basata su OWIN MVC di Servizi multimediali di Azure con Azure Active Directory e limitare la distribuzione di chiavi simmetriche in base ad attestazioni JWT](http://gtrifonov.com/2015/01/24/mvc-owin-azure-media-services-ad-integration/).</span><span class="sxs-lookup"><span data-stu-id="d86c7-311">George Trifonov of Azure Media Services Team has written a blog providing detailed steps in setting up Azure Active Directory for an ASP.NET MVC player app: [Integrate Azure Media Services OWIN MVC based app with Azure Active Directory and restrict content key delivery based on JWT claims](http://gtrifonov.com/2015/01/24/mvc-owin-azure-media-services-ad-integration/).</span></span>

<span data-ttu-id="d86c7-312">George ha scritto anche un blog relativo all' [autenticazione di token JWT in Servizi multimediali di Azure e alla crittografia dinamica](http://gtrifonov.com/2015/01/03/jwt-token-authentication-in-azure-media-services-and-dynamic-encryption/).</span><span class="sxs-lookup"><span data-stu-id="d86c7-312">George has also written a blog on [JWT token Authentication in Azure Media Services and Dynamic Encryption](http://gtrifonov.com/2015/01/03/jwt-token-authentication-in-azure-media-services-and-dynamic-encryption/).</span></span> <span data-ttu-id="d86c7-313">Qui invece è disponibile il suo [esempio di integrazione di Azure AD con la distribuzione delle chiavi di Servizi multimediali di Azure](https://github.com/AzureMediaServicesSamples/Key-delivery-with-AAD-integration/).</span><span class="sxs-lookup"><span data-stu-id="d86c7-313">And here is his [sample on Azure AD integration with Azure Media Services key delivery](https://github.com/AzureMediaServicesSamples/Key-delivery-with-AAD-integration/).</span></span>

<span data-ttu-id="d86c7-314">Per informazioni su Azure Active Directory:</span><span class="sxs-lookup"><span data-stu-id="d86c7-314">For information on Azure Active Directory:</span></span>

* <span data-ttu-id="d86c7-315">Le informazioni per gli sviluppatori sono disponibili nella [Guida per gli sviluppatori di Azure Active Directory](../active-directory/active-directory-developers-guide.md).</span><span class="sxs-lookup"><span data-stu-id="d86c7-315">You can find developer information in [Azure Active Directory Developer’s Guide](../active-directory/active-directory-developers-guide.md).</span></span>
* <span data-ttu-id="d86c7-316">Le informazioni per gli amministratori sono disponibili in [Amministrare la directory di Azure AD](../active-directory/active-directory-administer.md).</span><span class="sxs-lookup"><span data-stu-id="d86c7-316">You can find administrator information in [Administer Your Azure AD Directory](../active-directory/active-directory-administer.md).</span></span>

### <a name="some-gotchas-in-implementation"></a><span data-ttu-id="d86c7-317">Problematiche di implementazione</span><span class="sxs-lookup"><span data-stu-id="d86c7-317">Some gotchas in implementation</span></span>
<span data-ttu-id="d86c7-318">Esistono alcuni "trabocchetti" nell'implementazione.</span><span class="sxs-lookup"><span data-stu-id="d86c7-318">There are some “gotchas” in the implementation.</span></span> <span data-ttu-id="d86c7-319">L'elenco seguente di "trabocchetti" dovrebbe essere d'aiuto per risolvere eventuali problemi.</span><span class="sxs-lookup"><span data-stu-id="d86c7-319">Hopefully the following list of “gotchas” can help you troubleshooting in case you run into issues.</span></span>

1. <span data-ttu-id="d86c7-320">L'URL dell'**autorità di certificazione** deve terminare con **"/"**.</span><span class="sxs-lookup"><span data-stu-id="d86c7-320">**Issuer** URL should end with **"/"**.</span></span>  

    <span data-ttu-id="d86c7-321">**Audience** deve corrispondere all'ID client dell'applicazione lettore ed è anche consigliabile aggiungere **"/"** alla fine dell'URL dell'autorità di certificazione.</span><span class="sxs-lookup"><span data-stu-id="d86c7-321">**Audience** should be the player application client ID and you should also add **"/"** at the end of the issuer URL.</span></span>

        <add key="ida:audience" value="[Application Client ID GUID]" />
        <add key="ida:issuer" value="https://sts.windows.net/[AAD Tenant ID]/" />

    <span data-ttu-id="d86c7-322">In [JWT Decoder](http://jwt.calebb.net/) verranno visualizzati **aud** e **iss** come nel token JWT seguente:</span><span class="sxs-lookup"><span data-stu-id="d86c7-322">In [JWT Decoder](http://jwt.calebb.net/), you should see **aud** and **iss** as below in the JWT token:</span></span>

    ![Primo trabocchetto](./media/media-services-cenc-with-multidrm-access-control/media-services-1st-gotcha.png)
2. <span data-ttu-id="d86c7-324">Aggiungere le autorizzazioni all'applicazione in AAD (nella scheda Configura dell'applicazione).</span><span class="sxs-lookup"><span data-stu-id="d86c7-324">Add Permissions to the application in AAD (on Configure tab of the application).</span></span> <span data-ttu-id="d86c7-325">Questa operazione è obbligatoria per ogni applicazione (versioni locali e distribuite).</span><span class="sxs-lookup"><span data-stu-id="d86c7-325">This is required for each application (local and deployed versions).</span></span>

    ![Secondo trabocchetto](./media/media-services-cenc-with-multidrm-access-control/media-services-perms-to-other-apps.png)
3. <span data-ttu-id="d86c7-327">Usare l'autorità di certificazione corretta durante la configurazione della protezione CENC dinamica:</span><span class="sxs-lookup"><span data-stu-id="d86c7-327">Use the right issuer in setting up dynamic CENC protection:</span></span>

        <add key="ida:issuer" value="https://sts.windows.net/[AAD Tenant ID]/"/>

    <span data-ttu-id="d86c7-328">La seguente non funzionerà:</span><span class="sxs-lookup"><span data-stu-id="d86c7-328">The following will not work:</span></span>

        <add key="ida:issuer" value="https://willzhanad.onmicrosoft.com/" />

    <span data-ttu-id="d86c7-329">Il GUID è l'ID tenant di AAD.</span><span class="sxs-lookup"><span data-stu-id="d86c7-329">The GUID is the AAD tenant ID.</span></span> <span data-ttu-id="d86c7-330">Il GUID è presente nel popup Endpoint nel portale di Azure.</span><span class="sxs-lookup"><span data-stu-id="d86c7-330">The GUID can be found in Endpoints popup in Azure portal.</span></span>
4. <span data-ttu-id="d86c7-331">Concedere i privilegi delle attestazioni di appartenenza al gruppo.</span><span class="sxs-lookup"><span data-stu-id="d86c7-331">Grant group membership claims privileges.</span></span> <span data-ttu-id="d86c7-332">Verificare che nel file manifesto dell'applicazione AAD, sia presente quanto segue:</span><span class="sxs-lookup"><span data-stu-id="d86c7-332">Make sure in AAD application manifest file, we have the following</span></span>

    <span data-ttu-id="d86c7-333">"groupMembershipClaims": "All" (il valore predefinito è Null)</span><span class="sxs-lookup"><span data-stu-id="d86c7-333">"groupMembershipClaims": "All",    (the default value is null)</span></span>
5. <span data-ttu-id="d86c7-334">Impostare l'oggetto TokenType appropriato quando si creano i requisiti relativi alle restrizioni.</span><span class="sxs-lookup"><span data-stu-id="d86c7-334">Setting proper TokenType when creating restriction requirements.</span></span>

        objTokenRestrictionTemplate.TokenType = TokenType.JWT;

    <span data-ttu-id="d86c7-335">Dopo l'aggiunta del supporto di JWT (AAD) oltre a SWT (ACS), l'oggetto TokenType predefinito è TokenType.JWT.</span><span class="sxs-lookup"><span data-stu-id="d86c7-335">Since adding support of JWT (AAD) in addition to SWT (ACS), the default TokenType is TokenType.JWT.</span></span> <span data-ttu-id="d86c7-336">Se si usa SWT/ACS, è necessario impostarlo su TokenType.SWT.</span><span class="sxs-lookup"><span data-stu-id="d86c7-336">If you use SWT/ACS, you must set to TokenType.SWT.</span></span>

## <a name="additional-topics-for-implementation"></a><span data-ttu-id="d86c7-337">Argomenti aggiuntivi per l'implementazione</span><span class="sxs-lookup"><span data-stu-id="d86c7-337">Additional Topics for Implementation</span></span>
<span data-ttu-id="d86c7-338">Verranno ora illustrati alcuni argomenti aggiuntivi sulla progettazione e l'implementazione.</span><span class="sxs-lookup"><span data-stu-id="d86c7-338">Next we will disc uss some additional topics in our design and implementation.</span></span>

### <a name="http-or-https"></a><span data-ttu-id="d86c7-339">HTTP o HTTPS?</span><span class="sxs-lookup"><span data-stu-id="d86c7-339">HTTP or HTTPS?</span></span>
<span data-ttu-id="d86c7-340">L'applicazione lettore MVC ASP.NET compilata deve supportare quanto segue:</span><span class="sxs-lookup"><span data-stu-id="d86c7-340">The ASP.NET MVC player application we built must support the following:</span></span>

1. <span data-ttu-id="d86c7-341">Autenticazione utente con Azure AD, che deve usare HTTPS.</span><span class="sxs-lookup"><span data-stu-id="d86c7-341">User authentication through Azure AD which needs to be under HTTPS;</span></span>
2. <span data-ttu-id="d86c7-342">Scambio di token JWT tra il client e Azure AD, che deve usare HTTPS.</span><span class="sxs-lookup"><span data-stu-id="d86c7-342">JWT token exchange between client and Azure AD which needs to be under HTTPS;</span></span>
3. <span data-ttu-id="d86c7-343">Acquisizione della licenza DRM dal client, che deve essere gestita tramite HTTPS se la distribuzione delle licenze avviene tramite Servizi multimediali di Azure.</span><span class="sxs-lookup"><span data-stu-id="d86c7-343">DRM license acquisition by the client which is required to be under HTTPS if license delivery is provided by Azure Media Services.</span></span> <span data-ttu-id="d86c7-344">Naturalmente, la famiglia di prodotti PlayReady non obbliga a usare HTTPS per la distribuzione delle licenze.</span><span class="sxs-lookup"><span data-stu-id="d86c7-344">Of course, PlayReady product suite does not mandate HTTPS for license delivery.</span></span> <span data-ttu-id="d86c7-345">Se il server delle licenze PlayReady non rientra nei Servizi multimediali di Azure, usare HTTP o HTTPS.</span><span class="sxs-lookup"><span data-stu-id="d86c7-345">If your PlayReady license server is outside of Azure Media Services, either HTTP or HTTPS could be used.</span></span>

<span data-ttu-id="d86c7-346">L'applicazione lettore ASP.NET dovrà quindi usare HTTPS come procedura consigliata.</span><span class="sxs-lookup"><span data-stu-id="d86c7-346">Therefore, the ASP.NET player application will use HTTPS as a best practice.</span></span> <span data-ttu-id="d86c7-347">Ciò significa che Azure Media Player sarà in una pagina con HTTPS.</span><span class="sxs-lookup"><span data-stu-id="d86c7-347">This means the Azure Media Player will be on a page under HTTPS.</span></span> <span data-ttu-id="d86c7-348">Tuttavia, per lo streaming è preferibile HTTP, perciò è necessario considerare il problema del contenuto misto.</span><span class="sxs-lookup"><span data-stu-id="d86c7-348">However, for streaming we prefer HTTP, hence we need to consider mixed content issue.</span></span>

1. <span data-ttu-id="d86c7-349">Il browser non consente il contenuto misto,</span><span class="sxs-lookup"><span data-stu-id="d86c7-349">Browser does not allow mixed content.</span></span> <span data-ttu-id="d86c7-350">ma lo consentono i plug-in come Silverlight e il plug-in OSMF per Smooth e DASH.</span><span class="sxs-lookup"><span data-stu-id="d86c7-350">But plugins like Silverlight and OSMF plugin for smooth and DASH allow.</span></span> <span data-ttu-id="d86c7-351">Il contenuto misto pone una questione di sicurezza a causa della minaccia derivante dalla possibilità di inserire codice JS dannoso che può mettere a rischio i dati dei clienti.</span><span class="sxs-lookup"><span data-stu-id="d86c7-351">Mixed content is a security concern - This is due to the threat of the ability to inject malicious JS which can cause the customer data to be at risk.</span></span>  <span data-ttu-id="d86c7-352">I browser lo bloccano per impostazione predefinita e finora il solo modo per aggirare il problema è intervenire sul lato server (origine), per consentire tutti i domini (sia https che http),</span><span class="sxs-lookup"><span data-stu-id="d86c7-352">Browsers block this by default and so far the only way to work around it is on the server (origin) side, to allow all domains (regardless https or http).</span></span> <span data-ttu-id="d86c7-353">ma probabilmente nemmeno questa è una buona idea.</span><span class="sxs-lookup"><span data-stu-id="d86c7-353">This is probably not a good idea either.</span></span>
2. <span data-ttu-id="d86c7-354">È consigliabile evitare il contenuto misto: entrambi devono usare HTTP o HTTPS.</span><span class="sxs-lookup"><span data-stu-id="d86c7-354">We should avoid mixed content: either both use HTTP or both use HTTPS.</span></span> <span data-ttu-id="d86c7-355">Quando gestisce il contenuto misto, la tecnologia silverlightSS richiede la cancellazione di un avviso di contenuto misto.</span><span class="sxs-lookup"><span data-stu-id="d86c7-355">When playing mixed content, silverlightSS tech requires clearing a mixed content warning.</span></span> <span data-ttu-id="d86c7-356">La tecnologia flashSS gestisce il contenuto misto senza avvisi di contenuto misto.</span><span class="sxs-lookup"><span data-stu-id="d86c7-356">flashSS tech handles mixed content without mixed content warning.</span></span>
3. <span data-ttu-id="d86c7-357">Se l'endpoint di streaming è stato creato prima di agosto 2014, non supporterà HTTPS.</span><span class="sxs-lookup"><span data-stu-id="d86c7-357">If your streaming endpoint was created before August 2014, it will not support HTTPS.</span></span> <span data-ttu-id="d86c7-358">In questo caso, creare e usare un nuovo endpoint di streaming per HTTPS.</span><span class="sxs-lookup"><span data-stu-id="d86c7-358">In this case, please create and use a new streaming endpoint for HTTPS.</span></span>

<span data-ttu-id="d86c7-359">Nell'implementazione di riferimento, per i contenuti protetti da DRM, sia l'applicazione che il flusso useranno HTTTPS.</span><span class="sxs-lookup"><span data-stu-id="d86c7-359">In the reference implementation, for DRM protected contents, both application and streaming will be under HTTTPS.</span></span> <span data-ttu-id="d86c7-360">Per i contenuti aperti, per il lettore non è necessaria l'autenticazione o la licenza, quindi è possibile usare HTTP o HTTPS.</span><span class="sxs-lookup"><span data-stu-id="d86c7-360">For open contents, the player does not need authentication or license, so you have the liberty to use either HTTP or HTTPS.</span></span>

### <a name="azure-active-directory-signing-key-rollover"></a><span data-ttu-id="d86c7-361">Rollover della chiave per la firma di Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="d86c7-361">Azure Active Directory signing key rollover</span></span>
<span data-ttu-id="d86c7-362">Questo è un aspetto importante da considerare per l'implementazione.</span><span class="sxs-lookup"><span data-stu-id="d86c7-362">This is an important point to take into consideration of your implementation.</span></span> <span data-ttu-id="d86c7-363">In caso contrario, il sistema completato smetterà di funzionare completamente entro 6 settimane al massimo.</span><span class="sxs-lookup"><span data-stu-id="d86c7-363">If you do not consider this in your implementation, the completed system will eventually stop working completely within at most 6 weeks.</span></span>

<span data-ttu-id="d86c7-364">Azure AD usa lo standard di settore per stabilire una relazione di trust tra se stesso e le applicazioni che usano Azure AD.</span><span class="sxs-lookup"><span data-stu-id="d86c7-364">Azure AD uses industry standard to establish trust between itself and applications using Azure AD.</span></span> <span data-ttu-id="d86c7-365">In particolare, Azure AD usa una chiave per la firma costituita da una coppia di chiavi pubblica e privata.</span><span class="sxs-lookup"><span data-stu-id="d86c7-365">Specifically, Azure AD uses a signing key that consists of a public and private key pair.</span></span> <span data-ttu-id="d86c7-366">Quando Azure AD crea un token di sicurezza contenente informazioni sull'utente, questo token viene firmato da Azure AD con la chiave privata prima che venga inviato di nuovo all'applicazione.</span><span class="sxs-lookup"><span data-stu-id="d86c7-366">When Azure AD creates a security token that contains information about the user, this token is signed by Azure AD using its private key before it is sent back to the application.</span></span> <span data-ttu-id="d86c7-367">Per verificare che il token sia valido e sia stato realmente originato da Azure AD, l'applicazione deve convalidare la firma del token usando la chiave pubblica esposta da Azure AD contenuta nel documento di metadati federativi del tenant.</span><span class="sxs-lookup"><span data-stu-id="d86c7-367">To verify that the token is valid and actually originated from Azure AD, the application must validate the token’s signature using the public key exposed by Azure AD that is contained in the tenant’s federation metadata document.</span></span> <span data-ttu-id="d86c7-368">Questa chiave pubblica e la chiave per la firma da cui deriva sono le stesse usate per tutti i tenant in Azure AD.</span><span class="sxs-lookup"><span data-stu-id="d86c7-368">This public key – and the signing key from which it derives – is the same one used for all tenants in Azure AD.</span></span>

<span data-ttu-id="d86c7-369">Informazioni dettagliate sul rollover della chiave di Azure AD sono disponibili nel documento: [Important Information about Signing Key Rollover in Azure AD](../active-directory/active-directory-signing-key-rollover.md)(Informazioni importanti sul rollover della chiave di firma in Azure AD).</span><span class="sxs-lookup"><span data-stu-id="d86c7-369">Detailed info on Azure AD key rollover can be found in the document: [Important Information about Signing Key Rollover in Azure AD](../active-directory/active-directory-signing-key-rollover.md).</span></span>

<span data-ttu-id="d86c7-370">Tra la [coppia di chiavi pubblica-privata](https://login.microsoftonline.com/common/discovery/keys/):</span><span class="sxs-lookup"><span data-stu-id="d86c7-370">Between the [public-private key pair](https://login.microsoftonline.com/common/discovery/keys/),</span></span>

* <span data-ttu-id="d86c7-371">La chiave privata viene usata da Azure Active Directory per generare un token JWT.</span><span class="sxs-lookup"><span data-stu-id="d86c7-371">The private key is used by Azure Active Directory to generate a JWT token;</span></span>
* <span data-ttu-id="d86c7-372">La chiave pubblica viene usata da un'applicazione, ad esempio i servizi di distribuzione delle licenze DRM in AMS, per verificare il token JWT.</span><span class="sxs-lookup"><span data-stu-id="d86c7-372">The public key is used by an application such as DRM License Delivery Services in AMS to verify the JWT token;</span></span>

<span data-ttu-id="d86c7-373">Per motivi di sicurezza, Azure Active Directory fa girare questo certificato periodicamente (ogni 6 settimane).</span><span class="sxs-lookup"><span data-stu-id="d86c7-373">For security purpose, Azure Active Directory rotates this certificate periodically (every 6 weeks).</span></span> <span data-ttu-id="d86c7-374">In caso di violazioni della sicurezza, il rollover della chiave può essere eseguito in qualsiasi momento.</span><span class="sxs-lookup"><span data-stu-id="d86c7-374">In case of security breaches, the key rollover can occur any time.</span></span> <span data-ttu-id="d86c7-375">Quindi i servizi di distribuzione delle licenze in AMS devono aggiornare la chiave pubblica usata quando Azure AD fa ruotare la coppia di chiavi. In caso contrario, l'autenticazione token in AMS non riuscirà e non verrà rilasciata alcuna licenza.</span><span class="sxs-lookup"><span data-stu-id="d86c7-375">Therefore, the license delivery services in AMS need to update the public key used as Azure AD rotates the key pair, otherwise token authentication in AMS will fail and no license will be issued.</span></span>

<span data-ttu-id="d86c7-376">Questo risultato viene ottenuto impostando TokenRestrictionTemplate.OpenIdConnectDiscoveryDocument quando si configurano i servizi di distribuzione delle licenze DRM.</span><span class="sxs-lookup"><span data-stu-id="d86c7-376">This is achieved by setting TokenRestrictionTemplate.OpenIdConnectDiscoveryDocument when configuring DRM license delivery services.</span></span>

<span data-ttu-id="d86c7-377">Il flusso del token JWT è il seguente:</span><span class="sxs-lookup"><span data-stu-id="d86c7-377">The JWT token flow is as below:</span></span>

1. <span data-ttu-id="d86c7-378">Azure AD rilascerà il token JWT con la chiave privata corrente per un utente autenticato.</span><span class="sxs-lookup"><span data-stu-id="d86c7-378">Azure AD will issue the JWT token with the current private key for an authenticated user;</span></span>
2. <span data-ttu-id="d86c7-379">Quando un lettore visualizza un contenuto protetto da CENC con DRM multiplo, individuerà prima il token JWT rilasciato da Azure AD.</span><span class="sxs-lookup"><span data-stu-id="d86c7-379">When a player sees a CENC with multi-DRM protected content, it will first locate the JWT token issued by Azure AD.</span></span>
3. <span data-ttu-id="d86c7-380">Il lettore invia la richiesta di acquisizione della licenza con il token JWT ai servizi di distribuzione delle licenze in AMS.</span><span class="sxs-lookup"><span data-stu-id="d86c7-380">The player sends license acquisition request with the JWT token to license delivery services in AMS;</span></span>
4. <span data-ttu-id="d86c7-381">I servizi di distribuzione delle licenze in AMS useranno la chiave pubblica corrente/valida di Azure AD per verificare il token JWT, prima di rilasciare le licenze.</span><span class="sxs-lookup"><span data-stu-id="d86c7-381">The license delivery services in AMS will use the current/valid public key from Azure AD to verify the JWT token, before issuing licenses.</span></span>

<span data-ttu-id="d86c7-382">I servizi di distribuzione delle licenze DRM cercheranno sempre la chiave pubblica corrente/valida di Azure AD.</span><span class="sxs-lookup"><span data-stu-id="d86c7-382">DRM license delivery services will always be checking for the current/valid public key from Azure AD.</span></span> <span data-ttu-id="d86c7-383">La chiave pubblica presentata da Azure AD sarà la chiave usata per verificare un token JWT rilasciato da Azure AD.</span><span class="sxs-lookup"><span data-stu-id="d86c7-383">The public key presented by Azure AD will be the key used for verifying a JWT token issued by Azure AD.</span></span>

<span data-ttu-id="d86c7-384">Che cosa accade se il rollover della chiave viene eseguito dopo che AAD ha generato un token JWT, ma prima che il token JWT venga inviato dai lettori ai servizi di distribuzione delle licenze DRM in AMS per la verifica?</span><span class="sxs-lookup"><span data-stu-id="d86c7-384">What if the key rollover happens after AAD generates a JWT token but before the JWT token is sent by players to DRM license delivery services in AMS for verification?</span></span>

<span data-ttu-id="d86c7-385">Poiché il rollover di una chiave può essere eseguito in qualsiasi momento, nel documento di metadati federativi è sempre disponibile più di una chiave pubblica valida.</span><span class="sxs-lookup"><span data-stu-id="d86c7-385">Because a key may be rolled at any moment, there is always more than one valid public key available in the federation metadata document.</span></span> <span data-ttu-id="d86c7-386">La distribuzione delle licenze di Servizi multimediali di Azure può usare qualsiasi chiave specificata nel documento, perché di una chiave può essere eseguito il rollover a breve, un'altra può essere quella sostitutiva e così via.</span><span class="sxs-lookup"><span data-stu-id="d86c7-386">Azure Media Services license delivery can use any of the keys specified in the document, since one key may be rolled soon, another may be its replacement, and so forth.</span></span>

### <a name="where-is-the-access-token"></a><span data-ttu-id="d86c7-387">Dov'è il token di accesso?</span><span class="sxs-lookup"><span data-stu-id="d86c7-387">Where is the Access Token?</span></span>
<span data-ttu-id="d86c7-388">Se si esamina come un'app Web chiama un'app per le API in [Identità applicazione con concessione delle credenziali client OAuth 2.0](../active-directory/develop/active-directory-authentication-scenarios.md#web-application-to-web-api), il flusso di autenticazione è il seguente:</span><span class="sxs-lookup"><span data-stu-id="d86c7-388">If you look at how a web app calls an API app under [Application Identity with OAuth 2.0 Client Credentials Grant](../active-directory/develop/active-directory-authentication-scenarios.md#web-application-to-web-api), the authentication flow is as below:</span></span>

1. <span data-ttu-id="d86c7-389">Un utente esegue l'accesso ad Azure AD nell'applicazione Web (vedere [Da Web browser ad applicazione Web](../active-directory/develop/active-directory-authentication-scenarios.md#web-browser-to-web-application)).</span><span class="sxs-lookup"><span data-stu-id="d86c7-389">A user is signed in to Azure AD in the web application (see the [Web Browser to Web Application](../active-directory/develop/active-directory-authentication-scenarios.md#web-browser-to-web-application).</span></span>
2. <span data-ttu-id="d86c7-390">L'endpoint di autorizzazione di Azure AD reindirizza di nuovo l'agente utente all'applicazione client con un codice di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="d86c7-390">The Azure AD authorization endpoint redirects the user agent back to the client application with an authorization code.</span></span> <span data-ttu-id="d86c7-391">L'agente utente restituisce il codice di autorizzazione all'URI di reindirizzamento dell'applicazione client.</span><span class="sxs-lookup"><span data-stu-id="d86c7-391">The user agent returns authorization code to the client application’s redirect URI.</span></span>
3. <span data-ttu-id="d86c7-392">L'applicazione Web deve acquisire un token di accesso per l'autenticazione nell'API Web e il recupero della risorsa desiderata.</span><span class="sxs-lookup"><span data-stu-id="d86c7-392">The web application needs to acquire an access token so that it can authenticate to the web API and retrieve the desired resource.</span></span> <span data-ttu-id="d86c7-393">Esegue una richiesta all'endpoint token di Azure AD, fornendo credenziali, ID client e URI ID applicazione dell'API Web.</span><span class="sxs-lookup"><span data-stu-id="d86c7-393">It makes a request to Azure AD’s token endpoint, providing the credential, client ID, and web API’s application ID URI.</span></span> <span data-ttu-id="d86c7-394">Presenta il codice di autorizzazione per dimostrare che l'utente ha acconsentito.</span><span class="sxs-lookup"><span data-stu-id="d86c7-394">It presents the authorization code to prove that the user has consented.</span></span>
4. <span data-ttu-id="d86c7-395">Azure AD autentica l'applicazione e restituisce un token di accesso JWT usato per chiamare l'API Web.</span><span class="sxs-lookup"><span data-stu-id="d86c7-395">Azure AD authenticates the application and returns a JWT access token that is used to call the web API.</span></span>
5. <span data-ttu-id="d86c7-396">Su HTTPS l'applicazione Web usa il token di accesso JWT restituito per aggiungere la stringa JWT con una designazione "Bearer" nell'intestazione dell'autorizzazione della richiesta all'API Web.</span><span class="sxs-lookup"><span data-stu-id="d86c7-396">Over HTTPS, the web application uses the returned JWT access token to add the JWT string with a “Bearer” designation in the Authorization header of the request to the web API.</span></span> <span data-ttu-id="d86c7-397">L'API Web convalida quindi il token JWT e, se la convalida riesce, restituisce la risorsa desiderata.</span><span class="sxs-lookup"><span data-stu-id="d86c7-397">The web API then validates the JWT token, and if validation is successful, returns the desired resource.</span></span>

<span data-ttu-id="d86c7-398">In questo flusso di "identità dell'applicazione" l'API Web confida che l'applicazione Web abbia autenticato l'utente.</span><span class="sxs-lookup"><span data-stu-id="d86c7-398">In this “application identity” flow, the web API trusts that the web application authenticated the user.</span></span> <span data-ttu-id="d86c7-399">Per questo motivo il modello è definito sottosistema attendibile.</span><span class="sxs-lookup"><span data-stu-id="d86c7-399">For this reason, this pattern is called a trusted subsystem.</span></span> <span data-ttu-id="d86c7-400">Il [diagramma in questa pagina](https://docs.microsoft.com/azure/active-directory/active-directory-protocols-oauth-code) illustra come il codice di autorizzazione garantisca il funzionamento del flusso.</span><span class="sxs-lookup"><span data-stu-id="d86c7-400">The [diagram on this page](https://docs.microsoft.com/azure/active-directory/active-directory-protocols-oauth-code) describes how authorization code grant flow works.</span></span>

<span data-ttu-id="d86c7-401">Nell'acquisizione della licenza con la restrizione token si sta seguendo lo stesso modello di sottosistema attendibile.</span><span class="sxs-lookup"><span data-stu-id="d86c7-401">In license acquisition with token restriction, we are following the same trusted subsystem pattern.</span></span> <span data-ttu-id="d86c7-402">E il servizio di distribuzione delle licenze in Servizi multimediali di Azure è la risorsa API Web, ovvero la "risorsa back-end" a cui un'applicazione Web deve accedere.</span><span class="sxs-lookup"><span data-stu-id="d86c7-402">And the license delivery service in Azure Media Services is the web API resource, the “backend resource” a web application needs to access.</span></span> <span data-ttu-id="d86c7-403">Dov'è quindi il token di accesso?</span><span class="sxs-lookup"><span data-stu-id="d86c7-403">So where is the access token?</span></span>

<span data-ttu-id="d86c7-404">In realtà il token di accesso viene ottenuto da Azure AD.</span><span class="sxs-lookup"><span data-stu-id="d86c7-404">Indeed, we are obtaining access token from Azure AD.</span></span> <span data-ttu-id="d86c7-405">Al termine dell'autenticazione utente, viene restituito il codice di autorizzazione.</span><span class="sxs-lookup"><span data-stu-id="d86c7-405">After successful user authentication, authorization code is returned.</span></span> <span data-ttu-id="d86c7-406">Il codice di autorizzazione viene quindi usato, con l'ID client e la chiave app, per ottenere in cambio il token di accesso.</span><span class="sxs-lookup"><span data-stu-id="d86c7-406">The authorization code is then used, together with client ID and app key, to exchange for access token.</span></span> <span data-ttu-id="d86c7-407">Il token di accesso serve per accedere a un'applicazione "puntatore" che punta a un servizio di distribuzione delle licenze di Servizi multimediali di Azure o lo rappresenta.</span><span class="sxs-lookup"><span data-stu-id="d86c7-407">And the access token is for accessing a “pointer” application pointing or representing Azure Media Services license delivery service.</span></span>

<span data-ttu-id="d86c7-408">È necessario registrare e configurare l'app "puntatore" in Azure AD seguendo questa procedura:</span><span class="sxs-lookup"><span data-stu-id="d86c7-408">We need to register and configure the “pointer” app in Azure AD by following the steps below:</span></span>

1. <span data-ttu-id="d86c7-409">Nel tenant di Azure AD</span><span class="sxs-lookup"><span data-stu-id="d86c7-409">In the Azure AD tenant</span></span>

   * <span data-ttu-id="d86c7-410">aggiungere un'applicazione (risorsa) con l'URL di accesso:</span><span class="sxs-lookup"><span data-stu-id="d86c7-410">add an application (resource) with sign-on URL:</span></span>

   <span data-ttu-id="d86c7-411">https://[nome_risorsa].azurewebsites.net/ e</span><span class="sxs-lookup"><span data-stu-id="d86c7-411">https://[resource_name].azurewebsites.net/ and</span></span>

   * <span data-ttu-id="d86c7-412">l'URL dell'ID app:</span><span class="sxs-lookup"><span data-stu-id="d86c7-412">app ID URL:</span></span>

   <span data-ttu-id="d86c7-413">https://[nome_tenant_aad].onmicrosoft.com/[nome_risorsa];</span><span class="sxs-lookup"><span data-stu-id="d86c7-413">https://[aad_tenant_name].onmicrosoft.com/[resource_name];</span></span>
2. <span data-ttu-id="d86c7-414">Aggiungere una nuova chiave per l'app risorsa.</span><span class="sxs-lookup"><span data-stu-id="d86c7-414">Add a new key for the resource app;</span></span>
3. <span data-ttu-id="d86c7-415">Aggiornare il file manifesto dell'app in modo che il valore della proprietà groupMembershipClaims sia il seguente: "groupMembershipClaims": "All".</span><span class="sxs-lookup"><span data-stu-id="d86c7-415">Update the app manifest file so that the groupMembershipClaims property has the following value: "groupMembershipClaims": "All",</span></span>  
4. <span data-ttu-id="d86c7-416">Nell'app Azure AD che punta all'app Web del lettore, nella sezione "Autorizzazioni per altre applicazioni" aggiungere l'app risorsa aggiunta nel passaggio 1.</span><span class="sxs-lookup"><span data-stu-id="d86c7-416">In the Azure AD app pointing to the player web app, in the section “permissions to other applications”, add the resource app which was added in step 1 above.</span></span> <span data-ttu-id="d86c7-417">In "Autorizzazioni delegate" selezionare la casella di controllo "Accedi a [nome_risorsa]".</span><span class="sxs-lookup"><span data-stu-id="d86c7-417">Under “delegated permissions” check “Access [resource_name]” checkmark.</span></span> <span data-ttu-id="d86c7-418">L'app Web avrà così l'autorizzazione per creare i token di accesso per accedere all'app risorsa.</span><span class="sxs-lookup"><span data-stu-id="d86c7-418">This gives the web app permission to create access tokens for accessing the resource app.</span></span> <span data-ttu-id="d86c7-419">È consigliabile eseguire questa operazione sia per la versione locale che per quella distribuita dell'app Web se si sviluppa con Visual Studio e l'app Web di Azure.</span><span class="sxs-lookup"><span data-stu-id="d86c7-419">You should do this for both local and deployed version of the web app if you are developing with Visual Studio and Azure web app.</span></span>

<span data-ttu-id="d86c7-420">Quindi il token JWT rilasciato da Azure AD è in realtà il token di accesso per accedere a questa risorsa "puntatore".</span><span class="sxs-lookup"><span data-stu-id="d86c7-420">Therefore, the JWT token issued by Azure AD is indeed the access token for accessing this “pointer” resource.</span></span>

### <a name="what-about-live-streaming"></a><span data-ttu-id="d86c7-421">Come funziona lo streaming live?</span><span class="sxs-lookup"><span data-stu-id="d86c7-421">What about Live Streaming?</span></span>
<span data-ttu-id="d86c7-422">Nella parte precedente la discussione si è concentrata sugli asset su richiesta.</span><span class="sxs-lookup"><span data-stu-id="d86c7-422">In the above, our discussion has been focusing on on-demand assets.</span></span> <span data-ttu-id="d86c7-423">Come funziona lo streaming live?</span><span class="sxs-lookup"><span data-stu-id="d86c7-423">What about live streaming?</span></span>

<span data-ttu-id="d86c7-424">L'aspetto positivo è che è possibile usare esattamente la stessa progettazione e la stessa implementazione per proteggere lo streaming live in Servizi multimediali di Azure, trattando l'asset associato a un programma come "asset VOD".</span><span class="sxs-lookup"><span data-stu-id="d86c7-424">The good news is that you can use exactly the same design and implementation for protecting live streaming in Azure Media Services, by treating the asset associated with a program as a “VOD asset”.</span></span>

<span data-ttu-id="d86c7-425">In particolare, è risaputo che, per eseguire lo streaming live in Servizi multimediali di Azure, è necessario creare un canale, quindi un programma nel canale.</span><span class="sxs-lookup"><span data-stu-id="d86c7-425">Specifically, it is well known that to do live streaming in Azure Media Services, you need to create a channel, then a program under the channel.</span></span> <span data-ttu-id="d86c7-426">Per creare il programma, è necessario creare un asset che conterrà l'archivio live per il programma.</span><span class="sxs-lookup"><span data-stu-id="d86c7-426">To create the program, you need to create an asset which will contain the live archive for the program.</span></span> <span data-ttu-id="d86c7-427">Per fornire la protezione CENC con DRM multiplo del contenuto live, è sufficiente applicare all'asset la stessa configurazione/elaborazione che si applicherebbe se fosse un "asset VOD" prima di avviare il programma.</span><span class="sxs-lookup"><span data-stu-id="d86c7-427">In order to provide CENC with multi-DRM protection of the live content, all you need to do, is to apply the same setup/processing to the asset as if it was a “VOD asset” before you start the program.</span></span>

### <a name="what-about-license-servers-outside-of-azure-media-services"></a><span data-ttu-id="d86c7-428">Come funzionano i server licenze al di fuori di Servizi multimediali di Azure?</span><span class="sxs-lookup"><span data-stu-id="d86c7-428">What about license servers outside of Azure Media Services?</span></span>
<span data-ttu-id="d86c7-429">I clienti spesso investono in una farm di server licenze nel proprio data center o ospitata da provider di servizi DRM.</span><span class="sxs-lookup"><span data-stu-id="d86c7-429">Often, customers may have invested in license server farm either in their own data center or hosted by DRM service providers.</span></span> <span data-ttu-id="d86c7-430">Fortunatamente, la protezione del contenuto di Servizi multimediali di Azure consente di operare in modalità ibrida: i contenuti sono ospitati e protetti in modo dinamico in Servizi multimediali di Azure, mentre le licenze DRM vengono distribuite da server al di fuori di Servizi multimediali di Azure.</span><span class="sxs-lookup"><span data-stu-id="d86c7-430">Fortunately, Azure Media Services Content Protection allows you to operate in hybrid mode: contents hosted and dynamically protected in Azure Media Services, while DRM licenses are delivered by servers outside Azure Media Services.</span></span> <span data-ttu-id="d86c7-431">In questo caso, considerare le modifiche seguenti:</span><span class="sxs-lookup"><span data-stu-id="d86c7-431">In this case, there are the following considerations of changes:</span></span>

1. <span data-ttu-id="d86c7-432">Secure Token Service deve rilasciare token che siano accettabili e verificabili dalla farm di server licenze.</span><span class="sxs-lookup"><span data-stu-id="d86c7-432">The Secure Token Service needs to issue tokens which are acceptable and can be verified by the license server farm.</span></span> <span data-ttu-id="d86c7-433">Ad esempio, il server licenze Widevine fornito da Axinom richiede uno specifico token JWT contenente un elemento "entitlement message".</span><span class="sxs-lookup"><span data-stu-id="d86c7-433">For example, the Widevine license servers provided by Axinom requires a specific JWT token which contains “entitlement message”.</span></span> <span data-ttu-id="d86c7-434">Per rilasciare tale token JWT, è quindi necessario un servizio token di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="d86c7-434">Therefore, you need to have an STS to issue such JWT token.</span></span> <span data-ttu-id="d86c7-435">Gli autori hanno completato questa implementazione, i cui dettagli sono disponibili nel documento seguente del [Centro di documentazione di Azure](https://azure.microsoft.com/documentation/): [Uso di Axinom per fornire licenze Widevine ai Servizi multimediali di Azure](media-services-axinom-integration.md).</span><span class="sxs-lookup"><span data-stu-id="d86c7-435">The authors have completed such an implementation and you can find the details in the following document in [Azure Documentation Center](https://azure.microsoft.com/documentation/): [Using Axinom to deliver Widevine licenses to Azure Media Services](media-services-axinom-integration.md).</span></span>
2. <span data-ttu-id="d86c7-436">Non è più necessario configurare il servizio di distribuzione delle licenze (ContentKeyAuthorizationPolicy) in Servizi multimediali di Azure.</span><span class="sxs-lookup"><span data-stu-id="d86c7-436">You no longer need to configure license delivery service (ContentKeyAuthorizationPolicy) in Azure Media Services.</span></span> <span data-ttu-id="d86c7-437">È sufficiente fornire gli URL di acquisizione delle licenze (per PlayReady, Widevine e FairPlay) quando si configura AssetDeliveryPolicy durante la configurazione di CENC con DRM multiplo.</span><span class="sxs-lookup"><span data-stu-id="d86c7-437">What you need to do is to provide the license acquisition URLs (for PlayReady, Widevine and FairPlay) when you configure AssetDeliveryPolicy in setting up CENC with multi-DRM.</span></span>

### <a name="what-if-i-want-to-use-a-custom-sts"></a><span data-ttu-id="d86c7-438">Come procedere per usare un servizio token di sicurezza personalizzato?</span><span class="sxs-lookup"><span data-stu-id="d86c7-438">What if I want to use a custom STS?</span></span>
<span data-ttu-id="d86c7-439">Un cliente può scegliere di usare un servizio token di sicurezza personalizzato per fornire i token JWT per diversi morivi.</span><span class="sxs-lookup"><span data-stu-id="d86c7-439">There could be a few reasons that a customer may choose to use a custom STS (Secure Token Service) for providing JWT tokens.</span></span> <span data-ttu-id="d86c7-440">Eccone alcuni:</span><span class="sxs-lookup"><span data-stu-id="d86c7-440">Some of them are:</span></span>

1. <span data-ttu-id="d86c7-441">Il provider di identità (IdP) usato dal cliente non supporta il servizio token di sicurezza.</span><span class="sxs-lookup"><span data-stu-id="d86c7-441">The Identity Provider (IDP) used by the customer does not support STS.</span></span> <span data-ttu-id="d86c7-442">In questo caso un servizio token di sicurezza personalizzato può essere una soluzione.</span><span class="sxs-lookup"><span data-stu-id="d86c7-442">In this case a custom STS may be an option.</span></span>
2. <span data-ttu-id="d86c7-443">Il cliente può avere bisogno di un controllo più flessibile o più rigido nell'integrazione del servizio token di sicurezza con il sistema di fatturazione sottoscrittore del cliente.</span><span class="sxs-lookup"><span data-stu-id="d86c7-443">The customer may need more flexible or tighter control in integrating STS with customer’s subscriber billing system.</span></span> <span data-ttu-id="d86c7-444">Un operatore MVPD, ad esempio, può offrire più pacchetti sottoscrittore OTT, ad esempio Premium, Basic, Sport e così via. L'operatore può associare le attestazioni in un token al pacchetto di un sottoscrittore in modo che siano disponibili solo i contenuti del pacchetto corretto.</span><span class="sxs-lookup"><span data-stu-id="d86c7-444">For example, an MVPD operator may offer multiple OTT subscriber packages such as premium, basic, sports, etc. The operator may want to match the claims in a token with a subscriber’s package so that only contents in the right package is made available.</span></span> <span data-ttu-id="d86c7-445">In questo caso, un servizio token di sicurezza personalizzato fornisce la flessibilità e il controllo necessari.</span><span class="sxs-lookup"><span data-stu-id="d86c7-445">In this case, a custom STS provides the needed flexibility and control.</span></span>

<span data-ttu-id="d86c7-446">Quando si usa un servizio token di sicurezza personalizzato, è necessario apportare due modifiche:</span><span class="sxs-lookup"><span data-stu-id="d86c7-446">Two changes need to be made when using a custom STS:</span></span>

1. <span data-ttu-id="d86c7-447">Quando si configura un servizio di distribuzione delle licenze per un asset, è necessario specificare la chiave di sicurezza usata per la verifica dal servizio token di sicurezza personalizzato (per altri dettagli, vedere di seguito) invece della chiave corrente di Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="d86c7-447">When configuring license delivery service for an asset, you need to specify the security key used for verification by the custom STS (more details below) instead of the current key from Azure Active Directory.</span></span>
2. <span data-ttu-id="d86c7-448">Quando viene generato un token JTW, viene specificata una chiave di sicurezza invece della chiave privata del certificato X509 corrente in Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="d86c7-448">When a JTW token is generated, a security key is specified instead of the private key of the current X509 certificate in Azure Active Directory.</span></span>

<span data-ttu-id="d86c7-449">Esistono due tipi di chiavi di sicurezza:</span><span class="sxs-lookup"><span data-stu-id="d86c7-449">There are two types of security keys:</span></span>

1. <span data-ttu-id="d86c7-450">Chiave simmetrica: la stessa chiave viene usata sia per la generazione che per la verifica di un token JWT.</span><span class="sxs-lookup"><span data-stu-id="d86c7-450">Symmetric key: the same key is used for both generating and verifying a JWT token;</span></span>
2. <span data-ttu-id="d86c7-451">Chiave asimmetrica: un coppia di chiavi pubblica-privata in un certificato X509 viene usata con la chiave privata per la crittografia/generazione di un token JWT e con la chiave pubblica per la verifica del token.</span><span class="sxs-lookup"><span data-stu-id="d86c7-451">Asymmetric key: a public-private key pair in an X509 certificate is used with private key for encrypting/generating a JWT token and the public key for verifying the token.</span></span>

#### <a name="tech-note"></a><span data-ttu-id="d86c7-452">Nota tecnica</span><span class="sxs-lookup"><span data-stu-id="d86c7-452">Tech note</span></span>
<span data-ttu-id="d86c7-453">Se si usa .NET Framework/C# come piattaforma di sviluppo, il certificato X509 usato per la chiave di sicurezza asimmetrica deve avere una lunghezza della chiave pari almeno a 2048 bit.</span><span class="sxs-lookup"><span data-stu-id="d86c7-453">If you use .NET Framework/C# as your development platform, the X509 certificate used for asymmetric security key must have key length at least 2048.</span></span> <span data-ttu-id="d86c7-454">È un requisito della classe System.IdentityModel.Tokens.X509AsymmetricSecurityKey in .NET Framework.</span><span class="sxs-lookup"><span data-stu-id="d86c7-454">This is a requirement of the class System.IdentityModel.Tokens.X509AsymmetricSecurityKey in .NET Framework.</span></span> <span data-ttu-id="d86c7-455">In caso contrario, verrà generata un'eccezione simile alla seguente:</span><span class="sxs-lookup"><span data-stu-id="d86c7-455">Otherwise, the following exception will be thrown:</span></span>

<span data-ttu-id="d86c7-456">IDX10630: 'System.IdentityModel.Tokens.X509AsymmetricSecurityKey' per la firma non può essere inferiore a '2048' bit.</span><span class="sxs-lookup"><span data-stu-id="d86c7-456">IDX10630: The 'System.IdentityModel.Tokens.X509AsymmetricSecurityKey' for signing cannot be smaller than '2048' bits.</span></span>

## <a name="the-completed-system-and-test"></a><span data-ttu-id="d86c7-457">Sistema completato e test</span><span class="sxs-lookup"><span data-stu-id="d86c7-457">The completed system and test</span></span>
<span data-ttu-id="d86c7-458">Verranno illustrati alcuni scenari nel sistema end-to-end completato per offrire ai lettori una panoramica generale del comportamento prima che ottengano un account di accesso.</span><span class="sxs-lookup"><span data-stu-id="d86c7-458">We will walk through a few scenarios in the completed end-to-end system so that readers can have a basic “picture” of the behavior before getting a login account.</span></span>

<span data-ttu-id="d86c7-459">L'applicazione Web del lettore e l'account di accesso sono disponibili [qui](https://openidconnectweb.azurewebsites.net/).</span><span class="sxs-lookup"><span data-stu-id="d86c7-459">The player web application and its login can be found [here](https://openidconnectweb.azurewebsites.net/).</span></span>

<span data-ttu-id="d86c7-460">Se è necessario uno scenario "non integrato" in cui gli asset video sono ospitati in Servizi multimediali di Azure non protetti o protetti da DRM, ma senza autenticazione token (viene rilasciata una licenza a chiunque la richieda), è possibile testarlo senza accedere (passando a HTTP se il flusso video è su HTTP).</span><span class="sxs-lookup"><span data-stu-id="d86c7-460">If what you need is “non-integrated” scenario: video assets hosted in Azure Media Services which are either unprotected, or DRM protected but without token authentication (issuing a license to whoever requesting it), you can test it without login (by switching to HTTP if your video streaming is over HTTP).</span></span>

<span data-ttu-id="d86c7-461">Se è necessario uno scenario end-to-end integrato in cui gli asset video usano la protezione DRM dinamica in Servizi multimediali di Azure, con l'autenticazione token e il token JWT generato da Azure AD, è necessario effettuare l'accesso.</span><span class="sxs-lookup"><span data-stu-id="d86c7-461">If what you need is end-to-end integrated scenario: video assets is under dynamic DRM protection in Azure Media Services, with token authentication and JWT token being generated by Azure AD, you need to login.</span></span>

### <a name="user-login"></a><span data-ttu-id="d86c7-462">Accesso utente</span><span class="sxs-lookup"><span data-stu-id="d86c7-462">User login</span></span>
<span data-ttu-id="d86c7-463">Per testare il sistema DRM end-to-end integrato, è necessario che sia stato creato o aggiunto un "account".</span><span class="sxs-lookup"><span data-stu-id="d86c7-463">In order to test the end-to-end integrated DRM system, you need to have an “account” created or added.</span></span>

<span data-ttu-id="d86c7-464">Quale account?</span><span class="sxs-lookup"><span data-stu-id="d86c7-464">What account?</span></span>

<span data-ttu-id="d86c7-465">Anche se in origine l'accesso ad Azure era consentito solo agli utenti con account Microsoft, ora è invece consentito l'accesso agli utenti di entrambi i sistemi.</span><span class="sxs-lookup"><span data-stu-id="d86c7-465">Although Azure originally allowed access only by Microsoft account users, it now allows access by users from both systems.</span></span> <span data-ttu-id="d86c7-466">A questo scopo, tutte le proprietà di Azure devono considerare Azure AD come attendibile per l'autenticazione, Azure AD deve autenticare gli utenti aziendali e creare una relazione federativa in cui Azure AD considera attendibile il sistema di identità utente degli account Microsoft per autenticare gli utenti privati.</span><span class="sxs-lookup"><span data-stu-id="d86c7-466">This was done by having all the Azure properties trust Azure AD for authentication, having Azure AD authenticate organizational users, and by creating a federation relationship where Azure AD trusts the Microsoft account consumer identity system to authenticate consumer users.</span></span> <span data-ttu-id="d86c7-467">Di conseguenza, Azure AD è ora in grado di autenticare gli account Microsoft "guest" e gli account Azure AD "nativi".</span><span class="sxs-lookup"><span data-stu-id="d86c7-467">As a result, Azure AD is able to authenticate “guest” Microsoft accounts as well as “native” Azure AD accounts.</span></span>

<span data-ttu-id="d86c7-468">Poiché Azure AD considera attendibile il dominio account Microsoft (MSA), è possibile aggiungere qualsiasi account da uno dei domini seguenti al tenant di Azure AD personalizzato e usare l'account per l'accesso:</span><span class="sxs-lookup"><span data-stu-id="d86c7-468">Since Azure AD trusts Microsoft Account (MSA) domain, you can add any accounts from any of the following domains to the custom Azure AD tenant and use the account to login:</span></span>

| <span data-ttu-id="d86c7-469">**Nome di dominio**</span><span class="sxs-lookup"><span data-stu-id="d86c7-469">**Domain Name**</span></span> | <span data-ttu-id="d86c7-470">**Dominio**</span><span class="sxs-lookup"><span data-stu-id="d86c7-470">**Domain**</span></span> |
| --- | --- |
| <span data-ttu-id="d86c7-471">**Dominio del tenant di Azure AD personalizzato**</span><span class="sxs-lookup"><span data-stu-id="d86c7-471">**Custom Azure AD tenant domain**</span></span> |<span data-ttu-id="d86c7-472">nome.onmicrosoft.com</span><span class="sxs-lookup"><span data-stu-id="d86c7-472">somename.onmicrosoft.com</span></span> |
| <span data-ttu-id="d86c7-473">**Dominio aziendale**</span><span class="sxs-lookup"><span data-stu-id="d86c7-473">**Corporate domain**</span></span> |<span data-ttu-id="d86c7-474">microsoft.com</span><span class="sxs-lookup"><span data-stu-id="d86c7-474">microsoft.com</span></span> |
| <span data-ttu-id="d86c7-475">**Dominio account Microsoft (MSA)**</span><span class="sxs-lookup"><span data-stu-id="d86c7-475">**Microsoft Account (MSA) domain**</span></span> |<span data-ttu-id="d86c7-476">outlook.com, live.com, hotmail.com</span><span class="sxs-lookup"><span data-stu-id="d86c7-476">outlook.com, live.com, hotmail.com</span></span> |

<span data-ttu-id="d86c7-477">È possibile contattare gli autori per farsi creare o aggiungere un account.</span><span class="sxs-lookup"><span data-stu-id="d86c7-477">You may contact any of the authors to have an account created or added for you.</span></span>

<span data-ttu-id="d86c7-478">Di seguito sono riportati gli screenshot di alcune pagine di accesso usate da diversi account dominio.</span><span class="sxs-lookup"><span data-stu-id="d86c7-478">Below are the screenshots of different login pages used by different domain accounts.</span></span>

<span data-ttu-id="d86c7-479">**Account dominio del tenant di Azure AD personalizzato**: in questo caso, viene visualizzata la pagina di accesso personalizzata del dominio del tenant di Azure AD.</span><span class="sxs-lookup"><span data-stu-id="d86c7-479">**Custom Azure AD tenant domain account**: In this case, you see the customized login page of the custom Azure AD tenant domain.</span></span>

![Account dominio del tenant di Azure AD personalizzato](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain1.png)

<span data-ttu-id="d86c7-481">**Account dominio Microsoft con smart card**: in questo caso, viene visualizzata la pagina di accesso personalizzata dall'IT aziendale Microsoft con autenticazione a due fattori.</span><span class="sxs-lookup"><span data-stu-id="d86c7-481">**Microsoft domain account with smart card**: In this case you see the login page customized by Microsoft corporate IT with two-factor authentication.</span></span>

![Account dominio del tenant di Azure AD personalizzato](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain2.png)

<span data-ttu-id="d86c7-483">**Account Microsoft (MSA)**: in questo caso, viene visualizzata la pagina di accesso dell'account Microsoft per i clienti.</span><span class="sxs-lookup"><span data-stu-id="d86c7-483">**Microsoft Account (MSA)**: In this case, you see the login page of Microsoft Account for consumers.</span></span>

![Account dominio del tenant di Azure AD personalizzato](./media/media-services-cenc-with-multidrm-access-control/media-services-ad-tenant-domain3.png)

### <a name="using-encrypted-media-extensions-for-playready"></a><span data-ttu-id="d86c7-485">Uso di Encrypted Media Extensions per PlayReady</span><span class="sxs-lookup"><span data-stu-id="d86c7-485">Using Encrypted Media Extensions for PlayReady</span></span>
<span data-ttu-id="d86c7-486">In un browser moderno con il supporto EME (Encrypted Media Extensions) per PlayReady, ad esempio IE 11 in Windows 8.1 e versioni successive e il browser Microsoft Edge in Windows 10, PlayReady sarà il sistema DRM sottostante per EME.</span><span class="sxs-lookup"><span data-stu-id="d86c7-486">On a modern browser with Encrypted Media Extensions (EME) for PlayReady support, such as IE 11 on Windows 8.1 and up, and Microsoft Edge browser on Windows 10, PlayReady will be the underlying DRM for EME.</span></span>

![Uso di EME per PlayReady](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-playready1.png)

<span data-ttu-id="d86c7-488">Nel lettore è presente un'area scura perché la protezione di PlayReady impedisce di acquisire schermate da un video protetto.</span><span class="sxs-lookup"><span data-stu-id="d86c7-488">The dark player area is due to the fact that PlayReady protection prevents one from making screen capture of protected video.</span></span>

<span data-ttu-id="d86c7-489">La schermata seguente mostra i plug-in del lettore e il supporto MSE/EME.</span><span class="sxs-lookup"><span data-stu-id="d86c7-489">The following screen shows the player plugins and MSE/EME support.</span></span>

![Uso di EME per PlayReady](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-playready2.png)

<span data-ttu-id="d86c7-491">EME in Microsoft Edge e IE 11 in Windows 10 consente di chiamare [PlayReady SL3000](https://www.microsoft.com/playready/features/EnhancedContentProtection.aspx/) sui dispositivi Windows 10 che lo supportano.</span><span class="sxs-lookup"><span data-stu-id="d86c7-491">EME in Microsoft Edge and IE 11 on Windows 10 allows invoking of [PlayReady SL3000](https://www.microsoft.com/playready/features/EnhancedContentProtection.aspx/) on Windows 10 devices which support it.</span></span> <span data-ttu-id="d86c7-492">PlayReady SL3000 sblocca il flusso di contenuti premium avanzati (4 KB, HDR e così via) e nuovi modelli di distribuzione dei contenuti (finestra anticipata per contenuti avanzati).</span><span class="sxs-lookup"><span data-stu-id="d86c7-492">PlayReady SL3000 unlocks the flow of enhanced premium content (4K, HDR, etc.) and new content delivery models (early window for Enhanced Content).</span></span>

<span data-ttu-id="d86c7-493">Concentrarsi sui dispositivi Windows: PlayReady è il solo DRM nell'hardware disponibile nei dispositivi Windows (PlayReady SL3000).</span><span class="sxs-lookup"><span data-stu-id="d86c7-493">Focus on the Windows devices: PlayReady is the only DRM in the HW available on Windows devices (PlayReady SL3000).</span></span> <span data-ttu-id="d86c7-494">Un servizio di streaming può usare PlayReady tramite EME o un'applicazione UWP e offrire una migliore qualità video usando PlayReady SL3000 anziché un altro DRM.</span><span class="sxs-lookup"><span data-stu-id="d86c7-494">A streaming service can use PlayReady through EME or through a UWP application and offer a higher video quality using PlayReady SL3000 than another DRM.</span></span> <span data-ttu-id="d86c7-495">In genere, i contenuti 2K passeranno attraverso Chrome o Firefox e i contenuti 4K attraverso Microsoft Edge/IE11 o un'applicazione UWP sullo stesso dispositivo (a seconda delle impostazioni di servizio e dell'implementazione).</span><span class="sxs-lookup"><span data-stu-id="d86c7-495">Typically, 2K content will flow through Chrome or Firefox, and 4K content through Microsoft Edge/IE11 or a UWP application on the same device (depending on service settings and implementation).</span></span>

#### <a name="using-eme-for-widevine"></a><span data-ttu-id="d86c7-496">Uso di EME per Widevine</span><span class="sxs-lookup"><span data-stu-id="d86c7-496">Using EME for Widevine</span></span>
<span data-ttu-id="d86c7-497">In un browser moderno con il supporto EME/Widevine, ad esempio Chrome 41+ in Windows 10, Windows 8.1, Mac OSX Yosemite e Chrome in Android 4.4.4, Google Widevine è il sistema DRM dietro EME.</span><span class="sxs-lookup"><span data-stu-id="d86c7-497">On a modern browser with EME/Widevine support, such as Chrome 41+ on Windows 10, Windows 8.1, Mac OSX Yosemite, and Chrome on Android 4.4.4, Google Widevine is the DRM behind EME.</span></span>

![Uso di EME per Widevine](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-widevine1.png)

<span data-ttu-id="d86c7-499">Si noti che Widevine non impedisce di acquisire schermate da un video protetto.</span><span class="sxs-lookup"><span data-stu-id="d86c7-499">Notice that Widevine does not prevent one from making screen capture of protected video.</span></span>

![Uso di EME per Widevine](./media/media-services-cenc-with-multidrm-access-control/media-services-eme-for-widevine2.png)

### <a name="not-entitled-users"></a><span data-ttu-id="d86c7-501">Utenti non idonei</span><span class="sxs-lookup"><span data-stu-id="d86c7-501">Not entitled users</span></span>
<span data-ttu-id="d86c7-502">Se un utente non è membro del gruppo di utenti idonei, l'utente non potrà superare il controllo dei diritti e il servizio di licenza con DRM multiplo rifiuterà di rilasciare la licenza richiesta, come illustrato di seguito.</span><span class="sxs-lookup"><span data-stu-id="d86c7-502">If a user is not a member of "Entitled Users" group, the user will not be able to pass “entitlement check” and the multi-DRM license service will refuse to issue the requested license as shown below.</span></span> <span data-ttu-id="d86c7-503">La descrizione dettagliata è "License acquire failed", come previsto dalla progettazione.</span><span class="sxs-lookup"><span data-stu-id="d86c7-503">The detailed description is “License acquire failed”, which is as designed.</span></span>

![Utenti non idonei](./media/media-services-cenc-with-multidrm-access-control/media-services-unentitledusers.png)

### <a name="running-custom-secure-token-service"></a><span data-ttu-id="d86c7-505">Esecuzione del servizio token di sicurezza personalizzato</span><span class="sxs-lookup"><span data-stu-id="d86c7-505">Running custom Secure Token Service</span></span>
<span data-ttu-id="d86c7-506">Per lo scenario dell'esecuzione del servizio token di sicurezza personalizzato, il token JWT verrà rilasciato dal servizio token di sicurezza personalizzato usando la chiave simmetrica o asimmetrica.</span><span class="sxs-lookup"><span data-stu-id="d86c7-506">For the scenario of running custom Secure Token Service (STS), the JWT token will be issued by the custom STS using either symmetric or asymmetric key.</span></span>

<span data-ttu-id="d86c7-507">Uso della chiave simmetrica (con Chrome):</span><span class="sxs-lookup"><span data-stu-id="d86c7-507">The case of using symmetric key (using Chrome):</span></span>

![Esecuzione del servizio token di sicurezza personalizzato](./media/media-services-cenc-with-multidrm-access-control/media-services-running-sts1.png)

<span data-ttu-id="d86c7-509">Uso della chiave asimmetrica tramite un certificato X509 (con un browser Microsoft moderno).</span><span class="sxs-lookup"><span data-stu-id="d86c7-509">The case of using asymmetric key via an X509 certificate (using Microsoft modern browser).</span></span>

![Esecuzione del servizio token di sicurezza personalizzato](./media/media-services-cenc-with-multidrm-access-control/media-services-running-sts2.png)

<span data-ttu-id="d86c7-511">In entrambi i casi precedenti, l'autenticazione utente è la stessa, ovvero tramite Azure AD.</span><span class="sxs-lookup"><span data-stu-id="d86c7-511">In both of the above cases, user authentication stays the same – through Azure AD.</span></span> <span data-ttu-id="d86c7-512">L'unica differenza è che i token JWT vengono rilasciati dal servizio token di sicurezza personalizzato invece che da Azure AD.</span><span class="sxs-lookup"><span data-stu-id="d86c7-512">The only difference is that JWT tokens are issued by the custom STS instead of Azure AD.</span></span> <span data-ttu-id="d86c7-513">Ovviamente, quando si configura la protezione CENC dinamica, la restrizione del servizio di distribuzione delle licenze specifica il tipo di token JWT, una chiave simmetrica o asimmetrica.</span><span class="sxs-lookup"><span data-stu-id="d86c7-513">Of course, when configuring dynamic CENC protection, the restriction of license delivery service specifies the type of JWT token, either symmetric or asymmetric key.</span></span>

## <a name="summary"></a><span data-ttu-id="d86c7-514">Riepilogo</span><span class="sxs-lookup"><span data-stu-id="d86c7-514">Summary</span></span>
<span data-ttu-id="d86c7-515">In questo documento è stata illustrata la crittografia CENC con DRM nativo multiplo e il controllo di accesso tramite l'autenticazione token: la progettazione e l'implementazione con Azure, Servizi multimediali di Azure e Azure Media Player.</span><span class="sxs-lookup"><span data-stu-id="d86c7-515">In this document, we discussed CENC with multi-native-DRM and access control via token authentication: its design and its implementation using Azure, Azure Media Services and Azure Media Player.</span></span>

* <span data-ttu-id="d86c7-516">È stata presentata una progettazione di riferimento contenente tutti i componenti necessari nel sottosistema DRM/CENC.</span><span class="sxs-lookup"><span data-stu-id="d86c7-516">A reference design is presented which contains all the necessary components in a DRM/CENC subsystem;</span></span>
* <span data-ttu-id="d86c7-517">Implementazione di riferimento in Azure, Servizi multimediali di Azure e Azure Media Player.</span><span class="sxs-lookup"><span data-stu-id="d86c7-517">A reference implementation on Azure, Azure Media Services and Azure Media Player.</span></span>
* <span data-ttu-id="d86c7-518">Sono stati illustrati anche alcuni argomenti direttamente collegati alla progettazione e all'implementazione.</span><span class="sxs-lookup"><span data-stu-id="d86c7-518">Some topics directly involved in the design and implementation are also discussed.</span></span>

## <a name="media-services-learning-paths"></a><span data-ttu-id="d86c7-519">Percorsi di apprendimento di Servizi multimediali</span><span class="sxs-lookup"><span data-stu-id="d86c7-519">Media Services learning paths</span></span>
[!INCLUDE [media-services-learning-paths-include](../../includes/media-services-learning-paths-include.md)]

## <a name="provide-feedback"></a><span data-ttu-id="d86c7-520">Fornire commenti e suggerimenti</span><span class="sxs-lookup"><span data-stu-id="d86c7-520">Provide feedback</span></span>
[!INCLUDE [media-services-user-voice-include](../../includes/media-services-user-voice-include.md)]
 
