---
title: Eseguire il failback di una macchina virtuale VMware da Azure al sito locale | Microsoft Docs
description: Informazioni sul failback nel sito locale dopo il failover dei server fisici e delle macchine virtuali VMware in Azure.
services: site-recovery
documentationcenter: 
author: ruturaj
manager: mkjain
editor: 
ms.assetid: 5a47337f-89a9-43e8-8fdc-7da373c0fb0f
ms.service: site-recovery
ms.devlang: na
ms.tgt_pltfrm: na
ms.topic: article
ms.workload: storage-backup-recovery
ms.date: 03/27/2017
ms.author: ruturajd
ms.openlocfilehash: dde0bb6b4f6bc10afdd7d40adc6689d42b37de81
ms.sourcegitcommit: 02e69c4a9d17645633357fe3d46677c2ff22c85a
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/03/2017
---
# <a name="fail-back-vmware-virtual-machines-and-physical-servers-to-the-on-premises-site"></a><span data-ttu-id="b8811-103">Eseguire il failback di server fisici e macchine virtuali VMware nel sito locale</span><span class="sxs-lookup"><span data-stu-id="b8811-103">Fail back VMware virtual machines and physical servers to the on-premises site</span></span>


<span data-ttu-id="b8811-104">Questo articolo descrive come eseguire il failback di macchine virtuali di Azure da Azure al sito locale.</span><span class="sxs-lookup"><span data-stu-id="b8811-104">This article describes how to failback Azure virtual machines from Azure to the on-premises site.</span></span> <span data-ttu-id="b8811-105">Seguire le istruzioni riportate di seguito per eseguire il failback delle macchine virtuali VMware o dei server fisici Windows o Linux dopo avere riprotetto i computer seguendo queste [informazioni di riferimento](site-recovery-how-to-reprotect.md).</span><span class="sxs-lookup"><span data-stu-id="b8811-105">Follow the instructions here when you're ready to fail back your VMware virtual machines or Windows or Linux physical servers after you have re-protected your machines using this [reference](site-recovery-how-to-reprotect.md).</span></span>

>[!NOTE]
><span data-ttu-id="b8811-106">Se si usa il portale di Azure classico, vedere le istruzioni indicate [qui](site-recovery-failback-azure-to-vmware-classic.md) per l'architettura avanzata da VMware ad Azure e [qui](site-recovery-failback-azure-to-vmware-classic-legacy.md) per l'architettura legacy</span><span class="sxs-lookup"><span data-stu-id="b8811-106">If you are using the classic Azure portal, please refer to instructions mentioned [here](site-recovery-failback-azure-to-vmware-classic.md) for enhanced VMware to Azure architecture and [here](site-recovery-failback-azure-to-vmware-classic-legacy.md) for the legacy architecture</span></span>

## <a name="overview"></a><span data-ttu-id="b8811-107">Panoramica</span><span class="sxs-lookup"><span data-stu-id="b8811-107">Overview</span></span>
<span data-ttu-id="b8811-108">I diagrammi riportati in questa sezione illustrano l'architettura di failback per questo scenario.</span><span class="sxs-lookup"><span data-stu-id="b8811-108">The diagrams in this section show the failback architecture for this scenario.</span></span>

<span data-ttu-id="b8811-109">Quando il server di elaborazione è locale e si usa una connessione ExpressRoute di Azure, usare questa architettura:</span><span class="sxs-lookup"><span data-stu-id="b8811-109">When the Process Server is on-premises and you are using an Azure ExpressRoute connection, use this architecture:</span></span>

![Diagramma dell'architettura per ExpressRoute](./media/site-recovery-failback-azure-to-vmware-classic/architecture.png)

<span data-ttu-id="b8811-111">Quando il server di elaborazione è in Azure e si dispone di una rete VPN o di una connessione ExpressRoute, usare questa architettura:</span><span class="sxs-lookup"><span data-stu-id="b8811-111">When the Process Server is on Azure and you have either a VPN or an ExpressRoute connection, use this architecture:</span></span>

![Diagramma dell'architettura per VPN](./media/site-recovery-failback-azure-to-vmware-classic/architecture2.png)

<span data-ttu-id="b8811-113">Per un elenco completo delle porte e il diagramma che illustra l'architettura di failback, fare riferimento all'immagine seguente:</span><span class="sxs-lookup"><span data-stu-id="b8811-113">For a complete list of ports and the failback architecture diagram, refer to the following image:</span></span>

![Failover-Failback - Elenco di tutte le porte](./media/site-recovery-failback-azure-to-vmware-classic/Failover-Failback.png)

<span data-ttu-id="b8811-115">Dopo aver eseguito il failover in Azure, eseguire il failback nel sito locale con i tre passaggi seguenti:</span><span class="sxs-lookup"><span data-stu-id="b8811-115">After you’ve failed over to Azure, you fail back to your on-premises site in three stages:</span></span>

* <span data-ttu-id="b8811-116">**Fase 1**: abilitare la riprotezione delle VM di Azure in modo che inizino la replica nelle macchine virtuali di VMware in esecuzione nel sito locale.</span><span class="sxs-lookup"><span data-stu-id="b8811-116">**Stage 1**: You reprotect the Azure VMs so that they start replicating back to the VMware VMs that are running on your on-premises site.</span></span>
* <span data-ttu-id="b8811-117">**Fase 2**: dopo la replica delle VM di Azure nel sito locale, eseguire un failover per il failback da Azure.</span><span class="sxs-lookup"><span data-stu-id="b8811-117">**Stage 2**: After your Azure VMs are replicated to your on-premises site, you run a failover to fail back from Azure.</span></span>
* <span data-ttu-id="b8811-118">**Fase 3**: dopo aver eseguito il failback dei dati, abilitare la riprotezione delle macchine virtuali locali in cui è stato eseguito il failback, in modo che inizino la replica in Azure.</span><span class="sxs-lookup"><span data-stu-id="b8811-118">**Stage 3**: After your data has failed back, you reprotect the on-premises VMs that you failed back to, so that they start replicating to Azure.</span></span>

### <a name="fail-back-to-the-original-location-or-an-alternate-location"></a><span data-ttu-id="b8811-119">Failback alla posizione originale o a una posizione alternativa</span><span class="sxs-lookup"><span data-stu-id="b8811-119">Fail back to the original location or an alternate location</span></span>
<span data-ttu-id="b8811-120">Dopo aver eseguito il failover di una macchina virtuale VMware è possibile eseguire il failback nella stessa macchina virtuale di origine, se è ancora presente in locale.</span><span class="sxs-lookup"><span data-stu-id="b8811-120">After you fail over a VMware VM, you can fail back to the same source VM if it still exists on-premises.</span></span> <span data-ttu-id="b8811-121">In questo scenario viene eseguito il failback delle sole modifiche differenziali.</span><span class="sxs-lookup"><span data-stu-id="b8811-121">In this scenario, only the deltas are failed back.</span></span>

<span data-ttu-id="b8811-122">Se è stato eseguito il failover di server fisici, il failback viene sempre eseguito in una nuova macchina virtuale VMware.</span><span class="sxs-lookup"><span data-stu-id="b8811-122">If you failed over physical servers, failback is always to a new VMware VM.</span></span> <span data-ttu-id="b8811-123">Prima di eseguire il failback di una computer fisico, ricordare che:</span><span class="sxs-lookup"><span data-stu-id="b8811-123">Before failing back a physical machine, note that:</span></span>
* <span data-ttu-id="b8811-124">Un computer fisico protetto viene restituito come macchina virtuale dopo aver eseguito il failover da Azure in VMware.</span><span class="sxs-lookup"><span data-stu-id="b8811-124">A protected physical machine will come back as a virtual machine when it is failed over back from Azure to VMware.</span></span> <span data-ttu-id="b8811-125">Non è possibile eseguire il failback di un computer fisico Windows Server 2008 R2 SP1 protetto e sottoposto a failover in Azure.</span><span class="sxs-lookup"><span data-stu-id="b8811-125">A Windows Server 2008 R2 SP1 physical machine, if it is protected and failed over to Azure, cannot be failed back.</span></span> <span data-ttu-id="b8811-126">Potrà essere eseguito il failback di un computer Windows Server 2008 R2 SP1 avviato come macchina virtuale in locale.</span><span class="sxs-lookup"><span data-stu-id="b8811-126">A Windows Server 2008 R2 SP1 machine that started as a virtual machine on-premises will be able to fail back.</span></span>
* <span data-ttu-id="b8811-127">È necessario individuare almeno un server di destinazione master e gli host ESX/ESXi necessari per il failback.</span><span class="sxs-lookup"><span data-stu-id="b8811-127">Ensure that you discover at least one master target server along with the necessary ESX/ESXi hosts that you need to fail back to.</span></span>

<span data-ttu-id="b8811-128">Se si esegue il failback nella macchina virtuale originaria è necessario quanto segue:</span><span class="sxs-lookup"><span data-stu-id="b8811-128">If you fail back to the original VM, the following are required:</span></span>

* <span data-ttu-id="b8811-129">Se la macchina virtuale è gestita da un server vCenter, l'host ESX della destinazione master deve avere accesso all'archivio dati delle macchine virtuali.</span><span class="sxs-lookup"><span data-stu-id="b8811-129">If the VM is managed by a vCenter server, the master target's ESX host should have access to the VMs datastore.</span></span>
* <span data-ttu-id="b8811-130">Se la macchina virtuale si trova in un host ESX ma non è gestita da vCenter, il disco rigido della macchina virtuale deve trovarsi in un archivio dati accessibile da parte dell'host della destinazione master.</span><span class="sxs-lookup"><span data-stu-id="b8811-130">If the VM is on an ESX host but isn’t managed by vCenter, the hard disk of the VM must be in a datastore that's accessible by the MT's host.</span></span>
* <span data-ttu-id="b8811-131">Se la macchina virtuale si trova in un host ESX e non usa vCenter, è necessario completare l'individuazione dell'host ESX della destinazione master prima di abilitare la riprotezione.</span><span class="sxs-lookup"><span data-stu-id="b8811-131">If your VM is on an ESX host and doesn't use vCenter, you should complete discovery of the ESX host of the MT before you reprotect.</span></span> <span data-ttu-id="b8811-132">Questa opzione è valida anche per il failback di server fisici.</span><span class="sxs-lookup"><span data-stu-id="b8811-132">This applies if you're failing back physical servers too.</span></span>
* <span data-ttu-id="b8811-133">Se è presente una macchina virtuale locale, è anche possibile eliminarla prima di eseguire il failback.</span><span class="sxs-lookup"><span data-stu-id="b8811-133">Another option (if the on-premises VM exists) is to delete it before you do a failback.</span></span> <span data-ttu-id="b8811-134">Il failback crea quindi una nuova macchina virtuale nello stesso host dell'host ESX di destinazione master.</span><span class="sxs-lookup"><span data-stu-id="b8811-134">Failback then creates a new VM on the same host as the master target ESX host.</span></span>

<span data-ttu-id="b8811-135">Quando si esegue il failback in una posizione alternativa, i dati vengono ripristinati nello stesso archivio dati e nello stesso host ESX usati dal server di destinazione master locale.</span><span class="sxs-lookup"><span data-stu-id="b8811-135">When you fail back to an alternate location, the data is recovered to the same datastore and the same ESX host as that used by the on-premises master target server.</span></span>

## <a name="prerequisites"></a><span data-ttu-id="b8811-136">Prerequisiti</span><span class="sxs-lookup"><span data-stu-id="b8811-136">Prerequisites</span></span>
* <span data-ttu-id="b8811-137">Per eseguire il failback di server fisici e macchine virtuali VMware, è necessario un ambiente VMware.</span><span class="sxs-lookup"><span data-stu-id="b8811-137">To fail back VMware VMs and physical servers, you need a VMware environment.</span></span> <span data-ttu-id="b8811-138">Il failback in un server fisico non è supportato.</span><span class="sxs-lookup"><span data-stu-id="b8811-138">Failing back to a physical server isn’t supported.</span></span>
* <span data-ttu-id="b8811-139">Per eseguire il failback, è necessaria una rete di Azure creata al momento dell'impostazione iniziale della protezione.</span><span class="sxs-lookup"><span data-stu-id="b8811-139">To fail back, you must have created an Azure network when you initially set up protection.</span></span> <span data-ttu-id="b8811-140">Il failback richiede una connessione VPN o ExpressRoute dalla rete di Azure in cui si trovano le macchine virtuali di Azure al sito locale.</span><span class="sxs-lookup"><span data-stu-id="b8811-140">Failback needs a VPN or ExpressRoute connection from the Azure network in which the Azure VMs are located to the on-premises site.</span></span>
* <span data-ttu-id="b8811-141">Se le macchine virtuali in cui si vuole eseguire il failback sono gestite da un server vCenter, assicurarsi di disporre delle autorizzazioni necessarie per l'individuazione di macchine virtuali nei server vCenter.</span><span class="sxs-lookup"><span data-stu-id="b8811-141">If the VMs that you want to fail back to are managed by a vCenter server, make sure that you have the required permissions for discovery of VMs on vCenter servers.</span></span> <span data-ttu-id="b8811-142">Per altre informazioni, vedere [Eseguire la replica di macchine virtuali VMware e server fisici in Azure con Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span><span class="sxs-lookup"><span data-stu-id="b8811-142">For more information, see [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span></span>
* <span data-ttu-id="b8811-143">Se in una macchina virtuale sono presenti snapshot, la riprotezione ha esito negativo.</span><span class="sxs-lookup"><span data-stu-id="b8811-143">If snapshots are present on a VM, reprotection fails.</span></span> <span data-ttu-id="b8811-144">È possibile eliminare gli snapshot o i dischi.</span><span class="sxs-lookup"><span data-stu-id="b8811-144">You can delete the snapshots or the disks.</span></span>
* <span data-ttu-id="b8811-145">Prima di eseguire il failback, creare i componenti seguenti:</span><span class="sxs-lookup"><span data-stu-id="b8811-145">Before you fail back, create these components:</span></span>
  * <span data-ttu-id="b8811-146">**Creare un server di elaborazione in Azure**.</span><span class="sxs-lookup"><span data-stu-id="b8811-146">**Create a Process Server in Azure**.</span></span> <span data-ttu-id="b8811-147">Questo componente è una macchina virtuale di Azure da creare e lasciare in esecuzione durante il failback.</span><span class="sxs-lookup"><span data-stu-id="b8811-147">This component is an Azure VM that you create and keep running during failback.</span></span> <span data-ttu-id="b8811-148">È possibile eliminare la macchina al termine del failback.</span><span class="sxs-lookup"><span data-stu-id="b8811-148">You can delete the VM after failback is complete.</span></span>
  * <span data-ttu-id="b8811-149">**Creare un server di destinazione master**: il server di destinazione master invia e riceve i dati di failback.</span><span class="sxs-lookup"><span data-stu-id="b8811-149">**Create a master target server**: The master target server sends and receives failback data.</span></span> <span data-ttu-id="b8811-150">Nel server di gestione creato in locale è installato un server di destinazione master per impostazione predefinita.</span><span class="sxs-lookup"><span data-stu-id="b8811-150">The management server that you created on-premises has a master target server that's installed by default.</span></span> <span data-ttu-id="b8811-151">Tuttavia, a seconda del volume di traffico sottoposto a failback, potrebbe essere necessario creare un server di destinazione master separato per il failback.</span><span class="sxs-lookup"><span data-stu-id="b8811-151">However, depending on the volume of failed-back traffic, you might need to create a separate master target server for failback.</span></span>
  * <span data-ttu-id="b8811-152">Per creare un server di destinazione master aggiuntivo in esecuzione su Linux, configurare la macchina virtuale Linux prima di installare il server di destinazione master, come descritto di seguito.</span><span class="sxs-lookup"><span data-stu-id="b8811-152">To create an additional master target server that runs on Linux, set up the Linux VM before you install the master target server, as described later.</span></span>
* <span data-ttu-id="b8811-153">Quando si esegue un failback, è necessario un server di configurazione locale.</span><span class="sxs-lookup"><span data-stu-id="b8811-153">A configuration server is required on-premises when you do a failback.</span></span> <span data-ttu-id="b8811-154">Durante il failback, la macchina virtuale deve esistere nel database del server di configurazione.</span><span class="sxs-lookup"><span data-stu-id="b8811-154">During failback, the virtual machine must exist in the configuration server database.</span></span> <span data-ttu-id="b8811-155">Se il database del server di configurazione non contiene nessuna macchina virtuale, il failback ha esito negativo.</span><span class="sxs-lookup"><span data-stu-id="b8811-155">If the configuration server database contains no VM, failback cannot succeed.</span></span> <span data-ttu-id="b8811-156">Assicurarsi pertanto di pianificare backup regolari del server.</span><span class="sxs-lookup"><span data-stu-id="b8811-156">Therefore, ensure that you make regular scheduled backups of your server.</span></span> <span data-ttu-id="b8811-157">In caso di emergenza, è necessario ripristinare il server con lo stesso indirizzo IP in modo che il failback funzioni.</span><span class="sxs-lookup"><span data-stu-id="b8811-157">In a disaster, you need to restore it with the same IP address so that failback works.</span></span>
* <span data-ttu-id="b8811-158">Assicurarsi di configurare l'impostazione disk.enableUUID=true nei **parametri di configurazione** della VM di destinazione master in VMware.</span><span class="sxs-lookup"><span data-stu-id="b8811-158">Set the disk.enableUUID=true setting in **Configuration Parameters** of the master target VM in VMware.</span></span> <span data-ttu-id="b8811-159">Se questa riga non esiste, aggiungerla</span><span class="sxs-lookup"><span data-stu-id="b8811-159">If this row does not exist, add it.</span></span> <span data-ttu-id="b8811-160">Questa impostazione è necessaria per fornire un identificatore univoco universale (UUID) coerente al file del disco della macchina virtuale (VMDK) perché venga installato correttamente.</span><span class="sxs-lookup"><span data-stu-id="b8811-160">This setting is required to provide a consistent universally unique identifier (UUID) to the virtual machine disk (VMDK) file so that it is mounted correctly.</span></span>
* <span data-ttu-id="b8811-161">Prestare attenzione alla condizione "Master target server cannot be storage vMotioned" (Il server di destinazione master non può essere sottoposto a Storage vMotion) che può causare l'esito negativo del failback.</span><span class="sxs-lookup"><span data-stu-id="b8811-161">Be aware of a "Master target server cannot be storage vMotioned" condition, which can cause the failback to fail.</span></span> <span data-ttu-id="b8811-162">La macchina virtuale non può avviarsi perché i dischi non sono stati resi disponibili per la macchina.</span><span class="sxs-lookup"><span data-stu-id="b8811-162">The VM cannot come up because the disks aren't made available to it.</span></span>
* <span data-ttu-id="b8811-163">Aggiungere un'unità, denominata unità di conservazione, nel server di destinazione master.</span><span class="sxs-lookup"><span data-stu-id="b8811-163">Add a drive, called a retention drive, onto the master target server.</span></span> <span data-ttu-id="b8811-164">Aggiungere un disco e formattare l'unità.</span><span class="sxs-lookup"><span data-stu-id="b8811-164">Add a disk, and format the drive.</span></span>

## <a name="failback-policy"></a><span data-ttu-id="b8811-165">Criteri di failback</span><span class="sxs-lookup"><span data-stu-id="b8811-165">Failback policy</span></span>
<span data-ttu-id="b8811-166">Per eseguire la replica locale, sono necessari criteri di failback.</span><span class="sxs-lookup"><span data-stu-id="b8811-166">To replicate back to on-premises, you need a failback policy.</span></span> <span data-ttu-id="b8811-167">Il criterio viene creato automaticamente quando si crea un criterio di direzione incrementale, che viene automaticamente associato al server di configurazione.</span><span class="sxs-lookup"><span data-stu-id="b8811-167">The policy is automatically created when you create a forward direction policy, and it is automatically associated with the configuration server.</span></span> <span data-ttu-id="b8811-168">Non è modificabile.</span><span class="sxs-lookup"><span data-stu-id="b8811-168">It is not editable.</span></span> <span data-ttu-id="b8811-169">Il criterio presenta le impostazioni di replica seguenti:</span><span class="sxs-lookup"><span data-stu-id="b8811-169">The policy has the following replication settings:</span></span>

* <span data-ttu-id="b8811-170">Soglia RPO: 15 minuti</span><span class="sxs-lookup"><span data-stu-id="b8811-170">RPO threshold = 15 minutes</span></span>
* <span data-ttu-id="b8811-171">Conservazione del punto di ripristino: 24 ore</span><span class="sxs-lookup"><span data-stu-id="b8811-171">Recovery point retention = 24 hours</span></span>
* <span data-ttu-id="b8811-172">Frequenza di snapshot coerenti con l'applicazione: 60 minuti</span><span class="sxs-lookup"><span data-stu-id="b8811-172">App consistent snapshot frequency = 60 minutes</span></span>

 ![Impostazioni di replica del criterio di failback](./media/site-recovery-failback-azure-to-vmware-new/failback-policy.png)

## <a name="set-up-a-process-server-in-azure"></a><span data-ttu-id="b8811-174">Configurare un server di elaborazione in Azure</span><span class="sxs-lookup"><span data-stu-id="b8811-174">Set up a Process Server in Azure</span></span>
<span data-ttu-id="b8811-175">Installare un server di elaborazione in Azure per permettere alle macchine virtuali di Azure di rinviare i dati al server di destinazione master locale.</span><span class="sxs-lookup"><span data-stu-id="b8811-175">Install a Process Server in Azure so that the Azure VMs can send the data back to the on-premises master target server.</span></span>

<span data-ttu-id="b8811-176">Se le macchine virtuali sono state protette come risorse classiche (ovvero la macchina virtuale ripristinata in Azure è una VM creata tramite il modello di distribuzione classica), è necessario un server di elaborazione in Azure.</span><span class="sxs-lookup"><span data-stu-id="b8811-176">If you have protected your virtual machines as classic resources (that is, the VM recovered in Azure is a VM that was created by using the classic deployment model), you need a Process Server in Azure.</span></span> <span data-ttu-id="b8811-177">Se le macchine virtuali sono state ripristinate con il tipo di distribuzione di Azure Resource Manager, il server di elaborazione deve avere Resource Manager come tipo di distribuzione.</span><span class="sxs-lookup"><span data-stu-id="b8811-177">If you have recovered the VMs with Azure Resource Manager as the deployment type, the Process Server must have Resource Manager as the deployment type.</span></span> <span data-ttu-id="b8811-178">Il tipo di distribuzione viene selezionato in base alla rete virtuale di Azure in cui si distribuisce il server di elaborazione.</span><span class="sxs-lookup"><span data-stu-id="b8811-178">The deployment type is selected by the Azure virtual network that you deploy the Process Server to.</span></span>

1. <span data-ttu-id="b8811-179">Selezionare il server di configurazione in **Insieme di credenziali** > **Impostazioni** > **Manage Site Recovery Infrastructure (Gestisci infrastruttura di Site Recovery)** (in **Gestisci**) > **Server di configurazione** (sotto **For VMware and Physical Machines**(Per VMware e computer fisici)).</span><span class="sxs-lookup"><span data-stu-id="b8811-179">In **Vault** > **Settings** > **Site Recovery Infrastructure** (under **Manage**) > **Configuration Servers** (under **For VMware and Physical Machines**), select the configuration server.</span></span>
2. <span data-ttu-id="b8811-180">Fare clic su **Server di elaborazione**.</span><span class="sxs-lookup"><span data-stu-id="b8811-180">Click **Process Server**.</span></span>

  ![Pulsante Server di elaborazione](./media/site-recovery-failback-azure-to-vmware-classic/add-processserver.png)
3. <span data-ttu-id="b8811-182">Per la distribuzione del server di elaborazione scegliere la **distribuzione di un server di elaborazione di failback in Azure**.</span><span class="sxs-lookup"><span data-stu-id="b8811-182">Choose to deploy the Process Server as **Deploy a failback Process Server in Azure**.</span></span>
4. <span data-ttu-id="b8811-183">Selezionare la sottoscrizione su cui sono state ripristinate le macchine virtuali.</span><span class="sxs-lookup"><span data-stu-id="b8811-183">Select the subscription that you have recovered the VMs to.</span></span>
5. <span data-ttu-id="b8811-184">Selezionare la rete Azure su cui sono state ripristinate le macchine virtuali.</span><span class="sxs-lookup"><span data-stu-id="b8811-184">Select the Azure network that you have recovered the VMs to.</span></span> <span data-ttu-id="b8811-185">Il server di elaborazione deve trovarsi nella stessa rete in modo che le VM ripristinate e il server di elaborazione possano comunicare.</span><span class="sxs-lookup"><span data-stu-id="b8811-185">The Process Server needs to be in the same network so that the recovered VMs and the Process Server can communicate.</span></span>
6. <span data-ttu-id="b8811-186">Se è stata selezionata una rete del *modello di distribuzione classico*, creare una macchina virtuale tramite il marketplace di Azure e quindi installare il server di elaborazione su di essa.</span><span class="sxs-lookup"><span data-stu-id="b8811-186">If you selected a *classic deployment model* network, create a VM via the Azure Marketplace, and then install the Process Server in it.</span></span>

 ![Finestra "Aggiungere il server di elaborazione"](./media/site-recovery-failback-azure-to-vmware-classic/add-classic.png)

 <span data-ttu-id="b8811-188">Durante la creazione del server di elaborazione, prestare attenzione a quanto segue:</span><span class="sxs-lookup"><span data-stu-id="b8811-188">As you're creating the Process Server, pay attention to the following:</span></span>
 * <span data-ttu-id="b8811-189">Il nome dell'immagine è *Microsoft Azure Site Recovery Process Server V2*.</span><span class="sxs-lookup"><span data-stu-id="b8811-189">The name of the image is *Microsoft Azure Site Recovery Process Server V2*.</span></span> <span data-ttu-id="b8811-190">Selezionare **Classica** come modello di distribuzione.</span><span class="sxs-lookup"><span data-stu-id="b8811-190">Select **Classic** as the deployment model.</span></span>

       ![Select "Classic" as the Process Server deployment model](./media/site-recovery-failback-azure-to-vmware-classic/templatename.png)
 * <span data-ttu-id="b8811-191">Installare il server di elaborazione seguendo le istruzioni in [Eseguire la replica di macchine virtuali VMware e server fisici in Azure con Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span><span class="sxs-lookup"><span data-stu-id="b8811-191">Install the Process Server according to the instructions in [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span></span>
7. <span data-ttu-id="b8811-192">Se si seleziona la rete di Azure *Resource Manager*, distribuire il server di elaborazione immettendo le informazioni seguenti:</span><span class="sxs-lookup"><span data-stu-id="b8811-192">If you select the *Resource Manager* Azure network, deploy the Process Server by providing the following information:</span></span>

  * <span data-ttu-id="b8811-193">Nome del gruppo di risorse a cui si vuole distribuire il server.</span><span class="sxs-lookup"><span data-stu-id="b8811-193">The name of the resource group that you want to deploy the server to</span></span>
  * <span data-ttu-id="b8811-194">Nome host del server.</span><span class="sxs-lookup"><span data-stu-id="b8811-194">The name of the server</span></span>
  * <span data-ttu-id="b8811-195">Nome utente e password per l'accesso al server.</span><span class="sxs-lookup"><span data-stu-id="b8811-195">A username and password for signing in to the server</span></span>
  * <span data-ttu-id="b8811-196">Account di archiviazione in cui distribuire il server.</span><span class="sxs-lookup"><span data-stu-id="b8811-196">The storage account that you want to deploy the server to</span></span>
  * <span data-ttu-id="b8811-197">Subnet e interfaccia di rete a cui eseguire la connessione.</span><span class="sxs-lookup"><span data-stu-id="b8811-197">The subnet and the network interface that you want to connect to it</span></span>
   >[!NOTE]
   ><span data-ttu-id="b8811-198">Nota: è necessario creare un'[interfaccia di rete](../virtual-network/virtual-networks-multiple-nics.md) (NIC) e selezionarla durante la distribuzione del server di elaborazione.</span><span class="sxs-lookup"><span data-stu-id="b8811-198">You must create your own [network interface](../virtual-network/virtual-networks-multiple-nics.md) (NIC) and select it while you are deploying the Process Server.</span></span>

    ![Immettere le informazioni nella finestra di dialogo "Aggiungere il server di elaborazione"](./media/site-recovery-failback-azure-to-vmware-classic/psinputsadd.png)

8. <span data-ttu-id="b8811-200">Fare clic su **OK**.</span><span class="sxs-lookup"><span data-stu-id="b8811-200">Click **OK**.</span></span> <span data-ttu-id="b8811-201">Questa operazione attiva un processo che crea una macchina virtuale del tipo di distribuzione Resource Manager durante l'installazione del server di elaborazione.</span><span class="sxs-lookup"><span data-stu-id="b8811-201">This action triggers a job that creates a Resource Manager deployment type virtual machine during the Process Server setup.</span></span> <span data-ttu-id="b8811-202">Per registrare il server nel server di configurazione, eseguire il programma di installazione all'interno della macchina virtuale seguendo le istruzioni in [Eseguire la replica di macchine virtuali VMware e server fisici in Azure con Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span><span class="sxs-lookup"><span data-stu-id="b8811-202">To register the server to the configuration server, run the setup inside the VM by following the instructions in [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span></span> <span data-ttu-id="b8811-203">Viene anche attivato un processo di distribuzione del server di elaborazione.</span><span class="sxs-lookup"><span data-stu-id="b8811-203">A job to deploy the Process Server is also triggered.</span></span>

  <span data-ttu-id="b8811-204">Il server di elaborazione è riportato nella scheda **Server di configurazione** > **Server associati** > **Server di elaborazione**.</span><span class="sxs-lookup"><span data-stu-id="b8811-204">The Process Server is listed on the **Configuration servers** > **Associated servers** > **Process Servers** tab.</span></span>

    ![](./media/site-recovery-failback-azure-to-vmware-new/pslistingincs.png)

    > [!NOTE]
    > <span data-ttu-id="b8811-205">Il server di elaborazione non è visibile in **VM properties** (Proprietà della macchina virtuale).</span><span class="sxs-lookup"><span data-stu-id="b8811-205">The Process Server isn't visible under **VM properties**.</span></span> <span data-ttu-id="b8811-206">È visibile solo nella scheda **Server** all'interno del server di gestione in cui è registrato.</span><span class="sxs-lookup"><span data-stu-id="b8811-206">It's visible only on the **Servers** tab in the management server that it's registered to.</span></span> <span data-ttu-id="b8811-207">Possono essere necessari circa tra i 10 e i 15 minuti perché il server di elaborazione venga visualizzato.</span><span class="sxs-lookup"><span data-stu-id="b8811-207">It can take 10 to 15 minutes for the Process Server to appear.</span></span>


## <a name="set-up-the-master-target-server-on-premises"></a><span data-ttu-id="b8811-208">Configurare il server di destinazione master in locale</span><span class="sxs-lookup"><span data-stu-id="b8811-208">Set up the master target server on-premises</span></span>
<span data-ttu-id="b8811-209">Il server di destinazione master riceve i dati di failback.</span><span class="sxs-lookup"><span data-stu-id="b8811-209">The master target server receives the failback data.</span></span> <span data-ttu-id="b8811-210">Il server viene installato automaticamente nel server di gestione locale, ma se si esegue il failback di una quantità eccessiva di dati potrebbe essere necessario configurare un server di destinazione master aggiuntivo.</span><span class="sxs-lookup"><span data-stu-id="b8811-210">The server is automatically installed on the on-premises management server, but if you're failing back too much data, you might need to set up an additional master target server.</span></span> <span data-ttu-id="b8811-211">Per configurare un server di destinazione master in locale, procedere come segue:</span><span class="sxs-lookup"><span data-stu-id="b8811-211">To set up a master target server on-premises, do the following:</span></span>

> [!NOTE]
> <span data-ttu-id="b8811-212">Per configurare un server di destinazione master in Linux, passare alla procedura successiva.</span><span class="sxs-lookup"><span data-stu-id="b8811-212">To set up a master target server on Linux, skip to the next procedure.</span></span> <span data-ttu-id="b8811-213">Usare solo il sistema operativo di base CentOS 6.6 come sistema operativo di destinazione master.</span><span class="sxs-lookup"><span data-stu-id="b8811-213">Use only CentOS 6.6 minimal operating system as the master target OS.</span></span>

1. <span data-ttu-id="b8811-214">Se si sta configurando il server di destinazione master su Windows, aprire la pagina di avvio rapido dalla macchina virtuale su cui si sta installando il server di destinazione master.</span><span class="sxs-lookup"><span data-stu-id="b8811-214">If you're setting up the master target server on Windows, open the quick-start page from the VM that you're installing the master target server on.</span></span>
2. <span data-ttu-id="b8811-215">Scaricare il file di installazione per l'installazione guidata unificata di Azure Site Recovery.</span><span class="sxs-lookup"><span data-stu-id="b8811-215">Download the installation file for the Azure Site Recovery Unified Setup wizard.</span></span>
3. <span data-ttu-id="b8811-216">Eseguire la configurazione, quindi in **Prima di iniziare** selezionare **Add additional process servers to scale out deployment** (Aggiungere server di elaborazione per aumentare le istanze di distribuzione).</span><span class="sxs-lookup"><span data-stu-id="b8811-216">Run the setup and, in **Before you begin**, select **Add additional Process Servers to scale out deployment**.</span></span>
4. <span data-ttu-id="b8811-217">Completare la procedura guidata come per la [configurazione del server di gestione](site-recovery-vmware-to-azure-classic.md).</span><span class="sxs-lookup"><span data-stu-id="b8811-217">Complete the wizard in the same way you did when you [set up the management server](site-recovery-vmware-to-azure-classic.md).</span></span> <span data-ttu-id="b8811-218">Nella pagina **Dettagli del server di configurazione** specificare l'indirizzo IP del server di destinazione master e immettere una passphrase per accedere alla macchina virtuale.</span><span class="sxs-lookup"><span data-stu-id="b8811-218">On the **Configuration Server Details** page, specify the IP address of the master target server, and enter a passphrase to access the VM.</span></span>

### <a name="set-up-a-linux-vm-as-the-master-target-server"></a><span data-ttu-id="b8811-219">Configurare una macchina virtuale Linux come server di destinazione master</span><span class="sxs-lookup"><span data-stu-id="b8811-219">Set up a Linux VM as the master target server</span></span>
<span data-ttu-id="b8811-220">Per configurare il server di gestione che esegue il server di destinazione master come macchina virtuale Linux, installare il sistema operativo di base CentOS 6.6.</span><span class="sxs-lookup"><span data-stu-id="b8811-220">To set up the management server running the master target server as a Linux VM, install the CentOS 6.6 minimal operating system.</span></span> <span data-ttu-id="b8811-221">Successivamente, recuperare gli ID SCSI per ogni disco rigido SCSI, installare alcuni pacchetti aggiuntivi e apportare alcune modifiche personalizzate.</span><span class="sxs-lookup"><span data-stu-id="b8811-221">Next, retrieve the SCSI IDs for each SCSI hard disk, install some additional packages, and apply some custom changes.</span></span>

#### <a name="install-centos-66"></a><span data-ttu-id="b8811-222">Installare CentOS 6.6</span><span class="sxs-lookup"><span data-stu-id="b8811-222">Install CentOS 6.6</span></span>

1. <span data-ttu-id="b8811-223">Installare il sistema operativo minimo CentOS 6.6 nella macchina virtuale del server di gestione.</span><span class="sxs-lookup"><span data-stu-id="b8811-223">Install the CentOS 6.6 minimal operating system on the management server VM.</span></span> <span data-ttu-id="b8811-224">Lasciare l'immagine ISO in un'unità DVD e avviare il sistema.</span><span class="sxs-lookup"><span data-stu-id="b8811-224">Keep the ISO on a DVD drive, and boot the system.</span></span> <span data-ttu-id="b8811-225">Ignorare il test dei supporti.</span><span class="sxs-lookup"><span data-stu-id="b8811-225">Skip the media testing.</span></span> <span data-ttu-id="b8811-226">Selezionare **Inglese (Stati Uniti)** come lingua, selezionare **Dispositivi di archiviazione di base**, verificare che il disco rigido non contenga dati importanti e fare clic su **Sì**. Tutti i dati verranno rimossi.</span><span class="sxs-lookup"><span data-stu-id="b8811-226">Select **US English** as the language, select **Basic Storage Devices**, check that the hard drive doesn’t have any important data, click **Yes**, and discard any data.</span></span> <span data-ttu-id="b8811-227">Immettere il nome host del server di gestione e selezionare la scheda di rete del server.</span><span class="sxs-lookup"><span data-stu-id="b8811-227">Enter the host name of the management server, and select the server network adapter.</span></span>  <span data-ttu-id="b8811-228">Nella finestra di dialogo **Modifica del sistema** selezionare **Connetti automaticamente** e aggiungere un indirizzo IP statico, una rete e le impostazioni DNS.</span><span class="sxs-lookup"><span data-stu-id="b8811-228">In the **Editing System** dialog box, select **Connect automatically**, and then add a static IP address, network, and DNS settings.</span></span> <span data-ttu-id="b8811-229">Specificare un fuso orario.</span><span class="sxs-lookup"><span data-stu-id="b8811-229">Specify a time zone.</span></span> <span data-ttu-id="b8811-230">Per accedere al server di gestione, immettere la password radice.</span><span class="sxs-lookup"><span data-stu-id="b8811-230">To access the management server, enter the root password.</span></span>
2. <span data-ttu-id="b8811-231">Quando viene richiesto il tipo di installazione, selezionare **Crea layout personalizzato** come partizione.</span><span class="sxs-lookup"><span data-stu-id="b8811-231">When you're asked what type of installation you want, select **Create Custom Layout** as the partition.</span></span> <span data-ttu-id="b8811-232">Fare clic su **Avanti**.</span><span class="sxs-lookup"><span data-stu-id="b8811-232">Click **Next**.</span></span> <span data-ttu-id="b8811-233">Selezionare **Gratuito** e quindi fare clic su **Crea**.</span><span class="sxs-lookup"><span data-stu-id="b8811-233">Select **Free**, and then click **Create**.</span></span> <span data-ttu-id="b8811-234">Creare **/**, **/var/crash** e **/home partitions** con **FS Type:** **ext4**.</span><span class="sxs-lookup"><span data-stu-id="b8811-234">Create **/**,  **/var/crash**, and **/home partitions** with **FS Type:** **ext4**.</span></span> <span data-ttu-id="b8811-235">Creare la partizione di swapping con **FS Type: swap**.</span><span class="sxs-lookup"><span data-stu-id="b8811-235">Create the swap partition as **FS Type: swap**.</span></span>
3. <span data-ttu-id="b8811-236">Se vengono rilevati dispositivi preesistenti viene visualizzato un messaggio di avviso.</span><span class="sxs-lookup"><span data-stu-id="b8811-236">If pre-existing devices are found, a warning message appears.</span></span> <span data-ttu-id="b8811-237">Fare clic su **Formatta** per formattare l'unità con le impostazioni della partizione.</span><span class="sxs-lookup"><span data-stu-id="b8811-237">Click **Format** to format the drive with the partition settings.</span></span> <span data-ttu-id="b8811-238">Fare clic su **Scrivi modifica su disco** per applicare le modifiche della partizione.</span><span class="sxs-lookup"><span data-stu-id="b8811-238">Click **Write change to disk** to apply the partition changes.</span></span>
4. <span data-ttu-id="b8811-239">Selezionare **Installa caricatore di avvio** > **Avanti** per installare il caricatore di avvio nella partizione radice.</span><span class="sxs-lookup"><span data-stu-id="b8811-239">Select **Install boot loader** > **Next** to install the boot loader on the root partition.</span></span>
5. <span data-ttu-id="b8811-240">Al termine dell'installazione, fare clic su **Riavvia**.</span><span class="sxs-lookup"><span data-stu-id="b8811-240">When the installation is complete, click **Reboot**.</span></span>

#### <a name="retrieve-the-scsi-ids"></a><span data-ttu-id="b8811-241">Recuperare gli ID SCSI</span><span class="sxs-lookup"><span data-stu-id="b8811-241">Retrieve the SCSI IDs</span></span>

1. <span data-ttu-id="b8811-242">Dopo l'installazione, recuperare gli ID SCSI per ogni disco rigido SCSI nella macchina virtuale.</span><span class="sxs-lookup"><span data-stu-id="b8811-242">After the installation, retrieve the SCSI IDs for each SCSI hard disk in the VM.</span></span> <span data-ttu-id="b8811-243">A tale scopo, arrestare la VM del server di gestione.</span><span class="sxs-lookup"><span data-stu-id="b8811-243">To do so, shut down the management server VM.</span></span> <span data-ttu-id="b8811-244">Nelle proprietà della VM in VMware, fare clic con il pulsante destro del mouse sulla voce della VM > **Modifica impostazioni** > **Opzioni**.</span><span class="sxs-lookup"><span data-stu-id="b8811-244">In the VM properties in VMware, right-click the VM entry > **Edit Settings** > **Options**.</span></span>
2. <span data-ttu-id="b8811-245">Selezionare **Avanzate** > **Generale** e quindi fare clic su **Parametri di configurazione**.</span><span class="sxs-lookup"><span data-stu-id="b8811-245">Select **Advanced** > **General item**, and then click **Configuration Parameters**.</span></span> <span data-ttu-id="b8811-246">Quando il computer è in esecuzione questa opzione non è disponibile.</span><span class="sxs-lookup"><span data-stu-id="b8811-246">This option is unavailable when the machine is running.</span></span> <span data-ttu-id="b8811-247">Per rendere l'opzione disponibile, arrestare la macchina.</span><span class="sxs-lookup"><span data-stu-id="b8811-247">For the option to be available, the machine must be shut down.</span></span>
3. <span data-ttu-id="b8811-248">Eseguire una di queste operazioni:</span><span class="sxs-lookup"><span data-stu-id="b8811-248">Do either of the following:</span></span>
 * <span data-ttu-id="b8811-249">Se la riga **disk.EnableUUID** esiste, verificare che il valore sia impostato su **True**, con distinzione tra maiuscole e minuscole.</span><span class="sxs-lookup"><span data-stu-id="b8811-249">If the row **disk.EnableUUID** exists, make sure that the value is set to **True** (case sensitive).</span></span> <span data-ttu-id="b8811-250">Se il valore è già impostato su True, è possibile annullare e testare il comando SCSI in un sistema operativo guest dopo l'avvio.</span><span class="sxs-lookup"><span data-stu-id="b8811-250">If the value is already set to True, you can cancel and test the SCSI command inside a guest operating system after it’s booted.</span></span>
 * <span data-ttu-id="b8811-251">Se la riga **disk.EnableUUID** non esiste, fare clic su **Aggiungi riga** e aggiungerla impostando il valore su **True**.</span><span class="sxs-lookup"><span data-stu-id="b8811-251">If the row **disk.EnableUUID** doesn’t exist, click **Add Row**, and then add it with the **True** value.</span></span> <span data-ttu-id="b8811-252">Non usare le virgolette doppie.</span><span class="sxs-lookup"><span data-stu-id="b8811-252">Don’t use double quotation marks.</span></span>

#### <a name="install-additional-packages"></a><span data-ttu-id="b8811-253">Installare pacchetti aggiuntivi</span><span class="sxs-lookup"><span data-stu-id="b8811-253">Install additional packages</span></span>
<span data-ttu-id="b8811-254">Scaricare e installare pacchetti aggiuntivi.</span><span class="sxs-lookup"><span data-stu-id="b8811-254">Download and install additional packages.</span></span>

1. <span data-ttu-id="b8811-255">Assicurarsi che il server di destinazione master sia connesso a Internet.</span><span class="sxs-lookup"><span data-stu-id="b8811-255">Make sure the master target server is connected to the Internet.</span></span>
2. <span data-ttu-id="b8811-256">Per scaricare e installare i 15 pacchetti dal repository di CentOS, eseguire questo comando: `# yum install –y xfsprogs perl lsscsi rsync wget kexec-tools`.</span><span class="sxs-lookup"><span data-stu-id="b8811-256">To download and install 15 packages from the CentOS repository, run this command: `# yum install –y xfsprogs perl lsscsi rsync wget kexec-tools`.</span></span>
3. <span data-ttu-id="b8811-257">Se le macchine di origine da proteggere eseguono Linux con il file system Reiser o XFS per il dispositivo di avvio o radice, scaricare e installare pacchetti aggiuntivi come indicato di seguito:</span><span class="sxs-lookup"><span data-stu-id="b8811-257">If the source machines you’re protecting are running Linux with a Reiser or XFS file system for the root or boot device, download and install additional packages as follows:</span></span>

   * <span data-ttu-id="b8811-258">\# cd /usr/local</span><span class="sxs-lookup"><span data-stu-id="b8811-258">\# cd /usr/local</span></span>
   * <span data-ttu-id="b8811-259">\# wget [http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm)</span><span class="sxs-lookup"><span data-stu-id="b8811-259">\# wget [http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm)</span></span>
   * <span data-ttu-id="b8811-260">\# wget [http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm)</span><span class="sxs-lookup"><span data-stu-id="b8811-260">\# wget [http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm](http://elrepo.org/linux/elrepo/el6/x86_64/RPMS/reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm)</span></span>
   * <span data-ttu-id="b8811-261">\# rpm –ivh kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm</span><span class="sxs-lookup"><span data-stu-id="b8811-261">\# rpm –ivh kmod-reiserfs-0.0-1.el6.elrepo.x86_64.rpm reiserfs-utils-3.6.21-1.el6.elrepo.x86_64.rpm</span></span>
   * <span data-ttu-id="b8811-262">\# wget [http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_65.rpm](http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_65.rpm)</span><span class="sxs-lookup"><span data-stu-id="b8811-262">\# wget [http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_65.rpm](http://mirror.centos.org/centos/6.6/os/x86_64/Packages/xfsprogs-3.1.1-16.el6.x86_65.rpm)</span></span>
   * <span data-ttu-id="b8811-263">\# rpm –ivh xfsprogs-3.1.1-16.el6.x86_64.rpm</span><span class="sxs-lookup"><span data-stu-id="b8811-263">\# rpm –ivh xfsprogs-3.1.1-16.el6.x86_64.rpm</span></span>
   * <span data-ttu-id="b8811-264">\# yum install device-mapper-multipath (questa operazione è necessaria per abilitare i pacchetti Multipath sul server di destinazione master).</span><span class="sxs-lookup"><span data-stu-id="b8811-264">\# yum install device-mapper-multipath (required to enable multipath packages on the master target server)</span></span>

#### <a name="apply-custom-changes"></a><span data-ttu-id="b8811-265">Applicare modifiche personalizzate</span><span class="sxs-lookup"><span data-stu-id="b8811-265">Apply custom changes</span></span>
<span data-ttu-id="b8811-266">Dopo aver completato i passaggi successivi all'installazione e aver installato i pacchetti, applicare modifiche personalizzate eseguendo queste operazioni:</span><span class="sxs-lookup"><span data-stu-id="b8811-266">After you’ve completed the post-installation steps and installed the packages, apply custom changes by doing the following:</span></span>

1. <span data-ttu-id="b8811-267">Copiare il file binario di RHEL 6-64 Unified Agent nella macchina virtuale.</span><span class="sxs-lookup"><span data-stu-id="b8811-267">Copy the RHEL 6-64 Unified Agent binary to the VM.</span></span> <span data-ttu-id="b8811-268">Eseguire questo comando per decomprimere il file binario: `tar –zxvf <file name>`.</span><span class="sxs-lookup"><span data-stu-id="b8811-268">To untar the binary, run this command: `tar –zxvf <file name>`.</span></span>
2. <span data-ttu-id="b8811-269">Per concedere autorizzazioni, eseguire questo comando: `# chmod 755 ./ApplyCustomChanges.sh`.</span><span class="sxs-lookup"><span data-stu-id="b8811-269">To give permissions, run this command: `# chmod 755 ./ApplyCustomChanges.sh`.</span></span>
3. <span data-ttu-id="b8811-270">Eseguire lo script seguente: `# ./ApplyCustomChanges.sh`.</span><span class="sxs-lookup"><span data-stu-id="b8811-270">Run the following script: `# ./ApplyCustomChanges.sh`.</span></span> <span data-ttu-id="b8811-271">Eseguirlo una sola volta.</span><span class="sxs-lookup"><span data-stu-id="b8811-271">Run it only once.</span></span> <span data-ttu-id="b8811-272">Riavviare il server dopo l'esecuzione dello script.</span><span class="sxs-lookup"><span data-stu-id="b8811-272">After it runs successfully, reboot the server.</span></span>

## <a name="run-the-failback"></a><span data-ttu-id="b8811-273">Eseguire il failback</span><span class="sxs-lookup"><span data-stu-id="b8811-273">Run the failback</span></span>
### <a name="reprotect-the-azure-vms"></a><span data-ttu-id="b8811-274">Abilitare la riprotezione delle macchine virtuali di Azure</span><span class="sxs-lookup"><span data-stu-id="b8811-274">Reprotect the Azure VMs</span></span>
1. <span data-ttu-id="b8811-275">In **Insieme di credenziali**, in **Elementi replicati** fare clic con il pulsante destro del mouse sulla VM di cui è stato eseguito il failover e selezionare **Riproteggi**.</span><span class="sxs-lookup"><span data-stu-id="b8811-275">In **Vault**, in **Replicated items**, right-click the VM that has been failed over, and then select **Re-Protect**.</span></span>
2. <span data-ttu-id="b8811-276">Nel pannello, si può osservare che la direzione della protezione **Da Azure a locale** è già selezionata.</span><span class="sxs-lookup"><span data-stu-id="b8811-276">On the blade, you can see that the direction of protection **Azure to On-premises** is already selected.</span></span>
3. <span data-ttu-id="b8811-277">In **Server di destinazione master** e **Server di elaborazione** selezionare il server di destinazione master locale e il server di elaborazione della VM di Azure.</span><span class="sxs-lookup"><span data-stu-id="b8811-277">In **Master Target Server** and **Process Server**, select the on-premises master target server and the Azure VM Process Server.</span></span>
4. <span data-ttu-id="b8811-278">Selezionare l'archivio dati in cui ripristinare i dischi in locale.</span><span class="sxs-lookup"><span data-stu-id="b8811-278">Select the datastore that you want to recover the disks on-premises to.</span></span> <span data-ttu-id="b8811-279">Usare questa opzione quando la VM locale viene eliminata e devono essere creati nuovi dischi.</span><span class="sxs-lookup"><span data-stu-id="b8811-279">Use this option when the on-premises VM is deleted and you need to create new disks.</span></span> <span data-ttu-id="b8811-280">Ignorare questa opzione se i dischi esistono già, ma è necessario specificare un valore.</span><span class="sxs-lookup"><span data-stu-id="b8811-280">Ignore the option if the disks already exist, but you still need to specify a value.</span></span>
5. <span data-ttu-id="b8811-281">Usare un'unità di conservazione per arrestare i punti temporali in cui la VM viene replicata nel sito locale.</span><span class="sxs-lookup"><span data-stu-id="b8811-281">Use a retention drive to stop the points in time when the VM is replicated back to on-premises.</span></span> <span data-ttu-id="b8811-282">Di seguito si elencano alcuni criteri di un'unità di conservazione.</span><span class="sxs-lookup"><span data-stu-id="b8811-282">Some criteria of a retention drive are listed here.</span></span> <span data-ttu-id="b8811-283">Senza questi criteri, l'unità non viene elencato per il server di destinazione master.</span><span class="sxs-lookup"><span data-stu-id="b8811-283">Without these criteria, the drive is not listed for the master target server.</span></span>

  * <span data-ttu-id="b8811-284">Il volume non deve essere in uso per altri scopi (destinazione di replica e così via).</span><span class="sxs-lookup"><span data-stu-id="b8811-284">Volume shouldn't be in use for any other purpose (target of replication, and so forth).</span></span>
  * <span data-ttu-id="b8811-285">Il volume non deve essere in modalità di blocco</span><span class="sxs-lookup"><span data-stu-id="b8811-285">Volume shouldn't be in lock mode.</span></span>
  * <span data-ttu-id="b8811-286">Il volume non deve essere il volume della cache.</span><span class="sxs-lookup"><span data-stu-id="b8811-286">Volume shouldn't be cache volume.</span></span> <span data-ttu-id="b8811-287">Nel volume non deve esistere un'installazione di destinazione master.</span><span class="sxs-lookup"><span data-stu-id="b8811-287">(The master target installation shouldn't exist on that volume.</span></span> <span data-ttu-id="b8811-288">Il volume di installazione personalizzata del server di elaborazione e del server di destinazione master non è idoneo per il volume di conservazione.</span><span class="sxs-lookup"><span data-stu-id="b8811-288">The Process Server plus master target custom installation volume is not eligible for retention volume.</span></span> <span data-ttu-id="b8811-289">In questo caso, il volume del server di elaborazione e del server di destinazione master è il volume della cache di destinazione master.</span><span class="sxs-lookup"><span data-stu-id="b8811-289">Here, the installed Process Server plus master target volume is the cache volume of the master target.)</span></span>
  * <span data-ttu-id="b8811-290">Il file system del volume non deve essere di tipo FAT e FAT32.</span><span class="sxs-lookup"><span data-stu-id="b8811-290">The volume file system type shouldn't be FAT and FAT32.</span></span>
  * <span data-ttu-id="b8811-291">La capacità del volume deve essere diversa da zero.</span><span class="sxs-lookup"><span data-stu-id="b8811-291">The volume capacity should be non-zero.</span></span>
  * <span data-ttu-id="b8811-292">Il volume di conservazione predefinito per Windows è il volume R.</span><span class="sxs-lookup"><span data-stu-id="b8811-292">The default retention volume for Windows is R volume.</span></span>
  * <span data-ttu-id="b8811-293">Il volume di conservazione predefinito per Linux è /mnt/retention/.</span><span class="sxs-lookup"><span data-stu-id="b8811-293">The default retention volume for Linux is /mnt/retention.</span></span>

6. <span data-ttu-id="b8811-294">I criteri di failback vengono selezionati automaticamente.</span><span class="sxs-lookup"><span data-stu-id="b8811-294">The failback policy is automatically selected.</span></span>
7. <span data-ttu-id="b8811-295">Dopo aver fatto clic su **OK** per avviare la riprotezione, inizia un processo di replica della VM da Azure al sito locale.</span><span class="sxs-lookup"><span data-stu-id="b8811-295">After you click **OK** to begin reprotection, a job begins to replicate the VM from Azure to the on-premises site.</span></span> <span data-ttu-id="b8811-296">È possibile monitorare l'avanzamento nella scheda **Processi** .</span><span class="sxs-lookup"><span data-stu-id="b8811-296">You can track the progress on the **Jobs** tab.</span></span>

<span data-ttu-id="b8811-297">Per eseguire il ripristino in un percorso alternativo, selezionare l'unità di conservazione e l'archivio dati configurati per il server di destinazione master.</span><span class="sxs-lookup"><span data-stu-id="b8811-297">If you want to recover to an alternate location, select the retention drive and datastore that are configured for the master target server.</span></span> <span data-ttu-id="b8811-298">Quando si esegue il failback al sito locale, le macchine virtuali VMware nel piano di protezione di failback usano lo stesso archivio dati del server di destinazione master.</span><span class="sxs-lookup"><span data-stu-id="b8811-298">When you fail back to the on-premises site, the VMware VMs in the failback protection plan use the same datastore as the master target server.</span></span> <span data-ttu-id="b8811-299">Per ripristinare la macchina virtuale di Azure di replica nella stessa macchina virtuale locale, quest'ultima deve già trovarsi nello stesso archivio dati del server di destinazione master.</span><span class="sxs-lookup"><span data-stu-id="b8811-299">If you want to recover the replica Azure VM to the same on-premises VM, the on-premises VM should already be in the same datastore as the master target server.</span></span> <span data-ttu-id="b8811-300">Se non è presente alcuna macchina virtuale in locale, ne viene creata una nuova durante la riprotezione.</span><span class="sxs-lookup"><span data-stu-id="b8811-300">If there's no VM on-premises, a new one is created during reprotection.</span></span>

![Selezionare "Da Azure a locale" nel menu a discesa.](./media/site-recovery-failback-azure-to-vmware-new/reprotectinputs.png)

<span data-ttu-id="b8811-302">È anche possibile eseguire la riprotezione a livello di piano di ripristino.</span><span class="sxs-lookup"><span data-stu-id="b8811-302">You can also reprotect at a recovery plan level.</span></span> <span data-ttu-id="b8811-303">Se si dispone di un gruppo di replica, è possibile riproteggerlo solo usando un piano di ripristino.</span><span class="sxs-lookup"><span data-stu-id="b8811-303">If you have a replication group, you can reprotect it only by using a recovery plan.</span></span> <span data-ttu-id="b8811-304">Per la riprotezione tramite piano di ripristino, usare i valori precedenti per ogni macchina protetta.</span><span class="sxs-lookup"><span data-stu-id="b8811-304">When you reprotect by using a recovery plan, use the previous values for every protected machine.</span></span>

> [!NOTE]
> <span data-ttu-id="b8811-305">I gruppi di replica devono essere riprotetti con la stessa destinazione master.</span><span class="sxs-lookup"><span data-stu-id="b8811-305">Replication groups should be protected back with the same master target.</span></span> <span data-ttu-id="b8811-306">In caso di riprotezione con server di destinazione master diversi, non è possibile determinare un punto temporale.</span><span class="sxs-lookup"><span data-stu-id="b8811-306">If they are protected back with different master target servers, a common point in time cannot be determined for them.</span></span>

### <a name="run-a-failover-to-the-on-premises-site"></a><span data-ttu-id="b8811-307">Eseguire un failover nel sito locale</span><span class="sxs-lookup"><span data-stu-id="b8811-307">Run a failover to the on-premises site</span></span>
<span data-ttu-id="b8811-308">Dopo la riprotezione della macchina virtuale, è possibile avviare un failover da Azure nel sito locale.</span><span class="sxs-lookup"><span data-stu-id="b8811-308">After you reprotect the VM, you can initiate a failover from Azure to on-premises.</span></span>

1. <span data-ttu-id="b8811-309">Nella pagina degli elementi replicati fare clic con il pulsante destro del mouse sulla macchina virtuale e selezionare **Failover non pianificato**.</span><span class="sxs-lookup"><span data-stu-id="b8811-309">On the replicated items page, right-click the virtual machine, and then select **Unplanned Failover**.</span></span>
2. <span data-ttu-id="b8811-310">In **Conferma failover** verificare la direzione del failover (da Azure) e quindi selezionare il punto di ripristino da usare per il failover. Usare il più recente o quello coerente con l'app più recente.</span><span class="sxs-lookup"><span data-stu-id="b8811-310">In **Confirm Failover**, verify the failover direction (from Azure), and then select the recovery point that you want to use for the failover (the latest, or the latest app-consistent recovery point).</span></span> <span data-ttu-id="b8811-311">Il punto di ripristino coerente con l'applicazione si verifica prima del punto più recente nel tempo e provoca perdita di dati.</span><span class="sxs-lookup"><span data-stu-id="b8811-311">An app-consistent recovery point occurs before the most recent point in time, and it will cause some data loss.</span></span>
3. <span data-ttu-id="b8811-312">Durante il failover, Site Recovery arresta le macchine virtuali di Azure.</span><span class="sxs-lookup"><span data-stu-id="b8811-312">During failover, Site Recovery shuts down the Azure VMs.</span></span> <span data-ttu-id="b8811-313">Assicurarsi che il failback sia stato completato e verificare che le macchine virtuali di Azure siano state arrestate come previsto.</span><span class="sxs-lookup"><span data-stu-id="b8811-313">After you check that failback has been completed as expected, you can check to ensure that the Azure VMs have been shut down as expected.</span></span>

### <a name="reprotect-the-on-premises-site"></a><span data-ttu-id="b8811-314">Riproteggere il sito locale</span><span class="sxs-lookup"><span data-stu-id="b8811-314">Reprotect the on-premises site</span></span>
<span data-ttu-id="b8811-315">Al termine del failback, eseguire il commit della macchina virtuale per garantire che vengano eliminate le macchine virtuali ripristinate in Azure.</span><span class="sxs-lookup"><span data-stu-id="b8811-315">After failback has been completed, commit the virtual machine to ensure that the VMs recovered in Azure are deleted.</span></span> <span data-ttu-id="b8811-316">A tale scopo, fare clic con il pulsante destro del mouse sull'elemento protetto e quindi su **Commit**.</span><span class="sxs-lookup"><span data-stu-id="b8811-316">To do so, right-click the protected item, and then click **Commit**.</span></span> <span data-ttu-id="b8811-317">Viene attivato un processo che rimuove le macchine virtuali precedentemente ripristinate in Azure.</span><span class="sxs-lookup"><span data-stu-id="b8811-317">This action triggers a job that removes the former recovered virtual machines in Azure.</span></span>

<span data-ttu-id="b8811-318">Al termine del commit i dati dovrebbero trovarsi nuovamente nel sito locale, ma non sono protetti.</span><span class="sxs-lookup"><span data-stu-id="b8811-318">After the commit is completed, your data should be back on the on-premises site, but it won’t be protected.</span></span> <span data-ttu-id="b8811-319">Per avviare nuovamente la replica in Azure, eseguire queste operazioni:</span><span class="sxs-lookup"><span data-stu-id="b8811-319">To start replicating to Azure again, do the following:</span></span>

1. <span data-ttu-id="b8811-320">In **Insieme di credenziali**, **Impostazioni** > **Elementi replicati** selezionare le VM di cui è stato eseguito il failback e quindi fare clic su **Riproteggi**.</span><span class="sxs-lookup"><span data-stu-id="b8811-320">In **Vault**, in **Setting** > **Replicated items**, select the VMs that have failed back, and then click **Re-Protect**.</span></span>
2. <span data-ttu-id="b8811-321">Specificare il valore del server di elaborazione da usare per inviare i dati ad Azure.</span><span class="sxs-lookup"><span data-stu-id="b8811-321">Give the value of the Process Server that needs to be used to send data back to Azure.</span></span>
3. <span data-ttu-id="b8811-322">Fare clic su **OK**.</span><span class="sxs-lookup"><span data-stu-id="b8811-322">Click **OK**.</span></span>

<span data-ttu-id="b8811-323">Al termine della riprotezione, la VM viene replicata in Azure ed è possibile eseguire il failover.</span><span class="sxs-lookup"><span data-stu-id="b8811-323">After the reprotection is complete, the VM replicates back to Azure and you can do a failover.</span></span>

### <a name="resolve-common-failback-issues"></a><span data-ttu-id="b8811-324">Risolvere i problemi comuni di failback</span><span class="sxs-lookup"><span data-stu-id="b8811-324">Resolve common failback issues</span></span>
* <span data-ttu-id="b8811-325">Se si esegue l'individuazione di vCenter con utente di sola lettura e la protezione delle macchine virtuali, il processo funziona e il failover viene eseguito.</span><span class="sxs-lookup"><span data-stu-id="b8811-325">If you perform a read-only user vCenter discovery and protect virtual machines, it succeeds and failover works.</span></span> <span data-ttu-id="b8811-326">Durante la riprotezione, failover ha esito negativo perché non è possibile individuare gli archivi dati.</span><span class="sxs-lookup"><span data-stu-id="b8811-326">During reprotection, failover fails because the datastores cannot be discovered.</span></span> <span data-ttu-id="b8811-327">Non verranno quindi visualizzati gli archivi dati elencati durante la riprotezione.</span><span class="sxs-lookup"><span data-stu-id="b8811-327">As a symptom, you will not see the datastores listed during reprotection.</span></span> <span data-ttu-id="b8811-328">Per risolvere questo problema, è possibile aggiornare le credenziali di vCenter usando un account appropriato che abbia le autorizzazioni, quindi ripetere il processo.</span><span class="sxs-lookup"><span data-stu-id="b8811-328">To resolve this issue, you can update the vCenter credential with an appropriate account that has permissions and retry the job.</span></span> <span data-ttu-id="b8811-329">Per altre informazioni, vedere [Eseguire la replica di macchine virtuali VMware e server fisici in Azure con Azure Site Recovery](site-recovery-vmware-to-azure-classic.md).</span><span class="sxs-lookup"><span data-stu-id="b8811-329">For more information, see [Replicate VMware virtual machines and physical servers to Azure with Azure Site Recovery](site-recovery-vmware-to-azure-classic.md)</span></span>
* <span data-ttu-id="b8811-330">Quando si esegue il failback di una macchina virtuale Linux e l'esecuzione è locale, si nota che il pacchetto di gestione reti viene disinstallato dal computer.</span><span class="sxs-lookup"><span data-stu-id="b8811-330">When you fail back a Linux VM and run it on-premises, you can see that the Network Manager package has been uninstalled from the machine.</span></span> <span data-ttu-id="b8811-331">Tale installazione si verifica perché, quando la macchina virtuale viene ripristinata in Azure, il pacchetto di gestione reti viene rimosso.</span><span class="sxs-lookup"><span data-stu-id="b8811-331">This uninstallation happens because the Network Manager package is removed when the VM is recovered in Azure.</span></span>
* <span data-ttu-id="b8811-332">Se per la configurazione di una macchina virtuale viene usato un indirizzo IP statico e viene eseguito il failover in Azure, l'indirizzo IP viene acquisito tramite DHCP.</span><span class="sxs-lookup"><span data-stu-id="b8811-332">When a VM is configured with a static IP address and is failed over to Azure, the IP address is acquired via DHCP.</span></span> <span data-ttu-id="b8811-333">Quando il failover viene eseguito di nuovo in locale, la macchina virtuale continua a usare il protocollo DHCP per acquisire l'indirizzo IP.</span><span class="sxs-lookup"><span data-stu-id="b8811-333">When you fail over back to on-premises, the VM continues to use DHCP to acquire the IP address.</span></span> <span data-ttu-id="b8811-334">Se necessario, accedere manualmente al computer e impostare l'indirizzo IP torna su un indirizzo statico.</span><span class="sxs-lookup"><span data-stu-id="b8811-334">Manually sign in to the machine and set the IP address back to a static address if necessary.</span></span>
* <span data-ttu-id="b8811-335">Se si usa l'edizione gratuita di ESXi 5.5 o di vSphere 6 Hypervisor, sarà possibile eseguire il failover, ma non eseguire il failback.</span><span class="sxs-lookup"><span data-stu-id="b8811-335">If you are using either ESXi 5.5 free edition or vSphere 6 Hypervisor free edition, failover would succeed, but failback would not succeed.</span></span> <span data-ttu-id="b8811-336">Per abilitare il failback, scegliere l'aggiornamento alla licenza di valutazione del programma.</span><span class="sxs-lookup"><span data-stu-id="b8811-336">To enable failback, upgrade to either program's evaluation license.</span></span>
* <span data-ttu-id="b8811-337">Se non è possibile raggiungere il server di configurazione dal server di elaborazione, verificare la connettività al server di configurazione, da Telnet al computer del server di configurazione sulla porta 443.</span><span class="sxs-lookup"><span data-stu-id="b8811-337">If you cannot reach the configuration server from the Process Server, check connectivity to the configuration server by Telnet to the configuration server machine on port 443.</span></span> <span data-ttu-id="b8811-338">È anche possibile provare a eseguire il ping del server di configurazione dal computer del server di elaborazione.</span><span class="sxs-lookup"><span data-stu-id="b8811-338">You can also try to ping the configuration server from the Process Server machine.</span></span> <span data-ttu-id="b8811-339">Un server di elaborazione deve avere anche un heartbeat quando è connesso al server di configurazione.</span><span class="sxs-lookup"><span data-stu-id="b8811-339">A Process Server should also have a heartbeat when it is connected to the configuration server.</span></span>
* <span data-ttu-id="b8811-340">Se si sta tentando di eseguire il failback a un vCenter alternativo, assicurarsi che il nuovo vCenter e il server di destinazione master vengano rilevati.</span><span class="sxs-lookup"><span data-stu-id="b8811-340">If you are trying to fail back to an alternate vCenter, make sure that your new vCenter is discovered and that the master target server is also discovered.</span></span> <span data-ttu-id="b8811-341">Come sintomo tipico, gli archivi dati non sono accessibili o visibili nella finestra di dialogo **Riproteggi**.</span><span class="sxs-lookup"><span data-stu-id="b8811-341">A typical symptom is that the datastores are not accessible or visible in the **Reprotect** dialog box.</span></span>
* <span data-ttu-id="b8811-342">Non è possibile eseguire il failback da Azure a locale di un computer WS2008R2SP1 protetto come computer locale fisico.</span><span class="sxs-lookup"><span data-stu-id="b8811-342">A WS2008R2SP1 machine that is protected as a physical on-premises machine cannot be failed back from Azure to on-premises.</span></span>

## <a name="fail-back-with-expressroute"></a><span data-ttu-id="b8811-343">Eseguire il failback con ExpressRoute</span><span class="sxs-lookup"><span data-stu-id="b8811-343">Fail back with ExpressRoute</span></span>
<span data-ttu-id="b8811-344">È possibile eseguire il failback usando una connessione VPN o ExpressRoute.</span><span class="sxs-lookup"><span data-stu-id="b8811-344">You can fail back over a VPN connection or by using an ExpressRoute connection.</span></span> <span data-ttu-id="b8811-345">Per usare una connessione ExpressRoute, tenere presente quanto segue:</span><span class="sxs-lookup"><span data-stu-id="b8811-345">If you want to use an ExpressRoute connection, note the following:</span></span>

* <span data-ttu-id="b8811-346">La connessione ExpressRoute deve essere configurata nella rete virtuale di Azure in cui viene eseguito il failover dei computer di origine e in cui si trovano le macchine virtuali di Azure dopo il failover.</span><span class="sxs-lookup"><span data-stu-id="b8811-346">The ExpressRoute connection should be set up on the Azure virtual network that the source machines fail over to and where the Azure VMs are located after the failover occurs.</span></span>
* <span data-ttu-id="b8811-347">I dati vengono replicati in un account di archiviazione di Azure in un endpoint pubblico.</span><span class="sxs-lookup"><span data-stu-id="b8811-347">Data is replicated to an Azure storage account on a public endpoint.</span></span> <span data-ttu-id="b8811-348">Per consentire l'uso di ExpressRoute da parte della replica di Site Recovery, configurare il peering pubblico in ExpressRoute specificando il data center di destinazione.</span><span class="sxs-lookup"><span data-stu-id="b8811-348">To use an ExpressRoute connection, set up public peering in ExpressRoute with the target data center for Site Recovery replication.</span></span>
