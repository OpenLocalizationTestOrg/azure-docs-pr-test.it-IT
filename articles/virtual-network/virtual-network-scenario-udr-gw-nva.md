---
title: Connessione ibrida con applicazione a 2 livelli | Documentazione Microsoft
description: Informazioni su come distribuire appliance virtuali e route definite dall'utente per creare un ambiente di applicazioni multilivello in Azure
services: virtual-network
documentationcenter: na
author: jimdial
manager: carmonm
editor: tysonn
ms.assetid: 1f509bec-bdd1-470d-8aa4-3cf2bb7f6134
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/05/2016
ms.author: jdial
ms.openlocfilehash: 8e464348660114f5e99b4739bb7761b7e53ebf99
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 07/11/2017
---
# <a name="virtual-appliance-scenario"></a><span data-ttu-id="aa670-103">Scenario dell'appliance virtuale</span><span class="sxs-lookup"><span data-stu-id="aa670-103">Virtual appliance scenario</span></span>
<span data-ttu-id="aa670-104">Uno scenario comune tra i clienti di Azure di grandi dimensioni è la necessità di offrire un'applicazione a due livelli esposta a Internet, consentendo l'accesso al livello back-end da un data center locale.</span><span class="sxs-lookup"><span data-stu-id="aa670-104">A common scenario among larger Azure customer is the need to provide a two-tiered application exposed to the Internet, while allowing access to the back tier from an on-premises datacenter.</span></span> <span data-ttu-id="aa670-105">Questo documento illustra uno scenario che prevede route definite dall'utente (UDR), un gateway VPN e appliance di rete virtuali per distribuire un ambiente a due livelli che soddisfi i requisiti seguenti:</span><span class="sxs-lookup"><span data-stu-id="aa670-105">This document will walk you through a scenario using User Defined Routes (UDR), a VPN Gateway, and network virtual appliances to deploy a two-tier environment that meets the following requirements:</span></span>

* <span data-ttu-id="aa670-106">L'applicazione Web deve essere accessibile solo da Internet pubblico.</span><span class="sxs-lookup"><span data-stu-id="aa670-106">Web application must be accessible from the public Internet only.</span></span>
* <span data-ttu-id="aa670-107">Il server Web che ospita l'applicazione deve essere in grado di accedere a un server applicazioni back-end.</span><span class="sxs-lookup"><span data-stu-id="aa670-107">Web server hosting the application must be able to access a backend application server.</span></span>
* <span data-ttu-id="aa670-108">Tutto il traffico da Internet all'applicazione Web deve passare attraverso un'appliance virtuale firewall.</span><span class="sxs-lookup"><span data-stu-id="aa670-108">All traffic from the Internet to the web application must go through a firewall virtual appliance.</span></span> <span data-ttu-id="aa670-109">Questa appliance virtuale verrà usata solo per il traffico Internet.</span><span class="sxs-lookup"><span data-stu-id="aa670-109">This virtual appliance will be used for Internet traffic only.</span></span>
* <span data-ttu-id="aa670-110">Tutto il traffico verso il server applicazioni deve passare attraverso un'appliance virtuale firewall.</span><span class="sxs-lookup"><span data-stu-id="aa670-110">All traffic going to the application server must go through a firewall virtual appliance.</span></span> <span data-ttu-id="aa670-111">Questa appliance virtuale verrà usata per l'accesso al server back-end e l'accesso proveniente dalla rete locale tramite un gateway VPN.</span><span class="sxs-lookup"><span data-stu-id="aa670-111">This virtual appliance will be used for access to the backend end server, and access coming in from the on-premises network via a VPN Gateway.</span></span>
* <span data-ttu-id="aa670-112">Gli amministratori devono essere in grado di gestire le appliance virtuali firewall dai computer locali, con una terza appliance virtuale firewall usata esclusivamente per scopi di gestione.</span><span class="sxs-lookup"><span data-stu-id="aa670-112">Administrators must be able to manage the firewall virtual appliances from their on-premises computers, by using a third firewall virtual appliance used exclusively for management purposes.</span></span>

<span data-ttu-id="aa670-113">Si tratta di uno scenario di rete perimetrale standard con una rete perimetrale e una rete protetta.</span><span class="sxs-lookup"><span data-stu-id="aa670-113">This is a standard DMZ scenario with a DMZ and a protected network.</span></span> <span data-ttu-id="aa670-114">Questo scenario può essere creato in Azure usando gruppi di sicurezza di rete, appliance virtuali firewall o una combinazione di entrambi.</span><span class="sxs-lookup"><span data-stu-id="aa670-114">Such scenario can be constructed in Azure by using NSGs, firewall virtual appliances, or a combination of both.</span></span> <span data-ttu-id="aa670-115">La tabella seguente mostra un confronto tra vantaggi e svantaggi di gruppi di sicurezza di rete e appliance virtuali firewall.</span><span class="sxs-lookup"><span data-stu-id="aa670-115">The table below shows some of the pros and cons between NSGs and firewall virtual appliances.</span></span>

|  | <span data-ttu-id="aa670-116">Vantaggi</span><span class="sxs-lookup"><span data-stu-id="aa670-116">Pros</span></span> | <span data-ttu-id="aa670-117">Svantaggi</span><span class="sxs-lookup"><span data-stu-id="aa670-117">Cons</span></span> |
| --- | --- | --- |
| <span data-ttu-id="aa670-118">NSG</span><span class="sxs-lookup"><span data-stu-id="aa670-118">NSG</span></span> |<span data-ttu-id="aa670-119">Nessun costo.</span><span class="sxs-lookup"><span data-stu-id="aa670-119">No cost.</span></span> <br/><span data-ttu-id="aa670-120">Integrato nel controllo degli accessi in base al ruolo di Azure.</span><span class="sxs-lookup"><span data-stu-id="aa670-120">Integrated into Azure RBAC.</span></span> <br/><span data-ttu-id="aa670-121">Le regole possono essere create in modelli di Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="aa670-121">Rules can be created in ARM templates.</span></span> |<span data-ttu-id="aa670-122">La complessità può variare in ambienti più grandi.</span><span class="sxs-lookup"><span data-stu-id="aa670-122">Complexity could vary in larger environments.</span></span> |
| <span data-ttu-id="aa670-123">Firewall</span><span class="sxs-lookup"><span data-stu-id="aa670-123">Firewall</span></span> |<span data-ttu-id="aa670-124">Controllo completo del piano dati.</span><span class="sxs-lookup"><span data-stu-id="aa670-124">Full control over data plane.</span></span> <br/><span data-ttu-id="aa670-125">Gestione centrale con console firewall.</span><span class="sxs-lookup"><span data-stu-id="aa670-125">Central management through firewall console.</span></span> |<span data-ttu-id="aa670-126">Costo dell'appliance firewall.</span><span class="sxs-lookup"><span data-stu-id="aa670-126">Cost of firewall appliance.</span></span> <br/><span data-ttu-id="aa670-127">Non integrato nel controllo degli accessi in base al ruolo di Azure.</span><span class="sxs-lookup"><span data-stu-id="aa670-127">Not integrated with Azure RBAC.</span></span> |

<span data-ttu-id="aa670-128">La soluzione seguente usa appliance virtuali firewall per implementare uno scenario di rete perimetrale/rete protetta.</span><span class="sxs-lookup"><span data-stu-id="aa670-128">The solution below uses firewall virtual appliances to implement a DMZ/protected network scenario.</span></span>

## <a name="considerations"></a><span data-ttu-id="aa670-129">Considerazioni</span><span class="sxs-lookup"><span data-stu-id="aa670-129">Considerations</span></span>
<span data-ttu-id="aa670-130">È possibile distribuire l'ambiente illustrato in precedenza in Azure usando diverse funzionalità attualmente disponibili come indicato di seguito.</span><span class="sxs-lookup"><span data-stu-id="aa670-130">You can deploy the environment explained above in Azure using different features available today, as follows.</span></span>

* <span data-ttu-id="aa670-131">**Rete virtuale**.</span><span class="sxs-lookup"><span data-stu-id="aa670-131">**Virtual network (VNet)**.</span></span> <span data-ttu-id="aa670-132">Una rete virtuale di Azure funziona in modo analogo a una rete locale e può essere segmentata in una o più subnet per l'isolamento del traffico e la separazione dei compiti.</span><span class="sxs-lookup"><span data-stu-id="aa670-132">An Azure VNet acts in similar fashion to an on-premises network, and can be segmented into one or more subnets to provide traffic isolation, and separation of concerns.</span></span>
* <span data-ttu-id="aa670-133">**Appliance virtuale**.</span><span class="sxs-lookup"><span data-stu-id="aa670-133">**Virtual appliance**.</span></span> <span data-ttu-id="aa670-134">Numerosi partner offrono appliance virtuali in Azure Marketplace che possono essere usate per i tre firewall descritti in precedenza.</span><span class="sxs-lookup"><span data-stu-id="aa670-134">Several partners provide virtual appliances in the Azure Marketplace that can be used for the three firewalls described above.</span></span> 
* <span data-ttu-id="aa670-135">**Route definite dall'utente**.</span><span class="sxs-lookup"><span data-stu-id="aa670-135">**User Defined Routes (UDR)**.</span></span> <span data-ttu-id="aa670-136">Le tabelle di route possono contenere route definite dall'utente usate dalla rete di Azure per controllare il flusso dei pacchetti all'interno di una rete virtuale.</span><span class="sxs-lookup"><span data-stu-id="aa670-136">Route tables can contain UDRs used by Azure networking to control the flow of packets within a VNet.</span></span> <span data-ttu-id="aa670-137">Queste tabelle di route possono essere applicate alle subnet.</span><span class="sxs-lookup"><span data-stu-id="aa670-137">These route tables can be applied to subnets.</span></span> <span data-ttu-id="aa670-138">Una delle funzionalità più recenti di Azure è la possibilità di applicare una tabella di route alla subnet del gateway, al fine di inoltrare tutto il traffico in ingresso sulla rete virtuale di Azure da una connessione ibrida verso un'appliance virtuale.</span><span class="sxs-lookup"><span data-stu-id="aa670-138">One of the newest features in Azure is the ability to apply a route table to the GatewaySubnet, providing the ability to forward all traffic coming into the Azure VNet from a hybrid connection to a virtual appliance.</span></span>
* <span data-ttu-id="aa670-139">**Inoltro IP**.</span><span class="sxs-lookup"><span data-stu-id="aa670-139">**IP Forwarding**.</span></span> <span data-ttu-id="aa670-140">Per impostazione predefinita, il motore di rete Azure inoltra i pacchetti alle schede di interfaccia di rete (NIC) virtuale solo se l'indirizzo IP di destinazione dei pacchetti corrisponde all'indirizzo IP della scheda di interfaccia di rete.</span><span class="sxs-lookup"><span data-stu-id="aa670-140">By default, the Azure networking engine forward packets to virtual network interface cards (NICs) only if the packet destination IP address matches the NIC IP address.</span></span> <span data-ttu-id="aa670-141">Se quindi una route definita dall'utente indica che un pacchetto dovrà essere inviato a una specifica appliance virtuale, il motore di rete di Azure rilascerà il pacchetto.</span><span class="sxs-lookup"><span data-stu-id="aa670-141">Therefore, if a UDR defines that a packet must be sent to a given virtual appliance, the Azure networking engine would drop that packet.</span></span> <span data-ttu-id="aa670-142">Per far sì che il pacchetto venga inviato a una macchina virtuale, in questo caso un'appliance virtuale, che non è la destinazione effettiva del pacchetto è necessario abilitare l'inoltro IP per l'appliance virtuale.</span><span class="sxs-lookup"><span data-stu-id="aa670-142">To ensure the packet is delivered to a VM (in this case a virtual appliance) that is not the actual destination for the packet, you need to enable IP Forwarding for the virtual appliance.</span></span>
* <span data-ttu-id="aa670-143">**Gruppi di sicurezza di rete**.</span><span class="sxs-lookup"><span data-stu-id="aa670-143">**Network Security Groups (NSGs)**.</span></span> <span data-ttu-id="aa670-144">Nell'esempio seguente non vengono usati gruppi di sicurezza di rete, che possono essere tuttavia applicati alle subnet e/o alle schede di interfaccia di rete di questa soluzione per filtrare ulteriormente il traffico in ingresso e in uscita da tali subnet e schede di interfaccia di rete.</span><span class="sxs-lookup"><span data-stu-id="aa670-144">The example below does not make use of NSGs, but you could use NSGs applied to the subnets and/or NICs in this solution to further filter the traffic in and out of those subnets and NICs.</span></span>

![IPv6 connectivity](./media/virtual-network-scenario-udr-gw-nva/figure01.png)

<span data-ttu-id="aa670-146">In questo esempio è presente una sottoscrizione che include gli elementi seguenti:</span><span class="sxs-lookup"><span data-stu-id="aa670-146">In this example there is a subscription that contains the following:</span></span>

* <span data-ttu-id="aa670-147">2 gruppi di risorse non indicati nel diagramma.</span><span class="sxs-lookup"><span data-stu-id="aa670-147">2 resource groups, not shown in the diagram.</span></span> 
  * <span data-ttu-id="aa670-148">**ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="aa670-148">**ONPREMRG**.</span></span> <span data-ttu-id="aa670-149">Contiene tutte le risorse necessarie per simulare una rete locale.</span><span class="sxs-lookup"><span data-stu-id="aa670-149">Contains all resources necessary to simulate an on-premises network.</span></span>
  * <span data-ttu-id="aa670-150">**AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="aa670-150">**AZURERG**.</span></span> <span data-ttu-id="aa670-151">Contiene tutte le risorse necessarie per l'ambiente di rete virtuale di Azure.</span><span class="sxs-lookup"><span data-stu-id="aa670-151">Contains all resources necessary for the Azure virtual network environment.</span></span> 
* <span data-ttu-id="aa670-152">Una rete virtuale denominata **onpremvnet** usata per simulare un data center locale segmentato come indicato di seguito.</span><span class="sxs-lookup"><span data-stu-id="aa670-152">A VNet named **onpremvnet** used to mimic an on-premises datacenter segmented as listed below.</span></span>
  * <span data-ttu-id="aa670-153">**onpremsn1**.</span><span class="sxs-lookup"><span data-stu-id="aa670-153">**onpremsn1**.</span></span> <span data-ttu-id="aa670-154">Subnet contenente una macchina virtuale che esegue Ubuntu per simulare un server locale.</span><span class="sxs-lookup"><span data-stu-id="aa670-154">Subnet containing a virtual machine (VM) running Ubuntu to mimic an on-premises server.</span></span>
  * <span data-ttu-id="aa670-155">**onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="aa670-155">**onpremsn2**.</span></span> <span data-ttu-id="aa670-156">Subnet contenente una macchina virtuale che esegue Ubuntu per simulare un computer locale usato da un amministratore.</span><span class="sxs-lookup"><span data-stu-id="aa670-156">Subnet containing a VM running Ubuntu to mimic an on-premises computer used by an administrator.</span></span>
* <span data-ttu-id="aa670-157">È presente un'appliance virtuale firewall denominata **OPFW** su **onpremvnet** usata per mantenere un tunnel per **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="aa670-157">There is one firewall virtual appliance named **OPFW** on **onpremvnet** used to maintain a tunnel to **azurevnet**.</span></span>
* <span data-ttu-id="aa670-158">Una rete virtuale denominata **azurevnet** segmentata come indicato di seguito.</span><span class="sxs-lookup"><span data-stu-id="aa670-158">A VNet named **azurevnet** segmented as listed below.</span></span>
  * <span data-ttu-id="aa670-159">**azsn1**.</span><span class="sxs-lookup"><span data-stu-id="aa670-159">**azsn1**.</span></span> <span data-ttu-id="aa670-160">Subnet del firewall esterno usata esclusivamente per il firewall esterno.</span><span class="sxs-lookup"><span data-stu-id="aa670-160">External firewall subnet used exclusively for the external firewall.</span></span> <span data-ttu-id="aa670-161">Tutto il traffico Internet in ingresso passerà attraverso questa subnet.</span><span class="sxs-lookup"><span data-stu-id="aa670-161">All Internet traffic will come in through this subnet.</span></span> <span data-ttu-id="aa670-162">Questa subnet contiene solo una scheda di interfaccia di rete collegata al firewall esterno.</span><span class="sxs-lookup"><span data-stu-id="aa670-162">This subnet only contains a NIC linked to the external firewall.</span></span>
  * <span data-ttu-id="aa670-163">**azsn2**.</span><span class="sxs-lookup"><span data-stu-id="aa670-163">**azsn2**.</span></span> <span data-ttu-id="aa670-164">Subnet front-end che ospita una macchina virtuale in esecuzione come server Web accessibile da Internet.</span><span class="sxs-lookup"><span data-stu-id="aa670-164">Front end subnet hosting a VM running as a web server that will be accessed from the Internet.</span></span>
  * <span data-ttu-id="aa670-165">**azsn3**.</span><span class="sxs-lookup"><span data-stu-id="aa670-165">**azsn3**.</span></span> <span data-ttu-id="aa670-166">Subnet back-end che ospita una macchina virtuale che esegue un server applicazioni back-end accessibile dal server Web front-end.</span><span class="sxs-lookup"><span data-stu-id="aa670-166">Backend subnet hosting a VM running a backend application server that will be accessed by the front end web server.</span></span>
  * <span data-ttu-id="aa670-167">**azsn4**.</span><span class="sxs-lookup"><span data-stu-id="aa670-167">**azsn4**.</span></span> <span data-ttu-id="aa670-168">Subnet di gestione usata esclusivamente per consentire l'accesso di gestione a tutte le appliance virtuali firewall.</span><span class="sxs-lookup"><span data-stu-id="aa670-168">Management subnet used exclusively to provide management access to all firewall virtual appliances.</span></span> <span data-ttu-id="aa670-169">Questa subnet contiene solo una scheda di interfaccia di rete per ogni appliance virtuale firewall usata nella soluzione.</span><span class="sxs-lookup"><span data-stu-id="aa670-169">This subnet only contains a NIC for each firewall virtual appliance used in the solution.</span></span>
  * <span data-ttu-id="aa670-170">**GatewaySubnet**.</span><span class="sxs-lookup"><span data-stu-id="aa670-170">**GatewaySubnet**.</span></span> <span data-ttu-id="aa670-171">Subnet di connessione ibrida di Azure necessaria per consentire a ExpressRoute e al gateway VPN di offrire la connessione tra le reti virtuali di Azure e altre reti.</span><span class="sxs-lookup"><span data-stu-id="aa670-171">Azure hybrid connection subnet required for ExpressRoute and VPN Gateway to provide connectivity between Azure VNets and other networks.</span></span> 
* <span data-ttu-id="aa670-172">Sono disponibili 3 appliance virtuali firewall nella rete **azurevnet** .</span><span class="sxs-lookup"><span data-stu-id="aa670-172">There are 3 firewall virtual appliances in the **azurevnet** network.</span></span> 
  * <span data-ttu-id="aa670-173">**AZF1**.</span><span class="sxs-lookup"><span data-stu-id="aa670-173">**AZF1**.</span></span> <span data-ttu-id="aa670-174">Firewall esterno esposto a Internet pubblico con una risorsa di indirizzo IP pubblico in Azure.</span><span class="sxs-lookup"><span data-stu-id="aa670-174">External firewall exposed to the public Internet by using a public IP address resource in Azure.</span></span> <span data-ttu-id="aa670-175">È necessario ottenere un modello dal Marketplace o direttamente dal fornitore dell'appliance per il provisioning di un'appliance virtuale con 3 schede di interfaccia di rete.</span><span class="sxs-lookup"><span data-stu-id="aa670-175">You need to ensure you have a template from the Marketplace, or directly from your appliance vendor, that provisions a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="aa670-176">**AZF2**.</span><span class="sxs-lookup"><span data-stu-id="aa670-176">**AZF2**.</span></span> <span data-ttu-id="aa670-177">Firewall interno usato per gestire il traffico tra **azsn2** e **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="aa670-177">Internal firewall used to control traffic between **azsn2** and **azsn3**.</span></span> <span data-ttu-id="aa670-178">Anche questa è un'appliance virtuale con 3 schede di interfaccia di rete.</span><span class="sxs-lookup"><span data-stu-id="aa670-178">This is also a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="aa670-179">**AZF3**.</span><span class="sxs-lookup"><span data-stu-id="aa670-179">**AZF3**.</span></span> <span data-ttu-id="aa670-180">Firewall di gestione accessibile agli amministratori dal centro dati locale e connesso a una subnet usata per la gestione di tutte le appliance firewall.</span><span class="sxs-lookup"><span data-stu-id="aa670-180">Management firewall accessible to administrators from the on-premises datacenter, and connected to a management subnet used to manage all firewall appliances.</span></span> <span data-ttu-id="aa670-181">I modelli per appliance virtuali con 2 schede di interfaccia di rete sono disponibili nel Marketplace oppure possono essere richiesti direttamente al fornitore dell'appliance.</span><span class="sxs-lookup"><span data-stu-id="aa670-181">You can find 2-NIC virtual appliance templates in the Marketplace, or request one directly from your appliance vendor.</span></span>

## <a name="user-defined-routing-udr"></a><span data-ttu-id="aa670-182">Routing definito dall'utente</span><span class="sxs-lookup"><span data-stu-id="aa670-182">User Defined Routing (UDR)</span></span>
<span data-ttu-id="aa670-183">Ogni subnet in Azure può essere collegata a una tabella di route definite dall'utente usata per definire come viene indirizzato il traffico che ha origine nella subnet.</span><span class="sxs-lookup"><span data-stu-id="aa670-183">Each subnet in Azure can be linked to a UDR table used to define how traffic initiated in that subnet is routed.</span></span> <span data-ttu-id="aa670-184">Se non sono presenti route definite dall'utente, Azure usa le route predefinite per consentire il flusso del traffico da una subnet all'altra.</span><span class="sxs-lookup"><span data-stu-id="aa670-184">If no UDRs are defined, Azure uses default routes to allow traffic to flow from one subnet to another.</span></span> <span data-ttu-id="aa670-185">Per informazioni approfondite sulle route definite dall'utente, vedere [Cosa sono le route definite dall'utente e l'inoltro IP](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="aa670-185">To better understand UDRs, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="aa670-186">Per garantire la comunicazione tramite l'appliance firewall corretta, in base all'ultimo requisito indicato in precedenza, è necessario creare la tabella seguente contenente le route definite dall'utente in **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="aa670-186">To ensure communication is done through the right firewall appliance, based on the last requirement above, you need to create the following route table containing UDRs in **azurevnet**.</span></span>

### <a name="azgwudr"></a><span data-ttu-id="aa670-187">azgwudr</span><span class="sxs-lookup"><span data-stu-id="aa670-187">azgwudr</span></span>
<span data-ttu-id="aa670-188">In questo scenario, il solo traffico da locale ad Azure verrà usato per gestire i firewall connettendosi a **AZF3** e tale traffico deve passare attraverso il firewall interno, **AZF2**.</span><span class="sxs-lookup"><span data-stu-id="aa670-188">In this scenario, the only traffic flowing from on-premises to Azure will be used to manage the firewalls by connecting to **AZF3**, and that traffic must go through the internal firewall, **AZF2**.</span></span> <span data-ttu-id="aa670-189">È quindi necessaria una sola route in **GatewaySubnet** come illustrato di seguito.</span><span class="sxs-lookup"><span data-stu-id="aa670-189">Therefore, only one route is necessary in the **GatewaySubnet** as shown below.</span></span>

| <span data-ttu-id="aa670-190">Destination</span><span class="sxs-lookup"><span data-stu-id="aa670-190">Destination</span></span> | <span data-ttu-id="aa670-191">Hop successivo</span><span class="sxs-lookup"><span data-stu-id="aa670-191">Next hop</span></span> | <span data-ttu-id="aa670-192">Spiegazione</span><span class="sxs-lookup"><span data-stu-id="aa670-192">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="aa670-193">10.0.4.0/24</span><span class="sxs-lookup"><span data-stu-id="aa670-193">10.0.4.0/24</span></span> |<span data-ttu-id="aa670-194">10.0.3.11</span><span class="sxs-lookup"><span data-stu-id="aa670-194">10.0.3.11</span></span> |<span data-ttu-id="aa670-195">Consente al traffico locale di raggiungere il firewall di gestione **AZF3**</span><span class="sxs-lookup"><span data-stu-id="aa670-195">Allows on-premises traffic to reach management firewall **AZF3**</span></span> |

### <a name="azsn2udr"></a><span data-ttu-id="aa670-196">azsn2udr</span><span class="sxs-lookup"><span data-stu-id="aa670-196">azsn2udr</span></span>
| <span data-ttu-id="aa670-197">Destination</span><span class="sxs-lookup"><span data-stu-id="aa670-197">Destination</span></span> | <span data-ttu-id="aa670-198">Hop successivo</span><span class="sxs-lookup"><span data-stu-id="aa670-198">Next hop</span></span> | <span data-ttu-id="aa670-199">Spiegazione</span><span class="sxs-lookup"><span data-stu-id="aa670-199">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="aa670-200">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="aa670-200">10.0.3.0/24</span></span> |<span data-ttu-id="aa670-201">10.0.2.11</span><span class="sxs-lookup"><span data-stu-id="aa670-201">10.0.2.11</span></span> |<span data-ttu-id="aa670-202">Consente il traffico verso la subnet di back-end che ospita il server applicazioni tramite **AZF2**</span><span class="sxs-lookup"><span data-stu-id="aa670-202">Allows traffic to the backend subnet hosting the application server through **AZF2**</span></span> |
| <span data-ttu-id="aa670-203">0.0.0.0/0</span><span class="sxs-lookup"><span data-stu-id="aa670-203">0.0.0.0/0</span></span> |<span data-ttu-id="aa670-204">10.0.2.10</span><span class="sxs-lookup"><span data-stu-id="aa670-204">10.0.2.10</span></span> |<span data-ttu-id="aa670-205">Consente di indirizzare il resto del traffico tramite **AZF1**</span><span class="sxs-lookup"><span data-stu-id="aa670-205">Allows all other traffic to be routed through **AZF1**</span></span> |

### <a name="azsn3udr"></a><span data-ttu-id="aa670-206">azsn3udr</span><span class="sxs-lookup"><span data-stu-id="aa670-206">azsn3udr</span></span>
| <span data-ttu-id="aa670-207">Destination</span><span class="sxs-lookup"><span data-stu-id="aa670-207">Destination</span></span> | <span data-ttu-id="aa670-208">Hop successivo</span><span class="sxs-lookup"><span data-stu-id="aa670-208">Next hop</span></span> | <span data-ttu-id="aa670-209">Spiegazione</span><span class="sxs-lookup"><span data-stu-id="aa670-209">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="aa670-210">10.0.2.0/24</span><span class="sxs-lookup"><span data-stu-id="aa670-210">10.0.2.0/24</span></span> |<span data-ttu-id="aa670-211">10.0.3.10</span><span class="sxs-lookup"><span data-stu-id="aa670-211">10.0.3.10</span></span> |<span data-ttu-id="aa670-212">Consente al traffico verso **azsn2** di passare dal server app al server Web attraverso **AZF2**</span><span class="sxs-lookup"><span data-stu-id="aa670-212">Allows traffic to **azsn2** to flow from app server to the webserver through **AZF2**</span></span> |

<span data-ttu-id="aa670-213">È anche necessario creare tabelle route per le subnet in **onpremvnet** per simulare il centro dati locale.</span><span class="sxs-lookup"><span data-stu-id="aa670-213">You also need to create route tables for the subnets in **onpremvnet** to mimic the on-premises datacenter.</span></span>

### <a name="onpremsn1udr"></a><span data-ttu-id="aa670-214">onpremsn1udr</span><span class="sxs-lookup"><span data-stu-id="aa670-214">onpremsn1udr</span></span>
| <span data-ttu-id="aa670-215">Destination</span><span class="sxs-lookup"><span data-stu-id="aa670-215">Destination</span></span> | <span data-ttu-id="aa670-216">Hop successivo</span><span class="sxs-lookup"><span data-stu-id="aa670-216">Next hop</span></span> | <span data-ttu-id="aa670-217">Spiegazione</span><span class="sxs-lookup"><span data-stu-id="aa670-217">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="aa670-218">192.168.2.0/24</span><span class="sxs-lookup"><span data-stu-id="aa670-218">192.168.2.0/24</span></span> |<span data-ttu-id="aa670-219">192.168.1.4</span><span class="sxs-lookup"><span data-stu-id="aa670-219">192.168.1.4</span></span> |<span data-ttu-id="aa670-220">Consente il traffico verso **onpremsn2** attraverso **OPFW**</span><span class="sxs-lookup"><span data-stu-id="aa670-220">Allows traffic to **onpremsn2** through **OPFW**</span></span> |

### <a name="onpremsn2udr"></a><span data-ttu-id="aa670-221">onpremsn2udr</span><span class="sxs-lookup"><span data-stu-id="aa670-221">onpremsn2udr</span></span>
| <span data-ttu-id="aa670-222">Destination</span><span class="sxs-lookup"><span data-stu-id="aa670-222">Destination</span></span> | <span data-ttu-id="aa670-223">Hop successivo</span><span class="sxs-lookup"><span data-stu-id="aa670-223">Next hop</span></span> | <span data-ttu-id="aa670-224">Spiegazione</span><span class="sxs-lookup"><span data-stu-id="aa670-224">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="aa670-225">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="aa670-225">10.0.3.0/24</span></span> |<span data-ttu-id="aa670-226">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="aa670-226">192.168.2.4</span></span> |<span data-ttu-id="aa670-227">Consente il traffico verso la subnet back-end in Azure tramite **OPFW**</span><span class="sxs-lookup"><span data-stu-id="aa670-227">Allows traffic to the backed subnet in Azure through **OPFW**</span></span> |
| <span data-ttu-id="aa670-228">192.168.1.0/24</span><span class="sxs-lookup"><span data-stu-id="aa670-228">192.168.1.0/24</span></span> |<span data-ttu-id="aa670-229">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="aa670-229">192.168.2.4</span></span> |<span data-ttu-id="aa670-230">Consente il traffico verso **onpremsn1** attraverso **OPFW**</span><span class="sxs-lookup"><span data-stu-id="aa670-230">Allows traffic to **onpremsn1** through **OPFW**</span></span> |

## <a name="ip-forwarding"></a><span data-ttu-id="aa670-231">Inoltro IP</span><span class="sxs-lookup"><span data-stu-id="aa670-231">IP Forwarding</span></span>
<span data-ttu-id="aa670-232">Le route definite dall'utente e l'inoltro IP sono funzionalità che è possibile usare in combinazione per consentire l'uso delle appliance virtuali per gestire il flusso del traffico in una rete virtuale di Azure.</span><span class="sxs-lookup"><span data-stu-id="aa670-232">UDR and IP Forwarding are features that you can use in combination to allow virtual appliances to be used to control traffic flow in an Azure VNet.</span></span>  <span data-ttu-id="aa670-233">Un dispositivo virtuale non è altro che una macchina virtuale che esegue un'applicazione utilizzata per gestire il traffico di rete in qualche modo, ad esempio un firewall o un dispositivo NAT.</span><span class="sxs-lookup"><span data-stu-id="aa670-233">A virtual appliance is nothing more than a VM that runs an application used to handle network traffic in some way, such as a firewall or a NAT device.</span></span>

<span data-ttu-id="aa670-234">Questo dispositivo virtuale macchina virtuale deve essere in grado di ricevere traffico in ingresso non viene indirizzato a se stesso.</span><span class="sxs-lookup"><span data-stu-id="aa670-234">This virtual appliance VM must be able to receive incoming traffic that is not addressed to itself.</span></span> <span data-ttu-id="aa670-235">Per consentire a una macchina virtuale di ricevere il traffico indirizzato ad altre destinazioni, è necessario abilitare l'inoltro IP per la macchina virtuale.</span><span class="sxs-lookup"><span data-stu-id="aa670-235">To allow a VM to receive traffic addressed to other destinations, you must enable IP Forwarding for the VM.</span></span> <span data-ttu-id="aa670-236">Si tratta di un'impostazione di Azure e non del sistema operativo guest.</span><span class="sxs-lookup"><span data-stu-id="aa670-236">This is an Azure setting, not a setting in the guest operating system.</span></span> <span data-ttu-id="aa670-237">L'appliance virtuale deve comunque eseguire qualche tipo di applicazione per gestire il traffico in ingresso e indirizzarlo correttamente.</span><span class="sxs-lookup"><span data-stu-id="aa670-237">Your virtual appliance still needs to run some type of application to handle the incoming traffic, and route it appropriately.</span></span>

<span data-ttu-id="aa670-238">Per altre informazioni sull'inoltro IP, vedere [Cosa sono le route definite dall'utente e l'inoltro IP](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="aa670-238">To learn more about IP Forwarding, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="aa670-239">Si supponga ad esempio che una rete virtuale di Azure sia configurata come segue:</span><span class="sxs-lookup"><span data-stu-id="aa670-239">As an example, imagine you have the following setup in an Azure vnet:</span></span>

* <span data-ttu-id="aa670-240">La subnet **onpremsn1** contiene una macchina virtuale denominata **onpremvm1**.</span><span class="sxs-lookup"><span data-stu-id="aa670-240">Subnet **onpremsn1** contains a VM named **onpremvm1**.</span></span>
* <span data-ttu-id="aa670-241">La subnet **onpremsn2** contiene una macchina virtuale denominata **onpremvm2**.</span><span class="sxs-lookup"><span data-stu-id="aa670-241">Subnet **onpremsn2** contains a VM named **onpremvm2**.</span></span>
* <span data-ttu-id="aa670-242">Un'appliance virtuale denominata **OPFW** è connessa a **onpremsn1** e **onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="aa670-242">A virtual appliance named **OPFW** is connected to **onpremsn1** and **onpremsn2**.</span></span>
* <span data-ttu-id="aa670-243">Una route definita dall'utente collegata a **onpremsn1** specifica che tutto il traffico verso **onpremsn2** dovrà essere inviato a **OPFW**.</span><span class="sxs-lookup"><span data-stu-id="aa670-243">A user defined route linked to **onpremsn1** specifies that all traffic to **onpremsn2** must be sent to **OPFW**.</span></span>

<span data-ttu-id="aa670-244">Se a questo punto **onpremvm1** tenta di stabilire una connessione a **onpremvm2**, verrà usata la route definita dall'utente e il traffico verrà inviato a **OPFW** come hop successivo.</span><span class="sxs-lookup"><span data-stu-id="aa670-244">At this point, if **onpremvm1** tries to establish a connection with **onpremvm2**, the UDR will be used and traffic will be sent to **OPFW** as the next hop.</span></span> <span data-ttu-id="aa670-245">Tenere presente che la destinazione effettiva dei pacchetti non viene modificata, **onpremvm2** rappresenta ancora la destinazione.</span><span class="sxs-lookup"><span data-stu-id="aa670-245">Keep in mind that the actual packet destination is not being changed, it still says **onpremvm2** is the destination.</span></span> 

<span data-ttu-id="aa670-246">Se l'inoltro IP non è attivato per **OPFW**, la logica della rete virtuale di Azure rilascerà i pacchetti perché consente l'invio di pacchetti a una macchina virtuale solo se l'indirizzo IP della macchina virtuale è la destinazione del pacchetto.</span><span class="sxs-lookup"><span data-stu-id="aa670-246">Without IP Forwarding enabled for **OPFW**, the Azure virtual networking logic will drop the packets, since it only allows packets to be sent to a VM if the VM’s IP address is the destination for the packet.</span></span>

<span data-ttu-id="aa670-247">Con l'inoltro IP, la logica della rete virtuale di Azure inoltrerà i pacchetti a OPFW, senza modificare l'indirizzo di destinazione originale.</span><span class="sxs-lookup"><span data-stu-id="aa670-247">With IP Forwarding, the Azure virtual network logic will forward the packets to OPFW, without changing its original destination address.</span></span> <span data-ttu-id="aa670-248">**OPFW** deve gestire i pacchetti e determinare cosa farne.</span><span class="sxs-lookup"><span data-stu-id="aa670-248">**OPFW** must handle the packets and determine what to do with them.</span></span>

<span data-ttu-id="aa670-249">Per far sì che lo scenario precedente funzioni è necessario abilitare l'inoltro IP sulle schede di interfaccia di rete per **OPFW**, **AZF1**, **AZF2** e **AZF3** che vengono usate per il routing. Si tratta di tutte le schede di interfaccia di rete ad eccezione di quelle collegate alla subnet di gestione.</span><span class="sxs-lookup"><span data-stu-id="aa670-249">For the scenario above to work, you must enable IP Forwarding on the NICs for **OPFW**, **AZF1**, **AZF2**, and **AZF3** that are used for routing (all NICs except the ones linked to the management subnet).</span></span> 

## <a name="firewall-rules"></a><span data-ttu-id="aa670-250">Regole del firewall</span><span class="sxs-lookup"><span data-stu-id="aa670-250">Firewall Rules</span></span>
<span data-ttu-id="aa670-251">Come descritto in precedenza, l'inoltro IP assicura solo che i pacchetti vengano inviati alle appliance virtuali.</span><span class="sxs-lookup"><span data-stu-id="aa670-251">As described above, IP Forwarding only ensures packets are sent to the virtual appliances.</span></span> <span data-ttu-id="aa670-252">L'appliance deve comunque stabilire come gestire i pacchetti.</span><span class="sxs-lookup"><span data-stu-id="aa670-252">Your appliance still needs to decide what to do with those packets.</span></span> <span data-ttu-id="aa670-253">Nello scenario precedente è necessario creare le regole seguenti nelle appliance:</span><span class="sxs-lookup"><span data-stu-id="aa670-253">In the scenario above, you will need to create the following rules in your appliances:</span></span>

### <a name="opfw"></a><span data-ttu-id="aa670-254">OPFW</span><span class="sxs-lookup"><span data-stu-id="aa670-254">OPFW</span></span>
<span data-ttu-id="aa670-255">OPFW rappresenta un dispositivo locale contenente le regole seguenti:</span><span class="sxs-lookup"><span data-stu-id="aa670-255">OPFW represents an on-premises device containing the following rules:</span></span>

* <span data-ttu-id="aa670-256">**Route**: tutto il traffico verso 10.0.0.0/16 (**azurevnet**) deve essere inviato attraverso il tunnel **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="aa670-256">**Route**: All traffic to 10.0.0.0/16 (**azurevnet**) must be sent through tunnel **ONPREMAZURE**.</span></span>
* <span data-ttu-id="aa670-257">**Criteri**: consentire tutto il traffico bidirezionale tra **port2** e **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="aa670-257">**Policy**: Allow all bidirectional traffic between **port2** and **ONPREMAZURE**.</span></span>

### <a name="azf1"></a><span data-ttu-id="aa670-258">AZF1</span><span class="sxs-lookup"><span data-stu-id="aa670-258">AZF1</span></span>
<span data-ttu-id="aa670-259">AZF1 rappresenta un'appliance virtuale di Azure contenente le regole seguenti:</span><span class="sxs-lookup"><span data-stu-id="aa670-259">AZF1 represents an Azure virtual appliance containing the following rules:</span></span>

* <span data-ttu-id="aa670-260">**Criteri**: consentire tutto il traffico bidirezionale tra **port1** e **port2**.</span><span class="sxs-lookup"><span data-stu-id="aa670-260">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

### <a name="azf2"></a><span data-ttu-id="aa670-261">AZF2</span><span class="sxs-lookup"><span data-stu-id="aa670-261">AZF2</span></span>
<span data-ttu-id="aa670-262">AZF2 rappresenta un'appliance virtuale di Azure contenente le regole seguenti:</span><span class="sxs-lookup"><span data-stu-id="aa670-262">AZF2 represents an Azure virtual appliance containing the following rules:</span></span>

* <span data-ttu-id="aa670-263">**Route**: tutto il traffico verso 10.0.0.0/16 (**onpremvnet**) deve essere inviato all'indirizzo IP del gateway di Azure (ovvero 10.0.0.1) attraverso **port1**.</span><span class="sxs-lookup"><span data-stu-id="aa670-263">**Route**: All traffic to 10.0.0.0/16 (**onpremvnet**) must be sent to the Azure gateway IP address (i.e. 10.0.0.1) through **port1**.</span></span>
* <span data-ttu-id="aa670-264">**Criteri**: consentire tutto il traffico bidirezionale tra **port1** e **port2**.</span><span class="sxs-lookup"><span data-stu-id="aa670-264">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

## <a name="network-security-groups-nsgs"></a><span data-ttu-id="aa670-265">Gruppi di sicurezza di rete (NGS)</span><span class="sxs-lookup"><span data-stu-id="aa670-265">Network Security Groups (NSGs)</span></span>
<span data-ttu-id="aa670-266">In questo scenario i gruppi di sicurezza di rete non vengono usati.</span><span class="sxs-lookup"><span data-stu-id="aa670-266">In this scenario, NSGs are not being used.</span></span> <span data-ttu-id="aa670-267">È tuttavia possibile applicare i gruppi di sicurezza di rete a ogni subnet per limitare il traffico in ingresso e in uscita.</span><span class="sxs-lookup"><span data-stu-id="aa670-267">However, you could apply NSGs to each subnet to restrict incoming and outgoing traffic.</span></span> <span data-ttu-id="aa670-268">È ad esempio possibile applicare le seguenti regole per gruppi di sicurezza di rete alla subnet del firewall esterno.</span><span class="sxs-lookup"><span data-stu-id="aa670-268">For instance, you could apply the following NSG rules to the external FW subnet.</span></span>

<span data-ttu-id="aa670-269">**In ingresso**</span><span class="sxs-lookup"><span data-stu-id="aa670-269">**Incoming**</span></span>

* <span data-ttu-id="aa670-270">Consentire tutto il traffico TCP da Internet alla porta 80 in qualsiasi macchina virtuale della subnet.</span><span class="sxs-lookup"><span data-stu-id="aa670-270">Allow all TCP traffic from the Internet to port 80 on any VM in the subnet.</span></span>
* <span data-ttu-id="aa670-271">Rifiutare il resto del traffico da Internet.</span><span class="sxs-lookup"><span data-stu-id="aa670-271">Deny all other traffic from the Internet.</span></span>

<span data-ttu-id="aa670-272">**In uscita**</span><span class="sxs-lookup"><span data-stu-id="aa670-272">**Outgoing**</span></span>

* <span data-ttu-id="aa670-273">Rifiutare il traffico verso Internet.</span><span class="sxs-lookup"><span data-stu-id="aa670-273">Deny all traffic to the Internet.</span></span>

## <a name="high-level-steps"></a><span data-ttu-id="aa670-274">Passaggi di livello elevato</span><span class="sxs-lookup"><span data-stu-id="aa670-274">High level steps</span></span>
<span data-ttu-id="aa670-275">Per distribuire lo scenario seguire questi passaggi generali.</span><span class="sxs-lookup"><span data-stu-id="aa670-275">To deploy this scenario, follow the high level steps below.</span></span>

1. <span data-ttu-id="aa670-276">Effettuare l'accesso alla sottoscrizione di Azure.</span><span class="sxs-lookup"><span data-stu-id="aa670-276">Login to your Azure Subscription.</span></span>
2. <span data-ttu-id="aa670-277">Se si intende distribuire una rete virtuale per simulare la rete locale, effettuare il provisioning delle risorse che fanno parte di **ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="aa670-277">If you want to deploy a VNet to mimic the on-premises network, provision the resources that are part of **ONPREMRG**.</span></span>
3. <span data-ttu-id="aa670-278">Effettuare il provisioning delle risorse che fanno parte di **AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="aa670-278">Provision the resources that are part of **AZURERG**.</span></span>
4. <span data-ttu-id="aa670-279">Effettuare il provisioning del tunnel da **onpremvnet** ad **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="aa670-279">Provision the tunnel from **onpremvnet** to **azurevnet**.</span></span>
5. <span data-ttu-id="aa670-280">Dopo aver effettuato il provisioning di tutte le risorse, accedere a **onpremvm2** ed eseguire il ping di 10.0.3.101 per verificare la connessione tra **onpremsn2** e **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="aa670-280">Once all resources are provisioned, log on to **onpremvm2** and ping 10.0.3.101 to test connectivity between **onpremsn2** and **azsn3**.</span></span>

