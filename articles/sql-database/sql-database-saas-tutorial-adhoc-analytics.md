---
title: "Eseguire query di analisi ad-hoc su più database SQL di Azure | Microsoft Docs"
description: "Eseguire query di analisi ad-hoc su più database SQL nell'app multi-tenant SaaS Wingtip."
keywords: esercitazione database SQL
services: sql-database
documentationcenter: 
author: stevestein
manager: jhubbard
editor: 
ms.assetid: 
ms.service: sql-database
ms.custom: scale out apps
ms.workload: data-management
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 06/23/2017
ms.author: billgib; sstein
ms.openlocfilehash: c287fe5d6b333c749b0580b5253e7e46ac27232b
ms.sourcegitcommit: f537befafb079256fba0529ee554c034d73f36b0
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 07/11/2017
---
# <a name="run-ad-hoc-analytics-queries-across-all-wingtip-saas-tenants"></a><span data-ttu-id="5885e-104">Eseguire query di analisi ad-hoc su tutti i tenant SaaS Wingtip</span><span class="sxs-lookup"><span data-stu-id="5885e-104">Run ad-hoc analytics queries across all Wingtip SaaS tenants</span></span>

<span data-ttu-id="5885e-105">In questa esercitazione verranno eseguite query distribuite sull'intero set di database tenant per consentire analisi ad hoc.</span><span class="sxs-lookup"><span data-stu-id="5885e-105">In this tutorial, you run distributed queries across the entire set of tenant databases to enable ad-hoc analytics.</span></span> <span data-ttu-id="5885e-106">Viene usata la funzionalità di query elastica per abilitare le query distribuite, che richiede la distribuzione di un database di analisi aggiuntivo nel server di catalogo.</span><span class="sxs-lookup"><span data-stu-id="5885e-106">Elastic Query is used to enable distributed queries, which requires an additional analytics database is deployed (to the catalog server).</span></span> <span data-ttu-id="5885e-107">Queste query consentono di estrarre informazioni approfondite nascoste nei dati operativi quotidiani dell'app SaaS Wingtip.</span><span class="sxs-lookup"><span data-stu-id="5885e-107">These queries can extract insights buried in the day-to-day operational data of the Wingtip SaaS app.</span></span>


<span data-ttu-id="5885e-108">In questa esercitazione si apprenderà:</span><span class="sxs-lookup"><span data-stu-id="5885e-108">In this tutorial you learn:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="5885e-109">Informazioni sulle viste globali in ogni database, che consentono l'esecuzione di query efficienti tra i tenant</span><span class="sxs-lookup"><span data-stu-id="5885e-109">About the global views in each database, that enable efficient querying across tenants</span></span>
> * <span data-ttu-id="5885e-110">Come distribuire un database di analisi ad hoc</span><span class="sxs-lookup"><span data-stu-id="5885e-110">How to deploy an ad-hoc analytics database</span></span>
> * <span data-ttu-id="5885e-111">Come eseguire query distribuite su tutti i database tenant</span><span class="sxs-lookup"><span data-stu-id="5885e-111">How to run distributed queries across all tenant databases</span></span>



<span data-ttu-id="5885e-112">Per completare questa esercitazione, verificare che siano soddisfatti i prerequisiti seguenti:</span><span class="sxs-lookup"><span data-stu-id="5885e-112">To complete this tutorial, make sure the following prerequisites are completed:</span></span>

* <span data-ttu-id="5885e-113">L'app SaaS Wingtip viene distribuita.</span><span class="sxs-lookup"><span data-stu-id="5885e-113">The Wingtip SaaS app is deployed.</span></span> <span data-ttu-id="5885e-114">Per distribuire in meno di cinque minuti, vedere [Distribuire ed esplorare l'applicazione SaaS Wingtip](sql-database-saas-tutorial.md)</span><span class="sxs-lookup"><span data-stu-id="5885e-114">To deploy in less than five minutes, see [Deploy and explore the Wingtip SaaS application](sql-database-saas-tutorial.md)</span></span>
* <span data-ttu-id="5885e-115">Azure PowerShell è installato.</span><span class="sxs-lookup"><span data-stu-id="5885e-115">Azure PowerShell is installed.</span></span> <span data-ttu-id="5885e-116">Per informazioni dettagliate, vedere [Introduzione ad Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps)</span><span class="sxs-lookup"><span data-stu-id="5885e-116">For details, see [Getting started with Azure PowerShell](https://docs.microsoft.com/powershell/azure/get-started-azureps)</span></span>
* <span data-ttu-id="5885e-117">SQL Server Management Studio (SSMS) è installato.</span><span class="sxs-lookup"><span data-stu-id="5885e-117">SQL Server Management Studio (SSMS) is installed.</span></span> <span data-ttu-id="5885e-118">Per scaricare e installare SSMS, vedere [Scaricare SQL Server Management Studio](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms).</span><span class="sxs-lookup"><span data-stu-id="5885e-118">To download and install SSMS, see [Download SQL Server Management Studio (SSMS)](https://docs.microsoft.com/sql/ssms/download-sql-server-management-studio-ssms).</span></span>


## <a name="ad-hoc-analytics-pattern"></a><span data-ttu-id="5885e-119">Modello di analisi ad hoc</span><span class="sxs-lookup"><span data-stu-id="5885e-119">Ad-hoc analytics pattern</span></span>

<span data-ttu-id="5885e-120">Una delle grandi opportunità offerte dalle applicazioni SaaS è la possibilità di usare enormi quantità di dati dei tenant archiviati in modo centralizzato nel cloud.</span><span class="sxs-lookup"><span data-stu-id="5885e-120">One of the great opportunities with SaaS applications is to use the vast amount of tenant data stored centrally in the cloud.</span></span> <span data-ttu-id="5885e-121">Usare questi dati per ottenere informazioni approfondite sul funzionamento e l'utilizzo delle applicazioni, sui tenant, i relativi utenti e le loro preferenze, i loro comportamenti e così via. Queste informazioni possono essere utili come base per progettare sviluppi futuri, miglioramenti dell'usabilità e altri investimenti per app e servizi.</span><span class="sxs-lookup"><span data-stu-id="5885e-121">Use this data to gain insights into the operation and usage of your application, your tenants, their users, preferences, behaviors, etc. These insights can guide feature development, usability improvements, and other investments in your apps and services.</span></span>

<span data-ttu-id="5885e-122">L'accesso a questi dati è semplice quando sono raccolti in un singolo database multi-tenant, ma non è altrettanto semplice in una distribuzione su larga scala potenzialmente in migliaia di database.</span><span class="sxs-lookup"><span data-stu-id="5885e-122">Accessing this data in a single multi-tenant database is easy, but not so easy when distributed at scale across potentially thousands of databases.</span></span> <span data-ttu-id="5885e-123">Uno degli approcci possibili prevede l'uso di una [query elastica](sql-database-elastic-query-overview.md), che consente di eseguire query su un set di database distribuiti con uno schema comune.</span><span class="sxs-lookup"><span data-stu-id="5885e-123">One approach is to use [Elastic Query](sql-database-elastic-query-overview.md), which enables querying across a distributed set of databases with common schema.</span></span> <span data-ttu-id="5885e-124">La query elastica usa un singolo database *principale* in cui sono definite le tabelle esterne speculari alle tabelle o alle viste nei database (tenant) distribuiti.</span><span class="sxs-lookup"><span data-stu-id="5885e-124">Elastic Query uses a single *head* database in which external tables are defined that mirror tables or views in the distributed (tenant) databases.</span></span> <span data-ttu-id="5885e-125">Le query inviate a questo database principale vengono compilate per produrre un piano di query distribuito, con il push di parti della query ai database tenant all'occorrenza.</span><span class="sxs-lookup"><span data-stu-id="5885e-125">Queries submitted to this head database are compiled to produce a distributed query plan, with portions of the query pushed down to the tenant databases as needed.</span></span> <span data-ttu-id="5885e-126">La query elastica usa la mappa partizioni nel database del catalogo per fornire la posizione dei database tenant.</span><span class="sxs-lookup"><span data-stu-id="5885e-126">Elastic Query uses the shard map in the catalog database to provide the location of the tenant databases.</span></span> <span data-ttu-id="5885e-127">La configurazione e l'esecuzione di query sono semplici con il linguaggio [Transact-SQL](https://docs.microsoft.com/sql/t-sql/language-reference) standard e sono supportate query ad hoc da strumenti come Power BI ed Excel.</span><span class="sxs-lookup"><span data-stu-id="5885e-127">Setup and query are straightforward using standard [Transact-SQL](https://docs.microsoft.com/sql/t-sql/language-reference), and support ad-hoc querying from tools like Power BI and Excel.</span></span>

<span data-ttu-id="5885e-128">Grazie alla distribuzione delle query tra i database tenant, la query elastica offre informazioni dettagliate immediate sui dati di produzione attivi.</span><span class="sxs-lookup"><span data-stu-id="5885e-128">By distributing queries across the tenant databases, Elastic Query provides immediate insight into live production data.</span></span> <span data-ttu-id="5885e-129">Tuttavia, dato che la query elastica esegue il pull dei dati potenzialmente da molti database, la latenza delle query può talvolta essere superiore a quella di query equivalenti inviate a un singolo database multi-tenant.</span><span class="sxs-lookup"><span data-stu-id="5885e-129">However, as Elastic Query pulls data from potentially many databases, query latency can sometimes be higher than for equivalent queries submitted to a single multi-tenant database.</span></span> <span data-ttu-id="5885e-130">Occorre prestare attenzione quando si progettano le query per ridurre al minimo i dati restituiti.</span><span class="sxs-lookup"><span data-stu-id="5885e-130">Care should be taken when designing queries to minimize the data that is returned.</span></span> <span data-ttu-id="5885e-131">La query elastica è spesso la soluzione ideale per eseguire query su piccole quantità di dati in tempo reale, in alternativa alla creazione di query analitiche o report usati di frequente e complessi.</span><span class="sxs-lookup"><span data-stu-id="5885e-131">Elastic Query is often best suited for querying small amounts of real-time data, as opposed to building frequently used or complex analytics queries or reports.</span></span> <span data-ttu-id="5885e-132">Se le query non offrono prestazioni adeguate, esaminare il [piano di esecuzione](https://docs.microsoft.com/sql/relational-databases/performance/display-an-actual-execution-plan) per scoprire quale parte della query è stata inviata al database remoto e quanti dati vengono restituiti.</span><span class="sxs-lookup"><span data-stu-id="5885e-132">If queries don't perform well, look at the [execution plan](https://docs.microsoft.com/sql/relational-databases/performance/display-an-actual-execution-plan) to see what part of the query has been pushed down to the remote database and how much data is being returned.</span></span> <span data-ttu-id="5885e-133">Per ottenere un servizio migliore per le query che richiedono un'elaborazione analitica complessa, in alcuni casi è consigliabile estrarre i dati tenant in un database dedicato o in un data warehouse ottimizzato per le query analitiche.</span><span class="sxs-lookup"><span data-stu-id="5885e-133">Queries that require complex analytical processing may be better served in some cases by extracting tenant data into a dedicated database or data warehouse optimized for analytics queries.</span></span> <span data-ttu-id="5885e-134">Questo modello è spiegato nell'[esercitazione sull'analisi dei tenant](sql-database-saas-tutorial-tenant-analytics.md).</span><span class="sxs-lookup"><span data-stu-id="5885e-134">This pattern is explained in the [tenant analytics tutorial](sql-database-saas-tutorial-tenant-analytics.md).</span></span> 

## <a name="get-the-wingtip-application-scripts"></a><span data-ttu-id="5885e-135">Ottenere gli script dell'applicazione Wingtip</span><span class="sxs-lookup"><span data-stu-id="5885e-135">Get the Wingtip application scripts</span></span>

<span data-ttu-id="5885e-136">Gli script dell'app SaaS Wingtip e il codice sorgente dell'applicazione sono disponibili nel repository GitHub [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS).</span><span class="sxs-lookup"><span data-stu-id="5885e-136">The Wingtip SaaS scripts and application source code are available in the [WingtipSaaS](https://github.com/Microsoft/WingtipSaaS) github repo.</span></span> <span data-ttu-id="5885e-137">[Procedura per scaricare gli script dell'app SaaS Wingtip](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span><span class="sxs-lookup"><span data-stu-id="5885e-137">[Steps to download the Wingtip SaaS scripts](sql-database-wtp-overview.md#download-and-unblock-the-wingtip-saas-scripts).</span></span>

## <a name="create-ticket-sales-data"></a><span data-ttu-id="5885e-138">Creare i dati di vendita dei biglietti</span><span class="sxs-lookup"><span data-stu-id="5885e-138">Create ticket sales data</span></span>

<span data-ttu-id="5885e-139">Per eseguire query su un set di dati più interessante, creare i dati di vendita dei biglietti eseguendo il generatore di biglietti.</span><span class="sxs-lookup"><span data-stu-id="5885e-139">To run queries against a more interesting data set, create ticket sales data by running the ticket-generator.</span></span>

1. <span data-ttu-id="5885e-140">In *PowerShell ISE* aprire lo script \\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1* e impostare i valori seguenti:</span><span class="sxs-lookup"><span data-stu-id="5885e-140">In the *PowerShell ISE*, open the ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1* script and set the following values:</span></span>
   * <span data-ttu-id="5885e-141">**$DemoScenario** = 1, **Acquistare biglietti per gli eventi in tutte le sedi**.</span><span class="sxs-lookup"><span data-stu-id="5885e-141">**$DemoScenario** = 1, **Purchase tickets for events at all venues**.</span></span>
2. <span data-ttu-id="5885e-142">Premere **F5** per eseguire lo script e generare i dati di vendita dei biglietti.</span><span class="sxs-lookup"><span data-stu-id="5885e-142">Press **F5** to run the script and generate ticket sales.</span></span> <span data-ttu-id="5885e-143">Durante l'esecuzione dello script, è possibile continuare la procedura in questa esercitazione.</span><span class="sxs-lookup"><span data-stu-id="5885e-143">While the script is running, continue the steps in this tutorial.</span></span> <span data-ttu-id="5885e-144">I dati sui biglietti vengono recuperati nella sezione *Eseguire query distribuite ad hoc*, quindi attendere che il generatore di biglietti completi le operazioni se è ancora in esecuzione quando si arriva a tale esercizio.</span><span class="sxs-lookup"><span data-stu-id="5885e-144">The ticket data is queried in the *Run ad-hoc distributed queries* section, so wait for the ticket generator to complete if it's still running when you get to that exercise.</span></span>

## <a name="explore-the-global-views"></a><span data-ttu-id="5885e-145">Esplorare le viste globali</span><span class="sxs-lookup"><span data-stu-id="5885e-145">Explore the global views</span></span>

<span data-ttu-id="5885e-146">L'applicazione SaaS Wingtip è compilata in base a un modello che usa un database per ogni tenant. Lo schema del database tenant è quindi definito dal punto di vista di un tenant singolo.</span><span class="sxs-lookup"><span data-stu-id="5885e-146">The Wingtip SaaS application is built using a tenant-per-database model, so the tenant database schema is defined from a single-tenant perspective.</span></span> <span data-ttu-id="5885e-147">Le informazioni specifiche sul tenant sono presenti in una sola tabella *Venue*, che contiene sempre una singola riga ed è implementata come heap, senza una chiave primaria.</span><span class="sxs-lookup"><span data-stu-id="5885e-147">Tenant-specific information exists in one table, *Venue*, which always has a single row, and is implemented as a heap, without a primary key.</span></span> <span data-ttu-id="5885e-148">Non è necessario che le altre tabelle nello schema siano correlate alla tabella *Venue*, perché nell'uso normale l'appartenenza dei dati ai tenant non è mai dubbia.</span><span class="sxs-lookup"><span data-stu-id="5885e-148">Other tables in the schema don't need to be related to the *Venue* table, because in normal use, there is never any doubt which tenant the data belongs to.</span></span>

<span data-ttu-id="5885e-149">Quando si eseguono query su tutti i database, tuttavia, è importante che la query elastica possa trattare i dati come se facessero parte di un singolo database logico partizionato dal tenant.</span><span class="sxs-lookup"><span data-stu-id="5885e-149">However, when querying across all databases, it's important that Elastic Query can treat the data as if it is part of a single logical database sharded by tenant.</span></span> <span data-ttu-id="5885e-150">A tale scopo, viene aggiunto un set di viste 'globali' al database tenant che proiettano un ID tenant in ogni tabella sottoposta a query a livello globale.</span><span class="sxs-lookup"><span data-stu-id="5885e-150">To achieve this, a set of 'global' views are added to the tenant database that project a tenant id into each of the tables that are queried globally.</span></span> <span data-ttu-id="5885e-151">Ad esempio, la vista *VenueEvents* aggiunge un *VenueId* calcolato alle colonne proiettate dalla tabella *Events*.</span><span class="sxs-lookup"><span data-stu-id="5885e-151">For example, the *VenueEvents* view adds a computed *VenueId* to the columns projected from the *Events* table.</span></span> <span data-ttu-id="5885e-152">Tramite la definizione della tabella esterna nel database principale su *VenueEvents* (invece della tabella sottostante *Events*), la query elastica può eseguire il push dei join in base a *VenueId*, in modo che possano essere eseguiti in parallelo su ogni database remoto, anziché sul database principale.</span><span class="sxs-lookup"><span data-stu-id="5885e-152">By defining the external table in the head database over *VenueEvents* (rather than the underlying *Events* table), Elastic Query is able to push down joins based on *VenueId* so they can be executed in parallel on each remote database (rather than on the head database).</span></span> <span data-ttu-id="5885e-153">Questo riduce drasticamente la quantità di dati restituita, con conseguente miglioramento sostanziale delle prestazioni per molte query.</span><span class="sxs-lookup"><span data-stu-id="5885e-153">This dramatically reduces the amount of data that is returned, which results in a substantial increase in performance for many queries.</span></span> <span data-ttu-id="5885e-154">Queste viste globali sono state già create in tutti i database tenant e in *basetenantdb*.</span><span class="sxs-lookup"><span data-stu-id="5885e-154">These global views have been pre-created in all tenant databases (and in *basetenantdb*).</span></span>

1. <span data-ttu-id="5885e-155">Aprire SSMS e [connettersi al server tenants1-&lt;USER&gt;](sql-database-wtp-overview.md#explore-database-schema-and-execute-sql-queries-using-ssms).</span><span class="sxs-lookup"><span data-stu-id="5885e-155">Open SSMS and [connect to the tenants1-&lt;USER&gt; server](sql-database-wtp-overview.md#explore-database-schema-and-execute-sql-queries-using-ssms).</span></span>
2. <span data-ttu-id="5885e-156">Espandere **Database**, fare clic con il pulsante destro del mouse su **contosoconcerthall** e selezionare **Nuova query**.</span><span class="sxs-lookup"><span data-stu-id="5885e-156">Expand **Databases**, right-click **contosoconcerthall**, and select **New Query**.</span></span>
3. <span data-ttu-id="5885e-157">Eseguire le query seguenti per esplorare la differenza tra le tabelle a tenant singolo e le viste globali:</span><span class="sxs-lookup"><span data-stu-id="5885e-157">Run the following queries to explore the difference between the single-tenant tables and the global views:</span></span>

   ```T-SQL
   -- The base Venue table, that has no VenueId associated.
   SELECT * FROM Venue

   -- Notice the plural name 'Venues'. This view projects a VenueId column.
   SELECT * FROM Venues

   -- The base Events table, which has no VenueId column.
   SELECT * FROM Events

   -- This view projects the VenueId retrieved from the Venues table.
   SELECT * FROM VenueEvents
   ```

<span data-ttu-id="5885e-158">In queste viste, *VenueId* viene calcolato come hash del nome Venue, ma si può usare qualsiasi approccio per introdurre un valore univoco.</span><span class="sxs-lookup"><span data-stu-id="5885e-158">In these views, the *VenueId* is computed as a hash of the Venue name, but any approach could be used to introduce a unique value.</span></span> <span data-ttu-id="5885e-159">Questo approccio è simile al modo in cui viene calcolata la chiave del tenant per l'uso nel catalogo.</span><span class="sxs-lookup"><span data-stu-id="5885e-159">This approach is similar to the way the tenant key is computed for use in the catalog.</span></span>

<span data-ttu-id="5885e-160">Per esaminare la definizione della vista *Venues*:</span><span class="sxs-lookup"><span data-stu-id="5885e-160">To examine the definition of the *Venues* view:</span></span>

1. <span data-ttu-id="5885e-161">In **Esplora oggetti** espandere **contosoconcethall** > **Viste**:</span><span class="sxs-lookup"><span data-stu-id="5885e-161">In **Object Explorer**, expand **contosoconcethall** > **Views**:</span></span>

   ![Viste](media/sql-database-saas-tutorial-adhoc-analytics/views.png)

2. <span data-ttu-id="5885e-163">Fare clic con il pulsante destro del mouse su **dbo.Venues**.</span><span class="sxs-lookup"><span data-stu-id="5885e-163">Right-click **dbo.Venues**.</span></span>
3. <span data-ttu-id="5885e-164">Selezionare **Crea script per vista** > **CREATE in** > **Nuova finestra editor di query**.</span><span class="sxs-lookup"><span data-stu-id="5885e-164">Select **Script View as** > **CREATE To** > **New Query Editor Window**</span></span>

<span data-ttu-id="5885e-165">Creare uno script per qualsiasi altra vista *Venue* per scoprire come viene aggiunto *VenueId*.</span><span class="sxs-lookup"><span data-stu-id="5885e-165">Script any of the other *Venue* views to see how they add the *VenueId*.</span></span>

## <a name="deploy-the-database-used-for-ad-hoc-distributed-queries"></a><span data-ttu-id="5885e-166">Distribuire il database usato per le query distribuite ad hoc</span><span class="sxs-lookup"><span data-stu-id="5885e-166">Deploy the database used for ad-hoc distributed queries</span></span>

<span data-ttu-id="5885e-167">Questo esercizio permette di distribuire il database *adhocanalytics*,</span><span class="sxs-lookup"><span data-stu-id="5885e-167">This exercise deploys the *adhocanalytics* database.</span></span> <span data-ttu-id="5885e-168">ovvero il database principale che conterrà lo schema usato per l'esecuzione di query su tutti i database tenant.</span><span class="sxs-lookup"><span data-stu-id="5885e-168">This is the head database that will contain the schema used for querying across all tenant databases.</span></span> <span data-ttu-id="5885e-169">Il database viene distribuito nel server di catalogo esistente, vale a dire il server usato per tutti i database correlati alla gestione nell'app di esempio.</span><span class="sxs-lookup"><span data-stu-id="5885e-169">The database is deployed to the existing catalog server, which is the server used for all management-related databases in the sample app.</span></span>

1. <span data-ttu-id="5885e-170">Aprire ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1* in *PowerShell ISE* e impostare i valori seguenti:</span><span class="sxs-lookup"><span data-stu-id="5885e-170">Open ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalytics.ps1* in the *PowerShell ISE* and set the following values:</span></span>
   * <span data-ttu-id="5885e-171">**$DemoScenario** = 2, **Distribuire un database di analisi ad hoc**.</span><span class="sxs-lookup"><span data-stu-id="5885e-171">**$DemoScenario** = 2, **Deploy Ad-hoc analytics database**.</span></span>

2. <span data-ttu-id="5885e-172">Premere **F5** per eseguire lo script e creare il database *adhocanalytics*.</span><span class="sxs-lookup"><span data-stu-id="5885e-172">Press **F5** to run the script and create the *adhocanalytics* database.</span></span>

<span data-ttu-id="5885e-173">Nella prossima sezione si aggiungerà lo schema al database in modo da poterlo usare per eseguire query distribuite.</span><span class="sxs-lookup"><span data-stu-id="5885e-173">In the next section, you add schema to the database so it can be used to run distributed queries.</span></span>

## <a name="configure-the-database-for-running-distributed-queries"></a><span data-ttu-id="5885e-174">Configurare il database per l'esecuzione di query distribuite</span><span class="sxs-lookup"><span data-stu-id="5885e-174">Configure the database for running distributed queries</span></span>

<span data-ttu-id="5885e-175">Questo esercizio aggiunge lo schema (definizioni dell'origine dati esterna e della tabella esterna) al database di analisi ad hoc che consente l'esecuzione di query su tutti i database tenant.</span><span class="sxs-lookup"><span data-stu-id="5885e-175">This exercise adds schema (the external data source and external table definitions) to the ad-hoc analytics database that enables querying across all tenant databases.</span></span>

1. <span data-ttu-id="5885e-176">Aprire SQL Server Management Studio e connettersi al database di analisi ad hoc creato nel passaggio precedente.</span><span class="sxs-lookup"><span data-stu-id="5885e-176">Open SQL Server Management Studio, and connect to the Adhoc Analytics database you created in the previous step.</span></span> <span data-ttu-id="5885e-177">Il nome del database è adhocanalytics.</span><span class="sxs-lookup"><span data-stu-id="5885e-177">The name of the database will be adhocanalytics.</span></span>
2. <span data-ttu-id="5885e-178">Aprire ...\Learning Modules\Operational Analytics\Adhoc Analytics\ *Initialize-AdhocAnalyticsDB.sql* in SSMS.</span><span class="sxs-lookup"><span data-stu-id="5885e-178">Open ...\Learning Modules\Operational Analytics\Adhoc Analytics\ *Initialize-AdhocAnalyticsDB.sql* in SSMS.</span></span>
3. <span data-ttu-id="5885e-179">Esaminare lo script SQL e tenere presente quanto segue:</span><span class="sxs-lookup"><span data-stu-id="5885e-179">Review the SQL script and note the following:</span></span>

   <span data-ttu-id="5885e-180">La query elastica usa credenziali con ambito database per accedere a ognuno dei database tenant.</span><span class="sxs-lookup"><span data-stu-id="5885e-180">Elastic Query uses a database-scoped credential to access each of the tenant databases.</span></span> <span data-ttu-id="5885e-181">Tali credenziali devono essere disponibili in tutti i database e, in genere, devono avere i diritti minimi necessari per abilitare le query ad hoc.</span><span class="sxs-lookup"><span data-stu-id="5885e-181">This credential needs to be available in all the databases and should normally be granted the minimum rights required to enable these ad-hoc queries.</span></span>

    ![creare le credenziali](media/sql-database-saas-tutorial-adhoc-analytics/create-credential.png)

   <span data-ttu-id="5885e-183">L'origine dati esterna, definita in modo da usare la mappa partizioni del tenant nel database del catalogo.</span><span class="sxs-lookup"><span data-stu-id="5885e-183">The external data source, that is defined to use the tenant shard map in the catalog database.</span></span> <span data-ttu-id="5885e-184">Usando questa come origine dati esterna, le query verranno distribuite a tutti i database registrati nel catalogo nel momento in cui viene eseguita la query.</span><span class="sxs-lookup"><span data-stu-id="5885e-184">By using this as the external data source, queries are distributed to all databases registered in the catalog when the query is run.</span></span> <span data-ttu-id="5885e-185">Dato che i nomi dei server sono diversi per ogni distribuzione, questo script di inizializzazione ottiene la posizione del database del catalogo recuperando il server corrente (@@servername) in cui viene eseguito lo script.</span><span class="sxs-lookup"><span data-stu-id="5885e-185">Because server names are different for each deployment, this initialization script gets the location of the catalog database by retrieving the current server (@@servername) where the script is executed.</span></span>

    ![creare l'origine dati esterna](media/sql-database-saas-tutorial-adhoc-analytics/create-external-data-source.png)

   <span data-ttu-id="5885e-187">Le tabelle esterne che fanno riferimento alle viste globali descritte nella sezione precedente e definite con **DISTRIBUTION = SHARDED(VenueId)**.</span><span class="sxs-lookup"><span data-stu-id="5885e-187">The external tables that reference the global views described in the previous section, and defined with **DISTRIBUTION = SHARDED(VenueId)**.</span></span> <span data-ttu-id="5885e-188">Dato che ogni *VenueId* corrisponde a un singolo database, ciò migliora le prestazioni per molti scenari, come illustrato nella sezione successiva.</span><span class="sxs-lookup"><span data-stu-id="5885e-188">Because each *VenueId* maps to a single database, this improves performance for many scenarios as shown in the next section.</span></span>

    ![creare tabelle esterne](media/sql-database-saas-tutorial-adhoc-analytics/external-tables.png)

   <span data-ttu-id="5885e-190">La tabella locale *VenueTypes* che viene creata e popolata.</span><span class="sxs-lookup"><span data-stu-id="5885e-190">The local table *VenueTypes* that is created and populated.</span></span> <span data-ttu-id="5885e-191">Questa tabella di dati di riferimento è comune in tutti i database tenant, pertanto può essere rappresentata come tabella locale e popolata con i dati comuni.</span><span class="sxs-lookup"><span data-stu-id="5885e-191">This reference data table is common in all tenant databases, so it can be represented here as a local table and populated with the common data.</span></span> <span data-ttu-id="5885e-192">Per alcune query questo potrebbe ridurre la quantità di dati spostati tra i database tenant e il database *adhocanalytics*.</span><span class="sxs-lookup"><span data-stu-id="5885e-192">For some queries this may reduce the amount of data moved between the tenant databases and the *adhocanalytics* database.</span></span>

    ![creare la tabella](media/sql-database-saas-tutorial-adhoc-analytics/create-table.png)

   <span data-ttu-id="5885e-194">Se si includono tabelle di riferimento in questo modo, assicurarsi di aggiornare lo schema di tabella e i dati ogni volta che si aggiornano i database tenant.</span><span class="sxs-lookup"><span data-stu-id="5885e-194">If you include reference tables in this manner, be sure to update the table schema and data whenever you update the tenant databases.</span></span>

4. <span data-ttu-id="5885e-195">Premere **F5** per eseguire lo script e inizializzare il database *adhocanalytics*.</span><span class="sxs-lookup"><span data-stu-id="5885e-195">Press **F5** to run the script and initialize the *adhocanalytics* database.</span></span> 

<span data-ttu-id="5885e-196">È ora possibile eseguire query distribuite e ottenere informazioni dettagliate da tutti i tenant.</span><span class="sxs-lookup"><span data-stu-id="5885e-196">Now you can run distributed queries, and gather insights across all tenants!</span></span>

## <a name="run-ad-hoc-distributed-queries"></a><span data-ttu-id="5885e-197">Eseguire query distribuite ad hoc</span><span class="sxs-lookup"><span data-stu-id="5885e-197">Run ad-hoc distributed queries</span></span>

<span data-ttu-id="5885e-198">Ora che il database *adhocanalytics* è configurato, è possibile procedere ed eseguire alcune query distribuite.</span><span class="sxs-lookup"><span data-stu-id="5885e-198">Now that the *adhocanalytics* database is set up, go ahead and run some distributed queries.</span></span> <span data-ttu-id="5885e-199">Includere il piano di esecuzione per una migliore comprensione della posizione in cui avviene l'elaborazione delle query.</span><span class="sxs-lookup"><span data-stu-id="5885e-199">Include the execution plan for a better understanding of where the query processing is happening.</span></span> 

<span data-ttu-id="5885e-200">Quando si esamina il piano di esecuzione, passare il mouse sulle icone del piano per visualizzare i dettagli.</span><span class="sxs-lookup"><span data-stu-id="5885e-200">When inspecting the execution plan, hover over the plan icons for details.</span></span> 

<span data-ttu-id="5885e-201">È importante sottolineare che l'impostazione **DISTRIBUTION = SHARDED(VenueId)**, usata per la definizione dell'origine dati esterna, consente di migliorare le prestazioni in molti scenari.</span><span class="sxs-lookup"><span data-stu-id="5885e-201">Important to note, is that setting **DISTRIBUTION = SHARDED(VenueId)** when we defined the external data source, improves performance for many scenarios.</span></span> <span data-ttu-id="5885e-202">Dato che ogni *VenueId* corrisponde a un singolo database, è possibile filtrare facilmente i dati in remoto e restituire solo i dati necessari.</span><span class="sxs-lookup"><span data-stu-id="5885e-202">Because each *VenueId* maps to a single database, filtering is easily done remotely, returning only the data we need.</span></span>

1. <span data-ttu-id="5885e-203">Aprire ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalyticsQueries.sql* in SSMS.</span><span class="sxs-lookup"><span data-stu-id="5885e-203">Open ...\\Learning Modules\\Operational Analytics\\Adhoc Analytics\\*Demo-AdhocAnalyticsQueries.sql* in SSMS.</span></span>
2. <span data-ttu-id="5885e-204">Assicurarsi di essere connessi al database **adhocanalytics**.</span><span class="sxs-lookup"><span data-stu-id="5885e-204">Ensure you are connected to the **adhocanalytics** database.</span></span>
3. <span data-ttu-id="5885e-205">Selezionare il menu **Query** e fare clic su **Includi piano di esecuzione effettivo**</span><span class="sxs-lookup"><span data-stu-id="5885e-205">Select the **Query** menu and click **Include Actual Execution Plan**</span></span>
4. <span data-ttu-id="5885e-206">Evidenziare la query *Which venues are currently registered?* e premere **F5**.</span><span class="sxs-lookup"><span data-stu-id="5885e-206">Highlight the *Which venues are currently registered?* query, and press **F5**.</span></span>

   <span data-ttu-id="5885e-207">La query restituisce l'intero elenco di sedi, dimostrando come sia semplice e veloce eseguire una query su tutti i tenant e restituire i dati da ogni tenant.</span><span class="sxs-lookup"><span data-stu-id="5885e-207">The query returns the entire venue list, illustrating how quick and easy it is to query across all tenants and return data from each tenant.</span></span>

   <span data-ttu-id="5885e-208">Esaminare il piano e notare che l'intero costo è la query remota, perché l'operazione prevede semplicemente il passaggio a ogni database tenant e la selezione delle informazioni sulle sedi degli eventi.</span><span class="sxs-lookup"><span data-stu-id="5885e-208">Inspect the plan and see that the entire cost is the remote query because we're simply going to each tenant database and selecting the venue information.</span></span>

   ![SELECT * FROM dbo.Venues](media/sql-database-saas-tutorial-adhoc-analytics/query1-plan.png)

5. <span data-ttu-id="5885e-210">Selezionare la query successiva e premere **F5**.</span><span class="sxs-lookup"><span data-stu-id="5885e-210">Select the next query, and press **F5**.</span></span>

   <span data-ttu-id="5885e-211">La query unisce i dati dai database tenant e dalla tabella *VenueTypes* locale (locale perché è una tabella nel database *adhocanalytics*).</span><span class="sxs-lookup"><span data-stu-id="5885e-211">This query joins data from the tenant databases and the local *VenueTypes* table (local, as its a table in the *adhocanalytics* database).</span></span>

   <span data-ttu-id="5885e-212">Esaminare il piano e verificare che la maggior parte del costo è rappresentato dalla query remota, perché vengono recuperate le informazioni sulle sedi di ogni tenant (dbo.Venues) e quindi si esegue un rapido join locale con la tabella *VenueTypes* locale per visualizzare il nome descrittivo.</span><span class="sxs-lookup"><span data-stu-id="5885e-212">Inspect the plan and see that the majority of cost is the remote query because we query each tenant's venue info (dbo.Venues), and then do a quick local join with the local *VenueTypes* table to display the friendly name.</span></span>

   ![Creare un join su dati remoti e locali](media/sql-database-saas-tutorial-adhoc-analytics/query2-plan.png)

6. <span data-ttu-id="5885e-214">Selezionare ora la query *On which day were the most tickets sold?* e premere **F5**.</span><span class="sxs-lookup"><span data-stu-id="5885e-214">Now select the *On which day were the most tickets sold?* query, and press **F5**.</span></span>

   <span data-ttu-id="5885e-215">Questa query esegue operazioni un po' più complesse di join e aggregazione.</span><span class="sxs-lookup"><span data-stu-id="5885e-215">This query does a bit more complex joining and aggregation.</span></span> <span data-ttu-id="5885e-216">È importante tenere presente che la maggior parte dell'elaborazione viene eseguita in remoto e ancora una volta vengono recuperate solo le righe necessarie, restituendo una singola riga per il totale delle vendite di biglietti aggregato al giorno di ogni sede.</span><span class="sxs-lookup"><span data-stu-id="5885e-216">What's important to note is that most of the processing is done remotely, and once again, we bring back only the rows we need, returning just a single row for each venue's aggregate ticket sale count per day.</span></span>

   ![query](media/sql-database-saas-tutorial-adhoc-analytics/query3-plan.png)


## <a name="next-steps"></a><span data-ttu-id="5885e-218">Passaggi successivi</span><span class="sxs-lookup"><span data-stu-id="5885e-218">Next steps</span></span>

<span data-ttu-id="5885e-219">In questa esercitazione si è appreso come:</span><span class="sxs-lookup"><span data-stu-id="5885e-219">In this tutorial you learned how to:</span></span>

> [!div class="checklist"]

> * <span data-ttu-id="5885e-220">Eseguire query distribuite su tutti i database tenant</span><span class="sxs-lookup"><span data-stu-id="5885e-220">Run distributed queries across all tenant databases</span></span>
> * <span data-ttu-id="5885e-221">Distribuire un database analitico ad hoc e aggiungere lo schema per eseguire query distribuite.</span><span class="sxs-lookup"><span data-stu-id="5885e-221">Deploy an ad-hoc analytics database and add schema to it to run distributed queries.</span></span>


<span data-ttu-id="5885e-222">Provare ora l'[esercitazione sull'analisi dei tenant](sql-database-saas-tutorial-tenant-analytics.md) per esplorare l'estrazione dei dati in un database di analisi separato per elaborazioni analitiche più complesse.</span><span class="sxs-lookup"><span data-stu-id="5885e-222">Now try the [Tenant Analytics tutorial](sql-database-saas-tutorial-tenant-analytics.md) to explore extracting data to a separate analytics database for more complex analytics processing...</span></span>

## <a name="additional-resources"></a><span data-ttu-id="5885e-223">Risorse aggiuntive</span><span class="sxs-lookup"><span data-stu-id="5885e-223">Additional resources</span></span>

* <span data-ttu-id="5885e-224">Altre [esercitazioni basate sull'applicazione SaaS Wingtip](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span><span class="sxs-lookup"><span data-stu-id="5885e-224">Additional [tutorials that build upon the Wingtip SaaS application](sql-database-wtp-overview.md#sql-database-wingtip-saas-tutorials)</span></span>
* [<span data-ttu-id="5885e-225">Query elastica</span><span class="sxs-lookup"><span data-stu-id="5885e-225">Elastic Query</span></span>](sql-database-elastic-query-overview.md)
