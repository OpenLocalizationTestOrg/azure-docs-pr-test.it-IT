---
title: connessione aaaHybrid con applicazioni di livello 2 | Documenti Microsoft
description: "Informazioni su come toodeploy Appliance virtuali e UDR toocreate un ambiente a più livelli applicazione in Azure"
services: virtual-network
documentationcenter: na
author: jimdial
manager: carmonm
editor: tysonn
ms.assetid: 1f509bec-bdd1-470d-8aa4-3cf2bb7f6134
ms.service: virtual-network
ms.devlang: na
ms.topic: article
ms.tgt_pltfrm: na
ms.workload: infrastructure-services
ms.date: 05/05/2016
ms.author: jdial
ms.openlocfilehash: 53599862289dbf9c6ab3289b0cb8dda6430f20f7
ms.sourcegitcommit: 523283cc1b3c37c428e77850964dc1c33742c5f0
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 10/06/2017
---
# <a name="virtual-appliance-scenario"></a><span data-ttu-id="76af4-103">Scenario dell'appliance virtuale</span><span class="sxs-lookup"><span data-stu-id="76af4-103">Virtual appliance scenario</span></span>
<span data-ttu-id="76af4-104">Uno scenario comune tra i clienti di Azure più grandi è hello necessità tooprovide toohello un'applicazione a due livelli esposto Internet, consentendo allo stesso livello di back-toohello accesso da un data center locale.</span><span class="sxs-lookup"><span data-stu-id="76af4-104">A common scenario among larger Azure customer is hello need tooprovide a two-tiered application exposed toohello Internet, while allowing access toohello back tier from an on-premises datacenter.</span></span> <span data-ttu-id="76af4-105">Questo documento verrà illustrati uno scenario utilizzando le route di definito dall'utente (UDR), un Gateway VPN e network Appliance virtuali toodeploy un ambiente a due livelli che soddisfi i seguenti requisiti hello:</span><span class="sxs-lookup"><span data-stu-id="76af4-105">This document will walk you through a scenario using User Defined Routes (UDR), a VPN Gateway, and network virtual appliances toodeploy a two-tier environment that meets hello following requirements:</span></span>

* <span data-ttu-id="76af4-106">Applicazione Web deve essere accessibile da Internet pubblica solo hello.</span><span class="sxs-lookup"><span data-stu-id="76af4-106">Web application must be accessible from hello public Internet only.</span></span>
* <span data-ttu-id="76af4-107">Applicazione hello hosting del server Web deve essere in grado di tooaccess un server applicazioni back-end.</span><span class="sxs-lookup"><span data-stu-id="76af4-107">Web server hosting hello application must be able tooaccess a backend application server.</span></span>
* <span data-ttu-id="76af4-108">Tutto il traffico da applicazione web di Internet toohello hello deve passare attraverso un accessorio virtuale di firewall.</span><span class="sxs-lookup"><span data-stu-id="76af4-108">All traffic from hello Internet toohello web application must go through a firewall virtual appliance.</span></span> <span data-ttu-id="76af4-109">Questa appliance virtuale verrà usata solo per il traffico Internet.</span><span class="sxs-lookup"><span data-stu-id="76af4-109">This virtual appliance will be used for Internet traffic only.</span></span>
* <span data-ttu-id="76af4-110">Tutto il traffico verso i server applicazioni toohello deve passare attraverso un accessorio virtuale di firewall.</span><span class="sxs-lookup"><span data-stu-id="76af4-110">All traffic going toohello application server must go through a firewall virtual appliance.</span></span> <span data-ttu-id="76af4-111">Questo dispositivo virtuale verrà utilizzato per l'accesso provenienti da una rete locale hello tramite un Gateway VPN e server di accesso toohello back-end end.</span><span class="sxs-lookup"><span data-stu-id="76af4-111">This virtual appliance will be used for access toohello backend end server, and access coming in from hello on-premises network via a VPN Gateway.</span></span>
* <span data-ttu-id="76af4-112">Gli amministratori devono essere in grado di toomanage hello firewall dispositivi di rete dal computer locale, utilizzando un terzo firewall appliance virtuale utilizzati esclusivamente per scopi di gestione.</span><span class="sxs-lookup"><span data-stu-id="76af4-112">Administrators must be able toomanage hello firewall virtual appliances from their on-premises computers, by using a third firewall virtual appliance used exclusively for management purposes.</span></span>

<span data-ttu-id="76af4-113">Si tratta di uno scenario di rete perimetrale standard con una rete perimetrale e una rete protetta.</span><span class="sxs-lookup"><span data-stu-id="76af4-113">This is a standard DMZ scenario with a DMZ and a protected network.</span></span> <span data-ttu-id="76af4-114">Questo scenario può essere creato in Azure usando gruppi di sicurezza di rete, appliance virtuali firewall o una combinazione di entrambi.</span><span class="sxs-lookup"><span data-stu-id="76af4-114">Such scenario can be constructed in Azure by using NSGs, firewall virtual appliances, or a combination of both.</span></span> <span data-ttu-id="76af4-115">tabella Hello riportata di seguito vengono illustrate alcune hello vantaggi e svantaggi tra NSGs e Appliance virtuali firewall.</span><span class="sxs-lookup"><span data-stu-id="76af4-115">hello table below shows some of hello pros and cons between NSGs and firewall virtual appliances.</span></span>

|  | <span data-ttu-id="76af4-116">Vantaggi</span><span class="sxs-lookup"><span data-stu-id="76af4-116">Pros</span></span> | <span data-ttu-id="76af4-117">Svantaggi</span><span class="sxs-lookup"><span data-stu-id="76af4-117">Cons</span></span> |
| --- | --- | --- |
| <span data-ttu-id="76af4-118">NSG</span><span class="sxs-lookup"><span data-stu-id="76af4-118">NSG</span></span> |<span data-ttu-id="76af4-119">Nessun costo.</span><span class="sxs-lookup"><span data-stu-id="76af4-119">No cost.</span></span> <br/><span data-ttu-id="76af4-120">Integrato nel controllo degli accessi in base al ruolo di Azure.</span><span class="sxs-lookup"><span data-stu-id="76af4-120">Integrated into Azure RBAC.</span></span> <br/><span data-ttu-id="76af4-121">Le regole possono essere create in modelli di Azure Resource Manager.</span><span class="sxs-lookup"><span data-stu-id="76af4-121">Rules can be created in ARM templates.</span></span> |<span data-ttu-id="76af4-122">La complessità può variare in ambienti più grandi.</span><span class="sxs-lookup"><span data-stu-id="76af4-122">Complexity could vary in larger environments.</span></span> |
| <span data-ttu-id="76af4-123">Firewall</span><span class="sxs-lookup"><span data-stu-id="76af4-123">Firewall</span></span> |<span data-ttu-id="76af4-124">Controllo completo del piano dati.</span><span class="sxs-lookup"><span data-stu-id="76af4-124">Full control over data plane.</span></span> <br/><span data-ttu-id="76af4-125">Gestione centrale con console firewall.</span><span class="sxs-lookup"><span data-stu-id="76af4-125">Central management through firewall console.</span></span> |<span data-ttu-id="76af4-126">Costo dell'appliance firewall.</span><span class="sxs-lookup"><span data-stu-id="76af4-126">Cost of firewall appliance.</span></span> <br/><span data-ttu-id="76af4-127">Non integrato nel controllo degli accessi in base al ruolo di Azure.</span><span class="sxs-lookup"><span data-stu-id="76af4-127">Not integrated with Azure RBAC.</span></span> |

<span data-ttu-id="76af4-128">soluzione Hello seguente Usa firewall Appliance virtuali tooimplement uno scenario di rete protetta/rete Perimetrale.</span><span class="sxs-lookup"><span data-stu-id="76af4-128">hello solution below uses firewall virtual appliances tooimplement a DMZ/protected network scenario.</span></span>

## <a name="considerations"></a><span data-ttu-id="76af4-129">Considerazioni</span><span class="sxs-lookup"><span data-stu-id="76af4-129">Considerations</span></span>
<span data-ttu-id="76af4-130">È possibile distribuire l'ambiente hello illustrati in precedenza in Azure utilizzando diverse funzionalità disponibili oggi, come indicato di seguito.</span><span class="sxs-lookup"><span data-stu-id="76af4-130">You can deploy hello environment explained above in Azure using different features available today, as follows.</span></span>

* <span data-ttu-id="76af4-131">**Rete virtuale**.</span><span class="sxs-lookup"><span data-stu-id="76af4-131">**Virtual network (VNet)**.</span></span> <span data-ttu-id="76af4-132">Una rete virtuale di Azure funziona nella rete di on-premise tooan modo simile e può essere suddiviso in uno o più subnet tooprovide traffico isolamento e la separazione dei compiti.</span><span class="sxs-lookup"><span data-stu-id="76af4-132">An Azure VNet acts in similar fashion tooan on-premises network, and can be segmented into one or more subnets tooprovide traffic isolation, and separation of concerns.</span></span>
* <span data-ttu-id="76af4-133">**Appliance virtuale**.</span><span class="sxs-lookup"><span data-stu-id="76af4-133">**Virtual appliance**.</span></span> <span data-ttu-id="76af4-134">Alcuni partner forniscono Appliance virtuali in hello Azure Marketplace che può essere utilizzato per i firewall di tre hello descritti in precedenza.</span><span class="sxs-lookup"><span data-stu-id="76af4-134">Several partners provide virtual appliances in hello Azure Marketplace that can be used for hello three firewalls described above.</span></span> 
* <span data-ttu-id="76af4-135">**Route definite dall'utente**.</span><span class="sxs-lookup"><span data-stu-id="76af4-135">**User Defined Routes (UDR)**.</span></span> <span data-ttu-id="76af4-136">Tabelle di routing possono contenere UDRs utilizzate da Azure flusso hello toocontrol rete dei pacchetti all'interno di una rete virtuale.</span><span class="sxs-lookup"><span data-stu-id="76af4-136">Route tables can contain UDRs used by Azure networking toocontrol hello flow of packets within a VNet.</span></span> <span data-ttu-id="76af4-137">Queste tabelle di routing possono essere applicato toosubnets.</span><span class="sxs-lookup"><span data-stu-id="76af4-137">These route tables can be applied toosubnets.</span></span> <span data-ttu-id="76af4-138">Una delle funzionalità più recenti di hello in Azure è possibilità di hello tooapply un toohello tabella route GatewaySubnet, fornendo hello possibilità tooforward tutto il traffico in rete virtuale di Azure hello proviene ibrida connessione tooa appliance virtuale.</span><span class="sxs-lookup"><span data-stu-id="76af4-138">One of hello newest features in Azure is hello ability tooapply a route table toohello GatewaySubnet, providing hello ability tooforward all traffic coming into hello Azure VNet from a hybrid connection tooa virtual appliance.</span></span>
* <span data-ttu-id="76af4-139">**Inoltro IP**.</span><span class="sxs-lookup"><span data-stu-id="76af4-139">**IP Forwarding**.</span></span> <span data-ttu-id="76af4-140">Per impostazione predefinita, hello Azure motore rete inoltrare pacchetti toovirtual schede di interfaccia rete (NIC) solo se corrisponde a indirizzo IP di destinazione dei pacchetti hello hello indirizzo IP NIC.</span><span class="sxs-lookup"><span data-stu-id="76af4-140">By default, hello Azure networking engine forward packets toovirtual network interface cards (NICs) only if hello packet destination IP address matches hello NIC IP address.</span></span> <span data-ttu-id="76af4-141">Pertanto, se un UDR definisce che un pacchetto deve essere inviato tooa appliance virtuale di base, hello Azure motore rete scenderanno tale pacchetto.</span><span class="sxs-lookup"><span data-stu-id="76af4-141">Therefore, if a UDR defines that a packet must be sent tooa given virtual appliance, hello Azure networking engine would drop that packet.</span></span> <span data-ttu-id="76af4-142">pacchetto di hello tooensure viene recapitato tooa macchina virtuale (in questo caso, un accessorio virtuale) che non è destinazione effettiva di hello per i pacchetti hello, è necessario tooenable l'inoltro IP per il dispositivo virtuale hello.</span><span class="sxs-lookup"><span data-stu-id="76af4-142">tooensure hello packet is delivered tooa VM (in this case a virtual appliance) that is not hello actual destination for hello packet, you need tooenable IP Forwarding for hello virtual appliance.</span></span>
* <span data-ttu-id="76af4-143">**Gruppi di sicurezza di rete**.</span><span class="sxs-lookup"><span data-stu-id="76af4-143">**Network Security Groups (NSGs)**.</span></span> <span data-ttu-id="76af4-144">esempio Hello seguente non avvalersi della NSGs, ma è possibile utilizzare subnet toohello NSGs applicato e/o schede di rete in questa soluzione toofurther filtro hello il traffico da e verso le subnet e schede di rete.</span><span class="sxs-lookup"><span data-stu-id="76af4-144">hello example below does not make use of NSGs, but you could use NSGs applied toohello subnets and/or NICs in this solution toofurther filter hello traffic in and out of those subnets and NICs.</span></span>

![IPv6 connectivity](./media/virtual-network-scenario-udr-gw-nva/figure01.png)

<span data-ttu-id="76af4-146">In questo esempio è associata una sottoscrizione che contiene la seguente sintassi hello:</span><span class="sxs-lookup"><span data-stu-id="76af4-146">In this example there is a subscription that contains hello following:</span></span>

* <span data-ttu-id="76af4-147">2 gruppi di risorse, non illustrati nel diagramma hello.</span><span class="sxs-lookup"><span data-stu-id="76af4-147">2 resource groups, not shown in hello diagram.</span></span> 
  * <span data-ttu-id="76af4-148">**ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="76af4-148">**ONPREMRG**.</span></span> <span data-ttu-id="76af4-149">Contiene tutte le risorse necessarie toosimulate una rete locale.</span><span class="sxs-lookup"><span data-stu-id="76af4-149">Contains all resources necessary toosimulate an on-premises network.</span></span>
  * <span data-ttu-id="76af4-150">**AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="76af4-150">**AZURERG**.</span></span> <span data-ttu-id="76af4-151">Contiene tutte le risorse necessarie per l'ambiente di rete virtuale di Azure hello.</span><span class="sxs-lookup"><span data-stu-id="76af4-151">Contains all resources necessary for hello Azure virtual network environment.</span></span> 
* <span data-ttu-id="76af4-152">Una rete virtuale denominata **onpremvnet** utilizzato toomimic segmentato di un data center locale come indicato di seguito.</span><span class="sxs-lookup"><span data-stu-id="76af4-152">A VNet named **onpremvnet** used toomimic an on-premises datacenter segmented as listed below.</span></span>
  * <span data-ttu-id="76af4-153">**onpremsn1**.</span><span class="sxs-lookup"><span data-stu-id="76af4-153">**onpremsn1**.</span></span> <span data-ttu-id="76af4-154">Subnet contenente una macchina virtuale (VM) in esecuzione Ubuntu toomimic un server locale.</span><span class="sxs-lookup"><span data-stu-id="76af4-154">Subnet containing a virtual machine (VM) running Ubuntu toomimic an on-premises server.</span></span>
  * <span data-ttu-id="76af4-155">**onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="76af4-155">**onpremsn2**.</span></span> <span data-ttu-id="76af4-156">Subnet contenente una macchina virtuale in esecuzione Ubuntu toomimic un computer locale utilizzato da un amministratore.</span><span class="sxs-lookup"><span data-stu-id="76af4-156">Subnet containing a VM running Ubuntu toomimic an on-premises computer used by an administrator.</span></span>
* <span data-ttu-id="76af4-157">È un accessorio virtuale di firewall denominato **OPFW** su **onpremvnet** utilizzato toomaintain un tunnel troppo**azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="76af4-157">There is one firewall virtual appliance named **OPFW** on **onpremvnet** used toomaintain a tunnel too**azurevnet**.</span></span>
* <span data-ttu-id="76af4-158">Una rete virtuale denominata **azurevnet** segmentata come indicato di seguito.</span><span class="sxs-lookup"><span data-stu-id="76af4-158">A VNet named **azurevnet** segmented as listed below.</span></span>
  * <span data-ttu-id="76af4-159">**azsn1**.</span><span class="sxs-lookup"><span data-stu-id="76af4-159">**azsn1**.</span></span> <span data-ttu-id="76af4-160">Subnet firewall esterno utilizzata esclusivamente per i firewall esterno hello.</span><span class="sxs-lookup"><span data-stu-id="76af4-160">External firewall subnet used exclusively for hello external firewall.</span></span> <span data-ttu-id="76af4-161">Tutto il traffico Internet in ingresso passerà attraverso questa subnet.</span><span class="sxs-lookup"><span data-stu-id="76af4-161">All Internet traffic will come in through this subnet.</span></span> <span data-ttu-id="76af4-162">Questa subnet contiene solo un firewall esterno toohello NIC collegato.</span><span class="sxs-lookup"><span data-stu-id="76af4-162">This subnet only contains a NIC linked toohello external firewall.</span></span>
  * <span data-ttu-id="76af4-163">**azsn2**.</span><span class="sxs-lookup"><span data-stu-id="76af4-163">**azsn2**.</span></span> <span data-ttu-id="76af4-164">Subnet front-end che ospita una macchina virtuale in esecuzione come server web che verrà eseguito da hello Internet.</span><span class="sxs-lookup"><span data-stu-id="76af4-164">Front end subnet hosting a VM running as a web server that will be accessed from hello Internet.</span></span>
  * <span data-ttu-id="76af4-165">**azsn3**.</span><span class="sxs-lookup"><span data-stu-id="76af4-165">**azsn3**.</span></span> <span data-ttu-id="76af4-166">Subnet di back-end che ospita una macchina virtuale in esecuzione un server applicazioni back-end che eseguiranno l'accesso a server web front-end di hello.</span><span class="sxs-lookup"><span data-stu-id="76af4-166">Backend subnet hosting a VM running a backend application server that will be accessed by hello front end web server.</span></span>
  * <span data-ttu-id="76af4-167">**azsn4**.</span><span class="sxs-lookup"><span data-stu-id="76af4-167">**azsn4**.</span></span> <span data-ttu-id="76af4-168">Subnet di gestione utilizzato esclusivamente tooprovide Gestione accesso tooall firewall dispositivi virtuali.</span><span class="sxs-lookup"><span data-stu-id="76af4-168">Management subnet used exclusively tooprovide management access tooall firewall virtual appliances.</span></span> <span data-ttu-id="76af4-169">Questa subnet contiene solo una scheda di rete per ogni dispositivo virtuale firewall utilizzato nella soluzione hello.</span><span class="sxs-lookup"><span data-stu-id="76af4-169">This subnet only contains a NIC for each firewall virtual appliance used in hello solution.</span></span>
  * <span data-ttu-id="76af4-170">**GatewaySubnet**.</span><span class="sxs-lookup"><span data-stu-id="76af4-170">**GatewaySubnet**.</span></span> <span data-ttu-id="76af4-171">Subnet connessione ibrida di Azure necessarie per la connettività di tooprovide ExpressRoute e VPN Gateway tra reti virtuali di Azure e altre reti.</span><span class="sxs-lookup"><span data-stu-id="76af4-171">Azure hybrid connection subnet required for ExpressRoute and VPN Gateway tooprovide connectivity between Azure VNets and other networks.</span></span> 
* <span data-ttu-id="76af4-172">Sono disponibili 3 Appliance virtuale firewall in hello **azurevnet** rete.</span><span class="sxs-lookup"><span data-stu-id="76af4-172">There are 3 firewall virtual appliances in hello **azurevnet** network.</span></span> 
  * <span data-ttu-id="76af4-173">**AZF1**.</span><span class="sxs-lookup"><span data-stu-id="76af4-173">**AZF1**.</span></span> <span data-ttu-id="76af4-174">Firewall esterno esposto toohello rete Internet pubblica utilizzando una risorsa di indirizzo IP pubblica in Azure.</span><span class="sxs-lookup"><span data-stu-id="76af4-174">External firewall exposed toohello public Internet by using a public IP address resource in Azure.</span></span> <span data-ttu-id="76af4-175">È necessario avere un modello da hello Marketplace o direttamente dal fornitore del dispositivo, che esegue il provisioning appliance virtuale 3-NIC tooensure.</span><span class="sxs-lookup"><span data-stu-id="76af4-175">You need tooensure you have a template from hello Marketplace, or directly from your appliance vendor, that provisions a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="76af4-176">**AZF2**.</span><span class="sxs-lookup"><span data-stu-id="76af4-176">**AZF2**.</span></span> <span data-ttu-id="76af4-177">Firewall interno utilizzato traffico toocontrol tra **azsn2** e **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="76af4-177">Internal firewall used toocontrol traffic between **azsn2** and **azsn3**.</span></span> <span data-ttu-id="76af4-178">Anche questa è un'appliance virtuale con 3 schede di interfaccia di rete.</span><span class="sxs-lookup"><span data-stu-id="76af4-178">This is also a 3-NIC virtual appliance.</span></span>
  * <span data-ttu-id="76af4-179">**AZF3**.</span><span class="sxs-lookup"><span data-stu-id="76af4-179">**AZF3**.</span></span> <span data-ttu-id="76af4-180">Gestione firewall di tooadministrators accessibile da hello locale datacenter e subnet di gestione connesso tooa utilizzato toomanage Appliance firewall tutti.</span><span class="sxs-lookup"><span data-stu-id="76af4-180">Management firewall accessible tooadministrators from hello on-premises datacenter, and connected tooa management subnet used toomanage all firewall appliances.</span></span> <span data-ttu-id="76af4-181">È possibile richiedere uno direttamente dal fornitore del dispositivo o modelli sono disponibili 2 NIC appliance virtuale hello Marketplace.</span><span class="sxs-lookup"><span data-stu-id="76af4-181">You can find 2-NIC virtual appliance templates in hello Marketplace, or request one directly from your appliance vendor.</span></span>

## <a name="user-defined-routing-udr"></a><span data-ttu-id="76af4-182">Routing definito dall'utente</span><span class="sxs-lookup"><span data-stu-id="76af4-182">User Defined Routing (UDR)</span></span>
<span data-ttu-id="76af4-183">Ogni subnet in Azure può essere collegato tooa UDR tabella utilizzata toodefine modalità di routing avviato in tale subnet di traffico.</span><span class="sxs-lookup"><span data-stu-id="76af4-183">Each subnet in Azure can be linked tooa UDR table used toodefine how traffic initiated in that subnet is routed.</span></span> <span data-ttu-id="76af4-184">Se non è definito alcun UDRs, Azure Usa impostazione predefinita le route tooallow traffico tooflow da una subnet tooanother.</span><span class="sxs-lookup"><span data-stu-id="76af4-184">If no UDRs are defined, Azure uses default routes tooallow traffic tooflow from one subnet tooanother.</span></span> <span data-ttu-id="76af4-185">toobetter comprendere UDRs, visitare [quali sono le route definite dall'utente e l'inoltro IP](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="76af4-185">toobetter understand UDRs, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="76af4-186">comunicazione tooensure viene eseguita tramite appliance firewall destra hello, in base ai requisiti ultimo hello precedenti, è necessario toocreate hello segue la tabella di routing contenente UDRs in **azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="76af4-186">tooensure communication is done through hello right firewall appliance, based on hello last requirement above, you need toocreate hello following route table containing UDRs in **azurevnet**.</span></span>

### <a name="azgwudr"></a><span data-ttu-id="76af4-187">azgwudr</span><span class="sxs-lookup"><span data-stu-id="76af4-187">azgwudr</span></span>
<span data-ttu-id="76af4-188">In questo scenario, hello solo il traffico che passa da on-premise tooAzure saranno utilizzati toomanage hello firewall connettendosi troppo**AZF3**, e che il traffico deve passare attraverso firewall interno hello, **AZF2**.</span><span class="sxs-lookup"><span data-stu-id="76af4-188">In this scenario, hello only traffic flowing from on-premises tooAzure will be used toomanage hello firewalls by connecting too**AZF3**, and that traffic must go through hello internal firewall, **AZF2**.</span></span> <span data-ttu-id="76af4-189">Pertanto, solo una route è necessaria in hello **GatewaySubnet** come illustrato di seguito.</span><span class="sxs-lookup"><span data-stu-id="76af4-189">Therefore, only one route is necessary in hello **GatewaySubnet** as shown below.</span></span>

| <span data-ttu-id="76af4-190">Destination</span><span class="sxs-lookup"><span data-stu-id="76af4-190">Destination</span></span> | <span data-ttu-id="76af4-191">Hop successivo</span><span class="sxs-lookup"><span data-stu-id="76af4-191">Next hop</span></span> | <span data-ttu-id="76af4-192">Spiegazione</span><span class="sxs-lookup"><span data-stu-id="76af4-192">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="76af4-193">10.0.4.0/24</span><span class="sxs-lookup"><span data-stu-id="76af4-193">10.0.4.0/24</span></span> |<span data-ttu-id="76af4-194">10.0.3.11</span><span class="sxs-lookup"><span data-stu-id="76af4-194">10.0.3.11</span></span> |<span data-ttu-id="76af4-195">Consente di firewall di gestione locale traffico tooreach **AZF3**</span><span class="sxs-lookup"><span data-stu-id="76af4-195">Allows on-premises traffic tooreach management firewall **AZF3**</span></span> |

### <a name="azsn2udr"></a><span data-ttu-id="76af4-196">azsn2udr</span><span class="sxs-lookup"><span data-stu-id="76af4-196">azsn2udr</span></span>
| <span data-ttu-id="76af4-197">Destination</span><span class="sxs-lookup"><span data-stu-id="76af4-197">Destination</span></span> | <span data-ttu-id="76af4-198">Hop successivo</span><span class="sxs-lookup"><span data-stu-id="76af4-198">Next hop</span></span> | <span data-ttu-id="76af4-199">Spiegazione</span><span class="sxs-lookup"><span data-stu-id="76af4-199">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="76af4-200">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="76af4-200">10.0.3.0/24</span></span> |<span data-ttu-id="76af4-201">10.0.2.11</span><span class="sxs-lookup"><span data-stu-id="76af4-201">10.0.2.11</span></span> |<span data-ttu-id="76af4-202">Consente il traffico toohello back-end subnet che ospita il server applicazioni hello tramite **AZF2**</span><span class="sxs-lookup"><span data-stu-id="76af4-202">Allows traffic toohello backend subnet hosting hello application server through **AZF2**</span></span> |
| <span data-ttu-id="76af4-203">0.0.0.0/0</span><span class="sxs-lookup"><span data-stu-id="76af4-203">0.0.0.0/0</span></span> |<span data-ttu-id="76af4-204">10.0.2.10</span><span class="sxs-lookup"><span data-stu-id="76af4-204">10.0.2.10</span></span> |<span data-ttu-id="76af4-205">Consente a tutti gli altri toobe traffico instradato tramite **AZF1**</span><span class="sxs-lookup"><span data-stu-id="76af4-205">Allows all other traffic toobe routed through **AZF1**</span></span> |

### <a name="azsn3udr"></a><span data-ttu-id="76af4-206">azsn3udr</span><span class="sxs-lookup"><span data-stu-id="76af4-206">azsn3udr</span></span>
| <span data-ttu-id="76af4-207">Destination</span><span class="sxs-lookup"><span data-stu-id="76af4-207">Destination</span></span> | <span data-ttu-id="76af4-208">Hop successivo</span><span class="sxs-lookup"><span data-stu-id="76af4-208">Next hop</span></span> | <span data-ttu-id="76af4-209">Spiegazione</span><span class="sxs-lookup"><span data-stu-id="76af4-209">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="76af4-210">10.0.2.0/24</span><span class="sxs-lookup"><span data-stu-id="76af4-210">10.0.2.0/24</span></span> |<span data-ttu-id="76af4-211">10.0.3.10</span><span class="sxs-lookup"><span data-stu-id="76af4-211">10.0.3.10</span></span> |<span data-ttu-id="76af4-212">Consente il traffico troppo**azsn2** tooflow dal server Web toohello di server app attraverso **AZF2**</span><span class="sxs-lookup"><span data-stu-id="76af4-212">Allows traffic too**azsn2** tooflow from app server toohello webserver through **AZF2**</span></span> |

<span data-ttu-id="76af4-213">È inoltre necessario toocreate le tabelle di route per le subnet hello **onpremvnet** toomimic hello locale Data Center.</span><span class="sxs-lookup"><span data-stu-id="76af4-213">You also need toocreate route tables for hello subnets in **onpremvnet** toomimic hello on-premises datacenter.</span></span>

### <a name="onpremsn1udr"></a><span data-ttu-id="76af4-214">onpremsn1udr</span><span class="sxs-lookup"><span data-stu-id="76af4-214">onpremsn1udr</span></span>
| <span data-ttu-id="76af4-215">Destination</span><span class="sxs-lookup"><span data-stu-id="76af4-215">Destination</span></span> | <span data-ttu-id="76af4-216">Hop successivo</span><span class="sxs-lookup"><span data-stu-id="76af4-216">Next hop</span></span> | <span data-ttu-id="76af4-217">Spiegazione</span><span class="sxs-lookup"><span data-stu-id="76af4-217">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="76af4-218">192.168.2.0/24</span><span class="sxs-lookup"><span data-stu-id="76af4-218">192.168.2.0/24</span></span> |<span data-ttu-id="76af4-219">192.168.1.4</span><span class="sxs-lookup"><span data-stu-id="76af4-219">192.168.1.4</span></span> |<span data-ttu-id="76af4-220">Consente il traffico troppo**onpremsn2** tramite **OPFW**</span><span class="sxs-lookup"><span data-stu-id="76af4-220">Allows traffic too**onpremsn2** through **OPFW**</span></span> |

### <a name="onpremsn2udr"></a><span data-ttu-id="76af4-221">onpremsn2udr</span><span class="sxs-lookup"><span data-stu-id="76af4-221">onpremsn2udr</span></span>
| <span data-ttu-id="76af4-222">Destination</span><span class="sxs-lookup"><span data-stu-id="76af4-222">Destination</span></span> | <span data-ttu-id="76af4-223">Hop successivo</span><span class="sxs-lookup"><span data-stu-id="76af4-223">Next hop</span></span> | <span data-ttu-id="76af4-224">Spiegazione</span><span class="sxs-lookup"><span data-stu-id="76af4-224">Explanation</span></span> |
| --- | --- | --- |
| <span data-ttu-id="76af4-225">10.0.3.0/24</span><span class="sxs-lookup"><span data-stu-id="76af4-225">10.0.3.0/24</span></span> |<span data-ttu-id="76af4-226">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="76af4-226">192.168.2.4</span></span> |<span data-ttu-id="76af4-227">Consente di subnet con traffico toohello eseguito in Azure tramite **OPFW**</span><span class="sxs-lookup"><span data-stu-id="76af4-227">Allows traffic toohello backed subnet in Azure through **OPFW**</span></span> |
| <span data-ttu-id="76af4-228">192.168.1.0/24</span><span class="sxs-lookup"><span data-stu-id="76af4-228">192.168.1.0/24</span></span> |<span data-ttu-id="76af4-229">192.168.2.4</span><span class="sxs-lookup"><span data-stu-id="76af4-229">192.168.2.4</span></span> |<span data-ttu-id="76af4-230">Consente il traffico troppo**onpremsn1** tramite **OPFW**</span><span class="sxs-lookup"><span data-stu-id="76af4-230">Allows traffic too**onpremsn1** through **OPFW**</span></span> |

## <a name="ip-forwarding"></a><span data-ttu-id="76af4-231">Inoltro IP</span><span class="sxs-lookup"><span data-stu-id="76af4-231">IP Forwarding</span></span>
<span data-ttu-id="76af4-232">UDR e l'inoltro IP sono funzionalità che è possibile utilizzare in combinazione tooallow Appliance virtuali toobe utilizzato toocontrol flusso del traffico in una rete virtuale di Azure.</span><span class="sxs-lookup"><span data-stu-id="76af4-232">UDR and IP Forwarding are features that you can use in combination tooallow virtual appliances toobe used toocontrol traffic flow in an Azure VNet.</span></span>  <span data-ttu-id="76af4-233">Un dispositivo virtuale è semplicemente una macchina virtuale che esegue un'applicazione che consente il traffico di rete toohandle in qualche modo, ad esempio un firewall o un dispositivo NAT.</span><span class="sxs-lookup"><span data-stu-id="76af4-233">A virtual appliance is nothing more than a VM that runs an application used toohandle network traffic in some way, such as a firewall or a NAT device.</span></span>

<span data-ttu-id="76af4-234">Questo dispositivo virtuale che VM deve essere in grado di tooreceive il traffico in ingresso che viene risolto non tooitself.</span><span class="sxs-lookup"><span data-stu-id="76af4-234">This virtual appliance VM must be able tooreceive incoming traffic that is not addressed tooitself.</span></span> <span data-ttu-id="76af4-235">tooallow un traffico tooreceive VM inoltrate tooother destinazioni, è necessario abilitare l'inoltro IP per hello macchina virtuale.</span><span class="sxs-lookup"><span data-stu-id="76af4-235">tooallow a VM tooreceive traffic addressed tooother destinations, you must enable IP Forwarding for hello VM.</span></span> <span data-ttu-id="76af4-236">Si tratta di un'impostazione, non è un'impostazione hello del sistema operativo guest di Azure.</span><span class="sxs-lookup"><span data-stu-id="76af4-236">This is an Azure setting, not a setting in hello guest operating system.</span></span> <span data-ttu-id="76af4-237">Il dispositivo virtuale ancora esigenze toorun tipo di applicazione toohandle hello il traffico in ingresso e distribuirla in modo appropriato.</span><span class="sxs-lookup"><span data-stu-id="76af4-237">Your virtual appliance still needs toorun some type of application toohandle hello incoming traffic, and route it appropriately.</span></span>

<span data-ttu-id="76af4-238">toolearn ulteriori informazioni sull'inoltro IP, visitare [quali sono le route definite dall'utente e l'inoltro IP](virtual-networks-udr-overview.md#ip-forwarding).</span><span class="sxs-lookup"><span data-stu-id="76af4-238">toolearn more about IP Forwarding, visit [What are User Defined Routes and IP Forwarding](virtual-networks-udr-overview.md#ip-forwarding).</span></span>

<span data-ttu-id="76af4-239">Ad esempio, si supponga di che aver hello dopo l'installazione in una rete virtuale di Azure:</span><span class="sxs-lookup"><span data-stu-id="76af4-239">As an example, imagine you have hello following setup in an Azure vnet:</span></span>

* <span data-ttu-id="76af4-240">La subnet **onpremsn1** contiene una macchina virtuale denominata **onpremvm1**.</span><span class="sxs-lookup"><span data-stu-id="76af4-240">Subnet **onpremsn1** contains a VM named **onpremvm1**.</span></span>
* <span data-ttu-id="76af4-241">La subnet **onpremsn2** contiene una macchina virtuale denominata **onpremvm2**.</span><span class="sxs-lookup"><span data-stu-id="76af4-241">Subnet **onpremsn2** contains a VM named **onpremvm2**.</span></span>
* <span data-ttu-id="76af4-242">Appliance virtuale denominato **OPFW** è connesso troppo**onpremsn1** e **onpremsn2**.</span><span class="sxs-lookup"><span data-stu-id="76af4-242">A virtual appliance named **OPFW** is connected too**onpremsn1** and **onpremsn2**.</span></span>
* <span data-ttu-id="76af4-243">Una route definita dall'utente collegato troppo**onpremsn1** specifica che tutto il traffico troppo**onpremsn2** devono essere inviati troppo**OPFW**.</span><span class="sxs-lookup"><span data-stu-id="76af4-243">A user defined route linked too**onpremsn1** specifies that all traffic too**onpremsn2** must be sent too**OPFW**.</span></span>

<span data-ttu-id="76af4-244">In questo punto, se **onpremvm1** tenta di una connessione con tooestablish **onpremvm2**, hello UDR verrà utilizzato e il traffico verrà inviato troppo**OPFW** come hop successivo hello.</span><span class="sxs-lookup"><span data-stu-id="76af4-244">At this point, if **onpremvm1** tries tooestablish a connection with **onpremvm2**, hello UDR will be used and traffic will be sent too**OPFW** as hello next hop.</span></span> <span data-ttu-id="76af4-245">Tenere presente che hello destinazione pacchetto effettivo non viene modificato, ancora visualizzato **onpremvm2** hello destinazione.</span><span class="sxs-lookup"><span data-stu-id="76af4-245">Keep in mind that hello actual packet destination is not being changed, it still says **onpremvm2** is hello destination.</span></span> 

<span data-ttu-id="76af4-246">Senza attivato per l'inoltro IP **OPFW**, hello la logica di rete virtuale Azure eliminerà i pacchetti hello, poiché consente solo i pacchetti inviati toobe tooa VM se hello indirizzo IP della macchina virtuale è la destinazione hello per i pacchetti hello.</span><span class="sxs-lookup"><span data-stu-id="76af4-246">Without IP Forwarding enabled for **OPFW**, hello Azure virtual networking logic will drop hello packets, since it only allows packets toobe sent tooa VM if hello VM’s IP address is hello destination for hello packet.</span></span>

<span data-ttu-id="76af4-247">Con inoltro IP, la logica di rete virtuale di Azure hello inoltrerà tooOPFW pacchetti hello, senza modificare l'indirizzo di destinazione originale.</span><span class="sxs-lookup"><span data-stu-id="76af4-247">With IP Forwarding, hello Azure virtual network logic will forward hello packets tooOPFW, without changing its original destination address.</span></span> <span data-ttu-id="76af4-248">**OPFW** deve gestire i pacchetti hello e determinare quali toodo con essi.</span><span class="sxs-lookup"><span data-stu-id="76af4-248">**OPFW** must handle hello packets and determine what toodo with them.</span></span>

<span data-ttu-id="76af4-249">Scenario di hello sopra toowork, è necessario abilitare l'inoltro IP nelle schede NIC hello per **OPFW**, **AZF1**, **AZF2**, e **AZF3** utilizzati per routing (tutte le NIC ad eccezione di quelli hello toohello collegato gestione subnet).</span><span class="sxs-lookup"><span data-stu-id="76af4-249">For hello scenario above toowork, you must enable IP Forwarding on hello NICs for **OPFW**, **AZF1**, **AZF2**, and **AZF3** that are used for routing (all NICs except hello ones linked toohello management subnet).</span></span> 

## <a name="firewall-rules"></a><span data-ttu-id="76af4-250">Regole del firewall</span><span class="sxs-lookup"><span data-stu-id="76af4-250">Firewall Rules</span></span>
<span data-ttu-id="76af4-251">Come descritto in precedenza, solo l'inoltro IP garantisce Appliance virtuali toohello i pacchetti vengono inviati.</span><span class="sxs-lookup"><span data-stu-id="76af4-251">As described above, IP Forwarding only ensures packets are sent toohello virtual appliances.</span></span> <span data-ttu-id="76af4-252">Il dispositivo è ancora necessario toodecide quali toodo con tali pacchetti.</span><span class="sxs-lookup"><span data-stu-id="76af4-252">Your appliance still needs toodecide what toodo with those packets.</span></span> <span data-ttu-id="76af4-253">Nel precedente scenario hello, sarà necessario hello toocreate alle regole nei dispositivi:</span><span class="sxs-lookup"><span data-stu-id="76af4-253">In hello scenario above, you will need toocreate hello following rules in your appliances:</span></span>

### <a name="opfw"></a><span data-ttu-id="76af4-254">OPFW</span><span class="sxs-lookup"><span data-stu-id="76af4-254">OPFW</span></span>
<span data-ttu-id="76af4-255">OPFW rappresenta un dispositivo locale contenente hello seguenti regole:</span><span class="sxs-lookup"><span data-stu-id="76af4-255">OPFW represents an on-premises device containing hello following rules:</span></span>

* <span data-ttu-id="76af4-256">**Route**: tutto il traffico too10.0.0.0/16 (**azurevnet**) devono essere inviati tramite tunnel **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="76af4-256">**Route**: All traffic too10.0.0.0/16 (**azurevnet**) must be sent through tunnel **ONPREMAZURE**.</span></span>
* <span data-ttu-id="76af4-257">**Criteri**: consentire tutto il traffico bidirezionale tra **port2** e **ONPREMAZURE**.</span><span class="sxs-lookup"><span data-stu-id="76af4-257">**Policy**: Allow all bidirectional traffic between **port2** and **ONPREMAZURE**.</span></span>

### <a name="azf1"></a><span data-ttu-id="76af4-258">AZF1</span><span class="sxs-lookup"><span data-stu-id="76af4-258">AZF1</span></span>
<span data-ttu-id="76af4-259">AZF1 rappresenta un'appliance virtuale Azure contenente hello seguenti regole:</span><span class="sxs-lookup"><span data-stu-id="76af4-259">AZF1 represents an Azure virtual appliance containing hello following rules:</span></span>

* <span data-ttu-id="76af4-260">**Criteri**: consentire tutto il traffico bidirezionale tra **port1** e **port2**.</span><span class="sxs-lookup"><span data-stu-id="76af4-260">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

### <a name="azf2"></a><span data-ttu-id="76af4-261">AZF2</span><span class="sxs-lookup"><span data-stu-id="76af4-261">AZF2</span></span>
<span data-ttu-id="76af4-262">AZF2 rappresenta un'appliance virtuale Azure contenente hello seguenti regole:</span><span class="sxs-lookup"><span data-stu-id="76af4-262">AZF2 represents an Azure virtual appliance containing hello following rules:</span></span>

* <span data-ttu-id="76af4-263">**Route**: tutto il traffico too10.0.0.0/16 (**onpremvnet**) deve essere inviato l'indirizzo IP del gateway Azure toohello (ad esempio, 10.0.0.1) tramite **port1**.</span><span class="sxs-lookup"><span data-stu-id="76af4-263">**Route**: All traffic too10.0.0.0/16 (**onpremvnet**) must be sent toohello Azure gateway IP address (i.e. 10.0.0.1) through **port1**.</span></span>
* <span data-ttu-id="76af4-264">**Criteri**: consentire tutto il traffico bidirezionale tra **port1** e **port2**.</span><span class="sxs-lookup"><span data-stu-id="76af4-264">**Policy**: Allow all bidirectional traffic between **port1** and **port2**.</span></span>

## <a name="network-security-groups-nsgs"></a><span data-ttu-id="76af4-265">Gruppi di sicurezza di rete (NGS)</span><span class="sxs-lookup"><span data-stu-id="76af4-265">Network Security Groups (NSGs)</span></span>
<span data-ttu-id="76af4-266">In questo scenario i gruppi di sicurezza di rete non vengono usati.</span><span class="sxs-lookup"><span data-stu-id="76af4-266">In this scenario, NSGs are not being used.</span></span> <span data-ttu-id="76af4-267">Tuttavia, è possibile applicare NSGs tooeach subnet toorestrict traffico in entrata e in uscita.</span><span class="sxs-lookup"><span data-stu-id="76af4-267">However, you could apply NSGs tooeach subnet toorestrict incoming and outgoing traffic.</span></span> <span data-ttu-id="76af4-268">Ad esempio, è possibile applicare hello subnet FW esterna di NSG regole toohello seguente.</span><span class="sxs-lookup"><span data-stu-id="76af4-268">For instance, you could apply hello following NSG rules toohello external FW subnet.</span></span>

<span data-ttu-id="76af4-269">**In ingresso**</span><span class="sxs-lookup"><span data-stu-id="76af4-269">**Incoming**</span></span>

* <span data-ttu-id="76af4-270">Consenti tutto il traffico TCP da hello Internet tooport 80 su tutte le VM nella subnet hello.</span><span class="sxs-lookup"><span data-stu-id="76af4-270">Allow all TCP traffic from hello Internet tooport 80 on any VM in hello subnet.</span></span>
* <span data-ttu-id="76af4-271">Nega tutto il traffico Internet hello.</span><span class="sxs-lookup"><span data-stu-id="76af4-271">Deny all other traffic from hello Internet.</span></span>

<span data-ttu-id="76af4-272">**In uscita**</span><span class="sxs-lookup"><span data-stu-id="76af4-272">**Outgoing**</span></span>

* <span data-ttu-id="76af4-273">Nega tutto il traffico toohello Internet.</span><span class="sxs-lookup"><span data-stu-id="76af4-273">Deny all traffic toohello Internet.</span></span>

## <a name="high-level-steps"></a><span data-ttu-id="76af4-274">Passaggi di livello elevato</span><span class="sxs-lookup"><span data-stu-id="76af4-274">High level steps</span></span>
<span data-ttu-id="76af4-275">toodeploy questo scenario, seguire hello passaggi di alto livello seguenti.</span><span class="sxs-lookup"><span data-stu-id="76af4-275">toodeploy this scenario, follow hello high level steps below.</span></span>

1. <span data-ttu-id="76af4-276">Account di accesso tooyour sottoscrizione Azure.</span><span class="sxs-lookup"><span data-stu-id="76af4-276">Login tooyour Azure Subscription.</span></span>
2. <span data-ttu-id="76af4-277">Se si desidera toodeploy hello di toomimic una rete virtuale locale rete, il provisioning delle risorse di hello che fanno parte di **ONPREMRG**.</span><span class="sxs-lookup"><span data-stu-id="76af4-277">If you want toodeploy a VNet toomimic hello on-premises network, provision hello resources that are part of **ONPREMRG**.</span></span>
3. <span data-ttu-id="76af4-278">Il provisioning di risorse hello che fanno parte di **AZURERG**.</span><span class="sxs-lookup"><span data-stu-id="76af4-278">Provision hello resources that are part of **AZURERG**.</span></span>
4. <span data-ttu-id="76af4-279">Tunnel hello effettuare il provisioning da **onpremvnet** troppo**azurevnet**.</span><span class="sxs-lookup"><span data-stu-id="76af4-279">Provision hello tunnel from **onpremvnet** too**azurevnet**.</span></span>
5. <span data-ttu-id="76af4-280">Una volta che vengono effettuato il provisioning di tutte le risorse, effettuare l'accesso troppo**onpremvm2** e ping 10.0.3.101 tootest connettività tra **onpremsn2** e **azsn3**.</span><span class="sxs-lookup"><span data-stu-id="76af4-280">Once all resources are provisioned, log on too**onpremvm2** and ping 10.0.3.101 tootest connectivity between **onpremsn2** and **azsn3**.</span></span>

