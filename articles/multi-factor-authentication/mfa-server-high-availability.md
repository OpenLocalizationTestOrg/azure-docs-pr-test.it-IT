---
title: "Configurare il server Azure MFA per la disponibilità elevata | Microsoft Docs"
description: "Distribuire più istanze del server Microsoft Azure Multi-Factor Authentication in configurazioni che offrono disponibilità elevata."
services: multi-factor-authentication
keywords: Azure MFA,
documentationcenter: 
author: MicrosoftGuyJFlo
manager: femila
ms.assetid: 
ms.service: multi-factor-authentication
ms.workload: identity
ms.tgt_pltfrm: na
ms.devlang: na
ms.topic: article
ms.date: 08/23/2017
ms.author: joflore
ms.reviewer: alexwe
ms.custom: it-pro
ms.openlocfilehash: 9f03e61e05383c309fb66b67e0641b17df5ab00f
ms.sourcegitcommit: 18ad9bc049589c8e44ed277f8f43dcaa483f3339
ms.translationtype: MT
ms.contentlocale: it-IT
ms.lasthandoff: 08/29/2017
---
# <a name="configure-azure-multi-factor-authentication-server-for-high-availability"></a><span data-ttu-id="ab618-104">Configurare il server Azure MFA per la disponibilità elevata</span><span class="sxs-lookup"><span data-stu-id="ab618-104">Configure Azure Multi-Factor Authentication Server for high availability</span></span>

<span data-ttu-id="ab618-105">Per ottenere disponibilità elevata con la distribuzione del server Azure MFA, è necessario distribuire più server MFA.</span><span class="sxs-lookup"><span data-stu-id="ab618-105">To achieve high-availability with your Azure Server MFA deployment, you need to deploy multiple MFA servers.</span></span> <span data-ttu-id="ab618-106">Questa sezione contiene informazioni su una progettazione con bilanciamento del carico per ottenere destinazioni a disponibilità elevata nella distribuzione di server Azure MFS.</span><span class="sxs-lookup"><span data-stu-id="ab618-106">This section provides information on a load-balanced design to achieve your high availability targets in you Azure MFS Server deployment.</span></span>

## <a name="mfa-server-overview"></a><span data-ttu-id="ab618-107">Panoramica del server MFA</span><span class="sxs-lookup"><span data-stu-id="ab618-107">MFA Server overview</span></span>

<span data-ttu-id="ab618-108">L'architettura di servizio del server Azure MFA include diversi componenti, come illustrato nel diagramma seguente:</span><span class="sxs-lookup"><span data-stu-id="ab618-108">The Azure MFA Server service architecture comprises several components as shown in the following diagram:</span></span>

 ![Architettura del server MFA](./media/mfa-server-high-availability/mfa-ha-architecture.png)

<span data-ttu-id="ab618-110">Un server MFA è un'istanza di Windows Server in cui è installato il software Azure Multi-Factor Authentication.</span><span class="sxs-lookup"><span data-stu-id="ab618-110">An MFA Server is a Windows Server that has the Azure Multi-Factor Authentication software installed.</span></span> <span data-ttu-id="ab618-111">Per funzionare, l'istanza del server MFA deve essere attivata dal servizio MFA in Azure.</span><span class="sxs-lookup"><span data-stu-id="ab618-111">The MFA Server instance must be activated by the MFA Service in Azure to function.</span></span> <span data-ttu-id="ab618-112">È possibile installare più di un server MFA locale.</span><span class="sxs-lookup"><span data-stu-id="ab618-112">More than one MFA Server can be installed on-premises.</span></span>

<span data-ttu-id="ab618-113">Per impostazione predefinita, la prima istanza del server MFA installata rappresenta il server master MFA al momento dell'attivazione da parte del servizio Azure MFA.</span><span class="sxs-lookup"><span data-stu-id="ab618-113">The first MFA Server that is installed is the master MFA Server upon activation by the Azure MFA Service by default.</span></span> <span data-ttu-id="ab618-114">L'istanza master del server MFA include una copia scrivibile del database PhoneFactor.pfdata.</span><span class="sxs-lookup"><span data-stu-id="ab618-114">The master MFA server has a writeable copy of the PhoneFactor.pfdata database.</span></span> <span data-ttu-id="ab618-115">Le installazioni successive delle istanze del server MFA sono note con il nome di slave.</span><span class="sxs-lookup"><span data-stu-id="ab618-115">Subsequent installations of instances of MFA Server are known as slaves.</span></span> <span data-ttu-id="ab618-116">Gli slave di MFA includono una copia replicata di sola lettura del database PhoneFactor.pfdata.</span><span class="sxs-lookup"><span data-stu-id="ab618-116">The MFA slaves have a replicated read-only copy of the PhoneFactor.pfdata database.</span></span> <span data-ttu-id="ab618-117">I server MFA replicano le informazioni mediante Remote Procedure Call (RPC).</span><span class="sxs-lookup"><span data-stu-id="ab618-117">MFA servers replicate information using Remote Procedure Call (RPC).</span></span> <span data-ttu-id="ab618-118">Tutti i server MFA devono essere collettivamente aggiunti a un dominio o autonomi per replicare informazioni.</span><span class="sxs-lookup"><span data-stu-id="ab618-118">All MFA Severs must collectively either be domain joined or standalone to replicate information.</span></span>

<span data-ttu-id="ab618-119">Le istanze master e slave dei server MFA comunicano con il servizio MFA quando è necessaria l'autenticazione a due fattori.</span><span class="sxs-lookup"><span data-stu-id="ab618-119">Both MFA master and slave MFA Servers communicate with the MFA Service when two-factor authentication is required.</span></span> <span data-ttu-id="ab618-120">Ad esempio, quando un utente tenta di accedere a un'applicazione che richiede l'autenticazione a due fattori, l'utente verrà prima autenticato da un provider di identità, ad esempio Active Directory (AD).</span><span class="sxs-lookup"><span data-stu-id="ab618-120">For example, when a user attempts to gain access to an application that requires two-factor authentication, the user will first be authenticated by an identity provider, such as Active Directory (AD).</span></span>

<span data-ttu-id="ab618-121">In seguito all'autenticazione con AD, il server MFA comunicherà con il servizio MFA.</span><span class="sxs-lookup"><span data-stu-id="ab618-121">After successful authentication with AD, the MFA Server will communicate with the MFA Service.</span></span> <span data-ttu-id="ab618-122">Il server MFA attende la notifica dal servizio MFA per consentire o negare l'accesso dell'utente all'applicazione.</span><span class="sxs-lookup"><span data-stu-id="ab618-122">The MFA Server waits for notification from the MFA Service to allow or deny the user access to the application.</span></span>

<span data-ttu-id="ab618-123">Se l'istanza master del server MFA è offline, è comunque possibile elaborare le autenticazioni, ma non le operazioni che richiedono modifiche al database MFA.</span><span class="sxs-lookup"><span data-stu-id="ab618-123">If the MFA master server goes offline, authentications can still be processed, but operations that require changes to the MFA database cannot be processed.</span></span> <span data-ttu-id="ab618-124">Alcuni esempi includono l'aggiunta di utenti, le modifiche PIN self-service e la modifica delle informazioni utente.</span><span class="sxs-lookup"><span data-stu-id="ab618-124">(Examples include: the addition of users, self-service PIN changes, and changing user information)</span></span>

## <a name="deployment"></a><span data-ttu-id="ab618-125">Distribuzione</span><span class="sxs-lookup"><span data-stu-id="ab618-125">Deployment</span></span>

<span data-ttu-id="ab618-126">Considerare gli aspetti fondamentali seguenti per eseguire il bilanciamento del carico del server Azure MFA e dei componenti correlati.</span><span class="sxs-lookup"><span data-stu-id="ab618-126">Consider the following important points for load balancing Azure MFA Server and its related components.</span></span>

* <span data-ttu-id="ab618-127">**Uso dello standard RADIUS per conseguire disponibilità elevata**.</span><span class="sxs-lookup"><span data-stu-id="ab618-127">**Using RADIUS standard to achieve high availability**.</span></span> <span data-ttu-id="ab618-128">Se si usano server Azure MFA come server RADIUS, è possibile configurare un server MFA come destinazione di autenticazione RADIUS primaria e altri server Azure MFA come destinazioni di autenticazione secondarie.</span><span class="sxs-lookup"><span data-stu-id="ab618-128">If you are using Azure MFA Servers as RADIUS servers, you can potentially configure one MFA Server as a primary RADIUS authentication target and other Azure MFA Servers as secondary authentication targets.</span></span> <span data-ttu-id="ab618-129">Questo metodo per conseguire la disponibilità elevata, tuttavia, potrebbe non risultare pratico, poiché è necessario attendere che si verifichi un timeout quando l'autenticazione ha esito negativo nella destinazione di autenticazione primaria prima che sia possibile eseguire l'autenticazione con la destinazione di autenticazione secondaria.</span><span class="sxs-lookup"><span data-stu-id="ab618-129">However, this method to achieve high availability may not be practical because you must wait for a time-out period to occur when authentication fails on the primary authentication target before you can be authenticated against the secondary authentication target.</span></span> <span data-ttu-id="ab618-130">È più efficiente eseguire il bilanciamento del carico del traffico RADIUS tra il client RADIUS e i server RADIUS (in questo caso, le istanze del server Azure MFA che operano come server RADIUS) in modo da poter configurare i client RADIUS con un singolo URL a cui possano puntare.</span><span class="sxs-lookup"><span data-stu-id="ab618-130">It is more efficient to load balance the RADIUS traffic between the RADIUS client and the RADIUS Servers (in this case, the Azure MFA Servers acting as RADIUS servers) so that you can configure the RADIUS clients with a single URL that they can point to.</span></span>
* <span data-ttu-id="ab618-131">**Necessità di alzare manualmente di livello le istanze slave di MFA**.</span><span class="sxs-lookup"><span data-stu-id="ab618-131">**Need to manually promote MFA slaves**.</span></span> <span data-ttu-id="ab618-132">Se l'istanza master del server Azure MFA è offline, le istanze secondarie del server Azure MFA continuano a elaborare le richieste MFA.</span><span class="sxs-lookup"><span data-stu-id="ab618-132">If the master Azure MFA server goes offline, the secondary Azure MFA Servers continue to process MFA requests.</span></span> <span data-ttu-id="ab618-133">Tuttavia, fino a quando è disponibile un'istanza master del server MFA, gli amministratori non possono aggiungere utenti o modificare le impostazioni di autenticazione a più fattori e gli utenti non possono apportare modifiche tramite il portale per gli utenti.</span><span class="sxs-lookup"><span data-stu-id="ab618-133">However, until a master MFA server is available, admins can not add users or modify MFA settings, and users can not make changes using the user portal.</span></span> <span data-ttu-id="ab618-134">L'aumento di livello di un'istanza slave di MFA al ruolo master è sempre un processo manuale.</span><span class="sxs-lookup"><span data-stu-id="ab618-134">Promoting an MFA slave to the master role is always a manual process.</span></span>
* <span data-ttu-id="ab618-135">**Separabilità dei componenti**.</span><span class="sxs-lookup"><span data-stu-id="ab618-135">**Separability of components**.</span></span> <span data-ttu-id="ab618-136">Il server Azure MFA è costituito da diversi componenti che possono essere installati nella stessa istanza di Windows Server o in istanze diverse.</span><span class="sxs-lookup"><span data-stu-id="ab618-136">The Azure MFA Server comprises several components that can be installed on the same Windows Server instance or on different instances.</span></span> <span data-ttu-id="ab618-137">Questi componenti includono il portale per gli utenti, il servizio Web per app per dispositivi mobili e la scheda AD FS (agente).</span><span class="sxs-lookup"><span data-stu-id="ab618-137">These components include the User Portal, Mobile App Web Service, and the ADFS adapter (agent).</span></span> <span data-ttu-id="ab618-138">Questa separabilità permette di usare il proxy applicazione Web per pubblicare il portale per gli utenti e il server Web per app per dispositivi mobili dalla rete perimetrale.</span><span class="sxs-lookup"><span data-stu-id="ab618-138">This separability makes it possible to use the Web Application Proxy to publish the User Portal and Mobile App Web Server from the perimeter network.</span></span> <span data-ttu-id="ab618-139">Questo tipo di configurazione contribuisce alla sicurezza complessiva delle progettazioni, come illustrato nel diagramma seguente.</span><span class="sxs-lookup"><span data-stu-id="ab618-139">Such a configuration adds to the overall security of your design, as shown in the following diagram.</span></span> <span data-ttu-id="ab618-140">È anche possibile distribuire il portale per gli utenti MFA e il server Web per app per dispositivi mobili in configurazioni con bilanciamento del carico a disponibilità elevata.</span><span class="sxs-lookup"><span data-stu-id="ab618-140">The MFA User Portal and Mobile App Web Server may also be deployed in HA load-balanced configurations.</span></span>

   ![Server MFA con una rete perimetrale](./media/mfa-server-high-availability/mfasecurity.png)

* <span data-ttu-id="ab618-142">**L'autenticazione One Time Password (OTP) con SMS (nota anche come SMS unidirezionale) richiede l'uso di sessioni permanenti, se il traffico è sottoposto a bilanciamento del carico**.</span><span class="sxs-lookup"><span data-stu-id="ab618-142">**One-time password (OTP) over SMS (aka one-way SMS) requires the use of sticky sessions if traffic is load-balanced**.</span></span> <span data-ttu-id="ab618-143">L'opzione di autenticazione con SMS unidirezionale determina l'invio agli utenti di un SMS contenente un messaggio OTP da parte del server MFA.</span><span class="sxs-lookup"><span data-stu-id="ab618-143">One-way SMS is an authentication option that causes the MFA Server to send the users a text message containing an OTP.</span></span> <span data-ttu-id="ab618-144">L'utente immette l'OTP in una finestra del prompt dei comandi per completare la richiesta di autenticazione a più fattori.</span><span class="sxs-lookup"><span data-stu-id="ab618-144">The user enters the OTP in a prompt window to complete the MFA challenge.</span></span> <span data-ttu-id="ab618-145">Se si esegue il bilanciamento del carico delle istanze del server Azure MFA, il server che ha gestito la richiesta di autenticazione iniziale deve essere quello che riceve il messaggio OTP dall'utente. Se un'altra istanza del server MFA riceve la risposta OTP, la richiesta di autenticazione ha esito negativo.</span><span class="sxs-lookup"><span data-stu-id="ab618-145">If you load balance Azure MFA Servers, the same server that served the initial authentication request must be the server that receives the OTP message from the user; if another MFA Server receives the OTP reply, the authentication challenge fails.</span></span> <span data-ttu-id="ab618-146">Per altre informazioni, vedere [One Time Password over SMS Added to Azure MFA Server](https://blogs.technet.microsoft.com/enterprisemobility/2015/03/02/one-time-password-over-sms-added-to-azure-mfa-server) (Aggiunta di One Time Password con SMS al server Azure MFA).</span><span class="sxs-lookup"><span data-stu-id="ab618-146">For more information, see [One Time Password over SMS Added to Azure MFA Server](https://blogs.technet.microsoft.com/enterprisemobility/2015/03/02/one-time-password-over-sms-added-to-azure-mfa-server).</span></span>
* <span data-ttu-id="ab618-147">**Le distribuzioni con bilanciamento del carico del portale per gli utenti e del servizio Web per app per dispositivi mobili richiedono sessioni permanenti**.</span><span class="sxs-lookup"><span data-stu-id="ab618-147">**Load-Balanced deployments of the User Portal and Mobile App Web Service require sticky sessions**.</span></span> <span data-ttu-id="ab618-148">Se si esegue il bilanciamento del carico del portale per utenti MFA e del servizio Web per app per dispositivi mobili, ogni sessione deve rimanere nello stesso server.</span><span class="sxs-lookup"><span data-stu-id="ab618-148">If you are load-balancing the MFA User Portal and the Mobile App Web Service, each session needs to stay on the same server.</span></span>

## <a name="high-availability-deployment"></a><span data-ttu-id="ab618-149">Distribuzione a disponibilità elevata</span><span class="sxs-lookup"><span data-stu-id="ab618-149">High-availability deployment</span></span>

<span data-ttu-id="ab618-150">Il diagramma seguente illustra un'implementazione completa con bilanciamento del carico a disponibilità elevata di Azure MFA e dei relativi componenti, oltre ad AD FS per riferimento.</span><span class="sxs-lookup"><span data-stu-id="ab618-150">The following diagram shows a complete HA load-balanced implementation of Azure MFA and its components, along with ADFS for reference.</span></span>

 ![Implementazione a disponibilità elevata del server Azure MFA](./media/mfa-server-high-availability/mfa-ha-deployment.png)

<span data-ttu-id="ab618-152">Tenere presente gli elementi seguenti per l'area numerata corrispondente del diagramma precedente.</span><span class="sxs-lookup"><span data-stu-id="ab618-152">Note the following items for the correspondingly numbered area of the preceding diagram.</span></span>

1. <span data-ttu-id="ab618-153">Le due istanze del server Azure MFA (MFA1 e MFA2) sono sottoposte a bilanciamento del carico (mfaapp.contoso.com) e configurate per l'uso di una porta statica (4443) per replicare il database PhoneFactor.pfdata.</span><span class="sxs-lookup"><span data-stu-id="ab618-153">The two Azure MFA Servers (MFA1 and MFA2) are load balanced (mfaapp.contoso.com) and are configured to use a static port (4443) to replicate the PhoneFactor.pfdata database.</span></span> <span data-ttu-id="ab618-154">L'SDK del servizio Web è installato in ogni istanza del server MFA per consentire la comunicazione sulla porta TCP 443 con i server AD FS.</span><span class="sxs-lookup"><span data-stu-id="ab618-154">The Web Service SDK is installed on each of the MFA Server to enable communication over TCP port 443 with the ADFS servers.</span></span> <span data-ttu-id="ab618-155">Le istanze del server MFA sono distribuite in una configurazione con bilanciamento del carico senza stato.</span><span class="sxs-lookup"><span data-stu-id="ab618-155">The MFA servers are deployed in a stateless load-balanced configuration.</span></span> <span data-ttu-id="ab618-156">Tuttavia, se si intende usare OTP con SMS, è necessario usare il bilanciamento del carico con stato.</span><span class="sxs-lookup"><span data-stu-id="ab618-156">However, if you wanted to use OTP over SMS, you must use stateful load balancing.</span></span>
   <span data-ttu-id="ab618-157">![Server Azure MFA - Elevata disponibilità del server app](./media/mfa-server-high-availability/mfaapp.png)</span><span class="sxs-lookup"><span data-stu-id="ab618-157">![Azure MFA Server - App server HA](./media/mfa-server-high-availability/mfaapp.png)</span></span>

   > [!NOTE]
   > <span data-ttu-id="ab618-158">Poiché RPC usa porte dinamiche, non è consigliabile aprire i firewall fino all'intervallo di porte dinamiche che RPC può usare.</span><span class="sxs-lookup"><span data-stu-id="ab618-158">Because RPC uses dynamic ports, it is not recommended to open firewalls up to the range of dynamic ports that RPC can potentially use.</span></span> <span data-ttu-id="ab618-159">Se è presente un firewall **tra** i server applicativi MFA, è consigliabile configurare il server MFA per le comunicazioni su una porta statica per il traffico di replica tra i server master e slave e aprire la porta sul firewall.</span><span class="sxs-lookup"><span data-stu-id="ab618-159">If you have a firewall **between** your MFA application servers, you should configure the MFA Server to communicate on a static port for the replication traffic between slave and master servers and open that port on your firewall.</span></span> <span data-ttu-id="ab618-160">È possibile forzare la porta statica creando un valore del Registro di sistema DWORD in ```HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Positive Networks\PhoneFactor``` denominato ```Pfsvc_ncan_ip_tcp_port``` e impostando il valore su una porta statica disponibile.</span><span class="sxs-lookup"><span data-stu-id="ab618-160">You can force the static port by creating a DWORD registry value at ```HKEY_LOCAL_MACHINE\SOFTWARE\Wow6432Node\Positive Networks\PhoneFactor``` called ```Pfsvc_ncan_ip_tcp_port``` and setting the value to an available static port.</span></span> <span data-ttu-id="ab618-161">Le connessioni vengono sempre avviate dall'istanza slave del server MFA all'istanza master, la porta statica è necessaria solo nell'istanza master, ma poiché è possibile alzare di livello un server slave in un master in qualsiasi momento, è consigliabile impostare la porta statica in tutte le istanze del server MFA.</span><span class="sxs-lookup"><span data-stu-id="ab618-161">Connections are always initiated by the slave MFA Servers to the master, the static port is only required on the master, but since you can promote a slave to be the master at any time, you should set the static port on all MFA Servers.</span></span>

2. <span data-ttu-id="ab618-162">I due server del portale per gli utenti e delle app per dispositivi mobili MFA (MFA-UP-MAS1 e MFA-UP-MAS2) sono sottoposti a bilanciamento del carico in una configurazione **con stato** (mfa.contoso.com).</span><span class="sxs-lookup"><span data-stu-id="ab618-162">The two User Portal/MFA Mobile App servers (MFA-UP-MAS1 and MFA-UP-MAS2) are load balanced in a **stateful** configuration (mfa.contoso.com).</span></span> <span data-ttu-id="ab618-163">Tenere presente che le sessioni permanenti sono un requisito necessario per il bilanciamento del carico del portale per gli utenti MFA e del servizio per app per dispositivi mobili.</span><span class="sxs-lookup"><span data-stu-id="ab618-163">Recall that sticky sessions are a requirement for load balancing the MFA User Portal and Mobile App Service.</span></span>
   <span data-ttu-id="ab618-164">![Server Azure MFA - Disponibilità elevata per il portale per gli utenti e per il servizio per app per dispositivi mobili](./media/mfa-server-high-availability/mfaportal.png)</span><span class="sxs-lookup"><span data-stu-id="ab618-164">![Azure MFA Server - User Portal and Mobile App Service HA](./media/mfa-server-high-availability/mfaportal.png)</span></span>
3. <span data-ttu-id="ab618-165">La server farm AD FS è sottoposta a bilanciamento del carico e pubblicata in Internet tramite proxy AD FS con bilanciamento del carico nella rete perimetrale.</span><span class="sxs-lookup"><span data-stu-id="ab618-165">The ADFS Server farm is load balanced and published to the Internet through load-balanced ADFS proxies in the perimeter network.</span></span> <span data-ttu-id="ab618-166">Ogni server AD FS usa l'agente AD FS per comunicare con i server Azure MFA mediante un unico URL con bilanciamento del carico (mfaapp.contoso.com) sulla porta TCP 443.</span><span class="sxs-lookup"><span data-stu-id="ab618-166">Each ADFS Server uses the ADFS agent to communicate with the Azure MFA Servers using a single load-balanced URL (mfaapp.contoso.com) over TCP port 443.</span></span>

## <a name="next-steps"></a><span data-ttu-id="ab618-167">Passaggi successivi</span><span class="sxs-lookup"><span data-stu-id="ab618-167">Next steps</span></span>

* [<span data-ttu-id="ab618-168">Installare e configurare il server Azure MFA</span><span class="sxs-lookup"><span data-stu-id="ab618-168">Install and configure Azure MFA Server</span></span>](multi-factor-authentication-get-started-server.md)
